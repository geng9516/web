<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.smartcompany.job.modules.core.mapper.TmgDailyMapper">

    <select id="buildSQLForSelectCountNotApprovalDay" resultType="string">
        SELECT
            SUM(DECODE(TDA_CSTATUSFLG, NULL, NULL, #{dataStatus9}, 0, #{dataStatus5} , 0, 1))
        FROM
            TMG_DAILY
        WHERE TDA_CCOMPANYID = #{compId}
        AND TDA_CCUSTOMERID = #{custId}
        AND TDA_CEMPLOYEEID = #{empId}
        AND TDA_DYYYYMM = TRUNC(TO_DATE(#{targetDate}, 'YYYY/MM/DD'))
     </select>

    <select id="buildSQLForSelectDaily" resultType="hashmap">
        SELECT
            to_char(TDA_DYYYYMMDD, 'yyyy/MM/dd') AS TDA_DYYYYMMDD,             <!-- 日付 -->
            to_char(TDA_DYYYYMMDD, 'dd') AS TDA_DYYYYMMDD_DD,                  <!-- 日 -->
            to_char(TDA_DYYYYMMDD, 'dy') AS TDA_DYYYYMMDD_DY,                  <!-- 曜日 -->
            TDA_CSTATUSFLG,                                                    <!-- ステータス -->
            (
                SELECT
                    TMG_F_GET_MGD_C(TDA_CSTATUSFLG, TDA_DYYYYMMDD, 1, TDA_CCUSTOMERID,TDA_CCOMPANYID, 'ja') TDA_CSTATUSFLG
                FROM
                    TMG_DAILY a
                WHERE
                    a.TDA_CCUSTOMERID = b.TDA_CCUSTOMERID
                AND a.TDA_CCOMPANYID = b.TDA_CCOMPANYID
                AND a.TDA_CEMPLOYEEID = b.TDA_CEMPLOYEEID
                AND a.TDA_DYYYYMMDD = b.TDA_DYYYYMMDD
                AND TMG_F_IS_HOLIDAY( b.TDA_CWORKINGID_R ,TDA_CCUSTOMERID ,TDA_CCOMPANYID) = 0
            ) AS TDA_CSTATUSFLG_NAME,                                          <!-- ステータス名称 -->
            TDA_CNTFSTATUSFLG,                                                 <!-- 申請ステータス -->
            TMG_F_GET_MGD_C(
                TDA_CNTFSTATUSFLG,
                TDA_DYYYYMMDD,
                1,
                TDA_CCUSTOMERID,
                TDA_CCOMPANYID,
                #{language}
            ) AS TDA_CNTFSTATUSFLG_NAME,                                       <!-- 申請ステータス名称 -->
            TDA_CWORKINGID_R,                                                  <!-- 就業区分 -->
            TMG_F_TRANS_WORKNAME(
                TDA_CEMPLOYEEID,
                TDA_DYYYYMMDD,
                1,
                TDA_CCUSTOMERID,
                TDA_CCOMPANYID,
                #{language}
            ) AS TDA_CWORKINGID_R_NAME,                                          <!-- 就業区分名称 -->
            TDA_CMESSAGE || ' ' || TDA_CCOMMENT_P AS  CCOMMENT                   <!-- 備考 -->
            <!-- 表示項目のselect句を取得し、joinでカンマ結合する -->
            <foreach collection="list" item="params" index ="index" open="," separator =","  close="">
                ${params}
            </foreach>
        FROM
            TMG_DAILY b
        WHERE
            TDA_CEMPLOYEEID    = #{targetUser}
        AND TDA_DYYYYMM        = #{month,jdbcType=DATE}
        AND TDA_CCOMPANYID     = #{compCode}
        AND TDA_CCUSTOMERID    = #{custID}
        <!-- 対象終了日の月について管理対象であるか判定 -->
        AND #{manageFlg}  <![CDATA[<>]]>TMG_F_IS_MANAGEFLG(
                                            #{targetUser},
                                            TRUNC(TO_DATE(#{month,jdbcType=DATE})),
                                            LAST_DAY(TO_DATE(#{month,jdbcType=DATE})),
                                            #{custID},
                                            #{compCode}
                                        )
        ORDER BY
            b.TDA_DYYYYMMDD
     </select>
    <select id="buildSQLForSelectDailyEdit" resultType="jp.smartcompany.job.modules.tmg.tmgresults.vo.DailyEditVO">
        SELECT
            TDA_CSTATUSFLG,                                                            <!-- 0 ステータス -->
            TDA_CERRCODE TDA_CERRCODE,                                                 <!-- 1 エラーメッセージ -->
            to_char(TDA_DYYYYMMDD, 'yyyy/MM/dd') TDA_DYYYYMMDD,                        <!-- 2 日付 -->
            to_char(TDA_DYYYYMMDD, 'yyyy"年"MM"月"dd"日"(dy)') TDA_DYYYYMMDD_DY,       <!-- 3 日付(表示) -->
            TDA_CWORKINGID_R,                                                          <!-- 4 [実績]就業区分 -->
            TMG_F_TRANS_WORKNAME(
                TDA_CEMPLOYEEID,
                TDA_DYYYYMMDD,
                0,
                TDA_CCUSTOMERID,
                TDA_CCOMPANYID,
                #{language}
            ) TDA_CWORKINGID_R_NAME,                                                 <!-- 5 [実績]就業区分名称 -->
            TMG_F_CONV_MIN2HHMI(TDA_NOPEN_N, 0) TDA_NOPEN_N,                    <!-- 6 [申請反映]始業時刻 -->
            TMG_F_CONV_MIN2HHMI(TDA_NCLOSE_N, 0) TDA_NCLOSE_N,                  <!-- 7 [申請反映]終業時刻 -->
            TMG_F_CONV_MIN2HHMI(TDA_NOPEN_TP, 0) TDA_NOPEN_TP,                  <!-- 8 打刻始業時刻 -->
            TMG_F_CONV_MIN2HHMI(TDA_NCLOSE_TP, 0) TDA_NCLOSE_TP,                <!-- 9 打刻終業時刻 -->
            DECODE(
                TMG_F_IS_DISCRETIONWORK(
                    #{custId}   ,
                    #{compCode} ,
                    TDA_CEMPLOYEEID,
                    TRUNC(TDA_DYYYYMMDD)
                ),

                <!-- 入力サイトの場合はTMG_F_GET_SHOULD_SHOW_TIMEを経由して実績の表示非表示判定を行う -->
                <choose>
                    <when test="siteId == 'TMG_INP' ">
                        <!-- 裁量労働でなければそのまま表示 -->
                        '0' ,
                        TMG_F_CONV_MIN2HHMI(TMG_F_GET_SHOULD_SHOW_TIME(TRUNC(TDA_DYYYYMMDD), TDA_CSTATUSFLG, TDA_NOPEN_TP, TDA_NOPEN_R)),
                    </when>
                    <otherwise>
                        <!-- 裁量労働でなければそのまま表示 -->
                        '0' ,
                        TMG_F_CONV_MIN2HHMI(TDA_NOPEN_R),
                    </otherwise>
                </choose>
                TMG_F_CONV_MIN2HHMI(TDA_NOPEN_R, 0)
            ) as TDA_NOPEN_R,                                                        <!-- 10 [実績]始業時刻 -->
            DECODE(
                TMG_F_IS_DISCRETIONWORK(
                    #{custId},
                    #{compCode},
                    TDA_CEMPLOYEEID,
                    TRUNC(TDA_DYYYYMMDD)
                ),
                <!-- 入力サイトの場合はTMG_F_GET_SHOULD_SHOW_TIMEを経由して実績の表示非表示判定を行う -->
                <choose>
                    <when test="siteId == 'TMG_INP' ">
                        <!-- 裁量労働でなければそのまま表示 -->
                        '0',
                        TMG_F_CONV_MIN2HHMI(TMG_F_GET_SHOULD_SHOW_TIME(TRUNC(TDA_DYYYYMMDD), TDA_CSTATUSFLG, TDA_NCLOSE_TP, TDA_NCLOSE_R)),
                    </when>
                    <otherwise>
                        <!-- 裁量労働でなければそのまま表示 -->
                        '0',
                        TMG_F_CONV_MIN2HHMI(TDA_NCLOSE_R),
                    </otherwise>
                </choose>
                TMG_F_CONV_MIN2HHMI(TDA_NCLOSE_R, 0)
            ) as TDA_NCLOSE_R,                                                      <!-- 11 [実績終業時刻 -->
            TMG_F_CONV_MIN2HHMI(TDA_NRESTOPEN_R, 0) TDA_NRESTOPEN_R,                <!-- 12 [実績]休憩開始時刻 -->
            TMG_F_CONV_MIN2HHMI(TDA_NRESTCLOSE_R, 0) TDA_NRESTCLOSE_R,              <!-- 13 [実績]休憩終了時刻 -->
            TMG_F_CONV_MIN2HHMI(TDA_NOPEN_O, 0) TDA_NOPEN_O,                        <!-- 14 超勤開始時刻 -->
            TMG_F_CONV_MIN2HHMI(TDA_NCLOSE_O, 0) TDA_NCLOSE_O,                      <!-- 15 超勤終了時刻 -->
            TDA_CCOMMENT_O,                                                         <!-- 16 超勤コメント -->
            TDA_COWNCOMMENT_R,                                                      <!-- 17 本人コメント-->
            TDA_CBOSSCOMMENT_R,                                                     <!-- 18 承認者コメント -->
            TMG_F_GET_ME_NAME_APPROVE(
                TDA_CMODIFIERUSERID_R,
                to_date(#{today}, 'yyyy/MM/dd'),
                0,
                #{custId},
                #{compCode}
            ) TDA_CMODIFIERUSERID_R,                                                   <!-- 19 コメント記入者 -->
            TO_CHAR(TDA_DMODIFIEDDATE_R, 'YYYY/MM/DD HH24:MI' ) TDA_DMODIFIEDDATE_R,   <!-- 20 コメント記載日 -->
            TMG_F_CONV_MIN2HHMI(TDA_NOPEN_P, 0) TDA_NOPEN_P,                           <!-- 21 [予定]始業時刻 -->
            TMG_F_CONV_MIN2HHMI(TDA_NCLOSE_P, 0) TDA_NCLOSE_P,                         <!-- 22 [予定]終業時刻 -->
            TDA_CBUSINESSTRIPID_R,                                                     <!-- 23 出張区分 -->
            TMG_F_GET_MGD(
                TDA_CBUSINESSTRIPID_R,
                TDA_DYYYYMMDD,
                TDA_CCUSTOMERID,
                TDA_CCOMPANYID,
                #{language}
            ) TDA_CBUSINESSTRIPID_R_NAME,                                              <!-- 24 [実績]出張区分名称 -->
            TDA_NREST45_P,                                                             <!-- 25 [予定]休憩45分選択 -->
            TMG_F_CONV_MIN2HHMI(
                DECODE(TDA_NREST45_P,
                1,
                DECODE(TDA_NCLOSE_P - TDA_NCLOSE_N, 15, (TDA_NCLOSE_P - 15), TDA_NCLOSE_P),
                TDA_NCLOSE_P
                ),
                0
            ) as TDA_NCLOSE_P_AT_REST45,                                                  <!-- 26 [予定]休憩45分選択 -->
            TMG_F_GET_TMG_PATTERN(TDA_CCUSTOMERID, TDA_CCOMPANYID, NULL, NULL).NTIME NTIME,    <!-- 27 [標準]勤務時間数 -->
            DECODE(
                TMG_F_IS_DISCRETIONWORK(
                    #{custId},
                    #{compCode} ,
                    TDA_CEMPLOYEEID,
                    TRUNC(TDA_DYYYYMMDD)
                ),
        '0' ,
                TMG_F_CONV_MIN2HHMI(TDA_NOPEN_R),     <!-- 裁量労働でなければそのまま表示 -->
                TMG_F_CONV_MIN2HHMI(TDA_NOPEN_R, 0)
            ) as TDA_NOPEN_R_HIDDEN,                                                            <!-- 28 [hidden用]始業時刻 -->
            DECODE(
                TMG_F_IS_DISCRETIONWORK(
                    #{custId}  ,
                    #{compCode} ,
                    TDA_CEMPLOYEEID,
                    TRUNC(TDA_DYYYYMMDD)
                ),
                '0' ,
                TMG_F_CONV_MIN2HHMI(TDA_NCLOSE_R),    <!-- 裁量労働でなければそのまま表示 -->
                TMG_F_CONV_MIN2HHMI(TDA_NCLOSE_R, 0)
            ) as TDA_NCLOSE_R_HIDDEN,                                                         <!-- 29 [hidden用]終業時刻 -->
            NVL(DECODE(
                TMG_F_GET_TIMEPUNCH_TARGETDATE(TDA_CCUSTOMERID, TDA_CCOMPANYID, TDA_CEMPLOYEEID, SYSDATE),
                TDA_DYYYYMMDD,
                TMG_F_GET_NOOVERTIME_DAYS_MSG(TDA_CEMPLOYEEID, TDA_DYYYYMMDD, 1, TDA_CCUSTOMERID, TDA_CCOMPANYID, #{language})
            ), ' ') as NO_OVERTIME_DAYS_MSG                                            <!-- 30 ノー残業デー表示メッセージ -->
        FROM
            TMG_DAILY
        WHERE
            TDA_CEMPLOYEEID = #{targetUser}
        AND TDA_DYYYYMMDD   = #{day}
        AND TDA_CCOMPANYID  = #{compCode}
        AND TDA_CCUSTOMERID = #{custId}
     </select>

    <select id="buildSQLForSelectDetailNonDuty" resultType="jp.smartcompany.job.modules.tmg.tmgresults.vo.DetailNonDutyVO">
        SELECT
            ATTRIBUTE_URL,                                                          <!-- URL-->
            ITEM_CODE TDAD_CNOTWORKID,                                              <!-- 非勤務区分-->
            TMG_F_CONV_MIN2HHMI(TDA_NRESTOPEN_R, 0) TDAD_NOPEN,                     <!-- 開始時刻-->
            TMG_F_CONV_MIN2HHMI(TDA_NRESTCLOSE_R, 0) TDAD_NCLOSE,                   <!-- 終了時刻-->
            0 TDAD_NDELETEFLG,                                                      <!-- 削除フラグ-->
            0 TDAD_SEQ,                                                             <!-- SEQ-->
            '' TDAD_CSPARECHAR1 ,                                                   <!-- 予備文字列1-->
            0 TDAD_NSPARENUM1 ,                                                     <!-- 予備数値1-->
            '' TDAD_CCODE01 ,                                                       <!-- 予備コード1-->
            '' TDAD_CCODE01_NAME,                                                   <!-- 予備コード名-->
            ITEM_NAME                                                               <!-- マスタ名称-->
        FROM
            TMG_DAILY,
            TABLE(
                TMG_F_GET_RESULTATTRIBUTE(
                    #{custId},
                    #{compCode},
                    #{targetUser},
                    #{siteId},
                    'TMG_CATEGORY|NonDuty',
                    #{day}
                )
            )
        WHERE
        TDA_CEMPLOYEEID    = #{targetUser}
        AND TDA_DYYYYMMDD      = #{day}
        AND TDA_CCOMPANYID     = #{compCode}
        AND TDA_CCUSTOMERID    = #{custId}
        AND TDA_DSTARTDATE     <![CDATA[<=]]>  #{day}
        AND TDA_DENDDATE       >= #{day}
        AND TDA_NRESTOPEN_R IS NOT NULL
        AND TDA_NRESTCLOSE_R IS NOT NULL
        AND ITEM_CODE = 'TMG_ITEMS|ResultRest'

        UNION

        SELECT
            ATTRIBUTE_URL,                                                          <!-- URL-->
            TDAD_CNOTWORKID,                                                        <!-- 非勤務区分-->
            TMG_F_CONV_MIN2HHMI(TDAD_NOPEN, 0) TDAD_NOPEN,                          <!-- 開始時刻-->
            TMG_F_CONV_MIN2HHMI(TDAD_NCLOSE, 0) TDAD_NCLOSE,                        <!-- 終了時刻-->
            TDAD_NDELETEFLG,                                                        <!-- 削除フラグ-->
            TDAD_SEQ,                                                               <!-- SEQ-->
            NVL(TDAD_CSPARECHAR1,'') TDAD_CSPARECHAR1,                              <!-- 予備文字列1-->
            TDAD_NSPARENUM1 TDAD_NSPARENUM1 ,                                       <!-- 予備数値1-->
            NVL(TDAD_CCODE01,'') TDAD_CCODE01,                                      <!-- 予備コード1-->
            TMG_F_GET_MGD(
                TDAD_CCODE01,
                TDAD_DYYYYMMDD,
                TDAD_CCUSTOMERID,
                TDAD_CCOMPANYID,
                #{language}
            ) TDAD_CCODE01_NAME,                                                      <!-- 予備コード1名-->
            ITEM_NAME                                                                 <!-- マスタ名称-->
        FROM
            TMG_DAILY_DETAIL,
            TABLE(
                TMG_F_GET_RESULTATTRIBUTE(
                    #{custId},
                    #{compCode},
                    #{targetUser},
                    #{siteId},
                    'TMG_CATEGORY|NonDuty',
                    #{day}
                )
            )
        WHERE
            TDAD_CEMPLOYEEID   = #{targetUser}
        AND TDAD_DYYYYMMDD     = #{day}
        AND TDAD_CCOMPANYID    = #{compCode}
        AND TDAD_CCUSTOMERID   = #{custId}
        AND TDAD_CNOTWORKID    = ITEM_CODE
        ORDER BY
            TDAD_SEQ
    </select>
    <select id="buildSQLForSelectDetailOverhours" resultType="jp.smartcompany.job.modules.tmg.tmgresults.vo.DetailOverhoursVO">
        SELECT
            ATTRIBUTE_URL,                          									<!-- URL -->
            ITEM_CODE TDAD_CNOTWORKID,              									<!--  非勤務区分 -->
            TMG_F_CONV_MIN2HHMI(TDA_NOPEN_O, 0) TDAD_NOPEN,                    			<!-- 超勤開始時刻 -->
            TMG_F_CONV_MIN2HHMI(TDA_NCLOSE_O, 0) TDAD_NCLOSE,                 			<!-- 超勤終了時刻 -->
            0 TDAD_NDELETEFLG,                                      					<!-- 削除フラグ -->
            0 TDAD_SEQ,     															<!-- SEQ -->
            TDA_CCOMMENT_O TDAD_CSPARECHAR1,   											<!-- 予備文字列1 -->
            0 TDAD_NSPARENUM1,  														<!-- 予備数値1 -->
            '' TDAD_CCODE01 ,  															<!-- 予備コード1 -->
            '' TDAD_CCODE01_NAME,   													<!-- 予備コード名 -->
            ITEM_NAME,                                                         			<!-- マスタ名称 -->
            'TMG_OVERHOUR_STATUS|6' TDAD_CSPARECHAR2,    								<!-- 予備文字列2(申請ステータス) -->
            TMG_F_GET_MGD(
                'TMG_OVERHOUR_STATUS|6',
                #{day},
                #{compCode},
                #{custId},
                #{language}
            ) AS TDAD_CSPARECHAR2_NAME    												<!-- 申請ステータス名称 -->
        FROM
            TMG_DAILY,
            TABLE
                (
                    TMG_F_GET_RESULTATTRIBUTE(
                        #{custId},
                        #{compCode},
                        #{targetUser},
                        #{siteId},
                        'TMG_CATEGORY|Overhours',
                        #{day}
                    )
                )
        WHERE
            TDA_CEMPLOYEEID    = #{targetUser}
        AND TDA_DYYYYMMDD      = #{day}
        AND TDA_CCOMPANYID     = #{compCode}
        AND TDA_CCUSTOMERID    = #{custId}
        AND TDA_DSTARTDATE <![CDATA[<=]]> #{day}
        AND TDA_DENDDATE   >= #{day}
        AND TDA_NOPEN_O IS NOT NULL
        AND TDA_NCLOSE_O IS NOT NULL
        AND ITEM_CODE = 'TMG_ITEMS|Overhours'

        UNION

        SELECT
            ATTRIBUTE_URL,                                          										<!-- URL -->
            TDAD_CNOTWORKID,                                        										<!--  非勤務区分 -->
            TMG_F_CONV_MIN2HHMI(TDAD_NOPEN, 0) TDAD_NOPEN,          										<!-- 超勤開始時刻 -->
            TMG_F_CONV_MIN2HHMI(TDAD_NCLOSE, 0) TDAD_NCLOSE,        										<!-- 超勤終了時刻 -->
            TDAD_NDELETEFLG,                                        										<!-- 削除フラグ -->
            TDAD_SEQ,   																					<!-- SEQ -->
            NVL(TDAD_CSPARECHAR1,'') TDAD_CSPARECHAR1,   													<!-- 予備文字列1 -->
            TDAD_NSPARENUM1 TDAD_NSPARENUM1 ,   															<!-- 予備数値1 -->
            NVL(TDAD_CCODE01,'') TDAD_CCODE01,  															<!-- 予備コード1 -->
            TMG_F_GET_MGD(
                TDAD_CCODE01,
                TDAD_DYYYYMMDD,
                TDAD_CCUSTOMERID,
                TDAD_CCOMPANYID,
                #{language}
            ) TDAD_CCODE01_NAME,    																	<!-- 予備コード名 -->
            ITEM_NAME                                            										<!-- マスタ名称 -->
            , NVL(TDAD_CSPARECHAR2, 'TMG_OVERHOUR_STATUS|6') TDAD_CSPARECHAR2,   						<!-- 予備文字列2(申請ステータス) -->
            TMG_F_GET_MGD(
                TDAD_CSPARECHAR2
                ,#{day}
                ,#{compCode}
                ,#{custId}
                ,#{language}
            )
            <!--超過勤務の事前事後情報の表示制御がＯＮ設定の場合、事前事後の情報を取得する。-->
            <if test="isOvertimeNotification == true ">
                    || '（' || TMG_F_GET_OVERTIME_NOTICEINFO(TDAD_CEMPLOYEEID, TDAD_DYYYYMMDD, TDAD_NOPEN, TDAD_CSPARECHAR3, TDAD_DSPAREDATE1, TDAD_CCUSTOMERID, TDAD_CCOMPANYID) || '）'
            </if>
            AS  TDAD_CSPARECHAR2_NAME    																			<!-- 申請ステータス名称 -->
        FROM
            TMG_DAILY_DETAIL,
            TABLE
                (
                    TMG_F_GET_RESULTATTRIBUTE(
                        #{custId},
                        #{compCode},
                        #{targetUser},
                        #{siteId},
                        'TMG_CATEGORY|Overhours',
                        #{day}
                    )
                )
        WHERE
            TDAD_CEMPLOYEEID   = #{targetUser}
        AND TDAD_DYYYYMMDD     = #{day}
        AND TDAD_CCOMPANYID    = #{compCode}
        AND TDAD_CCUSTOMERID   = #{custId}
        AND TDAD_CNOTWORKID    = ITEM_CODE
        ORDER BY TDAD_SEQ
    </select>



</mapper>