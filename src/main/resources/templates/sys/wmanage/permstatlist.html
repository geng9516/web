<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='承認状況一覧',cssPaths='/pages/content.min.css')">
</head>

<body>
    <div th:replace="layout/loadingBar::loadingBar"></div>
<!-- 菜单导航栏 -->
<div th:replace="layout/sider"></div>
    <main class="content permstatlist-warp" ref="layout">
        <div class="content_head">
            <div class="header">
                <div class="title1">
                    <h1>
                        <Icon type="i-emeer colored"></Icon>
                        {{  '承認状況一覧' }}
                    </h1>
                </div>
                <div class="btnbox">
                    <span style="flex:1"></span>
                    <i-button type="primary" @click="bulkApproval" :disabled="!approval" :loading="bulkApprovalLoading">月次一括承認</i-button>
                    
                </div>
            </div>
            <div class="searchwrap">
                <span class="label">年月</span>
                <i-select v-model="model1" :disabled="!selectDisabled" class="mr30" @on-change="handleStartMonth($event)"
                          placeholder="選択ください">
                    <i-option v-for="(item, index) of dispMonthlyList" :key="index" :label="item.val":value="item.val">
                    </i-option>
                </i-select>
                <span style="display:flex;width: calc(15% + 200px);">
                    <span class="label">所属</span>
                    <i-button v-on:click.native="deptDrawShow = true" class="input-like-span mr30 cursor grey"
                              style="width: calc(100% - 120px);border-radius:0;border: 1px dashed var(--dept-select);color: var(--dept-select);">
                        {{ deptName }}
                    </i-button>
                    <Drawer class="tc" title="所属を選択してください" placement="right" width="700" :closable="false"
                            :mask-closable="!isSearchHistory" v-model="deptDrawShow">
                        <div class="titlenorm mt15">
                            <Icon type="logo-buffer"></Icon>
                            所属
                        </div>
                        <Row class="tl">
                            <i-col span="8" class="label tc" style="height: 32px;">基準日</i-col>
                            <i-col span="8" class="no-border-radius">
                            <date-picker type="date" :value="referListObject.txtTmgReferListTreeViewRecordDate"
                                         class="mb5" placeholder="日付け" format="yyyy/MM/dd" ref="datePicker"
                                         @on-change="handleDeptDateChange"></date-picker>
                            </i-col>
                        </Row>
                        <div style="position: relative;">
                            <Tree class="tree mt2" :data="treeData" v-on:on-select-change="handleClickLeaf" ref="tree"
                                  empty-text="所属データなし"></Tree>
                            <Spin size="large" fix v-if="empDeptLoading"></Spin>
                        </div>
                    </Drawer>
                </span>
                <span style="flex:1"></span>
            </div>
        </div>
        <div class="content_body">
            <div class="table-top">
                <Row :gutter="16">
                    <i-col span="11">
                    <i-button type="text" @click="preMonthApproval" :disabled="!preMonthShow">
                        <Icon type="ios-arrow-back"></Icon>
                        前月
                    </i-button>
                    <i-button type="text" @click="nextMonthApproval" :disabled="!nextMonthShow">
                        翌月
                        <Icon type="ios-arrow-forward"></Icon>
                    </i-button>
                    </i-col>
                    <i-col class="tr" span="13">
                    <i-button type="primary" class="mr5" :disabled="!approval" ghost @click="handleSelectAll(false)">選択状態をクリア</i-button>
                    <i-button type="primary" class="mr5" :disabled="!approval" ghost @click="handleSelectAll(true)">承認対象者を全選択</i-button>
                    </i-col>
                </Row>
            </div>
            <i-table class="long-table" border ref="selection" :columns="columns" :data="tableData" @on-select="tableSelect" @on-selection-change="tableSelectChange"
                :disabled-hover="true" :loading="listLoading" no-data-text="教職員が存在している所属を選択して下さい。">
                <template slot-scope="{ row }" slot="name">
                    <span>{{ row.empname }}</span>
                </template>
                <template slot-scope="{ row }" slot="statusName">
                    <span>{{ row.statusName }}</span>
                </template>

                <template v-for="item of slotList" slot-scope="{ row }" :slot="item">
                    <span @click="showDay(row.empid,item,row.tmoCstatusflg)" class="cursor confirm-sytle ing" v-if="row[item] === '未'">未</span>
                    <span @click="showDay(row.empid,item,row.tmoCstatusflg)" class="cursor confirm-sytle undo" v-if="row[item] === 'エ'">エ</span>
                    <span @click="showDay(row.empid,item,row.tmoCstatusflg)" class="cursor confirm-sytle ing" v-if="row[item] === '待'">待</span>
                    <span @click="showDay(row.empid,item,row.tmoCstatusflg)" class="cursor confirm-sytle" v-if="row[item] === '済'">済</span>
                    <span @click="showDay(row.empid,item,row.tmoCstatusflg)" class="cursor confirm-sytle" v-if="row[item] === '確'">確</span>
                </template>
            </i-table>
            <FormDrawer
                    :isAdmin="true"
                    title=""
                    :isShow="isShow"
                    @close="() => (this.isShow = false)"
            ></FormDrawer>
            <Drawer :title="title" v-model="showDayApply" width="97">
                <Row :gutter="16" class="mb10">
                    <i-col class="tr" offset="11" span="13">
                    <i-button type="primary" class="mr5" :disabled="!drawApproval" ghost @click="handleSelectAll2(false)">
                        選択状態をクリア
                    </i-button>
                    <i-button type="primary" class="mr5" :disabled="!drawApproval" ghost @click="handleSelectAll2(true)">
                        承認対象者を全選択
                    </i-button>
                    <i-button type="primary" :disabled="!drawApproval" :loading="bulkApprovalLoading2" class="tr" @click="bulkApproval2">一括承認</i-button>
                    </i-col>
                </Row>
                <i-table border :columns="columns2" :loading="sublistLoading" :data="tableData2" @on-select="tableSelect2" @on-selection-change="tableSelectChange2" ref="selection2">
                    <template v-for="(item, i) of slotList2" slot-scope="{ row }" :slot="item">
                        <span v-if="i === 0">
                            <span class="confirm-sytle ing" v-if="row[item] === '未'">未</span>
                            <span class="confirm-sytle undo" v-if="row[item] === 'エ'">エ</span>
                            <span class="confirm-sytle ing" v-if="row[item] === '待'">待</span>
                            <span class="confirm-sytle" v-if="row[item] === '済'">済</span>
                            <span class="confirm-sytle" v-if="row[item] === '確'">確</span>
                        </span>
                        <span v-else>{{ row[item] | turnLine | whiteSpace}}</span>
                    </template>
                </i-table>
            </Drawer>

            <!--日次就業実績-->
            <Drawer :mask-closable="false" :title="title" @on-close="handleClose()" v-model="showAddWork" width="850">
                <div style="position: relative">
                    <Alert type="primary-info" v-if="query.txtAction === 'ACT_EDITPERM_EDIT'">締め済データの編集中</Alert>
                    <Alert class="error-info" type="error" v-show="errorFlag">{{ errorMsg }}</Alert>
                    <Row class="mb15 tr">
                        <div v-if="!bFixed">
                            <i-button icon="md-done-all" :loading="updateDailyLoading" @click="updateDaily"  ghost type="primary">
                                承認
                            </i-button>
                            <i-button icon="md-hand" :loading="returnUpdateDailyLoading" @click="updateRemandsStatus"  ghost type="error" v-if="notapproval">
                                差戻
                            </i-button>
                        </div>
                        <div v-else>
                            <i-button disabled>
                                承認
                            </i-button>
                            <i-button icon="md-create" @click="edit" ghost  type="primary" v-if="isShowFixedMonthlyEditButton" >
                                締め済データの編集
                            </i-button>
                        </div>
                    </Row>
                    <div class="titlenorm mb10">
                        <Icon type="logo-buffer"></Icon>
                        就業実績
                    </div>
                    <div style="position: relative;">
                        <Row>
                            <i-col class="label tc" span="8">就業区分</i-col>
                            <i-col class="no-border-radius" span="8">
                                <i-select @on-change="changeWorkingID" class="mr30" v-if="!bHoliday && !bFixed"
                                          v-model="workingId">
                                    <i-option :key="index" :label="item.mgdCgenericdetaildesc"
                                              v-for="(item, index) of workingIdList" 　:value="item.mgdCmastercode">
                                    </i-option>
                                </i-select>
                                <p align="center" v-else>{{dailyEdit.tdaCworkingidRName}}</p>
                            </i-col>
                        </Row>
                        <Row>
                            <i-col class="label tc" span="8">出張</i-col>
                            <i-col class="no-border-radius" span="8" v-if="!bDisable">
                                <i-select @on-change="" class="mr30" v-if="(!bHoliday && !bFixed)" v-model="businessTrip">
                                    <i-option :key="index" :label="item.mgdCgenericdetaildesc"
                                              v-for="(item, index) of businessTripList" 　:value="item.mgdCmastercode">
                                    </i-option>
                                </i-select>
                                <p align="center" v-else>{{dailyEdit.tdaCbusinesstripidRName}}</p>
                            </i-col>
                            <i-col class="no-border-radius" span="8" v-else>
                                <i-select @on-change="" class="mr30" disabled v-if="(!bHoliday && !bFixed)"
                                          v-model="businessTrip">
                                    <i-option :key="index" :label="item.mgdCgenericdetaildesc"
                                              v-for="(item, index) of businessTripList" 　:value="item.mgdCmastercode">
                                    </i-option>
                                </i-select>
                                <p align="center" v-else>{{dailyEdit.tdaCbusinesstripidRName}}</p>
                            </i-col>
                        </Row>
                        <i-table :columns="columnsWork" :data="workData">
                            <template slot="workStart" slot-scope="{ row, index }">
                                <div v-if="row.isInput && bFixed" >
                                    <i-input :disabled="workTimeDisable" @on-blur="handleInputChange(index, workData[index],'workStart', $event.target)" class="tc" v-if="!isCommonDiscretionaryLabor" v-model="workData[index].workStart"></i-input>
                                    <span v-else>{{ row.workStart | toTime }}</span>
                                </div>
                                <div  v-else-if="row.isInput" >
                                    <i-input :disabled="workTimeDisable" @on-blur="handleInputChange(index,  workData[index],'workStart', $event.target)" class="tc" v-model="workData[index].workStart"></i-input>
                                </div>
                                <span v-else>{{ row.workStart | toTime }}</span>
                            </template>
                            <template slot="workEnd" slot-scope="{ row, index }">
                                <div v-if="row.isInput && bFixed" >
                                    <i-input :disabled="workTimeDisable" @on-blur="handleInputChange(index, workData[index],'workEnd', $event.target)" class="tc"  v-if="!isCommonDiscretionaryLabor" v-model="workData[index].workEnd"></i-input>
                                    <span v-else>{{ row.workEnd | toTime }}</span>
                                </div>
                                <div  v-else-if="row.isInput" >
                                    <i-input :disabled="workTimeDisable" @on-blur="handleInputChange(index, workData[index],'workEnd', $event.target)" class="tc" v-model="workData[index].workEnd"></i-input>
                                </div>
                                <span v-else>{{ row.workEnd | toTime }}</span>
                            </template>

                        </i-table>


                        <Row>
                            <i-col class="label tc" span="8">本人コメント</i-col>
                            <i-col span="16">
                                <i-input disabled readonly text-align="center;" type="textarea"
                                         v-model="dailyEdit.tdaCowncommentR"></i-input>
                            </i-col>
                        </Row>
                        <Row class="mb5">
                            <i-col class="label tc" span="8">承認者コメント</i-col>
                            <i-col span="16">
                                <span v-if="bApproved">{{ dailyEdit.tdaCmodifieruseridR}} ({{dailyEdit.tdaDmodifieddateR }})</span>
                                <i-input text-align="center;" type="textarea" v-if="!bFixed"
                                         v-model="dailyEdit.tdaCbosscommentR" ></i-input>
                                <i-input readonly text-align="center;" type="textarea"
                                         v-else v-model="dailyEdit.tdaCbosscommentR"></i-input>
                            </i-col>
                        </Row>
                    </div>


                    <!-- 非勤務 -->
                    <div class="titlenorm mb10">
                        <Icon type="logo-buffer"></Icon>
                        非勤務
                    </div>
                    <Row class="mb15 tr" v-if=" !bHoliday && !bFixed ">
                        <i-col offset="15" span="6">
                            <i-select @on-change="" class="mr30" v-if="!bDisable" v-model="categoryNonduty">
                                <i-option :key="index" :label="item.itemName" v-for="(item, index) of categoryNondutyList"
                                          　:value="item.itemCode">
                                </i-option>
                            </i-select>
                            <i-select @on-change="" class="mr30" disabled v-else v-model="categoryNonduty">
                                <i-option :key="index" :label="item.itemName" v-for="(item, index) of categoryNondutyList"
                                          　:value="item.itemCode">
                                </i-option>
                            </i-select>
                        </i-col>
                        <i-col span="3">
                            <i-button @click="addNotWork" ghost type="primary" v-if="!bDisable">追加</i-button>
                            <i-button disabled v-else>追加</i-button>
                        </i-col>
                    </Row>
                    <i-table :columns="columnsNotWork" :data="detailNonDutyVOList" class="mb20"
                             no-data-text="">
                        <template slot="tdadNopen" slot-scope="{ row, index }">
                            <i-input @on-blur="handleInputChange(index, detailNonDutyVOList[index],'tdadNopen', $event.target)" v-if=" !bFixed" v-model="detailNonDutyVOList[index].tdadNopen"></i-input>
                            <span v-else>{{  row.tdadNopen | toTime  }}</span>
                        </template>

                        <template slot="tdadNclose" slot-scope="{ row, index }">
                            <i-input @on-blur="handleInputChange(index, detailNonDutyVOList[index],'tdadNclose', $event.target)" v-if="!bFixed " v-model="detailNonDutyVOList[index].tdadNclose"></i-input>
                            <span v-else>{{ row.tdadNclose | toTime }}</span>
                        </template>

                        <template slot="tdadCsparechar1" slot-scope="{ row ,index}">
                            <i-input :autosize="{ maxRows: 3 }" type="textarea"
                                     v-if="row.tdadCnotworkid !== 'TMG_ITEMS|ResultRest' && !bFixed "
                                     v-model="detailNonDutyVOList[index].tdadCsparechar1"></i-input>
                            <span v-else>{{ row.tdadCsparechar1 | toTime }}</span>
                        </template>

                        <template slot="tdadNdeleteflg" slot-scope="{ row }" v-if="!bFixed">
                            <i-button @click="delNotWork(row)" class="width100" ghost size="small" type="error">削除</i-button>
                        </template>
                    </i-table>

                    <div v-if="!isDiscretion">
                        <!-- 超過勤務 -->
                        <div class="titlenorm mb10">
                            <Icon type="logo-buffer"></Icon>
                            超過勤務
                        </div>
                        <Row class="mb15 tr" v-if="!bHoliday && !bFixed ">

                            <i-col offset="15" span="6">
                                <i-select @on-change="" class="mr30" v-if="!bDisable" v-model="categoryOverhours">
                                    <i-option :key="index" :label="item.itemName" v-for="(item, index) of categoryOverhoursList"
                                              　:value="item.itemCode">
                                    </i-option>
                                </i-select>
                                <i-select @on-change="" class="mr30" disabled v-else v-model="categoryOverhours">
                                    <i-option :key="index" :label="item.itemName" v-for="(item, index) of categoryOverhoursList"
                                              　:value="item.itemCode">
                                    </i-option>
                                </i-select>
                            </i-col>

                            <i-col span="3">
                                <i-button @click="addOverWork" ghost type="primary" v-if="!bDisable">追加</i-button>
                                <i-button disabled v-else>追加</i-button>
                            </i-col>
                            <!--                <i-col span="4">-->
                            <!--                    <i-button type="primary" ghost v-if="!bDisable">時刻補完</i-button>-->
                            <!--                    <i-button type="primary" ghost disabled v-else>時刻補完</i-button>-->
                            <!--                </i-col>-->
                        </Row>

                        <i-table :columns="columnsOverWork" :data="detailOverhoursVOList" class="mb20"
                                 no-data-text="">
                            <template slot="tdadNopen" slot-scope="{ row ,index }">
                                <i-input @on-blur="handleInputChange(index, detailOverhoursVOList[index],'tdadNopen', $event.target)" v-if=" !bFixed" v-model="detailOverhoursVOList[index].tdadNopen"></i-input>
                                <span v-else>{{ row.tdadNopen | toTime }}</span>
                            </template>

                            <template slot="tdadNclose" slot-scope="{ row ,index}">
                                <i-input @on-blur="handleInputChange(index, detailOverhoursVOList[index],'tdadNclose', $event.target)" v-if=" !bFixed" v-model="detailOverhoursVOList[index].tdadNclose"></i-input>
                                <span v-else>{{ row.tdadNclose | toTime }}</span>
                            </template>

                            <template slot="tdadCsparechar1" slot-scope="{ row ,index}">
                                <i-input :autosize="{ maxRows: 3 }" type="textarea"
                                         v-if="!bFixed"
                                         v-model="detailOverhoursVOList[index].tdadCsparechar1"></i-input>
                                <span v-else>{{ row.tdadCsparechar1}}</span>
                            </template>

                            <template slot="tdadNdeleteflg" slot-scope="{ row ,index}" v-if="!bFixed">
                                <i-button @click="delOverWork(row)" class="width100" ghost size="small" type="error">削除</i-button>
                            </template>
                        </i-table>
                    </div>

                    <div class="titlenorm mb10">
                        <Icon type="logo-buffer"></Icon>
                        更新履歴
                    </div>
                    <i-table :columns="columnsDailyLog" :data="dailyLog" class="mb20">
                    </i-table>
                    <Spin fix size="large" v-if="dailyloading"></Spin>
                </div>
                <div style="position: fixed;top: 0;bottom: 0;left: 0;right: 0;z-index: 999999;" v-if="sovlingLoading"></div>
            </Drawer>
        </div>
        <back-top></back-top>
    </main>

    <div th:replace="layout/head::header"></div>
    <script type="text/babel" th:inline="javascript">
        const PERM_STATLIST = new Vue({
            el: '.permstatlist-warp',
            data() {
                return {
                    curDate: new Date(),
                    tableHead: [],
                    tableData: [],
                    slotList: Utils.getNumArray(1, 31).map(e => `disppermStatusName${e}`),
                    slotList2: Utils.getNumArray(1, 13).map(e => `COLUMNID${e}`),
                    dailyShow: true,
                    rawData: [],
                    isShow: false,
                    showPre: true,
                    listLoading: false,
                    sublistLoading: false,
                    showDayApply: false,
                    emplistLoading: false,
                    referListObject: {
                        [[${ TREEVIEW_KEY_ADMIN_TARGET_SECTION }]]: '',
                        [[${ TREEVIEW_KEY_ADMIN_TARGET_EMP }]]: '',
                        [[${ TREEVIEW_KEY_RECORD_DATE }]]: '',
                        [[${ TREEVIEW_KEY_REFRESH_FLG }]]: '',
                        txtTmgReferListTreeViewRecordDate: '',
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        psApp: Utils.getUrlParam(location.href, 'psApp'),
                        type: 31
                    },
                    empTreeData: [],
                    deptName: '選んでください',
                    query: {
                        txtAction: 'ACT_DISP_MONTHLY',
                        txtDYYYYMM: '',
                        txtDYYYYMMDD: '',
                        txtCallBeanAction: 'ACT_DISP_MONTHLY',
                        txtTmgReferListTreeViewRecordDate: '',
                        txtTmgReferListTreeViewAdminTargetSection: '',
                        txtCEMPLOYEEID: '',
                        sectionid: '',
                        txtExecuteEmpId: '',
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        psApp: Utils.getUrlParam(location.href, 'psApp'),
                        type: 31
                    },
                    empDeptLoading: false,
                    deptDrawShow: false,
                    treeData: [],
                    selectDisabled: false,   　//年月選択可否制御
                    dispMonthlyList: [],       //年月リスト
                    model1: '',
                    approval: false,
                    drawApproval: false,

                    title: '',
                    tableHead2: [],
                    tableData2: [],
                    empIds: [],
                    empIds2: [],

                    bulkApprovalLoading: false,
                    bulkApprovalLoading2: false,
                    isSearchHistory: false,

                    thisMonth: '',
                    preMonth: '',
                    nextMonth: '',
                    preMonthShow: false,
                    nextMonthShow: false,
                    //↓↓↓↓↓↓日次実績登録用↓↓↓↓↓↓
                    //body 使用参数
                    queryAddWork: {
                        txtTmgReferListTreeViewAdminTargetEmp: '',        //組織ツリーで選択した職員番号
                        hidSelectTab:'0',      //組織タブー0：ツリ、1:検索
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        txtDYYYYMM: '',
                        txtDYYYYMMDD: '',
                        txtAction:'ACT_EDITINP_RDAILY'
                    },
                    showAddWork: false,
                    updateDailyLoading: false,
                    returnUpdateDailyLoading: false,
                    sovlingLoading: false,
                    notapproval:false,
                    errorFlag: false,
                    errorMsg: '',//错误信息
                    //就業区分
                    workingId: '',
                    workingIdList: [],
                    // 就業区分切替の表示制御
                    bDisable: false,
                    // 出張区分切替の表示制御
                    businessTrip: '',
                    businessTripList: [],
                    bHoliday: false, //就業区分マスタ
                    bFixed: false, //確定状態
                    columnsWork: [
                        {
                            title: '勤務時間',
                            align: 'center',
                            key: 'workTime'
                        },
                        {
                            title: '始業',
                            slot: 'workStart',
                            align: 'center'
                        },
                        {
                            title: '終業',
                            slot: 'workEnd',
                            align: 'center'
                        }
                    ],
                    columnsNotWork: [
                        {
                            title: '内容',
                            align: 'center',
                            width: '120',
                            key: 'itemName'
                        },
                        {
                            title: '開始時刻',
                            width: '80',
                            slot: 'tdadNopen',
                            align: 'center'
                        },
                        {
                            title: '終了時刻',
                            slot: 'tdadNclose',
                            width: '80',
                            align: 'center'
                        },
                        {
                            title: '備考',
                            slot: 'tdadCsparechar1',
                            align: 'center'
                        },
                        {
                            title: '削除',
                            slot: 'tdadNdeleteflg',
                            width: '80',
                            align: 'center'
                        }
                    ],
                    columnsOverWork: [
                        {
                            title: '内容',
                            align: 'center',
                            width: '120',
                            key: 'itemName'
                        },
                        {
                            title: '開始時刻',
                            width: '80',
                            slot: 'tdadNopen',
                            align: 'center'
                        },
                        {
                            title: '終了時刻',
                            slot: 'tdadNclose',
                            width: '80',
                            align: 'center'
                        },
                        {
                            title: '用務内容',
                            slot: 'tdadCsparechar1',
                            align: 'center'
                        },
                        {
                            title: '状態',
                            key: 'tdadCsparechar2Name',
                            align: 'center'
                        },
                        {
                            title: '削除',
                            slot: 'tdadNdeleteflg',
                            width: '80',
                            align: 'center'
                        }
                    ],
                    columnsDailyLog: [
                        {
                            title: '更新者',
                            key: 'cmodifierusernm',
                            width: '120'
                        },
                        {
                            title: '更新日時',
                            key: 'dmodifieddate',
                            width: '140',
                            align: 'center'
                        },
                        {
                            title: '画面',
                            key: 'cmodifierprogramnm',
                            width: '100',
                            align: 'center'

                        },
                        {
                            title: '操作',
                            key: 'cactionnm',
                            width: '130',
                            align: 'center'
                        },
                        {
                            title: '更新内容',
                            key: 'cchangelogstr'
                        }
                    ],
                    workData: [],
                    // 承認者コメントの入力制御
                    bApproved: false,
                    // 非勤務と超過勤務区分切替の表示制御
                    categoryNonduty: '',
                    categoryNondutyList: [],
                    categoryOverhours: '',
                    categoryOverhoursList: [],
                    dailyEdit:[],
                    detailNonDutyVOList: [],
                    isDiscretion:false,//裁量労働制
                    detailOverhoursVOList: [],
                    dailyLog: [],
                    dailyloading:false,
                    tmoCstatusflg: '',
                    tmgResultsDto: {
                        txtAction: '',
                        holiday: false,
                        txtTdaNopenR: '',
                        txtTdaNcloseR: '',
                        workingId: '',
                        selMgdCbusinessTrip: '',
                        txtDYYYYMMDD: '',
                        tdaCowncommentR: '',
                        nonDutyList: [],
                        overHoursList: [],
                        hasAuthority: true,
                        targetEmp:'',
                        psSite: Utils.getUrlParam(location.href, 'psSite')
                    },　//参数
                    //締め済データの編集
                    isShowFixedMonthlyEditButton:false,
                    //↑↑↑↑↑↑日次実績登録用↓↓↓↓↓↓
                }
            },
            async mounted() {
                this.getOrgTree()
                this.getTableHead()
                window.addEventListener('scroll',this.handleScroll,{ passive: true })
            },
            beforeDestroy() {
                window.removeEventListener('scroll',this.handleScroll,{ passive: true })
            },
            computed: {
                tableHeadFixed() {
                    if (this.contentScrollTop > 300) return true
                    else return false
                },
                columns() {
                    let result = [
                        {
                            title: '氏名',
                            slot: 'name',
                            minWidth: 100,
                            align: 'right'
                        },
                        {
                            title: '月次\n承認',
                            slot: 'statusName',
                            minWidth: 36,
                            align: 'center'
                        }
                    ]
                    const that = this
                    this.tableHead.forEach((e, i) => {
                        result = result.concat({
                            // title: e,
                            className: e.today ? 'gold' : (e.tcaCholflg.indexOf('1') > -1 || e.tcaCholflg.indexOf('2') > -1 || e.tcaCholflg.indexOf('3') > -1 ? 'rest' : ''),
                            minWidth: 25,
                            renderHeader: (h, params) => {
                                return h(
                                    'span',
                                    {
                                        style: {
                                            cursor: 'pointer',
                                        },
                                        domProps: {
                                            className: 'table-head',
                                            innerHTML: e.name,
                                        },
                                        on: {
                                            click(){
                                                that.handleClickHead(e.day)
                                            },
                                        },
                                    }
                                )
                            },
                            slot: `disppermStatusName${i + 1}`,
                            align: 'center'
                        })
                    })
                    result = result.concat({
                        type: 'selection',
                        width: 60,
                        align: 'center'
                    })
                    return result
                },
                columns2() {
                    let result = []
                    const that = this
                    const r =[45,120,60,55,55,55,55,55,55,250,250,150,150]
                    this.tableHead2.forEach((e, i) => {
                        result = result.concat({
                            // width: e.mgdNwidth,
                            minWidth: r[i],
                            tooltip: true,
                            renderHeader: (h, params) => {
                                return h(
                                    'span',
                                    {
                                        style: {
                                            cursor: 'pointer',
                                        },
                                        domProps: {
                                            className: 'table-head',
                                            innerHTML: e.mgdCheader,
                                        }
                                    }
                                )
                            },
                            key: `COLUMNID${i + 1}`,
                            align: e.mgdCdispstyle
                        })
                    })
                    result = result.concat({
                        type: 'selection',
                        width: 50,
                        align: 'center'
                    })
                    return result
                }
            },
            methods: {
                async getDispTmgMonthlyList() {
                    this.query.txtAction = 'ACT_DISP_MONTHLY'
                    const { data } = await this.http.get('sys/permStatList/dispTmgMonthlyList', this.query)
                    this.dispMonthlyList = data

                    if (data.length > 0){
                        this.model1 = data[0].val

                        let result = this.model1.replace("年","/")
                        result = result.replace("月","/")
                        result = result + "01"
                        this.query.txtDYYYYMM = result

                        this.thisMonth = result
                        this.preNextMonth(data[0].val)

                        //年月リストを取得する時に、活性化にする
                        this.selectDisabled = true
                    }

                    //年月リスト.lengthがゼロ場合、非活性化にする
                    if (data.length === 0){
                        this.model1 = ''
                        this.selectDisabled = false
                        this.preMonthShow = false
                        this.nextMonthShow = false
                    }
                },
                async getTableHead() {
                    this.query.txtAction = 'ACT_DISP_MONTHLY'
                    const { data } = await this.http.get('sys/permStatList/selectDayHead', this.query)
                    this.tableHead = data
                },
                async getTableData() {
                    this.listLoading  = true
                    const { data } = await this.http.get('sys/permStatList/getTmgMonthlyInfoVOList', this.query)
                    this.tableData = data.tmgMonthlyInfoVOList
                    this.approval = data.approval
                    this.listLoading  = false
                    this.isSearchHistory = false
                },
                async getTmgMonthlyInfoVOList() {
                    this.query.txtAction = 'ACT_DISP_MONTHLY'

                    const { data } = await this.http.get('sys/permStatList/getTmgMonthlyInfoVOList', this.query)
                    this.tableData = data
                },
                async getOrgTree(refreshDept) {
                    this.empDeptLoading = true
                    try {
                        const { orgList, recordDate } = await this.http.get('sys/tree', this.referListObject)
                        // 先将数据转为标准格式，再转为可用数据
                        this.treeData = Utils.convertTreeData(orgList)
                        this.referListObject.txtTmgReferListTreeViewRecordDate = recordDate
                    } catch (error) {
                        return
                    } finally {
                        this.empDeptLoading = false
                    }
                },
                async handleDeptDateChange(e) {
                    this.referListObject.txtTmgReferListTreeViewRecordDate = e
                    this.isSearchHistory = true
                    await this.getOrgTree()
                    this.$Notice.warning({ title: '所属図更新完了', desc: "下記の所属リストから対象を選んでください" })
                },
                async preMonthApproval() {
                    console.log("preMonthApproval")
                    console.log(this.preMonth)
                    this.query.txtDYYYYMM = this.dateFormat(this.preMonth)
                    await this.getTableHead()
                    await this.getTableData()
                    this.model1 = this.preMonth
                    this.preNextMonth(this.preMonth)

                },
                async nextMonthApproval() {
                    this.query.txtDYYYYMM = this.dateFormat(this.nextMonth)
                    await this.getTableHead()
                    await this.getTableData()
                    this.model1 = this.nextMonth
                    this.preNextMonth(this.nextMonth)
                },
                preNextMonth(e) {
                    console.log("preNextMonth_s")
                    console.log(this.dispMonthlyList.length)
                    console.log(e)
                    for (var i=0;i < this.dispMonthlyList.length;i++){
                            if (e===this.dispMonthlyList[i].val) {
                                if (i===0){
                                    this.preMonthShow = true
                                    this.nextMonthShow = false

                                    this.preMonth = this.dispMonthlyList[i+1].val
                                    this.nextMonth = ''
                                    break

                                } else if (i===this.dispMonthlyList.length-1) {

                                    this.preMonthShow = false
                                    this.nextMonthShow = true

                                    this.preMonth = ''
                                    this.nextMonth = this.dispMonthlyList[i-1].val
                                    break
                                } else {
                                    this.preMonthShow = true
                                    this.nextMonthShow = true

                                    this.preMonth = this.dispMonthlyList[i+1].val
                                    this.nextMonth = this.dispMonthlyList[i-1].val
                                    break
                                }
                            }
                    }
                    console.log(this.preMonth)
                    console.log(this.nextMonth)
                    console.log("preNextMonth_e")
                },
                rowClass(row) {
                    // 表格变色
                    if (!row.dayDivisionCode || row.dayDivisionCode === '1') {
                        return ''
                    }
                    return 'sat'
                },
                handleScroll: Throttle(function (e) {
                    this.contentScrollTop = e.target.documentElement.scrollTop || e.target.body.scrollTop
                }, 50),
                convertTreeData(treeData = []) {
                    return treeData.map(e => {
                        const children = e.child || e.children
                        if (children) {
                            return {
                                ...e.data,
                                title: e.data.label,
                                // 前两层级默认展开方便查看
                                expand: e.data.level < 2 || !e.data.level,
                                children: this.convertTreeData(children)
                            }
                        } else {
                            return {
                                ...e.data,
                                title: e.data.label
                            }
                        }
                    })
                },
                handleSelector() { },
                async handleClickLeaf(e) {
                    //同一部署を二回目でクリックすると、取消とするためで、エラーあり
                    //よって、二回目クリックすると、何もしない
                    if(!e[0]) return

                    console.log('e2')
                    console.log(e)
                    this.deptDrawShow = false
                    this.query.txtAction = 'ACT_DISP_MONTHLY'
                    this.deptName = e[0].secnic
                    this.query.txtTmgReferListTreeViewAdminTargetSection = e[0].secid
                    this.query.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate

                    //年月リストの取得
                    await this.getDispTmgMonthlyList()

                    await this.getTableHead()
                    await this.getTableData()

                },
                async getEmpList() {
                    try {
                        this.emplistLoading = true
                        const { data } = await this.http.get('sys/tree/admin/emplist', this.referListObject)
                        this.empTreeData = Utils.convertTreeData(Utils.convertToData(data))
                    } catch (error) {
                        return
                    } finally {
                        this.emplistLoading = false
                    }
                },
                handleClickEmpLeaf(e) {
                    this.deptDrawShow = false
                    // this.getData(true)
                },
                showName(e) {
                    const result = e.match(/^[\s\S]+(?=\()/g)
                    return (result && result[0]) || e
                },
                async handleClickHead(e) {
                    console.log(e)
                    //テーブルデータ存在しないと、日次一括承認画面へ遷移できません
                    if(this.tableData.length===0) return

                    this.query.txtAction = 'ACT_EDIT_DAIRY'
                    this.query.txtDYYYYMMDD = e
                    this.query.txtCallBeanAction = 'ACT_DISP_MONTHLY'

                    this.title = "承認状況 " + Utils.formatDate(e, 'yyyy年m月d日')

                    this.showDayApply = true
                    this.getReadTmgDaily()

                    //選択した職員リストをクリアする
                    this.handleSelectAll2(false)
                    console.log("this.handleClickHead")
                    console.log(this.tableHead2)
                    console.log(this.tableData2)
                },
                async getReadTmgDaily() {
                    this.sublistLoading  = true
                    const { data } = await this.http.get('sys/permStatList/getReadTmgDaily', this.query)

                    //日別詳細画面のボタンを制御
                    this.drawApproval = data.approval

                    this.tableHead2 = data.itemVOList
                    this.tableData2 = data.tmgDailyMapList
                    this.sublistLoading  = false
                },
                toWorkPage() {
                    // this.$router.push('/sys/confirmer/applyWork')
                },
                handleSelectAll(status) {
                    this.$refs.selection.selectAll(status)
                },
                //行が選択される場合、トリガーされる
                tableSelect(selection, row) {
                    console.log("tableSelect")
                    console.log(selection)
                    console.log(row)
                },
                //選択した行の状態が変わる場合、トリガーされる
                tableSelectChange(selection, row) {
                    console.log("tableSelectChange")
                    console.log(selection)

                    this.empIds = []
                    for (var i=0;i < selection.length;i++){
                        this.empIds.push(selection[i].empid)
                    }
                    this.query.txtExecuteEmpId = this.empIds.join(',')
                    console.log(this.query.txtExecuteEmpId)

                },

                //行が選択される場合、トリガーされる
                tableSelect2(selection, row) {
                    console.log("tableSelect")
                    console.log(selection)
                    console.log(row)
                },
                //選択した行の状態が変わる場合、トリガーされる
                tableSelectChange2(selection, row) {
                    console.log("tableSelectChange2")
                    console.log(selection)

                    this.empIds2 = []
                    for (var i=0;i < selection.length;i++){
                        this.empIds2.push(selection[i].TDA_CEMPLOYEEID)
                    }
                    this.query.txtExecuteEmpId = this.empIds2.join(',')
                    console.log(this.query.txtExecuteEmpId)

                },
                handleSelectAll2(status) {
                    this.$refs.selection2.selectAll(status)
                },
                handleStartMonth(e) {
                    console.log("handleStartMonth")
                    if(e){
                        this.query.txtDYYYYMM = this.dateFormat(e)
                        this.getTableHead()
                        this.getTableData()
                        this.preNextMonth(e)
                    }
                },
                async bulkApproval(e) {
                    this.query.txtAction = 'ACT_MONTHLY_PERMIT'
                    this.query.txtCallBeanAction = 'ACT_DISP_MONTHLY'

                    //月次一括承認Loading制御
                    this.bulkApprovalLoading = true

                    console.log("bulkApproval")
                    console.log(this.empIds)
                    console.log(this.empIds.length)

                    if (this.empIds.length === 0){
                        this.$Message.error("月次一括承認の対象者が選択されていません")
                        //月次一括承認Loading制御
                        this.bulkApprovalLoading = false

                    } else {
                        this.$Modal.confirm({
                            title: '',
                            content: 'チェックされた職員の月次就業実績を承認しますか。よろしいでしょうか？',
                            okText: 'OK',
                            cancelText: 'キャンセル',
                            onOk: async () => {
                                const { data } = await this.http.get('sys/permStatList/executeUpdateTmgMonthly', this.query)

                                //月次承認状況一覧検索処理
                                await this.getTableData()

                                //月次一括承認Loading制御
                                this.bulkApprovalLoading = false
                            },
                            onCancel: () => {
                                //選択した職員リストをクリアする
                                this.handleSelectAll(false)

                                //月次一括承認Loading制御
                                this.bulkApprovalLoading = false
                           　　 console.log(this.empIds)

                        }
                        })
                    }
                },
                async bulkApproval2(e) {
                    this.query.txtAction = 'ACT_EDIT_DAIRY'
                    this.query.txtCallBeanAction = 'ACT_DISP_MONTHLY'

                    //月次一括承認Loading制御
                    this.bulkApprovalLoading2 = true

                    console.log("bulkApproval2")
                    console.log(this.empIds2)
                    console.log(this.empIds2.length)

                    if (this.empIds2.length === 0){
                        this.$Message.warning("日次一括承認の対象者が選択されていません")
                        //日次一括承認Loading制御
                        this.bulkApprovalLoading2 = false

                    } else {
                        this.$Modal.confirm({
                            title: '',
                            content: 'チェックされた職員の日次就業実績を承認しますか。よろしいでしょうか？',
                            okText: 'OK',
                            cancelText: 'キャンセル',
                            onOk: async () => {
                                const { code,msg } = await this.http.get('sys/permStatList/executeUpdateTmgDaily', this.query)

                                //日次承認状況一覧検索処理
                                this.getReadTmgDaily()

                                //月次承認状況一覧検索処理
                                await this.getTableData()

                                //日次一括承認Loading制御
                                this.bulkApprovalLoading2 = false

                                if(code === 0){
                                    this.$Message.success({
                                        background: true,
                                        closable: true,
                                        duration: 6,
                                        content: '一括承認が正しく実施されました。'
                                    });
                                }
                            },
                            onCancel: () => {
                                //選択した職員リストをクリアする
                                this.handleSelectAll2(false)

                                //日次一括承認Loading制御
                                this.bulkApprovalLoading2 = false
                                console.log(this.empIds2)
                            }
                        })
                    }
                },
                dateFormat(e) {
                    //YYYY年MM月からYYYY/MM/01へ変換する
                    let yearMMDD = e.replace("年","/")
                    yearMMDD = yearMMDD.replace("月","/")
                    yearMMDD = yearMMDD+"01"
                    return  yearMMDD
                },

                //日次承認画面用
                //一覧から日次実績をクリックする
                async showDay(e1,e2,e3) {
                    console.log("showDay(e)")
                    console.log(e1)
                    console.log(e2)
                    console.log(this.model1)
                    console.log(e2.substr(18))

                    //画面操作不可の制御
                    this.sovlingLoading = false
                    //月次承認状態
                    this.tmoCstatusflg = e3

                    this.queryAddWork.txtTmgReferListTreeViewAdminTargetEmp = e1
                    this.queryAddWork.txtDYYYYMM = this.dateFormat(this.model1)
                    this.queryAddWork.txtAction = 'ACT_EDITINP_RDAILY'

                    let num = Math.floor(e2.substr(18))
                    this.queryAddWork.txtDYYYYMMDD = this.queryAddWork.txtDYYYYMM.substr(0,8) + ((9 >= num) ? ("0" + num) : num)
                    console.log(this.queryAddWork.txtDYYYYMMDD)

                    // 業登録画面表示
                    this.showAddWork = true
                    this.dailyloading = true

                    // 就業登録画面項目クリアする
                    this.categoryNonduty = ''
                    this.categoryOverhours = ''
                    this.dailyEdit = []
                    this.workData0 = []
                    this.detailNonDutyVOList = []
                    this.detailOverhoursVOList = []

                    this.title = '  '
                    // this.query.txtDYYYYMMDD = e
                    // this.query.txtAction = 'ACT_EDITPERM_RDAILY'
                    this.bFixed = false
                    this.bHoliday = false
                    // 業登録画面データ取得
                    await this.dailyDetail()
                    this.dailyloading = false
                },
                // 就業登録画面情報取得・設定する
                async dailyDetail() {

                    // 画面情報取得
                    const {data} = await this.http.get('sys/tmgResults/dailyDetail', this.queryAddWork)

                    // 就業区分ドロップダウン
                    this.workingIdList = data.workIdList

                    // 出張ドロップダウン
                    this.businessTripList = data.businessTripList

                    // 非勤務ドロップダウン
                    this.categoryNondutyList = data.categoryNondutyList
                    this.categoryNonduty = this.categoryNondutyList[0].itemCode

                    // 超過勤務ドロップダウン
                    this.categoryOverhoursList = data.categoryOverhoursList
                    this.categoryOverhours = this.categoryOverhoursList[0].itemCode
                    this.mgdCsparechar4VOList = data.mgdCsparechar4VOList

                    // 詳細:欠勤離籍以外
                    this.workData0 = data.dailyDetail0List
                    // 就業実績
                    this.dailyEdit = data.dailyEditVO

                    if (('TMG_DATASTATUS|9' === this.dailyEdit.tdaCstatusflg || 'TMG_DATASTATUS|5' === this.dailyEdit.tdaCstatusflg)
                        && '' !== this.dailyEdit.tdaCmodifieruseridR
                        && '' !== this.dailyEdit.tdaDmodifieddateR
                    ) {
                        this.bApproved = true
                    } else {
                        this.bApproved = false
                    }
                    this.isShowFixedMonthlyEditButton=data.isShowFixedMonthlyEditButton
                    // 登録ボタンとコメントのみ登録ボタンの表示制御
                    this.bFixed = !data.isEditable
                    if (data.workIdList.length < 2) {
                        this.bHoliday = true
                    }


                    this.isCommonDiscretionaryLabor = data.isCommonDiscretionaryLabor
                    this.isDiscretion=data.isDiscretion

                    if (this.dailyEdit.tdaNopenR !== this.dailyEdit.tdaNopenTp) {
                        this.bOpen = true
                    } else {
                        this.bOpen = false
                    }
                    if (this.dailyEdit.tdaNcloseR !== this.dailyEdit.tdaNcloseTp) {
                        this.bClose = true
                    } else {
                        this.bClose = false
                    }


                    this.dailyEdit.tdaNcloseR = this.dailyEdit.tdaNopenRHidden
                    this.dailyEdit.tdaNcloseR = this.dailyEdit.tdaNcloseRHidden


                    if (this.dailyEdit.tdaNopenTp === null) {
                        this.dailyEdit.tdaNopenTp = '---'
                    }
                    if (this.dailyEdit.tdaNcloseTp === null) {
                        this.dailyEdit.tdaNcloseTp = '---'
                    }
                    if (this.isDiscretion) {
                        this.dailyEdit.tdaNopenN = '---'
                        this.dailyEdit.tdaNcloseN = '---'
                    }

                    this.workingId = this.dailyEdit.tdaCworkingidR
                    this.businessTrip = this.dailyEdit.tdaCbusinesstripidR
                    this.title = this.dailyEdit.tdaDyyyymmddDy

                    if(this.dailyEdit.tdaCerrcode !== null){

                        let tempErrCode = JSON.parse(this.dailyEdit.tdaCerrcode)
                        Object.keys(tempErrCode).some(e => {

                            if (e === 'ERRTYPE_10') {

                                this.$Notice.error({desc: tempErrCode.ERRTYPE_10[0].ERRMSG})
                                return true
                            }
                        })

                    }
                    this.workData=[
                        {
                            workTime: '予定時間',
                            workStart: this.dailyEdit.tdaNopenN,
                            workEnd: this.dailyEdit.tdaNcloseN,
                            cellClassName: {
                                workTime: 'sub-title'
                            }
                        },
                        {
                            workTime: '打刻',
                            workStart: this.dailyEdit.tdaNopenTp,
                            workEnd: this.dailyEdit.tdaNcloseTp,
                            cellClassName: {
                                workTime: 'sub-title'
                            }
                        },
                        {
                            workTime: '就業時間',
                            workStart: this.dailyEdit.tdaNopenR,
                            workEnd: this.dailyEdit.tdaNcloseR,
                            isInput: true,
                            cellClassName: {
                                workTime: 'sub-title'
                            }
                        }]
                    this.workData0.forEach(e => {
                        this.workData = this.workData.concat(
                            {
                                workTime: e.tdadCnotworkName,
                                workStart: e.tdadNopenHhmi,
                                workEnd: e.tdadNcloseHhmi,
                                cellClassName: {
                                    workTime: 'sub-title'
                                }
                            }
                        )
                    })
                    // 非勤務
                    this.detailNonDutyVOList = data.detailNonDutyVOList
                    // 超過勤務
                    this.detailOverhoursVOList = data.detailOverhoursVOList
                    //
                    const turnLine = Vue.filter('turnLine');
                    this.dailyLog = data.columnsDailyLog.map(e => {
                        return {
                            ...e,
                            cchangelogstr: turnLine(e.cchangelogstr)

                        }
                    })
                    let limitOfBasedateVO = data.limitOfBasedateVO
                    this.overHourLimit = limitOfBasedateVO.dailyConvMinute
                    this.otDaily = limitOfBasedateVO.otDaily
                    this.targetForOverTime = data.targetForOverTime
                    this.changeWorkingID(this.workingId)
                    if(data.dailyEditVO.tdaCstatusflg==='TMG_DATASTATUS|5' && 'TMG_DATASTATUS|0'===this.tmoCstatusflg ){
                        this.notapproval=true
                    }else{
                        this.notapproval=false
                    }

                },
                handleClose() {
                    this.errorFlag = false
                    this.showAddWork = false
                    this.$emit('close')
                },
                //承認
                async updateDaily() {
                    this.sovlingLoading=true
                    if (!this.errorCheck(this.workingId)) {
                        this.sovlingLoading = false
                        return
                    }
                    this.updateDailyLoading = true

                    this.tmgResultsDto.txtDYYYYMMDD = this.queryAddWork.txtDYYYYMMDD
                    this.tmgResultsDto.txtAction = 'ACT_EDITPERM_UPERMIT'

                    this.tmgResultsDto.workingId = this.workingId
                    this.tmgResultsDto.selMgdCbusinessTrip = this.businessTrip
                    this.tmgResultsDto.holiday = null
                    this.tmgResultsDto.txtTdaNopenR = ''
                    this.tmgResultsDto.txtTdaNcloseR = ''
                    this.tmgResultsDto.tdaCowncommentR = ''
                    this.tmgResultsDto.hasAuthority = ''
                    this.tmgResultsDto.nonDutyList = []
                    this.tmgResultsDto.overHoursList = []
                    this.tmgResultsDto.targetEmp=this.queryAddWork.txtTmgReferListTreeViewAdminTargetEmp
                    this.tmgResultsDto.holiday = this.bHoliday
                    if (!this.bDisable) {

                        this.tmgResultsDto.txtTdaNopenR = this.workData[2].workStart
                        this.tmgResultsDto.txtTdaNcloseR = this.workData[2].workEnd
                        this.tmgResultsDto.tdaCowncommentR = this.dailyEdit.tdaCowncommentR
                        this.tmgResultsDto.nonDutyList = this.detailNonDutyVOList
                        this.tmgResultsDto.overHoursList = this.detailOverhoursVOList
                        if (this.bFixed || this.bHoliday) {
                            this.tmgResultsDto.hasAuthority = false
                        } else {
                            this.tmgResultsDto.hasAuthority = true
                        }
                    }
                    try {
                        const {msg} = await this.http.post('sys/tmgResults/updateDaily', this.tmgResultsDto)
                        if(msg === '0'){
                            this.updateDailyLoading = false
                            this.showAddWork = false
                            await this.getTableHead()
                            await this.getTableData()
                            return
                        }
                        this.errMsg = JSON.parse(msg)
                        let errMsg20
                        let check = Object.keys(this.errMsg).some(e => {
                            if (e === 'ERRTYPE_10') {
                                this.$Notice.error({desc: this.errMsg.ERRTYPE_10[0].ERRMSG})
                                return true
                            }
                            if (e === 'ERRTYPE_20') {
                                this.errMsg.ERRTYPE_20.forEach(e20 => {
                                    errMsg20 = errMsg20 + e20.ERRMSG + '/n'
                                })
                                this.$Notice.error({desc: errMsg20})
                            }

                        })
                        if (check) {
                            this.sovlingLoading = false
                            return false
                        }
                    }catch(errror){
                        this.sovlingLoading = false
                        retrun
                    }finally {
                        this.sovlingLoading = false
                        this.updateDailyLoading = false
                    }
                },
                //差戻
                async updateRemandsStatus() {
                    this.sovlingLoading=true
                    if (!this.errorCheck(this.workingId)) {
                        this.sovlingLoading = false
                        return
                    }
                    this.returnUpdateDailyLoading = true
                    this.tmgResultsDto.txtDYYYYMMDD = this.queryAddWork.txtDYYYYMMDD
                    this.tmgResultsDto.txtAction = 'ACT_REMANDS'
                    this.tmgResultsDto.workingId = this.workingId
                    this.tmgResultsDto.selMgdCbusinessTrip = this.businessTrip
                    this.tmgResultsDto.holiday = null
                    this.tmgResultsDto.txtTdaNopenR = ''
                    this.tmgResultsDto.txtTdaNcloseR = ''
                    this.tmgResultsDto.tdaCowncommentR = ''
                    this.tmgResultsDto.hasAuthority = ''
                    this.tmgResultsDto.nonDutyList = []
                    this.tmgResultsDto.overHoursList = []
                    this.tmgResultsDto.targetEmp=this.queryAddWork.txtTmgReferListTreeViewAdminTargetEmp
                    this.tmgResultsDto.holiday = this.bHoliday
                    if (!this.bDisable) {
                        this.tmgResultsDto.txtTdaNopenR = this.workData[2].workStart
                        this.tmgResultsDto.txtTdaNcloseR = this.workData[2].workEnd
                        this.tmgResultsDto.tdaCowncommentR = this.dailyEdit.tdaCowncommentR
                        this.tmgResultsDto.nonDutyList = this.detailNonDutyVOList
                        this.tmgResultsDto.overHoursList = this.detailOverhoursVOList
                        if (this.bFixed || this.bHoliday) {
                            this.tmgResultsDto.hasAuthority = false
                        } else {
                            this.tmgResultsDto.hasAuthority = true
                        }
                    }
                    try {
                        const {msg} = await this.http.post('sys/tmgResults/updateDaily', this.tmgResultsDto)
                        if (msg === '0') {
                            this.returnUpdateDailyLoading = false
                            this.showAddWork = false
                            await this.getTableHead()
                            await this.getTableData()
                            return
                        }
                        this.errMsg = JSON.parse(msg)
                        let errMsg20
                        let check = Object.keys(this.errMsg).some(e => {
                            if (e === 'ERRTYPE_10') {
                                this.$Notice.error({desc: this.errMsg.ERRTYPE_10[0].ERRMSG})
                                return true
                            }
                            if (e === 'ERRTYPE_20') {
                                this.errMsg.ERRTYPE_20.forEach(e20 => {
                                    errMsg20 = errMsg20 + e20.ERRMSG + '/n'
                                })
                                this.$Notice.error({desc: errMsg20})
                            }

                        })
                        if (check) {
                            this.sovlingLoading = false
                            return false
                        }
                    }catch (error) {
                        this.sovlingLoading = false
                        return
                    }finally {
                        this.sovlingLoading = false
                        this.returnUpdateDailyLoading = false
                    }
                },
                //締め済データの編集
                async edit() {
                    this.dailyloading = true
                    // 就業登録画面項目クリアする
                    this.categoryNonduty = ''
                    this.categoryOverhours = ''
                    this.dailyEdit = []
                    this.workData0 = []
                    this.detailNonDutyVOList = []
                    this.detailOverhoursVOList = []
                    this.title = '  '
                    this.queryAddWork.txtAction = 'ACT_EDITPERM_EDIT'
                    this.bFixed = false
                    this.bHoliday = false
                    // 業登録画面データ取得
                    await this.dailyDetail()
                    this.dailyloading = false
                },
                // 就業区分の切り替え表示制御
                changeWorkingID(workingid) {
                    this.bDisable = false;
                    // 休暇
                    if (this.bHoliday) {
                        this.bDisable = true;
                        this.workTimeDisable=true
                        // 休暇以外
                    } else {
                        let mgdCsparechar4VO = this.mgdCsparechar4VOList.find(e => e.mgdCmastercode === workingid)
                        // 出勤 or 休日出勤
                        if (mgdCsparechar4VO.mgdCsparechar5 == '0') {
                            this.bDisable = false;
                            this.workTimeDisable=false
                            // 欠勤
                        } else {
                            this.bDisable = true;
                            this.workTimeDisable=true
                        }
                    }
                    if (this.bDisable === true) {
                        this.workData[2].workStart=''
                        this.workData[2].workEnd=''
                        this.detailNonDutyVOList = []
                        this.detailOverhoursVOList = []

                    }
                },
                addNotWork() {
                    let categoryNondutyVO = this.categoryNondutyList.find(e => e.itemCode === this.categoryNonduty)

                    this.detailNonDutyVOList.push({
                        attributeUrl: categoryNondutyVO.attributeUrl,
                        tdadCnotworkid: categoryNondutyVO.itemCode,
                        itemName: categoryNondutyVO.itemName,
                        tdadNdeleteflg: "0",
                        tdadNopen: '',
                        tdadNclose: '',
                        tdadSeq: Date.now(),
                        tdadCsparechar1: '',
                        tdadNsparenum1: null

                    })
                },
                addOverWork() {
                    let detailOverhoursVO = this.categoryOverhoursList.find(e => e.itemCode === this.categoryOverhours)

                    this.detailOverhoursVOList.push({
                        attributeUrl: detailOverhoursVO.attributeUrl,
                        tdadCnotworkid: detailOverhoursVO.itemCode,
                        itemName: detailOverhoursVO.itemName,
                        tdadNopen: '',
                        tdadNclose: '',
                        tdadNdeleteflg: '0',
                        tdadSeq: Date.now(),
                        tdadCsparechar1: '',
                        tdadNsparenum1: '',
                        tdadCcode01: '',
                        tdadCcode01Name: '',
                        tdadCsparechar2: '',
                        tdadCsparechar2Name: ''

                    })
                },
                // エラーチェック
                errorCheck(workingid) {
                    let mgdCsparechar4VO = this.mgdCsparechar4VOList.find(e => e.mgdCmastercode === workingid)
                    // 出勤 or 休日出勤
                    if (mgdCsparechar4VO.mgdCsparechar5 != '0') {
                        return true;
                    }
                    // 修正出社時刻形式
                    if (this.workData[2].workStart ===null || !this.time_check(this.workData[2].workStart)) {
                        this.$Notice.error({desc: "就業時間・始業は適切な時刻ではありません。(hh:mm)形式で時刻を入力してください。"})
                        return false;
                    }

                    // 修正退社時刻形式
                    if (this.workData[2].workEnd ===null || !this.time_check(this.workData[2].workEnd)) {
                        this.$Notice.error({desc: "就業時間・終業は適切な時刻ではありません。(hh:mm)形式で時刻を入力してください。"})
                        return false;
                    }

                    if (this.dailyEdit.tdaCowncommentR !== null && this.getLengthB(this.dailyEdit.tdaCowncommentR) > 100) {

                        return false;
                    }

                    //非勤務
                    const checkNonDuty = this.detailNonDutyVOList.some(e => {

                        if (e.tdadNopen ===null ||  !this.time_check(e.tdadNopen)) {
                            this.$Notice.error({desc: "非勤務の開始時刻は適切な時刻ではありません。(hh:mm)形式で時刻を入力してください。"})
                            return true;
                        }
                        if (e.tdadNclose ===null ||  !this.time_check(e.tdadNclose)) {
                            this.$Notice.error({desc: "非勤務の終了時刻は適切な時刻ではありません。(hh:mm)形式で時刻を入力してください。"})
                            return true;
                        }
                        if (e.tdadCsparechar1 !== null && this.getLengthB(e.tdadCsparechar1) > 100) {
                            this.$Notice.error({desc: "中断備考が設定値を超えています。全角・半角カナ50字以内、半角英数100字以内。"})
                            return true
                        }
                    })
                    if (checkNonDuty) return false
                    // 超過勤務
                    const checkOverhour = this.detailOverhoursVOList.some(e => {

                        if (e.tdadCsparechar1 !== null && e.tdadCsparechar1.length > 100) {
                            this.$Notice.error({desc: "超過勤務備考が設定値を超えています。全角・半角カナ50字以内、半角英数100字以内。"})
                            return true
                        }
                    })
                    if (checkOverhour) return false
                    let nOverTimeTotal = 0;
                    // 超過勤務命令の明細部配下を行単位で取得
                    this.detailOverhoursVOList.forEach(e => {
                        // 超過勤務命令の時間数を算出
                        let sOpen = this.toMinuteFromHHcMI60(e.tdadNopen);
                        let sClose = this.toMinuteFromHHcMI60(e.tdadNclose);
                        nOverTimeTotal = nOverTimeTotal + (sClose - sOpen);
                    })
                    // 超過勤務命令時間が入力されていて、超過勤務対象「無」の場合は警告メッセージを表示する
                    if (nOverTimeTotal > 0 && this.targetForOverTime === "1") {
                        // 警告メッセージの表示および、応答の確認

                        if(!confirm('超過勤務対象外として設定されています。\n超過勤務命令を登録してもよろしいですか？')){
                            return false
                        }
                    }
                    // 超過勤務命令時間数合計が登録された超勤限度時間を超える場合は警告メッセージを表示する
                    if (nOverTimeTotal > this.overHourLimit) {
                        // 警告メッセージの表示および、応答の確認
                        if(!confirm('超過勤務命令の時間数が' +this.otDaily +'時間を超えています。\nこの超過勤務時間で登録してよろしいですか？')){
                            return false
                        }
                    }
                    return true;
                },
                delNotWork(row) {
                    this.detailNonDutyVOList = this.detailNonDutyVOList.filter(e => e.tdadSeq !== row.tdadSeq)
                },
                delOverWork(row) {
                    this.detailOverhoursVOList = this.detailOverhoursVOList.filter(e => e.tdadSeq !== row.tdadSeq)
                },
                time_check(sTime) {
                    return sTime.match(/^(([0-3]?[0-9])|([4][0-7])):([0-5]?[0-9])$/);
                },
                handleInputChange(i,object,value,el) {
                    // 填完后自动checkbox
                    if(object) {
                        this.hasPassedTimeCheck = Utils.checkTime(object, value,el)
                    }
                },
                getLengthB(moji) {
                    let i, j, cnt = 0;
                    let multiStr = new Array("×", "§", "¨", "°", "±", "´", "¶");
                    for (i = 0; i < moji.length; i++) {
                        for (j = 0; j < multiStr.length; j++) {
                            if (multiStr[j].length == 0) {
                                continue;
                            }
                            moji = moji.replace(multiStr[j], "00");
                        }
                    }
                    // MAC OSの場合、改行コードが「\n」となり、Windowsの改行コード「\r\n」とバイト数が異なるので、
                    moji = moji.split("\r\n").join("\n"); // 一旦「\r\n」 ⇒ 「\n」の変換を行い、改行コードを「\n」に合わせる。
                    // バイト数を求めます。
                    for (i = 0; i < moji.length; i++)
                        if (escape(moji.charAt(i)).length >= 4) cnt += 2; else cnt++;
                    return cnt;
                },
                toMinuteFromHHcMI60(pHHMM) {
                    // 何もパラメータが渡されなかった場合、そのまま返す
                    if (pHHMM === '') {
                        return '';
                    }
                    let retMinute;
                    let nHour = new Number();
                    let nMinute = new Number();
                    // 分に変換します
                    nHour = eval(+(pHHMM.split(":")[0] * 60));
                    nMinute = eval(+(pHHMM.split(":")[1]));
                    retMinute = eval(nHour + nMinute);
                    return retMinute;
                },
            }
        })
    </script>
</body>

</html>