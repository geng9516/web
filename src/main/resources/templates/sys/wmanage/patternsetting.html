<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='勤務パターン',cssPaths='/pages/content.min.css')">
</head>

<body>
<div th:replace="layout/loadingBar::loadingBar"></div>
<main class="content patternSetting-warp" @scroll.passive="handleScroll" ref="layout">
    <div class="content_head">
        <div class="header">
            <div class="title1">
                <h1>
                    <Icon type="i-emeer colored"></Icon>
                    {{ ' 勤務パターン ' }}
                </h1>
            </div>
            <div class="btnbox">
                <span style="flex:1"></span>
                <i-button type="primary" @click="handleBtn(null)" size="large" :loading="bulkApprovalLoading" disabled v-if="addPatternShow===false">+ 新規</i-button>
                <i-button type="primary" @click="handleBtn(null)" size="large" :loading="bulkApprovalLoading" v-else>+ 新規</i-button>
                <Upload action="/">
                    <i-button type="warning" ghost size="large" icon="ios-cloud-upload-outline" disabled v-if="addPatternShow===false">CSVファイル取込</i-button>
                    <i-button type="warning" ghost size="large" icon="ios-cloud-upload-outline" v-else>CSVファイル取込</i-button>
                </Upload>
            </div>
        </div>
        <div class="searchwrap">
            <span class="label">改訂日</span>
            <date-picker class="mar" v-model="curDate" type="date" :editable="false" :clearable="false" @on-change="handleDatePicker" format="yyyy年MM月dd日"></date-picker>

            <span style="display:flex;width: calc(15% + 200px);">
                    <span class="label">所属</span>
                    <i-button v-on:click.native="deptDrawShow = true" class="input-like-span mr30 cursor grey"
                              style="width: calc(100% - 120px);border-radius:0">
                        {{ deptName }}
                    </i-button>
                    <Drawer class="tc" title="所属を選択してください" placement="right" width="700" :closable="false"
                            :mask-closable="!isSearchHistory" v-model="deptDrawShow">
                        <div class="titlenorm mt15">
                            <Icon type="logo-buffer"></Icon>
                            所属
                        </div>
                        <Row class="tl">
                            <i-col span="8" class="label tc" style="height: 32px;">基準日</i-col>
                            <i-col span="8" class="no-border-radius">
                            <date-picker type="date" :value="referListObject.txtTmgReferListTreeViewRecordDate"
                                         class="mb5" placeholder="日付け" format="yyyy/MM/dd" ref="datePicker"
                                         @on-change="handleDeptDateChange"></date-picker>
                            </i-col>
                        </Row>
                        <div style="position: relative;">
                            <Tree class="tree mt2" :data="treeData" v-on:on-select-change="handleClickLeaf" ref="tree"
                                  empty-text="所属データなし"></Tree>
                            <Spin size="large" fix v-if="empDeptLoading"></Spin>
                        </div>
                    </Drawer>
                </span>
            <span style="flex:1"></span>
        </div>
    </div>
    <div class="content_body">
        <i-table :columns="columns" :data="tmgPatternList" border :loading="tableLoading">
            <!-- 勤務時間 -->
            <template slot-scope="{ row }" slot="dutyTime">
                <span v-for="(item,i) of row.planDuty" :key="i">{{item.NOPEN|handleTime}}～{{item.NCLOSE|handleTime}}</span>
            </template>
            <!-- 休憩時間 -->
            <template v-for="(item,i) of planRest" slot-scope="{row}" :slot="item">
                <span v-if="row.planRest[i] != undefined ">{{row.planRest[i].NOPEN|handleTime}}～{{row.planRest[i].NCLOSE|handleTime}}</span>
            </template>

            <template slot-scope="{ row }" slot="action">
                <div>
                    <i-button type="primary" ghost size="small" icon="ios-create" style="margin-right: 5px" :disabled="!editPatternShow" v-if="row.edit===false">編集</i-button>
                    <i-button type="primary" ghost size="small" icon="ios-create" style="margin-right: 5px" @click="handleBtn(row)" :disabled="editPatternShow" v-else>編集</i-button>

                    <i-button type="primary" ghost size="small" icon="ios-create" style="margin-right: 5px" :disabled="!deletePatternShow" v-if="row.edit===false">削除</i-button>
                    <i-button type="primary" ghost size="small" icon="ios-create" style="margin-right: 5px" @click="handleBtn(row)" :disabled="deletePatternShow" v-else>削除</i-button>
                </div>
            </template>

        </i-table>

    </div>
    <!-- 勤務パターンSTART -->
    <template>
      <span>
        <Modal v-model="isShow" :title="pageTitle" footer-hide :mask-closable="false" @on-cancel="cancel" draggable>
          <i-form :label-width="120" ref="localValue" :model="localValue" :rules="ruleValidate">
            <form-item label="所属">
              <i-button class="input-like-span mr30 cursor grey width100 border-radius:0">
                  {{ deptName }}
              </i-button>
            </form-item>

            <form-item label="コード">
              <i-input v-model="rawData.tpa_cpatternid" :disabled="isPatternCodeDisable" 　placeholder="入力してください"></i-input>
            </form-item>

            <form-item label="名称">
              <i-input v-model="rawData.tpa_cpatternname" placeholder="入力してください"></i-input>
            </form-item>

            <form-item label="勤務時間">
                <time-picker format="HH:mm" placeholder="入力してください" :steps="[1, 5]" type="timerange" class="width100" v-model="rawData.dutyTime"></time-picker>
            </form-item>

            <form-item label="休憩時間1">
                <time-picker format="HH:mm" placeholder="入力してください" 　:steps="[1, 5]" type="timerange" class="width100" v-model="rawData.planRest1"></time-picker>
            </form-item>

            <form-item label="休憩時間2">
                <time-picker format="HH:mm" 　placeholder="入力してください" :steps="[1, 5]" type="timerange" class="width100" v-model="rawData.planRest2"></time-picker>
            </form-item>

            <form-item label="休憩時間3">
                <time-picker format="HH:mm" 　placeholder="入力してください" :steps="[1, 5]" type="timerange" class="width100" v-model="rawData.planRest3"></time-picker>
            </form-item>

            <form-item label="休憩時間4">
                <time-picker format="HH:mm" 　placeholder="入力してください" :steps="[1, 5]" type="timerange" class="width100" v-model="rawData.planRest4"></time-picker>
            </form-item>

            <form-item label="日付切替時刻">
                <time-picker format="HH:mm" 　placeholder="入力してください" :steps="[1, 5]" class="width100" v-model="rawData.tpa_ndate_change_time"></time-picker>
            </form-item>

            <form-item label="翌日勤務パターン">
              <i-select v-model="ykjtPatternModel" placeholder="選択ください" filterable transfer @on-change="handleChangePattern($event)">
                  <i-option v-for="(item, index) of ykjtPatternList" :key="index" :label="item.tpa_cpatternname" :value="item.tpa_cpatternid"></i-option>
              </i-select>
            </form-item>
          </i-form>
          <div class="my-footer">
            <i-button type="text" @click="cancel">キャンセル</i-button>
            <i-button type="success" size="large" @click="add()">登録</i-button>
          </div>
        </Modal>
      </span>
    </template>
    <!-- 勤務パターン追加END -->

</main>

<div th:replace="layout/script::common_script"></div>
<script type="text/babel" th:inline="javascript">
    const PERM_STATLIST = new Vue({
        el: '.patternSetting-warp',
        data() {
            return {
                planRest: ['one', 'two', 'three', 'four'],
                isAdd: Boolean,
                localValue: {
                    name: '',
                    group: '1',
                    date: '2019年11月01日(金)'
                },
                ruleValidate: {
                    name: [
                        {
                            required: true,
                            message: '入力してください',
                            trigger: 'blur'
                        }
                    ]
                },
                curDate: new Date(),
                rawData: {
                    tpa_csectionid: '',
                    tpa_cgroupid: '',
                    tpa_cpatternid: '',
                    tpa_cpatternname: '',
                    dutyTime: [],
                    planRest1: [],
                    planRest2: [],
                    planRest3: [],
                    planRest4: [],
                    tpa_ndate_change_time: '',
                    tpa_cnextptn: '',
                    flag: ''
                },
                pageTitle: '勤務パターン追加',
                //翌日勤務パターン
                ykjtPatternList: [],
                ykjtPatternModel: '',
                isShow: false,
                loading: false,
                tableLoading: false,
                referListObject: {
                    [[${ TREEVIEW_KEY_ADMIN_TARGET_SECTION }]]: '',
                    [[${ TREEVIEW_KEY_ADMIN_TARGET_EMP }]]: '',
                    [[${ TREEVIEW_KEY_RECORD_DATE }]]: '',
                    [[${ TREEVIEW_KEY_REFRESH_FLG }]]: '',
                    txtTmgReferListTreeViewRecordDate: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    type: 31
                },
                empTreeData: [],
                deptName: '選んでください',
                query: {
                    txtAction: 'ACTION_DISP_DISP',
                    txtDYYYYMM: '',
                    txtDYYYYMMDD: '',
                    txtCallBeanAction: 'ACTION_DISP_DISP',
                    txtTmgReferListTreeViewRecordDate: '',
                    txtTmgReferListTreeViewAdminTargetSection: '',
                    txtCEMPLOYEEID: '',
                    groupId: 'null',
                    sectionId: [[${ session.psSession.loginDesignation[0].section }]],
                    txtExecuteEmpId: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    type: 31
                },
                query_ykjtPattern: {
                    txtAction: 'ACTION_DISP_DISP',
                    txtDYYYYMM: '',
                    txtDYYYYMMDD: '',
                    txtCallBeanAction: 'ACTION_DISP_DISP',
                    txtTmgReferListTreeViewRecordDate: '',
                    txtTmgReferListTreeViewAdminTargetSection: '',
                    txtCEMPLOYEEID: '',
                    groupId: 'null',
                    sectionId: [[${ session.psSession.loginDesignation[0].section }]],
                    txtExecuteEmpId: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    type: 31
                },
                empDeptLoading: false,
                deptDrawShow: false,
                treeData: [],
                selectDisabled: false,   　//年月選択可否制御
                tmgPatternList: [],       //年月リスト
                model1: '',

                title: '',
                empIds: [],
                empIds2: [],

                bulkApprovalLoading: false,
                isSearchHistory: false,

                editPatternShow: false,
                deletePatternShow: false,
                isPatternCodeDisable: false,
                addPatternShow: false,
                curDate: new Date(),
                columns: [
                    {
                        title: '勤務パターン',
                        key: 'tpa_cpatternname',
                        align: 'right'
                    },
                    {
                        title: '勤務時間',
                        slot: 'dutyTime',
                        align: 'center'
                    },
                    {
                        title: '休憩時間',
                        children: [
                            {
                                title: '1',
                                slot: 'one',
                                align: 'center'
                            },
                            {
                                title: '2',
                                slot: 'two',
                                align: 'center'
                            },
                            {
                                title: '3',
                                slot: 'three',
                                align: 'center'
                            },
                            {
                                title: '4',
                                slot: 'four',
                                align: 'center'
                            }
                        ]
                    },
                    {
                        title: '日付切替時刻',
                        key: 'tpa_ndate_change_time',
                        align: 'center'
                    },
                    {
                        title: '翌日勤務パターン',
                        key: 'tpa_cnextptn',
                        align: 'center'
                    },
                    {
                        title: '操作',
                        slot: 'action',
                        width: 150,
                        align: 'center'
                    }
                ]
            }
        },
        async mounted() {
            this.getOrgTree()
        },
        computed: {
            tableHeadFixed() {
                if (this.contentScrollTop > 300) return true
                else return false
            },
            columns() {
                let result = [
                    {
                        title: '氏名',
                        slot: 'name',
                        minWidth: 100,
                        align: 'right'
                    },
                    {
                        title: '月次\n承認',
                        slot: 'statusName',
                        minWidth: 36,
                        align: 'center'
                    }
                ]
                const that = this
                this.tableHead.forEach((e, i) => {
                    result = result.concat({
                        // title: e,
                        className: e.tcaCholflg.indexOf('1') > -1 || e.tcaCholflg.indexOf('2') > -1 || e.tcaCholflg.indexOf('3') > -1 ? 'rest' : '',
                        minWidth: 25,
                        renderHeader: (h, params) => {
                            return h(
                                'span',
                                {
                                    style: {
                                        cursor: 'pointer',
                                    },
                                    domProps: {
                                        className: 'table-head',
                                        innerHTML: e.name,
                                    },
                                    on: {
                                        click() {
                                            that.handleClickHead(e.day)
                                        },
                                    },
                                }
                            )
                        },
                        slot: `disppermStatusName${i + 1}`,
                        align: 'center'
                    })
                })
                result = result.concat({
                    type: 'selection',
                    width: 60,
                    align: 'center'
                })
                return result
            }

        },
        methods: {
            // 勤務パターンリスト
            async getTmgPatternList() {

                this.query.txtAction = 'ACTION_DISP_DISP'
                this.tableLoading = true
                const {data} = await this.http.get('sys/patternSetting/selectTmgPattern', this.query)
                this.tmgPatternList = data

                if (data.length > 0) {
                    this.model1 = data[0].val
                }

                //年月リスト.lengthがゼロ場合、非活性化にする
                if (data.length === 0) {
                    this.model1 = ''
                    this.selectDisabled = false
                }
                this.tableLoading = false
                this.addPatternShow = true
            },
            async getOrgTree(refreshDept) {
                this.empDeptLoading = true
                try {
                    const {orgList, recordDate} = await this.http.get('sys/tree', this.referListObject)
                    // 先将数据转为标准格式，再转为可用数据
                    this.treeData = Utils.convertTreeData(orgList)
                    this.referListObject.txtTmgReferListTreeViewRecordDate = recordDate
                } catch (error) {
                    return
                } finally {
                    this.loading = false
                    this.empDeptLoading = false
                }
            },
            async handleDeptDateChange(e) {
                this.referListObject.txtTmgReferListTreeViewRecordDate = e
                this.isSearchHistory = true
                await this.getOrgTree()
                this.$Notice.warning({title: '所属図更新完了', desc: "下記の所属リストから対象を選んでください"})
            },
            rowClass(row) {
                // 表格变色
                if (!row.dayDivisionCode || row.dayDivisionCode === '1') {
                    return ''
                }
                return 'sat'
            },
            handleScroll: Throttle(function (e) {
                this.contentScrollTop = e.target.scrollTop
                if (e.target.scrollTop > 200) {
                    this.isScroll = true
                } else {
                    this.isScroll = false
                }
            }, 50),

            toTop() {
                const animateMachine = requestAnimationFrame(this.toTop)
                this.$refs.layout.scrollTop = this.$refs.layout.scrollTop - this.$refs.layout.scrollTop / 5
                if (this.$refs.layout.scrollTop === 0) {
                    cancelAnimationFrame(animateMachine)
                }
            },
            convertTreeData(treeData = []) {
                return treeData.map(e => {
                    const children = e.child || e.children
                    if (children) {
                        return {
                            ...e.data,
                            title: e.data.label,
                            // 前两层级默认展开方便查看
                            expand: e.data.level < 2 || !e.data.level,
                            children: this.convertTreeData(children)
                        }
                    } else {
                        return {
                            ...e.data,
                            title: e.data.label
                        }
                    }
                })
            },

            // ----------------------
            handleDatePicker() {

            },
            //翌日勤務パターン
            handleChangePattern(e) {
                if (e) {
                    this.rawData.tpa_cnextptn = e
                }
            },
            //所属変更する
            async handleClickLeaf(e) {
                //同一部署を二回目でクリックすると、取消とするためで、エラーあり
                //よって、二回目クリックすると、何もしない
                if (!e[0]) return

                this.deptDrawShow = false
                this.query.txtAction = 'ACTION_DISP_DISP'
                this.deptName = e[0].secnic
                this.query.txtTmgReferListTreeViewAdminTargetSection = e[0].secid
                this.query.sectionId = e[0].secid
                // this.query.groupId = e[0].groupId
                this.query.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate

                //編集画面のグループと部署を設定する
                this.rawData.tpa_csectionid = e[0].secid
                this.rawData.tpa_cgroupid = e[0].groupId
                //リストの取得
                await this.getTmgPatternList()

                //新規ボタンを有効にする
                this.addPatternShow = true
            },

            // 新規と編集画面を開く
            async handleBtn(row) {
                this.tableLoading = true
                await this.getYkjtTmgPatternList()
                if (row != undefined && null != row) {
                    // 編集
                    this.pageTitle = '勤務パターン編集'
                    this.isPatternCodeDisable = true
                    this.rawData = {...row}
                    this.rawData.tpa_cpatternname = row.tpa_cpatternname
                    this.rawData.tpa_cpatternid = row.tpa_cpatternid

                    //時間フォーマットを変える
                    const handleTime = Vue.filter('handleTime');
                    const duty_start = handleTime(row.planDuty[0].NOPEN)
                    const duty_end = handleTime(row.planDuty[0].NCLOSE)
                    this.rawData.dutyTime = [duty_start, duty_end]

                    if (row.planRest[0] != undefined) {
                        const rest_start = handleTime(row.planRest[0].NOPEN)
                        const rest_end = handleTime(row.planRest[0].NCLOSE)
                        this.rawData.planRest1 = [rest_start, rest_end]
                    }
                    if (row.planRest[1] != undefined) {
                        const rest_start = handleTime(row.planRest[1].NOPEN)
                        const rest_end = handleTime(row.planRest[1].NCLOSE)
                        this.rawData.planRest2 = [rest_start, rest_end]
                    }
                    if (row.planRest[2] != undefined) {
                        const rest_start = handleTime(row.planRest[2].NOPEN)
                        const rest_end = handleTime(row.planRest[2].NCLOSE)
                        this.rawData.planRest3 = [rest_start, rest_end]
                    }
                    if (row.planRest[3] != undefined) {
                        const rest_start = handleTime(row.planRest[3].NOPEN)
                        const rest_end = handleTime(row.planRest[4].NCLOSE)
                        this.rawData.planRest4 = [rest_start, rest_end]
                    }

                    this.rawData.tpa_ndate_change_time = row.tpa_ndate_change_time
                    this.rawData.tpa_cnextptn = row.tpa_cnextptn
                    //更新
                    this.rawData.flag = 'TMG_ONOFF|1'

                    //初期化データ
                    if (row.tpa_cnextptn == '' || row.tpa_cnextptn == undefined || row.tpa_cnextptn == null) {
                        this.ykjtPatternModel = ''
                    } else {
                        this.ykjtPatternModel = row.tpa_cnextptn
                    }
                } else {
                    //新規
                    this.pageTitle = '勤務パターン新規'
                    this.rawData = []
                    this.ykjtPatternModel = ''
                    this.rawData.flag = 'TMG_ONOFF|0'

                    this.isPatternCodeDisable = false

                    /* if ((this.query.sectionId == null && this.query.sectionId == '') && (this.query.groupId == null && this.query.groupId == '')) {
                         this.$Notice.warn({title: '部署またはグループを選択してください!', desc: ""})
                         return
                     }*/
                }
                this.tableLoading = false
                this.isShow = true
            },

            //編集画面を閉じる
            cancel() {
                this.$refs.localValue.resetFields()
                this.isShow = false
            },

            //勤務パターン更新登録
            async add() {
                //   alert(this.rawData)
                this.$refs.localValue.validate(valid => {
                    if (valid) {
                        this.$emit('add')
                        this.isShow = false
                    }
                })

                //パターンを更新
                await this.http.post('sys/patternSetting/modifiEditAndNew', this.rawData)
                //新規又は編集画面を閉じる
                this.cancel()
                //リストの取得
                await this.getTmgPatternList()
                this.$Notice.info({title: this.pageTitle + 'しました', desc: ""})

            },

            //翌日勤務パターンリスト
            async getYkjtTmgPatternList() {
                this.query_ykjtPattern.sectionId = '000000'
                const {data} = await this.http.get('sys/patternSetting/selectTmgPattern', this.query_ykjtPattern)
                this.ykjtPatternList = data
                this.ykjtPatternModel = 'ykjtPatternModel'
            }

        }
    })
</script>
</body>

</html>