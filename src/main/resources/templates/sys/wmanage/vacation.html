<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head
    th:replace="layout/header::common_header(title='年次休暇管理',cssPaths='/pages/content.min.css,' + '/pages/vacation.min.css')">
</head>

<body>
    <div th:replace="layout/loadingBar::loadingBar"></div>
    <main class="content vaction-warp">
        <div class="content_head">
            <div class="header">
                <div class="title1">
                    <h1>
                        <Icon type="i-happytime colored"></Icon>
                        年次休暇管理
                    </h1>
                </div>
                <div class="btnbox">
                    <div style="height:40px;margin:2px"></div>
                </div>
            </div>
            <div class="searchwrap">
                <!-- 共通組織図画面 start-->
                <span style="display:flex;width: calc(15% + 200px);">
                    <span class="label">所属</span>
                    <i-button v-on:click.native="deptDrawShow = true" class="input-like-span mr30 cursor grey"
                        style="width: calc(100% - 120px);border-radius:0">
                        {{ deptName }}
                    </i-button>
                    <Drawer class="tc" title="所属を選択してください" placement="right" width="700" :closable="false" :mask-closable="!isSearchHistory"
                        v-model="deptDrawShow">
                        <div class="titlenorm mb5">
                            <Icon type="logo-buffer"></Icon>
                            所属
                        </div>
                        <Row class="tl mb5">
                            <i-col span="4" class="label tc" style="height: 32px;">基準日</i-col>
                            <i-col span="7" class="no-border-radius">
                            <date-picker type="date" :value="referListObject.txtTmgReferListTreeViewRecordDate"
                            placeholder="基準日" format="yyyy/MM/dd" ref="datePicker" @on-change="handleDeptDateChange"></date-picker>
                            </i-col>
                        </Row>
                        <div style="position: relative;">
                            <Tree class="tree mt2" :data="treeData" v-on:on-select-change="handleClickLeaf" ref="tree"
                            empty-text="所属データなし"></Tree>
                            <Spin size="large" fix v-if="empDeptLoading"></Spin>
                        </div>
                    </Drawer>
                </span>
                <!-- 共通組織図画面 end-->
                <span style="flex:1"></span>
            </div>
        </div>
        <div class="content_body">
            <i-table @on-row-click="showDay(arguments)" no-data-text="所属を選択して下さい。" border :columns="columns"
                :row-class-name="() => 'select-col'" :disabled-hover="true" :data="data" :loading="loading">
                <template slot-scope="{ row }" slot="investDaysSum">
                    <span>{{ row.investDaysSum | addNumDeci(true) }}</span>
                </template>

                <template slot-scope="{ row }" slot="investHours">
                    <span>{{ row.investHours | addNumDeci }}</span>
                </template>

                <template slot-scope="{ row }" slot="throughoutDaysSum">
                    <span>{{ row.throughoutDaysSum | addNumDeci(true)  }}</span>
                </template>

                <template slot-scope="{ row }" slot="throughoutHoursSum">
                    <span>{{ row.throughoutHoursSum | addNumDeci }}</span>
                </template>
            </i-table>
        </div>
    </main>
    <div th:replace="layout/script::common_script"></div>
    <script type="text/babel" th:inline="javascript">
        const VACATION = new Vue({
            el: '.vaction-warp',
            data() {
                return {
                    columns: [
                        {
                            title: '氏名',
                            key: 'name',
                            align: 'right'
                        },
                        {
                            title: '種別',
                            key: 'workertypenm',
                            minWidth: 250,
                            align: 'left'
                        },
                        {
                            title: '年次休暇付与日',
                            key: 'tphDyyyymmdd',
                            align: 'center'
                        },
                        {
                            title: '年次休暇付与',
                            children: [
                                {
                                    title: '日数',
                                    slot: 'investDaysSum',
                                    align: 'center'
                                },
                                {
                                    title: '時間数',
                                    slot: 'investHours',
                                    align: 'center'
                                }
                            ]
                        },
                        {
                            title: '年次休暇繰越',
                            children: [
                                {
                                    title: '日数',
                                    slot: 'throughoutDaysSum',
                                    align: 'center'
                                },
                                {
                                    title: '時間数',
                                    slot: 'throughoutHoursSum',
                                    align: 'center'
                                }
                            ]
                        }
                    ],
                    data: [],
                    loading: false,
                    referListObject: {
                        [[${ TREEVIEW_KEY_ADMIN_TARGET_SECTION }]]: '',
                        [[${ TREEVIEW_KEY_ADMIN_TARGET_EMP }]]: '',
                        [[${ TREEVIEW_KEY_RECORD_DATE }]]: '',
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        psApp: Utils.getUrlParam(location.href, 'psApp'),
                        type: 31
                    },
                    isSearchHistory: false,
                    empDeptLoading: false,
                    deptDrawShow: false,
                    treeData: [],
                    deptName: '選んでください'
                }
            },
            mounted() {
                console.log([[${ session }]])
                this.getOrgTree()
            },
            methods: {
                async getTableData() {
                    try {
                        this.loading = true
                        const { data } = await this.http.get('sys/wmanage/vacation/list', this.referListObject)
                        this.data = data
                    } catch (error) {
                        return
                    } finally {
                        this.loading = false
                        this.isSearchHistory = false
                    }
                },
                async getOrgTree() {
                    this.empDeptLoading = true
                    try {
                        const { orgList, recordDate } = await this.http.get('sys/tree', this.referListObject)
                        // 先将数据转为标准格式，再转为可用数据
                        this.treeData = Utils.convertTreeData(orgList)
                        const date = [[${ TREEVIEW_KEY_RECORD_DATE }]]
                        this.referListObject[date] = recordDate
                    } catch (error) {
                        return
                    } finally {
                        this.loading = false
                        this.empDeptLoading = false
                    }
                },
                showDay() {
                    //todo: 跳到详情页
                    location.href = "./VacationTablePanel/vacationtablepanel.html";
                },
                async handleDeptDateChange(e) {
                    const date = [[${ TREEVIEW_KEY_RECORD_DATE }]]
                    this.referListObject[date] = e
                    this.isSearchHistory = true
                    await this.getOrgTree()
                    this.$Notice.warning({ title:'所属図更新完了',desc:"下記の所属リストから対象を選んでください" })
                },
                async handleClickLeaf(e) {
                    this.deptDrawShow = false
                    const section = [[${ TREEVIEW_KEY_ADMIN_TARGET_SECTION }]]
                    this.referListObject[section] = e[0].secid
                    this.deptName = e[0].secnic
                    this.getTableData()
                },
            }
        })
    </script>
</body>

</html>