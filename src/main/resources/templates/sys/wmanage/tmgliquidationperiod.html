<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='清算期間設定',cssPaths='/pages/content.min.css,' + '/pages/tmgliquidationperiod.min.css')">
</head>

<body>
<div th:replace="layout/loadingBar::loadingBar"></div>
<!-- 菜单导航栏 -->
<div th:replace="layout/sider"></div>
<main class="content tmgliquidationperiod-warp" ref="layout">
    <div class="content_head">
        <div class="header">
            <div class="title1">
                <h1>
                    <Icon type="i-emeer colored"></Icon>
                    {{  '清算期間設定' }}
                </h1>
            </div>
        </div>
        <!--todo:button-->
    </div>
    <div class="searchwrap">
        <!-- 共通組織図画面 start-->
        <span style="display:flex;width: calc(15% + 250px);">
            <i-input class=" ml15 like-select" style="width: 300px;" placeholder="検索" @on-enter="getSearchTableData" v-model="optsSearch.searchText">
                <i-select v-model="optsSearch.type" slot="prepend" style="width: 100px;">
                    <i-option value="0" label="氏名"></i-option>
                    <i-option value="1" label="カタカナ"></i-option>
                    <i-option value="2" label="番号"></i-option>
                </i-select>

            </i-input>
            <i-button class="mr15" type="primary" icon="md-search" ghost :loading="loading" @click="getSearchTableData">検索</i-button>
        </span>

        <span style="display:flex;width: calc(15% + 150px);">
            <span class="label">種別</span>
    <!--        <i-select v-model="workTypeName" class="mr30" @on-change="handlSelectWorkType($event)"-->
    <!--                  placeholder="選択ください">-->
    <!--            <option-group v-for="(item, i) of dispWorkTypeList" :key="i" :label="item.workTypeName" :value="item.workTypeGroupId">-->
    <!--                <i-option v-for="(e, i) of item.list" :value="e.worktypeid" :key="i" :label="e.worktypeName">-->
    <!--                </i-option>-->
    <!--            </option-group>-->
    <!--        </i-select>-->
            <i-button v-on:click.native="workTypeDrawShow = true" class="input-like-span dept-select">
                <Tooltip trigger="hover" :theme="toolTipTheme()" transfer>{{workTypeName}}
                    <div slot="content">{{workTypeName}}</div>
                </Tooltip>
            </i-button>
            <Drawer class="tc" placement="right" width="500" :closable="false"
                  v-model="workTypeDrawShow">
                <div class="titlenorm mb5">
                    <Icon type="logo-buffer"></Icon>
                    種別
                </div>
                <div style="position: relative;">
                    <Tree class="tree mt2" :data="dispWorkTypeList" v-on:on-select-change="handleClickLeaf"
                          empty-text="種別データなし"></Tree>
                    <Spin size="large" fix v-if="workTypeLoading"></Spin>
                </div>
            </Drawer>



        </span>
    </div>
    <div class="content_body">
        <div class="titlenorm mb10 ">
            <Icon type="logo-buffer"></Icon>
            精算一覧
        </div>
        <Alert class="primary-info mt10">123</Alert>
        <i-table :disabled-hover="true"
                 border :row-class-name="() => 'select-col'"
                :data="tableData" :loading="loading" :columns="columns"
                 no-data-text="123">
            <template slot-scope="{ row }" slot="dailymaxworktime">{{row.dailymaxworktime}}分
            </template>
            <template slot-scope="{ row }" slot="weeklymaxworktime">{{row.weeklymaxworktime}}時
            </template>
            <template slot-scope="{ row }" slot="totalworkdays" v-if="row.totalworkdays">{{row.totalworkdays}}日
            </template>
            <template slot-scope="{ row }" slot="detail">
                <i-button class="width100" size="small" v-if="row.newflag" @click="showDetails(row)">{{row.statusname}}</i-button>
                <i-button class="width100" size="small" v-else @click="showDetails(row)">新規</i-button>
            </template>
        </i-table>



<!--        <Drawer class="tc" title="精算期間詳細" placement="right" width="700" :closable="false" v-model="editFlag">-->

<!--            <div class="tr">-->
<!--                <i-button type="error" class="mr15 mb10" ghost @click="insertLiquidation" v-if="0===0">登録</i-button>-->
<!--                <i-button type="primary" class="mb10" ghost @click="deleteLiquidation" v-if="0===0">削除</i-button>-->
<!--            </div>-->
<!--            <div class="titlenorm mb10 mt10" style="font-size:15px">-->
<!--                <Icon type="logo-buffer"></Icon>-->
<!--                精算期間-->
<!--            </div>-->
<!--            <Row>-->
<!--                <i-col span="20" class="tl">-->
<!--                    <date-picker class="mar"  type="month" v-model="curDateFrom" :editable="false" :clearable="false"-->
<!--                                 format="yyyy年MM月"></date-picker>-->
<!--                    - -->
<!--                    <date-picker class="mar"  type="month" v-model="curDateTo" :editable="false" :clearable="false"-->
<!--                                 format="yyyy年MM月"></date-picker>-->
<!--                </i-col>-->
<!--                <i-col span="4" class="tr">-->
<!--                    <i-button type="primary" @click="handleDatePicker" ghost>期間作成</i-button>-->
<!--                </i-col>-->
<!--            </Row>-->

<!--            <div class="titlenorm mb10 mt10" style="font-size:15px">-->
<!--                <Icon type="logo-buffer"></Icon>-->
<!--                精算期間一覧-->
<!--            </div>-->
<!--            <i-table border :columns="editColumns" :disabled-hover="true" ref="table"-->
<!--                     :data="editTableDate">-->
<!--                <template slot-scope="{ row }" slot="result">-->
<!--                    <i-input v-model="row.result"></i-input>-->
<!--                </template>-->

<!--                <template slot-scope="{ row }" slot="adjust"><span>{{ row.result - row.standard }}</span></template>-->
<!--            </i-table>-->
<!--            <i-table border :columns="totalColumns" :disabled-hover="true"-->
<!--                     :data="autoTotalDate">-->
<!--            </i-table>-->
<!--        </Drawer>-->




        <Modal title="精算期間詳細"  width="90" :mask-closable="false" footer-hide v-model="editFlag">
            <div class="table-top">
                <Row  class="mb10">
                    <i-col span="24" class="tr">
                        <i-button type="primary" class="mr5" ghost icon="md-paper">印刷</i-button>
                        <i-button type="primary" ghost icon="md-filing">登録</i-button>
                    </i-col>
                </Row>

            </div>

            <Alert type="error" class="error-info" >123 123 123 123 123 123</Alert>

            <div class="titlenorm mb10 mt10" style="font-size:15px">
                <Icon type="logo-buffer"></Icon>
                精算期間一覧
            </div>
            <i-table
                    class="mt10"
                    max-height="730"
                    border
                    :columns="columns4Year"
                    :data="tableData4Year"
                    :loading="loading"
                    :span-method="handleSpan"
                    ref="tableDisp"
            >
                <template slot-scope="{ row }" slot="yyyymm">
                    <span style="text-decoration: underline" @click="showMonth(row.yyyymm)" >{{ row.yyyymm }}</span>
                </template>
                <template v-for="(e, j) of tableHead" slot-scope="{ row }" :slot="`m${j + 1}`">
                    <div :class="i === 0 ? `sum-row ${item.color}` : `divi-hour-line sum-row ${item.color}`" v-for="(item, i) of row[`m${j + 1}`]" :key="i">{{ item.label || '&nbsp;' }}</div>
                </template>
            </i-table>
        </Modal>

        <Modal title="新規精算期間"  width="40" :mask-closable="false" footer-hide v-model="newFlg">
            <Row :gutter="10">
                <i-col span="8">
                    <div class="label" style="padding:1px 0">所属</div>
                    <div class="person-info">{{ empInfo.deptName }}</div>
                </i-col>
                <i-col span="7">
                    <div class="label" style="padding:1px 0">氏名</div>
                    <div class="person-info">{{ empInfo.empName }}</div>
                </i-col>
                <i-col span="9">
                    <div class="label" style="padding:1px 0">種別</div>
                    <div class="person-info">{{ empInfo.empWorkTypeName }}</div>
                </i-col>
            </Row>

            <div class="titlenorm mt20 mb20 ">
                <Icon type="logo-buffer"></Icon>
                新規精算
            </div>
            <Alert type="error" class="error-info" v-if="newErrorMsg">{{newErrorMsg}}</Alert>
            <div class="tr mb20">
                <i-form :label-width="300" ref="newLiquidationInfo" :model="newLiquidationInfo" @submit.native.prevent>
                    <form-item label="精算期間">
                        <date-picker style="width:48.3%" type="date" class="datepicker-single tl" transfer v-model="newLiquidationInfo.curDateFrom" format="yyyy/MM/dd" placeholder="日付"></date-picker>&nbsp;<span style="position: relative; top: -8px;">-</span>&nbsp;<date-picker style="width:48.3%" type="date" class="datepicker-single tl" transfer v-model="newLiquidationInfo.curDateTo" format="yyyy/MM/dd" :editable="false" placeholder="日付" ></date-picker>
                    </form-item>
                    <form-item label="一週間の平均労働時間数">
                        <input-number class="width100" v-model="newLiquidationInfo.avgWorkTime" placeholder="分"/>
                    </form-item>
                    <form-item label="一日最大労働時間">
                        <input-number class="width100" v-model="newLiquidationInfo.dailyMaxWorkTime" placeholder="分"/>
                    </form-item>
                    <form-item label="一週最大労働時間">
                        <input-number class="width100" v-model="newLiquidationInfo.weeklyMaxWorkTime" placeholder="日"/>
                    </form-item>
                    <form-item label="総労働日数">
                        <input-number class="width100" v-model="newLiquidationInfo.totalWorkDays" placeholder="日"/>
                    </form-item>
                    <form-item label="最も長い連続労働日数">
                        <input-number class="width100" v-model="newLiquidationInfo.maxContiDays" placeholder="週"/>
                    </form-item>
                    <form-item label="４８時間を超える週の最長連続週数">
                        <input-number class="width100" v-model="newLiquidationInfo.maxContiWeeks" placeholder="週"/>
                    </form-item>
                    <form-item label="三っ月の労働時間が４８時間を超える週数">
                        <input-number class="width100" v-model="newLiquidationInfo.contiWeeks" placeholder="週"/>
                    </form-item>
                </i-form>
            </div>
            <div class="tr">
                <i-button type="primary" @click="makeNewLiquidation" ghost>期間作成</i-button>
            </div>
        </Modal>
        <!-- 勤務パターンSTART -->
        <Modal title="新規パターン" width="40" v-model="patternFlg"  footer-hide :mask-closable="false">
            <Alert type="error" class="error-info" v-show="patternErrorMsg">{{ patternErrorMsg }}</Alert>
            <i-form :label-width="120" ref="localValue">
                <form-item label="所属">
                    <span class="input-like-span">
                        {{ empInfo.deptName }}
                    </span>
                </form-item>

                <form-item label="名称">
                    <i-input v-model="patternInfo.patternName" placeholder="入力してください"></i-input>
                </form-item>

                <form-item label="勤務時間">
                    <Row>
                        <i-col span="11">
                            <i-input v-model="patternInfo.startTime" placeholder="開始時間" maxlength="5" icon="ios-clock-outline"
                                     @on-blur="handleInputChange(patternInfo,'startTime',$event.target)"></i-input>
                        </i-col>
                        <i-col span="2">
                            <span style="display: inline-block;vertical-align: sub;color:grey;margin-top: 17px;margin-left: 20px">～</span>
                        </i-col>
                        <i-col span="11">
                            <i-input v-model="patternInfo.endTime" placeholder="終了時間" maxlength="5" icon="ios-clock-outline"
                                     @on-blur="handleInputChange(patternInfo,'endTime',$event.target)"></i-input>
                        </i-col>
                    </Row>
                </form-item>

                <form-item label="休憩時間1">
                    <Row>
                        <i-col span="11">
                            <i-input v-model="patternInfo.restTime[0].restOpen" placeholder="開始時間" maxlength="5" icon="ios-clock-outline"
                                     @on-blur="handleInputChange(patternInfo.restTime[0],'restOpen',$event.target)"></i-input>
                        </i-col>
                        <i-col span="2">
                            <span style="display: inline-block;vertical-align: sub;color:grey;margin-top: 17px;margin-left: 20px">～</span>
                        </i-col>
                        <i-col span="11">
                            <i-input v-model="patternInfo.restTime[0].restClose" placeholder="終了時間" maxlength="5" icon="ios-clock-outline"
                                     @on-blur="handleInputChange(patternInfo.restTime[0],'restClose',$event.target)"></i-input>
                        </i-col>
                    </Row>
                </form-item>
                <form-item label="休憩時間2">
                    <Row>
                        <i-col span="11">
                            <i-input v-model="patternInfo.restTime[1].restOpen" placeholder="開始時間" maxlength="5" icon="ios-clock-outline"
                                     @on-blur="handleInputChange(patternInfo.restTime[1],'restOpen',$event.target)"></i-input>
                        </i-col>
                        <i-col span="2">
                            <span style="display: inline-block;vertical-align: sub;color:grey;margin-top: 17px;margin-left: 20px">～</span>
                        </i-col>
                        <i-col span="11">
                            <i-input v-model="patternInfo.restTime[1].restClose" placeholder="終了時間" maxlength="5" icon="ios-clock-outline"
                                     @on-blur="handleInputChange(patternInfo.restTime[1],'restClose',$event.target)"></i-input>
                        </i-col>
                    </Row>
                </form-item>
                <div class="tr" >
                    <i-button @click="insertNewPattern">登録</i-button>
                </div>

            </i-form>
        </Modal>



        <Modal title = "月編集画面"　width="90" :mask-closable="false" footer-hide v-model="monthlyEditFlg">
            <div class="tr">
                <i-button @click="updateMonthInfo"　icon="md-filing">登録</i-button>
            </div>

            <div class="titlenorm mb10 ">
                <Icon type="logo-buffer"></Icon>
                パターン一覧
            </div>
            <Row class="mb10">
                <i-col span="4">
                    <div class="label tc">勤務パターン</div></i-col>
                <i-col span="20">
                    <template>
                    <radio-group v-model="workPattern" type="button">
                        <Radio v-for="(item, i) of workPatternList" :label="item.patternId" :key="i" >{{item.patternName}}</Radio>
                        <Radio label="TMG_HOLFLG|1" key="4">法休</Radio>
                        <Radio label="TMG_HOLFLG|3" key="5">定休</Radio>
                        <Radio label="TMG_LIQUIDATION_PATTERN|CUSTOMIZE" key="6">カスタマイズ</Radio>
                    </radio-group>
                    </template>
                    <i-button  @click="makeNewPattern">新規</i-button>
                </i-col>
            </Row>

            <Alert class="primary-info tl">123</Alert>
            <i-table border ref="monthTable" :columns="columnsMonth" :data="monthData" :row-class-name="monthColDisabled"  @on-row-click="patternSet">

                <template slot-scope="{ row, index }" slot="workhours">{{computeWorkTime( monthData[index].starttime,monthData[index].endtime,monthData[index].restTime,index ) }}
                </template>

                <template slot-scope="{ row, index }" slot="starttime">
                    <i-input v-model="monthData[index].starttime" v-if="colClick(index)"　@on-blur="handleInputChange(monthData[index],'starttime', $event.target)"></i-input>
                    <span class="input-like-span" v-else>{{monthData[index].starttime}}</span>
                </template>

                <template slot-scope="{ row, index }" slot="endtime">
                    <i-input v-model="monthData[index].endtime" v-if="colClick(index)" @on-blur="handleInputChange(monthData[index],'endtime', $event.target)"></i-input>
                    <span class="input-like-span" v-else>{{monthData[index].endtime}}</span>
                </template>

                <template slot-scope="{ row, index }" slot="restTime" >
                    <div v-if="colClick(index)">
                        <Row :gutter="10" v-for="(item, i) of monthData[index].restTime" :key="i" class="mb5" >
                            <i-col :span="monthData[index].restTime.length > 1 ? 8 : 12">
                                <i-input v-model="monthData[index].restTime[i].restOpen" @on-blur="handleInputChange(monthData[index].restTime[i],'restOpen', $event.target)"/>
                            </i-col>
                            <i-col :span="monthData[index].restTime.length > 1 ? 8 : 12">
                                <i-input v-model="monthData[index].restTime[i].restClose" @on-blur="handleInputChange(monthData[index].restTime[i],'restClose', $event.target)"/>
                            </i-col>
                            <i-col span="8" v-show="monthData[index].restTime.length > 1">
                                <i-button ghost type="error" @click="handleMinusRest(monthData[index].restTime, i)">-</i-button>
                            </i-col>
                        </Row>
                        <i-button
                                class="mt5"
                                size="small"
                                ghost
                                type="success"
                                long
                                @click="handleAddRest(monthData[index].restTime)"
                                v-show="monthData[index].restTime.length < 2 && monthData[index].patternid === 'TMG_LIQUIDATION_PATTERN|CUSTOMIZE' "
                        >+</i-button>
                    </div>
                    <div v-else>
                        <Row :gutter="10" v-for="(item, i) of monthData[index].restTime" :key="i" class="mb5" >
                            <i-col :span="monthData[index].restTime.length > 1 ? 8 : 12">
                                <span class="input-like-span" >{{monthData[index].restTime[i].restOpen}}</span>
                            </i-col>
                            <i-col :span="monthData[index].restTime.length > 1 ? 8 : 12">
                                <span class="input-like-span" >{{monthData[index].restTime[i].restClose}}</span>
                            </i-col>
                        </Row>
                    </div>
                </template>
            </i-table>
        </Modal>

    </div>
</main>

<div th:replace="layout/head::header"></div>
<script type="text/babel" th:inline="javascript">
    const FIVE_DAYS_HOLIDAY = new Vue({
        el: '.tmgliquidationperiod-warp',
        data() {
            return {
                workTypeDrawShow:false,
                loading:false,
                workTypeLoading:false,
                workTypeName:'',
                dispWorkTypeList:[],
                columns: [
                    {
                        title: '氏名',
                        key: 'employeename',
                        minWidth: 60,
                        align: 'left'
                    },
                    {
                        title: '所属',
                        key: 'deptname',
                        minWidth: 100,
                        align: 'center'
                    },
                    {
                        title: '種別',
                        minWidth: 100,
                        key: 'worktypename',
                        align: 'center'
                    },
                    {
                        title: '適用開始日',
                        key: 'startdate',
                        align: 'center'
                    },
                    {
                        title: '適用終了日',
                        key: 'enddate',
                        align: 'center'
                    },
                    {
                        title: '日最大労働時間',
                        slot: 'dailymaxworktime',
                        align: 'center'
                    },
                    {
                        title: '週最大労働時間',
                        slot: 'weeklymaxworktime',
                        align: 'center'
                    },
                    {
                        title: '総労働日数',
                        slot: 'totalworkdays',
                        align: 'center'
                    },
                    {
                        title: '更新者',
                        minWidth: 60,
                        key: 'modifieduser',
                        align: 'center'
                    },
                    {
                        title: '更新日付',
                        minWidth: 60,
                        key: 'modifieddate',
                        align: 'center'
                    },
                    {
                        title: '登録内容',
                        Width: 40,
                        slot: 'detail',
                        align: 'center'
                    },
                ],
                tableData:[],
                optsSearch:{
                    workType:'',
                    type:'0',
                    searchText:'',
                },
                optsEmp:{
                    empId:'',
                    startDate:'',
                    endDate:'',
                },
                editFlag:false,
                empInfo:{
                    empId:'',
                    empName:'',
                    empWorkTypeName:'',
                    empWorkTypeId:'',
                    deptName:'',
                    sectionId:''
                },
                editColumns:[
                    {
                        title: '年月',
                        key: 'yyyymm',
                        align: 'center'
                    },
                    {
                        title: '標準時間',
                        key: 'standard',
                        align: 'center'
                    },
                    {
                        title: '調整時間',
                        slot: 'result',
                        align: 'center'
                    },
                    {
                        title: '調整数値',
                        slot: 'adjust',
                        align: 'center'
                    },
                ],
                editTableDate:[],
                totalColumns:[
                    {
                        title: '期間',
                        key: 'yyyymm',
                        align: 'center'
                    },
                    {
                        title: '総標準時間',
                        key: 'totalStandard',
                        align: 'center'
                    },
                    {
                        title: '総調整時間',
                        key: 'totalResult',
                        align: 'center'
                    },
                    {
                        title: '結果',
                        key: 'totalAdjust',
                        align: 'center'
                    },
                ],
                totalDate:[],


                //新規画面
                newFlg:false,
                newErrorMsg:'',
                newLiquidationInfo:{
                    empId:'',
                    sectionId:'',
                    workTypeId:'',
                    curDateFrom:'',
                    curDateTo:'',
                    avgWorkTime:'',
                    dailyMaxWorkTime:'',
                    weeklyMaxWorkTime:'',
                    totalWorkDays:'',
                    maxContiDays:'',
                    maxContiWeeks:'',
                    contiWeeks:''
                },

                //編集画面
                show3:true,
                button4Pattern:['1','2'],
                tableData4Year: [
                    {
                        yyyymm: '2020/07',
                        m1: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '1:30', color: '' }
                        ],
                        m2: [
                            { label: '', color: '' },
                            { label: '二外', color: 'blue' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m3: [
                            { label: '会:1:30', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '1:30', color: '' }
                        ],
                        m4: [
                            { label: '', color: '' },
                            { label: '前', color: 'blue' },
                            { label: 'ﾆB', color: '' },
                            { label: '1:30', color: '' }
                        ],
                        m5: [
                            { label: '外2F2:+', color: '' },
                            { label: '前', color: 'blue' },
                            { label: 'ﾆB', color: '' },
                            { label: '1:30', color: '' }
                        ],
                        m6: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '1:00', color: '' }
                        ],
                        m7: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '1:00', color: '' }
                        ],
                        m8: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '1:30', color: '' }
                        ],
                        m9: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '1:30', color: '' }
                        ],
                        m10: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '1:30', color: '' }
                        ],
                        m11: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '1:30', color: '' }
                        ],
                        m12: [
                            { label: '外1F4', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '1:30', color: '' }
                        ],
                        m13: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m14: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m15: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m16: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m17: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m18: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m19: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m20: [
                            { label: '外1F4', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m21: [
                            { label: '研2+', color: '' },
                            { label: '/ネ', color: 'red1' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m22: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m23: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m24: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m25: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m26: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m27: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m28: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m29: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m30: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        m31: [
                            { label: '', color: '' },
                            { label: 'ﾆA', color: '' },
                            { label: 'ﾆB', color: '' },
                            { label: '', color: '' }
                        ],
                        workTime: '14',
                        yeahrest: '3'
                    },
                    {
                        yyyymm: '2020/07',
                        m1: '',
                        m2: '',
                        m3: '',
                        m4: '',
                        m5: '',
                        m6: '',
                        m7: '',
                        m8: '',
                        m9: '',
                        m10: '',
                        m11: '',
                        m12: '',
                        m13: '',
                        m14: '',
                        m15: '',
                        m16: '',
                        m17: '',
                        m18: '',
                        m19: '',
                        m20: '',
                        m21: '',
                        m22: '',
                        m23: '',
                        m24: '',
                        m25: '',
                        m26: '',
                        m27: '',
                        m28: '',
                        m29: '',
                        m30: '',
                        m31: '',
                        workTime: '',
                        yeahrest: ''
                    },
                ],
                tableHead: Utils.getNumArray(1, 31),
                leftTable: [],
                centerTable: [],
                rightTable: [],

                //月编辑画面
                editMonth:'',
                columnsMonth:[
                    {
                        title: '日付',
                        key: 'yyyymmdd',
                        minWidth: 100,
                        align: 'left'
                    },
                    {
                        title: '区分',
                        key: 'kuben',
                        minWidth: 100,
                        align: 'left'
                    },
                    {
                        title: 'パターン',
                        key: 'patternname',
                        minWidth: 100,
                        align: 'left'
                    },
                    {
                        title: '労働時間',
                        slot: 'workhours',
                        minWidth: 100,
                        align: 'center'
                    },
                    {
                        title: '勤務時間',
                        children:[
                            {
                                title: '開始時間',
                                slot: 'starttime',
                                minWidth: 100,
                                align: 'left'
                            },
                            {
                                title: '終了時間',
                                slot: 'endtime',
                                minWidth: 100,
                                align: 'left'
                            },
                        ]
                    },
                    {
                        title: '休憩時間',
                        slot: 'restTime',
                        minWidth: 100,
                        align: 'left'
                    },
                    {
                        title: 'コメント',
                        key: 'comment',
                        minWidth: 100,
                        align: 'left'
                    },
                ],
                monthData:[],
                monthlyEditFlg:false,
                dailyDisabedArr:[],
                workPattern:'',
                workPatternList:[],



                //pattern編集画面

                patternInfo:{
                    sectionId:'',
                    worktypeId:'',
                    empId:'',
                    patternName:'',
                    startTime:'',
                    endTime:'',
                    restTime:[
                        {
                            restOpen:'',
                            restClose:''
                        },
                        {
                            restOpen:'',
                            restClose:''
                        },
                    ]
                },
                patternFlg:false,
                patternErrorMsg:'',
            }
        },
        async mounted() {
            this.getWorkTypeList()

        },

        computed: {
            columns4Year() {
                    let result = [
                        {
                            title: '年月',
                            slot: 'yyyymm',
                            width: 100,
                            align: 'center',
                            fixed: 'left'
                        },
                    ]
                    this.tableHead.forEach((e, i) => {
                        result = result.concat({
                            title: `${i + 1}日`,
                            className: '',
                            minWidth: 70,
                            slot: `m${i + 1}`,
                            align: 'center'
                        })
                    })
                    result = result.concat([
                        {
                            title: '労働時間',
                            key: 'workTime',
                            width: 70,
                            align: 'center',
                            fixed: 'right'
                        },
                        {
                            title: '年休',
                            key: 'yeahrest',
                            width: 70,
                            align: 'center',
                            fixed: 'right'
                        }
                    ])
                    return result
                }

        },
        methods: {
            async getWorkTypeList() {
                try {
                    this.loading=true
                    const {data} = await this.http.get('sys/tmgliquidationperiod/WorkTypeList', this.referListObject)
                    const convertedTreeData = this.convertTreeData(data)
                    this.dispWorkTypeList=[{worktypeid:'all',title:'全て',expand:true,children:convertedTreeData}]
                    this.handleClickLeaf()
                } catch (error) {
                    return
                } finally {
                    this.loading=false
                }
            },
            /**
             * 通用转化所属选择器data
             * @param treeData 标准树形数据
             * @param fristDisable 是否禁用第一项
             *
             */
            convertTreeData(treeData) {
                if(!treeData) {
                    Vue.prototype.$Message.error({
                        background:true,
                        closable: true,
                        duration: 6.5,
                        content: '参照できる種別が存在しません。'
                    });
                    return []
                }
                return treeData.map((e) => {
                    const children = e.child
                    if (children) {
                        return {
                                    ...e,
                                    title: e.worktypename,
                                    // 前两层级默认展开方便查看
                                    expand: true,
                                    children: this.convertTreeData(children)
                        }
                    } else {
                        return {
                            ...e,
                            expand: true,
                            title: e.worktypename
                        }
                    }
                })
            },

            async handleClickLeaf(e) {
                let selectid
                if (!e) {
                    selectid='all'
                    this.workTypeName='全て'
                }else{
                    selectid=e[0].worktypeid
                    this.workTypeName=e[0].worktypename
                }
                try {
                    this.loading=true
                    this.optsSearch.workType=selectid
                    this.optsSearch.searchText= ''
                    this.optsSearch.type = '0'
                    const {data} = await this.http.get('sys/tmgliquidationperiod/Disp', this.optsSearch)
                    this.tableData = data.liquidationPeriodList
                    this.workTypeDrawShow=false
                } catch (error) {
                    return
                } finally {
                    this.loading=false
                }
            },
            async getSearchTableData() {
                if (!this.optsSearch.searchText) {
                    this.handleClickLeaf()
                }
                try {
                    this.loading = true
                    this.workTypeName='検索中'
                    this.optsSearch.workType = ''
                    const {data} = await this.http.get('sys/tmgliquidationperiod/Disp', this.optsSearch)
                    this.tableData = data.liquidationPeriodList
                    this.workTypeDrawShow = false
                } catch (error) {
                    return
                } finally {
                    this.loading = false
                }
            },
            async showDetails(e) {
                this.empInfo.empId=e.employeeid
                this.empInfo.empWorkTypeId=e.worktypeid
                this.empInfo.deptName=e.deptname
                this.empInfo.sectionId=e.sectionid
                this.empInfo.empName=e.employeename
                this.empInfo.empWorkTypeName=e.worktypename
                if(e.newflag){
                    try {
                        this.optsEmp.empId = e.employeeid
                        this.optsEmp.startDate = e.startdate
                        this.optsEmp.endDate = e.enddate
                        const {data} = await this.http.get('sys/tmgliquidationperiod/EditDisp', this.optsEmp)
                        this.editTableDate = data.monthDtoList
                        this.centerTable = this.$refs.tableDisp.$el.childNodes[0].childNodes[4].childNodes[0].childNodes[1].childNodes
                        this.leftTable = this.$refs.tableDisp.$el.childNodes[0].childNodes[10].childNodes[2].childNodes[0].childNodes[1].childNodes
                        this.rightTable = this.$refs.tableDisp.$el.childNodes[0].childNodes[12].childNodes[2].childNodes[0].childNodes[1].childNodes
                        this.editFlag = true;
                    } catch (error) {
                        return
                    } finally {
                    }
                }else{
                    this.newLiquidationInfo.empId=this.empInfo.empId
                    this.newLiquidationInfo.sectionId=this.empInfo.sectionId
                    this.newLiquidationInfo.workTypeId=this.empInfo.empWorkTypeId
                    this.newFlg=true
                }
            },

            async insertLiquidation() {
                const OPTS = {
                    empId: this.empInfo.empId,
                    worktypeId: this.empInfo.empWorkTypeId,
                    startDate: Utils.formatDate(this.curDateFrom, 'yyyy/mm/dd'),
                    endDate: Utils.formatDate(this.curDateTo, 'yyyy/mm/dd'),
                    tldDtos: this.$refs.table.rebuildData
                }
                try {
                    const {data} = await this.http.post('sys/tmgliquidationperiod/InsertLiquidation', OPTS)
                } catch (error) {
                    return
                } finally {
                }
            },
            //删除清算
            deleteLiquidation(){

            },
            //清算详细表格合并
            handleSpan ({ row, column, rowIndex, columnIndex }) {
                //每月第二行时 第一列时 计算周几并且合并到周日（周一为周开始日的情况下）
                if(rowIndex % 2 === 1  && columnIndex === 1){
                    return [1,(8-new Date("1/1/2020").getDay())];
                }else if(rowIndex % 2 === 1  && columnIndex > 1 && columnIndex < (9-new Date("1/1/2020").getDay())){
                    return [0,0];
                }
                //每月第二行时 非第一列 合并（周一为周开始日的情况下）
                if (rowIndex % 2 === 1  && columnIndex > (8-new Date("1/1/2020").getDay()) &&  (columnIndex-8+new Date("1/1/2020").getDay()) % 7 === 1 && columnIndex < 32) {
                    //最后一个只合并剩余
                    if((31-columnIndex) < 7){
                        return [1,31-columnIndex+1];
                    }else{
                        return [1, 7];
                    }
                }else if(rowIndex % 2 === 1  && columnIndex > (8-new Date("1/1/2020").getDay()) && (columnIndex-8+new Date("1/1/2020").getDay()) % 7 != 1 && columnIndex < 32){
                    return [0,0];
                }
                //每月第一行时 非日期列 合并3格  table存在fixed情况下 3张表同用index 用title作区分
                if(column.title != '1日'  && rowIndex % 2 === 0 &&  columnIndex < 2 ){
                    return [2, 1];
                } else if(column.title != '1日'  && rowIndex % 2 === 1 &&   columnIndex  < 2 ){
                    return [0, 0];
                }
            },
            //时间转换
            handleInputChange(object, index, el) {
                if (object) {
                    this.hasPassedTimeCheck = Utils.checkTime(object, index)
                    this.$set(object, index, object[index])
                }
            },
            //新规清算区间
            async makeNewLiquidation() {
                this.$Modal.confirm({
                    inDrawer: true,
                    width: 480,
                    title: '注意',
                    content: 'この精算期間を新規します。よろしいですか？',
                    okText: 'OK',
                    cancelText: 'キャンセル',
                    onOk: async () => {
                        try {
                            const { msg } = await this.http.post('sys/tmgliquidationperiod/insertLiquidation', this.newLiquidationInfo)
                            this.newFlg = false;
                        } catch (error) {
                            return
                        } finally {
                        }
                    }
                })
            },

            //日期天数差
            DateDiff(sDate1,  sDate2){
                iDays  =  parseInt(Math.abs(oDate1-oDate2)/1000/60/60/24)    //把相差的毫秒数转换为天数
                return  iDays
            },
            //月编辑画面显示
            async showMonth(e) {
                this.editMonth=e
                let OPTS={
                    empId:this.empInfo.empId,
                    yyyymm:e
                }
                try {
                    const {data} = await this.http.get('sys/tmgliquidationperiod/EditMonthDisp', OPTS)
                    let monthInfo= data.liquidationDailyInfoVoList.map(e => {
                        if(e.reststarttime2){
                            return{
                                ...e,
                                restTime: [
                                    {
                                        restOpen: e.reststarttime1,
                                        restClose: e.restendtime1
                                    },
                                    {
                                        restOpen: e.reststarttime2,
                                        restClose: e.restendtime2
                                    },
                                ]
                            }}
                        if(e.reststarttime1){
                            return{
                                ...e,
                                restTime: [{
                                    restOpen: e.reststarttime1,
                                    restClose: e.restendtime1
                                }]}
                        }else{
                            return{
                                ...e,
                                restTime: []
                            }
                        }
                    })
                    this.monthData = monthInfo
                    //获取patternList
                    this.workPatternList = data.workPatternList
                    console.log(this.workPatternList)
                    this.monthlyEditFlg = true
                } catch (error) {
                    return
                } finally {
                }

            },
            //休息时间的减号处理
            handleMinusRest(e, i) {
                e.splice(i, 1)
            },
            //休息时间的加号处理
            handleAddRest(e) {
                e.push({ restOpen: '', restClose: '' })
            },
            //控制行disabled
            monthColDisabled(row,index){
                //customize下都不显示
                if(row.disabled){
                    return 'disabled'
                }else{
                    return 'white select-col'
                }
            },
            //控制行pattern
            colClick(e){
                if(this.monthData[e].patternid === 'TMG_LIQUIDATION_PATTERN|CUSTOMIZE'){
                    return true
                }else{
                    return false
                }
            },
            //将此行设置为当前点击pattern
            async patternSet(row,index){
                //如果此行disabled 不可更新
                if(this.monthData[index].disabled) return
                //重复点击
                if(this.workPattern === this.monthData[index].kubunid) return
                //非customize按钮
                if(this.workPattern && this.workPattern === 'TMG_LIQUIDATION_PATTERN|CUSTOMIZE'){
                    console.log(this.workPattern)
                    //customize按钮
                    this.monthData[index].kubunid=this.workPattern
                    this.monthData[index].kubun='出勤'
                    this.monthData[index].patternid='TMG_LIQUIDATION_PATTERN|CUSTOMIZE'
                    this.monthData[index].patternname='カスタマイズ'
                    this.monthData[index].starttime=''
                    this.monthData[index].endtime=''
                    this.monthData[index].restTime=[{ restOpen: '', restClose: '' }]
                }else if(this.workPattern && this.workPattern.indexOf('TMG_HOLFLG') > -1){
                    console.log(this.workPattern)
                    this.monthData[index].kubunid=this.workPattern
                    this.monthData[index].kubun=this.workPattern === 'TMG_HOLFLG|3'? '所定休' : '法定休'
                    this.monthData[index].patternid=''
                    this.monthData[index].patternname=''
                    this.monthData[index].starttime=''
                    this.monthData[index].endtime=''
                    this.monthData[index].restTime=[]
                } else if(this.workPattern && this.workPattern != 'TMG_LIQUIDATION_PATTERN|CUSTOMIZE'){
                    console.log(this.workPattern)
                    this.monthData[index].patternid=this.workPattern
                    this.workPatternList.some(e => {
                        if(e.patternId===this.workPattern){
                            console.log(e)
                            this.monthData[index].kubunid=this.workPattern
                            this.monthData[index].kubun='出勤'
                            this.monthData[index].patternid= this.workPattern
                            this.monthData[index].patternname = e.patternName
                            this.monthData[index].starttime=e.startTime
                            this.monthData[index].endtime=e.endTime
                            this.monthData[index].restTime=e.restTime
                            return
                        }
                    })
                }
            },

            // 计算单日劳动时间
            computeWorkTime (startTime,endTime,restTimeList,index) {
                if (!startTime || !endTime) return ''
                let checkRestTime=restTimeList.every(e=> {
                    if (!e.restOpen || !e.restClose) return true
                    //休息在工作时间范围内
                    if(Utils.timeToMinute(endTime)>Utils.timeToMinute(e.restClose) && Utils.timeToMinute(e.restOpen)>Utils.timeToMinute(startTime)){
                        //休息结束大于休息开始
                        if(Utils.timeToMinute(e.restClose) > Utils.timeToMinute(e.restOpen)){
                            return true
                        }
                    }
                    return false
                })
                if(!checkRestTime) return ''
                let computeTime =0
                restTimeList.forEach(e=> {
                    computeTime=computeTime+Utils.timeToMinute(e.restClose) - Utils.timeToMinute(e.restOpen)
                })
                if(index){
                    this.monthData[index].workhours=Utils.timeToMinute(endTime)-Utils.timeToMinute(startTime)-computeTime
                }
                return Utils.timeToMinute(endTime)-Utils.timeToMinute(startTime)-computeTime
            },
            //更新月数据
           async updateMonthInfo(){
               this.monthData.forEach((e,i)=>{
                   if(e.restTime.length === 1){
                       this.monthData[i].reststarttime1=this.monthData[i].restTime[0].restOpen
                       this.monthData[i].restendtime1=this.monthData[i].restTime[0].restClose
                   }else if(e.restTime.length === 2){
                       this.monthData[i].reststarttime2=this.monthData[i].restTime[1].restOpen
                       this.monthData[i].restendtime2=this.monthData[i].restTime[1].restClose
                       this.monthData[i].reststarttime1=this.monthData[i].restTime[0].restOpen
                       this.monthData[i].restendtime1=this.monthData[i].restTime[0].restClose
                   }
               })
               let OPTS={
                   empId:this.optsEmp.empId,
                   startDate:this.optsEmp.startDate,
                   endDate:this.optsEmp.endDate,
                   monthList:this.monthData,
               }
               try {
                   const { data } = await this.http.post('sys/tmgliquidationperiod/UpdateLiquidationDaily', OPTS)
               } catch (error) {
                   return
               } finally {

               }
            },
            //新規パターン画面の表示
            makeNewPattern(){
                this.patternFlg=true
                //重制新规pattern
                this.patternInfo={
                        sectionId:'',
                        worktypeId:'',
                        empId:'',
                        patternName:'',
                        startTime:'',
                        endTime:'',
                        restTime:[
                            {
                                restOpen:'',
                                restClose:''
                            },
                            {
                                restOpen:'',
                                restClose:''
                            },
                        ]
                }
            },
            //登陆新规pattern
            async insertNewPattern() {
                this.patternInfo.restTime.every((e,i)=> {
                    //休息在工作时间范围内
                    if(Utils.timeToMinute(this.patternInfo.endTime)>Utils.timeToMinute(e.restClose) && Utils.timeToMinute(e.restOpen)>Utils.timeToMinute(this.patternInfo.startTime)){
                        //休息结束大于休息开始
                        if(!(Utils.timeToMinute(e.restClose) > Utils.timeToMinute(e.restOpen))){
                            this.$Notice.error({desc: "终了时间小于开始时间"})
                        }
                    }else{
                        this.$Notice.error({desc: "休息时间不在工作时间范围内"})
                    }
                })
                let workTime = this.computeWorkTime(this.patternInfo.startTime, this.patternInfo.endTime, this.patternInfo.restTime)
                if(workTime === ''){
                    return
                }
                if (workTime > 600) {
                    this.$Notice.error({desc: "工作时间超过法定上限"})
                    return
                }
                try {
                    //登陆新规pattern
                    const {data} = await this.http.post('sys/tmgliquidationperiod/insertPattern', this.patternInfo)
                    //重新加载页面
                    this.showMonth(this.editMonth)
                    this.patternFlg=false
                } catch (error) {
                    return
                } finally {

                }
            }

        }
    })
</script>
</body>

</html>