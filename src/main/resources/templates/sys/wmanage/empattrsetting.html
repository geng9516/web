<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='個人属性設定',cssPaths='/pages/content.min.css')">
</head>

<body>
<div th:replace="layout/loadingBar::loadingBar"></div>
<!-- 菜单导航栏 -->
<div th:replace="layout/sider"></div>
<main class="content empattrsettinginfo-warp" @scroll.passive="handleScroll" ref="layout">
    <div class="content_head">
        <div class="header">
            <div class="title1">
                <h1>
                    <Icon type="i-emeer colored"></Icon>
                    {{ `個人属性設定` }}
                </h1>
            </div>
            <div class="btnbox">
                <span style="flex:1"></span>
                <i-button type="primary" size="large" icon="md-create"  @click="isEditable = !isEditable"  v-if=" !isEditable">対象者一括編集</i-button>
                <i-button type="success" icon="md-create" size="large" v-if=" isEditable" @click="manageFlagUpdate">登録</i-button>
                <i-button size="large" v-if=" isEditable" @click="isEditable = !isEditable">キャンセル</i-button>
            </div>

        </div>
        <div class="searchwrap">
            <span class="label">年月日</span>
            <date-picker class="mar" v-model="curDate" type="date" :editable="false" :clearable="false"
                         @on-change="handleDatePicker" format="yyyy年MM月dd日"></date-picker>
            <!-- 共通組織図画面 start-->
            <span style="display:flex;width: calc(15% + 200px);">
                    <span class="label">所属</span>
                    <i-button v-on:click.native="deptDrawShow = true" class="input-like-span mr30 cursor grey"
                              style="width: calc(100% - 120px);border-radius:0">
                        {{ deptName }}
                    </i-button>

                    <Drawer class="tc" title="所属を選択してください" placement="right" width="700" :closable="false"
                            :mask-closable="!isSearchHistory" v-model="deptDrawShow">
                       <Tabs :animated="false" v-model="currentTab" @on-click="currentTabChanged">
                        <tab-pane label="ツリー" name="organisationTree">
                              <div class="titlenorm mt15">
                                    <Icon type="logo-buffer"></Icon>
                                    所属
                                </div>

                               <Row class="tl mb5">
                                    <i-col span="4" class="label tc" style="height: 32px;">基準日</i-col>
                                    <i-col span="7" class="no-border-radius">
                                    <date-picker type="date" :value="referListObject.txtTmgReferListTreeViewRecordDate"
                                                 placeholder="基準日" format="yyyy/MM/dd" ref="datePicker" @on-change="handleDeptDateChange"></date-picker>
                                    </i-col>
                                </Row>
                                <Tree class="tree mt2" :data="treeData" @on-select-change="handleClickLeaf" ref="tree"
                                      empty-text="所属データなし"></Tree>

                        </tab-pane>
                        <tab-pane label="検索" name="organisationSearch">
                               <Row class="tl mb2" :gutter="8">
                                    <i-col span="15">
                                        <i-input v-model="referListObject.hidSearchData" @on-search="searchOrgTree" class="mar mb5 like-select" search enter-button placeholder="検索">
                                            <i-select v-model="referListObject.hidSearchItems" slot="prepend" style="width: 108px" placeholder="項目">
                                                <i-option v-for="(item,i) of searchTypesList" :value="item.value">{{ item.name }}</i-option>
                                            </i-select>
                                            <i-select v-model="referListObject.hidSearchCondition"  slot="append" style="width: 108px" placeholder="条件">
                                                <i-option v-for="(item,i) of searchConditionsList" :value="item.value">{{ item.name }}</i-option>
                                            </i-select>
                                        </i-input>
                                    </i-col>
                                    <i-col span="8" class="no-border-radius">
                                        <i-button long type="primary" icon="md-search" ghost :loading="empDeptLoading" @click="searchOrgTree">検索</i-button>
                                    </i-col>
                                </Row>
                                <div class="titlenorm mt15">
                                    <Icon type="logo-buffer"></Icon>
                                    社員
                                </div>
                                <div style="position: relative;">
                                    <Tree class="tree mt2" :data="searchEmpTreeData" @on-select-change="handleClickEmpLeaf" empty-text="社員データなし"></Tree>
                                    <Spin size="large" fix v-if="emplistLoading"></Spin>
                                </div>
                        </tab-pane>
                        </Tabs>
                    </Drawer>
                </span>
            <!-- 共通組織図画面 end-->
            <span style="flex:1"></span>
        </div>
        <div class="content_body">
            <div class="table-top">
                <Row :gutter="16">
                    <i-col span="12">
                        <Page :total="pageValue.amount" :current="pageValue.curPage" show-total style="display: inline"
                              :page-size="pageValue.curSize" @on-change="pageChange" ref="Page" />
                    </i-col>
                    <i-col class="tr" span="10" v-if="isEditable" style="margin-left: 8%;">
                        <i-button type="primary" ghost @click="checkAlladmin" class="mr15">
                            管理対象者 一括チェック
                        </i-button>
                        <i-button type="primary" ghost @click="checkOverWorkAlladmin" class="pr20 pl20">
                            超過勤務対象者 一括チェック
                        </i-button>
                    </i-col>
                </Row>
            </div>
            <template>
                <div>
                    <i-table border :columns="columns" :data="tableData" :loading="loading" :disabled-hover="true"
                             :row-class-name="() => 'select-col'">
                        <template slot-scope="{ row }" slot="manageFlg">
                                <span :class="row.manageFlg ? 'blue' : 'red'"
                                      v-show="!isEditable">{{ `${row.manageFlg ? '〇' : '除外'}` }}</span>
                            <Checkbox v-show="isEditable" v-model="row.manageFlg" @on-change="checkBoxChange($event,row._index,'manage')"></Checkbox>
                        </template>

                        <template slot-scope="{ row }" slot="excludeOvertime">
                                <span :class="row.excludeOvertime ? 'blue' : 'red'"
                                      v-show="!isEditable">{{ `${row.excludeOvertime ? '〇' : '除外'}` }}</span>
                            <Checkbox v-show="isEditable" v-model="row.excludeOvertime" @on-change="checkBoxChange($event,row._index,'over')"></Checkbox>
                        </template>


                        <template slot-scope="{ row }" slot="begindate">
                            <i-button type="primary" ghost size="small" style="margin-right: 5px"
                                      @click.stop="handleBeginDate(row)">
                                {{ row.begindate }}
                            </i-button>
                        </template>

                        <template slot-scope="{ row }" slot="tphaNavgworktime">
                            <i-button type="primary" ghost size="small" style="margin-right: 5px"
                                      @click.stop="handleAvgTime(row)">
                                {{ row.tphaNavgworktime | handleTime }}
                            </i-button>
                        </template>

                        <template slot-scope="{ row }" slot="tphaNworkingdaysWeek">
                            <i-button type="primary" ghost size="small" style="margin-right: 5px"
                                      @click.stop="handleAvgTime(row)">
                                {{ row.tphaNworkingdaysWeek }}
                            </i-button>
                        </template>


                    </i-table>
                </div>
            </template>
        </div>
    </div>



    <Modal v-model="isShow" title="個人属性設定" width="850" @on-cancel="cancel" :mask-closable="false" footer-hide
           >
        <Row :gutter="10">
            <i-col span="8">
                <div class="label">所属</div>
                <div class="person-info">{{ deptName }}</div>
            </i-col>
            <i-col span="8">
                <div class="label">氏名</div>
                <div class="person-info">{{ empName }}</div>
            </i-col>
            <i-col span="8">
                <div class="label">種別</div>
                <div class="person-info">{{ workerTypeName }}</div>
            </i-col>
        </Row>

        <Alert v-if="isBeginDateEdit" class="primary-info lb tl">{{ msg }}</Alert>
        <Alert v-if="false" type="error" class="error-info lb tl">{{ errorMsg }}</Alert>

        <div class="tr mb10" v-if="isBeginDateEdit">
            <i-button type="error" ghost class="mr15" @click="beginDateDelete">削除</i-button>
            <i-button @click.stop="clear" class="mr15" ghost type="primary">クリア</i-button>
            <i-button type="success" ghost class="mr15" @click="beginDateUploadOrUpdate">登録</i-button>
        </div>
        <div class="tr mb10" v-else>
            <i-button class="mr15" ghost type="error" @click="avgWorkTimeDelete">削除</i-button>
            <i-button class="mr15" ghost type="success" @click="avgWorkTimeUpload">登録</i-button>
        </div>

        <span v-if="isBeginDateEdit">
                <Row :gutter="10" class="mt20 mb10" v-if="isBeginDateEdit">
                    <i-col span="15">
                        <div class="titlenorm">
                            <Icon type="logo-buffer"></Icon>
                            勤務開始日設定状況
                        </div>

                        <i-table border :columns="workDaySettingColums" :data="workDaySettingData" :loading="loading"  v-if="!forClear"　key="forClear2"
                                 class="mt2">
                            <template slot-scope="{ row }" slot="radio">
                                <Radio v-model="row.isChecked" @on-change="handleRadio(row._index)"></Radio>
                            </template>

                            <template slot-scope="{ row }" slot="time">
                                <date-picker :value="workDaySettingData[row._index].dstart" format="yyyy/MM/dd" type="date" transfer
                                             style="width:47%" :disabled="row._index !== radioCheckedIndex"
                                             @on-change="workDaySettingData[row._index].dstart=$event">
                                </date-picker>

                                <date-picker :value="workDaySettingData[row._index].dend" format="yyyy/MM/dd" type="date" transfer
                                             style="width:47%" :disabled="row._index !== radioCheckedIndex"
                                             @on-change="workDaySettingData[row._index].dend=$event">
                                </date-picker>

                            </template>

                            <template slot-scope="{ row }" slot="beginDate">
                                <date-picker :value="workDaySettingData[row._index].beginDate" :disabled="row._index !== radioCheckedIndex"
                                             format="yyyy/MM/dd" type="date" transfer
                                             @on-change="workDaySettingData[row._index].beginDate=$event"></date-picker>
                            </template>
                        </i-table>
                    </i-col>
                    <i-col span="9">
                        <div class="titlenorm">
                            <Icon type="logo-buffer"></Icon>
                            [参考]発令上の勤務開始日
                        </div>
                        <i-table border :columns="referSettingColums" :data="referSettingData" :loading="loading"
                                 class="mt2"></i-table>
                    </i-col>
                </Row>
                <div class="titlenorm mb10" v-if="isBeginDateEdit">
                    <Icon type="logo-buffer"></Icon>
                    更新履歴
                </div>
                <i-table border :columns="historyColums" :data="historyData" :loading="loading" v-if="isBeginDateEdit">
                </i-table>
            </span>




        <span v-if="isAvgTimeEdit">
                <div class="titlenorm mt10" style="margin-bottom:0">
                    <Icon type="logo-buffer"></Icon>
                    平均勤務時間設定:変更内容
                </div>
                <span class="input-like-span tl pl20" style="border-top:0">
                    {{opts.baseDate}} から
                    <i-input size="small" class="mr10 ml10" style="width: 50px"  v-model="nowWork.nowWorkTime" @on-blur="handleInputChange(0,nowWork,'nowWorkTime',$event.target)"></i-input>
                    (週
                    <i-input size="small" class="mr10 ml10" style="width: 50px" v-model="nowWork.nowWorKDays"></i-input>
                    日) 勤務とする
                </span>
                <div class="titlenorm mb10 mt20">
                    <Icon type="logo-buffer"></Icon>
                    平均勤務時間設定状況
                </div>

                <i-table border :columns="averageTimeColums" :data="averageTimeData" :loading="loading"></i-table>
            </span>
    </Modal>
</main>
<div th:replace="layout/head::header"></div>
<script type="text/babel" th:inline="javascript">
    const MONTH_SUM_INFO = new Vue({
        el: '.empattrsettinginfo-warp',
        data() {
            return {
                limitTime:'',
                searchEmpTreeData: [],        //組織ツリー用
                searchTypesList: [],     //組織ツリー用
                searchConditionsList: [],//組織ツリー用
                emplistLoading: false,  //職員番号ローディング用動画
                empTreeData: [],
                currentTab: '',         //組織のツリーと検索タブーを切り替え
                manageValue:[],
                overValue:[],
                contentScrollTop: 0,
                pageValue: {
                    amount: 0,
                    curPage: 1,
                    curSize: 50
                },
                radioCheckedIndex: 0,
                nowWork: {
                    nowWorkTime: '',
                    nowWorKDays: ''
                },
                empName: '',
                workerTypeName: '',
                isBeginDateEdit: false,
                isAvgTimeEdit: false,
                forClear: false,
                msg: '※勤務開始日の変更によって年休付与日が変動する場合、設定済みの調整付与日数はクリアされます。\n' +
                    '　変更後、年次休暇管理を確認し、残日数がマイナスになっている場合は改めて調整をしてください。\n' +
                    '※注意：選択した対象区間のみ、更新処理を実行します。',
                errorMsg: '',
                isShow: false,
                loading: false,
                isEditable: false,
                curDate: new Date(),
                deptName: '選んでください',  //選択した職員の所属
                isSearchHistory: false,
                deptDrawShow: false,    //組織ツリー用
                empDeptLoading: false,  // 組織ツリーloading用
                referListObject: {       //組織ツリー共通
                    hidSearchItems:'EMPLOYEEID',
                    hidSearchCondition:'BROADMATCH',
                    hidSearchData:'',
                    [[${ TREEVIEW_KEY_ADMIN_TARGET_SECTION }]]: '',
                    [[${ TREEVIEW_KEY_ADMIN_TARGET_EMP }]]: '',
                    [[${ TREEVIEW_KEY_ADMIN_TARGET_GROUP }]]: '',
                    [[${ TREEVIEW_KEY_RECORD_DATE }]]: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    type: 21
                },
                treeData: [],            //組織ツリー用
                opts: {
                    hidSearchItems:'EMPLOYEEID',
                    hidSearchCondition:'BROADMATCH',
                    hidSearchData:'',
                    hidSelectTab:'0',      //組織タブー0：ツリ、1:検索
                    keyword: '',
                    baseDate: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    //目标sec
                    txtTmgReferListTreeViewAdminTargetSection: '',
                    //基准日
                    txtTmgReferListTreeViewRecordDate: '',
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    type: 21,
                    page: '1',
                    empId: ''
                },
                columns: [
                    {
                        title: '氏名',
                        key: 'meCkanjiname',
                        width: 150,
                        align: 'right'
                    },
                    {
                        title: '職種',
                        key: 'hdCpostname',
                        minWidth: 180,
                        align: 'left',
                        tooltip: true
                    },
                    {
                        title: '種別',
                        key: 'temCworktypename',
                        minWidth: 220,
                        align: 'left',
                        tooltip: true
                    },
                    {
                        title: '管理対象者',
                        slot: 'manageFlg',
                        minWidth: 80,
                        maxWidth: 200,
                        align: 'center'
                    },
                    {
                        title: '超過勤務対象者',
                        minWidth: 80,
                        maxWidth: 200,
                        slot: 'excludeOvertime',
                        align: 'center'
                    },
                    {
                        title: '勤務開始日',
                        slot: 'begindate',
                        minWidth: 100,
                        align: 'center'
                    },
                    {
                        title: '平均勤務\n時間設定',
                        slot: 'tphaNavgworktime',
                        minWidth: 80,
                        align: 'center'
                    },
                    {
                        title: '週勤務日数',
                        minWidth: 60,
                        slot: 'tphaNworkingdaysWeek',
                        align: 'center'
                    }
                ],
                tableData: [],
                referSettingColums: [
                    {
                        title: '発令日',
                        key: 'dstart'
                    },
                    {
                        title: '勤務開始日',
                        key: 'ddateofemployement'
                    }
                ],
                averageTimeColums: [
                    {
                        title: '開始年月日',
                        key: 'tphaDstartdate',
                        align: 'cener'
                    },
                    {
                        title: '終了年月日',
                        key: 'tphaDenddate'
                    },
                    {
                        title: '設定内容',
                        key: 'content'
                    }
                ],
                historyColums: [
                    {
                        title: '更新者',
                        key: 'modifieruserId',
                        align: 'right',
                        width: 150
                    },
                    {
                        title: '更新日時',
                        key: 'modifieddate',
                        align: 'center',
                        width: 200
                    },
                    {
                        title: '更新内容',
                        key: 'tdlgCmodifieddetail',
                        align: 'left'
                    }
                ],
                workDaySettingColums: [
                    {
                        title: ' ',
                        slot: 'radio',
                        width: 35
                    },
                    {
                        title: '適用期間',
                        slot: 'time',
                        width: 300
                    },
                    {
                        title: '勤務開始日',
                        slot: 'beginDate'
                    }
                ],
                workDaySettingData: [],
                beginDateListBackUp:[],
                averageTimeData: [],
                historyData: [],
                referSettingData: [],
                hasPassedTimeCheck:false
            }
        },
        async mounted() {
            this.getOrgTree()
            this.getSearchCondition()
        },

        methods: {
            async getSearchCondition() {
                const { data } = await this.http.get('sys/tree/conditions', this.referListObject)
                this.searchConditionsList= Object.keys(data.searchConditions).map(e=> { return { name:data.searchConditions[e], value:e }})
                this.searchTypesList = Object.keys(data.searchTypes).map(e=> { return { name:data.searchTypes[e], value:e }})
            },
            async avgWorkTimeUpload(){
                if (this.avgWorkTimeCheck()) {
                    return
                }
                let params={"sAvgWorkingHours":this.nowWork.nowWorkTime.split(":")[0],"sAvgWorkingMinutes":this.nowWork.nowWorkTime.split(":")[1],"sWorkingdaysWeek":this.nowWork.nowWorKDays}
                const OPTS = { ...this.opts,"params":JSON.stringify(params)}
                try{
                    this.$Modal.confirm({
                        title: '',
                        content: '表示されている内容を登録します。\nなお、登録した内容は翌日から反映されます。\nよろしいですか？',
                        okText: 'OK',
                        cancelText: 'キャンセル',
                        onOk: async () => {
                            await this.http.postForm('sys/userprofile/avgWorkTimeUpload', OPTS)
                            this.$Notice.info({title: '登録成功', desc: ""})
                            this.isShow = false
                            this.getTableData()
                        }
                    })
                }catch (error) {
                    return
                }

            },

            // エラーチェック
            avgWorkTimeCheck() {
                if(this.nowWork.nowWorkTime === ""){
                    this.$Notice.error({desc: "平均勤務時間は入力してください。"})
                    return true
                }
                let hours=+this.nowWork.nowWorkTime.split(":")[0]
                let mins=+this.nowWork.nowWorkTime.split(":")[1]
                if (hours*60 + mins > +(this.limitTime)) {
                    this.$Notice.error({desc: "平均勤務時間は" + this.limitTime +"分以内で入力してください。"})
                    return true
                }
                if (this.nowWork.nowWorKDays > '6' || this.nowWork.nowWorKDays === "" ) {
                    this.$Notice.error({desc: "週勤務日数は6日以内で入力してください。"})
                    return true
                }
                return false
            },
            async avgWorkTimeDelete(){
                let params={"sAvgWorkingHours":this.nowWork.nowWorkTime.split(":")[0],"sAvgWorkingMinutes":this.nowWork.nowWorkTime.split(":")[1],"sWorkingdaysWeek":this.nowWork.nowWorKDays}
                const OPTS = { ...this.opts,"params":JSON.stringify(params)}
                try{
                    this.$Modal.confirm({
                        title: '',
                        content: '基準日以降の設定内容を削除します。\nなお、削除した内容は翌日から反映されます。\nよろしいですか？',
                        okText: 'OK',
                        cancelText: 'キャンセル',
                        onOk: async () => {
                            await this.http.postForm('sys/userprofile/avgWorkTimeDelete', OPTS)
                            this.$Notice.info({title: '取消成功', desc: ""})
                            this.isShow = false
                            this.getTableData()
                        }
                    })
                }catch (error) {
                    return
                }
            },
            async beginDateDelete(){
                let index=this.radioCheckedIndex
                let oldValue=Array.of(this.workDaySettingData[index]).map(e=>{
                    return {'action':'ACTION_EDITBEGINDATE_D',"psOldStartDate":e.dstart,"psOldEndDate":e.dend,'psOldBeginDate':e.beginDate,'psMaxOldStartDate':''}
                })[0]

                let params={...oldValue}
                const OPTS = { ...this.opts,"params":JSON.stringify(params)}
                try{
                    this.$Modal.confirm({
                        title: '',
                        content: '選択された行の設定を削除します。よろしいですか？',
                        okText: 'OK',
                        cancelText: 'キャンセル',
                        onOk: async () => {
                            await this.http.postForm('sys/userprofile/beginDateDelete', OPTS)
                            this.$Notice.info({title: '登録成功', desc: ""})
                            this.isShow = false
                            this.workDaySettingData.splice(index,1)
                            this.getTableData()
                        }
                    })

                }catch (error) {

                }
            },
            // エラーチェック
            beginDateCheck() {
                let index=this.radioCheckedIndex;
                let minDate = new Date('1900/1/1');
                let maxDate = new Date('2222/12/31');
                if (this.workDaySettingData[index].dend ===""){
                    this.workDaySettingData[index].dend = '2222/12/31'
                }
                if ( this.workDaySettingData[index].beginDate === "" ) {
                    this.$Notice.error({desc: "勤務開始日を入力してください。"})
                    return true
                }
                if ( this.workDaySettingData[index].dstart === "" ) {
                    this.$Notice.error({desc: "適用開始日を入力してください。"})
                    return true
                }
                if ( this.workDaySettingData[index].dend === "" ) {
                    this.$Notice.error({desc: "適用終了日を入力してください。"})
                    return true
                }
                if(this.workDaySettingData[index].dstart > this.workDaySettingData[index].dend){
                    this.$Notice.error({desc: "適用開始日＜＝適用終了日となるように入力してください。"})
                    return true
                }
                if(new Date(this.workDaySettingData[index].dstart) > maxDate || new Date(this.workDaySettingData[index].dstart) < minDate){
                    this.$Notice.error({desc: "適用開始日は適切な日付ではありません。\n1900/01/01～2222/12/31の範囲で入力してください。"})
                    return true
                }
                if(new Date(this.workDaySettingData[index].dend) > maxDate || new Date(this.workDaySettingData[index].dend) < minDate){
                    this.$Notice.error({desc: "適用終了日は適切な日付ではありません。\n1900/01/01～2222/12/31の範囲で入力してください。"})
                    return true
                }
                if(new Date(this.workDaySettingData[index].beginDate) > maxDate || new Date(this.workDaySettingData[index].beginDate) < minDate){
                    this.$Notice.error({desc: "勤務開始日は適切な日付ではありません。\n1900/01/01～2222/12/31の範囲で入力してください。"})
                    return true
                }
                let check = this.workDaySettingData.some((e) => {
                    if(e.dstart !="" ){
                        if( new Date(this.workDaySettingData[index].dstart) > new Date(e.dstart)  && new Date(this.workDaySettingData[index].dstart) < new Date(e.dend)  ){
                            this.$Notice.error({desc: "入力された適用期間が既に登録されている適用期間と重複しています。\n適用期間が重複しない様に日付を変更してください。"})
                            return true
                        }
                        if(new Date(this.workDaySettingData[index].dend) < new Date(e.dend)   && new Date(this.workDaySettingData[index].dend)  > new Date(e.dstart)  ){
                            this.$Notice.error({desc: "入力された適用期間が既に登録されている適用期間と重複しています。\n適用期間が重複しない様に日付を変更してください。"})
                            return true
                        }
                    }
                })
               if(check){
                   return true
               }

                return false
            },
            async beginDateUploadOrUpdate(){
                if (this.beginDateCheck()) {
                    return
                }
                let index=this.radioCheckedIndex;

                let max=Math.max.apply(null,this.beginDateListBackUp.slice(1).map(e=> new Date(e.dstart)))

                let psMaxOldStartDate=Utils.formatDate(new Date(max))

                let tempUrl;
                let msg;
                let newValue;
                let oldValue;
                if(index==0){
                    tempUrl="beginDateUpload"
                     newValue=Array.of(this.workDaySettingData[index]).map(e=>{
                        return {'action':'ACTION_EDITBEGINDATE_C',"psStartDate":e.dstart,"psEndDate":e.dend,'psBeginDate':e.beginDate}
                    })[0]
                    msg="勤務開始日の設定を新規登録します。よろしいですか？"
                }else{
                    tempUrl="beginDateUpdate"
                    msg="選択された行の設定を変更します。よろしいですか？"
                     newValue=Array.of(this.workDaySettingData[index]).map(e=>{
                        return {'action':'ACTION_EDITBEGINDATE_U',"psStartDate":e.dstart,"psEndDate":e.dend,'psBeginDate':e.beginDate}
                    })[0]
                    oldValue=Array.of(this.beginDateListBackUp[index]).map(e=>{
                        return {"psOldStartDate":e.dstart,"psOldEndDate":e.dend,'psOldBeginDate':e.beginDate,'psMaxOldStartDate':psMaxOldStartDate}
                    })[0]
                }
                let params={...newValue,...oldValue}
                const OPTS = { ...this.opts,"params":JSON.stringify(params)}

                try{
                    this.$Modal.confirm({
                        title: '',
                        content: msg,
                        okText: 'OK',
                        cancelText: 'キャンセル',
                        onOk: async () => {
                            await this.http.postForm('sys/userprofile/'+tempUrl, OPTS)
                            this.workDaySettingData[index].isChecked=false
                            this.workDaySettingData.unshift({"isChecked": true,"dstart":'',"dend": '', "dendback": '',"beginDate": ''})
                            this.isShow = false
                            this.getTableData()
                        }
                    })

                }catch (e) {
                    return
                }

            },
            async manageFlagUpdate(){
                const OPTS = { ...this.opts,"ManageList":JSON.stringify(this.manageValue),
                        "OverTimesList":JSON.stringify(this.overValue)}
                try{
                    this.$Modal.confirm({
                        title: '',
                        content: '表示されている内容を登録します。よろしいですか？\n※登録されるのは現在表示されている項目のみとなります。',
                        okText: 'OK',
                        cancelText: 'キャンセル',
                        onOk: async () => {
                            await this.http.postForm('sys/userprofile/manageFlagUpdate', OPTS)
                            this.$Notice.info({title: '登録成功', desc: ""})
                            this.isEditable=false
                            this.getTableData()
                        }
                    })

                }catch (error) {
                    return
                }

            },
            checkBoxChange(e,i,name){
                if(name=="over"){
                    this.overValue[i].updaeCheckType=e
                    this.tableData[i].excludeOvertime=e
                }else if(name=="manage"){
                    this.manageValue[i].updaeCheckType=e
                    this.tableData[i].manageFlg=e
                }

            },
            checkOverWorkAlladmin() {
                    let that=this
                    this.tableData.forEach((e,index) => {
                        that.overValue[index].updaeCheckType=true
                        e.excludeOvertime=true
                    })
            },
            checkAlladmin(){
                    let that=this
                    this.tableData.forEach((e,index) => {
                        that.manageValue[index].updaeCheckType=true
                        e.manageFlg=true
                    })
            },
            handleDatePicker() {
                if (this.deptName !== '選んでください') {
                    this.opts.baseDate = Utils.formatDate(this.curDate, 'yyyy/MM/dd')
                    this.getTableData()
                    return
                }
                this.$Notice.warning({ title: '所属を選択して下さい' })
            },
            async handleDeptDateChange(e) {
                this.referListObject.txtTmgReferListTreeViewRecordDate = e
                this.isSearchHistory = true
                await this.getOrgTree()
                this.$Notice.warning({ title: '所属図更新完了', desc: "下記の所属リストから対象を選んでください" })
            },
            async getOrgTree() {
                this.empDeptLoading = true
                try {
                    const { orgList, recordDate } = await this.http.get('sys/tree', this.referListObject)
                    // 转为可用数据
                    this.treeData = Utils.convertTreeData(orgList)
                    this.referListObject.txtTmgReferListTreeViewRecordDate = recordDate
                } catch (error) {
                    return
                } finally {
                    this.loading = false
                    this.empDeptLoading = false
                }
            },
            handleClickLeaf(e) {
                if (!e[0]) return
                this.deptDrawShow = false
                this.deptName = e[0].secnic
                this.opts.txtTmgReferListTreeViewAdminTargetSection = e[0].secid
                this.opts.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                this.opts.baseDate = Utils.formatDate(this.curDate, 'yyyy/MM/dd')
                this.getTableData()
            },
            keywordSearch() {
            },
            async getTableData() {
                this.loading = true

                try {
                    const { data } = await this.http.get('sys/userprofile/screenDisp', this.opts)
                    this.pageValue.amount = data.totalCount
                    this.tableData = data.list
                    this.manageValue=Array(data.list.length).fill().
                    map((e,index)=>({"employeeId":data.list[index].meCemployeeidCk,"initCheckType":data.list[index].manageFlg,"updaeCheckType":data.list[index].manageFlg}))

                    this.overValue=Array(data.list.length).fill().
                    map((e,index)=>({"employeeId":data.list[index].meCemployeeidCk,"initCheckType":data.list[index].excludeOvertime,"updaeCheckType":data.list[index].excludeOvertime}))

                } catch (error) {
                    console.log(error)
                    return
                } finally {
                    this.loading = false
                }
            },
            async handleBeginDate(e) {
                if (!e) return
                this.opts.empId = e.meCemployeeidCk
                this.empName = e.meCkanjiname
                this.sectionName = this.deptName
                this.workerTypeName = e.temCworktypename

                try {
                    const { data } = await this.http.get('sys/userprofile/beginDateEditDisp', this.opts)
                    this.referSettingData = [data.beginDate]
                    this.workDaySettingData = [
                        {
                            isChecked: true,
                            dstart: '',
                            dend: '',
                            dendback: '',
                            beginDate: ''
                        }
                    ].concat(data.list)

                    this.beginDateListBackUp=Utils.deepClone(this.workDaySettingData)
                    this.historyData = data.historyList
                    this.isShow = true
                    this.isBeginDateEdit = true
                    this.isAvgTimeEdit = false
                } catch (error) {
                    console.log(error)
                    return
                } finally {

                }



            },
            async handleAvgTime(e) {
                if (!e) return
                this.opts.empId = e.meCemployeeidCk
                this.empName = e.meCkanjiname
                this.workerTypeName = e.temCworktypename
                try {
                    const { data } = await this.http.get('sys/userprofile/avgWorkTimeEditDisp', this.opts)
                    this.averageTimeData = data.historyList
                    this.nowWork.nowWorKDays = data.nowAvgWorkTime.workingdaysWeek
                    this.nowWork.nowWorkTime = data.nowAvgWorkTime.avgWorkTime
                    this.limitTime=data.limitTime
                    this.isShow = true
                    this.isAvgTimeEdit = true
                    this.isBeginDateEdit = false
                } catch (error) {
                    console.log(error)
                    return
                } finally {

                }

            },
            cancel() {
                this.workDaySettingData= this.beginDateListBackUp
                this.handleRadio(0)
                this.isShow = false
            },
            handleRadio(index) {
                this.radioCheckedIndex = index
                this.workDaySettingData = this.workDaySettingData.map((e, i) => {
                    return {
                        ...e,
                        isChecked: i === index ? true : false
                    }
                })
            },
            clear(){
                this.workDaySettingData= this.beginDateListBackUp
                this.handleRadio(0)
            },
            pageChange(e) {
                this.opts.page = e
                this.pageValue.curPage = e
                this.getTableData()
            },
            currentTabChanged(name) {
                if (name=="organisationTree") {
                    this.opts.hidSelectTab='0'
                } else if (name=="organisationSearch") {
                    this.opts.hidSelectTab='1'
                }
            },
            handleClickEmpLeaf(e) {
                //同一部署を二回目でクリックすると、取消とするためで、エラーあり
                //よって、二回目クリックすると、何もしない
                if(!e[0]) return
                this.deptDrawShow = false
                this.opts.hidSearchData=e[0].empid
                this.opts.txtTmgReferListTreeViewAdminTargetSection = e[0].secid
                this.opts.baseDate = Utils.formatDate(this.curDate, 'yyyy/MM/dd')
                this.deptName = e[0].secnic
                this.getTableData()
            },
            searchOrgTree: Debounce( async function() {
                this.empDeptLoading = true
                try {
                    const { data } = await this.http.get('sys/tree/search', this.referListObject)
                    this.searchEmpTreeData = Utils.convertTreeData(data)
                    this.$Notice.success({ title:'所属図更新完了' })
                } catch (error) {
                    return
                } finally {
                    this.empDeptLoading = false
                }
            }),
            handleScroll: Throttle(function (e) {
                this.contentScrollTop = e.target.scrollTop
            }, 50),

            handleInputChange(i, object, value, el) {
                // 填完后自动checkbox
                if (object) {
                    this.hasPassedTimeCheck = Utils.checkTime(object, value, el)
                }
            },
        }
    })
</script>
</body>

</html>