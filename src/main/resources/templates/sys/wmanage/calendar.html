<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head
    th:replace="layout/header::common_header(title='カレンダー編集',cssPaths='/pages/content.min.css,' + '/pages/calendar.min.css')">
</head>

<body>
    <div th:replace="layout/loadingBar::loadingBar"></div>
    <main class="content calendaredit-warp">
        <div class="content_head">
            <div class="header">
                <div class="title1">
                    <h1>
                        <Icon type="i-emeer colored"></Icon>
                        {{ `カレンダー編集` }}
                    </h1>
                </div>
                <div class="btnbox">
                    <span style="flex:1"></span>
                    <i-button type="primary" icon="md-create" size="large" @click="isEditable = !isEditable"
                        v-if="!isEditable">新規</i-button>
                    <i-button type="primary" icon="md-create" size="large" @click="isEditable = !isEditable"
                        v-if="!isEditable">編集</i-button>
                    <i-button type="success" icon="md-done-all" size="large" @click="updateCalendar" v-if="isEditable"></i-button>
                        保存</i-button>
                    <i-button size="large" @click="isEditable = !isEditable" v-if="isEditable">キャンセル</i-button>
                </div>
            </div>
            <div class="searchwrap">
                <span class="label">年</span>
                <date-picker class="mar" v-model="curDate" type="year" :editable="false" :clearable="false"
                    @on-change="handleDatePicker" format="yyyy年"></date-picker>
                <!-- 共通組織図画面 start-->
                <span style="display:flex;width: calc(15% + 200px);">
                    <span class="label">所属</span>
                    <i-button v-on:click.native="deptDrawShow = true" class="input-like-span mr30 cursor grey"
                        style="width: calc(100% - 120px);border-radius:0">
                        {{ deptName }}
                    </i-button>
                    <Drawer class="tc" title="所属を選択してください" placement="right" width="700" :closable="false"
                        :mask-closable="!isSearchHistory" v-model="deptDrawShow">
                        <div class="titlenorm mb5">
                            <Icon type="logo-buffer"></Icon>
                            所属
                        </div>
                        <Row class="tl mb5">
                            <i-col span="4" class="label tc" style="height: 32px;">基準日</i-col>
                            <i-col span="7" class="no-border-radius">
                                <date-picker type="date" :value="referListObject.txtTmgReferListTreeViewRecordDate"
                                    placeholder="基準日" format="yyyy/MM/dd" ref="datePicker"
                                    @on-change="handleDeptDateChange"></date-picker>
                            </i-col>
                        </Row>
                        <div style="position: relative;">
                            <Tree class="tree mt2" :data="treeData" v-on:on-select-change="handleClickLeaf" ref="tree"
                                empty-text="所属データなし"></Tree>
                            <Spin size="large" fix v-if="empDeptLoading"></Spin>
                        </div>
                    </Drawer>
                </span>
                <!-- 共通組織図画面 end-->
            </div>
        </div>
        <div class="content_body tc" style="position: relative;min-height: 500px;">
            <div style="display:inline-block;width:80%;margin-left: -14%;">
                <div v-for="(e, i) of yearData" :key="i" style="display:inline-block;width:30%">
                    <span class="label big" style="display:block;width:87.5%;">{{ `${i + 1}月` }}</span>
                    <Row class="calendar-row">
                        <i-col class="cal-week sun" span="3">日</i-col>
                        <i-col class="cal-week" span="3">月</i-col>
                        <i-col class="cal-week" span="3">火</i-col>
                        <i-col class="cal-week" span="3">水</i-col>
                        <i-col class="cal-week" span="3">木</i-col>
                        <i-col class="cal-week" span="3">金</i-col>
                        <i-col class="cal-week sat" span="3">土</i-col>
                    </Row>
                    <Row class="calendar-row mb20">
                        <i-col class="cal-week" style="background:rgb(245, 247, 249)" span="3"
                            v-for="(n, t) of +e.startDay" :key="t+500">
                            &nbsp;&nbsp;
                        </i-col>
                        <i-col :class="handleWeekStyle(e.dataFlg[t+1])" span="3" v-for="(n, t) of +e.lastDay"
                            :key="t + 1000" @click.native.stop="changeCalendar(e, t, i+1)">
                            {{ n }}
                        </i-col>
                        <i-col class="cal-week" style="background:rgb(245, 247, 249)" span="3"
                            v-for="(q, p) of addGreyCalendar(e)" :key="p+2000">
                            &nbsp;
                        </i-col>
                    </Row>
                </div>
            </div>
            <div style="display:inline-block;position: relative;width:16%;top: -139px;margin-left: -50px;">
                <Row v-for="(e, i) of yearData" :key="i">
                    <i-col span="18" class="label big">{{i}}月 基準日数</i-col>
                    <i-col span="6">
                        <span class="input-like-span">{{e.standarDday}}日</span>
                    </i-col>
                </Row>
            </div>
            <Spin size="large" fix v-if="loading"></Spin>
        </div>
    </main>
    <div th:replace="layout/script::common_script"></div>
    <script type="text/babel" th:inline="javascript">
        const CALENDAR_EDIT = new Vue({
            el: '.calendaredit-warp',
            data() {
                return {
                    empDeptLoading: false,
                    curDate: new Date(),
                    isEditable: false,
                    loading: false,
                    yearData: [],
                    emplistLoading: false,
                    deptDrawShow: false,
                    isSearchHistory: false,
                    treeData: [],
                    empTreeData: [],
                    deptName: '選んでください',   //選択した職員の所属
                    referListObject: {
                        [[${ TREEVIEW_KEY_ADMIN_TARGET_SECTION }]]: '',
                        [[${ TREEVIEW_KEY_ADMIN_TARGET_EMP }]]: '',
                        [[${ TREEVIEW_KEY_RECORD_DATE }]]: '',
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        psApp: Utils.getUrlParam(location.href, 'psApp'),
                        type: 21
                    },
                    query: {
                        year: '',
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        //目标sec
                        txtTmgReferListTreeViewAdminTargetSection: '',
                        //基准日
                        txtTmgReferListTreeViewRecordDate: '',
                        psApp: Utils.getUrlParam(location.href, 'psApp'),
                        type: 21,
                    },
                    changeCalendarHelper: {
                        'TMG_HOLFLG|0': 'TMG_HOLFLG|1',
                        'TMG_HOLFLG|1': 'TMG_HOLFLG|2',
                        'TMG_HOLFLG|2': 'TMG_HOLFLG|3',
                        'TMG_HOLFLG|3': 'TMG_HOLFLG|0'
                    },
                    updatedValue: {},
                    changeMonthList: []
                }
            },
            async mounted() {
                this.getOrgTree()
                this.getCalendarData()
            },
            methods: {
                handleDatePicker() {
                    if (this.deptName !== '選んでください') {
                        this.getCalendarData()
                        return
                    }
                    this.$Notice.warning({ title: '所属を選択して下さい' })
                },
                handleWeekStyle(e) {
                    if (e === 'TMG_HOLFLG|0') {
                        return 'cal-week'
                    }
                    if (e === 'TMG_HOLFLG|2') {
                        return 'cal-week rest'
                    }
                    if (e === 'TMG_HOLFLG|3') {
                        return 'cal-week sat'
                    }
                    if (e === 'TMG_HOLFLG|1') {
                        return 'cal-week sun'
                    }
                    return 'cal-week'
                },
                addGreyCalendar(e) {
                    const count = +e.startDay + +e.lastDay
                    const full = [28, 35, 42]
                    let reslut = 0
                    full.some(e => {
                        if (e === count) {
                            reslut = 0
                            return true
                        }
                        if (e > count) {
                            reslut = e - count
                            return true
                        }
                    })
                    return reslut
                },
                changeCalendar(e, i, whichMonthHasChanged) {
                    if (!this.isEditable) return
                    e.dataFlg[i + 1] = this.changeCalendarHelper[e.dataFlg[i + 1]]
                    if (!this.changeMonthList.includes(whichMonthHasChanged)) {
                        this.changeMonthList.push(whichMonthHasChanged)
                    }
                },
                async getOrgTree() {
                    this.empDeptLoading = true
                    try {
                        const { orgList, recordDate } = await this.http.get('sys/tree', this.referListObject)
                        // 先将数据转为标准格式，再转为可用数据
                        this.treeData = Utils.convertTreeData(orgList)
                        const date = [[${ TREEVIEW_KEY_RECORD_DATE }]]
                        this.referListObject[date] = recordDate
                    } catch (error) {
                        return
                    } finally {
                        this.empDeptLoading = false
                    }
                },
                async getCalendarData() {
                    this.query.year = Utils.formatDate(this.curDate, 'yyyy')
                    try {
                        this.loading = true
                        const { data } = await this.http.get('sys/calendar/getCalendar', this.query)
                        console.log(data)
                        this.yearData = data.calendarDispVoList
                    } catch (error) {
                        return
                    } finally {
                        this.loading = false
                    }
                },
                async handleDeptDateChange(e) {
                    const date = [[${ TREEVIEW_KEY_RECORD_DATE }]]
                    this.referListObject[date] = e
                    this.isSearchHistory = true
                    await this.getOrgTree()
                    this.$Notice.warning({ title: '所属図更新完了', desc: "下記の所属リストから対象を選んでください" })

                },
                async updateCalendar() {
                    // Todo: 更新calendar需要字段对上
                    this.updatedValue = this.changeMonthList.map(e => {
                        return {
                            month: e,
                            monthList: Object.values(this.yearData[e - 1].dataFlg)
                        }
                    })
                    console.log(this.updatedValue)
                },
                async handleClickLeaf(e) {
                    if (!e[0]) return
                    this.deptDrawShow = false
                    this.deptName = e[0].secnic
                    this.query.txtTmgReferListTreeViewAdminTargetSection = e[0].secid
                    this.query.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                    this.getCalendarData()
                },

            }
        })
    </script>
</body>

</html>