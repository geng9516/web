<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head
    th:replace="layout/header::common_header(title='カレンダー編集',cssPaths='/pages/content.min.css,' + '/pages/calendar.min.css')">
</head>

<body>
    <div th:replace="layout/loadingBar::loadingBar"></div>
<!-- 菜单导航栏 -->
<div th:replace="layout/sider"></div>
    <main class="content calendaredit-warp">
        <div class="content_head">
            <div class="header">
                <div class="title1">
                    <h1>
                        <Icon type="i-emeer colored"></Icon>
                        {{ `カレンダー編集` }}
                    </h1>
                </div>
                <div class="btnbox">
                    <span style="flex:1"></span>
                    <i-button type="primary" icon="md-create" size="large" @click="editshow"
                        v-if="isEditable && !isDisable">新規</i-button>
                    <i-button type="primary" icon="md-create" size="large" @click="editshow"
                        v-if="!isEditable && !isDisable">編集</i-button>
                    <i-button type="success" icon="md-done-all" size="large" @click="updateCalendar" v-if="isDisable" :loading="updateLoading">登録</i-button>
                    <i-button type="error" icon="md-trash" size="large" @click="deleteCalendar" v-if="isDisable && !isEditable" :loading="updateLoading">削除</i-button>
                    <i-button size="large" @click="cancel" v-if="isDisable">取消</i-button>
                </div>
            </div>
            <div class="searchwrap">
                <span class="label">年</span>
                <date-picker class="mar" v-model="curDate" type="year" :editable="false" :clearable="false"
                    @on-change="handleDatePicker" format="yyyy年"></date-picker>
                <!-- 共通組織図画面 start-->
                <span style="display:flex;width: calc(15% + 200px);">
                    <span class="label">所属</span>
                    <i-button v-on:click.native="deptDrawShow = true" class="input-like-span mr30 cursor grey"
                        style="width: calc(100% - 120px);border-radius:0">
                        {{ deptName }}
                    </i-button>
                    <Drawer class="tc" title="所属を選択してください" placement="right" width="700" :closable="false"
                        :mask-closable="!isSearchHistory" v-model="deptDrawShow">
                        <div class="titlenorm mb5">
                            <Icon type="logo-buffer"></Icon>
                            所属
                        </div>
                        <Row class="tl mb5">
                            <i-col span="4" class="label tc" style="height: 32px;">基準日</i-col>
                            <i-col span="7" class="no-border-radius">
                                <date-picker type="date" :value="referListObject.txtTmgReferListTreeViewRecordDate"
                                    placeholder="基準日" format="yyyy/MM/dd" ref="datePicker"
                                    @on-change="handleDeptDateChange"></date-picker>
                            </i-col>
                        </Row>
                        <div style="position: relative;">
                            <Tree class="tree mt2" :data="treeData" v-on:on-select-change="handleClickLeaf" ref="tree"
                                empty-text="所属データなし"></Tree>
                            <Spin size="large" fix v-if="empDeptLoading"></Spin>
                        </div>
                    </Drawer>
                </span>
                <!-- 共通組織図画面 end-->
            </div>
        </div>
        <div class="content_body tc" style="position: relative;min-height: 500px;">
            <Alert type="error" class="error-info tl" style="width: 70%" v-show="isDisable">{{ infoMsg }}</Alert>
            <div style="display:inline-block;width:80%;margin-left: -14%;">
                <div v-for="(e, i) of yearData" :key="i" style="display:inline-block;width:30%">
                    <span class="label big" style="display:block;width:87.5%;">{{ `${i + 1}月` }}</span>
                    <Row class="calendar-row">
                        <i-col class="cal-week sun" span="3">日</i-col>
                        <i-col class="cal-week" span="3">月</i-col>
                        <i-col class="cal-week" span="3">火</i-col>
                        <i-col class="cal-week" span="3">水</i-col>
                        <i-col class="cal-week" span="3">木</i-col>
                        <i-col class="cal-week" span="3">金</i-col>
                        <i-col class="cal-week sat" span="3">土</i-col>
                    </Row>
                    <Row class="calendar-row mb20">
                        <i-col class="cal-week" style="background:rgb(245, 247, 249)" span="3"
                            v-for="(n, t) of +e.startDay" :key="t+500">
                            &nbsp;&nbsp
                        </i-col>

                        <i-col :class="handleWeekStyle(e.dataFlg[t+1], e.tcaDyyyymm)" span="3" v-for="(n, t) of +e.lastDay"
                            :key="t + 1000" @click.native.stop="changeCalendar(e, t, i+1)">
                            {{ n }}
                        </i-col>
                        <i-col class="cal-week" style="background:rgb(245, 247, 249)" span="3"
                            v-for="(q, p) of addGreyCalendar(e)" :key="p+2000">
                            &nbsp
                        </i-col>
                    </Row>
                </div>
            </div>
            <div style="display:inline-block;position: relative;width:16%;top: -139px;margin-left: -50px;">
                <Row v-for="(e, i) of yearData" :key="i">
                    <i-col span="18" class="label big">{{i+1}}月 基準日数</i-col>
                    <i-col span="6">
                        <span class="input-like-span">{{e.standarDday}}日</span>
                    </i-col>
                </Row>
            </div>
            <Spin size="large" fix v-if="loading"></Spin>
        </div>
    </main>
    <div th:replace="layout/head::header"></div>
    <script type="text/babel" th:inline="javascript">
        const CALENDAR_EDIT = new Vue({
            el: '.calendaredit-warp',
            data() {
                return {
                    updateControl:false,
                    infoMsg:'',
                    empDeptLoading: false,
                    curDate: new Date(),
                    isEditable: false,
                    isDisable: false,
                    loading: false,
                    yearData: [],
                    maxMonthChange:'',
                    emplistLoading: false,
                    deptDrawShow: false,
                    isSearchHistory: false,
                    treeData: [],
                    empTreeData: [],
                    deptName: '選んでください',   //選択した職員の所属
                    referListObject: {
                        [[${ TREEVIEW_KEY_ADMIN_TARGET_SECTION }]]: '',
                        [[${ TREEVIEW_KEY_ADMIN_TARGET_EMP }]]: '',
                        [[${ TREEVIEW_KEY_RECORD_DATE }]]: '',
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        psApp: Utils.getUrlParam(location.href, 'psApp'),
                        type: 21
                    },
                    query: {
                        year: '',
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        //目标sec
                        txtTmgReferListTreeViewAdminTargetSection: '',
                        //基准日
                        txtTmgReferListTreeViewRecordDate: '',
                        psApp: Utils.getUrlParam(location.href, 'psApp'),
                        type: 21,
                    },
                    changeCalendarHelper: {
                        'TMG_HOLFLG|0': 'TMG_HOLFLG|1',
                        'TMG_HOLFLG|1': 'TMG_HOLFLG|2',
                        'TMG_HOLFLG|2': 'TMG_HOLFLG|3',
                        'TMG_HOLFLG|3': 'TMG_HOLFLG|0'
                    },
                    CalendarYearDto:{monthlist:[]},
                    changeMonthList: [],
                    updateLoading:false
                }
            },
            async mounted() {
                this.getOrgTree()
            },
            methods: {
                handleDatePicker() {
                    if (this.deptName !== '選んでください') {
                        this.getCalendarData()
                        return
                    }
                    this.$Notice.warning({ title: '所属を選択して下さい' })
                },
                handleWeekStyle(e, date) {
                    let result = 'cal-week'
                    if (e === 'TMG_HOLFLG|2') {
                        result = result.concat(' rest')
                    }
                    if (e === 'TMG_HOLFLG|3') {
                        result = result.concat(' sat')
                    }
                    if (e === 'TMG_HOLFLG|1') {
                        result = result.concat(' sun')
                    }
                    if(this.isDisable && Utils.formatDate(date, 'yyyymm') > this.maxMonthChange) {
                        result = result.concat(' clicked')
                    }
                    return result
                },
                addGreyCalendar(e) {
                    const count = +e.startDay + +e.lastDay
                    const full = [28, 35, 42]
                    let reslut = 0
                    full.some(e => {
                        if (e === count) {
                            reslut = 0
                            return true
                        }
                        if (e > count) {
                            reslut = e - count
                            return true
                        }
                    })
                    return reslut
                },
                changeCalendar(e, i, whichMonthHasChanged) {
                    if (!this.isDisable || this.maxMonthChange >= Utils.formatDate(e.tcaDyyyymm, 'yyyymm')) return

                    e.dataFlg[i + 1] = this.changeCalendarHelper[e.dataFlg[i + 1]]
                    if (!this.changeMonthList.includes(whichMonthHasChanged)) {
                        this.changeMonthList.push(whichMonthHasChanged)
                    }
                },
                async getOrgTree() {
                    this.empDeptLoading = true
                    try {
                        const { orgList, recordDate } = await this.http.get('sys/tree', this.referListObject)
                        // 先将数据转为标准格式，再转为可用数据
                        this.treeData = Utils.convertTreeData(orgList)
                        this.referListObject.txtTmgReferListTreeViewRecordDate = recordDate
                    } catch (error) {
                        return
                    } finally {
                        this.empDeptLoading = false
                    }
                },
                async getCalendarData() {
                    this.query.year = Utils.formatDate(this.curDate, 'yyyy')
                    try {
                        this.loading = true
                        const { data } = await this.http.get('sys/calendar/getCalendar', this.query)
                        console.log(data)
                        this.yearData = data.calendarDispVoList
                        this.maxMonthChange=data.selectMaxDaily
                        this.isEditable= !data.gupdateFlag
                        this.isDisable= false
                    } catch (error) {
                        return
                    } finally {
                        this.loading = false
                        console.log( this.isEditable)
                        console.log( this.isDisable)
                    }
                },
                async editshow() {
                    this.query.year = Utils.formatDate(this.curDate, 'yyyy')
                    try {
                        this.loading = true
                        const { data } = await this.http.get('sys/calendar/getCalendar', this.query)
                        this.yearData = data.calendarDispVoList
                        this.maxMonthChange=data.selectMaxDaily
                        this.isDisable= true
                        const curYear = this.yearData[0].tcaDyyyymm.slice(0,4)
                        const maxYear = this.maxMonthChange.slice(0,4)
                        if(curYear <  maxYear) {
                            this.infoMsg =`※1月, 2月, 3月, 4月, 5月, 6月, 7月, 8月, 9月, 10月, 11月, 12月は変更できません。`
                        }
                        if(curYear ===  maxYear) {
                            const month =  this.maxMonthChange.slice(-2)
                            this.infoMsg =`※${Utils.getNumArray(1, +month).map(e=> `${e}月`).join(', ')}は変更できません。`
                        }
                    } catch (error) {
                        return
                    } finally {
                        this.loading = false
                        console.log( this.isEditable)
                        console.log( this.isDisable)
                    }
                },
                async handleDeptDateChange(e) {
                    this.referListObject.txtTmgReferListTreeViewRecordDate = e
                    this.isSearchHistory = true
                    await this.getOrgTree()
                    this.$Notice.warning({ title: '所属図更新完了', desc: "下記の所属リストから対象を選んでください" })

                },
                async updateCalendar() {
                    this.updateLoading=true
                    if(this.isEditable){
                        this.CalendarYearDto.monthlist = this.yearData.map(e => {
                            return {
                                month:e.tcaDyyyymm.split(" ")[0].replace(/-/g,"/"),
                                holFlgList:[...Object.values(e.dataFlg)]
                            }
                        })
                    }else{
                        this.CalendarYearDto.monthlist = this.changeMonthList.map(e => {
                            return {
                                month:this.yearData[e - 1].tcaDyyyymm.split(" ")[0].replace(/-/g,"/"),
                                holFlgList: [...Object.values(this.yearData[e - 1].dataFlg)]
                            }
                        })
                    }
                    try{
                        if(this.isEditable){
                            console.log(this.query)
                            await this.http.post(`sys/calendar/insertCalendar?txtTmgReferListTreeViewAdminTargetSection=${this.query.txtTmgReferListTreeViewAdminTargetSection}&txtTmgReferListTreeViewRecordDate=${this.referListObject.txtTmgReferListTreeViewRecordDate}&psSite=${Utils.getUrlParam(location.href, 'psSite')}&type=21&psApp=calendar`,this.CalendarYearDto)
                        }else{
                            await this.http.post(`sys/calendar/updateCalendar?txtTmgReferListTreeViewAdminTargetSection=${this.query.txtTmgReferListTreeViewAdminTargetSection}&txtTmgReferListTreeViewRecordDate=${this.referListObject.txtTmgReferListTreeViewRecordDate}&psSite=${Utils.getUrlParam(location.href, 'psSite')}&type=21&psApp=calendar`,this.CalendarYearDto)
                        }
                        this.getCalendarData()
                    }catch(error){
                        return
                    }finally {
                        this.updateLoading=false
                    }
                },

                async deleteCalendar() {
                    try{
                        this.updateLoading=true
                        await this.http.postForm('sys/calendar/deleteCalendar', this.query)
                        this.getCalendarData()
                    }catch(error){
                        return
                    }finally {
                        this.updateLoading=false
                    }
                },
                async cancel() {
                    this.getCalendarData()
                },
                async handleClickLeaf(e) {
                    if (!e[0]) return
                    this.deptDrawShow = false
                    this.deptName = e[0].secnic
                    this.query.txtTmgReferListTreeViewAdminTargetSection = e[0].secid
                    this.query.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                    this.getCalendarData()
                },

            }
        })
    </script>
</body>

</html>