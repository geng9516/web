<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='月次集計データ作成',cssPaths='/pages/content.min.css')">
</head>

<body>
    <div th:replace="layout/loadingBar::loadingBar"></div>
    <main class="content monthsuminfo-warp" @scroll.passive="handleScroll" ref="layout">
        <div class="content_head">
            <div class="header">
                <div class="title1">
                    <h1>
                        <Icon type="i-emeer colored"></Icon>
                        {{ `月次集計データ作成` }}
                    </h1>
                </div>
                <div class="btnbox">
                    <span style="flex:1"></span>
                    <div style="height:40px;margin:2px"></div>
                </div>
            </div>
            <div class="searchwrap">
                <span class="label">年</span>
                <date-picker class="mar" v-model="curDate" type="year" :editable="false" :clearable="false"
                    @on-change="handleDatePicker" format="yyyy年"></date-picker>
                <!-- 共通組織図画面 start-->
                <span style="display:flex;width: calc(15% + 200px);">
                    <span class="label">所属</span>
                    <i-button v-on:click.native="deptDrawShow = true" class="input-like-span mr30 cursor grey"
                        style="width: calc(100% - 120px);border-radius:0">
                        {{ deptName }}
                    </i-button>
                    ​
                    <Drawer class="tc" title="所属を選択してください" placement="right" width="700" :closable="false"
                        :mask-closable="!isSearchHistory" v-model="deptDrawShow">
                        <div class="titlenorm mb5">
                            <Icon type="logo-buffer"></Icon>
                            所属
                        </div>
                        <Row class="tl mb5">
                            <i-col span="4" class="label tc" style="height: 32px;">基準日</i-col>
                            <i-col span="7" class="no-border-radius">
                                <date-picker type="date" :value="referListObject.txtTmgReferListTreeViewRecordDate"
                                    placeholder="基準日" format="yyyy/MM/dd" ref="datePicker"
                                    @on-change="handleDeptDateChange"></date-picker>
                            </i-col>
                        </Row>
                        <div style="position: relative;">
                            <Tree class="tree mt2" :data="treeData" v-on:on-select-change="handleClickLeaf" ref="tree"
                                empty-text="所属データなし"></Tree>
                            <Spin size="large" fix v-if="empDeptLoading"></Spin>
                        </div>
                    </Drawer>
                </span>
                <!-- 共通組織図画面 end-->
            </div>
        </div>
        <div class="content_body">
            <div class="table-top">
                <Row :gutter="16">
                    <!-- 共通年選択 start-->
                    <i-col span="11">
                        <i-button type="text" @click="preMonth" :disabled="preDisabled" class="icon-left">
                            <Icon type="ios-arrow-back" size="large"></Icon>
                        </i-button>
                        <i-button type="text" @click="currentMonth" :disabled="showPre" class="icon-center">今年
                        </i-button>
                        <i-button type="text" @click="nextMonth" :disabled="nextDisabled" class="icon-right">
                            <Icon type="ios-arrow-forward" size="large"></Icon>
                        </i-button>
                    </i-col>
                    <!-- 共通年選択 end-->
                </Row>
            </div>
            <i-table border :columns="columns" :disabled-hover="true" :data="tableData" :loading="loading">
                <template slot-scope="{ row }" slot="status" v-if="row.status">
                    <i-button type="primary" ghost size="small" long>未承認者状況</i-button>
                </template>

                <template slot-scope="{ row }" slot="end">
                    <i-button v-if="row.end === 1" type="primary" style="width:80%" ghost size="small" long
                        @click="handleChange(row)">
                        締め処理
                    </i-button>
                    <i-button v-if="row.end === 2" type="primary" ghost style="width:80%" size="small" long
                        @click="handleChange(row)">
                        締め解除
                    </i-button>
                    <p v-if="row.end === 3">完了</p>
                </template>

                <template slot-scope="{ row }" slot="sum">
                    <i-button v-if="row.status" type="primary" ghost size="small" long>集計処理</i-button>
                    <div v-if="row.sum === 2">
                        <p>{{ `${row.time} ${row.hour}` }}</p>
                        <i-button type="error" ghost size="small" long>集計時の問題</i-button>
                    </div>
                    <p v-if="row.sum === 3">集計中</p>
                </template>

                <template slot-scope="{ row }" slot="download" v-if="row.download">
                    <i-button class="mb5" type="primary" style="width:80%" ghost size="small">月例ダウンロード</i-button>
                    <i-button type="primary" style="width:80%" ghost size="small">遡及ダウンロード</i-button>
                </template>

                <template slot-scope="{ row }" slot="notEnd" v-if="row.status">
                    <i-button type="primary" ghost size="small" style="width:80%">締め未完了部局</i-button>
                </template>

                <template slot-scope="{ row }" slot="confirm">
                    <i-button v-if="row.confirm && !row.hasit" type="primary" ghost size="small" style="width:80%"
                        @click="$set(row, 'hasit', true)">
                        確定
                    </i-button>
                    <i-button v-if="row.hasit" type="primary" ghost size="small" style="width:80%"
                        @click="row.hasit = false">
                        確定解除
                    </i-button>
                </template>
            </i-table>
        </div>
    </main>
    <div th:replace="layout/script::common_script"></div>
    <script type="text/babel" th:inline="javascript">
        const MONTH_SUM_INFO = new Vue({
            el: '.monthsuminfo-warp',
            data() {
                return {
                    preDisabled: true,   //年度選択制御
                    nextDisabled: true,  //年度選択制御
                    showPre: true,
                    curDate: new Date(),
                    columns: [
                        {
                            title: '年月',
                            key: 'month',
                            align: 'center'
                        },
                        {
                            title: '承認状況',
                            slot: 'status',
                            align: 'center'
                        },
                        {
                            title: '締め',
                            slot: 'end',
                            align: 'center'
                        },
                        {
                            title: '集計',
                            slot: 'sum',
                            align: 'center'
                        },
                        {
                            title: 'ダウンロード',
                            slot: 'download',
                            align: 'center'
                        },
                        {
                            title: '締め未完了部局',
                            slot: 'notEnd',
                            align: 'center'
                        },
                        {
                            title: '確定',
                            slot: 'confirm',
                            align: 'center'
                        }
                    ],
                    loading: false,
                    tableData: [],
                    pageValue: {
                        amount: 0,
                        curPage: 1,
                        list: [20, 30, 50, 100],
                        curSize: 20
                    },
                    opts: {
                        month: 0,
                        status: 0,
                        page: null,
                        keyword: null,
                        limit: 20
                    },
                    empDeptLoading: false,  // 組織ツリーloading用
                    deptDrawShow: false,    //組織ツリー用
                    treeData: [],            //組織ツリー用
                    isSearchHistory: false,
                    empTreeData: [],        //組織ツリー用
                    deptName: '選んでください',   //選択した職員の所属
                    referListObject: {       //組織ツリー共通
                        [[${ TREEVIEW_KEY_PERM_TARGET_SECTION }]]: '',
                        [[${ TREEVIEW_KEY_PERM_TARGET_EMP }]]: '',
                        [[${ TREEVIEW_KEY_PERM_TARGET_GROUP }]]: '',
                        [[${ TREEVIEW_KEY_RECORD_DATE }]]: '',
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        psApp: Utils.getUrlParam(location.href, 'psApp'),
                        type: 41
                    },
                }
            },
            async mounted() {
                this.getData()
                this.getOrgTree()
            },
            computed: {
            },
            methods: {
                getData: Debounce(async function () {
                    try {
                        this.loading = true
                        // const { data } = await this.api.mock('applyConfirm')
                        this.tableData = data
                        this.amount = data.totalCount || 2
                    } catch (error) {
                        return
                    } finally {
                        this.loading = false
                    }
                }),
                async getOrgTree() {
                    this.empDeptLoading = true
                    try {
                        const { divisionTree, recordDate } = await this.http.get('sys/tree', this.referListObject)
                        // 转为可用数据
                        this.treeData = Utils.convertTreeData(divisionTree)
                        this.referListObject.txtTmgReferListTreeViewRecordDate = recordDate
                    } catch (error) {
                        return
                    } finally {
                        this.loading = false
                        this.empDeptLoading = false
                    }
                },
                async handleDeptDateChange(e) {
                    this.referListObject.txtTmgReferListTreeViewRecordDate = e
                    this.isSearchHistory = true
                    await this.getOrgTree()
                    this.$Notice.warning({ title: '所属図更新完了', desc: "下記の所属リストから対象を選んでください" })
                },
                async handleClickLeaf(e) {
                    this.deptDrawShow = false
                    const section = [[${ TREEVIEW_KEY_ADMIN_TARGET_SECTION }]]
                    this.referListObject[section] = e[0].secid
                    this.loginEmployee = e[0].empid
                    this.deptName = e[0].secnic
                    this.query.employeeId = e[0].empid
                    this.kanjiName = e[0].empname
                    this.selectDisabled = true
                    this.remarksDisabled = true
                    this.getTableData()
                },
                handleDatePicker() { },
                pageChange(e) {
                    this.opts.page = e
                    this.pageValue.curPage = e
                    this.getData()
                },
                handleChange(e) {
                    this.$Modal.confirm({
                        title: '注意',
                        content: '',
                        onOk: () => {
                            if (e.end === 1) {
                                e.end = 2
                            } else {
                                e.end = 1
                            }
                        }
                    })
                },
                preMonth() {
                },
                nextMonth() {
                },
                currentMonth() { },
                sizeChange(e) {
                    this.opts.limit = e
                    this.pageValue.curSize = e
                    this.utils.setStorage('SO_userSettings', { pageSize: e })
                    this.getData()
                }
            }
        })
    </script>
</body>

</html>