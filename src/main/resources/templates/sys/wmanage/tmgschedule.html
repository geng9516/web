<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head
        th:replace="layout/header::common_header(title='予定作成',cssPaths='/pages/content.min.css')">
</head>

<body>
<div th:replace="layout/loadingBar::loadingBar"></div>
<!-- 菜单导航栏 -->
<div th:replace="layout/sider"></div>
<main class="content tmgschedule-warp" ref="layout">
    <div class="content_head">
        <div class="header">
            <div class="title1">
                <h1>
                    <Icon type="i-emeer colored"></Icon>
                        予定作成
                </h1>
            </div>
            <div class="btnbox">
                <span style="flex:1"></span>
                <i-button type="primary"  icon="md-create"  :disabled="!selectDisabled || !scheduleDataDTOList.length >0 || !editable" @click="showWeek = !showWeek">週勤務パターン編集</i-button>
                <i-button type="primary"  icon="md-create"  :disabled="!selectDisabled || !scheduleDataDTOList.length >0 || !editable"  @click="isEditable = !isEditable"  v-if=" !isEditable">編集</i-button>
                <i-button type="success" icon="md-create"  :loading="postScheduleLoading" v-if=" isEditable" @click="postExecuteEditMonthlyUSchedule">登録</i-button>
                <i-button  v-if=" isEditable" @click="isEditable = !isEditable;handleSelectAll2(false);restPattern()">キャンセル</i-button>
            </div>
        </div>
        <div class="searchwrap">
            <span class="label">年月</span>
            <i-select :value="defaultDate" :disabled="!selectDisabled" class="mr30" @on-change="handleStartMonth($event)" v-show="resetMonthSelectForBtnEditable"
                      placeholder="選択ください">
                <i-option v-for="(item, index) of dispMonthlyList" :key="index" :label="item.tda_dyyyymm" :value="item.tda_dyyyymm">
                </i-option>
            </i-select>
            <i-select :value="defaultDate" :disabled="!selectDisabled" class="mr30" @on-change="handleStartMonth($event)" v-show="!resetMonthSelectForBtnEditable"
                      placeholder="選択ください">
                <i-option v-for="(item, index) of dispMonthlyList" :key="index" :label="item.tda_dyyyymm" :value="item.tda_dyyyymm">
                </i-option>
            </i-select>
            <!-- 共通組織図画面 start-->
            <span style="display:flex;width: calc(15% + 200px);">
                <span class="label">所属</span>
                <i-button v-on:click.native="deptDrawShow = true" class="input-like-span dept-select">
                        <Tooltip trigger="hover" :theme="toolTipTheme()" transfer>{{deptName}}
                            <div slot="content">{{deptName}}</div>
                        </Tooltip>
                    </i-button>
                <Drawer class="tc" placement="right" width="700" :closable="false"
                     :mask-closable="!isSearchHistory" v-model="deptDrawShow">
                <Tabs :animated="false" v-model="currentTab">
                <tab-pane label="ツリー" name="organisationTree">
                      <div class="titlenorm mb5">
                            <Icon type="logo-buffer"></Icon>
                            所属
                        </div>

                       <Row class="tl mb5">
                            <i-col span="4" class="label tc" style="height: 32px;">基準日</i-col>
                            <i-col span="7" class="no-border-radius">
                            <date-picker type="date" :value="referListObject.txtTmgReferListTreeViewRecordDate" :options="startLimit" transfer
                                         placeholder="基準日" format="yyyy/MM/dd" ref="datePicker" :clearable="false" @on-change="handleDeptDateChange"></date-picker>
                            </i-col>
                        </Row>
                        <Tree class="tree mt2" :data="treeData" @on-select-change="handleClickLeaf" ref="tree"
                              empty-text="所属データなし"></Tree>
                        <div class="titlenorm mt15">
                            <Icon type="logo-buffer"></Icon>
                            職員
                        </div>
                        <div style="position: relative;">
                            <Tree class="tree mt2" :data="empTreeData" @on-select-change="handleClickEmpLeaf($event,0)" empty-text="職員データなし"></Tree>
                            <Spin size="large" fix v-if="emplistLoading"></Spin>
                        </div>
                </tab-pane>
                <tab-pane label="検索" name="organisationSearch">
                       <Row class="tl mb2" :gutter="8">
                            <i-col span="15">
                                <i-input v-model="referListObject.hidSearchData" @on-search="searchOrgTree" class="mar mb5 like-select" search enter-button placeholder="検索">
                                    <i-select v-model="referListObject.hidSearchItems" slot="prepend" style="width: 108px" placeholder="項目">
                                        <i-option v-for="(item,i) of searchTypesList" :value="item.value">{{ item.name }}</i-option>
                                    </i-select>
                                    <i-select v-model="referListObject.hidSearchCondition"  slot="append" style="width: 108px" placeholder="条件">
                                        <i-option v-for="(item,i) of searchConditionsList" :value="item.value">{{ item.name }}</i-option>
                                    </i-select>
                                </i-input>
                            </i-col>
                            <i-col span="8" class="no-border-radius">
                                <i-button long type="primary" icon="md-search" ghost :loading="empDeptLoading" @click="searchOrgTree">検索</i-button>
                            </i-col>
                        </Row>
                        <div class="titlenorm mt15">
                            <Icon type="logo-buffer"></Icon>
                            職員
                        </div>
                        <Alert class="primary-info mt10">※検索結果の上位100件を表示しています。</Alert>
                        <div style="position: relative;">
                            <Tree class="tree mt2" :data="searchEmpTreeData" @on-select-change="handleClickEmpLeaf($event,1)" empty-text="職員データなし"></Tree>
                            <Spin size="large" fix v-if="emplistLoading"></Spin>
                        </div>
                </tab-pane>
               </Tabs>
                    </Drawer>
            </span>
            <!-- 共通組織図画面 end-->
            <span class="label">氏名</span>
            <span class="input-like-span width15 mr30">
                <Tooltip trigger="hover"　:theme="toolTipTheme()" transfer　v-if="kanjiName">{{kanjiName}}
                    <div slot="content">{{kanjiName}}</div>
                </Tooltip>
            </span>
            <span class="label">種別</span>
            <span class="input-like-span width15">
                <Tooltip trigger="hover"　:theme="toolTipTheme()" transfer v-if="wokertypename">{{wokertypename}}
                    <div slot="content">{{wokertypename}}</div>
                </Tooltip>
            </span>
        </div>
    </div>
    <div class="content_body">
        <div class="table-top">
        </div>
        <div style="position: relative;">
            <Row :gutter="10" class="mt5 mb15 tc">
                <i-col span="4">
                    <div class="label">公休日数</div>
                    <div class="person-info tc">{{paidHolidayVO.nationalHolidayDays?`${paidHolidayVO.nationalHolidayDays}日`:''}}</div>
                </i-col>
                <i-col span="4">
                    <div class>
                        <div class="label">基準日数</div>
                        <div class="person-info tc">{{paidHolidayVO.dateOfRecordDays?`${paidHolidayVO.dateOfRecordDays}日`:''}}</div>
                    </div>
                </i-col>
                <i-col span="4">
                    <div class="label">基準時間</div>
                    <div class="person-info tc">{{paidHolidayVO.dateOfRecord}}</div>
                </i-col>
                <i-col span="4">
                    <div class="label">基準平均勤務時間</div>
                    <div class="person-info tc">{{paidHolidayVO.avgWorkTime?`${Math.trunc(paidHolidayVO.avgWorkTime/60)}時間 ${paidHolidayVO.avgWorkTime%60}分`:''}}</div>
                </i-col>
                <i-col span="4">
                    <div class="label">年次休暇残</div>
                    <div class="person-info tc">{{paidHolidayVO.npaidRestDaysHour}}</div>
                </i-col>
                <i-col span="4">
                    <div class="label">発令</div>
                    <div class="person-info tc">{{hatuReiName}} {{hatuResTimeRange}}</div>
                </i-col>

            </Row>

            <div class="titlenorm mb10 mt15" v-if=" isEditable">
            <Icon type="logo-buffer"></Icon>
            一括適用
        </div>

            <Row v-if=" isEditable" class="mb10">
            <i-col span="3">
                <div class="label tc">勤務パターン</div>
            </i-col>
            <i-col span="6">
                <i-select class="no-border-radius"  :disabled="!patternDisabled" v-model="workPatternSelected" @on-change="handleChangeWorkPattern()">
                    <i-option v-for="(item, i) of workPatternList" :key="i" :value="item.CPATTERNID">{{ item.CPATTERNNAME }}</i-option>
                </i-select>
            </i-col>
        </Row>

            <i-table border :columns="columnsAction" :data="columnsActionData" v-if=" isEditable" :row-class-name="() => 'select-col'">
            <template slot-scope="{ row }" slot="workDivision">
                <i-select  transfer v-model="pattern.workId"　@on-change="handleChangeDivision($event)">
                    <i-option v-for="(item, i) of kubunnList" :key="i" :value="item.MGD_CMASTERCODE">{{ item.MGD_CGENERICDETAILDESC }}</i-option>
                </i-select>
            </template>

            <template slot-scope="{ row }" slot="workFar">
                <i-select transfer  v-model="pattern.bussinessTripid">
                    <i-option v-for="(item, i) of syuccyouList" :key="i" :value="item.MGD_CMASTERCODE">{{ item.MGD_CGENERICDETAILDESC }}</i-option>
                </i-select>
            </template>

            <template slot-scope="{ row }" slot="startTime">
                <i-input v-model="pattern.nopen"　:disabled="!patternDisabled" @on-blur="handleInputChange(row._index, pattern,'nopen', $event.target)"/>
            </template>

            <template slot-scope="{ row }" slot="endTime">
                <i-input v-model="pattern.nclose"　:disabled="!patternDisabled" @on-blur="handleInputChange(row._index, pattern,'nclose', $event.target)"/>
            </template>

            <template slot-scope="{ row }" slot="restTime" >
                <Row :gutter="10" v-for="(item, i) of pattern.restList" :key="i" class="mb5" >
                    <i-col :span="pattern.restList.length > 1 ? 8 : 12">
                        <i-input v-model="pattern.restList[i].restOpen"　:disabled="!patternDisabled" @on-blur="handleInputChange(row._index, pattern.restList[i],'restOpen', $event.target)"/>
                    </i-col>
                    <i-col :span="pattern.restList.length > 1 ? 8 : 12">
                        <i-input v-model="pattern.restList[i].restClose"　:disabled="!patternDisabled" @on-blur="handleInputChange(row._index, pattern.restList[i],'restClose', $event.target)"/>
                    </i-col>
                    <i-col span="8" v-show="pattern.restList.length > 1">
                        <i-button ghost type="error" @click="handleMinusRest(pattern.restList, i)">-</i-button>
                    </i-col>
                </Row>
                <i-button
                        :disabled="!patternDisabled"
                        class="mt5"
                        size="small"
                        ghost
                        type="success"
                        long
                        @click="handleAddRest(pattern.restList)"
                        v-show="pattern.restList.length < 4"
                >+</i-button>
            </template>

            <template slot-scope="{ row }" slot="option">
                <i-button type="primary" class="mr5" ghost @click="handleSelectAll2(false)">
                    クリア
                </i-button>
                <i-button type="primary" class="mr5" ghost @click="handleSelectAll2(true)">
                    全選択
                </i-button>
            </template>
                <template slot-scope="{ row }" slot="apply">
                    <i-button type="primary" class="mr5" ghost @click="handleSelectApply">
                        適用
                    </i-button>
                </template>
        </i-table>

            <div class="titlenorm mb10 mt15" v-if=" isEditable">
            <Icon type="logo-buffer"></Icon>
            勤務予定
            </div>

            <i-table :class="tableHeadFixed ? 'table-head-fixed long-table' : 'long-table'"  border :columns="columns"
            :row-class-name="() => 'select-col'" :disabled-hover="true" :data="scheduleDataDTOList"
                 ref="selection2"  @on-selection-change="handleSelectAll($event)" no-data-text=""
        >

            <template slot-scope="{ row }" slot="intDay">
                <span :class="dayRed(row)">{{`${row.tda_nmmdd}　${row.tda_nmmday}`}}</span>
            </template>

            <template slot-scope="{ row }" slot="workDivision">

                <span v-if=" isEditable && row._disabled">{{value[row._index].workMM}}</span>

                <i-select v-model="value[row._index].workId" transfer v-else-if=" isEditable" @on-change="handleChangeDivision2(row._index,'value')">
                    <i-option v-for="(item, i) of kubunnListbak" :key="i" :value="item.MGD_CMASTERCODE">{{ item.MGD_CGENERICDETAILDESC }}</i-option>
                </i-select>
                    <span :class="dayRed(row)" v-else>{{ row.tda_cworkingid_mm }}</span>
            </template>

            <template slot-scope="{ row }" slot="workFar">
                <i-select v-model="value[row._index].bussinessTripid" transfer v-if="isEditable" :disabled="row._disabled">
                    <i-option v-for="(item, i) of syuccyouListbak" :key="i" :value="item.MGD_CMASTERCODE">{{ item.MGD_CGENERICDETAILDESC }}</i-option>
                </i-select>
                <span  v-else>{{ row.tda_cbusinesstripid_mm=='なし'?'':row.tda_cbusinesstripid_mm }}</span>
            </template>

            <template slot-scope="{ row}" slot="workStartFinal">
                <i-input v-model="value[row._index].nopen" :disabled="value[row._index].workId!='TMG_WORK|000' || row._disabled" v-if=" isEditable" @on-blur="handleInputChange(row._index, value[row._index],'nopen', $event.target)"></i-input>
                <span v-else>{{ value[row._index].nopen }}</span>
            </template>

            <template slot-scope="{ row }" slot="workEndFinal">
                <i-input v-model="value[row._index].nclose" :disabled="value[row._index].workId!='TMG_WORK|000' || row._disabled" v-if=" isEditable" @on-blur="handleInputChange(row._index, value[row._index],'nclose', $event.target)"></i-input>
                <span v-else>{{ value[row._index].nclose}}</span>
            </template>

            <template slot-scope="{ row }" slot="restTimeList">
                <div v-if=" isEditable">
                    <Row :gutter="10" v-for="(item, i) of value[row._index].restList" :key="i" class="mb5">
                        <i-col :span="value[row._index].restList.length > 1 ? 8 : 12">
                            <i-input v-model="value[row._index].restList[i].restOpen" :disabled="value[row._index].workId!='TMG_WORK|000' || row._disabled " @on-blur="handleInputChange(row._index, value[row._index].restList[i],'restOpen', $event.target)"/>
                        </i-col>
                        <i-col :span="value[row._index].restList.length > 1 ? 8 : 12">
                            <i-input v-model="value[row._index].restList[i].restClose" :disabled="value[row._index].workId!='TMG_WORK|000' || row._disabled " @on-blur="handleInputChange(row._index, value[row._index].restList[i],'restClose', $event.target)"/>
                        </i-col>
                        <i-col span="8" v-show="value[row._index].restList.length > 1">
                            <i-button ghost type="error" @click="handleMinusRest(value[row._index].restList, i)">-</i-button>
                        </i-col>
                    </Row>
                    <i-button
                            :disabled="value[row._index].workId!='TMG_WORK|000' || row._disabled "
                            class="mt5"
                            size="small"
                            ghost
                            type="success"
                            long
                            @click="handleAddRest(value[row._index].restList);"
                            v-show="value[row._index].restList.length < 4"
                    >+
                    </i-button>

                </div>
                <span v-for="(item,i) of value[row._index].restList" v-else>{{i==0?"":" / "}}{{item.restOpen}}-{{item.restClose}} </span>
            </template>

            <template slot-scope="{ row }" slot="remark">
                <i-input v-model="value[row._index].comment" v-if=" isEditable" :disabled="row._disabled "></i-input>
                <span v-else>{{ value[row._index].comment }}</span>
            </template>
        </i-table>
            <Spin size="large" fix v-if="loading"></Spin>
        </div>
        <Drawer title="週勤務パターン編集" width="800" v-model="showWeek">
            <Row>
                <i-col span="6" class="label tc">所属</i-col>
                <i-col span="9">
                <span class="input-like-span">{{deptName}}</span>
                </i-col>
            </Row>

            <Row>
                <i-col span="6" class="label tc">氏名</i-col>
                <i-col span="9">
                <span class="input-like-span">{{kanjiName}}</span>
                </i-col>
            </Row>

            <Row>
                <i-col span="6" class="label tc">種別</i-col>
                <i-col span="9">
                <span class="input-like-span">{{wokertypename}}</span>
                </i-col>
            </Row>

            <div class="titlenorm mb10 mt15">
                <Icon type="logo-buffer"></Icon>
                適用済
            </div>
            <div style="position: relative;">
            <i-table border class="mt5" :columns="columnsUsed" :data="tableDataUsed" no-data-text="適用している週勤務パターンがありません" :disabled-hover="true">
                <template slot-scope="{ row }" slot="startTime">
                    <date-picker type="date" :value="row.twp_dstartdate" class="datepicker-single mb5"　@on-change="tableDataUsed[row._index].twp_dstartdate = $event"
                                 format="yyyy/MM/dd" :transfer="true" :disabled="!(new Date(tableDataUsedbak[row._index].twp_dstartdate)>=nextMonthFirstDay)"></date-picker>

                </template>

                <template slot-scope="{ row }" slot="endTime">
                    <date-picker type="date" :value="row.twp_denddate" class="datepicker-single mb5"　@on-change="tableDataUsed[row._index].twp_denddate = $event"
                                 format="yyyy/MM/dd" :transfer="true"></date-picker>
                </template>

                <template slot-scope="{ row }" slot="update">
                    <i-button type="primary" ghost  @click="updateWeekPatternInfo(row._index)">更新</i-button>
                </template>

                <template slot-scope="{ row }" slot="content">
                    <i-button type="primary" ghost @click="showWeekHistory=!showWeekHistory;selectWeekPatternInfo(row._index)">参照</i-button>
                </template>

                <template slot-scope="{ row }" slot="action">
                    <i-button type="error" ghost  @click="deleteWeekPtn(row._index)" :disabled="!(new Date(row.twp_dstartdate)>=nextMonthFirstDay)">削除</i-button>
                </template>
            </i-table>

            <Alert class="primary-info mt10">既に適用中の勤務パターンは、適用終了日の更新のみ可能です。</Alert>
            <div class="titlenorm mb10 mt15">
                <Icon type="logo-buffer"></Icon>
                新規
            </div>

            <Row class="mt5">
                <i-col span="6" class="label tc">適用期間</i-col>
                <i-col span="4">
                    <date-picker type="date"  :value="value2.applyStart" class="datepicker-single mb5" placeholder="日付"
                                 format="yyyy/MM/dd" @on-change="value2.applyStart = $event"></date-picker>
                </i-col>
                <i-col span="1">
                <span style="display: inline-block;vertical-align: sub;color:grey;margin-top: 6px">－</span>
                </i-col>
                <i-col span="4">
                    <date-picker type="date"  :value="value2.applyEnd" class="datepicker-single mb5" placeholder="日付"
                                 format="yyyy/MM/dd" @on-change="value2.applyEnd = $event" ></date-picker>
                </i-col>

                <i-col span="4" offset="5">
                <i-button type="primary" ghost long @click="executeMakeWeekPattern">登録</i-button>
                </i-col>
            </Row>
            <i-table border class="mt5" :columns="columns2" :data="tableData2" :disabled-hover="true">
                <template slot-scope="{ row }" slot="workDivision">
                    <i-select v-model="value2.applyList[row._index].workDivisionId" transfer @on-change="handleChangeDivision2(row._index,'value2')">
                        <i-option v-for="(item) of workDivisionList" :value="item.mgd_work">{{ item.mgd_workname }}</i-option>
                    </i-select>
                </template>

                <template slot-scope="{ row }" slot="startTime">
                    <i-input v-model="value2.applyList[row._index].startTime" :disabled="value2.applyList[row._index].workDivisionId!='TMG_WORK|000'" @on-blur="handleInputChange(row._index, value2.applyList[row._index],'startTime', $event.target)"></i-input>
                </template>

                <template slot-scope="{ row }" slot="endTime">
                    <i-input v-model="value2.applyList[row._index].endTime" :disabled="value2.applyList[row._index].workDivisionId!='TMG_WORK|000'" @on-blur="handleInputChange(row._index, value2.applyList[row._index],'endTime', $event.target)"></i-input>
                </template>

                <template slot-scope="{ row }" slot="rest">
                    <Row :gutter="16">
                        <i-col span="12">
                        <i-input v-model="value2.applyList[row._index].restStartTime" :disabled="value2.applyList[row._index].workDivisionId!='TMG_WORK|000'" @on-blur="handleInputChange(row._index, value2.applyList[row._index],'restStartTime', $event.target)"></i-input>
                        </i-col>
                        <i-col span="12">
                        <i-input v-model="value2.applyList[row._index].restEndTime" :disabled="value2.applyList[row._index].workDivisionId!='TMG_WORK|000'" @on-blur="handleInputChange(row._index, value2.applyList[row._index],'restEndTime', $event.target)"></i-input>
                        </i-col>
                    </Row>
                </template>
            </i-table>
                <Spin size="large" fix v-if="weekPatternloading2"></Spin>
            </div>
        </Drawer>

        <div style="position: relative;">
            <Modal v-model="showWeekHistory" width="700" title="週勤務パターン参照" footer-hide draggable>
                <Spin size="large" fix v-if="weekPatternloading"></Spin>
            <Row>
                <i-col span="6" class="label">適用期間</i-col>
                <i-col span="8">
                <span class="input-like-span">{{applyStartTime}}</span>
                </i-col>
                <i-col span="1">
                <span style="display: inline-block;vertical-align: sub;color:grey;margin-top: 6px">－</span>
                </i-col>
                <i-col span="8">
                <span class="input-like-span">{{applyEndTime}}</span>
                </i-col>
            </Row>

            <i-table border class="mt10 mb20" :columns="columns2" :data="tableData3" :disabled-hover="true">
                <template slot-scope="{ row }" slot="workDivision">
                    <span>{{ row.workname }}</span>
                </template>

                <template slot-scope="{ row }" slot="startTime">
                    <span>{{ row.twp_copen }}</span>
                </template>

                <template slot-scope="{ row }" slot="endTime">
                    <span>{{ row.twp_cclose }}</span>
                </template>

                <template slot-scope="{ row }" slot="rest">
                    <span>{{row.rest[0].trim().length == 0?'':`${row.rest[0]}-${row.rest[1]}`}}</span>
                </template>
            </i-table>
            </Modal>

        </div>
    </div>
    <back-top></back-top>
</main>
<div th:replace="layout/head::header"></div>
<script type="text/babel" th:inline="javascript">
    const WORK_YEAR_SCHEDULE = new Vue({
        el: '.tmgschedule-warp',
        data() {
            return {
                resetMonthSelectForBtnEditable:false,//年月下拉框切换标记
                editErrMsg:'', //年月下拉不能编辑时 后端返回的错误信息
                defaultDate: '', //年月选择（Date）
                dispMonthlyList: [],       //年月リスト
                editable:false, //年月下拉不能编辑时 后端返回的标志
                isSearchHistory: false,
                nextMonthFirstDay:new Date(new Date().getFullYear(), new Date().getMonth()+1, 1),//下个月第一天
                today:Utils.formatDate(new Date(),'YYYY/MM/DD'),
                postScheduleLoading:false,
                hatuReiName:'', //发令数据
                hatuResTimeRange:'', //发令数据
                weekPatternloading2:false,
                weekPatternloading:false,
                valuebak:[],  //备份的页面显示数据
                patternDisabled:false,
                emplistLoading: false,  //職員番号ローディング用動画
                applyStartTime:'', //周勤务pattern参照適用开始时间
                applyEndTime:'',//周勤务pattern参照適用结束时间
                showWeekHistory: false,
                value2:{"applyStart":'',"applyEnd":'',applyList:Array(7).fill().map((e,index)=>{
                        let id='TMG_WORK|000'
                        if(index==0){
                            id='TMG_WORK|500'
                        }
                        if(index==6){
                            id='TMG_WORK|570'
                        }
                        return  {"workFlag":index,"workDivisionId":id,"startTime":'',"endTime":'',"restStartTime":'',"restEndTime":''}
                    })},//週勤務パターン新規数据
                wokertypename:'',
                workDivisionList:[],//周勤务pattern列表
                columns2: [
                    {
                        title: '曜日',
                        key: 'intDay',
                        width: 50,
                        align: 'center'
                    },
                    {
                        title: '区分',
                        minWidth: 100,
                        slot: 'workDivision',
                        align: 'center'
                    },
                    {
                        title: '始業',
                        slot: 'startTime',
                        align: 'center'
                    },
                    {
                        title: '終業',
                        slot: 'endTime',
                        align: 'center'
                    },
                    {
                        title: '休憩',
                        minWidth: 150,
                        slot: 'rest',
                        align: 'center'
                    }
                ], //週勤務パターン 新規
                tableData2: [
                    {intDay:'日曜',},
                    {intDay: '月曜'},
                    {intDay: '火曜'},
                    {intDay: '水曜'},
                    {intDay: '木曜'},
                    {intDay: '金曜'},
                    {intDay: '土曜'}
                ],//週勤務パターン曜日列
                tableData3:[],//週勤務パターン参照
                showWeekHistory: false,
                tableDataUsed: [],//週勤務パターン適用list
                tableDataUsedbak: [],//备份的週勤務パターン適用list
                columnsUsed: [
                    {
                        title: '適用開始日',
                        slot: 'startTime',
                        align: 'center'
                    },
                    {
                        title: '適用終了日',
                        slot: 'endTime',
                        align: 'center'
                    },
                    {
                        title: '更新',
                        slot: 'update',
                        width: 120,
                        align: 'center'
                    },
                    {
                        title: '登録内容',
                        slot: 'content',
                        width: 120,
                        align: 'center'
                    },
                    {
                        title: '削除',
                        slot: 'action',
                        width: 120,
                        align: 'center'
                    }
                ],//週勤務パターン適用表头
                showWeek: false,
                yyyyMMdd:'',
                pattern:{nclose:"",nopen:"",workId:"TMG_WORK|",bussinessTripid:"TMG_BUSINESS_TRIP|",restList:[]},//勤務パターン
                value: [],//页面显示数据
                valueMap:[],//勾选的数据索引
                selectDisabled:false,
                workPatternSelected: "TMG_PATTERN|", //默认workPattern选择
                columnsAction: [
                    {
                        title: '区分',
                        slot: 'workDivision',
                        align: 'center'
                    },
                    {
                        title: '出張',
                        slot: 'workFar',
                        align: 'center'
                    },
                    {
                        title: '開始時間',
                        slot: 'startTime',
                        align: 'center'
                    },
                    {
                        title: '終了時間',
                        slot: 'endTime',
                        align: 'center'
                    },
                    {
                        title: '休憩',
                        slot: 'restTime',
                        className: 'checkin',
                        align: 'center'
                    },
                    {
                        title: '一括適用/クリア',
                        slot: 'option',
                        align: 'center'
                    },
                    {
                        title: 'チェックした日に対し',
                        slot: 'apply',
                        align: 'center'
                    }
                ],//编辑状态 一括適用 表格
                columnsActionData: [{ JSON: {} }],//编辑状态 一括適用 表格数据
                isEditable: false,
                selectScheduleInfo:{}, //预定做成原始数据
                selectIkkaInfo:{},//勤務パターン列表 区分列表 出張列表 原始数据
                workPatternList:[],//勤務パターン列表
                kubunnList:[],//区分列表
                kubunnListbak:[],//区分列表备份
                syuccyouList:[],//出张列表
                syuccyouListbak:[],//出张列表备份
                paidHolidayVO:{},//公休日数  基準日数 等等
                scheduleDataDTOList:[],//预定做成显示数据
                loading: false,             //ローディングアクション-->
                contentScrollTop: 0,
                kanjiName: '',　         　 //選択した職員の氏名
                loginEmployee: '',          //選択した職員の職員番号
                data: [],
                referListObject: {       //組織ツリー共通
                    [[${ TREEVIEW_KEY_ADMIN_TARGET_SECTION }]]: '',
                    [[${ TREEVIEW_KEY_ADMIN_TARGET_EMP }]]: '',
                    [[${ TREEVIEW_KEY_RECORD_DATE }]]: '',
                    [[${ TREEVIEW_KEY_REFRESH_FLG }]]: '',
                    hidSelectTab:[[${ session.hidSelectTab }]] === 1 ? '1':'0', //組織タブー0：ツリ、1:検索
                    hidSearchItems:'EMPLOYEEID',
                    hidSearchCondition:'BROADMATCH',
                    hidSearchData:'',
                    txtTmgReferListTreeViewRecordDate: '',
                    txtTmgReferListTreeViewAdminTargetEmp: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href,'psApp'),
                    type: 11
                },
                selectedDeptViewType: 3,
                searchEmpTreeData: [],        //組織ツリー用
                currentTab: [[${ session.hidSelectTab }]] === 1 ? "organisationSearch":"organisationTree",         //組織のツリーと検索タブーを切り替え
                empDeptLoading: false,  // 組織ツリーloading用
                deptDrawShow: false,    //組織ツリー用
                treeData:[],            //組織ツリー用
                empTreeData: [],        //組織ツリー用
                searchConditionsList: [],//組織ツリー用
                searchTypesList: [],     //組織ツリー用
                deptName: '選んでください',   //選択した職員の所属
                query: {
                    hidSelectTab:[[${ session.hidSelectTab }]] === 1 ? '1':'0', //組織タブー0：ツリ、1:検索
                    hidSearchItems:'',
                    hidSearchCondition :'',
                    hidSearchData :'',
                    txtTmgReferListTreeViewAdminTargetSection:'',
                    txtTmgReferListTreeViewAdminTargetEmp:'',
                    EmployeeCode:'',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href,'psApp'),
                    txtBaseDate:'',
                    txtEndDate:'',
                    sectionid:'',
                },
                SecFlag:false,
                EmpFlag:false,
                EmpSelect:false,
            }
        },
        async mounted() {
            console.log([[${ session }]])
            await this.getInit()
            //初始化週勤務パターン参照曜日
            this.tableData3 = Array(7).fill().map((e,index)=>({"intDay":this.tableData2[index].intDay,"workname":'',"twp_copen":'',"twp_cclose":'',"rest":['','']}))
            window.addEventListener('scroll',this.handleScroll,{ passive: true })
        },
        beforeDestroy() {
            window.removeEventListener('scroll',this.handleScroll,{ passive: true })
        },
        computed: {
            curSelectedWorkPattern() {
                return this.workPatternList.find(e => e.CPATTERNID === this.workPatternSelected)
            },
            tableHeadFixed() {
                if(this.isEditable) {
                    if (this.contentScrollTop > 459) return true
                    else return false
                } else {
                    if (this.contentScrollTop > 236) return true
                    else return false
                }
            },
            columns() {
                let result= [
                    {
                        title: '日',
                        slot: 'intDay',
                        width: 100,
                        align: 'center'
                    },
                    {
                        title: '区分',
                        minWidth: 36,
                        slot: 'workDivision',
                        align: 'center'
                    },
                    {
                        title: '出張',
                        slot: 'workFar',
                        align: 'center'
                    },
                    {
                        title: '勤務予定',
                        align: 'center',
                        children: [
                            {
                                title: '始業',
                                align: 'center',
                                minWidth: 36,
                                slot: 'workStartFinal'
                            },
                            {
                                title: '終業',
                                minWidth: 36,
                                slot: 'workEndFinal',
                                align: 'center'
                            }
                        ]
                    },
                    {
                        title: '休憩',
                        minWidth: 300,
                        className: 'checkin',
                        slot: 'restTimeList',
                        align: 'center'
                    },
                    {
                        title: '申請・命令',
                        minWidth: 70,
                        key: 'tda_cmessage',
                        align: 'center'
                    },
                    {
                        title: 'コメント',
                        minWidth: 70,
                        slot: 'remark',
                        tooltip: true,
                        align: 'center'
                    }
                ]
                if (this.isEditable) {
                    return result.concat({
                        type: 'selection',
                        width: 60,
                        align: 'center'
                    })
                } else {
                    return result
                }
            }
        },
        methods: {
            //页面初始化
            async getInit() {
                let targetAdminSection = [[${ session.txtTmgReferListTreeViewAdminTargetSection }]]
                let targetAdminEmp = [[${ session.txtTmgReferListTreeViewAdminTargetEmp }]]
                let loginDesignationSection = [[${ session.psSession.loginDesignation[0].section }]]
                let loginEmp = [[${ session.psSession.loginDesignation[0].employee }]]
                if(Utils.formatDate([[${ session.TmgReferListSYSDATE }]], 'yyyy/mm/dd')){
                    this.referListObject.txtTmgReferListTreeViewRecordDate =  Utils.formatDate([[${ session.TmgReferListSYSDATE }]], 'yyyy/mm/dd')
                }
                console.log([[${ session }]])
                await this.getOrgTree()
                this.getSearchCondition()
                //検索の初期化対応
                this.query.hidSelectTab = [[${ session.hidSelectTab }]]
                this.query.hidSearchItems = [[${ session.hidSearchItems }]]
                this.query.hidSearchCondition = [[${ session.hidSearchCondition }]]
                this.query.hidSearchData = [[${ session.hidSearchData }]]

                this.referListObject.hidSelectTab = [[${ session.hidSelectTab }]]
                this.referListObject.hidSearchItems = [[${ session.hidSearchItems }]] || 'EMPLOYEEID'
                this.referListObject.hidSearchCondition = [[${ session.hidSearchCondition }]] || 'BROADMATCH'
                this.referListObject.hidSearchData = [[${ session.hidSearchData }]]

                if(this.query.hidSelectTab == '1'){
                    this.searchOrgTree()
                }
                //　初回管理サイトの画面にアクセスするなら、targetSectionがnullであることから、下記通りでデフォルト所属を設定する
                // １．ログインユーザが本人所属部署の管理権限がある場合、ログインユーザの所属部署をデフォルト所属とする。
                // ２．ログインユーザが本人所属部署の管理権限がない場合、ログインユーザの管理対象部署のTOP部署をデフォルト所属とする
                if (targetAdminSection){
                    this.deptName = [[${ session.txtTmgReferListTreeViewAdminTargetSectionName }]]
                    this.referListObject.txtTmgReferListTreeViewAdminTargetSection = targetAdminSection
                    await this.getEmpCode(this.treeData,targetAdminEmp,targetAdminSection)
                    if (this.EmpSelect) {
                        console.log("1")
                        this.referListObject.txtTmgReferListTreeViewAdminTargetEmp = targetAdminEmp
                        //页面请求参数设置
                        this.query.EmployeeCode = targetAdminEmp
                        this.query.sectionid=targetAdminSection
                    }else{
                        console.log("2")
                        //页面请求参数设置
                        this.query.sectionid = this.referListObject.txtTmgReferListTreeViewAdminTargetSection
                        this.query.EmployeeCode = this.referListObject.txtTmgReferListTreeViewAdminTargetEmp
                    }
                } else {
                    await this.getEmpCode(this.treeData,loginEmp,loginDesignationSection)
                    if (this.EmpSelect) {
                        console.log("3")
                        this.deptName = [[${ session.psSession.loginDesignation[0].sectionName }]]
                        this.referListObject.txtTmgReferListTreeViewAdminTargetSection = [[${ session.psSession.loginDesignation[0].section }]]
                        this.referListObject.txtTmgReferListTreeViewAdminTargetEmp = [[${ session.psSession.loginDesignation[0].employee }]]
                        //页面请求参数设置
                        this.query.EmployeeCode = this.referListObject.txtTmgReferListTreeViewAdminTargetEmp
                        this.query.sectionid=this.referListObject.txtTmgReferListTreeViewAdminTargetSection
                    } else {
                        console.log("4")
                        this.deptName = this.treeData[0].children[0].secnic
                        this.referListObject.txtTmgReferListTreeViewAdminTargetSection = this.treeData[0].children[0].secid
                        //页面请求参数设置
                        this.query.EmployeeCode = this.referListObject.txtTmgReferListTreeViewAdminTargetEmp
                        this.query.sectionid=this.referListObject.txtTmgReferListTreeViewAdminTargetSection

                    }
                }
                 await this.getSearchCondition()
                if(this.EmpFlag){
                    //获取年月下拉列表
                    await this.selectScheduleDateList()
                    //获取预定做成数据
                    await this.getSelectScheduleInfo()
                    //获取 勤務パターン列表  区分列表 出張列表
                    await this.getSelectIkkaInfo()
                    //获取发令信息
                    await this.getHatuRei()
                    //获取周勤务pattern列表
                    await this.selectWeekPtn()
                    //获取周勤务pattern适用列表
                    await this.selectTmgWeekPatternList()
                    //判断选择的年月能不能编辑
                    this.isEditable4Schedule()
                }

            },
            //获取年月下拉列表
            async selectScheduleDateList() {
                try {
                    const query = {
                        ...this.referListObject,
                        EmployeeCode:this.query.EmployeeCode,
                        psSite:this.query.psSite,
                        psApp:this.query.psApp,
                        //请求基准日
                        baseDate:this.referListObject.txtTmgReferListTreeViewRecordDate
                    }
                    const {data}=await  this.http.get(`sys/schedule/selectScheduleDateList`,query)
                    this.dispMonthlyList = data
                    if(this.dispMonthlyList.length>0){
                        //有下拉年月时 取第一个作为默认显示预定数据  并且可以编辑
                        this.defaultDate=this.dispMonthlyList[0].tda_dyyyymm
                        this.query.txtBaseDate=this.dispMonthlyList[0].tda_firstDay
                        this.query.txtEndDate=this.dispMonthlyList[0].tda_endDay
                        this.selectDisabled = true
                    }else{
                        //没有下拉年月时 清空上一次获取的数据 并且页面进行错误提示
                        this.$Message.error({
                            background: true,
                            closable: true,
                            duration: 6.5,
                            content: '指定した年月の就業シート或は選択した所属に存在している職員はありません。'
                        });
                        this.defaultDate=''
                        this.query.txtBaseDate=''
                        this.query.txtEndDate=''
                    }
                } catch (error) {
                    return
                }
            },
            //年月下拉框选择处理
            async handleStartMonth(e) {
                if(!e){
                    return
                }
                let select=this.dispMonthlyList.find(item=> item.tda_dyyyymm==e )
                this.query.txtBaseDate=select.tda_firstDay
                this.query.txtEndDate=select.tda_endDay
                await this.isEditable4Schedule()
                //在编辑页面中当选中不能编辑的月份时 提示信息
                if(this.editErrMsg && this.isEditable){
                    return this.$Notice.error({ title: '注意', desc: this.editErrMsg, duration: 6.5 })
                }
                this.defaultDate = e
                //获取选择的月份的预定做成数据
                await this.getSelectScheduleInfo()
                //获取选择的月份的勤務パターン列表  区分列表 出張列表
                await this.getSelectIkkaInfo()
                //获取选择的月份的发令数据
                await this.getHatuRei()
                //获取周勤务pattern列表
                await this.selectWeekPtn()
                //获取周勤务pattern适用列表
                await this.selectTmgWeekPatternList()
            },
            //判断选择月份是否可以编辑
            async isEditable4Schedule(){
                if( this.defaultDate==''){
                    return
                }
                this.resetMonthSelectForBtnEditable = !this.resetMonthSelectForBtnEditable
                try{
                    const query = {
                        EmployeeCode:this.query.EmployeeCode,
                        psSite:this.query.psSite,
                        psApp:this.query.psApp,
                        //选择的年月
                        startDate: this.query.txtBaseDate,
                        endDate:this.query.txtEndDate
                    }
                    await  this.http.get(`sys/schedule/isEditable`,query)
                    //选择的年月能编辑
                    this.editable=true
                    this.editErrMsg=''
                    console.log("success")
                }catch (e) {
                    //选择的年月不能编辑 后端接口返回如下  进入catch
                    //{"msg":"該当職員「2020年06月」の勤怠はすでに確認済みになりました。\n予定変更することができません。","sysDate":"2020/09/17","code":500}
                    console.log("fail")
                    //不在编辑状态中
                    if(!this.isEditable){
                        this.editable=false
                    }
                    this.editErrMsg=e
                }
            },
            //发令接口
            async getHatuRei() {
                    if( this.defaultDate==''){
                        return
                    }
                    let txtBaseDate= this.yyyyMMdd.split('～')[0].replace(/(.+?)\年(.+?)\月(.+)\日/,"$1/$2/$3")
                    const query = {...this.referListObject,txtBaseDate:txtBaseDate}
                    const { data } =  await this.http.get(`sys/schedule/hatuRei`, query)
                    if(data){
                        this.hatuReiName=data.name
                        this.hatuResTimeRange=data.timerange
                    }else{
                        this.hatuReiName=""
                        this.hatuResTimeRange=""
                    }
            },
            //输入框check
            handleInputChange(i,object,value,el) {
                if(object) {
                    this.hasPassedTimeCheck =   Utils.checkTime(object, value,el)
                }
            },
            //选择框的勾选处理
            handleSelectAll(selection){
                let temp=selection.map(item=> {
                    return item.tda_ccustomerid
                })
                let that=this
                //valueMap 为选择的数据
                this.valueMap=temp.map(e=>{
                    return that.valuebak.findIndex((e1)=>e1.dyyyymmdd==e)
                })
                console.log("valueMap"+JSON.stringify(this.valueMap))

            },
            //适用button处理
            handleSelectApply(){
                //选择了数据才能适用
                if(this.valueMap.length==0){
                    this.$Notice.error({
                        title: '注意',
                        desc: '適用先が未選択です。',
                        duration: 6.5
                    })
                    return
                }
                //当区分和出張为(変更しない)时不允许适用
                if(this.pattern.workId=='TMG_WORK|' && this.pattern.bussinessTripid=='TMG_BUSINESS_TRIP|'){
                    return
                }
                //count：勤务时间
                let count=Utils.timeToMinute(this.pattern.nclose)-Utils.timeToMinute(this.pattern.nopen)
                let result=false
                //当区分为出勤时 勤务时间进行check
                if(this.pattern.workId=="TMG_WORK|000"){
                    if (!this.pattern.nopen) {
                        this.$Notice.warning({ title: '注意', desc:' 開始時間を入力してください。', duration: 6.5 })
                        result=true
                        return result
                    }
                    if (!this.pattern.nclose) {
                        this.$Notice.warning({ title: '注意', desc:' 終了時間を入力してください。', duration: 6.5 })
                        result=true
                        return result
                    }
                    if(0>=count ){
                        this.$Notice.warning({ title: '注意', desc:' 対象時間(終了時間)は(開始時間)より後の時刻を入力してください。', duration: 6.5 })
                        result=true
                        return result
                    }


                    let countRest=0;
                    //过滤后端可能会返回的为空的休息时间
                    this.pattern.restList= this.pattern.restList.filter(e=>e.restOpen!=''||e.restClose!='')
                    let that=this
                    //勤务时间大于360时休息时间check
                    if(count >=360 && this.pattern.restList.some(e1=>{

                        if (!e1.restOpen) {
                            that.$Notice.warning({ title: '注意', desc: ' 休憩開始時間を入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if (!e1.restClose) {
                            that.$Notice.warning({ title: '注意', desc: ' 休憩終了時間を入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if(0>=Utils.timeToMinute(e1.restClose)-Utils.timeToMinute(e1.restOpen)){
                            that.$Notice.warning({ title: '注意', desc:' 対象時間(休憩終了時間)は(休憩開始時間)より後の時刻を入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if (!Utils.timeOverlap(that.pattern.nopen, that.pattern.nclose, e1.restOpen, e1.restClose)) {
                            that.$Notice.warning({ title: '注意', desc:' 休憩時間は勤務時間内で入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }

                        countRest+=Utils.timeToMinute(e1.restClose)-Utils.timeToMinute(e1.restOpen)

                    })){
                        result=true
                        return result
                    }
                    //勤务时间小于360时休息时间check
                    if(360 >=count  && this.pattern.restList.some(e1=>{

                        if (e1.restOpen=='' && e1.restClose!='') {
                            that.$Notice.warning({ title: '注意', desc:' 休憩開始時間を入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if (e1.restOpen!='' && e1.restClose=='') {
                            that.$Notice.warning({ title: '注意', desc: ' 休憩終了時間を入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if(e1.restOpen!='' && e1.restClose!='' && 0>=Utils.timeToMinute(e1.restClose)-Utils.timeToMinute(e1.restOpen)){
                            that.$Notice.warning({ title: '注意', desc: ' 対象時間(休憩終了時間)は(休憩開始時間)より後の時刻を入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if (e1.restOpen!='' && e1.restClose!=''&& !Utils.timeOverlap(that.pattern.nopen, that.pattern.nclose, e1.restOpen, e1.restClose)) {
                            that.$Notice.warning({ title: '注意', desc: ' 休憩時間は勤務時間内で入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }
                        countRest+=Utils.timeToMinute(e1.restClose)-Utils.timeToMinute(e1.restOpen)
                        //checkArr = checkArr.concat(Utils.getNumArray(Utils.timeToMinute(e1.restOpen), Utils.timeToMinute(e1.restClose)).slice(1, -1))

                    })){
                        result=true
                        return result
                    }



                    console.log("countRest"+countRest)
                    //cc:工作时间
                    let cc=count-countRest
                    if(480>=cc && cc >360 &&  45>countRest){
                        that.$Notice.warning({ title: '注意', desc:' 6時間を超える勤務に対して45分以上の休憩が必要です。', duration: 6.5 })
                        result=true
                        return result
                    }
                    if(cc >480 &&  60>countRest){
                        that.$Notice.warning({ title: '注意', desc: ' 8時間を超える勤務に対して1時間以上の休憩が必要です。', duration: 6.5 })
                        result=true
                        return result
                    }

                    result = Utils.multipleTimeOverlap(this.pattern.restList, 'restOpen', 'restClose', '休憩時刻が重複しています。')
                }

                if(result){
                    return
                }

                const that = this
                //针对选择的行进行数据拷贝
                this.valueMap.map(Number).forEach(e=>{
                    let index=e
                    Object.keys(that.value[index]).forEach(function(key) {
                        if(key in that.pattern) {
                            if(that.pattern[key] === 'TMG_WORK|' || that.pattern[key] === 'TMG_BUSINESS_TRIP|') return
                            that.value[index][key]=JSON.parse(JSON.stringify(that.pattern[key]))
                        }
                    })
                })
            },
            //全选button和取消button的勾选处理
            handleSelectAll2(status) {
                this.$refs.selection2.selectAll(status)
                //取消button时还原数据
                if(!status){
                    this.value=JSON.parse(JSON.stringify(this.valuebak))
                }
            },
            //休息时间的减号处理
            handleMinusRest(e, i) {
                e.splice(i, 1)
            },
            //休息时间的加号处理
            handleAddRest(e) {
                e.push({ restOpen: '', restClose: '' })
            },
            //一括適用区分选择处理
            handleChangeDivision(e){
                console.log("handleChangeDivision"+e)
                // 区分选择しない时，将勤務パターン也置为変更しない
                if("TMG_WORK|000"!=e) {
                    this.workPatternSelected = this.workPatternList[0].CPATTERNID
                }
                if("TMG_WORK|000"!=e){
                    this.pattern.nclose=''
                    this.pattern.nopen=''
                    this.pattern.restList=[]
                }


                "TMG_WORK|000"==e ?this.patternDisabled=true:this.patternDisabled=false
            },
            //勤務予定区分选择处理
            handleChangeDivision2(index,name){
                console.log("handleChangeDivision2"+index)
                if(name=="value" && this.value[index].workId!='TMG_WORK|000'){
                    this.value[index].nopen=''
                    this.value[index].nclose=''
                    this.value[index].restList=[]
                }
                if(name== 'value2' && this.value2.applyList[index].workDivisionId!="TMG_WORK|000"){
                    this.value2.applyList[index].startTime=''
                    this.value2.applyList[index].endTime=''
                    this.value2.applyList[index].restStartTime=''
                    this.value2.applyList[index].restEndTime=''
                }
            },
            //勤務パターン选择处理
            handleChangeWorkPattern() {
                const handleTime = Vue.filter('handleTime');
                this.columnsActionData[0].JSON= this.curSelectedWorkPattern.JSON


                let nopen=this.columnsActionData[0].JSON.dutyArray.length === 0?'':this.curSelectedWorkPattern.JSON.dutyArray[0].NOPEN
                let nclose=this.columnsActionData[0].JSON.dutyArray.length === 0?'':this.curSelectedWorkPattern.JSON.dutyArray[0].NCLOSE

                let restList=this.columnsActionData[0].JSON.restArray.map(item=>{
                    return {
                        restOpen:handleTime(item.NOPEN),
                        restClose:handleTime(item.NCLOSE)
                    }
                })
                this.pattern.nopen=handleTime(nopen)
                this.pattern.nclose=handleTime(nclose)
                this.pattern.restList=restList

            },
            //获取预定做成数据
            async getSelectScheduleInfo() {
                const handleTime = Vue.filter('handleTime');
                this.loading=true
                try {
                    //当年月为空时 不请求后端接口 清空页面数据
                    if( this.defaultDate==''){
                        this.selectDisabled=false
                        this.paidHolidayVO=''
                        this.scheduleDataDTOList=[]
                        return
                    }
                    const { data } =  await this.http.get(`sys/schedule/selectScheduleInfo`, this.query)

                    this.selectScheduleInfo=data
                    // paidHolidayVO 为公休日数 基准日数 等等显示数据
                    this.paidHolidayVO=this.selectScheduleInfo.paidHolidayVO
                    //根据tda_nlock_p 判断该行数据能不能选择
                    this.scheduleDataDTOList=this.selectScheduleInfo.scheduleDataDTOList.map(item=>{
                        if(item.tda_nlock_p==1){
                            item._disabled=true;
                        }else if(item.tda_nlock_p==0){
                            item._disabled=false;
                        }
                        return item;
                    })
                    this.yyyyMMdd=this.selectScheduleInfo.period
                    //处理后端返回的数据为页面需要显示的数据
                    this.value=this.scheduleDataDTOList.map(item=>{
                        let restList=item.timerange_arr.map(r=>{
                            return {
                                restClose:handleTime(r.NCLOSE),
                                restOpen:handleTime(r.NOPEN)
                            }
                        })
                        return {
                            "workMM":item.tda_cworkingid_mm,
                            "workId":item.tda_cworkingid_p,
                            "bussinessTripid":item.tda_cbusinesstripid_p,
                            "nclose":item.tda_nclose_p.trim(),
                            "dyyyymmdd":item.tda_ccustomerid,
                            "nopen":item.tda_nopen_p.trim(),
                            "comment":item.tda_ccomment_p,
                            "restList":restList
                        }
                    })
                    //备份原始的页面显示数据
                    this.valuebak=JSON.parse(JSON.stringify(this.value))
                } catch (error) {
                    return
                } finally {
                    this.loading = false
                }
            },
            //获取周勤务pattern适用列表
            async selectTmgWeekPatternList(){
                this.weekPatternloading2=true
                try{
                    const { data } = await this.http.get(`sys/schedule/selectTmgWeekPatternList`, this.query)
                    this.tableDataUsed=data
                    this.tableDataUsedbak=JSON.parse(JSON.stringify(data))
                }catch (e) {
                    return
                }finally {
                    this.weekPatternloading2=false
                }

            },
            //获取周勤务pattern列表
            async selectWeekPtn(){
                this.weekPatternloading2=true
                try{
                    const { data } = await this.http.get(`sys/schedule/selectWeekPtn`, this.query)
                    this.workDivisionList=data
                }catch (e) {
                    return
                }finally {
                    this.weekPatternloading2=false
                }

            },
            //周勤务pattern参照处理
            async selectWeekPatternInfo(i){
                this.weekPatternloading = true
                try{
                    const query ={...this.query,twp_nid:this.tableDataUsed[i].twp_nid}
                    const { data } = await this.http.get(`sys/schedule/selectWeekPatternInfo`, query)
                    this.applyStartTime=data.twp_dstartdate
                    this.applyEndTime=data.twp_denddate
                    let index=-1;
                    Object.keys(data).map(e=>{
                        if(e.startsWith("workname")){
                            index++
                            this.tableData3[index].workname=data[e]
                        }
                        if(e.startsWith("twp_copen")){
                            this.tableData3[index].twp_copen=data[e]
                        }
                        if(e.startsWith("twp_cclose")){
                            this.tableData3[index].twp_cclose=data[e]
                        }
                        if(e.startsWith("rest")){
                            this.tableData3[index].rest=data[e].split('-')
                        }

                    })
                }catch (error) {
                    return
                }finally {
                    this.weekPatternloading = false
                }
            },
            //周勤务pattern更新处理
            async updateWeekPatternInfo(index){
                //週勤務パターン適用済时间check
                let dateArr=this.tableDataUsed.map(e=>{
                    return {"start":e.twp_dstartdate,"end":e.twp_denddate}
                })
                console.log("dateArr"+JSON.stringify(dateArr))
                if(Utils.multipleDateRangeOverlaps(dateArr)){
                    this.$Message.error("既存の入力欄および新規入力欄について、適用期間が重複しています。")
                    return
                }

                if(JSON.stringify(this.tableDataUsed[index])==JSON.stringify(this.tableDataUsedbak[index])){
                    this.$Message.error("データは変更されません")
                    return
                }
                let startdate=this.tableDataUsed[index].twp_dstartdate
                let enddate=this.tableDataUsed[index].twp_denddate
                let nid=this.tableDataUsed[index].twp_nid
                if(new Date(startdate)>=new Date(enddate)){
                    this.$Message.error("適用開始日は、適用終了日より前の日付を入力してください。")
                    return
                }

                let curDate=Utils.formatDate(new Date(),"YYYY/MM/DD")
                let msg=`は${curDate}以降を入力してください。`
                if(new Date()>new Date(enddate)){
                    this.$Message.error('適用終了日'+msg)
                    return
                }

                if(startdate!=this.tableDataUsedbak[index].twp_dstartdate){
                    if(new Date()>new Date(startdate)){
                        this.$Message.error('適用開始日'+msg)
                        return
                    }
                }
                this.$Modal.confirm({
                    title: '注意',
                    content: 'この編集内容で更新します。よろしいですか？',
                    okText: 'OK',
                    width: 480,
                    cancelText: 'キャンセル',
                    onOk: async () => {
                        this.weekPatternloading2=true
                        try{
                            const  query={...this.query,txtACTION:"ACT_MakeWeekPattern_UWPtn",twp_dstartdate:startdate,twp_denddate:enddate,twp_nid:nid}
                            const { data } = await this.http.postForm(`sys/schedule/executeUpdateWeekPattern`, query)
                            if(data){
                                this.$Message.success('更新完了')
                            }
                        }catch (e) {
                            return
                        }finally {
                            this.weekPatternloading2=false
                        }
                        this.selectTmgWeekPatternList()
                        this.getSelectScheduleInfo()
                    },
                    onCancel: () => {
                    }
                })
            },
            //周勤务pattern删除处理
            async deleteWeekPtn(index){
                this.$Modal.confirm({
                    title: '注意',
                    content: 'この週勤務パターンを削除します。よろしいですか？',
                    okText: 'OK',
                    width: 480,
                    cancelText: 'キャンセル',
                    onOk: async () => {
                        this.weekPatternloading2=true
                        const query ={...this.query,twp_nid:this.tableDataUsed[index].twp_nid}
                        try{
                            const { data } = await this.http.get(`sys/schedule/deleteWeekPtn`, query)
                        }catch(e){
                            return
                        }finally {
                            this.weekPatternloading2=false

                        }
                        this.selectTmgWeekPatternList()
                        this.getSelectScheduleInfo()
                    },
                    onCancel: () => {
                    }
                })
            },
            //周勤务pattern登陆处理
            async executeMakeWeekPattern(){
                //週勤務パターン適用期間开始时间check
                if(!this.value2.applyStart){
                    this.$Message.error(" 適用開始日が未入力です。")
                    return
                }
                //週勤務パターン適用期間结束时间check
                if(!this.value2.applyEnd){
                    this.$Message.error("適用終了日が未入力です。")
                    return
                }
                //週勤務パターン適用期間和適用済check
                let dateArr=this.tableDataUsed.map(e=>{
                    return {"start":e.twp_dstartdate,"end":e.twp_denddate}
                })
                dateArr.push({"start":this.value2.applyStart,"end":this.value2.applyEnd})
                console.log("dateArr"+JSON.stringify(dateArr))
                if(Utils.multipleDateRangeOverlaps(dateArr)){
                    this.$Message.error("既存の入力欄および新規入力欄について、適用期間が重複しています。")
                    return
                }

                //週勤務パターン適用期間开始时间check
                let nextMonthStr=Utils.formatDate(this.nextMonthFirstDay,"YYYY/MM/DD")
                let msg=`は${nextMonthStr}以降を入力してください。`
                if(this.nextMonthFirstDay>new Date(this.value2.applyStart)){
                    this.$Message.error('適用開始日'+msg)
                    return
                }

                if(this.nextMonthFirstDay>new Date(this.value2.applyEnd)){
                    this.$Message.error('適用終了日'+msg)
                    return
                }
                if(new Date(this.value2.applyStart)>new Date(this.value2.applyEnd)){
                    this.$Message.error("適用開始日は、適用終了日より前の日付を入力してください。")
                    return
                }
                let result=false
                let that=this
                this.value2.applyList.some(e=>{
                    let count=Utils.timeToMinute(e.endTime)-Utils.timeToMinute(e.startTime)
                    console.log("applyList"+JSON.stringify(e))
                    //週勤務パターン新规当区分为出勤 时间check
                    if(e.workDivisionId=='TMG_WORK|000'){
                        if (!e.startTime) {
                            that.$Notice.warning({ title: '注意', desc:'始業時間を入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if (!e.endTime) {
                            that.$Notice.warning({ title: '注意', desc:'終業時間を入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if(0>=count){
                            that.$Notice.warning({ title: '注意', desc:'始業時刻は、終業時刻より前の時刻を入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if(e.restStartTime!='' && e.restEndTime==''){
                            that.$Notice.warning({ title: '注意', desc:'休憩終了時刻を入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if(e.restStartTime=='' && e.restEndTime!=''){
                            that.$Notice.warning({ title: '注意', desc:'休憩開始時刻を入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }
                        let countRest=Utils.timeToMinute(e.restEndTime)-Utils.timeToMinute(e.restStartTime)

                        let cc=count-countRest
                        if(480>=cc && cc >360 &&  45>countRest){
                            that.$Notice.warning({ title: '注意', desc: ' 6時間を超える勤務に対して45分以上の休憩が必要です。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if(cc >480 &&  60>countRest){
                            that.$Notice.warning({ title: '注意', desc: ' 8時間を超える勤務に対して1時間以上の休憩が必要です。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if(e.restStartTime!='' && e.restEndTime!=''){
                            if (!Utils.timeOverlap(e.startTime, e.endTime, e.restStartTime, e.restEndTime)) {
                                that.$Notice.warning({ title: '注意', desc:' 休憩時間は勤務時間内で入力してください。', duration: 6.5 })
                                result=true
                                return result
                            }
                        }


                        if(e.restStartTime!='' && e.restEndTime!=''){
                            let count=Utils.timeToMinute(e.restEndTime)-Utils.timeToMinute(e.restStartTime)
                            if(0>=count){
                                that.$Notice.warning({ title: '注意', desc:'休憩開始時刻は、休憩終了時刻より前の時刻を入力してください。', duration: 6.5 })
                                result=true
                                return result
                            }
                        }

                    }
                })
                if(result){
                    return
                }
                this.$Modal.confirm({
                    title: '注意',
                    content: 'この編集内容で登録します。よろしいですか？',
                    okText: 'OK',
                    width: 480,
                    cancelText: 'キャンセル',
                    onOk: async () => {
                        this.weekPatternloading2=true
                        const query={...this.query,content:JSON.stringify(this.value2) }

                        try{
                            await this.http.postForm(`sys/schedule/executeMakeWeekPattern`,query)
                        }catch (e) {
                            this.$Notice.warning({ title: '注意', desc: e, duration: 6.5 })
                        }finally {
                            this.weekPatternloading2=false
                        }
                        this.selectTmgWeekPatternList()
                        this.getSelectScheduleInfo()
                        this.value2={"applyStart":'',"applyEnd":'',applyList:Array(7).fill().map((e,index)=>{
                                let id='TMG_WORK|000'
                                if(index==0){
                                    id='TMG_WORK|500'
                                }
                                if(index==6){
                                    id='TMG_WORK|570'
                                }
                                return  {"workFlag":index,"workDivisionId":id,"startTime":'',"endTime":'',"restStartTime":'',"restEndTime":''}
                            })}
                    },
                    onCancel: () => {
                    }
                })

            },
            //提交预定做成数据处理
            postExecuteEditMonthlyUSchedule: Debounce( async function() {

                let that=this
                //获取用户有改动的数据
                let postValue= this.value.filter(function(obj) {
                    return !that.valuebak.some(function(obj2) {
                        return JSON.stringify(obj) == JSON.stringify(obj2)
                    });
                });

                console.log("postValue"+JSON.stringify(postValue))
                let result=false
                //数据提交前check
                postValue.some(e=>{
                    //count:勤务时间
                    let count=Utils.timeToMinute(e.nclose)-Utils.timeToMinute(e.nopen)
                    console.log("count"+count)
                    let day=Utils.formatDate(e.dyyyymmdd,'MM/DD')

                    let pattern= new RegExp("[A-Za-z0-9]+");
                    if(pattern.test(e.comment)){
                        if(e.comment && e.comment.length>=100){
                            that.$Notice.warning({ title: '注意', desc: day+' コメントが設定値を超えています。全角・半角カナ50字以内、半角英数100字以内。', duration: 6.5 })
                            result=true
                            return result
                        }
                    }else{
                        if(e.comment && e.comment.length>=50){
                            that.$Notice.warning({ title: '注意', desc: day+' コメントが設定値を超えています。全角・半角カナ50字以内、半角英数100字以内。', duration: 6.5 })
                            result=true
                            return result
                        }

                    }
                    //区分为出勤时进行时间check
                    if(e.workId=="TMG_WORK|000"){
                        if (!e.nopen) {
                            that.$Notice.warning({ title: '注意', desc: day+' 始業時間を入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if (!e.nclose) {
                            that.$Notice.warning({ title: '注意', desc: day+' 終業時間を入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if(0>=count ){
                            that.$Notice.warning({ title: '注意', desc: day+' 対象時間(始業時間)は(終業時間)より後の時刻を入力してください。', duration: 6.5 })
                            result=true
                            return result
                        }


                        let countRest=0;
                        //过滤空值
                        e.restList= e.restList.filter(e=>e.restOpen!=''||e.restClose!='')
                        //勤务时间大于360check
                        if(count >=360 && e.restList.some(e1=>{
                            if (!e1.restOpen) {
                                that.$Notice.warning({ title: '注意', desc: day+' 休憩開始時間を入力してください。', duration: 6.5 })
                                result=true
                                return result
                            }
                            if (!e1.restClose) {
                                that.$Notice.warning({ title: '注意', desc: day+' 休憩終了時間を入力してください。', duration: 6.5 })
                                result=true
                                return result
                            }
                            if(0>=Utils.timeToMinute(e1.restClose)-Utils.timeToMinute(e1.restOpen)){
                                that.$Notice.warning({ title: '注意', desc: day+' 対象時間(休憩終了時間)は(休憩開始時間)より後の時刻を入力してください。', duration: 6.5 })
                                result=true
                                return result
                            }
                            if (!Utils.timeOverlap(e.nopen, e.nclose, e1.restOpen, e1.restClose)) {
                                that.$Notice.warning({ title: '注意', desc: day+' 休憩時間は勤務時間内で入力してください。', duration: 6.5 })
                                result=true
                                return result
                            }

                            countRest+=Utils.timeToMinute(e1.restClose)-Utils.timeToMinute(e1.restOpen)
                        })){
                            result=true
                            return result
                        }
                        //勤务时间小于360check
                        if(360 >=count  && e.restList.some(e1=>{
                            if (e1.restOpen=='' && e1.restClose!='') {
                                that.$Notice.warning({ title: '注意', desc: day+' 休憩開始時間を入力してください。', duration: 6.5 })
                                result=true
                                return result
                            }
                            if (e1.restOpen!='' && e1.restClose=='') {
                                that.$Notice.warning({ title: '注意', desc: day+' 休憩終了時間を入力してください。', duration: 6.5 })
                                result=true
                                return result
                            }
                            if(e1.restOpen!='' && e1.restClose!='' && 0>=Utils.timeToMinute(e1.restClose)-Utils.timeToMinute(e1.restOpen)){
                                that.$Notice.warning({ title: '注意', desc: day+' 対象時間(休憩終了時間)は(休憩開始時間)より後の時刻を入力してください。', duration: 6.5 })
                                result=true
                                return result
                            }
                            if (e1.restOpen!='' && e1.restClose!=''&&!Utils.timeOverlap(e.nopen, e.nclose, e1.restOpen, e1.restClose)) {
                                that.$Notice.warning({ title: '注意', desc: day+' 休憩時間は勤務時間内で入力してください。', duration: 6.5 })
                                result=true
                                return result
                            }
                            countRest+=Utils.timeToMinute(e1.restClose)-Utils.timeToMinute(e1.restOpen)
                        })){
                            result=true
                            return result
                        }

                        console.log("countRest"+countRest)
                        let cc=count-countRest
                        //休息时间check
                        if(480>=cc && cc >360 &&  45>countRest){
                            that.$Notice.warning({ title: '注意', desc: day+' 6時間を超える勤務に対して45分以上の休憩が必要です。', duration: 6.5 })
                            result=true
                            return result
                        }
                        if(cc >480 &&  60>countRest){
                            that.$Notice.warning({ title: '注意', desc: day+' 8時間を超える勤務に対して1時間以上の休憩が必要です。', duration: 6.5 })
                            result=true
                            return result
                        }
                        result = Utils.multipleTimeOverlap(e.restList, 'restOpen', 'restClose', '休憩時刻が重複しています。')

                    }
                })

                if(result){
                    return
                }
                this.$Modal.confirm({
                    title: '注意',
                    content: 'この編集内容で登録します。よろしいですか？',
                    okText: 'OK',
                    width: 480,
                    cancelText: 'キャンセル',
                    onOk: async () => {
                        let endDispDate= this.yyyyMMdd.split('～')[0].replace(/(.+?)\年(.+?)\月(.+)\日/,"$1/$2/$3")
                        let baseDate=this.yyyyMMdd.split('～')[1].replace(/(.+?)\年(.+?)\月(.+)\日/,"$1/$2/$3")
                        let content={
                            monthlyScheduleEmpInfoDTOS:postValue,
                            endDispDate:endDispDate,
                            baseDate:baseDate,
                            dispStartDate:Utils.formatDate(Date.now(),'YYYY/MM/DD'),
                            targetUserId:this.query.EmployeeCode,
                            loginUserId: [[${ session.psSession.loginEmployee }]]
                        }
                        const query = {...this.query,content:JSON.stringify(content) }
                        console.log("postExecuteEditMonthlyUSchedule"+query)
                        try{
                            this.postScheduleLoading=true
                            this.loading=true
                            await this.http.postForm(`sys/schedule/executeEditMonthlyUSchedule`,query)
                            this.$Message.success('登録完了')
                        }catch (e) {
                            return
                        }finally {
                            this.isEditable=false
                            this.valueMap=[]
                            this.postScheduleLoading=false
                            this.loading=false
                        }
                        await this.getSelectScheduleInfo()
                        this.getSelectIkkaInfo()
                    },
                    onCancel: () => {
                    }
                })
            }),
            //获取勤務パターン列表  区分列表 出張列表接口
            async getSelectIkkaInfo() {
                if( this.defaultDate==''){
                    return
                }
                const query = {
                    EmployeeCode:this.query.EmployeeCode,
                    psSite:this.query.psSite,
                    psApp:this.query.psApp,
                    //该参数后端要求传一个为空的过去
                    baseDateIkka:'',
                    sectionid:this.query.sectionid,
                    groupid:this.query.groupid,
                }
                const { data } = await this.http.get(`sys/schedule/selectIkkaInfo`, query)
                this.selectIkkaInfo=data
                //勤務パターン列表
                this.workPatternList=this.selectIkkaInfo.workPatternList
                //区分列表
                this.kubunnList=this.selectIkkaInfo.kubunnList
                //区分列表备份
                this.kubunnListbak=JSON.parse(JSON.stringify(this.selectIkkaInfo.kubunnList))
                //前端加入 変更しない 选项
                this.kubunnList.unshift({"MGD_CMASTERCODE":"TMG_WORK|","MGD_CGENERICDETAILDESC":"(変更しない)"})
                //出張列表
                this.syuccyouList=this.selectIkkaInfo.syuccyouList
                //出張列表备份
                this.syuccyouListbak=JSON.parse(JSON.stringify(this.selectIkkaInfo.syuccyouList))
                //前端加入 変更しない 选项
                this.syuccyouList.unshift({"MGD_CMASTERCODE":"TMG_BUSINESS_TRIP|","MGD_CGENERICDETAILDESC":"(変更しない)"})
            },
            //cancel按钮处理
            restPattern(){
                this.pattern.workId='TMG_WORK|'
                this.pattern.bussinessTripid='TMG_BUSINESS_TRIP|'
                this.workPatternSelected='TMG_PATTERN|'
                this.handleChangeWorkPattern()
                this.patternDisabled=false

            },

            async handleClickLeaf(e) {
                //同一部署を二回目でクリックすると、取消とするためで、エラーあり
                //よって、二回目クリックすると、何もしない
                if(!e[0]) return
                const section = [[${ TREEVIEW_KEY_ADMIN_TARGET_SECTION }]]
                this.referListObject[section] = e[0].secid
                this.deptName = e[0].secnic

                this.getEmpList()
            },
            async getEmpList() {
                try {
                    this.emplistLoading = true
                    //初期化及び前回データをクリアする
                    this.empTreeData = []
                    const { empList, recordDate } = await this.http.get('sys/tree/emplist', this.referListObject)
                    this.empTreeData = Utils.convertTreeData(empList[0].child)
                    this.referListObject.txtTmgReferListTreeViewRecordDate = recordDate
                } catch (error) {
                    return
                } finally {
                    this.emplistLoading = false
                }
            },
            async handleClickEmpLeaf(e, tabType) {
                //同一部署を二回目でクリックすると、取消とするためで、エラーあり
                //よって、二回目クリックすると、何もしない
                if(!e[0]) return
                this.deptDrawShow = false

                this.loginEmployee = e[0].empid
                this.sectionName = e[0].secnic

                this.kanjiName = e[0].empname
                this.deptName = e[0].secnic
                this.wokertypename=e[0].wokertypename
                //其他页面需要参数
                this.referListObject.txtTmgReferListTreeViewAdminTargetEmp = e[0].empid
                this.query.txtTmgReferListTreeViewAdminTargetEmp = e[0].empid
                this.query.txtTmgReferListTreeViewAdminTargetSection = e[0].secid
                //当前页面请求参数
                this.query.EmployeeCode = e[0].empid
                this.query.sectionid= e[0].secid
                this.query.hidSelectTab = tabType
                this.referListObject.hidSelectTab = tabType
                this.isSearchHistory = false

                //获取年月下拉列表
                await this.selectScheduleDateList()
                //获取预定做成数据
                await this.getSelectScheduleInfo()
                //获取 勤務パターン列表  区分列表 出張列表
                await this.getSelectIkkaInfo()
                //获取发令信息
                await this.getHatuRei()
                //获取周勤务pattern列表
                await this.selectWeekPtn()
                //获取周勤务pattern适用列表
                await this.selectTmgWeekPatternList()
                //判断选择的年月能不能编辑
                this.isEditable4Schedule()



            },
            async getEmpCode(data, empId, sectionId) {
                this.EmpSelect=false
                this.getSecCode(data, sectionId)
                if(this.SecFlag){
                    this.referListObject.txtTmgReferListTreeViewAdminTargetSection = sectionId
                }else{
                    this.referListObject.txtTmgReferListTreeViewAdminTargetSection = data[0].secid
                }
                await this.getEmpList()

                if(empId){
                    this.empTreeData.forEach(e => {
                        if (e.empid === empId) {
                            this.EmpFlag=true
                            this.kanjiName=e.empname
                            this.wokertypename=e.wokertypename
                            this.EmpSelect=true
                            return
                        }
                    })
                }
                if(this.empTreeData[0] && !this.EmpSelect){
                    this.EmpFlag=true
                    this.referListObject.txtTmgReferListTreeViewAdminTargetEmp = this.empTreeData[0].empid
                    this.kanjiName=this.empTreeData[0].empname
                    this.wokertypename=this.empTreeData[0].wokertypename
                }
            },
            getSecCode(data,sectionId){
                data.some( j => {
                    if (j.secid === sectionId) {
                        this.SecFlag = true
                    }else{
                        const children = j.child || j.children
                        if (children && children.length > 0) {
                            this.getSecCode(children,sectionId)
                        }
                    }
                })
            },
            async getOrgTree() {
                try {
                    const { orgList, recordDate } = await this.http.get('sys/tree', this.referListObject)
                    this.treeData = Utils.convertTreeData(orgList)
                    this.referListObject.txtTmgReferListTreeViewRecordDate = recordDate
                } catch (error) {
                    return
                } finally {
                    this.loading = false
                }
            },
            async getSearchCondition() {
                const { data } = await this.http.get('sys/tree/conditions', this.referListObject)
                this.searchConditionsList= Object.keys(data.searchConditions).map(e=> { return { name:data.searchConditions[e], value:e }})
                this.searchTypesList = Object.keys(data.searchTypes).map(e=> { return { name:data.searchTypes[e], value:e }})
            },
            async handleDeptDateChange(e) {
                this.referListObject.txtTmgReferListTreeViewRecordDate = e
                this.isSearchHistory = true
                await this.getOrgTree()
                if(this.treeData.length !== 0) {
                        this.$Notice.warning({ title:'所属図更新完了',desc:"下記の所属リストから対象を選んでください" })
                    }
                this.empTreeData= []
            },
            searchOrgTree: Debounce( async function() {
                if (this.referListObject.hidSearchData === null || this.referListObject.hidSearchData.trim() == '') {
                    this.$Message.error({
                        background: true,
                        closable: true,
                        duration: 6,
                        content: '検索内容が未設定です。検索内容を入力してください。'
                    });
                    return
                }
                this.empDeptLoading = true
                try {
                    const { data,msg } = await this.http.get('sys/tree/search', this.referListObject)
                    this.searchEmpTreeData = Utils.convertTreeData(data,false,msg)
                    this.$Notice.success({ title:'所属図更新完了' })
                } catch (error) {
                    return
                } finally {
                    this.empDeptLoading = false
                }
            }),
            handleScroll: Throttle(function(e) {
                this.contentScrollTop = e.target.documentElement.scrollTop || e.target.body.scrollTop
            }, 50),
            // currentTabChanged(name) {
            //     if (name=="organisationTree") {
            //         this.query.hidSelectTab='0'
            //     } else if (name=="organisationSearch") {
            //         this.query.hidSelectTab='1'
            //     }
            //     console.log("----------------------2----------------------"+this.query.hidSelectTab)
            // },
            async handleDeptViewTypeChange() {
                await this.getOrgTree()
                this.$Notice.success({ title:'所属図更新完了' })
            },

            dayRed(e) {
                const dayOfWeek = e.holflgCalendar
                if (!dayOfWeek) {
                    return
                }
                if (dayOfWeek.trim() != 'TMG_HOLFLG|0') {
                    return 'blue'
                }
                if (e.tda_ccustomerid == this.today) {
                    return 'brown'
                }
            },


        }
    })
</script>
</body>

</html>