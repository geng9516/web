<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='アプリケーション設定',cssPaths='/pages/content.min.css')">
</head>
<body>
  <div th:replace="layout/loadingBar::loadingBar"></div>
  <!-- 菜单导航栏 -->
  <div th:replace="layout/sider"></div>
  <main class="content startregistersettings-warp" ref="layout">
    <div class="content_head">
      <div class="header">
        <div class="title1">
          <h1>
            <Icon type="i-emeer colored"></Icon>
            {{ `アプリケーション設定` }}
          </h1>
        </div>
        <div class="btnbox">
          <span style="flex:1"></span>
          <i-button type="success" icon="md-done-all" @click="update" :loading="editLoading">登録</i-button>
        </div>
      </div>
    </div>
    <div class="content_body">
      <Alert v-show="this.updateList.length > 0" class="error-info tl">情報が変更されています。 登録ボタンで登録処理を行なってください。</Alert>
      <i-table border :class="tableHeadFixed ? 'table-head-fixed no-padding' : 'no-padding'" :row-class-name="() => 'select-col'"
        :columns="columns" :disabled-hover="true" :data="tableData" :loading="loading" @on-cell-click="handleCellClick"
        ref="table">
        <!-- type: "0" トップページ   <Icon type="md-compass" />
        type: "1" サイト   <Icon type="md-compass" />
        type: "3" アプリケーション ml10 <Icon type="md-desktop" />
        type: "4" サブアプリケーション <Icon type="md-easel" />
        type: "2" ダイアログアプリケーション ml10 <Icon type="ios-photos" />
        type: "5" 画面 ml20  <Icon type="md-browsers" />
        type: "6" 機能ボタン ml30 <Icon type="md-disc" /> -->

        <template slot-scope="{ row }" slot="objectName">
          <span v-if="row.type === '0'" class="mr10 mt5 mb5 pt2 pb2 pl10 pr10 row-label-primary">
            <Icon type="md-cloud" class="mr5"></Icon>{{row.name}}
          </span>
          <span v-if="row.type === '1'" class="mr10 mt5 mb5 pt2 pb2 pl10 pr10 row-label-primary">
            <Icon type="md-compass" class="mr5"></Icon>{{row.name}}
          </span>
          <span v-if="row.type === '2'" class="mr10 mt5 mb5 ml20 pt2 pb2 pl10 pr10 row-label-primary">
            <Icon type="ios-photos" class="mr5"></Icon>{{row.name}}
          </span>
          <span v-if="row.type === '3'" class="mr10 mt5 mb5 ml20 pt2 pb2 pl10 pr10 row-label-primary">
            <Icon type="md-desktop" class="mr5"></Icon>{{row.name}}
          </span>
          <span v-if="row.type === '4'" class="mr10 mt5 mb5 ml20 pt2 pb2 pl10 pr10 row-label-primary">
            <Icon type="md-easel" class="mr5"></Icon>{{row.name}}
          </span>
          <span v-if="row.type === '5'" class="mr10 mt5 mb5 pt2 pb2 pl10 pr10 row-label-primary"
            style="margin-left: 40px;">
            <Icon type="md-browsers" class="mr5"></Icon>{{row.name}}
          </span>
          <span v-if="row.type === '6'" class="mr10 mt5 mb5 pt2 pb2 pl10 pr10 row-label-primary"
            style="margin-left: 60px;">
            <Icon type="md-disc" class="mr5"></Icon>{{row.name}}
          </span>
        </template>

        <template slot-scope="{ row }" slot="type">
          <span v-if="row.type === '0'" style="color: var(--row-label-primary)">
            <Icon type="md-cloud" class="mr5"></Icon>トップページ
          </span>
          <span v-if="row.type === '1'" style="color: var(--row-label-primary)">
            <Icon type="md-compass" class="mr5"></Icon>サイト
          </span>
          <span v-if="row.type === '3'"style="color: var(--row-label-primary)">
            <Icon type="md-desktop" class="mr5"></Icon>アプリケーション
          </span>
          <span v-if="row.type === '4'"style="color: var(--row-label-primary)">
            <Icon type="md-easel" class="mr5"></Icon>サブアプリケーション
          </span>
          <span v-if="row.type === '2'"style="color: var(--row-label-primary)">
            <Icon type="ios-photos" class="mr5"></Icon>ダイアログアプリケーション
          </span>
          <span v-if="row.type === '5'"style="color: var(--row-label-primary)">
            <Icon type="md-browsers" class="mr5"></Icon>画面
          </span>
          <span v-if="row.type === '6'"style="color: var(--row-label-primary)">
            <Icon type="md-disc" class="mr5"></Icon>機能ボタン
          </span>
        </template>

        <template slot-scope="{ row }" slot="action">
          <span v-if="row.type === '0'" style="color: var(--row-label-primary)">
            <i-button type="primary" ghost icon="md-create" size="small">トップページ編集</i-button>
            <i-button type="success" ghost icon="md-add" size="small">ダイアログアプリ追加</i-button>
            <i-button type="success" ghost icon="md-add" size="small">アプリ追加</i-button>
            <i-button type="success" ghost icon="md-add" size="small">サイト追加</i-button>
          </span>
          <span v-if="row.type === '1'" style="color: var(--row-label-primary)">
            <i-button type="primary" ghost icon="md-create" size="small">サイト編集</i-button>
            <i-button type="success" ghost icon="md-add" size="small">アプリ追加</i-button>
            <i-button type="error" ghost icon="md-trash" size="small">サイト削除</i-button>
          </span>
          <span v-if="row.type === '3'"style="color: var(--row-label-primary)">
            <i-button type="primary" ghost icon="md-create" size="small">アプリ編集</i-button>
            <i-button type="success" ghost icon="md-add" size="small">画面追加</i-button>
            <i-button type="error" ghost icon="md-trash" size="small">アプリ削除</i-button>
          </span>
          <span v-if="row.type === '4'"style="color: var(--row-label-primary)">
            サブアプリケーション
          </span>
          <span v-if="row.type === '2'"style="color: var(--row-label-primary)">
            <i-button type="primary" ghost icon="md-create" size="small">ダイアログアプリ編集</i-button>
            <i-button type="success" ghost icon="md-add" size="small">画面追加</i-button>
            <i-button type="error" ghost icon="md-trash" size="small">ダイアログアプリ削除</i-button>
          </span>
          <span v-if="row.type === '5'"style="color: var(--row-label-primary)">
            <i-button type="primary" ghost icon="md-create" size="small">画面編集</i-button>
            <i-button type="success" ghost icon="md-add" size="small">ボタン追加</i-button>
            <i-button type="error" ghost icon="md-trash" size="small">画面削除</i-button>
          </span>
          <span v-if="row.type === '6'"style="color: var(--row-label-primary)">
            <i-button type="primary" ghost icon="md-create" size="small">ボタン編集</i-button>
            <i-button type="error" ghost icon="md-trash" size="small">ボタン削除</i-button>
          </span>
          <!-- <i-button type="success" ghost size="small" icon="ios-arrow-forward" long></i-button> -->
        </template>
      </i-table>
    </div>
    <Modal class="tc" v-model="isShow" title="対象範囲設定" width="650" :mask-closable="false" @on-ok="joinUpdate">
      <Alert class="error-info tl">入力内容は登録するまで保持されます。</Alert>
      <radio-group class="tl width100" v-model="updateValue.type" @on-change="handleRadio($event)" vertical>
        <Radio label="0">未設定</Radio>
        <span class="ml30" style="color: var(--primary-info);">自分自身の情報のみ参照可能です</span>
        <Radio label="1">すべて</Radio>
        <span class="ml30" style="color: var(--primary-info);">すべての情報が参照可能です。</span>
        <div class="titlenorm mb5 mt10" style="font-size:15px">
          <Icon type="logo-buffer"></Icon>
          条件を選択
        </div>
        <Alert class="primary-info tl">指定範囲内での情報が参照可能です。</Alert>
        <Radio style="display: inline-block;width: 50px;" label="2">OR</Radio>
        <Radio style="display: inline-block;width: 50px;" label="3">AND</Radio>
     </radio-group>

     <i-select class="mt10" v-model="updateValue.selected" :disabled="updateValue.selectedDisable" @on-change="handleSelect($event)" placeholder="選択ください">
     <i-option>&nbsp;</i-option>
      <i-option v-for="(item, index) of conditionsList" :key="index" :label="item.mdpCpermissionname" :value="item.mdpCpermissionid">
      </i-option>
    </i-select>

     <Checkbox v-model="updateValue.checked" class="width100 tl mt15" style="margin-left: 0;" @on-change="handleCheckBox">基点組織設定を使用する</Checkbox>
     <div class="titlenorm mb5 mt10" style="font-size:15px">
      <Icon type="logo-buffer"></Icon>
      退職者検索対象範囲
    </div>

    <radio-group class="tl width100" v-model="updateValue.hgpCpermRetired" vertical>
      <Radio label="0">参照しない</Radio>
      <span class="ml30" style="color: var(--primary-info);">退職者の情報は参照出来ません。</span>
      <Radio label="1">自社のみ</Radio>
      <span class="ml30" style="color: var(--primary-info);">自社の退職者の情報が参照可能です。</span>
      <Radio label="2">すべて</Radio>
      <span class="ml30" style="color: var(--primary-info);">すべての退職者の情報が参照可能です。</span>
   </radio-group>
    </Modal>
    <back-top></back-top>
  </main>
  <div th:replace="layout/head::header"></div>
  <script type="text/babel" th:inline="javascript">
    const START_REGISTER_SETTINGS = new Vue({
      el: '.startregistersettings-warp',
      data() {
        return {
          isShow: false,
          loading: true,
          editLoading: false,
          needChange: '',
          psSite: Utils.getUrlParam(location.href, 'psSite'),
          psApp: Utils.getUrlParam(location.href,'psApp'),
          updateValue: {},
          updateValueIndex: {},
          updateList:[],
          groupList: [],
          tableHead: [],
          columns:[
            {
              title: 'アプリケーション名',
              minWidth: 400,
              maxWidth: 600,
              slot: 'objectName'
            },
            {
              title: '種別',
              minWidth: 220,
              maxWidth: 320,
              slot: 'type'
            },
            {
              title: '操作',
              minWidth: 560,
              maxWidth: 900,
              slot: 'action',
              align: 'right'
            }
          ],
          opts: {
            systemId: '01',
            appId: '0',
            siteId: '0',
            companyId: '0',
            date: '',
            groupId: '0',
            isAll: false,
          },
          tableData: [],
          conditionsList: [],
          contentScrollTop: 0
        }
      },
      async created() {
        this.getConditionsList()
        this.getTableData()
        window.addEventListener('scroll',this.handleScroll,{ passive: true })
      },
        beforeDestroy() {
            window.removeEventListener('scroll',this.handleScroll,{ passive: true })
      },
      computed: {
        tableHeadFixed() {
          if (this.contentScrollTop > 110) return true
          else return false
        }
      },
      methods: {
        async getTableData() {
          const OPTS = { ...this.opts }
          OPTS.psSite = Utils.getUrlParam(location.href, 'psSite')
          OPTS.psApp = Utils.getUrlParam(location.href,'psApp')
          Object.keys(OPTS).forEach(key => {
            if (OPTS[key] === '0') {
              delete OPTS[key]
            }
          })
          this.loading = true
          try {
            const { data } = await this.http.get('sys/appmanager/applist', OPTS)
            this.tableData = data
          } catch (error) {
          } finally {
            this.loading = false
          }
        },
        async getConditionsList() {
          const { data } = await this.http.get('sys/searchrangemanager/conditions')
          this.conditionsList = data
        },
        handleRadio(e) {
          
        },
        handleSelect(e) {
          
        },
        handleCheckBox(bol) {
        
        },
        async update() {
          this.$Modal.confirm({
            title: '注意',
            content: '入力内容を保存します。よろしいですか？',
            okText: 'OK',
            cancelText: 'キャンセル',
            onOk: async () => {
              if(this.updateList.length === 0) {
                return this.$Notice.warning({ title: '注意', desc: '少なくとも一つの項目を変更しでください。', duration: 6.5 })
              }
              this.loading = true
              console.log(this.updateValue)
              const { data } = await this.http.post('sys/searchrangemanager/update', this.updateList)
              this.$Message.success('更新完了')
              this.getTableData()
              this.updateValue = {}
              this.updateList = []
            }
          })
        },
        joinUpdate() {
          this.tableData.some(e=> {
            if(e[this.updateValueIndex].hgpId ===this.updateValue.hgpId) {
              e[this.updateValueIndex] = this.updateValue
              this.updateList = this.updateList.concat(this.updateValue)
              return true
            }
          })
        },
        handleCellClick(row, column, data, event) {
          // 点到名字的第一列是也不要弹出操作浮层
          if (!this.isEditing ||  column.slot === 'objectName') {
            return
          }
          this.isShow = true
        },
        handleScroll: Throttle(function (e) {
          this.contentScrollTop = e.target.documentElement.scrollTop || e.target.body.scrollTop
        }, 50)
      }
    })
  </script>
</body>
</html>