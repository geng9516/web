<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='起動権限設定',cssPaths='/pages/content.min.css')">
</head>

<body>
  <div th:replace="layout/loadingBar::loadingBar"></div>
  <main class="content startregistersettings-warp">
    <div class="content_head">
      <div class="header">
        <div class="title1">
          <h1>
            <Icon type="i-emeer colored"></Icon>
            {{ `起動権限設定` }}
          </h1>
        </div>
        <div class="btnbox">
          <span style="flex:1"></span>
          <i-button type="primary" icon="md-create" size="large" @click="handleEdit(true)" v-if="!isEditing">編集
          </i-button>
          <i-button type="success" icon="md-done-all" size="large" @click="update" :loading="editLoading"
            v-if="isEditing">登録</i-button>
          <i-button type="primary" @click="handleEdit(false)" size="large" ghost v-if="isEditing">キャンセル</i-button>
          <i-button type="warning" icon="md-download" ghost size="large">Excel出力</i-button>
        </div>
      </div>
      <div class="searchwrap">
        <span class="label" @on-change="handleSystemChange">システム名</span>
        <i-select v-model="opts.systemId" class="mr15" style="width:200px">
          <i-option v-for="(item, i) of systemList" :key="i" :value="item.msCsystemidPk">{{ item.msCsystemname }}
          </i-option>
        </i-select>
        <span class="label">選択法人名</span>
        <i-select v-model="opts.companyId" class="mr15" @on-change="handleLegalPersonChange">
          <i-option value="0" label="全て"></i-option>
          <i-option v-for="(item, i) of legalPersonList" :key="i" :value="item.macCcompanyidCk">
            {{ item.macCcompanyname }}</i-option>
        </i-select>
        <span class="label">選択グループ名</span>
        <i-select v-model="opts.groupId">
          <i-option value="0" label="全グループ表示"></i-option>
          <i-option v-for="(item, i) of groupList" :key="i" :value="item.mgCgroupidPk">{{ item.mgCgroupdescription }}
          </i-option>
        </i-select>
      </div>
    </div>
    <div class="content_body">
      <div class="table-top">
        <Row :gutter="16">
          <i-col span="4">
            <i-button type="text" class="blue" :loading="loading">
              <Icon type="ios-arrow-back"></Icon>
              <span class="ml5">{{beforeDate}} 改定分</span>
            </i-button>
          </i-col>
          <i-col span="20" class="tr">
            選択サイト名：
            <i-select v-model="opts.siteId" class="mr15" style="width:260px" @on-change="handSiteChange" transfer>
              <i-option value="0" label="全サイト表示"></i-option>
              <i-option v-for="(item, i) of siteList" :key="i" :value="item.mtrCsiteid">{{ item.mtrCobjname }}
              </i-option>
            </i-select>
            選択アプリケーション名：
            <i-select v-model="opts.appId" class="mr15" style="width:260px" transfer>
              <i-option value="0" label="全アプリケーション"></i-option>
              <i-option v-for="(item, i) of appList" :key="i" :value="item.mtrCappid">{{ item.mtrCobjname }}</i-option>
            </i-select>
            今回改定日：
            <date-picker type="date" v-model="curDate" format="yyyy/MM/dd" @on-change="handleDatePicker" transfer
              clearable editable />
          </i-col>
        </Row>
      </div>
      <i-table border v-show="isEditing" class="no-padding" :columns="columns" :disabled-hover="true" :data="tableDataForAction" :loading="loading"
        @on-cell-click="handleCellClickForAction">

        <template slot-scope="{ row }" slot="objectName">
          <span></span>
        </template>


        <template slot-scope="{ row }" slot="action">
          <span></span>
        </template>

        <!-- 循环slotList -->
        <template v-for="item of slotList" slot-scope="{ row }" :slot="item">
          <i-button type="success" ghost size="small" icon="ios-arrow-down" long>
          </i-button>
        </template>
      </i-table>

      <i-table border :show-header="!isEditing" class="no-padding mt10" :columns="columns" :disabled-hover="true" :data="tableData" :loading="loading"
        @on-cell-click="handleCellClick" ref="table">
        <!-- type: "0" トップページ   <Icon type="md-compass" />
        type: "1" サイト   <Icon type="md-compass" />
        type: "3" アプリケーション ml10 <Icon type="md-desktop" />
        type: "4" サブアプリケーション <Icon type="md-easel" />
        type: "2" ダイアログアプリケーション ml10 <Icon type="ios-photos" />
        type: "5" 画面 ml20  <Icon type="md-browsers" />
        type: "6" 機能ボタン ml30 <Icon type="md-disc" /> -->

        <template slot-scope="{ row }" slot="objectName">
          <span v-if="row.type === '0'" class="mr10 mt5 mb5 pt2 pb2 pl10 pr10 row-label-primary">
            <Icon type="md-cloud" class="mr5"></Icon>{{row.objectName}}
          </span>
          <span v-if="row.type === '1'" class="mr10 mt5 mb5 pt2 pb2 pl10 pr10 row-label-primary">
            <Icon type="md-compass" class="mr5"></Icon>{{row.objectName}}
          </span>
          <span v-if="row.type === '2'" class="mr10 mt5 mb5 ml20 pt2 pb2 pl10 pr10 row-label-primary">
            <Icon type="ios-photos" class="mr5"></Icon>{{row.objectName}}
          </span>
          <span v-if="row.type === '3'" class="mr10 mt5 mb5 ml20 pt2 pb2 pl10 pr10 row-label-primary">
            <Icon type="md-desktop" class="mr5"></Icon>{{row.objectName}}
          </span>
          <span v-if="row.type === '4'" class="mr10 mt5 mb5 ml20 pt2 pb2 pl10 pr10 row-label-primary">
            <Icon type="md-easel" class="mr5"></Icon>{{row.objectName}}
          </span>
          <span v-if="row.type === '5'" class="mr10 mt5 mb5 pt2 pb2 pl10 pr10 row-label-primary"
            style="margin-left: 40px;">
            <Icon type="md-browsers" class="mr5"></Icon>{{row.objectName}}
          </span>
          <span v-if="row.type === '6'" class="mr10 mt5 mb5 pt2 pb2 pl10 pr10 row-label-primary"
            style="margin-left: 60px;">
            <Icon type="md-disc" class="mr5"></Icon>{{row.objectName}}
          </span>
        </template>


        <template slot-scope="{ row }" slot="action">
          <i-button type="success" ghost size="small" icon="ios-arrow-forward" long></i-button>
        </template>

        <!-- 循环slotList -->
        <template v-for="item of slotList" slot-scope="{ row }" :slot="item">
          <!-- <i-button type="success" ghost size="small" icon="ios-arrow-down" long v-show="row._index === 0 && isEditing">
          </i-button> -->
          <span :class="row[item].permission === '1' ? 'blue' : row[item].permission === '2' ? 'red': ''">{{ row[item].permission === '1' ? '〇' : row[item].permission === '2' ? '✖' : '　' }}</span>
        </template>
      </i-table>
      <div class="ivu-pop-popper" :style="poptipStyle" x-placement="right-start">
        <div class="ivu-poptip-content">
          <div class="ivu-poptip-arrow"></div>
          <div class="ivu-poptip-inner">
            <div class="ivu-poptip-title">
              <div class="ivu-poptip-title-inner">権限編集</div>
            </div>
            <div class="ivu-poptip-body">
              <div class="ivu-poptip-body-content">
                <div class="ivu-poptip-body-content-inner">
                  <i-button type="primary" style="display:block" @click="cellClickAction('0')" size="small" class="mb5"
                    ghost long>設定なし</i-button>
                  <i-button type="success" @click="cellClickAction('1')" style="display:block" size="small" class="mb5"
                    ghost long>〇 許可</i-button>
                  <i-button type="error" @click="cellClickAction('2')" style="display:block" size="small" class="mb5"
                    ghost long>✖ 拒否</i-button>
                  <i-button type="primary" @click="cellClickAction('4')" style="display:block" size="small" class="mb5"
                    ghost long>キャンセル</i-button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <div th:replace="layout/script::common_script"></div>
  <script type="text/babel" th:inline="javascript">
    const START_REGISTER_SETTINGS = new Vue({
      el: '.startregistersettings-warp',
      data() {
        return {
          // 预设最多20个权限
          slotList: Utils.getNumArray(1, 20).map(e => `m${e}`),
          radioType: 0,
          loading: false,
          editLoading: false,
          isEditing: false,
          beforeDate: '',
          needChange: '',
          legalPersonList: [],
          poptipStyle: {
            display: 'none',
            position: 'absolute',
            'will-change': 'top, left',
            'z-index': '5',
            left: '0',
            top: '0'
          },
          beforeClickedCell: {},
          clickedCell: {},
          updateValue: [],
          systemList: [],
          siteList: [],
          appList: [],
          groupList: [],
          tableHead: [],
          curDate: new Date(),
          opts: {
            systemId: '01',
            appId: '0',
            siteId: '0',
            companyId: '0',
            date: '',
            groupId: '0',
            isAll: false,
          },
          tableData: [],
          tableDataForAction: []
        }
      },
      async created() {
        this.getSystemList()
        this.getSiteList()
        this.getAppList()
        await this.getLegalPersonList()
        this.getGroupList()
        this.getTableData()
      },
      computed: {
        columns() {
          let result = [{
            title: 'アプリケーション名',
            minWidth: 200,
            slot: 'objectName',
            tree: true
          }]
          if (this.isEditing) {
            result = result.concat({
              title: '操作',
              width: 45,
              slot: 'action',
              align: 'center'
            })
          }
          this.tableHead.forEach((e, i) => {
            result = result.concat({
              title: e.mgCgroupdescription || ' ',
              slot: `m${i + 1}`,
              align: 'center'
            })
          })
          return result
        },

      },
      methods: {
        async getLegalPersonList() {
          const { data } = await this.http.get('sys/groupappmanager/companies')
          this.legalPersonList = data
          this.opts.companyId = data[0].macCcompanyidCk

        },
        async getSystemList() {
          const { data } = await this.http.get('sys/groupappmanager/systems')
          this.systemList = data
        },
        async getSiteList() {
          // 选择系统时，site要跟着变
          const { data } = await this.http.get('sys/groupappmanager/sites', this.opts)
          this.siteList = data
        },
        async getAppList() {
          // 选择サイト时，アプリケーション要跟着变,且每次切换都将app重置
          const OPTS = { ...this.opts }
          if (this.opts.siteId === '0') {
            delete OPTS.siteId
          }
          const { data } = await this.http.get('sys/groupappmanager/apps', OPTS)
          this.appList = data

        },
        async getGroupList() {
          // 选择法人时，グループ要跟着变
          const OPTS = { ...this.opts }
          OPTS.searchDate = this.opts.date

          if (this.opts.companyId === '0') {
            delete OPTS.companyId
          }
          const { data } = await this.http.postForm('sys/groupappmanager/groups', OPTS)
          this.groupList = data

        },
        async getTableData() {
          const OPTS = { ...this.opts }
          Object.keys(OPTS).forEach(key => {
            if (OPTS[key] === '0') {
              delete OPTS[key]
            }
          })
          this.loading = true
          try {
            const { data } = await this.http.postForm('sys/groupappmanager', OPTS)
            this.beforeDate = data.beforeDate
            this.tableHead = data.tableHeader
            this.tableData = data.tableBody.map((e, i) => {
              let result = {}
              e.list.forEach((n, j) => {
                result[`m${j + 1}`] = {
                  rowIndex: i,
                  colIndex: j,
                  permission: n.permission
                }
              })
              result.type = e.type
              result.objectName = e.objectName

              return result
            })
            this.tableDataForAction = this.tableData.slice(0,1)
            console.log(this.tableData)
            // [{
            //   m0: { rowIndex: 0, colIndex: 1, permission: '0' },
            //   m1: { rowIndex: 0, colIndex: 2, permission: '0' },
            //   m2: { rowIndex: 0, colIndex: 3, permission: '0' },
            //   m3: { rowIndex: 0, colIndex: 4, permission: '0' },
            //   m4: { rowIndex: 0, colIndex: 5, permission: '0' },
            //   type: '2',
            //   objectName: '代替ログイン'
            // },
            //   {
            //     m0: { rowIndex: 1, colIndex: 1, permission: '0' },
            //     m1: { rowIndex: 1, colIndex: 2, permission: '0' },
            //     m2: { rowIndex: 1, colIndex: 3, permission: '0' },
            //     m3: { rowIndex: 1, colIndex: 4, permission: '0' },
            //     m4: { rowIndex: 1, colIndex: 5, permission: '0' },
            //     type: '5',
            //     objectName: '代替ログイン'
            //   }]
          } catch (error) {

          } finally {
            this.loading = false
          }
        },
        async update() {
          let OPTS = {permList:[...new Set(this.updateValue)]}
          if(this.opts.date) {
            OPTS.changeDate = this.opts.date
          }
          // console.log(OPTS.permList)
          const { data } = await this.http.post('sys/groupappmanager/update',OPTS)
          this.isEditing = false
          this.getTableData()
        },
        handleCellClick(row, column, data, event) {
          // 点到名字的第一列是也不要弹出操作浮层
          if (!this.isEditing || column.slot === 'objectName') {
            return
          }
          // 开始复原
          this.needChange = ''
          console.log(row)
          console.log(column)
          this.clickedCell = row
          // 点到了右箭头按钮，需要将整行变了
          if (column.slot === 'action') {
            this.needChange = 'row'
          } else {
            // 复原所选项为此格
            this.clickedCell = row[column.slot]
          }
          this.changeCellStyle(event)
        },
        handleCellClickForAction(row, column, data, event) {
          // 点到名字的第一列是也不要弹出操作浮层
          if (!this.isEditing || column.slot === 'objectName') {
            return
          }
          // 点到了下箭头，需要将整列变了,needchange为列名
          this.needChange = column.slot
          this.changeCellStyle(event)
        },
        changeCellStyle(e) {
          if (this.beforeClickedCell.style) {
            this.beforeClickedCell.style.backgroundColor = ''
          }
          this.beforeClickedCell = e.target.offsetParent
          this.beforeClickedCell.style.backgroundColor = 'rgb(233, 243, 255)'
          this.poptipStyle.display = 'block'
          this.poptipStyle.left = `${e.pageX}px`
          this.poptipStyle.top = `${e.pageY}px`
        },
        cellClickAction(e) {
          if (e !== '4') {
            if (!this.needChange) {
              this.clickedCell.permission = e
              this.updateValue = this.updateValue.concat(this.clickedCell)
            }
            // 点到了右箭头按钮，需要将整行变了
            if (this.needChange === 'row') {
              Object.keys(this.clickedCell).forEach(key=>{
                if (this.clickedCell[key] instanceof Object) {
                  this.clickedCell[key].permission = e
                  this.updateValue = this.updateValue.concat(this.clickedCell[key])
                }
              })
            }
            // 点到了下箭头，需要将整列变了,needchange为列名
            if (this.needChange.indexOf('m') > -1) {
              this.$refs.table.data.forEach((n,i) => {
                n[this.needChange].permission = e
                this.updateValue = this.updateValue.concat(n[this.needChange])
              })
            }
          }
          this.poptipStyle.display = 'none'
        },
        handleEdit(flag) {
          this.isEditing = flag
          // if(!this.flag) {
          //   history.go(0)
          // }
          // if (flag) {
          //   this.$refs.table.data.unshift({})
          // } else {
          //   this.$refs.table.data.shift({})
          // }
        },
        handleSystemChange() {
          this.getSiteList()
        },
        handleLegalPersonChange(e) {
          if (e === '0') {
            // 法人全部的时候，需要将isAll设为true, 还要将法人id置空
            this.opts.isAll = true
          } else {
            this.opts.isAll = false
          }
          this.getGroupList()
          this.getTableData()
        },
        handSiteChange() {
          // 选择site名时，要把app的重置为第一项
          this.getAppList()

          this.opts.appId = '0'
          this.getTableData()
        },
        handleDatePicker(e) {
          this.opts.date = e
        }
      }
    })
  </script>
</body>

</html>