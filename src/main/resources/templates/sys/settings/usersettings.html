<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='ユーザ管理',cssPaths='/pages/content.min.css')">
</head>
<style>
    .ivu-radio-wrapper {
        font-size: 16px;
    }
</style>
<body>
    <div th:replace="layout/loadingBar::loadingBar"></div>
    <!-- 菜单导航栏 -->
    <div th:replace="layout/sider"></div>
    <main class="content usersettings-warp" ref="layout">
        <div class="content_head">
          <div class="header">
            <div class="title1">
              <h1>
                <Icon type="i-emeer colored"></Icon>
                ユーザ管理
              </h1>
            </div>
            <div class="btnbox">
                <span style="flex:1"></span>
              <i-button type="primary" icon="md-create" :loading="loading">パスワード変更</i-button>
              <i-button type="success" icon="md-create" :loading="loading">利用開始</i-button>
              <i-button type="error" icon="md-create" :loading="loading">利用終了</i-button>
              <i-button type="primary" icon="md-create" :loading="loading">ロックアウト解除</i-button>
              <i-button type="primary" ghost icon="md-create" :loading="loading">パスワードポリシー設定へ</i-button>
            </div>
          </div>
          <div class="searchwrap">
            <span class="label">選択法人名</span>
            <i-select v-model="opts.companyId" class="mr15" style="width: 350px;">
              <i-option value="0" label="全て"></i-option>
              <i-option v-for="(item, i) of legalPersonList" :key="i" :value="item.macCcompanyidCk">
                {{ item.macCcompanyname }}</i-option>
            </i-select>
            <i-button type="primary" ghost icon="md-search" :loading="loading" @click="getTableData">検索</i-button>
          </div>
          <radio-group v-model="opts.searchType">
            <Radio :label="1">全て</Radio>
            <Radio :label="2">ロックアウトされているユーザ</Radio>
            <Radio :label="3">現在有効なユーザ</Radio>
            <Radio :label="4">入社前</Radio>
            <Radio :label="5">入社後未登録</Radio>
            <Radio :label="6">退職後未削除</Radio>
            <Radio :label="10">管理ツールユーザ</Radio>
            <br></br>
            <Radio :label="7"><span class="pr5">社員番号検索</span><i-input style="width: 200px;"></i-input></Radio>
            <Radio :label="9"><span class="pr5">氏名検索</span><i-input style="width: 200px;"></i-input></Radio>
            <Radio :label="8"><span class="pr15">部署検索</span><i-button type="primary" ghost>参照</i-button></Radio>
         </radio-group>
        </div>
        <div class="content_body">
          <div class="table-top">
              <div class="tr">
                <Page :total="pageValue.amount" :current="pageValue.curPage" style="display: inline"
                :page-size="pageValue.curSize" @on-change="pageChange" ref="Page" simple/>
              </div>
          </div>
          <i-table border :class="tableHeadFixed ? 'table-head-fixed' : ''" :row-class-name="() => 'select-col'"
            :columns="columns" :disabled-hover="true" :data="tableData" :loading="loading" no-data-text=""
            ref="table">
            <template slot-scope="{ row }" slot="start">{{ Utils.formatDate(row.maDstart, 'yyyy/mm/dd') }}
            </template>

            <template slot-scope="{ row }" slot="end">{{ row.maDend === 7983759600000 ? '' : Utils.formatDate(row.maDend, 'yyyy/mm/dd') }}
            </template>
          </i-table>
        </div>
        <back-top></back-top>
      </main>
    <div th:replace="layout/head::header"></div>
    <script type="text/babel" th:inline="javascript">
        const USER_SETTINGS = new Vue({
          el: '.usersettings-warp',
          data() {
            return {
              isShow: false,
              loading: true,
              needChange: '',
              legalPersonList: [],
              opts: {
                sectionCompanyId: '01',
                companyId:'0',
                siteId: '0',
                sectionId: '0',
                page:'1',
                searchType:2,
                limit:'50',
              },
              pageValue: {
                amount: 0,
                curPage: 1,
                curSize: 50
              },
              columns:[
                  {
                      title:'現在の状態',
                      key:'status',
                      align:'center'
                  },
                  {
                      title:'社員番号',
                      key:'meCuserid',
                      align:'center'
                  },
                  {
                      title:'氏名',
                      key:'meCname',
                      align:'center'
                  },
                  {
                      title:'アカウント',
                      key:'maCaccount',
                      align:'center'
                  },
                  {
                      title:'利用開始日',
                      slot:'start',
                      align:'center'
                  },
                  {
                      title:'利用終了日',
                      slot:'end',
                      align:'center'
                  },
                  {
                      type:'selection',
                      width:'50',
                      align:'center'
                  }
              ],
              tableData: [],
              contentScrollTop: 0
            }
          },
          created() {
            this.getLegalPersonList()
            this.getTableData()
            window.addEventListener('scroll',this.handleScroll,{ passive: true })
          },
            beforeDestroy() {
                window.removeEventListener('scroll',this.handleScroll,{ passive: true })
          },
          computed: {
            tableHeadFixed() {
              if (this.contentScrollTop > 220) return true
              else return false
            }
          },
          methods: {
            async getLegalPersonList() {
                let OPTS = {
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp')
                }
                const { data } = await this.http.get('sys/groupappmanager/companies', OPTS)
                this.legalPersonList = data
                this.opts.companyId = data[0] && data[0].macCcompanyidCk

            },
            async getTableData() {
              const OPTS = { ...this.opts }
              OPTS.psSite = Utils.getUrlParam(location.href, 'psSite')
              OPTS.psApp = Utils.getUrlParam(location.href,'psApp')
              Object.keys(OPTS).forEach(key => {
                if (OPTS[key] === '0') {
                  delete OPTS[key]
                }
              })
              this.loading = true
              try {
                const { data } = await this.http.get('sys/usermanager/search', OPTS)
                this.tableData = data.list
                this.pageValue.amount = data.totalCount
              } catch (error) {
              } finally {
                this.loading = false
              }
            },
            // async getConditionsList() {
            //   const { data } = await this.http.get('sys/searchrangemanager/conditions')
            //   this.conditionsList = data
            // },
            // async update() {
            //   this.$Modal.confirm({
            //     title: '注意',
            //     content: '入力内容を保存します。よろしいですか？',
            //     okText: 'OK',
            //     cancelText: 'キャンセル',
            //     onOk: async () => {
            //       this.loading = true
            //       this.isEditing = false,
            //       console.log(this.updateValue)
            //       const { data } = await this.http.post('sys/searchrangemanager/update', this.updateList)
            //       this.$Message.success('更新完了')
            //       this.getTableData()
            //       this.updateValue = {}
            //       this.updateList = []
            //     }
            //   })
            // },
            pageChange(e) {
              this.opts.page = e
              this.pageValue.curPage = e
              this.getTableData()
            },
            handleScroll: Throttle(function (e) {
              this.contentScrollTop = e.target.documentElement.scrollTop || e.target.body.scrollTop
            }, 50)
          }
        })
      </script>
</body>
</html>