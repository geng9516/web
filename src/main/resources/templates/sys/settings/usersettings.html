<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='ユーザ管理',cssPaths='/pages/content.min.css')">
</head>
<style>
  .ivu-radio-wrapper {
    font-size: 16px;
  }
</style>

<body>
  <div th:replace="layout/loadingBar::loadingBar"></div>
  <!-- 菜单导航栏 -->
  <div th:replace="layout/sider"></div>
  <main class="content usersettings-warp" ref="layout">
    <div class="content_head">
      <div class="header">
        <div class="title1">
          <h1>
            <Icon type="i-emeer colored"></Icon>
            ユーザ管理
          </h1>
        </div>
        <div class="btnbox">
          <span style="flex:1"></span>
          <i-button type="primary" icon="md-create" :loading="loading">パスワード変更</i-button>
          <i-button type="success" icon="md-checkmark" :loading="loading">利用開始</i-button>
          <i-button type="error" icon="md-close" :loading="loading">利用終了</i-button>
          <i-button type="primary" icon="md-unlock" @click="cancelLock" :loading="loading">ロックアウト解除</i-button>
          <i-button type="primary" ghost icon="md-create" :loading="loading">パスワードポリシー設定へ</i-button>
        </div>
      </div>
      <div class="searchwrap">
        <span class="label">選択法人名</span>
        <i-select v-model="opts.companyId" class="mr15" style="width: 350px;">
          <i-option value="0" label="全て"></i-option>
          <i-option v-for="(item, i) of legalPersonList" :key="i" :value="item.macCcompanyidCk">
            {{ item.macCcompanyname }}</i-option>
        </i-select>
        <i-button type="primary" ghost icon="md-search" :loading="loading" @click="getTableData">検索</i-button>
      </div>
      <radio-group v-model="opts.searchType">
        <Radio :label="1">全て</Radio>
        <Radio :label="2">ロックアウトされているユーザ</Radio>
        <Radio :label="3">現在有効なユーザ</Radio>
        <Radio :label="4">入社前</Radio>
        <Radio :label="5">入社後未登録</Radio>
        <Radio :label="6">退職後未削除</Radio>
        <Radio :label="10">管理ツールユーザ</Radio>
        <br></br>
        <Radio :label="7"><span class="pr5">社員番号検索</span>
          <i-input v-model="opts.empId" style="width: 200px;"></i-input>
        </Radio>
        <Radio :label="9"><span class="pr5">氏名検索</span>
          <i-input v-model="opts.empName" style="width: 200px;"></i-input>
        </Radio>
        <Radio :label="8">
          <!-- 共通組織図画面 start-->
          <span>部署検索</span>
          <span class="input-like-span tc" style="color: var(--dept-select); border: 1px dashed var(--dept-select);width:400px;vertical-align: inherit; height: 30px;">
            <Tooltip @click.native="deptDrawShow = true" trigger="hover" :theme="toolTipTheme()" transfer>{{deptName}}
              <div slot="content">{{deptName}}</div>
            </Tooltip>
          </span>

          <Drawer class="tc" placement="right" width="700" v-model="deptDrawShow">
            <div class="titlenorm mb5">
              <Icon type="logo-buffer"></Icon>
              所属
            </div>
            <Row class="tl mb5">
              <!-- <i-col span="4" class="label tc" style="height: 32px;">基準日</i-col>
                <i-col span="7" class="no-border-radius">
                  <date-picker type="date" :value="referListObject.txtTmgReferListTreeViewRecordDate" transfer
                    :options="startLimit" placeholder="基準日" format="yyyy/MM/dd" ref="datePicker" :clearable="false"
                    @on-change="handleDeptDateChange"></date-picker>
                </i-col> -->
            </Row>
            <div style="position: relative;">
              <Tree class="tree mt2" :data="treeData" v-on:on-select-change="handleClickLeaf" ref="tree"
                empty-text="所属データなし"></Tree>
              <Spin size="large" fix v-if="empDeptLoading"></Spin>
            </div>
          </Drawer>
          <!-- 共通組織図画面 end-->
        </Radio>
      </radio-group>
    </div>
    <div class="content_body">
      <div class="table-top">
        <div class="tr">
          <Page :total="pageValue.amount" :current="pageValue.curPage" style="display: inline"
            :page-size="pageValue.curSize" @on-change="pageChange" ref="Page" simple />
        </div>
      </div>
      <i-table border :class="tableHeadFixed ? 'table-head-fixed' : ''" :row-class-name="rowClassName"
        :columns="columns" :disabled-hover="true" :data="tableData" :loading="loading" no-data-text="" ref="table">
        <template slot-scope="{ row }" slot="start">{{ Utils.formatDate(row.maDstart, 'yyyy/mm/dd') }}
        </template>

        <template slot-scope="{ row }"
          slot="end">{{ row.maDend === 7983759600000 ? '' : Utils.formatDate(row.maDend, 'yyyy/mm/dd') }}
        </template>
      </i-table>
    </div>
    <back-top></back-top>
  </main>
  <div th:replace="layout/head::header"></div>
  <script type="text/babel" th:inline="javascript">
    const USER_SETTINGS = new Vue({
      el: '.usersettings-warp',
      data() {
        return {
          isShow: false,
          loading: true,
          needChange: '',
          legalPersonList: [],
          opts: {
            sectionCompanyId: '01',
            companyId: '0',
            siteId: '0',
            sectionId: '',
            page: '1',
            searchType: 2,
            limit: '50',
          },
          pageValue: {
            amount: 0,
            curPage: 1,
            curSize: 50
          },
          columns: [
            {
              title: '現在の状態',
              key: 'status',
              align: 'center'
            },
            {
              title: '社員番号',
              key: 'meCuserid',
              align: 'center'
            },
            {
              title: '氏名',
              key: 'meCname',
              align: 'center'
            },
            {
              title: 'アカウント',
              key: 'maCaccount',
              align: 'center'
            },
            {
              title: '利用開始日',
              slot: 'start',
              align: 'center'
            },
            {
              title: '利用終了日',
              slot: 'end',
              align: 'center'
            },
            {
              type: 'selection',
              width: '50',
              align: 'center'
            }
          ],
          tableData: [],
          treeData: [],
          deptDrawShow: false,
          deptName: '参照',
          contentScrollTop: 0
        }
      },
      created() {
        this.getOrgTree()
        this.getLegalPersonList()
        this.getTableData()
        window.addEventListener('scroll', this.handleScroll, { passive: true })
      },
      beforeDestroy() {
        window.removeEventListener('scroll', this.handleScroll, { passive: true })
      },
      computed: {
        tableHeadFixed() {
          if (this.contentScrollTop > 220) return true
          else return false
        }
      },
      methods: {
        async getOrgTree() {
          this.empDeptLoading = true
          try {
            const { data } = await this.http.get('sys/tree/orgs?psSite=Admin')
            this.treeData = this.convertTreeData(data)
          } catch (error) {
            return
          } finally {
            this.loading = false
            this.empDeptLoading = false
          }
        },
        async getLegalPersonList() {
          let OPTS = {
            psSite: Utils.getUrlParam(location.href, 'psSite'),
            psApp: Utils.getUrlParam(location.href, 'psApp')
          }
          const { data } = await this.http.get('sys/groupappmanager/companies', OPTS)
          this.legalPersonList = data
          this.opts.companyId = data[0] && data[0].macCcompanyidCk

        },
        getTableData:Debounce(async function() {
          if(this.opts.searchType === 7 && !this.opts.empId) {
            return this.$Notice.warning({ title: '注意', desc: '氏名条件を入力してください。', duration: 6.5 })
          }
          if(this.opts.searchType === 8 && !this.opts.sectionId) {
            return this.$Notice.warning({ title: '注意', desc: '部署を選択してください。', duration: 6.5 })
          }
          if(this.opts.searchType === 9 && !this.opts.empName) {
            return this.$Notice.warning({ title: '注意', desc: '氏名条件を入力してください。', duration: 6.5 })
          }
          const OPTS = { ...this.opts }
          OPTS.psSite = Utils.getUrlParam(location.href, 'psSite')
          OPTS.psApp = Utils.getUrlParam(location.href, 'psApp')
          Object.keys(OPTS).forEach(key => {
            if (OPTS[key] === '0') {
              delete OPTS[key]
            }
          })
          this.loading = true
          try {
            const { data } = await this.http.get('sys/usermanager/search', OPTS)
            if (data.list.length === 0) {
              this.$Message.error({
                background: true,
                closable: true,
                duration: 6.5,
                content: '指定した条件に職員はありません。'
              })
            }
            this.tableData = data.list
            this.pageValue.amount = data.totalCount
          } catch (error) {
          } finally {
            this.loading = false
          }
        }),
        // async update() {
        //   this.$Modal.confirm({
        //     title: '注意',
        //     content: '入力内容を保存します。よろしいですか？',
        //     okText: 'OK',
        //     cancelText: 'キャンセル',
        //     onOk: async () => {
        //       this.loading = true
        //       this.isEditing = false,
        //       console.log(this.updateValue)
        //       const { data } = await this.http.post('sys/searchrangemanager/update', this.updateList)
        //       this.$Message.success('更新完了')
        //       this.getTableData()
        //       this.updateValue = {}
        //       this.updateList = []
        //     }
        //   })
        // },
        handleClickLeaf(e) {
          if(!e[0]) return
          this.deptName = e[0].sectionName
          this.opts.sectionId = e[0].sectionId
        },
        cancelLock:Debounce(async function() {
          const list = this.$refs.table.getSelection().map(e => e.maCuserid)
          if(list.length === 0) {
            return this.$Notice.warning({ title: '注意', desc: 'ロックアウト解除をするユーザを選択してください。', duration: 6.5 })
          }
          this.$Modal.confirm({
            title: '注意',
            content: '選択されたユーザのロックアウトを解除します。よろしいですか？',
            okText: 'OK',
            cancelText: 'キャンセル',
            onOk: async () => {
              this.loading = true
              const { data } = await this.http.post('sys/usermanager/unlock', list)
              this.$Message.success('ロックアウト解除完了')
              this.getTableData()
            }
          })
        }),
        pageChange(e) {
          this.opts.page = e
          this.pageValue.curPage = e
          this.getTableData()
        },
        rowClassName(row, index) {
          if (row.status) {
            return 'highlight select-col'
          } else {
            return 'select-col'
          }
        },
        convertTreeData(treeData, fristDisable) {
          if (!treeData) {
            this.$Message.error({
              background: true,
              closable: true,
              duration: 6.5,
              content: '参照できる組織図が存在しません。'
            });
            return []
          }
          return treeData.map((e, i) => {
            if (e.children) {
              return {
                ...e,
                title: e.sectionName,
                children: this.convertTreeData(e.children)
              }
            } else {
              return {
                ...e,
                title: e.sectionName
              }
            }
          })
        },
        handleScroll: Throttle(function (e) {
          this.contentScrollTop = e.target.documentElement.scrollTop || e.target.body.scrollTop
        }, 50)
      }
    })
  </script>
</body>

</html>