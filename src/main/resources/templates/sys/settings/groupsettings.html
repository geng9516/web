<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='グループ定義',cssPaths='/pages/content.min.css')">
</head>
<body>
  <div th:replace="layout/loadingBar::loadingBar"></div>
  <main class="content groupsettings-warp">
    <div class="content_head">
      <div class="header">
        <div class="title1">
          <h1>
            <Icon type="i-emeer colored"></Icon>
            {{ `グループ定義 ` }}
          </h1>
        </div>
        <div class="btnbox">
          <span style="flex:1"></span>
          今回改定日：
          <date-picker type="date" v-model="curDate" :options="rangeOptions" class="mt5 ml5" size="large"
            format="yyyy/MM/dd" @on-change="handleDatePicker" transfer clearable editable :disabled="loading">
          </date-picker>
          <i-button type="primary" icon="md-create" size="large" @click="isEditing = true" v-if="!isEditing"
            :loading="loading">編集
          </i-button>
          <i-button type="success" icon="md-done-all" size="large" @click="update" :loading="editLoading"
            v-if="isEditing">登録</i-button>
          <i-button type="primary" @click="handleCancel" size="large" ghost v-if="isEditing">キャンセル</i-button>
        </div>
      </div>
      <div class="searchwrap">
        <span class="label" @on-change="handleSystemChange">システム名</span>
        <i-select v-model="opts.systemId" class="mr15" style="width:200px">
          <i-option v-for="(item, i) of systemList" :key="i" :value="item.msCsystemidPk">{{ item.msCsystemname }}
          </i-option>
        </i-select>
      </div>
    </div>
    <div class="content_body">
      <div class="table-top">
        <Row :gutter="16">
          <i-col span="4">
            <i-button type="text" class="blue" :loading="loading" @click="getPreData">
              <Icon type="ios-arrow-back"></Icon>
              <span class="ml5">{{beforeDate}} 改定分</span>
            </i-button>
          </i-col>
        </Row>
      </div>
      <div class="titlenorm mb10 mt10" style="font-size:15px">
        <Icon type="logo-buffer"></Icon>
        有効なグループ
      </div>
      <i-table border :class="tableHeadFixed ? 'table-head-fixed mb10' : 'mb10'" :columns="columns" :disabled-hover="true"
        :data="tableData" :loading="loading">

        <template slot-scope="{ row }" slot="objectName">
          <span></span>
        </template>


        <template slot-scope="{ row }" slot="action">
          <span></span>
        </template>

        <!-- 循环slotList -->
        <!-- <template v-for="item of slotList" slot-scope="{ row }" :slot="item">
          <i-button type="success" ghost size="small" icon="ios-arrow-down" long>
            &nbsp;
          </i-button>
        </template> -->
      </i-table>
      <div class="titlenorm mb10 mt10" style="font-size:15px">
        <Icon type="logo-buffer"></Icon>
        現在使われていないグループ
      </div>
    </div>
  </main>
  <div th:replace="layout/script::common_script"></div>
  <script type="text/babel" th:inline="javascript">
    const GROUP_SETTINGS = new Vue({
      el: '.groupsettings-warp',
      data() {
        return {
          loading: true,
          editLoading: false,
          isEditing: false,
          beforeDate: '',
          updateValue: [],
          systemList: [],
          curDate: new Date(),
          opts: {
            systemId: '01',
            appId: '0',
            siteId: '0',
            companyId: '0',
            date: '',
            groupId: '0',
            isAll: false,
          },
          columns:[{
            title: 'ID',
            width: 150,
          },
          {
            title: '名称',
          },
          {
            title: '法人',
          },
          {
            title: '削除',
            width: 100,
          },
          {
            title: '順序',
            width: 150,
          }
         ],
          tableData: [{}],
          limitDate: '',
          rangeOptions: {
            disabledDate: date => {
              return date.valueOf() < new Date(this.limitDate).getTime()
            }
          },
          contentScrollTop: 0,
        //   isScroll: false
        }
      },
      async created() {
        this.getSystemList()
        // this.getTableData()
      },
      computed: {
        tableHeadFixed() {
          if (this.contentScrollTop > 220) return true
          else return false
        },
      },
      methods: {
        async getSystemList() {
          const { data } = await this.http.get('sys/groupappmanager/systems')
          this.systemList = data
        },
        async getTableData() {
          const OPTS = { ...this.opts }
          Object.keys(OPTS).forEach(key => {
            if (OPTS[key] === '0') {
              delete OPTS[key]
            }
          })
          this.loading = true
          try {
            const { data } = await this.http.postForm('sys/groupappmanager', OPTS)
            this.beforeDate = data.beforeDate
            this.limitDate = data.latestDate
            this.tableData = data.tableBody
          } catch (error) {

          } finally {
            this.loading = false
          }
        },
        async update() {
          this.loading = true
          let OPTS = { permList: [...new Set(this.updateValue)] }
          if (this.opts.date) {
            OPTS.changeDate = this.opts.date
          }
          const { data } = await this.http.post('sys/groupappmanager/update', OPTS)
          this.isEditing = false
          this.getTableData()
          this.updateValue = []
        },
        handleSystemChange() {
          this.getSiteList()
        },
        async handleDatePicker(e) {
          if (!e) return
          this.opts.date = e
          await this.getLegalPersonList()
          await this.getGroupList()
          this.getTableData()
        },
        getPreData() {
          this.opts.date = this.beforeDate
          this.getTableData()
        },
        handleCancel() {
          if(this.updateValue.length > 0) {
            history.go(0)
          } else {
            this.isEditing = false
          }
        }
      }
    })
  </script>
</body>
</html>