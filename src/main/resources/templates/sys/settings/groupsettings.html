<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='グループ定義',cssPaths='/pages/content.min.css')">
</head>

<body th:with="baseUrl = ${#httpServletRequest.getScheme() + '://' + #httpServletRequest.getServerName() + ':' + #request.getServerPort()  + #request.getContextPath()}">
  <div th:replace="layout/loadingBar::loadingBar"></div>
  <!-- 菜单导航栏 -->
  <div th:replace="layout/sider"></div>
  <main class="content groupsettings-warp">
    <div class="content_head">
      <div class="header">
        <div class="title1">
          <h1>
            <Icon type="i-emeer colored"></Icon>
            {{ `グループ定義 ` }}
          </h1>
        </div>
        <div class="btnbox">
          <span style="flex:1"></span>
          今回改定日：
          <date-picker type="date" v-model="curDate" :options="rangeOptions" class="ml5" format="yyyy/MM/dd"
            @on-change="handleDatePicker" transfer clearable editable :disabled="loading">
          </date-picker>
          <i-button type="success" icon="md-add" @click="add()" :loading="editLoading">新規</i-button>
        </div>
      </div>
      <div class="searchwrap">
        <span class="label" @on-change="handleSystemChange">システム名</span>
        <i-select v-model="opts.systemId" class="mr15" style="width:200px">
          <i-option v-for="(item, i) of systemList" :key="i" :value="item.msCsystemidPk">{{ item.msCsystemname }}
          </i-option>
        </i-select>
      </div>
    </div>
    <div class="content_body">
      <div class="table-top">
        <Row :gutter="16">
          <i-col span="4">
            <i-button type="text" class="blue" :loading="loading" @click="getPreData">
              <Icon type="ios-arrow-back"></Icon>
              <span class="ml5">{{beforeDate}} 改定分</span>
            </i-button>
          </i-col>
          <i-col span="20" class="tr">
            <span class="mr10">ドラッグ機能:  </span><i-switch v-model="isDraggable" size="large">
              <span slot="open">ON</span>
              <span slot="close">OFF</span>
            </i-switch>
            <i-button class="ml10" type="primary" icon="md-refresh" @click="sortingTableData" :loading="sortingLoading" :disabled="!hasDragTable">順序更新</i-button>
          </i-col>
        </Row>
      </div>
      <div class="titlenorm mb10 mt5" style="font-size:15px">
        <Icon type="logo-buffer"></Icon>
        有効なグループ
      </div>
      <i-table border class="mb10" :columns="columns" :data="tableData" :loading="loading" :draggable="isDraggable" @on-drag-drop="sortTableByDrag"
        :row-class-name="() => 'select-col'">
        <template slot-scope="{ row }" slot="date">
            <span class="ml15">{{ `${Utils.formatDate(row.mgDstartdate, 'yyyy/mm/dd')} ～ ${Utils.formatDate(row.mgDenddate, 'yyyy/mm/dd')}` }}</span>
        </template>

        <template slot-scope="{ row }" slot="mgCgroupidPk">
          <span class="mr10 pt2 pb2 pl10 pr10 cursor row-label-primary"
            @click="edit(row.mgCgroupidPk)">{{ row.mgCgroupidPk }}</span>
        </template>

        <template slot-scope="{ row }" slot="mgCgroupdescription">
          <span class="mr10 pt2 pb2 pl10 pr10 cursor row-label-primary"
            @click="edit(row.mgCgroupidPk)">{{ row.mgCgroupdescription }}</span>
        </template>

        <template slot-scope="{ row }" slot="del">
          <Poptip v-model="lightDelBtnVisible[row._index]" placement="left" transfer>
            <div class="operateBtn" slot="content">
              <a @click="cancel(row._index)">いいえ</a>
              <a @click="remove(row._index)">はい</a>
            </div>
            <i-button class="collapse-btn" type="error" ghost size="small" icon="md-trash" @click="deleteGroup(row.mgId)">削除</i-button>
          </Poptip>
        </template>
      </i-table>
      <div class="titlenorm mb10 mt10" style="font-size:15px">
        <Icon type="logo-buffer"></Icon>
        現在使われていないグループ
      </div>
      <!-- 該当条件編集画面 start-->
      <Drawer class="tc" placement="right" width="900" v-model="isShow" title="該当条件編集画面" :mask-closable="false">
        <div class="mb10 tr">
          <i-button type="primary" ghost @click="updateGroup()" icon="md-create" :loading="drawerBtnLoading" v-if="!isAdding">
            登録
          </i-button>
          <i-button type="success" ghost @click="updateGroup(true)" icon="md-add" :loading="drawerBtnLoading" v-if="isAdding">
            登録
          </i-button>
        </div>
        <div class="mt10 mb10">
          <div v-if="isAdding" class="mb5 no-border-radius" style="display: flex; align-items: stretch;">
            <span class="label tr" style="display: inline-block;width: 250px;margin-bottom: 1px;padding: 5px;">法人</span>
            <i-select v-model="groupInfoData[0].companyId" @on-change="handleChangeCompanyId">
              <i-option value="*" label="全社区分"></i-option>
              <i-option v-for="(item, i) of legalPersonList" :key="i" :value="item.macCcompanyidCk">
                {{ item.macCcompanyname }}</i-option>
            </i-select>
          </div>
          <div v-if="isAdding" class="mb5 no-border-radius" style="display: flex; align-items: stretch;">
            <span class="label tr" style="display: inline-block;width: 250px;margin-bottom: 1px;padding: 5px;">備考</span>
            <i-input class="tl" v-model="groupInfoData[0].mgCtext" :maxlength="100"></i-input>
          </div>
          <Row :gutter="10" v-if="!isAdding">
            <i-col span="12">
              <div class="label pl10">法人</div>
              <div class="person-info">{{ groupInfoData[0] && groupInfoData[0].companyName }}</div>
            </i-col>
            <i-col span="12">
              <div class="label pl10">備考</div>
              <div class="person-info">{{ groupInfoData[0] && groupInfoData[0].mgCtext }}</div>
            </i-col>
          </Row>
          <i-table class="mt10" border :row-class-name="()=>'select-col'" :columns="groupInfoColumns"
            :disabled-hover="true" :data="groupInfoData" :loading="loading" no-data-text="">
            <template slot-scope="{ row }" slot="date">
              <span v-if="!isAdding"> {{ `${Utils.formatDate(row.mgDstartdate, 'yyyy/mm/dd')} ～ ${Utils.formatDate(row.mgDenddate, 'yyyy/mm/dd')}` }}</span>
              <span v-if="isAdding"><date-picker v-model="groupInfoData[0].mgDstartdate" format="yyyy/MM/dd" type="date" transfer style="width:47.5%" placement="bottom-end"></date-picker>&nbsp;-&nbsp;<date-picker v-model="groupInfoData[0].mgDenddate" format="yyyy/MM/dd" type="date" transfer style="width:47.5%" placement="bottom-end"></date-picker></span>
            </span>
            </template>

            <template slot-scope="{ row }" slot="mgCgroupidPk">
              <span v-if="!isAdding"> {{ row.mgCgroupidPk }}</span>
              <i-input v-if="isAdding" v-model="groupInfoData[0].mgCgroupidPk" :maxlength="10"></i-input>
            </template>

            <template slot-scope="{ row }" slot="name">
              <i-input class="tl" v-model="groupInfoData[0].mgCgroupdescription" :maxlength="100"><span slot="prepend">日本語</span>
              </i-input>
            </template>

            <template slot-scope="{ row }" slot="count">
              <i-input class="tr" v-model="groupInfoData[0].mgNpartinentnumber" :maxlength="6" number><span slot="append">人</span></i-input>
            </template>
          </i-table>
          <!-- <div class="tl mt10">
          <radio-group class="tl" v-model="updateValue.baseFlag">
            <Radio label="0">社員選択による定義</Radio>
            <Radio label="1">条件式による定義</Radio>
            <Radio label="2">組織・役職選択による定義</Radio>
          </radio-group>
        </div> -->
          <Tabs class="mt10" :animated="false" v-model="updateValue.baseFlag" @on-click="poptipStyle.display = 'none'">
            <!-- 社員選択による定義 -->
            <tab-pane label="社員選択による定義 " name="0">
              <Row class="tl mb5" :gutter="8">
                <i-col span="10">
                  <i-input class="mar like-select" placeholder="社員の絞込み検索" v-model="searchEmpt"
                    @keyup.enter.native="handleSearchEmpt">
                  </i-input>
                </i-col>
                <i-col span="6" class="no-border-radius">
                  <i-button long type="primary" icon="md-search" ghost :loading="loading" @click="handleSearchEmpt()">
                    社員検索
                  </i-button>
                </i-col>
                <i-col span="6" class="no-border-radius">
                  <i-button long type="primary" icon="md-search" ghost :loading="loading"
                    @click="handleSearchEmpt(true)">所属一覧検索
                  </i-button>
                </i-col>
              </Row>

              <i-table class="mt10" border :row-class-name="()=>'select-col'" :columns="emptColumns"
                :disabled-hover="true" :data="emptData" :loading="loading" no-data-text="">
                <template slot-scope="{ row }" slot="action">
                  <Poptip v-model="lightDelBtnVisible2[row._index]" placement="left" transfer>
                    <div class="operateBtn" slot="content">
                      <a @click="cancelEmpt(row._index)">いいえ</a>
                      <a @click="removeEmpt(row, row._index)">はい</a>
                    </div>
                    <i-button type="error" ghost size="small" style="position: relative;left: 3px;width: 60px;">削除
                    </i-button>
                  </Poptip>
                </template>
              </i-table>
            </tab-pane>
            <!-- 条件式による定義 -->
            <tab-pane label="条件式による定義" name="1">
              <div class="tr mb5">
                <i-button type="error" icon="md-trash" ghost @click="conditionDeleteAll">全行を削除
                </i-button>
                <i-button type="success" icon="md-add" ghost @click="conditionAddTop">1行追加
                </i-button>
              </div>

              <i-table class="mt5 no-padding" border :row-class-name="()=>'select-col'" :columns="queryColumns"
                @on-cell-click="handleCellClickForAction" :disabled-hover="true" :data="queryData" no-data-text=""
                ref="table">
                <template slot-scope="{ row }" slot="andor">{{ queryData[row._index].andor || '　'  }}</template>

                <template slot-scope="{ row }"
                  slot="openedparenthsis">{{ queryData[row._index].openedparenthsis || '　' }}</template>

                <template slot-scope="{ row }"
                  slot="columnname">{{ queryData[row._index].columnname || '　' }}</template>

                <template slot-scope="{ row }" slot="operator">{{ queryData[row._index].operator || '　' }}</template>

                <template slot-scope="{ row }"
                  slot="displayvalue">{{ queryData[row._index].displayvalue || '　' }}</template>

                <template slot-scope="{ row }"
                  slot="closedparenthsis">{{ queryData[row._index].closedparenthsis || '　' }}</template>
                <template slot-scope="{ row }" slot="action">
                  <Poptip v-model="lightDelBtnVisible3[row._index]" placement="left" transfer>
                    <div class="operateBtn" slot="content">
                      <a @click="cancelconditionDelete(row._index)">いいえ</a>
                      <a @click="conditionDelete(row, row._index)">はい</a>
                    </div>
                    <i-button type="error" ghost size="small" style="width: 83px;text-align: left;">削除
                    </i-button>
                  </Poptip>
                  <i-button type="success" class="mt5" ghost icon="md-arrow-down" size="small"
                    @click="conditionAdd(row._index)" long>1行追加
                  </i-button>
                </template>
              </i-table>
            </tab-pane>
            <!-- 組織・役職選択による定義 -->
            <tab-pane label="組織・役職選択による定義" name="2">
              <div class="tl tree mt5">
                <i-button class="mt5" icon="md-trash" style="position:absolute; right: 35px;" type="error" ghost
                  size="small" @click="deleteSectionTree">選択行を削除</i-button>
                <Tree :data="sectionPostList" :render="renderTabTree" @on-select-change="" empty-text="" check-directly
                  show-checkbox ref="sectionTree"></Tree>

                <span class="row-label-primary pl10 pr10 mt10 mb10 cursor" @click="openBossTree()">＋
                  このグループに該当する所属長を追加</span>
                <checkbox-group v-model="bossListSelected" @on-change="" class="tl">
                  <Checkbox v-for="item of bossList" :key="item.uni_id" :label="item.uni_id" class="mb5"
                    style="display: block;">{{ item.title }}</Checkbox>
                </checkbox-group>

                <span class="row-label-primary pl10 pr10 mt10 mb10 cursor" @click="openPostTree()">＋
                  このグループに該当する役職を追加</span>
                <checkbox-group v-model="postListSelected" @on-change="" class="tl">
                  <Checkbox v-for="item of postList" :key="item.uni_id" :label="item.uni_id" class="mb5"
                    style="display: block;">{{ item.title }}</Checkbox>
                </checkbox-group>
              </div>
            </tab-pane>
          </Tabs>
          <div class="titlenorm mb5">
            <Icon type="logo-buffer"></Icon>
            基点組織
          </div>
          <div class="no-border-radius" style="display: flex; align-items: stretch;">
            <span class="label tr"
              style="display: inline-block;width: 250px;margin-bottom: 1px;padding: 6px 10px 0 0;">追加した組織</span>
            <span class="input-like-span tl" style="margin-bottom: 1px;">
              <radio-group class="tl" v-model="updateValue.belowSingle">
                <Radio label="0">以下</Radio>
                <Radio label="1">のみ を範囲とする</Radio>
              </radio-group>
            </span>
          </div>

          <!-- <div class="tr mt5 mb10"><i-button type="error" ghost size="small">選択行を削除</i-button></div> -->
          <!-- 那颗树 -->
          <div class="tl tree mt5">
            <span class="row-label-primary pl10 pr10 mt5 ml5 cursor">＋ このグループに該当する法人を追加</span>
            <i-button class="mt5" icon="md-trash" style="position:absolute; right: 35px;" type="error" ghost
              size="small" @click="deleteBasetree">選択行を削除</i-button>
            <Tree :data="baseTreeData" :render="renderBaseTree" @on-select-change="" empty-text="" check-directly
              show-checkbox ref="baseTree"></Tree>
          </div>
        </div>
        <Spin size="large" fix v-if="drawLoading"></Spin>
      </Drawer>
      <!-- 該当条件編集画面 end-->

      <!--  条件式による定義 选择group和 役職 start-->
      <Drawer class="tc" placement="right" :width="curdisplayPanel === 'searchDept' ? '100' : '700'" title="該当条件選択"
        v-model="showGroupOrPositionDrawer">
        <span v-show="curdisplayPanel === 'QPOST'">
          <div class="titlenorm mb5">
            <Icon type="logo-buffer"></Icon>
            役職
          </div>
          <Alert class="primary-info tl" style="margin-bottom: 5px;">
            <div>※ 役職マスタを選択してください。</div>
            <div class="mt2">&emsp;&nbsp;検索結果件数 {{ positonData.length }}件</div>
          </Alert>
          <div class="tr mb5" v-if="selectTreeType === 'post'">
            <i-button type="primary" ghost @click="addPostTree">決定</i-button>
          </div>
          <i-table class="mb5" border :row-class-name="()=>'select-col'" :columns="positonColumns"
            :disabled-hover="true" :data="positonData" :loading="loading" no-data-text="" ref="postTable">
            <template slot-scope="{ row }" slot="mapCpostidCk">
              <span class="mr10 pt2 pb2 pl10 pr10 cursor row-label-primary" @click="uptdatePositonValue(row)"
                v-if="selectTreeType !== 'post'">{{ row.mapCpostidCk }}</span>
              <span v-else>{{ row.mapCpostidCk }}</span>
            </template>

            <template slot-scope="{ row }" slot="mapCpostname">
              <span class="mr10 pt2 pb2 pl10 pr10 cursor row-label-primary" @click="uptdatePositonValue(row)"
                v-if="selectTreeType !== 'post'">{{ row.mapCpostname }}</span>
              <span v-else>{{ row.mapCpostname }}</span>
            </template>
          </i-table>
        </span>

        <Row :gutter="8">
          <i-col :span="curdisplayPanel === 'QSECTION'|| curdisplayPanel === 'base' ? 24 : 8"
            v-show="curdisplayPanel === 'QSECTION' || curdisplayPanel === 'searchDept'|| curdisplayPanel === 'base'">
            <div class="titlenorm mb5">
              <Icon type="logo-buffer"></Icon>
              所属
            </div>
            <Row class="tl mb5" :gutter="8">
              <i-col span="10">
                <i-input class="mar like-select" placeholder="検索" v-model="searchDept"
                  @keyup.enter.native="handleSearchDept">
                </i-input>
              </i-col>
              <i-col span="8" class="no-border-radius">
                <i-button long type="primary" icon="md-search" ghost :loading="loading" @click="handleSearchDept">検索
                </i-button>
              </i-col>
              <i-col span="4" offset="2" class="no-border-radius" v-if="curdisplayPanel === 'base'">
                <i-button long type="primary" ghost :loading="loading" @click="handleSelectDept">決定
                </i-button>
              </i-col>
            </Row>
            <!-- 这颗树在基点组织时，需要开启checkbox相关 -->
            <Tree class="tree mt2" :data="treeData" @on-select-change="handleClickLeaf" empty-text="所属データなし"
              :show-checkbox="curdisplayPanel === 'base'" :check-strictly="curdisplayPanel === 'base'"
              :check-directly="curdisplayPanel === 'base'" ref="selectTree"></Tree>
          </i-col>
          <i-col :span="curdisplayPanel === 'searchEmp' ? 24 : 16"
            v-show="curdisplayPanel === 'searchEmp' || curdisplayPanel === 'searchDept'">
            <div class="titlenorm mb5">
              <Icon type="logo-buffer"></Icon>
              社員検索
            </div>
            <div class="tr mb5">
              <i-button type="primary" ghost @click="addSearchEmp">決定</i-button>
            </div>
            <i-table class="mb5" border :row-class-name="()=>'select-col'" :columns="searchEmpColumns"
              :disabled-hover="true" :data="searchEmpData" :loading="loading" no-data-text="" ref="empTable">
            </i-table>
          </i-col>
        </Row>
        <Spin size="large" fix v-if="empSearchLoading"></Spin>
      </Drawer>
      <!--  条件式による定義 选择group和 役職 end-->
    </div>
    <div class="ivu-pop-popper" :style="poptipStyle" x-placement="right-start">
      <div class="ivu-poptip-content">
        <div class="ivu-poptip-arrow"></div>
        <div class="ivu-poptip-inner">
          <div class="ivu-poptip-body">
            <div class="ivu-poptip-body-content">
              <div class="ivu-poptip-body-content-inner">
                <!-- ＡＮＤ/ＯＲ -->
                <span v-show="poptipType === 'andor'">
                  <i-button @click="popClickAction('なし')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>なし</i-button>
                  <i-button @click="popClickAction('AND')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>AND</i-button>
                  <i-button @click="popClickAction('OR')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>OR</i-button>
                </span>

                <!-- （ -->
                <span v-show="poptipType === 'openedparenthsis'">
                  <i-button @click="popClickAction('なし')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>なし</i-button>
                  <i-button @click="popClickAction('(')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>(</i-button>
                  <i-button @click="popClickAction('((')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>((</i-button>
                  <i-button @click="popClickAction('(((')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>(((</i-button>
                </span>

                <!-- 項目 -->
                <span v-show="poptipType === 'columnname'">
                  <i-button v-for="(item,i) of queryconditionsList" :key="i" type="primary" ghost
                    @click="handleQueryconditions(item)" style="display:block;" size="small" class="mb5 tl" long>
                    {{ item.nameInfo }}</i-button>
                </span>

                <!-- 比較 -->
                <span v-show="poptipType === 'operator'">
                  <i-button @click="popClickAction(item.name, item.value)"
                    v-for="(item,i) of curdisplayPanel ? operatorList : operatorList2" type="primary" ghost
                    style="display:block" size="small" class="mb5" long>{{ item.name }}</i-button>
                </span>

                <!-- 値 -->
                <span v-show="poptipType === 'displayvalue'">
                  <!-- 为null时 自己输入
                  QHONKEN  0本務  兼務
                  QSECTION 弹出第二层抽屉选择所属
                  QPOST 役職マスタを選択してください。 弹出第二层抽屉选择役職マスタ
                  QPOSTNUM  役職順位マスタを選択してください。 没有
                  QZAITAI  在職 	退職
                  TMG_MANAGEFLG 管理対象外 管理対象 -->
                  <i-input class="mb5" v-if="!curdisplayPanel" v-model="updateValue.value"></i-input>
                  <i-button v-show="!curdisplayPanel" type="primary" ghost @click="updateInputValue"
                    style="display:block" size="small" class="mb5" long>決定</i-button>
                  <span v-show="curdisplayPanel === 'QHONKEN'">
                    <i-button @click="popClickAction('本務[0]', '0')" type="primary" ghost style="display:block"
                      size="small" class="mb5" long>本務[0]</i-button>
                    <i-button @click="popClickAction('兼務[1]', '1')" type="primary" ghost style="display:block"
                      size="small" class="mb5" long>兼務[1]</i-button>
                  </span>

                  <span v-show="curdisplayPanel === 'QZAITAI'">
                    <i-button @click="popClickAction('在職[0]', '0')" type="primary" ghost style="display:block"
                      size="small" class="mb5" long>在職[0]</i-button>
                    <i-button @click="popClickAction('退職[1]', '1')" type="primary" ghost style="display:block"
                      size="small" class="mb5" long>退職[1]</i-button>
                  </span>

                  <span v-show="curdisplayPanel === 'TMG_MANAGEFLG'">
                    <i-button @click="popClickAction('管理対象外[0]', '0')" type="primary" ghost style="display:block"
                      size="small" class="mb5" long>管理対象外[0]</i-button>
                    <i-button @click="popClickAction('管理対象[1]', '1')" type="primary" ghost style="display:block"
                      size="small" class="mb5" long>管理対象[1]</i-button>
                  </span>
                </span>

                <!-- ） -->
                <span v-show="poptipType === 'closedparenthsis'">
                  <i-button @click="popClickAction('なし')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>なし</i-button>
                  <i-button @click="popClickAction(')')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>)</i-button>
                  <i-button @click="popClickAction('))')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>))</i-button>
                  <i-button @click="popClickAction(')))')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>)))</i-button>
                </span>
                <i-button v-show="!hasSearchedQueryconditions || poptipType !== 'columnname'" @click="cancelpoptip"
                  style="display:block" size="small" class="mb5" long>キャンセル</i-button>
                <i-button v-show="hasSearchedQueryconditions && poptipType === 'columnname'"
                  @click="queryconditionsFallback" style="display:block" size="small" class="mb5" long>戻る</i-button>

                <Spin size="large" fix v-if="queryconditionsLoading"></Spin>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <div th:replace="layout/head::header"></div>
  <script th:src="${baseUrl + '/static/js/dragTableTr.js'}"></script>
  <script>
    var operatorList = [
      { name: '＝', value: '＝' },
      { name: '≠', value: '<>' },
      { name: '以上', value: '>=' },
      { name: '以下', value: '<=' },
      { name: 'より上', value: '>' },
      { name: 'より下', value: '<' },
      { name: '空白のみ', value: 'ISNULL' },
      { name: '空白以外', value: 'ISNOTNULL' },
    ]
    var operatorList2 = [
      { name: '＝', value: '＝' },
      { name: '≠', value: '<>' },
      { name: '≧', value: '>=' },
      { name: '≦', value: '<=' },
      { name: '＞', value: '>' },
      { name: '＜', value: '<' },
      { name: 'IS NULL', value: 'ISNULL' },
      { name: 'IS NOT NULL', value: 'ISNOTNULL' },
    ]
  </script>
  <script type="text/babel" th:inline="javascript">
    const GROUP_SETTINGS = new Vue({
      el: '.groupsettings-warp',
      data() {
        return {
          loading: true,
          isDraggable: true,
          hasDragTable: false,
          editLoading: false,
          drawLoading: false,
          empSearchLoading: false,
          sortingLoading: false,
          isAdding: false,
          isShow: false,
          showGroupOrPositionDrawer: false,
          drawerBtnLoading: false,
          queryconditionsLoading: false,
          currentTab: '',
          selectTreeType: '',
          lightDelBtnVisible: [],
          lightDelBtnVisible2: [],
          lightDelBtnVisible3: [],
          treeData: [],
          baseTreeData: [],
          beforeDate: '',
          searchEmpt: '',
          systemList: [],
          curDate: new Date(),
          opts: {
            systemId: '01',
            date: ''
          },
          poptipStyle: {
            display: 'none',
            position: 'absolute',
            'will-change': 'top, left',
            'z-index': '1001',
            left: '0',
            top: '0'
          },
          poptipType: '',
          columns: [
            {
              title: '期間',
              slot: 'date'
            },
            {
              title: 'ID',
              slot: 'mgCgroupidPk',
              width: 150,
            },
            {
              title: '名称',
              slot: 'mgCgroupdescription',
            },
            {
              title: '法人',
              key: 'companyName'
            },
            {
              title: '削除',
              slot: 'del',
              align: 'center',
              width: 80,
            }
          ],
          groupInfoColumns: [
            {
              title: '期間',
              slot: 'date',
            },
            {
              title: 'ID',
              width: 70,
              slot: 'mgCgroupidPk',
              align: 'center'
            },
            {
              title: '名称',
              slot: 'name',
            },
            {
              title: '適正人数',
              slot: 'count',
              width: 120,
            },
          ],
          groupInfoData: [],
          emptColumns: [
            {
              title: '法人',
              key: 'companyName',
            },
            {
              title: '所属',
              key: 'sectionName',
            },
            {
              title: '役職',
              key: 'postName',
            },
            {
              title: '社員番号',
              key: 'employeeId',
            },
            {
              title: '社員氏名',
              key: 'kanJiName',
            },
            {
              title: '削除',
              slot: 'action',
              width: 80
            }
          ],
          emptData: [],
          queryColumns: [
            {
              title: 'ＡＮＤ/ＯＲ',
              slot: 'andor',
              align: 'center',
              width: 100,
            },
            {
              title: '（',
              width: 70,
              align: 'center',
              slot: 'openedparenthsis',
            },
            {
              title: '項目',
              slot: 'columnname',
            },
            {
              title: '比較',
              width: 100,
              align: 'center',
              slot: 'operator',
            },
            {
              title: '値',
              slot: 'displayvalue',
            },
            {
              title: '）',
              width: 70,
              align: 'center',
              slot: 'closedparenthsis',
            },
            {
              title: ' ',
              width: 100,
              slot: 'action',
            },
          ],
          curdisplayPanel: '',
          queryData: [],
          deleteQueryData: [],
          positonColumns: [
            {
              title: 'コード',
              width: 120,
              slot: 'mapCpostidCk',
            },
            {
              title: '名称',
              slot: 'mapCpostname',
            },
          ],
          positonData: [],
          searchEmpColumns: [
            {
              title: '社員番号',
              width: 120,
              key: 'meCuserid',
            },
            {
              title: '氏名',
              key: 'empName',
            },
            {
              title: '所属',
              key: 'sectionName',
            },
            {
              title: '役職',
              key: 'postName',
            },
            {
              type: 'selection',
              width: 60,
              align: 'center'
            },
          ],
          legalPersonList: [],
          searchEmpData: [],
          searchDeptColumns: [],
          searchDeptData: [],
          sectionPostList: [], //組織・役職選択による定義
          bossList: [],
          bossListSelected: [],
          sectionPostList_bak: {},
          postList: [],
          postListSelected: [],
          clickedCell: {},
          tableData: [{}],
          _treeData: [],
          treeDataForSearch: [],
          searchDept: '',
          queryconditionsList: [],
          queryconditionsList_bak: [],
          hasSearchedQueryconditions: false,
          psSite: Utils.getUrlParam(location.href, 'psSite'),
          psApp: Utils.getUrlParam(location.href, 'psApp'),
          updateValue: {},
          limitDate: '',
          rangeOptions: {
            disabledDate: date => {
              return date.valueOf() < new Date(this.limitDate).getTime()
            }
          }
        }
      },
      async created() {
        this.getData()
        this.getLegalPersonList()
        this.getqueryconditions()
      },
      watch: {
        isShow(newValue) {
          // 关闭浮层需要将小浮窗一起关闭
          // 且将待删除条件式数组清空
          if (!newValue) {
            this.poptipStyle.display = 'none'
            this.deleteQueryData = []
          }
        }
      },
      computed: {
      },
      methods: {
        async getData() {
          const OPTS = { ...this.opts }
          OPTS.psSite = this.psSite
          OPTS.psApp = this.psApp
          this.loading = true
          try {
            const { data } = await this.http.get('sys/groupmanager/groups', OPTS)
            this.systemList = data.systemList
            this.beforeDate = data.beforeDate
            this.limitDate = data.latestDate
            this.tableData = data.validGroupList
          } catch (error) {

          } finally {
            this.loading = false
          }
        },
        async getqueryconditions() {
          const { data } = await this.http.get('sys/groupmanager/queryconditions')
          this.queryconditionsList = data
          this.queryconditionsList_bak = [...data]
        },
        // 点击項目
        async handleQueryconditions(e) {
          if (this.hasSearchedQueryconditions) {
            console.log(e)
            // columnname 项目
            // displayvalue 值
            // 将项目的选中值更新到表格中
            //   更新选择得条件
            this.queryData[this.clickedCell.where].columnname = e.nameInfo
            this.queryData[this.clickedCell.where].columnid = e.codeInfo
            //   更新值的变换信息
            this.queryData[this.clickedCell.where].mastertablename = e.masterInfo
            //   清空之前的值信息
            this.queryData[this.clickedCell.where].displayvalue = ''
            this.queryData[this.clickedCell.where].value = ''
            this.poptipStyle.display = 'none'
            return
          }
          this.queryData[this.clickedCell.where].tableid = e.codeInfo
          try {
            this.queryconditionsLoading = true
            const { data } = await this.http.get('sys/groupmanager/queryconditions', { tableId: e.codeInfo })
            this.hasSearchedQueryconditions = true
            this.queryconditionsList = data
          } catch (error) {
          } finally {
            this.queryconditionsLoading = false
          }
        },
        queryconditionsFallback() {
          this.queryconditionsList = this.queryconditionsList_bak
          this.hasSearchedQueryconditions = false
        },
        async add(resetByChangeCompanyId) {
          this.isAdding = true
          this.isShow = true
          this.searchEmpt = ''
          if (!resetByChangeCompanyId) {
            this.groupInfoData = [{
              mgDenddate: '',
              mgDstartdate: '',
              companyName: '',
              companyId: '01',
              mgCtext: '',
              mgCgroupdescription: '',
              mgNpartinentnumber: ''
            }]
            this.updateValue.baseFlag = '0'
          }
          // this.updateValue = {}
          this.baseTreeData = [{
            title: resetByChangeCompanyId ? '全社区分' : `【${this.legalPersonList[0].macCcompanyidCk}】 ${this.legalPersonList[0].macCcompanyname}`,
            expand: true,
            disabled: true,
            children: []
          }]
          // 条件式による定義
          this.queryData = [{ isAdd: true, addIndex: Date.now(), andor: '', openedparenthsis: '', columnname: '', operator: '', displayvalue: '', closedparenthsis: '', delete: false }]
          this.sectionPostList = [{
            companyId: this.legalPersonList[0].macCcompanyidCk,
            companyName: this.legalPersonList[0].macCcompanyname,
            title: resetByChangeCompanyId ? '全社区分' : `【${this.legalPersonList[0].macCcompanyidCk}】 ${this.legalPersonList[0].macCcompanyname}`,
            expand: true,
            disabled: true,
            children: [],
            isCompany: true
          }]
          this.bossList = []
          this.postList = []
        },
        handleChangeCompanyId(e) {
          this.$Modal.confirm({
            inDrawer: true,
            title: '法人を変更すると設定した条件は一度クリアされます。よろしいですか？？',
            okText: 'OK',
            cancelText: 'キャンセル',
            onOk: () => {
              this.add(true)
            },
            onCancel: () => {
              if (this.groupInfoData[0].companyId === '*') this.groupInfoData[0].companyId = '01'
              else this.groupInfoData[0].companyId = '*'
            }
          })
        },
        async handleSearchEmpt(isByDept) {
          // searchWord
          // targetDept
          if (!isByDept && !this.searchEmpt.trim()) {
            return this.$Notice.warning({ title: '注意', desc: '検索文字列を入力してください。', duration: 6.5 })
          }
          if (isByDept) {
            this.curdisplayPanel = 'searchDept'
            this.showGroupOrPositionDrawer = true
            const { data } = await this.http.get(`sys/tree/orgs?psSite=${this.psSite}&psApp=${this.psApp}`)
            this.treeData = this.convertTreeData(data)
            this.treeData[0].expand = true
            this._treeData = Utils.deepClone(this.treeData)
            this.searchEmpData = []

          } else {
            this.curdisplayPanel = 'searchEmp'
            this.showGroupOrPositionDrawer = true
            try {
              this.empSearchLoading = true
              const { data } = await this.http.get(`sys/groupmanager/empsearch?psSite=${this.psSite}`, { searchWord: this.searchEmpt, type: 1 })
              this.searchEmpData = data.map(e => {
                // 点开后将默认勾选勾上
                if (this.emptData.find(t => t.employeeId === e.meCuserid)) {
                  return { ...e, _checked: true }
                } else {
                  return e
                }
              })
            } catch (error) {
            } finally {
              this.empSearchLoading = false
            }
          }
        },
        // 将选择中的社员加到社員を指定表格里
        addSearchEmp() {
          let emptData = []
          this.$refs.empTable.getSelection().forEach(e => {
            if (!this.emptData.some(t => t.employeeId === e.meCuserid)) {
              emptData = emptData.concat({
                ...e,
                id: e.meId,
                companyId: e.hdCcompanyidCk,
                sectionId: e.hdCsectionidFk,
                postId: e.hdCpostidFk,
                companyName: e.compName,
                employeeId: e.meCuserid,
                kanJiName: e.empName
              })
            }
          })
          if (emptData.length > 0) this.emptData = this.emptData.concat(emptData)
          this.showGroupOrPositionDrawer = false
        },
        handleSystemChange() {
          this.getSiteList()
        },
        handleDatePicker(e) {
          if (!e) return
          this.opts.date = e
          this.getTableData()
        },
        async getLegalPersonList() {
          const { data } = await this.http.get(`sys/groupappmanager/companies?psSite=${this.psSite}&psApp=${this.psApp}`)
          this.legalPersonList = data
          this.opts.companyId = data[0] && data[0].macCcompanyidCk
        },
        getPreData() {
          this.opts.date = this.beforeDate
          this.getTableData()
        },
        handleCancel() {
          if (this.updateValue.length > 0) {
            history.go(0)
          } else {
            this.isEditing = false
          }
        },
        async edit(e) {
          this.isAdding = false
          const OPTS = { ...this.opts }
          OPTS.psSite = this.psSite
          OPTS.groupId = e
          this.searchEmpt = ''
          try {
            this.drawLoading = true
            this.isShow = true
            const { data } = await this.http.get('sys/groupmanager/detail', OPTS)
            this.groupInfoData = [data.groupInfo]
            this.emptData = data.empList.empList
            this.updateValue.belowSingle = data.belowSingle
            this.updateValue.baseFlag = data.groupInfo.gsBaseFlg
            this.updateValue.weightAge = data.groupInfo.mgNweightage
            this.sectionPostList_bak = Utils.deepClone(data)
            // 条件式による定義
            this.queryData = data.queryConditions.rowList.length >= 1 ? data.queryConditions.rowList : [{ isAdd: true, addIndex: Date.now(), andor: '', openedparenthsis: '', columnname: '', operator: '', displayvalue: '', closedparenthsis: '', delete: false }]
            // 只有单法人的情况，因为data中只有一个法人信息，且sectionList仅有一个对象且自属性中法人信息缺失
            // 所以这里直接取第一个法人的全部
            // 基点組織
            this.baseTreeData = [{
              title: data.companyId === '*' ? '全社区分' : `【${data.companyId}】 ${data.companyName}`, children: data.baseSectionList[0] && data.baseSectionList[0].sectionList.map((e, i) => {
                return {
                  ...e,
                  sectionId: e.mgbsCsectionid,
                  delete: false,
                  title: `【${e.mgbsCsectionid}】 ${e.sectionName}`
                }
              }), expand: true, disabled: true,
            }]

            // 組織・役職選択による定義
            let childIndex = 0
            // 组织树
            this.sectionPostList = data.orgJobConditions.companyList.map((t, i) => {
              return {
                title: t.companyId === '*' ? '全社区分' : `【${t.companyId}】 ${t.companyName}`,
                expand: true,
                disabled: true,
                companyId: data.companyId,
                companyName: data.companyName,
                isCompany: true, // 法人
                children: t.sectionList.map((n, j) => {
                  childIndex += j
                  return {
                    ...n,
                    title: `【${n.sectionId}】 ${n.sectionName}`,
                    children: n.postList.map((m, k) => {
                      return {
                        ...m,
                        title: `【${m.postId}】 ${m.postName}`,
                        uni_id: `${j}.${k}`,
                        isPost: true // 役職,
                      }
                    }),
                    expand: true,
                    isGroup: true, // 組織
                    isLastGroup: t.sectionList.length - 1 === j,
                    uni_id: `${j}`
                  }
                })
              }
            })
            // 所属长
            // 还需要查一查部门 有人没有
            const bossIdlist = data.orgJobConditions.companyList[0].bossSectionList.map(e => e.sectionId)
            Promise.all(bossIdlist.map(e =>
              this.http.get(`sys/groupmanager/bosslist?psSite=${this.psSite}`, { sectionId: e })
            )).then(resArray => {
              this.bossList = [...data.orgJobConditions.companyList[0].bossSectionList.map(
                (e, i) => { return { ...e, children: [], title: `【${e.sectionId}】 ${e.sectionName}【${resArray[i].data}】`, uni_id: e.sectionId, isBoss: true, checked: false, expand: false, delete: false } })]
            })

            // 役職
            this.postList = data.orgJobConditions.companyList[0].postList.map(n => {
              return {
                ...n,
                title: `【${n.postId}】 ${n.postName}`,
                delete: false,
                isPost: true, // 役職,
                uni_id: n.postId
              }
            })
            console.log('sectionList')
            console.log(this.sectionPostList)
          } catch (error) {

          } finally {
            this.drawLoading = false
          }
        },
        remove(i) {
          this.$set(this.lightDelBtnVisible, i, false)
        },
        cancel(i) {
          this.$set(this.lightDelBtnVisible, i, false)
        },
        removeEmpt(row, i) {
          // 由于自己选择新增的不存在id, 所以使用社员番号来删除
          this.emptData = this.emptData.filter(e => e.employeeId !== row.employeeId)
          this.$set(this.lightDelBtnVisible2, i, false)
        },
        cancelEmpt(i) {
          this.$set(this.lightDelBtnVisible2, i, false)
        },
        // 点击表格的格子
        async handleCellClickForAction(row, column, data, event) {
          // console.log(event)
          this.poptipStyle.display = 'none'
          if (column.slot === 'action') {
            return
          }
          this.poptipType = column.slot
          this.curdisplayPanel = row.mastertablename
          // 储存单击格的位置信息
          this.clickedCell = {
            where: row._index,
            which: column.slot
          }
          if (this.poptipType === 'displayvalue') {
            if (this.curdisplayPanel === 'QPOST') {
              this.showGroupOrPositionDrawer = true
              const selectionIndex = this.positonColumns.findIndex(e => e.type === 'selection')
              if (selectionIndex > -1) {
                this.positonColumns.splice(selectionIndex, 1)
              }
              this.selectTreeType = ''
              const { data } = await this.http.get(`sys/tree/posts?psSite=${this.psSite}`)
              this.positonData = data.list
              return
            }
            if (this.curdisplayPanel === 'QSECTION') {
              this.showGroupOrPositionDrawer = true
              const { data } = await this.http.get(`sys/tree/orgs?psSite=${this.psSite}&psApp=${this.psApp}`)
              this.treeData = this.convertTreeData(data)
              this.treeData[0].expand = true
              this._treeData = Utils.deepClone(this.treeData)
              return
            }
            // this.curdisplayPanel
          }
          const elemLocation = event.target.offsetParent.getBoundingClientRect()
          this.poptipStyle.display = 'block'
          this.poptipStyle.left = `${elemLocation.x}px`
          this.poptipStyle.top = `${elemLocation.y}px`
        },
        updateInputValue() {
          // 将input的值更新到表格中
          this.queryData[this.clickedCell.where].displayvalue = this.updateValue.value
          this.queryData[this.clickedCell.where].value = this.updateValue.value
          this.poptipStyle.display = 'none'
          this.updateValue.value = ''
        },
        uptdatePositonValue(e) {
          //mapCpostname  mapCpostidCk
          if (this.selectTreeType === 'post') {
            return
          } else {
            this.queryData[this.clickedCell.where].displayvalue = `${e.mapCpostname}[${e.mapCpostidCk}]`
          }
          this.showGroupOrPositionDrawer = false
        },
        cancelpoptip() {
          this.poptipStyle.display = 'none'
          this.updateValue.value = ''
        },
        // 点击改变表格的值
        popClickAction(e, value2) {
          if (e === 'なし') {
            this.queryData[this.clickedCell.where][this.clickedCell.which] = ''
            if (this.clickedCell.which === 'openedparenthsis') this.queryData[this.clickedCell.where].closedparenthsis = ''
            if (this.clickedCell.which === 'closedparenthsis') this.queryData[this.clickedCell.where].openedparenthsis = ''
          } else {
            this.queryData[this.clickedCell.where][this.clickedCell.which] = e
            const paernthsis = {
              '(': ')',
              '((': '))',
              '(((': ')))',
              ')': '(',
              '))': '((',
              ')))': '(((',
            }
            if (this.clickedCell.which === 'displayvalue') this.queryData[this.clickedCell.where].value = value2
            if (this.clickedCell.which === 'operator') this.queryData[this.clickedCell.where].operator = value2
            if (this.clickedCell.which === 'openedparenthsis') this.queryData[this.clickedCell.where].closedparenthsis = paernthsis[e]
            if (this.clickedCell.which === 'closedparenthsis') this.queryData[this.clickedCell.where].openedparenthsis = paernthsis[e]
          }
          this.poptipStyle.display = 'none'
        },
        async handleClickLeaf(e) {
          if (!e[0]) return
          if (this.curdisplayPanel === 'searchDept') {
            const { data } = await this.http.get(`sys/groupmanager/empsearch?psSite=${this.psSite}`, { targetDept: e[0].sectionId, type: 2 })
            try {
              this.empSearchLoading = true
              const { data } = await this.http.get(`sys/groupmanager/empsearch?psSite=${this.psSite}`, { searchWord: this.searchEmpt, type: 1 })
              this.searchEmpData = data.map(e => {
                // 点开后将默认勾选勾上
                if (this.emptData.find(t => t.employeeId === e.meCuserid)) {
                  return { ...e, _checked: true }
                } else {
                  return e
                }
              })
            } catch (error) {
            } finally {
              this.empSearchLoading = false
            }
            return
          }
          this.queryData[this.clickedCell.where][this.clickedCell.which] = `${e[0].sectionName}[${e[0].sectionId}]`
          this.showGroupOrPositionDrawer = false
        },
        handleSelectDept() {
          // 同样这里是只考虑单法人
          if (this.selectTreeType === 'base') {
            this.baseTreeData[0].children = [...this.$refs.selectTree.getCheckedNodes().map(
              e => {
                return {
                  ...e,
                  mgbsCgroupid: this.groupInfoData.mgCgroupidPk,
                  mgbsCcompanyid: this.groupInfoData.mgCcompanyid,
                  mgbsCsystemid: this.groupInfoData.mgCsystemidCkFk,
                  mgbsCbeloworsingle: this.updateValue.belowSingle,
                  mgbsCsectionid: e.sectionId,
                  mgbsClayeredsectionid: e.layeredSectionId,
                  mgbsCcustomerid: e.customerId,
                  children: [], title: `【${e.sectionId}】 ${e.sectionName}`, checked: false, expand: false, delete: false,
                }
              })]
          }

          if (this.selectTreeType === 'section') {
            //　自己增加得项目也必须添加uni_id来统一在外面的删除
            let cur = this.$refs.selectTree.getCheckedNodes()
            let curId = cur.map(e => e.sectionId)
            let deleteArray = []
            this.sectionPostList[0].children.forEach((e, j) => {
              if (e.isGroup) {
                if (curId.includes(e.sectionId)) {
                  // 得到需要追加的
                  cur.splice(cur.findIndex(t => t.sectionId === e.sectionId), 1)
                } else {
                  // 得到需要减去的
                  deleteArray.push(e.uni_id)
                }
              }
            })
            // 删除没打勾的
            deleteArray.forEach(e => {
              this.sectionPostList[0].children.splice(this.sectionPostList[0].children.findIndex(t => t.uni_id === e), 1)
            })
            cur.forEach((e, j) => {
              this.sectionPostList[0].children.splice(this.sectionPostList[0].children.length + j, 0, { ...e, children: [], title: `【${e.sectionId}】 ${e.sectionName}`, checked: false, delete: false, isGroup: true, uni_id: e.sectionId })
            })
          }

          if (this.selectTreeType === 'boss') {
            let cur = this.$refs.selectTree.getCheckedNodes()
            let curId = cur.map(e => e.sectionId)

            Promise.all(curId.map(e =>
              this.http.get(`sys/groupmanager/bosslist?psSite=${this.psSite}`, { sectionId: e })
            )).then(resArray => {
              console.log(resArray)
              this.bossList = [...cur.map(
                (e, i) => { return { ...e, children: [], id: e.moId, title: `【${e.sectionId}】 ${e.sectionName}【${resArray[i].data}】`, checked: false, expand: false, delete: false, uni_id: e.sectionId } })]
            })
          }
          this.showGroupOrPositionDrawer = false
        },
        conditionDeleteAll() {
          this.$Modal.confirm({
            inDrawer: true,
            title: '全行を削除します。よろしいですか？',
            okText: 'OK',
            cancelText: 'キャンセル',
            onOk: () => {
              this.deleteQueryData = this.queryData.filter(e => !e.isAdd)
              this.queryData = []
            }
          })
          this.poptipStyle.display = 'none'
        },
        cancelconditionDelete(i) {
          this.$set(this.lightDelBtnVisible3, i, false)
        },
        conditionDelete(row, i) {
          if (row.isAdd) this.queryData = this.queryData.filter(e => e.addIndex !== row.addIndex)
          else this.queryData = this.queryData.filter(e => e.id !== row.id)
          this.$set(this.lightDelBtnVisible3, i, false)
        },
        conditionAddTop() {
          // 条件式表格顶部加一行
          this.queryData.unshift({ isAdd: true, addIndex: Date.now(), andor: '', openedparenthsis: '', columnname: '', operator: '', displayvalue: '', closedparenthsis: '', delete: false })
          this.poptipStyle.display = 'none'
        },
        conditionAdd(i) {
          // 条件式表格中间加一行
          this.queryData.splice(i + 1, 0, { isAdd: true, addIndex: Date.now(), andor: '', openedparenthsis: '', columnname: '', operator: '', displayvalue: '', closedparenthsis: '', delete: false })
          this.poptipStyle.display = 'none'
        },
        handleSearchDept: Debounce(function () {
          if (!this.searchDept) {
            this.treeData = this._treeData
            return
          }

          this.treeDataForSearch = []
          this.sectionInTreeData(this._treeData)
          this.treeData = this.treeDataForSearch
        }),
        sectionInTreeData(data) {
          const _this = this
          // todo: 这里还是应该存路径解
          data.forEach((e, i) => {
            if (e.title.indexOf(_this.searchDept) > -1) {
              _this.treeDataForSearch = _this.treeDataForSearch.concat({ ...e, children: [] })
            }
            if (e.children && e.children.length > 0) {
              _this.sectionInTreeData(e.children);
            }
          })
        },
        // 可以传入一个selectedItemArray, 来回显已被选择的值
        convertTreeData(treeData, selectedItemArray, selectedItemkeyName) {
          if (!treeData) {
            this.$Message.error({
              background: true,
              closable: true,
              duration: 6.5,
              content: '参照できる組織図が存在しません。'
            });
            return []
          }
          return treeData.map((e, i) => {
            if (e.children) {
              return {
                ...e,
                title: e.sectionName,
                expand: true,
                checked: selectedItemArray && selectedItemArray.includes(e[selectedItemkeyName]),
                children: this.convertTreeData(e.children, selectedItemArray, selectedItemkeyName)
              }
            } else {
              return {
                ...e,
                title: e.sectionName,
                checked: selectedItemArray && selectedItemArray.includes(e[selectedItemkeyName])
              }
            }
          })
        },
        renderTabTree(h, { root, node, data }) {
          // 第一层法人可以追加組織，且组织的下方可以追加役職
          // 最后一个组织的下方可以追加所属长
          // 最后一个所属张的下方可以追加役職
          // 如果 bossSectionList 和 postList 为空则在第一个也加上
          const that = this
          if (data.isCompany) {
            return h('span', {
              style: {
                display: 'inline-block',
                width: '100%'
              }
            }, [
              h('span', data.title),
              h('div', [
                h('span', {
                  domProps: {
                    className: 'row-label-primary pl10 pr10'
                  },
                  style: {
                    margin: '6px 0 0 -1px'
                  },
                  on: {
                    click(e) {
                      e.stopPropagation()
                      that.openSectionTree()
                    },
                  }
                }, '＋ このグループに該当する組織を追加')
              ]
              )
            ])
          }
          if (data.isGroup) {
            return h('span', {
              style: {
                display: 'inline-block',
                width: '100%'
              }
            }, [
              h('span', data.title),
              h('div', [
                h('span', {
                  domProps: {
                    className: 'row-label-primary pl10 pr10'
                  },
                  style: {
                    margin: '6px 0 0 0'
                  },
                  on: {
                    click(e) {
                      e.stopPropagation()
                      that.openPostTree(data)
                    },
                  }
                }, '＋ このグループに該当する役職を追加')
              ])
            ])
          }
          return h('span', data.title)
        },
        renderBaseTree(h, { root, node, data }) {
          const that = this
          if (data.expand) {
            return h('span', {
              style: {
                display: 'inline-block',
                width: '100%'
              }
            }, [
              h('span', data.title),
              h('div', [
                h('span', {
                  domProps: {
                    className: 'row-label-primary pl10 pr10'
                  },
                  style: {
                    margin: '6px 0 0 -28px'
                  },
                  on: {
                    click(e) {
                      e.stopPropagation()
                      that.addBaseTree(0)
                    },
                  }
                }, '＋ このグループに該当する組織を追加')
              ])
            ])
          }
          return h('span', data.title)
        },
        async addBaseTree(i) {
          this.showGroupOrPositionDrawer = true
          this.curdisplayPanel = 'base'
          this.selectTreeType = 'base'
          this.selectedBaseTreeData = []
          const { data } = await this.http.get(`sys/tree/orgs?psSite=${this.psSite}&psApp=${this.psApp}`)
          // 点击追加基点组织时，需要回显已选择的项目
          const selectedBase = this.baseTreeData[i].children.map(e => e.sectionId)
          this.treeData = this.convertTreeData(data, selectedBase, 'sectionId')
          this.treeData[0].expand = true
          this._treeData = Utils.deepClone(this.treeData)
        },
        deleteBasetree() {
          this.$Modal.confirm({
            inDrawer: true,
            title: '選択行を削除します。よろしいですか？',
            okText: 'OK',
            cancelText: 'キャンセル',
            onOk: () => {
              const selectedNodes = this.$refs.baseTree.getCheckedNodes().map(e => e.sectionId)
              // 同样这里是只考虑单法人
              this.baseTreeData[0].children = this.baseTreeData[0].children.filter(e => !selectedNodes.includes(e.sectionId))
              // 将半选的root清除
              this.baseTreeData[0].indeterminate = false
            }
          })
        },
        async openSectionTree() {
          this.showGroupOrPositionDrawer = true
          this.curdisplayPanel = 'base'
          this.selectTreeType = 'section'
          this.selectedBaseTreeData = []
          const { data } = await this.http.get(`sys/tree/orgs?psSite=${this.psSite}&psApp=${this.psApp}`)
          // 点击追加組織・役職選択による定義回显
          let selectedBase = []
          this.sectionPostList.forEach(e => {
            e.children.forEach(t => {
              if (t.isGroup) selectedBase = selectedBase.concat(t.sectionId)
            })
          })
          this.treeData = this.convertTreeData(data, selectedBase, 'sectionId')
        },
        deleteSectionTree() {
          this.$Modal.confirm({
            inDrawer: true,
            title: '選択行を削除します。よろしいですか？',
            okText: 'OK',
            cancelText: 'キャンセル',
            onOk: () => {
              const selectedNodes = this.$refs.sectionTree.getCheckedNodes().map(e => e.uni_id)
              // 同样这里是只考虑单法人
              this.sectionPostList[0].children.forEach((e, i) => {
                if (selectedNodes.includes(e.uni_id)) {
                  // 因为删除后索引会变，需要找到正确的索引
                  this.sectionPostList[0].children.splice(this.sectionPostList[0].children.findIndex(t => t.uni_id === e.uni_id), 1)
                }
                if (e.children && e.children.length > 0) {
                  e.children.forEach(t => {
                    if (selectedNodes.includes(t.uni_id)) {
                      this.sectionPostList[0].children[i].indeterminate = false
                      this.sectionPostList[0].children[i].children.splice(this.sectionPostList[0].children[i].children.findIndex(n => n.uni_id === t.uni_id), 1)
                    }
                  })
                }
              })
              this.bossList.forEach(e => {
                if (this.bossListSelected.includes(e.uni_id)) this.bossList.splice(this.bossList.findIndex(t => t.uni_id === e.uni_id), 1)
              })

              this.postList.forEach(e => {
                if (this.postListSelected.includes(e.uni_id)) this.postList.splice(this.postList.findIndex(t => t.uni_id === e.uni_id), 1)
              })
              // 将半选的root清除
              this.sectionPostList[0].indeterminate = false
            }
          })
        },
        async openBossTree() {
          this.showGroupOrPositionDrawer = true
          this.curdisplayPanel = 'base'
          this.selectTreeType = 'boss'
          this.selectedBaseTreeData = []
          const { data } = await this.http.get(`sys/tree/orgs?psSite=${this.psSite}&psApp=${this.psApp}`)
          // 点击追加組織・役職選択による定義回显
          let selectedBase = []
          this.bossList.forEach(e => {
            selectedBase = selectedBase.concat(e.sectionId)
          })
          this.treeData = this.convertTreeData(data, selectedBase, 'sectionId')
        },
        async addPostTree() {
          // console.log(this.$refs.postTable.getSelection())
          // console.log(this.postList)
          if (!this.postUnderWhichDept) {
            this.postList = this.$refs.postTable.getSelection().map(e => {
              return {
                id: e.mapId,
                companyId: '01',
                title: `【${e.mapCpostidCk}】 ${e.mapCpostname}`,
                postId: e.mapCpostidCk,
                isPost: true, // 役職,
                uni_id: e.mapCpostidCk
              }
            })
          } else {
            const that = this
            this.sectionPostList[0].children.some((e, i) => {
              if (e.sectionId === this.postUnderWhichDept) {
                // 将役職正确的塞到组织中去
                this.sectionPostList[0].children[i].children = this.$refs.postTable.getSelection().map(t => {
                  return {
                    id: t.mapId,
                    companyId: '01',
                    sectionId: e.sectionId,
                    title: `【${t.mapCpostidCk}】 ${t.mapCpostname}`,
                    postId: t.mapCpostidCk,
                    isPost: true, // 役職
                    uni_id: t.mapCpostidCk
                  }
                })
                return true
              }
            })
          }
        },
        async openPostTree(underDeptInfo) {
          this.postUnderWhichDept = ''
          this.showGroupOrPositionDrawer = true
          this.curdisplayPanel = 'QPOST'
          this.selectTreeType = 'post'
          if (!this.positonColumns.some(e => e.type === 'selection')) this.positonColumns = this.positonColumns.concat({ type: 'selection', width: 60, align: 'center' })
          const { data } = await this.http.get(`sys/tree/posts?psSite=${this.psSite}`)
          let IDs = []
          if (!underDeptInfo) {
            // 点击役職定義回显
            IDs = this.postList.map(e => e.postId)
          } else {
            if (underDeptInfo.children && underDeptInfo.children.length > 0) IDs = underDeptInfo.children.map(e => e.postId)
            this.postUnderWhichDept = underDeptInfo.sectionId
          }
          this.positonData = data.list.map(e => {
            return {
              ...e,
              _checked: IDs.includes(e.mapCpostidCk)
            }
          })
        },
        async updateGroup(isAdd) {
          const updateValue = {
            ...this.updateValue,
            mgpId: this.groupInfoData[0].mgpId,
            mgId: this.groupInfoData[0].mgId,
            groupId: this.groupInfoData[0].mgCgroupidPk,
            startDate: this.groupInfoData[0].mgDstartdate,
            endDate: this.groupInfoData[0].mgDenddate,
            peopleCount: this.groupInfoData[0].mgNpartinentnumber,
            groupName: this.groupInfoData[0].mgCgroupdescription,
            remark: this.groupInfoData[0].mgCtext,
            sectionPostList: {
              companyId: this.sectionPostList[0].companyId,
              companyName: this.sectionPostList[0].companyName,
              sectionList: this.sectionPostList[0].children.map(e => {
                return {
                  companyId: e.companyId,
                  sectionId: e.sectionId,
                  id: e.id ? e.id : e.moId,
                  delete: false,
                  postList: e.children.map(t => {
                    return {
                      companyId: t.companyId,
                      sectionId: t.sectionId,
                      postId: t.postId,
                      id: t.id,
                      delete: false
                    }
                  })
                }
              }),
              postList: [...this.postList],
              bossSectionList: [...this.bossList],
            },
            employList: this.updateValue.baseFlag === '0' ? this.emptData : [], // 社員選択による定義
            queryConditionList: this.updateValue.baseFlag === '1' ? this.queryData : [],
            baseSectionList: [{ sectionList: this.baseTreeData[0].children }],

          }
          if (isAdd) {
            delete updateValue.mgpId
            delete updateValue.mgId
            if (!updateValue.startDate) return this.$Notice.warning({ title: '注意', desc: '開始日を入力してください。', duration: 6.5 })
            if (!updateValue.endDate) updateValue.endDate = '2222/12/31'
            updateValue.startDate = Utils.formatDate(updateValue.startDate, 'yyyy/mm/dd')
            updateValue.endDate = Utils.formatDate(updateValue.endDate, 'yyyy/mm/dd')
            if (updateValue.startDate > updateValue.endDate) return this.$Notice.warning({ title: '注意', desc: '開始日＜終了日となるようにしてください。', duration: 6.5 })
            if (!updateValue.groupId) return this.$Notice.warning({ title: '注意', desc: 'IDを入力してください。', duration: 6.5 })
          }
          if (this.sectionPostList_bak.companyId) {
            // 組織・役職選択による定義
            // 組織的处理
            const sectionIdList = updateValue.sectionPostList.sectionList.map(e => e.sectionId)
            this.sectionPostList_bak.orgJobConditions.companyList[0].sectionList.forEach(e => {
              // 如果之前的数组中存在此条組織，则对比postlist
              if (sectionIdList.includes(e.sectionId)) {
                const sectionIndex = updateValue.sectionPostList.sectionList.findIndex(n => n.sectionId === e.sectionId)
                const postIdList = updateValue.sectionPostList.sectionList[sectionIndex].postList.map(t => t.postId)
                e.postList.forEach(t => {
                  // 既有组织删除了役職, 则将它加回去
                  if (!postIdList.includes(t.postId)) {
                    updateValue.sectionPostList.sectionList[sectionIndex].postList.push({ id: t.id, delete: true })
                  }
                })
              } else {
                // 如果之前的数组中不存在此条組織, 则将它加回去
                updateValue.sectionPostList.sectionList.push({ id: e.id, delete: true })
              }
            })

            // 所属长
            const bossIdList = updateValue.sectionPostList.bossSectionList.map(e => e.sectionId)
            this.sectionPostList_bak.orgJobConditions.companyList[0].bossSectionList.forEach(e => {
              if (!bossIdList.includes(e.sectionId)) {
                updateValue.sectionPostList.bossSectionList.push({ id: e.id, delete: true })
              }
            })

            // 役職
            const postIdList = updateValue.sectionPostList.postList.map(e => e.postId)
            this.sectionPostList_bak.orgJobConditions.companyList[0].postList.forEach(e => {
              if (!postIdList.includes(e.postId)) {
                updateValue.sectionPostList.postList.push({ id: e.id, delete: true })
              }
            })

            // 基点組織
            const baseIdList = updateValue.baseSectionList[0].sectionList.map(e => e.mgbsCsectionid)
            this.sectionPostList_bak.baseSectionList.length > 0 && this.sectionPostList_bak.baseSectionList[0].sectionList.forEach(e => {
              if (!baseIdList.includes(e.mgbsCsectionid)) {
                updateValue.baseSectionList[0].sectionList.push({ mgbsId: e.mgbsId, delete: true })
              }
            })
          }

          // 条件式による定義
          if (this.updateValue.baseFlag === '1') {
            updateValue.queryConditionList.some(e => {
              if (!e.columnname) return this.$Notice.warning({ title: '注意', desc: '定義内容が設定されていません。必ず1つ以上設定してください。', duration: 6.5 })
              if (!e.value && e.operator !== 'ISNULL' && e.operator !== 'ISNOTNULL') { return this.$Notice.warning({ title: '注意', desc: '比較がIS NULL,IS NOT NULLでない場合は必ず値を入力してください。', duration: 6.5 }) }
            })
            if (this.sectionPostList_bak.companyId && this.sectionPostList_bak.queryConditions.rowList.length > 0) {
              const queryIdList = updateValue.queryConditionList.map(e => e.id)
              this.sectionPostList_bak.queryConditions.rowList.forEach(e => {
                if (!queryIdList.includes(e.id)) {
                  updateValue.queryConditionList.push({ ...e, delete: true })
                }
              })
            }
          }

          // 社員選択による定義
          if (this.updateValue.baseFlag === '0') {
            if (updateValue.employList.length === 0) return this.$Notice.warning({ title: '注意', desc: '定義内容が設定されていません。必ず1つ以上設定してください。', duration: 6.5 })
            const empIdList = updateValue.employList.map(e => e.id)
            this.sectionPostList_bak.companyId && this.sectionPostList_bak.empList.empList.length > 0 && this.sectionPostList_bak.empList.empList.forEach(e => {
              if (!empIdList.includes(e.id)) {
                updateValue.employList.push({ ...e, delete: true })
              }
            })
          }
          try {
            this.drawLoading = true
            // const { data } = await this.http.post(`sys/groupmanager/update?psSite=${this.psSite}`, updateValue)
            console.log(updateValue)
            this.isShow = false
            this.sectionPostList_bak = {}
            // this.getData()
          } catch (error) {
            this.$Notice.error({ title: 'Error!', desc: error, duration: 6.5 })
          } finally {
            this.drawLoading = false
          }
        },
        sortTableByDrag(from, to) {
          this.hasDragTable = true
          this.$set(this.tableData, from, [this.tableData[to], this.tableData[to] = this.tableData[from]][0])
        },
        async sortingTableData() {
          try {
            this.sortingLoading = true
            const { data } = await this.http.post(`sys/groupmanager/sort?psSite=${this.psSite}`, this.tableData.map(e => e.mgId))
            this.$Message.success('優先順位更新完了')
            this.hasDragTable = false
            this.getData()
          } catch (error) {
          } finally {
            this.sortingLoading = false
          }
        },
        async deleteGroup(id) {
          try {
            const { data } = await this.http.post(`sys/groupmanager/delete?psSite=${this.psSite}`, [id])
            this.$Message.success('削除完了')
            this.getData()
          } catch (error) {
          } finally {
          }
        }
      }
    })
  </script>
</body>

</html>