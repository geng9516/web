<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='承認状況一覧',cssPaths='/pages/content.min.css')">
</head>

<body>
<div th:replace="layout/loadingBar::loadingBar"></div>
<main class="content permstatlist-warp" @scroll.passive="handleScroll" ref="layout">
    <div class="content_head">
        <div class="header">
            <div class="title1">
                <h1>
                    <Icon type="i-emeer colored"></Icon>
                    {{  '承認状況一覧' }}
                </h1>
            </div>
            <div class="btnbox">
                <span style="flex:1"></span>
                <i-button type="primary" @click="bulkApproval" size="large" :disabled="!approval" :loading="bulkApprovalLoading">月次一括承認</i-button>
                <!-- <div style="height:40px;margin:2px"></div> -->
            </div>
        </div>
        <div class="searchwrap">
            <span class="label">年月</span>
            <i-select v-model="model1" :disabled="!selectDisabled" class="mr30" @on-change="handleStartMonth($event)"
                      placeholder="選択ください">
                <i-option v-for="(item, index) of dispMonthlyList" :key="index" :label="item.val":value="item.val">
                </i-option>
            </i-select>
            <!-- 共通組織図画面 start-->
            <span style="display:flex;width: calc(15% + 200px);">
              <span class="label">所属</span>
              <i-button v-on:click.native="deptDrawShow = true" class="input-like-span mr30 cursor grey"
                        style="width: calc(100% - 120px);border-radius:0">
                {{ deptName }}
              </i-button>
              ​
              <Drawer class="tc" title="所属を選択してください" placement="right" width="700" :closable="false"
                      :mask-closable="!isSearchHistory" v-model="deptDrawShow">
                <div class="titlenorm mb5">
                  <Icon type="logo-buffer"></Icon>
                  所属
                </div>
                <Row class="tl mb5">
                  <i-col span="4" class="label tc" style="height: 32px;">基準日</i-col>
                  <i-col span="7" class="no-border-radius">
                    <date-picker type="date" :value="referListObject.txtTmgReferListTreeViewRecordDate" placeholder="基準日"
                                 format="yyyy/MM/dd" ref="datePicker" @on-change="handleDeptDateChange"></date-picker>
                  </i-col>
                  <i-col span="4" class="label ml5 tc" style="height: 32px;">ビュー選択</i-col>
                  <div style="display: inline-block;width: 32.5%;" class="no-border-radius">
                    <i-select v-model="selectedDeptViewType" @on-change="handleDeptViewTypeChange">
                      <i-option :value="2">グループごとに</i-option>
                      <i-option :value="3">部署ごとに</i-option>
                    </i-select>
                  </div>
                </Row>
                ​
                <div style="position: relative;">
                  <Tree class="tree mt2" :data="treeData" v-on:on-select-change="handleClickLeaf" ref="tree"
                        empty-text="所属データなし"></Tree>
                  <Spin size="large" fix v-if="empDeptLoading"></Spin>
                </div>
              </Drawer>
            </span>
            <!-- 共通組織図画面 end-->
            <span style="flex:1"></span>
        </div>
    </div>
    <div class="content_body">
        <div class="table-top">
            <Row :gutter="16">
                <Col span="11">
                <i-button type="text" @click="preMonthApproval" :disabled="!preMonthShow">
                    <Icon type="ios-arrow-back"></Icon>
                    前月
                </i-button>
                <i-button type="text" @click="nextMonthApproval" :disabled="!nextMonthShow">
                    翌月
                    <Icon type="ios-arrow-forward"></Icon>
                </i-button>
                </Col>
                <Col span="13" class="tr">
                <i-button type="primary" class="mr5" :disabled="!approval" ghost @click="handleSelectAll(false)">選択状態をクリア</i-button>
                <i-button type="primary" class="mr5" :disabled="!approval" ghost @click="handleSelectAll(true)">承認対象者を全選択</i-button>
                </Col>
            </Row>
        </div>
        <i-table class="long-table" border ref="selection" :columns="columns" :data="tableData" @on-select="tableSelect" @on-selection-change="tableSelectChange"
                 :disabled-hover="true" :loading="listLoading" no-data-text="教職員が存在している所属を選択して下さい。">
            <template slot-scope="{ row }" slot="name">
                    <span @click="toWorkPage"
                          class="mr10 pt2 pb2 pl10 pr10 cursor row-label-primary">{{ row.empname }}</span>
            </template>
            <template slot-scope="{ row }" slot="statusName">
                <span>{{ row.statusName }}</span>
            </template>

            <template v-for="item of slotList" slot-scope="{ row }" :slot="item">
                <span @click="showDay" v-if="row[item] === '未'" class="confirm-sytle ing">未</span>
                <span @click="showDay" v-if="row[item] === 'エ'" class="confirm-sytle undo">エ</span>
                <span @click="showDay" v-if="row[item] === '待'" class="confirm-sytle ing">待</span>
                <span @click="showDay" v-if="row[item] === '済'" class="confirm-sytle">済</span>
                <span @click="showDay" v-if="row[item] === '確'" class="confirm-sytle">確</span>
            </template>
        </i-table>
        <FormDrawer
                :isAdmin="true"
                title=""
                :isShow="isShow"
                @close="() => (this.isShow = false)"
        ></FormDrawer>
        <Drawer :title="title" width="1200" v-model="showDayApply" draggable>
            <Row :gutter="16" class="mb10">
                <Col span="13" offset="11" class="tr">
                <i-button type="primary" size="large" class="mr5" :disabled="!drawApproval" ghost @click="handleSelectAll2(false)">
                    選択状態をクリア
                </i-button>
                <i-button type="primary" size="large" class="mr5" :disabled="!drawApproval" ghost @click="handleSelectAll2(true)">
                    承認対象者を全選択
                </i-button>
                <i-button type="primary" size="large"  :disabled="!drawApproval" :loading="bulkApprovalLoading2" class="tr" @click="bulkApproval2">一括承認</i-button>
                </Col>
            </Row>
            <i-table border :columns="columns2" :data="tableData2" @on-select="tableSelect2" @on-selection-change="tableSelectChange2" ref="selection2">
                <template v-for="(item, i) of slotList2" slot-scope="{ row }" :slot="item">
                        <span v-if="i === 0">
                            <span @click="showDay" v-if="row[item] === '未'" class="confirm-sytle ing">未</span>
                            <span @click="showDay" v-if="row[item] === 'エ'" class="confirm-sytle undo">エ</span>
                            <span @click="showDay" v-if="row[item] === '待'" class="confirm-sytle ing">待</span>
                            <span @click="showDay" v-if="row[item] === '済'" class="confirm-sytle">済</span>
                            <span @click="showDay" v-if="row[item] === '確'" class="confirm-sytle">確</span>
                        </span>
                    <span v-else>{{ row[item] }}</span>
                </template>
            </i-table>
        </Drawer>
    </div>
</main>

<div th:replace="layout/script::common_script"></div>
<script type="text/babel" th:inline="javascript">
    // const aliyun = "https://1615100189492697.ap-northeast-1.fc.aliyuncs.com/2016-08-15/proxy/api-dellen/test-func"
    const PERM_STATLIST = new Vue({
        el: '.permstatlist-warp',
        data() {
            return {
                curDate: new Date(),
                tableHead: [],
                tableData: [],
                slotList: Utils.getNumArray(1, 31).map(e => `disppermStatusName${e}`),
                slotList2: Utils.getNumArray(1, 13).map(e => `COLUMNID${e}`),
                dailyShow: true,
                rawData: [],
                isShow: false,
                showPre: true,
                listLoading: false,
                showDayApply: false,
                emplistLoading: false,
                referListObject: {
                    [[${ TREEVIEW_KEY_PERM_TARGET_SECTION }]]: '',
                    [[${ TREEVIEW_KEY_PERM_TARGET_EMP }]]: '',
                    [[${ TREEVIEW_KEY_PERM_TARGET_GROUP }]]: '',
                    [[${ TREEVIEW_KEY_RECORD_DATE }]]: '',
                    txtTmgReferListTreeViewRecordDate: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    type: 21
                },
                empTreeData: [],
                defaultDeptId: '',
                deptName: '選んでください',
                query: {
                    txtAction: 'ACT_DISP_MONTHLY',
                    txtDYYYYMM: '',
                    txtDYYYYMMDD: '',
                    txtCallBeanAction: 'ACT_DISP_MONTHLY',
                    txtTmgReferListTreeViewRecordDate: '',
                    txtTmgReferListTreeViewPermTargetSection: '',
                    txtTmgReferListTreeViewPermTargetGroup: '',
                    txtTmgReferListTreeViewPermTargetEmp: '',
                    txtTmgReferListTreeViewPermSelectedView: 'section',
                    txtCEMPLOYEEID: '',
                    // sectionid: '',
                    txtExecuteEmpId: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp')
                    // type: 21
                },

                treeData: [],
                selectDisabled: false,   　//年月選択可否制御
                dispMonthlyList: [],       //年月リスト
                model1: '',
                approval: false,
                drawApproval: false,

                title: '',
                tableHead2: [],
                tableData2: [],
                empIds: [],
                empIds2: [],

                bulkApprovalLoading: false,
                bulkApprovalLoading2: false,

                thisMonth: '',
                preMonth: '',
                nextMonth: '',
                preMonthShow: false,
                nextMonthShow: false,

                isSearchHistory: false,
                selectedDeptViewType: 3, //組織ツリー用
                empDeptLoading: false,
                deptDrawShow: false,
            }
        },
        async mounted() {
            this.getOrgTree()
            this.getTableHead()
        },
        computed: {
            tableHeadFixed() {
                if (this.contentScrollTop > 300) return true
                else return false
            },
            columns() {
                let result = [
                    {
                        title: '氏名',
                        slot: 'name',
                        minWidth: 100,
                        align: 'right'
                    },
                    {
                        title: '月次\n承認',
                        slot: 'statusName',
                        minWidth: 36,
                        align: 'center'
                    }
                ]
                const that = this
                this.tableHead.forEach((e, i) => {
                    result = result.concat({
                        // title: e,
                        className: e.tcaCholflg.indexOf('1') > -1 || e.tcaCholflg.indexOf('2') > -1 || e.tcaCholflg.indexOf('3') > -1 ? 'rest' : '',
                        minWidth: 25,
                        renderHeader: (h, params) => {
                            return h(
                                'span',
                                {
                                    style: {
                                        cursor: 'pointer',
                                    },
                                    domProps: {
                                        className: 'table-head',
                                        innerHTML: e.name,
                                    },
                                    on: {
                                        click(){
                                            that.handleClickHead(e.day)
                                        },
                                    },
                                }
                            )
                        },
                        slot: `disppermStatusName${i + 1}`,
                        align: 'center'
                    })
                })
                result = result.concat({
                    type: 'selection',
                    width: 60,
                    align: 'center'
                })
                return result
            },
            columns2() {
                let result = []
                const that = this
                this.tableHead2.forEach((e, i) => {
                    result = result.concat({
                        minWidth: 25,
                        renderHeader: (h, params) => {
                            return h(
                                'span',
                                {
                                    style: {
                                        cursor: 'pointer',
                                    },
                                    domProps: {
                                        className: 'table-head',
                                        innerHTML: e.mgdCheader,
                                    }
                                }
                            )
                        },
                        slot: `COLUMNID${i + 1}`,
                        align: 'center'
                    })
                })
                result = result.concat({
                    type: 'selection',
                    width: 60,
                    align: 'center'
                })
                return result
            }
        },
        methods: {
            async getDispTmgMonthlyList() {
                this.query.txtAction = 'ACT_DISP_MONTHLY'
                const { data } = await this.http.get('sys/permStatList/dispTmgMonthlyList', this.query)
                this.dispMonthlyList = data

                if (data.length > 0){
                    this.model1 = data[0].val

                    let result = this.model1.replace("年","/")
                    result = result.replace("月","/")
                    result = result + "01"
                    this.query.txtDYYYYMM = result

                    this.thisMonth = result
                    this.preNextMonth(data[0].val)

                    //年月リストを取得する時に、活性化にする
                    this.selectDisabled = true
                }

                //年月リスト.lengthがゼロ場合、非活性化にする
                if (data.length === 0){
                    this.model1 = ''
                    this.selectDisabled = false
                    this.preMonthShow = false
                    this.nextMonthShow = false
                }
            },
            async getTableHead() {
                this.query.txtAction = 'ACT_DISP_MONTHLY'
                const { data } = await this.http.get('sys/permStatList/selectDayHead', this.query)
                this.tableHead = data
            },
            async getTableData() {
                this.listLoading  = true
                const { data } = await this.http.get('sys/permStatList/getTmgMonthlyInfoVOList', this.query)
                this.tableData = data.tmgMonthlyInfoVOList
                this.approval = data.approval
                this.listLoading  = false
                this.isSearchHistory = false
            },
            async getTmgMonthlyInfoVOList() {
                this.query.txtAction = 'ACT_DISP_MONTHLY'

                const { data } = await this.http.get('sys/permStatList/getTmgMonthlyInfoVOList', this.query)
                this.tableData = data
            },
            async getOrgTree(refreshDept) {
                this.empDeptLoading = true
                try {
                    const { groupList, sectionList, recordDate } = await this.http.get('sys/tree', this.referListObject)
                    // 先将数据转为标准格式，再转为可用数据
                    if (this.selectedDeptViewType === 3) {
                        this.treeData = Utils.convertTreeData(sectionList)
                    }
                    if (this.selectedDeptViewType === 2) {
                        this.treeData = Utils.convertTreeData(groupList)
                    }
                    this.referListObject.txtTmgReferListTreeViewRecordDate = recordDate
                } catch (error) {
                    return
                } finally {
                    this.empDeptLoading = false
                }
            },
            async handleDeptDateChange(e) {
                this.referListObject.txtTmgReferListTreeViewRecordDate = e
                this.isSearchHistory = true
                await this.getOrgTree()
                this.$Notice.warning({ title: '所属図更新完了', desc: "下記の所属リストから対象を選んでください" })
            },
            async preMonthApproval() {
                console.log("preMonthApproval")
                console.log(this.preMonth)
                this.query.txtDYYYYMM = this.dateFormat(this.preMonth)
                await this.getTableHead()
                await this.getTableData()
                this.model1 = this.preMonth
                this.preNextMonth(this.preMonth)
            },
            async nextMonthApproval() {
                this.query.txtDYYYYMM = this.dateFormat(this.nextMonth)
                await this.getTableHead()
                await this.getTableData()
                this.model1 = this.nextMonth
                this.preNextMonth(this.nextMonth)
            },
            preNextMonth(e) {
                console.log("preNextMonth_s")
                console.log(this.dispMonthlyList.length)
                console.log(e)
                for (var i=0;i < this.dispMonthlyList.length;i++){
                    if (e===this.dispMonthlyList[i].val) {
                        if (i===0){
                            this.preMonthShow = true
                            this.nextMonthShow = false

                            this.preMonth = this.dispMonthlyList[i+1].val
                            this.nextMonth = ''
                            break

                        } else if (i===this.dispMonthlyList.length-1) {

                            this.preMonthShow = false
                            this.nextMonthShow = true

                            this.preMonth = ''
                            this.nextMonth = this.dispMonthlyList[i-1].val
                            break
                        } else {
                            this.preMonthShow = true
                            this.nextMonthShow = true

                            this.preMonth = this.dispMonthlyList[i+1].val
                            this.nextMonth = this.dispMonthlyList[i-1].val
                            break
                        }
                    }
                }
                console.log(this.preMonth)
                console.log(this.nextMonth)
                console.log("preNextMonth_e")
            },
            rowClass(row) {
                // 表格变色
                if (!row.dayDivisionCode || row.dayDivisionCode === '1') {
                    return ''
                }
                return 'sat'
            },
            handleScroll: Throttle(function (e) {
                this.contentScrollTop = e.target.scrollTop
                if (e.target.scrollTop > 200) {
                    this.isScroll = true
                } else {
                    this.isScroll = false
                }
            }, 50),
            showDay: Debounce(function () {
                this.isShow = true
            }),
            toTop() {
                const animateMachine = requestAnimationFrame(this.toTop)
                this.$refs.layout.scrollTop = this.$refs.layout.scrollTop - this.$refs.layout.scrollTop / 5
                if (this.$refs.layout.scrollTop === 0) {
                    cancelAnimationFrame(animateMachine)
                }
            },
            convertTreeData(treeData = []) {
                return treeData.map(e => {
                    const children = e.child || e.children
                    if (children) {
                        return {
                            ...e.data,
                            title: e.data.label,
                            // 前两层级默认展开方便查看
                            expand: e.data.level < 2 || !e.data.level,
                            children: this.convertTreeData(children)
                        }
                    } else {
                        return {
                            ...e.data,
                            title: e.data.label
                        }
                    }
                })
            },
            showDay() {
                //todo: 跳到详情页
                location.href = "./VacationTablePanel/vacationtablepanel.html";
            },
            handleSelector() { },
            async handleClickLeaf(e) {
                //同一部署を二回目でクリックすると、取消とするためで、エラーあり
                //よって、二回目クリックすると、何もしない
                if(!e[0]) return

                console.log('e2')
                console.log(e)
                this.deptDrawShow = false

                this.query.txtAction = 'ACT_DISP_MONTHLY'

                if (this.selectedDeptViewType === 3) {
                    this.deptName = e[0].label
                }
                if (this.selectedDeptViewType === 2) {
                    this.deptName = e[0].secnic
                }

                this.query.txtTmgReferListTreeViewPermTargetSection = e[0].secid
                this.query.txtTmgReferListTreeViewPermTargetGroup = e[0].groupid
                this.query.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate


                //年月リストの取得
                await this.getDispTmgMonthlyList()

                await this.getTableHead()
                await this.getTableData()

            },
            async getEmpList() {
                try {
                    this.emplistLoading = true
                    const { data } = await this.http.get('sys/tree/admin/emplist', this.referListObject)
                    this.empTreeData = Utils.convertTreeData(Utils.convertToData(data))
                } catch (error) {
                    return
                } finally {
                    this.emplistLoading = false
                }
            },
            handleClickEmpLeaf(e) {
                this.deptDrawShow = false
                // this.getData(true)
            },
            showName(e) {
                const result = e.match(/^[\s\S]+(?=\()/g)
                return (result && result[0]) || e
            },
            async handleClickHead(e) {
                console.log(e)
                this.query.txtAction = 'ACT_EDIT_DAIRY'
                this.query.txtDYYYYMMDD = e
                this.query.txtCallBeanAction = 'ACT_DISP_MONTHLY'

                this.title = "承認状況 " + Utils.formatDate(e, 'yyyy年m月d日')

                this.getReadTmgDaily()
                this.showDayApply = true

                //選択した職員リストをクリアする
                this.handleSelectAll2(false)
                console.log("this.handleClickHead")
                console.log(this.tableHead2)
                console.log(this.tableData2)
            },
            async getReadTmgDaily() {

                const { data } = await this.http.get('sys/permStatList/getReadTmgDaily', this.query)

                //日別詳細画面のボタンを制御
                this.drawApproval = data.approval

                this.tableHead2 = data.itemVOList
                this.tableData2 = data.tmgDailyMapList
            },
            toWorkPage() {
                // this.$router.push('/sys/confirmer/applyWork')
            },
            handleSelectAll(status) {
                this.$refs.selection.selectAll(status)
            },
            //行が選択される場合、トリガーされる
            tableSelect(selection, row) {
                console.log("tableSelect")
                console.log(selection)
                console.log(row)
            },
            //選択した行の状態が変わる場合、トリガーされる
            tableSelectChange(selection, row) {
                console.log("tableSelectChange")
                console.log(selection)

                this.empIds = []
                for (var i=0;i < selection.length;i++){
                    this.empIds.push(selection[i].empid)
                }
                this.query.txtExecuteEmpId = this.empIds.join(',')
                console.log(this.query.txtExecuteEmpId)

            },

            //行が選択される場合、トリガーされる
            tableSelect2(selection, row) {
                console.log("tableSelect")
                console.log(selection)
                console.log(row)
            },
            //選択した行の状態が変わる場合、トリガーされる
            tableSelectChange2(selection, row) {
                console.log("tableSelectChange2")
                console.log(selection)

                this.empIds2 = []
                for (var i=0;i < selection.length;i++){
                    this.empIds2.push(selection[i].TDA_CEMPLOYEEID)
                }
                this.query.txtExecuteEmpId = this.empIds2.join(',')
                console.log(this.query.txtExecuteEmpId)

            },
            handleSelectAll2(status) {
                this.$refs.selection2.selectAll(status)
            },
            handleStartMonth(e) {
                console.log("handleStartMonth")
                if(e){
                    this.query.txtDYYYYMM = this.dateFormat(e)
                    this.getTableHead()
                    this.getTableData()
                    this.preNextMonth(e)
                }
            },
            async bulkApproval(e) {
                this.query.txtAction = 'ACT_MONTHLY_PERMIT'
                this.query.txtCallBeanAction = 'ACT_DISP_MONTHLY'

                //月次一括承認Loading制御
                this.bulkApprovalLoading = true

                console.log("bulkApproval")
                console.log(this.empIds)
                console.log(this.empIds.length)

                if (this.empIds.length === 0){
                    this.$Message.error("月次一括承認の対象者が選択されていません")
                    //月次一括承認Loading制御
                    this.bulkApprovalLoading = false

                } else {
                    this.$Modal.confirm({
                        title: '',
                        content: 'チェックされた職員の月次就業実績を承認しますか。よろしいでしょうか？',
                        okText: 'OK',
                        cancelText: 'キャンセル',
                        onOk: async () => {
                            const { data } = await this.http.get('sys/permStatList/executeUpdateTmgMonthly', this.query)

                            //月次承認状況一覧検索処理
                            await this.getTableData()

                            //月次一括承認Loading制御
                            this.bulkApprovalLoading = false
                        },
                        onCancel: () => {
                            //選択した職員リストをクリアする
                            this.handleSelectAll(false)

                            //月次一括承認Loading制御
                            this.bulkApprovalLoading = false
                            console.log(this.empIds)

                        }
                    })
                }
            },
            async bulkApproval2(e) {
                this.query.txtAction = 'ACT_EDIT_DAIRY'
                this.query.txtCallBeanAction = 'ACT_DISP_MONTHLY'

                //月次一括承認Loading制御
                this.bulkApprovalLoading2 = true

                console.log("bulkApproval2")
                console.log(this.empIds2)
                console.log(this.empIds2.length)

                if (this.empIds2.length === 0){
                    this.$Message.error("日次一括承認の対象者が選択されていません")
                    //日次一括承認Loading制御
                    this.bulkApprovalLoading2 = false

                } else {
                    this.$Modal.confirm({
                        title: '',
                        content: 'チェックされた職員の日次就業実績を承認しますか。よろしいでしょうか？',
                        okText: 'OK',
                        cancelText: 'キャンセル',
                        onOk: async () => {
                            const { data } = await this.http.get('sys/permStatList/executeUpdateTmgDaily', this.query)

                            //日次承認状況一覧検索処理
                            this.getReadTmgDaily()

                            //月次承認状況一覧検索処理
                            await this.getTableData()

                            //日次一括承認Loading制御
                            this.bulkApprovalLoading2 = false
                        },
                        onCancel: () => {
                            //選択した職員リストをクリアする
                            this.handleSelectAll2(false)

                            //日次一括承認Loading制御
                            this.bulkApprovalLoading2 = false
                            console.log(this.empIds2)
                        }
                    })
                }
            },
            dateFormat(e) {
                //YYYY年MM月からYYYY/MM/01へ変換する
                let yearMMDD = e.replace("年","/")
                yearMMDD = yearMMDD.replace("月","/")
                yearMMDD = yearMMDD+"01"
                return  yearMMDD
            },
            async handleDeptViewTypeChange() {
                await this.getOrgTree()
                if (this.selectedDeptViewType === 3) {
                    this.query.txtTmgReferListTreeViewPermSelectedView = 'section'
                }
                if (this.selectedDeptViewType === 2) {
                    this.query.txtTmgReferListTreeViewPermSelectedView = 'group'
                }
                console.log("handleDeptViewTypeChange")
                console.log(this.query.txtTmgReferListTreeViewPermSelectedView)
                this.$Notice.success({ title: '所属図更新完了' })
            },
        }
    })
</script>
</body>

</html>