<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='承認状況一覧',cssPaths='/pages/content.min.css')">
</head>

<body>
<div th:replace="layout/loadingBar::loadingBar"></div>
<style>
    .table-head:hover {
        text-decoration: underline;
    }
</style>
<!-- 菜单导航栏 -->
<div th:replace="layout/sider"></div>
<main class="content permstatlist-warp" @scroll.passive="handleScroll" ref="layout">
    <div class="content_head">
        <div class="header">
            <div class="title1">
                <h1>
                    <Icon type="i-emeer colored"></Icon>
                    {{  '承認状況一覧' }}
                </h1>
            </div>
            <div class="btnbox">
                <span style="flex:1"></span>
                <i-button type="primary" icon="md-done-all" @click="bulkApproval" :loading="bulkApprovalLoading" v-if="approval">月次一括承認</i-button>
                <i-button icon="md-done-all" disabled v-else>月次一括承認</i-button>
            </div>
        </div>
        <div class="searchwrap">
            <span class="label">年月</span>
            <i-select v-model="model1" :disabled="!selectDisabled" class="mr30" @on-change="handleStartMonth($event)"
                      placeholder="選択ください">
                <i-option v-for="(item, index) of dispMonthlyList" :key="index" :label="item.val":value="item.val">
                </i-option>
            </i-select>
            <!-- 共通組織図画面 start-->
            <span style="display:flex;width: calc(15% + 200px);">
              <span class="label">所属</span>
              <i-button v-on:click.native="deptDrawShow = true" class="input-like-span dept-select">
                <Tooltip trigger="hover" :theme="toolTipTheme()" transfer>{{deptName}}
                    <div slot="content">{{deptName}}</div>
                </Tooltip>
             </i-button>
              <Drawer class="tc" placement="right" width="700" :closable="false"
                      :mask-closable="!isSearchHistory" v-model="deptDrawShow">
                <Tabs v-model="currentTab" :animated="false">
                     <tab-pane label="ツリー" name="organisationTree">
                        <div class="titlenorm mb5">
                              <Icon type="logo-buffer"></Icon>
                              所属
                        </div>
                        <Row class="tl mb5">
                              <i-col span="4" class="label tc" style="height: 32px;">基準日</i-col>
                              <i-col span="7" class="no-border-radius">
                                <date-picker type="date" :value="referListObject.txtTmgReferListTreeViewRecordDate" :options="startLimit" placeholder="基準日" :clearable="false" transfer
                                             format="yyyy/MM/dd" ref="datePicker" @on-change="handleDeptDateChange"></date-picker>
                              </i-col>
                              <i-col span="4" class="label ml5 tc" style="height: 32px;">ビュー選択</i-col>
                              <div style="display: inline-block;width: 32.5%;" class="no-border-radius">
                                    <i-select v-model="selectedDeptViewType" @on-change="handleDeptViewTypeChange" transfer>
                                      <i-option value="all">全て</i-option>
                                      <i-option value="group">グループごとに</i-option>
                                      <i-option value="section">部署ごとに</i-option>
                                    </i-select>
                              </div>
                        </Row>
                        <div style="position: relative;">
                              <Tree class="tree mt2" :data="treeData" v-on:on-select-change="handleClickLeaf" ref="tree"
                                    :empty-text="selectedDeptViewType === 'all' ? '全て表示中' : '所属データなし'"></Tree>
                              <Spin size="large" fix v-if="empDeptLoading"></Spin>
                        </div>
                      </tab-pane>
                       <tab-pane label="検索" name="organisationSearch">
                                <Row class="tl mb2" :gutter="8">
                                    <i-col span="15">
                                        <i-input v-model="referListObject.hidSearchData" @on-search="handleClickEmpLeaf"
                                                 class="mar mb5 like-select" search enter-button placeholder="検索">
                                            <i-select v-model="referListObject.hidSearchItems" slot="prepend" style="width: 108px"
                                                      placeholder="項目" transfer>
                                                <i-option v-for="(item,i) of searchTypesList" :value="item.value">
                                                    {{ item.name }}</i-option>
                                            </i-select>
                                            <i-select v-model="referListObject.hidSearchCondition"  slot="append"
                                                      style="width: 108px" placeholder="条件" transfer>
                                                <i-option v-for="(item,i) of searchConditionsList" :value="item.value">
                                                    {{ item.name }}</i-option>
                                            </i-select>
                                        </i-input>
                                    </i-col>
                                    <i-col span="8" class="no-border-radius">
                                        <i-button long type="primary" icon="md-search" ghost :loading="empDeptLoading" @click="handleClickEmpLeaf">検索</i-button>
                                    </i-col>
                                </Row>
                      </tab-pane>
                      <Alert class="primary-info mt10">※検索結果の上位100件を表示しています。</Alert>
                </Tabs>
              </Drawer>
            </span>
            <!-- 共通組織図画面 end-->
            <span style="flex:1"></span>
        </div>
    </div>
    <div class="content_body">
        <div class="table-top">
            <Row :gutter="16">
                <!--                <i-col span="11">-->
                <!--                    <i-button :disabled="!preMonthShow" @click="preMonthApproval" type="text">-->
                <!--                        <Icon type="ios-arrow-back"></Icon>-->
                <!--                        前月-->
                <!--                    </i-button>-->
                <!--                    <i-button :disabled="!nextMonthShow" @click="nextMonthApproval" type="text">-->
                <!--                        翌月-->
                <!--                        <Icon type="ios-arrow-forward"></Icon>-->
                <!--                    </i-button>-->
                <!--                </i-col>-->
                <i-col class="tr">
                    <i-button :disabled="!approval" @click="handleSelectAll(false)" class="mr5" ghost type="primary">選択状態をクリア</i-button>
                    <i-button :disabled="!approval" @click="handleSelectAll(true)" class="mr5" ghost type="primary">承認対象者を全選択</i-button>
                </i-col>
            </Row>
        </div>
        <Alert class="primary-info tl" v-show="this.tableData.length>0">※日付をクリックすると、一括承認画面を表示します。※承認ステータスをクリックすると、就業承認コンテンツを表示します。</Alert>
        <i-table class="long-table" border ref="selection" :columns="columns" :data="tableData" @on-select="tableSelect" @on-selection-change="tableSelectChange" :row-class-name="() => 'select-col'"
                 :disabled-hover="true" :loading="listLoading" no-data-text="">
            <template slot-scope="{ row }" slot="name">
                <span>{{ row.empname }}</span>
            </template>
            <template slot-scope="{ row }" slot="statusName">
                <span>{{ row.statusName }}</span>
            </template>

            <template v-for="item of slotList" slot-scope="{ row }" :slot="item">
                <span @click="showDay(row.empid,item,row.tmoCstatusflg)" class="cursor confirm-sytle ing" v-if="row[item] === '未'">未</span>
                <span @click="showDay(row.empid,item,row.tmoCstatusflg)" class="cursor confirm-sytle undo" v-if="row[item] === 'エ'">エ</span>
                <span @click="showDay(row.empid,item,row.tmoCstatusflg)" class="cursor confirm-sytle ing" v-if="row[item] === '待'">待</span>
                <span @click="showDay(row.empid,item,row.tmoCstatusflg)" class="cursor confirm-sytle" v-if="row[item] === '済'">済</span>
                <span @click="showDay(row.empid,item,row.tmoCstatusflg)" class="cursor confirm-sytle rest" v-if="row[item] === '確'">確</span>
            </template>
        </i-table>
        <Drawer :title="title" v-model="showDayApply" width="97">
            <Row :gutter="16" class="mb10">
                <i-col class="tr" offset="11" span="13">
                    <i-button :disabled="!drawApproval" @click="handleSelectAll2(false)" class="mr5" ghost type="primary">
                        選択状態をクリア
                    </i-button>
                    <i-button :disabled="!drawApproval" @click="handleSelectAll2(true)" class="mr5" ghost type="primary">
                        承認対象者を全選択
                    </i-button>
                    <i-button :disabled="!drawApproval" :loading="bulkApprovalLoading2"  @click="bulkApproval2" class="tr" type="primary">一括承認</i-button>
                </i-col>
            </Row>
            <i-table border :columns="columns2" :loading="sublistLoading" :data="tableData2" @on-select="tableSelect2" @on-selection-change="tableSelectChange2" :row-class-name="() => 'select-col'" ref="selection2">
                <template v-for="(item, i) of slotList2" slot-scope="{ row }" :slot="item">
                        <span v-if="i === 0">
                            <span class="confirm-sytle ing" v-if="row[item] === '未'">未</span>
                            <span class="confirm-sytle undo" v-if="row[item] === 'エ'">エ</span>
                            <span class="confirm-sytle ing" v-if="row[item] === '待'">待</span>
                            <span class="confirm-sytle" v-if="row[item] === '済'">済</span>
                            <span class="confirm-sytle rest" v-if="row[item] === '確'">確</span>
                        </span>
                    <span v-else>{{ row[item] | turnLine | whiteSpace}}</span>
                </template>
            </i-table>
        </Drawer>

        <!--日次就業実績-->
        <Drawer :mask-closable="false" :title="title" @on-close="handleClose()" v-model="isShow" width="850">
            <div style="position: relative">
                <Alert class="error-info" type="error" v-show="errorFlag">{{ errorMsg }}</Alert>
                <div class="mb10">
                    <Row :gutter="10">
                        <i-col span="8">
                            <div class="label pl10">所属</div>
                            <div class="person-info">{{ privateInfo.deptName }}</div>
                        </i-col>
                        <i-col span="8">
                            <div class="label pl10">氏名</div>
                            <div class="person-info">{{ privateInfo.name }}</div>
                        </i-col>
                        <i-col span="8">
                            <div class="label pl10">種別</div>
                            <div class="person-info">{{ privateInfo.workType }}</div>
                        </i-col>
                    </Row>
                </div>
                <div class="mb10 tr">
                    <div v-if="!bFixed">
                        <i-button type="error" ghost  class="mr10" @click="updateRemandsStatus" icon="md-hand" :loading="deleteDailyLoading" v-if="notapproval">
                            差戻
                        </i-button>
                        <i-button type="primary" ghost  @click="updateDaily"　icon="md-done-all" :loading="updateDailyLoading" v-if="!notapproval">
                            承認
                        </i-button>
                        <i-button type="primary" ghost  @click="updateDaily"　icon="md-done-all" :loading="updateDailyLoading" v-if="notapproval">
                            承認
                        </i-button>
                    </div>
                    <div v-else>
                        <i-button disabled>
                            承認
                        </i-button>
                    </div>
                </div>
                <div class="titlenorm mb10">
                    <Icon type="logo-buffer"></Icon>
                    就業実績
                </div>
                <div class="mb15" style="position: relative;">
                    <Row>
                        <i-col class="label tc" span="8">就業区分</i-col>
                        <i-col class="no-border-radius" span="8">
                            <i-select @on-change="changeWorkingID" class="mr30" ref="select1" v-if="!bHoliday && !bFixed"
                                      v-model="workingId">
                                <i-option :key="index" :label="item.mgdCgenericdetaildesc"
                                          v-for="(item, index) of workingIdList" 　:value="item.mgdCmastercode">
                                </i-option>
                            </i-select>
                            <p class="input-like-span tc"  v-else>{{dailyEdit.tdaCworkingidRName}}</p>
                        </i-col>
                    </Row>
                    <Row class="mb5">
                        <i-col class="label tc" span="8">出張</i-col>
                        <i-col class="no-border-radius" span="8" v-if="!bDisable">
                            <i-select @on-change="" class="mr30"
                                      ref="select2" v-if="(!bHoliday && !bFixed)" v-model="businessTrip">
                                <i-option :key="index" :label="item.mgdCgenericdetaildesc"
                                          v-for="(item, index) of businessTripList" 　:value="item.mgdCmastercode">
                                </i-option>
                            </i-select>
                            <p class="input-like-span tc" v-else>{{dailyEdit.tdaCbusinesstripidRName}}</p>
                        </i-col>
                        <i-col class="no-border-radius" span="8" v-else>
                            <i-select @on-change="" class="mr30" disabled v-if="(!bHoliday && !bFixed)"
                                      v-model="businessTrip">
                                <i-option :key="index" :label="item.mgdCgenericdetaildesc"
                                          v-for="(item, index) of businessTripList" 　:value="item.mgdCmastercode">
                                </i-option>
                            </i-select>
                            <p class="input-like-span tc" v-else>{{dailyEdit.tdaCbusinesstripidRName}}</p>
                        </i-col>
                    </Row>
                    <i-table :columns="columnsWork" :data="workData" :span-method="handleSpan" :disabled-hover="true">
                        <template slot="workStart" slot-scope="{ row, index }">
                            <div v-if="row.isInput && bFixed" >
                                <span class="input-like-span tc" style="border-radius: 5px; white-space: pre-line;">{{ row.workStart }}</span>
                            </div>
                            <div  v-if="row.isInput && !bFixed" >
                                <i-input :disabled="workTimeDisable" @on-blur="handleInputChange(index,  workData[index],'workStart', $event.target)" class="tc" v-model="workData[index].workStart"></i-input>
                            </div>


                            <!-- 本人comment -->
                            <span class="tl input-like-span" style="border-radius: 5px; white-space: pre-line;" v-if="row.isOwnComment"  >{{ dailyEdit.tdaCowncommentR}}</span>

                            <!-- 承认者comment -->
                            <i-input class="tl" type="textarea" v-if="row.isBSComment  && !bFixed" v-model="dailyEdit.tdaCbosscommentR">
                            </i-input>
                            <span  class="tl input-like-span" style="border-radius: 5px; white-space: pre-line;" v-if="row.isBSComment  && bFixed">
                                {{dailyEdit.tdaCbosscommentR}}
                              </span>

                            <span class="bs-comment-approved" v-if="row.isBSComment && bApproved">{{ dailyEdit.tdaCmodifieruseridR}} ({{dailyEdit.tdaDmodifieddateR }})</span>

                            <span v-if="!row.isInput">{{ row.workStart }}</span>
                        </template>
                        <template slot="workEnd" slot-scope="{ row, index }">
                            <div v-if="row.isInput && bFixed" >
                                <span class="input-like-span tc" style="border-radius: 5px; white-space: pre-line;">{{ row.workEnd }}</span>
                            </div>
                            <div v-if="row.isInput && !bFixed" >
                                <i-input :disabled="workTimeDisable" @on-blur="handleInputChange(index, workData[index],'workEnd', $event.target)" class="tc" v-model="workData[index].workEnd"></i-input>
                            </div>
                            <span v-if="!row.isInput">{{ row.workEnd }}</span>
                        </template>
                    </i-table>
                </div>

                <!-- 非勤務 -->
                <div class="titlenorm mb10">
                    <Icon type="logo-buffer"></Icon>
                    非勤務
                </div>
                <div class="mb15 tr" v-if="!bHoliday && !bFixed ">
                    <i-select class="mr10" ref="select3" style="display: inline-block;width: 200px;" v-if="!bDisable && categoryNondutyList.length>0 " v-model="categoryNonduty">
                        <i-option :key="index" :label="item.itemName" :value="item.itemCode" v-for="(item, index) of categoryNondutyList">
                        </i-option>
                    </i-select>
                    <!--                    <p class="input-like-span tc" v-else>{{categoryNonduty}}</p>-->
                    <i-button @click="addNotWork" ghost type="primary" v-if="!bDisable">追加</i-button>
                    <i-button  disabled v-else>追加</i-button>
                </div>

                <i-table :columns="columnsNotWork" :data="detailNonDutyVOList" class="mb20" :disabled-hover="true"
                         no-data-text="">
                    <template slot="tdadNopen" slot-scope="{ row, index }">
                        <i-input @on-blur="handleInputChange(index, detailNonDutyVOList[index],'tdadNopen', $event.target)" v-if=" !bFixed" v-model="detailNonDutyVOList[index].tdadNopen"></i-input>
                        <span v-else>{{  row.tdadNopen | toTime  }}</span>
                    </template>

                    <template slot="tdadNclose" slot-scope="{ row, index }">
                        <i-input @on-blur="handleInputChange(index, detailNonDutyVOList[index],'tdadNclose', $event.target)" v-if="!bFixed " v-model="detailNonDutyVOList[index].tdadNclose"></i-input>
                        <span v-else>{{ row.tdadNclose | toTime }}</span>
                    </template>

                    <template slot="tdadCsparechar1" slot-scope="{ row ,index}">
                        <i-input :autosize="{ maxRows: 3 }" type="textarea"
                                 v-if="row.tdadCnotworkid !== 'TMG_ITEMS|ResultRest' && !bFixed "
                                 v-model="detailNonDutyVOList[index].tdadCsparechar1"></i-input>
                        <span v-else>{{ row.tdadCsparechar1 | toTime }}</span>
                    </template>

                    <template slot="tdadNdeleteflg" slot-scope="{ row }" v-if="!bFixed">
                        <Poptip placement="left" transfer v-model="lightDelBtnVisible2[row._index]">
                            <div class="operateBtn" slot="content">
                                <a @click="cancelNotWork(row._index)">いいえ</a>
                                <a @click="delNotWork(row, row._index)">はい</a>
                            </div>
                            <i-button ghost size="small" style="position: relative;left: 3px;width: 60px;" type="error">削除</i-button>
                        </Poptip>
                    </template>
                </i-table>

                <div v-if="!isDiscretion">
                    <!-- 超過勤務 -->
                    <div class="titlenorm mb10">
                        <Icon type="logo-buffer"></Icon>
                        超過勤務
                    </div>
                    <div class="mb15 tr" v-if="!bHoliday && !bFixed ">
                        <i-select @on-change="" class="mr10" ref="select4" style="display: inline-block;width: 200px;" v-if="!bDisable && categoryOverhoursList.length>0 " v-model="categoryOverhours">
                            <i-option :key="index" :label="item.itemName" :value="item.itemCode" v-for="(item, index) of categoryOverhoursList">
                            </i-option>
                        </i-select>
                        <!--                        <p class="input-like-span tc" v-else>{{categoryOverhours}}</p>-->
                        <i-button @click="addOverWork" ghost type="primary" v-if="!bDisable">追加</i-button>
                        <i-button disabled v-else>追加</i-button>
                        <!--                <i-col span="4">-->
                        <!--                    <i-button type="primary" ghost v-if="!bDisable">時刻補完</i-button>-->
                        <!--                    <i-button type="primary" ghost disabled v-else>時刻補完</i-button>-->
                        <!--                </i-col>-->
                    </div>

                    <i-table :columns="columnsOverWork" :data="detailOverhoursVOList" class="mb20" :disabled-hover="true"
                             no-data-text="">
                        <template slot="tdadNopen" slot-scope="{ row ,index }">
                            <i-input @on-blur="handleInputChange(index, detailOverhoursVOList[index],'tdadNopen', $event.target)" v-if=" !bFixed" v-model="detailOverhoursVOList[index].tdadNopen"></i-input>
                            <span v-else>{{ row.tdadNopen | toTime }}</span>
                        </template>

                        <template slot="tdadNclose" slot-scope="{ row ,index}">
                            <i-input @on-blur="handleInputChange(index, detailOverhoursVOList[index],'tdadNclose', $event.target)" v-if=" !bFixed" v-model="detailOverhoursVOList[index].tdadNclose"></i-input>
                            <span v-else>{{ row.tdadNclose | toTime }}</span>
                        </template>

                        <template slot="tdadCsparechar1" slot-scope="{ row ,index}">
                            <i-input :autosize="{ maxRows: 3 }" type="textarea"
                                     v-if="!bFixed"
                                     v-model="detailOverhoursVOList[index].tdadCsparechar1"></i-input>
                            <span v-else>{{ row.tdadCsparechar1}}</span>
                        </template>

                        <template slot="tdadNdeleteflg" slot-scope="{ row ,index}" v-if="!bFixed">
                            <Poptip placement="left" transfer v-model="lightDelBtnVisible[row._index]">
                                <div class="operateBtn" slot="content">
                                    <a @click="cancelOverWork(row._index)">いいえ</a>
                                    <a @click="delOverWork(row, row._index)">はい</a>
                                </div>
                                <i-button ghost size="small" style="position: relative;left: 3px;width: 60px;" type="error">削除</i-button>
                            </Poptip>
                        </template>
                    </i-table>
                </div>

                <div class="titlenorm mb10">
                    <Icon type="logo-buffer"></Icon>
                    更新履歴
                </div>
                <i-table :columns="columnsDailyLog" :data="dailyLog" class="mb20"   no-data-text="" :disabled-hover="true">
                </i-table>
                <Spin fix size="large" v-if="dailyloading"></Spin>
            </div>
        </Drawer>

    </div>
</main>

<div th:replace="layout/head::header"></div>
<script type="text/babel" th:inline="javascript">
    const PERM_STATLIST = new Vue({
        el: '.permstatlist-warp',
        data() {
            return {
                curDate: new Date(),
                tableHead: [],
                tableData: [],
                slotList: Utils.getNumArray(1, 31).map(e => `disppermStatusName${e}`),
                slotList2: Utils.getNumArray(1, 13).map(e => `COLUMNID${e}`),
                dailyShow: true,
                rawData: [],
                isShow: false,
                showPre: true,
                listLoading: false,
                sublistLoading: false,
                showDayApply: false,
                emplistLoading: false,
                referListObject: {
                    [[${ TREEVIEW_KEY_PERM_TARGET_SECTION }]]: '',
                    [[${ TREEVIEW_KEY_PERM_TARGET_EMP }]]: '',
                    [[${ TREEVIEW_KEY_PERM_TARGET_GROUP }]]: '',
                    [[${ TREEVIEW_KEY_RECORD_DATE }]]: '',
                    txtTmgReferListTreeViewPermSelectedView: '',
                    hidSearchData:'',
                    hidSearchItems:'EMPLOYEEID',
                    hidSearchCondition:'BROADMATCH',
                    txtTmgReferListTreeViewRecordDate: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    type: 21
                },
                empTreeData: [],
                defaultDeptId: '',
                deptName: '選んでください',
                queryList: {
                    txtAction: 'ACT_DISP_MONTHLY',
                    txtDYYYYMM: '',
                    txtDYYYYMMDD: '',
                    txtCallBeanAction: 'ACT_DISP_MONTHLY',
                    txtTmgReferListTreeViewRecordDate: '',
                    txtTmgReferListTreeViewPermTargetSection: '',
                    txtTmgReferListTreeViewPermTargetGroup: '',
                    txtTmgReferListTreeViewPermTargetEmp: '',
                    txtTmgReferListTreeViewPermSelectedView: '',
                    hidSearchItems: [[${ session.SearchItems }]],     //検索種別
                    hidSearchCondition: [[${ session.SearchCondition }]], //検索条件
                    hidSearchData: [[${ session.SearchData }]],      //検索対象
                    hidSelectTab:[[${ session.hidSelectTab }]] === 1 ? '1':'0',     //組織タブー0：ツリ、1:検索
                    txtCEMPLOYEEID: '',
                    // sectionid: '',
                    txtExecuteEmpId: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp')
                    // type: 21
                },
                currentTab: [[${ session.hidSelectTab }]] === 1 ? "organisationSearch":"organisationTree",         //組織のツリーと検索タブーを切り替え
                treeData: [],
                selectDisabled: false,   　//年月選択可否制御
                dispMonthlyList: [],       //年月リスト
                searchConditionsList: [],//組織ツリー用
                searchTypesList: [],     //組織ツリー用
                model1: '',
                approval: false,
                drawApproval: false,

                title: '',
                tableHead2: [],
                tableData2: [],
                empIds: [],
                empIds2: [],

                bulkApprovalLoading: false,
                bulkApprovalLoading2: false,

                thisMonth: '',
                preMonth: '',
                nextMonth: '',
                preMonthShow: false,
                nextMonthShow: false,

                isSearchHistory: false,
                selectedDeptViewType: [[${ session.txtTmgReferListTreeViewPermSelectedView }]]  ? [[${ session.txtTmgReferListTreeViewPermSelectedView }]]:"section", //类型选择
                empDeptLoading: false,
                deptDrawShow: false,
                //↓↓↓↓↓↓日次実績登録用↓↓↓↓↓↓
                //body 使用参数
                query: {
                    txtTmgReferListTreeViewPermTargetEmp: '',        //組織ツリーで選択した職員番号
                    txtTmgReferListTreeViewPermTargetSection:'',
                    txtTmgReferListTreeViewRecordDate:'',
                    txtTmgReferListTreeViewPermTargetGroup:'',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href,'psApp'),
                    txtDYYYYMM: '',
                    txtDYYYYMMDD: '',
                    txtAction:''
                },
                updateMonthloading:false,
                today:'',

                //日次承认画面使用参数
                dailyloading:false,
                title: {
                    type: String,
                    default: ''
                },
                isShow: false, //抽屉开关
                errorFlag: false, //错误信息开关
                errorMsg: '',//错误信息
                bHoliday: false, //就業区分マスタ
                bFixed: false, //確定状態
                hasPassedTimeCheck: false,
                // 更新履歴の表示制御
                isLogShow: false,
                updateDailyLoading: false,
                deleteDailyLoading: false,
                //就業区分
                workingId: '',
                workingIdList: [],
                // 就業区分切替の表示制御
                bDisable: false,
                overHourLimit: '',
                // 出張区分切替の表示制御
                businessTrip: '',
                businessTripList: [],
                // 非勤務と超過勤務区分切替の表示制御
                categoryNonduty: '',
                categoryNondutyName: '',
                categoryNondutyList: [],
                categoryOverhours: '',
                categoryOverhoursName: '',
                categoryOverhoursList: [],
                dailyEdit:[],
                notapproval:false,
                columnsWork: [
                    {
                        title: '勤務時間',
                        align: 'center',
                        key: 'workTime'
                    },
                    {
                        title: '始業',
                        slot: 'workStart',
                        align: 'center'
                    },
                    {
                        title: '終業',
                        slot: 'workEnd',
                        align: 'center'
                    }
                ],
                columnsNotWork: [
                    {
                        title: '内容',
                        align: 'center',
                        width: '120',
                        key: 'itemName'
                    },
                    {
                        title: '開始時刻',
                        width: '80',
                        slot: 'tdadNopen',
                        align: 'center'
                    },
                    {
                        title: '終了時刻',
                        slot: 'tdadNclose',
                        width: '80',
                        align: 'center'
                    },
                    {
                        title: '備考',
                        slot: 'tdadCsparechar1',
                        align: 'center'
                    },
                    {
                        title: '削除',
                        slot: 'tdadNdeleteflg',
                        width: '80',
                        align: 'center'
                    }
                ],
                detailNonDutyVOList: [],
                columnsOverWork: [
                    {
                        title: '内容',
                        align: 'center',
                        width: '120',
                        key: 'itemName'
                    },
                    {
                        title: '開始時刻',
                        width: '80',
                        slot: 'tdadNopen',
                        align: 'center'
                    },
                    {
                        title: '終了時刻',
                        slot: 'tdadNclose',
                        width: '80',
                        align: 'center'
                    },
                    {
                        title: '用務内容',
                        slot: 'tdadCsparechar1',
                        align: 'center'
                    },
                    {
                        title: '状態',
                        key: 'tdadCsparechar2Name',
                        align: 'center'
                    },
                    {
                        title: '削除',
                        slot: 'tdadNdeleteflg',
                        width: '80',
                        align: 'center'
                    }
                ],
                detailOverhoursVOList: [],
                columnsDailyLog: [
                    {
                        title: '更新者',
                        key: 'cmodifierusernm',
                        width: '120'
                    },
                    {
                        title: '更新日時',
                        key: 'dmodifieddate',
                        width: '140',
                        align: 'center'
                    },
                    {
                        title: '画面',
                        key: 'cmodifierprogramnm',
                        width: '100',
                        align: 'center'

                    },
                    {
                        title: '操作',
                        key: 'cactionnm',
                        width: '130',
                        align: 'center'
                    },
                    {
                        title: '更新内容',
                        key: 'cchangelogstr'
                    }
                ],
                dailyLog: [],
                workData0: [],
                // 承認者コメントの入力制御
                bApproved: false,
                isCommonDiscretionaryLabor: false,//裁量労働制+就业实际时间修改控制
                isDiscretion:false,//裁量労働制
                tmgResultsDto: {
                    txtAction: '',
                    holiday: false,
                    txtTdaNopenR: '',
                    txtTdaNcloseR: '',
                    workingId: '',
                    selMgdCbusinessTrip: '',
                    txtDYYYYMMDD: '',
                    tdaCowncommentR: '',
                    nonDutyList: [],
                    overHoursList: [],
                    hasAuthority: true,
                    targetEmp:'',
                    psSite: Utils.getUrlParam(location.href, 'psSite')
                },　//参数
                workData:[],//就业时间
                workTimeDisable:false, //就業時間制御
                isMonthlyApproval:false,
                mgdCsparechar4VOList: [],

                tmoCstatusflg: '',
                lightDelBtnVisible: [],
                lightDelBtnVisible2: [],
                privateInfo: {
                    deptName: '',
                    name: '',
                    workType: ''
                },
                //↑↑↑↑↑↑日次実績登録用↓↓↓↓↓↓
            }
        },
        async mounted() {
            console.log([[${ session }]])
            await this.getInit()
        },
        computed: {
            tableHeadFixed() {
                if (this.contentScrollTop > 300) return true
                else return false
            },
            columns() {
                let result = [
                    {
                        title: '氏名',
                        slot: 'name',
                        minWidth: 100,
                        tooltip: true,
                        align: 'center'
                    },
                    {
                        title: '月次\n承認',
                        slot: 'statusName',
                        minWidth: 30,
                        align: 'center'
                    }
                ]
                const that = this
                this.tableHead.forEach((e, i) => {
                    result = result.concat({
                        // title: e,
                        className: e.today ? 'gold' : (e.tcaCholflg.indexOf('1') > -1 || e.tcaCholflg.indexOf('2') > -1 || e.tcaCholflg.indexOf('3') > -1 ? 'rest' : ''),
                        minWidth: 25,
                        renderHeader: (h, params) => {
                            return h(
                                'span',
                                {
                                    style: {
                                        cursor: 'pointer',
                                    },
                                    domProps: {
                                        className: 'table-head',
                                        innerHTML: e.name,
                                    },
                                    on: {
                                        click(){
                                            that.handleClickHead(e.day)
                                        },
                                    },
                                }
                            )
                        },
                        slot: `disppermStatusName${i + 1}`,
                        align: 'center'
                    })
                })
                result = result.concat({
                    type: 'selection',
                    width: 50,
                    align: 'center'
                })
                return result
            },
            columns2() {
                let result = []
                const that = this
                const r =[45,120,60,55,55,55,55,55,55,250,250,150,150]
                this.tableHead2.forEach((e, i) => {
                    result = result.concat({
                        // width: e.mgdNwidth,
                        minWidth: r[i],
                        tooltip: true,
                        renderHeader: (h, params) => {
                            return h(
                                'span',
                                {
                                    // style: {
                                    //     cursor: 'pointer',
                                    // },
                                    domProps: {
                                        // className: 'table-head',
                                        innerHTML: e.mgdCheader,
                                    }
                                }
                            )
                        },
                        key: `COLUMNID${i + 1}`,
                        align: e.mgdCdispstyle
                    })
                })
                result = result.concat({
                    type: 'selection',
                    width: 50,
                    align: 'center'
                })
                return result
            }
        },
        methods: {
            async getDispTmgMonthlyList() {
                this.queryList.txtAction = 'ACT_DISP_MONTHLY'
                const { data } = await this.http.get('sys/permStatList/dispTmgMonthlyList', this.queryList)
                this.dispMonthlyList = data

                if (data.length > 0){
                    this.model1 = data[0].val

                    let result = this.model1.replace("年","/")
                    result = result.replace("月","/")
                    result = result + "01"
                    this.queryList.txtDYYYYMM = result

                    this.thisMonth = result
                    this.preNextMonth(data[0].val)

                    //年月リストを取得する時に、活性化にする
                    this.selectDisabled = true
                }

                //年月リスト.lengthがゼロ場合、非活性化にする
                console.log("年月リスト.lengthがゼロ場合、非活性化にする")
                console.log(this.queryList.hidSelectTab)
                if (data.length == 0 && this.queryList.hidSelectTab == '0' ){
                    this.model1 = ''
                    this.selectDisabled = false
                    this.preMonthShow = false
                    this.nextMonthShow = false
                    if(this.treeData.length !== 0) {
                        this.$Message.error({
                            background: true,
                            closable: true,
                            duration: 6,
                            content: '指定した年月の就業シートはありません。或は選択した所属に存在している職員はありません。'
                        })
                    }
                }
                if (data.length == 0 && this.queryList.hidSelectTab == '1' ){
                    this.model1 = ''
                    this.selectDisabled = false
                    this.preMonthShow = false
                    this.nextMonthShow = false
                    if(this.treeData.length !== 0) {
                        this.$Message.error({
                            background: true,
                            closable: true,
                            duration: 6,
                            content: '条件に一致する職員が見つかりませんでした。'
                        })
                    }
                }
            },
            async getTableHead() {
                this.queryList.txtAction = 'ACT_DISP_MONTHLY'
                const { data } = await this.http.get('sys/permStatList/selectDayHead', this.queryList)
                this.tableHead = data
                if (this.queryList.hidSelectTab == '1'){
                    this.deptName = '職員により検索中'
                    this.queryList.txtUserCode = null
                }
            },
            async getTableData() {
                this.listLoading  = true
                if (this.queryList.hidSelectTab == '1'){
                    this.deptName = '職員により検索中'
                    this.queryList.txtUserCode = null
                }
                const { data } = await this.http.get('sys/permStatList/getTmgMonthlyInfoVOList', this.queryList)
                this.tableData = data.tmgMonthlyInfoVOList
                this.approval = data.approval
                this.listLoading  = false
                this.isSearchHistory = false
            },
            // async getTmgMonthlyInfoVOList() {
            //     this.queryList.txtAction = 'ACT_DISP_MONTHLY'
            //
            //     const { data } = await this.http.get('sys/permStatList/getTmgMonthlyInfoVOList', this.queryList)
            //     this.tableData = data
            // },
            async getOrgTree(refreshDept) {
                this.empDeptLoading = true
                try {
                    const { groupList, sectionList, recordDate } = await this.http.get('sys/tree', this.referListObject)
                    // 先将数据转为标准格式，再转为可用数据
                    console.log("getOrgTree_getOrgTree_s")
                    console.log(this.selectedDeptViewType)
                    if (this.selectedDeptViewType === "section") {
                        this.treeData = Utils.convertTreeData(sectionList)
                    }
                    if (this.selectedDeptViewType === "group") {
                        this.treeData = Utils.convertTreeData(groupList)
                    }
                    this.referListObject.txtTmgReferListTreeViewRecordDate = recordDate
                    console.log("getOrgTree_getOrgTree_e")
                    console.log(this.treeData)
                } catch (error) {
                    return
                } finally {
                    this.empDeptLoading = false
                }
            },
            async handleDeptDateChange(e) {
                this.referListObject.txtTmgReferListTreeViewRecordDate = e
                this.isSearchHistory = true
                console.log("getOrgTree2")
                await this.getOrgTree()
                if(this.treeData.length !== 0) {
                    this.$Notice.warning({ title:'所属図更新完了',desc:"下記の所属リストから対象を選んでください" })
                }
            },
            async preMonthApproval() {
                console.log("preMonthApproval")
                console.log(this.preMonth)
                this.queryList.txtDYYYYMM = this.dateFormat(this.preMonth)
                await this.getTableHead()
                await this.getTableData()
                this.model1 = this.preMonth
                this.preNextMonth(this.preMonth)
            },
            async nextMonthApproval() {
                this.queryList.txtDYYYYMM = this.dateFormat(this.nextMonth)
                await this.getTableHead()
                await this.getTableData()
                this.model1 = this.nextMonth
                this.preNextMonth(this.nextMonth)
            },
            preNextMonth(e) {
                console.log("preNextMonth_s")
                console.log(this.dispMonthlyList.length)
                console.log(e)
                for (var i=0;i < this.dispMonthlyList.length;i++){
                    if (e===this.dispMonthlyList[i].val) {
                        //年月リストが１件であれば、前月・翌月が非活性化にする
                        if(this.dispMonthlyList.length ===1){
                            this.preMonthShow = false
                            this.nextMonthShow = false
                            break
                        }
                        if (i===0){
                            this.preMonthShow = true
                            this.nextMonthShow = false

                            this.preMonth = this.dispMonthlyList[i+1].val
                            this.nextMonth = ''
                            break

                        } else if (i===this.dispMonthlyList.length-1) {

                            this.preMonthShow = false
                            this.nextMonthShow = true

                            this.preMonth = ''
                            this.nextMonth = this.dispMonthlyList[i-1].val
                            break
                        } else {
                            this.preMonthShow = true
                            this.nextMonthShow = true

                            this.preMonth = this.dispMonthlyList[i+1].val
                            this.nextMonth = this.dispMonthlyList[i-1].val
                            break
                        }
                    }
                }
                console.log(this.preMonth)
                console.log(this.nextMonth)
                console.log("preNextMonth_e")
            },
            rowClass(row) {
                // 表格变色
                if (!row.dayDivisionCode || row.dayDivisionCode === '1') {
                    return ''
                }
                return 'sat'
            },
            handleScroll: Throttle(function (e) {
                this.contentScrollTop = e.target.documentElement.scrollTop || e.target.body.scrollTop

            }, 50),
            convertTreeData(treeData = []) {
                return treeData.map(e => {
                    const children = e.child || e.children
                    if (children) {
                        return {
                            ...e.data,
                            title: e.data.label,
                            // 前两层级默认展开方便查看
                            expand: e.data.level < 2 || !e.data.level,
                            children: this.convertTreeData(children)
                        }
                    } else {
                        return {
                            ...e.data,
                            title: e.data.label
                        }
                    }
                })
            },
            handleSelector() { },
            async handleClickLeaf(e) {
                //同一部署を二回目でクリックすると、取消とするためで、エラーあり
                //よって、二回目クリックすると、何もしない
                if(!e[0]) return

                console.log('e2')
                console.log(e)
                this.deptDrawShow = false

                this.queryList.txtAction = 'ACT_DISP_MONTHLY'

                if (this.selectedDeptViewType === "section") {
                    this.deptName = e[0].label
                }
                if (this.selectedDeptViewType === "group") {
                    this.deptName = e[0].secnic
                }

                this.queryList.txtTmgReferListTreeViewPermTargetSection = e[0].secid
                this.queryList.txtTmgReferListTreeViewPermTargetGroup = e[0].groupid
                this.queryList.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate


                //年月リストの取得
                //初期化
                this.tableHead = []
                this.tableData = []
                this.approval = false
                //ツリーを選択するの場合、0で設定する
                this.queryList.hidSelectTab='0'
                await this.getDispTmgMonthlyList()
                await this.getTableHead()
                // if(this.dispMonthlyList.length>0){
                    await this.getTableData()
                // }

                //ツリーを選択するの場合、0で設定する
                this.query.hidSelectTab = '0'
                await this.getTableData()
            },
            async getEmpList() {
                try {
                    this.emplistLoading = true
                    const { data } = await this.http.get('sys/tree/admin/emplist', this.referListObject)
                    this.empTreeData = Utils.convertTreeData(Utils.convertToData(data))
                } catch (error) {
                    return
                } finally {
                    this.emplistLoading = false
                }
            },
            handleClickEmpLeaf(e) {
                this.queryList.hidSelectTab = '1'
                this.queryList.hidSearchData = this.referListObject.hidSearchData
                this.queryList.hidSearchItems = this.referListObject.hidSearchItems
                this.queryList.hidSearchCondition = this.referListObject.hidSearchCondition

                this.getDispTmgMonthlyList()
                this.getTableData()
            },
            showName(e) {
                const result = e.match(/^[\s\S]+(?=\()/g)
                return (result && result[0]) || e
            },
            async handleClickHead(e) {
                console.log(e)
                //テーブルデータ存在しないと、日次一括承認画面へ遷移できません
                if(this.tableData.length===0) return

                this.queryList.txtAction = 'ACT_EDIT_DAIRY'
                this.queryList.txtDYYYYMMDD = e
                this.queryList.txtCallBeanAction = 'ACT_DISP_MONTHLY'

                this.title = "承認状況 " + Utils.formatDate(e, 'yyyy年m月d日')

                this.showDayApply = true
                this.getReadTmgDaily()

                //選択した職員リストをクリアする
                this.handleSelectAll2(false)
                console.log("this.handleClickHead")
                console.log(this.tableHead2)
                console.log(this.tableData2)
            },
            async getReadTmgDaily() {
                this.sublistLoading  = true
                const { data } = await this.http.get('sys/permStatList/getReadTmgDaily', this.queryList)

                //日別詳細画面のボタンを制御
                this.drawApproval = data.approval

                this.tableHead2 = data.itemVOList
                this.tableData2 = data.tmgDailyMapList
                this.sublistLoading  = false
            },
            handleSelectAll(status) {
                this.$refs.selection.selectAll(status)
            },
            //行が選択される場合、トリガーされる
            tableSelect(selection, row) {
                console.log("tableSelect")
                console.log(selection)
                console.log(row)
            },
            //選択した行の状態が変わる場合、トリガーされる
            tableSelectChange(selection, row) {
                console.log("tableSelectChange")
                console.log(selection)

                this.empIds = []
                for (var i=0;i < selection.length;i++){
                    this.empIds.push(selection[i].empid)
                }
                this.queryList.txtExecuteEmpId = this.empIds.join(',')
                console.log(this.queryList.txtExecuteEmpId)

            },

            //行が選択される場合、トリガーされる
            tableSelect2(selection, row) {
                console.log("tableSelect")
                console.log(selection)
                console.log(row)
            },
            //選択した行の状態が変わる場合、トリガーされる
            tableSelectChange2(selection, row) {
                console.log("tableSelectChange2")
                console.log(selection)

                this.empIds2 = []
                for (var i=0;i < selection.length;i++){
                    this.empIds2.push(selection[i].TDA_CEMPLOYEEID)
                }
                this.queryList.txtExecuteEmpId = this.empIds2.join(',')
                console.log(this.queryList.txtExecuteEmpId)

            },
            handleSelectAll2(status) {
                this.$refs.selection2.selectAll(status)
            },
            handleStartMonth(e) {
                console.log("handleStartMonth")
                if(e){
                    this.queryList.txtDYYYYMM = this.dateFormat(e)
                    this.getTableHead()
                    this.getTableData()
                    this.preNextMonth(e)
                }
            },
            async bulkApproval(e) {
                this.queryList.txtAction = 'ACT_MONTHLY_PERMIT'
                this.queryList.txtCallBeanAction = 'ACT_DISP_MONTHLY'

                //月次一括承認Loading制御
                this.bulkApprovalLoading = true

                console.log("bulkApproval")
                console.log(this.empIds)
                console.log(this.empIds.length)

                if (this.empIds.length === 0){
                    this.$Message.error("月次一括承認の対象者が選択されていません")
                    //月次一括承認Loading制御
                    this.bulkApprovalLoading = false

                } else {
                    this.$Modal.confirm({
                        title: '',
                        content: 'チェックされた職員の月次就業実績を承認しますか。よろしいでしょうか？',
                        okText: 'OK',
                        cancelText: 'キャンセル',
                        onOk: async () => {
                            const { data } = await this.http.get('sys/permStatList/executeUpdateTmgMonthly', this.queryList)

                            //月次承認状況一覧検索処理
                            await this.getTableData()

                            //月次一括承認Loading制御
                            this.bulkApprovalLoading = false
                        },
                        onCancel: () => {
                            //選択した職員リストをクリアする
                            this.handleSelectAll(false)

                            //月次一括承認Loading制御
                            this.bulkApprovalLoading = false
                            console.log(this.empIds)

                        }
                    })
                }
            },
            async bulkApproval2(e) {
                this.queryList.txtAction = 'ACT_EDIT_DAIRY'
                this.queryList.txtCallBeanAction = 'ACT_DISP_MONTHLY'

                //月次一括承認Loading制御
                this.bulkApprovalLoading2 = true

                console.log("bulkApproval2")
                console.log(this.empIds2)
                console.log(this.empIds2.length)

                if (this.empIds2.length === 0){
                    this.$Message.warning("日次一括承認の対象者が選択されていません")
                    //日次一括承認Loading制御
                    this.bulkApprovalLoading2 = false

                } else {
                    this.$Modal.confirm({
                        title: '',
                        content: 'チェックされた職員の日次就業実績を承認しますか。よろしいでしょうか？',
                        okText: 'OK',
                        cancelText: 'キャンセル',
                        onOk: async () => {
                            const { code,msg } = await this.http.get('sys/permStatList/executeUpdateTmgDaily', this.queryList)

                            //日次承認状況一覧検索処理
                            this.getReadTmgDaily()

                            //月次承認状況一覧検索処理
                            await this.getTableData()

                            //日次一括承認Loading制御
                            this.bulkApprovalLoading2 = false

                            if(code === 0){
                                this.$Message.success({
                                    background: true,
                                    closable: true,
                                    duration: 6,
                                    content: '一括承認が正しく実施されました。'
                                });
                            }
                        },
                        onCancel: () => {
                            //選択した職員リストをクリアする
                            this.handleSelectAll2(false)

                            //日次一括承認Loading制御
                            this.bulkApprovalLoading2 = false
                            console.log(this.empIds2)
                        }
                    })
                }
            },
            dateFormat(e) {
                //YYYY年MM月からYYYY/MM/01へ変換する
                let yearMMDD = e.replace("年","/")
                yearMMDD = yearMMDD.replace("月","/")
                yearMMDD = yearMMDD+"01"
                return  yearMMDD
            },
            // async handleDeptViewTypeChange(e) {
            //     this.selectedDeptViewType = e
            //     console.log("getOrgTree3")
            //     console.log(this.selectedDeptViewType)
            //     this.queryList.txtTmgReferListTreeViewPermSelectedView = this.selectedDeptViewType
            //     await this.getOrgTree()
            //     console.log("handleDeptViewTypeChange")
            //     console.log(this.queryList.txtTmgReferListTreeViewPermSelectedView)
            //     this.$Notice.success({ title: '所属図更新完了' })
            // },
            async handleDeptViewTypeChange(e) {
                this.selectedDeptViewType = e
                console.log("----------------1---------------------")
                console.log(this.selectedDeptViewType)
                if (this.selectedDeptViewType === "all") {
                    this.deptDrawShow = false
                    this.deptName = '全て表示中'
                    this.treeData = []
                    this.queryList.txtTmgReferListTreeViewPermSelectedView = 'all'
                    this.referListObject.txtTmgReferListTreeViewPermSelectedView = 'all'
                    this.getTableData()
                    return
                }
                await this.getOrgTree()
                if (this.selectedDeptViewType === "section") {
                    this.queryList.txtTmgReferListTreeViewPermSelectedView = 'section'
                    this.referListObject.txtTmgReferListTreeViewPermSelectedView = 'section'
                }
                if (this.selectedDeptViewType === "group") {
                    this.queryList.txtTmgReferListTreeViewPermSelectedView = 'group'
                    this.referListObject.txtTmgReferListTreeViewPermSelectedView = 'group'
                }
                this.$Notice.success({ title: '所属図更新完了' })
            },
            //日次承認画面用
            //一覧から日次実績をクリックする
            async showDay(e1,e2,e3) {

                //月次承認状態
                this.tmoCstatusflg = e3

                this.query.txtTmgReferListTreeViewPermTargetEmp = e1
                this.query.txtDYYYYMM = this.dateFormat(this.model1)
                this.query.txtAction = 'ACT_EDITINP_RDAILY'

                let num = Math.floor(e2.substr(18))
                this.query.txtDYYYYMMDD = this.query.txtDYYYYMM.substr(0,8) + ((9 >= num) ? ("0" + num) : num)

                // 業登録画面表示
                this.isShow = true
                this.dailyloading = true

                // 就業登録画面項目クリアする
                this.categoryNonduty = ''
                this.categoryOverhours = ''
                this.dailyEdit = []
                this.workData0 = []
                this.detailNonDutyVOList = []
                this.detailOverhoursVOList = []

                this.title = '  '
                // this.query.txtDYYYYMMDD = e
                // this.query.txtAction = 'ACT_EDITINP_RDAILY'
                this.bFixed = false
                this.bHoliday = false
                // 業登録画面データ取得
                await this.dailyDetail()

                // 職員情報取得
                this.queryList.txtTmgReferListTreeViewAdminTargetEmp = e1
                await this.getApplyEmployPersonalInfo()
                this.dailyloading = false
            },
            // 就業登録画面情報取得・設定する
            async dailyDetail() {
                if(this.$refs.select1){
                    this.$refs.select1.clearSingleSelect()
                }
                if(this.$refs.select2){
                    this.$refs.select2.clearSingleSelect()
                }
                if(this.$refs.select3){
                    this.$refs.select3.clearSingleSelect()
                }
                if(this.$refs.select4){
                    this.$refs.select4.clearSingleSelect()
                }
                // 画面情報取得
                const {data} = await this.http.get('sys/tmgResults/dailyDetail', this.query)

                // 就業区分ドロップダウン
                this.workingIdList = data.workIdList

                // 出張ドロップダウン
                this.businessTripList = data.businessTripList

                // 非勤務ドロップダウン
                this.categoryNondutyList = data.categoryNondutyList
                if(this.categoryNondutyList.length>0){
                    this.categoryNonduty = this.categoryNondutyList[0].itemCode
                }


                // 超過勤務ドロップダウン
                this.categoryOverhoursList = data.categoryOverhoursList
                if(this.categoryOverhoursList.length>0){
                    this.categoryOverhours = this.categoryOverhoursList[0].itemCode
                }

                this.mgdCsparechar4VOList = data.mgdCsparechar4VOList

                // 詳細:欠勤離籍以外
                this.workData0 = data.dailyDetail0List
                // 就業実績
                this.dailyEdit = data.dailyEditVO

                if (('TMG_DATASTATUS|9' === this.dailyEdit.tdaCstatusflg || 'TMG_DATASTATUS|5' === this.dailyEdit.tdaCstatusflg)
                    && '' !== this.dailyEdit.tdaCmodifieruseridR
                    && '' !== this.dailyEdit.tdaDmodifieddateR
                ) {
                    this.bApproved = true
                } else {
                    this.bApproved = false
                }

                // 登録ボタンとコメントのみ登録ボタンの表示制御
                this.bFixed = !data.isEditable
                if (data.workIdList.length < 2) {
                    this.bHoliday = true
                }


                this.isCommonDiscretionaryLabor = data.isCommonDiscretionaryLabor
                this.isDiscretion=data.isDiscretion

                if (this.dailyEdit.tdaNopenR !== this.dailyEdit.tdaNopenTp) {
                    this.bOpen = true
                } else {
                    this.bOpen = false
                }
                if (this.dailyEdit.tdaNcloseR !== this.dailyEdit.tdaNcloseTp) {
                    this.bClose = true
                } else {
                    this.bClose = false
                }


                this.dailyEdit.tdaNcloseR = this.dailyEdit.tdaNopenRHidden
                this.dailyEdit.tdaNcloseR = this.dailyEdit.tdaNcloseRHidden


                if (this.dailyEdit.tdaNopenTp === null) {
                    this.dailyEdit.tdaNopenTp = '---'
                }
                if (this.dailyEdit.tdaNcloseTp === null) {
                    this.dailyEdit.tdaNcloseTp = '---'
                }
                if (this.isDiscretion) {
                    this.dailyEdit.tdaNopenN = '---'
                    this.dailyEdit.tdaNcloseN = '---'
                }

                this.workingId = this.dailyEdit.tdaCworkingidR
                this.businessTrip = this.dailyEdit.tdaCbusinesstripidR
                this.title = this.dailyEdit.tdaDyyyymmddDy

                if(this.dailyEdit.tdaCerrcode !== null){

                    let tempErrCode = JSON.parse(this.dailyEdit.tdaCerrcode)
                    Object.keys(tempErrCode).some(e => {

                        if (e === 'ERRTYPE_10') {

                            this.$Notice.error({desc: tempErrCode.ERRTYPE_10[0].ERRMSG})
                            return true
                        }
                    })

                }
                this.workData=[
                    {
                        workTime: '予定時間',
                        workStart: this.dailyEdit.tdaNopenN,
                        workEnd: this.dailyEdit.tdaNcloseN,
                        cellClassName: {
                            workTime: 'sub-title'
                        }
                    },
                    {
                        workTime: '打刻',
                        workStart: this.dailyEdit.tdaNopenTp,
                        workEnd: this.dailyEdit.tdaNcloseTp,
                        cellClassName: {
                            workTime: 'sub-title'
                        }
                    },
                    {
                        workTime: '就業時間',
                        isInput: true,
                        workStart: this.dailyEdit.tdaNopenR,
                        workEnd: this.dailyEdit.tdaNcloseR,
                        cellClassName: {
                            workTime: 'sub-title'
                        }
                    }]
                this.workData0.forEach(e => {
                    this.workData = this.workData.concat(
                        {
                            workTime: e.tdadCnotworkName,
                            workStart: e.tdadNopenHhmi,
                            workEnd: e.tdadNcloseHhmi,
                            cellClassName: {
                                workTime: 'sub-title'
                            }
                        }
                    )
                })
                this.workData = this.workData.concat([
                    {
                        workTime: '本人コメント	',
                        isOwnComment: true,
                        cellClassName: {
                            workTime: 'like-title'
                        }
                    },
                    {
                        workTime: '承認者コメント	',
                        isBSComment: true,
                        cellClassName: {
                            workTime: 'like-title'
                        }
                    }])
                // 非勤務
                this.detailNonDutyVOList = data.detailNonDutyVOList
                // 超過勤務
                this.detailOverhoursVOList = data.detailOverhoursVOList
                //
                const turnLine = Vue.filter('turnLine');
                this.dailyLog = data.columnsDailyLog.map(e => {
                    return {
                        ...e,
                        cchangelogstr: turnLine(e.cchangelogstr)

                    }
                })
                let limitOfBasedateVO = data.limitOfBasedateVO
                this.overHourLimit = limitOfBasedateVO.dailyConvMinute
                this.otDaily = limitOfBasedateVO.otDaily
                this.targetForOverTime = data.targetForOverTime
                this.changeWorkingID(this.workingId)
                if(data.dailyEditVO.tdaCstatusflg==='TMG_DATASTATUS|5' && 'TMG_DATASTATUS|0'===this.tmoCstatusflg ){
                    this.notapproval=true
                }else{
                    this.notapproval=false
                }

            },
            //承認
            async updateDaily() {
                if (!this.errorCheck(this.workingId)) {
                    return
                }


                this.tmgResultsDto.txtDYYYYMMDD = this.query.txtDYYYYMMDD
                this.tmgResultsDto.txtAction = 'ACT_EDITPERM_UPERMIT'

                this.tmgResultsDto.workingId = this.workingId
                this.tmgResultsDto.selMgdCbusinessTrip = this.businessTrip
                this.tmgResultsDto.txtTdaNopenR = ''
                this.tmgResultsDto.txtTdaNcloseR = ''
                this.tmgResultsDto.txtTdaCbosscommentR = this.dailyEdit.tdaCbosscommentR
                this.tmgResultsDto.hasAuthority = ''
                this.tmgResultsDto.nonDutyList = []
                this.tmgResultsDto.overHoursList = []
                this.tmgResultsDto.targetEmp=this.query.txtTmgReferListTreeViewPermTargetEmp
                this.tmgResultsDto.holiday = this.bHoliday
                if (!this.bDisable) {
                    this.tmgResultsDto.txtTdaNopenR = this.workData[2].workStart
                    this.tmgResultsDto.txtTdaNcloseR = this.workData[2].workEnd
                    this.tmgResultsDto.nonDutyList = this.detailNonDutyVOList
                    this.tmgResultsDto.overHoursList = this.detailOverhoursVOList
                    if (this.bFixed || this.bHoliday) {
                        this.tmgResultsDto.hasAuthority = false
                    } else {
                        this.tmgResultsDto.hasAuthority = true
                    }
                }
                this.$Modal.confirm({
                    inDrawer: true,
                    title: 'この内容で承認します。よろしいですか？',
                    width: 400,
                    okText: 'OK',
                    cancelText: 'キャンセル',
                    onOk: async () => {
                        try {
                            this.updateDailyLoading = true
                            const {msg} = await this.http.post('sys/tmgResults/updateDaily', this.tmgResultsDto)
                            if (msg === '0') {
                                this.updateDailyLoading = false
                                this.isShow = false
                                this.getTitleData()
                                return
                            }
                            this.errMsg = JSON.parse(msg)
                            let errMsg20
                            let check = Object.keys(this.errMsg).some(e => {
                                if (e === 'ERRTYPE_10') {
                                    this.$Notice.error({desc: this.errMsg.ERRTYPE_10[0].ERRMSG})
                                    return true
                                }
                                if (e === 'ERRTYPE_20') {
                                    this.errMsg.ERRTYPE_20.forEach(e20 => {
                                        errMsg20 = errMsg20 + e20.ERRMSG + '/n'
                                    })
                                    this.$Notice.error({desc: errMsg20})
                                }

                            })
                            if (check) {

                                return false
                            }
                        }catch(error){
                            return
                        }finally {
                            this.updateDailyLoading = false

                            //月次承認状況一覧検索処理
                            await this.getTableData()
                        }
                    }
                })
            },
            //差戻
            async updateRemandsStatus() {
                this.$Modal.confirm({
                    inDrawer: true,
                    title: '勤務実績の内容を入力者へ差戻します。よろしいですか？\n'+'※今回、入力した内容は、承認者コメントのみ保存されます',
                    width: 490,
                    okText: 'OK',
                    cancelText: 'キャンセル',
                    onOk: async () => {

                        this.tmgResultsDto.txtDYYYYMMDD = this.query.txtDYYYYMMDD
                        this.tmgResultsDto.txtAction = 'ACT_REMANDS'
                        this.tmgResultsDto.workingId = this.workingId
                        this.tmgResultsDto.selMgdCbusinessTrip = this.businessTrip
                        this.tmgResultsDto.holiday = this.bHoliday
                        this.tmgResultsDto.txtTdaNopenR = this.dailyEdit.tdaNopenR
                        this.tmgResultsDto.txtTdaNcloseR = this.dailyEdit.tdaNcloseR
                        this.tmgResultsDto.txtTdaCbosscommentR = this.dailyEdit.tdaCbosscommentR
                        if (this.bFixed || this.bHoliday) {
                            this.tmgResultsDto.hasAuthority = false
                        } else {
                            this.tmgResultsDto.hasAuthority = true
                        }
                        this.tmgResultsDto.targetEmp=this.query.txtTmgReferListTreeViewPermTargetEmp
                        try{
                            this.deleteDailyLoading = true
                            const {msg} = await this.http.post('sys/tmgResults/updateDaily', this.tmgResultsDto)
                            this.deleteDailyLoading = false
                            this.isShow = false
                            this.getTitleData()
                            return
                        }catch (error) {
                            return
                        }finally {
                            this.deleteDailyLoading = false

                            //月次承認状況一覧検索処理
                            await this.getTableData()
                        }
                    }
                })
            },
            // 就業区分の切り替え表示制御
            changeWorkingID(workingid) {
                if(!workingid){
                    return
                }
                this.bDisable = false;
                // 休暇
                if (this.bHoliday) {
                    this.bDisable = true;
                    this.workTimeDisable=true
                    // 休暇以外
                } else {
                    let mgdCsparechar4VO = this.mgdCsparechar4VOList.find(e => e.mgdCmastercode === workingid)
                    // 出勤 or 休日出勤
                    if (mgdCsparechar4VO.mgdCsparechar5 == '0') {
                        this.bDisable = false;
                        this.workTimeDisable=false
                        // 欠勤
                    } else {
                        this.bDisable = true;
                        this.workTimeDisable=true
                    }
                }
                if (this.bDisable === true) {
                    this.workData[2].workStart=''
                    this.workData[2].workEnd=''
                    this.detailNonDutyVOList = []
                    this.detailOverhoursVOList = []
                    if(this.businessTripList[0].mgdCmastercode){
                        this.businessTrip=this.businessTripList[0].mgdCmastercode
                    }else{
                        this.businessTrip=''
                    }
                }
            },
            // エラーチェック
            errorCheck(workingid) {
                let mgdCsparechar4VO = this.mgdCsparechar4VOList.find(e => e.mgdCmastercode === workingid)
                // 出勤 or 休日出勤
                if (!mgdCsparechar4VO || mgdCsparechar4VO.mgdCsparechar5 != '0') {
                    return true;
                }
                // 修正出社時刻形式
                if (this.workData[2].workStart ===null || !this.time_check(this.workData[2].workStart)) {
                    this.$Notice.error({desc: "就業時間・始業は適切な時刻ではありません。(hh:mm)形式で時刻を入力及び48:00以内の時刻で指定してください。"})
                    return false;
                }

                // 修正退社時刻形式
                if (this.workData[2].workEnd ===null || !this.time_check(this.workData[2].workEnd)) {
                    this.$Notice.error({desc: "就業時間・終業は適切な時刻ではありません。(hh:mm)形式で時刻を入力及び48:00以内の時刻で指定してください。"})
                    return false;
                }

                if (this.dailyEdit.tdaCbosscommentR !== null && this.getLengthB(this.dailyEdit.tdaCbosscommentR) > 100) {
                    this.$Notice.error({desc: "承認者コメント考が設定値を超えています。全角・半角カナ50字以内、半角英数100字以内。"})
                    return false;
                }

                //非勤務
                const checkNonDuty = this.detailNonDutyVOList.some(e => {

                    if (e.tdadNopen ===null ||  !this.time_check(e.tdadNopen)) {
                        this.$Notice.error({desc: "非勤務の開始時刻は適切な時刻ではありません。(hh:mm)形式で時刻を入力及び48:00以内の時刻で指定してください。"})
                        return true;
                    }
                    if (e.tdadNclose ===null ||  !this.time_check(e.tdadNclose)) {
                        this.$Notice.error({desc: "非勤務の終了時刻は適切な時刻ではありません。(hh:mm)形式で時刻を入力及び48:00以内の時刻で指定してください。"})
                        return true;
                    }
                    if (e.tdadCsparechar1 !== null && this.getLengthB(e.tdadCsparechar1) > 100) {
                        this.$Notice.error({desc: "中断備考が設定値を超えています。全角・半角カナ50字以内、半角英数100字以内。"})
                        return true
                    }
                })
                if (checkNonDuty) return false
                // 超過勤務
                const checkOverhour = this.detailOverhoursVOList.some(e => {

                    if (e.tdadCsparechar1 !== null && e.tdadCsparechar1.length > 100) {
                        this.$Notice.error({desc: "超過勤務備考が設定値を超えています。全角・半角カナ50字以内、半角英数100字以内。"})
                        return true
                    }
                })
                if (checkOverhour) return false
                let nOverTimeTotal = 0;
                // 超過勤務命令の明細部配下を行単位で取得
                this.detailOverhoursVOList.forEach(e => {
                    // 超過勤務命令の時間数を算出
                    let sOpen = this.toMinuteFromHHcMI60(e.tdadNopen);
                    let sClose = this.toMinuteFromHHcMI60(e.tdadNclose);
                    nOverTimeTotal = nOverTimeTotal + (sClose - sOpen);
                })
                // 超過勤務命令時間が入力されていて、超過勤務対象「無」の場合は警告メッセージを表示する
                if (nOverTimeTotal > 0 && this.targetForOverTime === "1") {
                    // 警告メッセージの表示および、応答の確認

                    if(!confirm('超過勤務対象外として設定されています。\n超過勤務命令を登録してもよろしいですか？')){
                        return false
                    }
                }
                // 超過勤務命令時間数合計が登録された超勤限度時間を超える場合は警告メッセージを表示する
                if (nOverTimeTotal > this.overHourLimit) {
                    // 警告メッセージの表示および、応答の確認
                    if(!confirm('超過勤務命令の時間数が' +this.otDaily +'時間を超えています。\nこの超過勤務時間で登録してよろしいですか？')){
                        return false
                    }
                }
                return true;
            },
            getLengthB(moji) {
                let i, j, cnt = 0;
                let multiStr = new Array("×", "§", "¨", "°", "±", "´", "¶");
                for (i = 0; i < moji.length; i++) {
                    for (j = 0; j < multiStr.length; j++) {
                        if (multiStr[j].length == 0) {
                            continue;
                        }
                        moji = moji.replace(multiStr[j], "00");
                    }
                }
                // MAC OSの場合、改行コードが「\n」となり、Windowsの改行コード「\r\n」とバイト数が異なるので、
                moji = moji.split("\r\n").join("\n"); // 一旦「\r\n」 ⇒ 「\n」の変換を行い、改行コードを「\n」に合わせる。
                // バイト数を求めます。
                for (i = 0; i < moji.length; i++)
                    if (escape(moji.charAt(i)).length >= 4) cnt += 2; else cnt++;
                return cnt;
            },
            time_check(sTime) {
                return sTime.match(/^(([0-3]?[0-9])|([4][0-7])):([0-5]?[0-9])$/);
            },
            toMinuteFromHHcMI60(pHHMM) {
                // 何もパラメータが渡されなかった場合、そのまま返す
                if (pHHMM === '') {
                    return '';
                }
                let retMinute;
                let nHour = new Number();
                let nMinute = new Number();
                // 分に変換します
                nHour = eval(+(pHHMM.split(":")[0] * 60));
                nMinute = eval(+(pHHMM.split(":")[1]));
                retMinute = eval(nHour + nMinute);
                return retMinute;
            },
            handleInputChange(i,object,value,el) {
                // 填完后自动checkbox
                if(object) {
                    this.hasPassedTimeCheck = Utils.checkTime(object, value,el)
                }
            },
            addOverWork() {
                let detailOverhoursVO = this.categoryOverhoursList.find(e => e.itemCode === this.categoryOverhours)

                this.detailOverhoursVOList.push({
                    attributeUrl: detailOverhoursVO.attributeUrl,
                    tdadCnotworkid: detailOverhoursVO.itemCode,
                    itemName: detailOverhoursVO.itemName,
                    tdadNopen: '',
                    tdadNclose: '',
                    tdadNdeleteflg: '0',
                    tdadSeq: Date.now(),
                    tdadCsparechar1: '',
                    tdadNsparenum1: '',
                    tdadCcode01: '',
                    tdadCcode01Name: '',
                    tdadCsparechar2: '',
                    tdadCsparechar2Name: ''

                })
            },
            addNotWork() {
                let categoryNondutyVO = this.categoryNondutyList.find(e => e.itemCode === this.categoryNonduty)

                this.detailNonDutyVOList.push({
                    attributeUrl: categoryNondutyVO.attributeUrl,
                    tdadCnotworkid: categoryNondutyVO.itemCode,
                    itemName: categoryNondutyVO.itemName,
                    tdadNdeleteflg: "0",
                    tdadNopen: '',
                    tdadNclose: '',
                    tdadSeq: Date.now(),
                    tdadCsparechar1: '',
                    tdadNsparenum1: null

                })

            },
            delNotWork(row, i) {
                this.detailNonDutyVOList = this.detailNonDutyVOList.filter(e => e.tdadSeq !== row.tdadSeq)
                this.$set(this.lightDelBtnVisible2, i, false)
            },
            delOverWork(row, i) {
                this.detailOverhoursVOList = this.detailOverhoursVOList.filter(e => e.tdadSeq !== row.tdadSeq)
                this.$set(this.lightDelBtnVisible, i, false)
            },
            cancelNotWork(i) {
                this.$set(this.lightDelBtnVisible2, i, false)
            },
            cancelOverWork(i) {
                this.$set(this.lightDelBtnVisible, i, false)
            },
            handleClose() {
                this.errorFlag = false
                this.showAddWork = false
                this.$emit('close')
            },
            handleSpan({ rowIndex, columnIndex }) {
                const len = this.workData.length
                if (rowIndex === len - 2 && columnIndex === 1) {
                    return [1, 2]
                } else if (rowIndex === len - 1 && columnIndex === 1) {
                    return [1, 2]
                }
            },
            async getApplyEmployPersonalInfo() {
                // 職員情報取得
                const { data } = await this.http.get('sys/vapply/EmployInfo', this.queryList)
                this.privateInfo.deptName = data.section
                this.privateInfo.name = data.name
                this.privateInfo.workType = data.worktype
            },
             //初期化処理
            async getInit() {
                console.log("getInit")
                console.log([[${ session.txtTmgReferListTreeViewPermTargetSection }]])
                console.log([[${ session.txtTmgReferListTreeViewPermSelectedView }]])
                console.log(Utils.formatDate([[${ session.TmgReferListSYSDATE }]], 'yyyy/mm/dd'))

                this.targetPermSection = ''
                //検索の初期化対応
                this.queryList.hidSelectTab = [[${ session.hidSelectTab }]]
                this.queryList.hidSearchItems = [[${ session.hidSearchItems }]]
                this.queryList.hidSearchCondition = [[${ session.hidSearchCondition }]]
                this.queryList.hidSearchData = [[${ session.hidSearchData }]]

                this.referListObject.hidSelectTab = [[${ session.hidSelectTab }]]
                this.referListObject.hidSearchItems = [[${ session.hidSearchItems }]] || 'EMPLOYEEID'
                this.referListObject.hidSearchCondition = [[${ session.hidSearchCondition }]] || 'BROADMATCH'
                this.referListObject.hidSearchData = [[${ session.hidSearchData }]]

                if([[${ session.txtTmgReferListTreeViewPermSelectedView }]] === "group"){
                    this.targetPermSection = [[${ session.txtTmgReferListTreeViewPermTargetGroup }]]
                } else if ([[${ session.txtTmgReferListTreeViewPermSelectedView }]] === "all"){
                    this.targetPermSection = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                } else if ([[${ session.txtTmgReferListTreeViewPermSelectedView }]] === "section"){
                    this.targetPermSection = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                }
                this.referListObject.txtTmgReferListTreeViewRecordDate = Utils.formatDate([[${ session.TmgReferListSYSDATE }]], 'yyyy/mm/dd')
                console.log("getOrgTree1")
                console.log(this.selectedDeptViewType)
                await this.getOrgTree()
                await this.getSearchCondition()

                //　初回管理サイトの画面にアクセスするなら、targetSectionがnullであることから、下記通りでデフォルト所属を設定する
                // １．ログインユーザが本人所属部署の承認権限がある場合、ログインユーザの所属部署をデフォルト所属とする。
                // ２．ログインユーザが本人所属部署の管理権限がない場合、ログインユーザの管理対象部署のTOP部署をデフォルト所属とする
                console.log("getDeptCode")
                console.log(this.targetPermSection)

                if (this.targetPermSection != null || this.targetPermSection != '') {
                    this.getDeptCode(this.treeData)
                    if (this.targetPermSectionFlag) {
                        console.log("getDeptCode_true")
                        console.log(this.treeData)
                        this.getDeptName(this.treeData)
                        this.queryList.txtTmgReferListTreeViewPermTargetSection = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                        this.queryList.txtTmgReferListTreeViewPermTargetGroup = [[${ session.txtTmgReferListTreeViewPermTargetGroup }]]
                        this.queryList.txtTmgReferListTreeViewPermSelectedView = [[${ session.txtTmgReferListTreeViewPermSelectedView }]]
                        this.queryList.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                        this.queryList.recordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                    } else {
                        console.log("getDeptCode_false")
                        console.log(this.treeData)
                        this.deptName = this.treeData[0].label
                        this.queryList.txtTmgReferListTreeViewPermTargetSection = this.treeData[0].secid
                        this.queryList.txtTmgReferListTreeViewPermTargetGroup = this.treeData[0].groupid
                        this.queryList.txtTmgReferListTreeViewPermSelectedView = [[${ session.txtTmgReferListTreeViewPermSelectedView }]]
                        this.queryList.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                        this.queryList.recordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                    }
                }

                //一覧画面取得
                //年月リストの取得
                //初期化
                this.tableHead = []
                this.tableData = []
                this.approval = false

                //年月リストの取得
                await this.getDispTmgMonthlyList()
                await this.getTableHead()
                if(this.dispMonthlyList.length>0){
                    await this.getTableData()
                }


            },
            getDeptCode(data) {
                data.forEach(e => {
                    if (e.secid === this.targetPermSection || e.groupid === this.targetPermSection) {
                        this.targetPermSectionFlag = true
                    } else {
                        const children = e.child || e.children
                        if (children) {
                            this.getDeptCode(children)
                        }
                    }
                })
            },
            async getSearchCondition() {
                const { data } = await this.http.get('sys/tree/conditions', this.referListObject)
                this.searchConditionsList= Object.keys(data.searchConditions).map(e=> { return { name:data.searchConditions[e], value:e }})
                this.searchTypesList = Object.keys(data.searchTypes).map(e=> { return { name:data.searchTypes[e], value:e }})
            },
            getDeptName(data) {
                // idによりループ処理でdeptNameを取得する
                data.forEach(e => {
                    if (e.secid === this.targetPermSection || e.groupid === this.targetPermSection) {
                        this.deptName = e.secnic || e.label
                    } else {
                        const children = e.child || e.children
                        if (children) {
                            this.getDeptName(children)
                        }
                    }
                })
            },
        }
    })
</script>
</body>

</html>