<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head
        th:replace="layout/header::common_header(title='承認状況一覧',cssPaths='/pages/content.min.css,' + '/pages/permstatlist.min.css')">
</head>

<body>
<div th:replace="layout/loadingBar::loadingBar"></div>
<main class="content permstatlist-warp" @scroll.passive="handleScroll" ref="layout">
    <div class="content_head">
        <div class="header">
            <div class="title1">
                <h1>
                    <Icon type="i-emeer colored"></Icon>
                    {{  '承認状況一覧' }}
                </h1>
            </div>
            <div class="btnbox">
                <span style="flex:1"></span>
                <i-button type="primary" size="large">月次一括承認</i-button>
                <!-- <div style="height:40px;margin:2px"></div> -->
            </div>
        </div>
        <div class="searchwrap">
            <span class="label">年月</span>
            <i-select :value="model1" :disabled="!selectDisabled" class="mr30" @on-change="handleDatePicker($event)" placeholder="選択ください">
                <i-option v-for="(item, index) of dispMonthlyList" :key="index" :value="item.val">
                </i-option>
            </i-select>
            <span style="display:flex;width: calc(15% + 200px);">
                    <span class="label">所属</span>
                    <i-button v-on:click.native="deptDrawShow = true" class="input-like-span mr30 cursor grey"
                              style="width: calc(100% - 120px);border-radius:0">
                        {{ showName(deptName) }}
                    </i-button>
                    <Drawer class="tc" title="所属を選択してください" placement="right" width="700" :closable="false"
                            v-model="deptDrawShow">
                        <div class="titlenorm mt15">
                            <Icon type="logo-buffer"></Icon>
                            所属
                        </div>
                        <Tree class="tree mt2" :data="treeData" @on-select-change="handleClickLeaf" ref="tree"
                              empty-text="所属データなし"></Tree>
                        <div class="titlenorm mt15">
                            <Icon type="logo-buffer"></Icon>
                            社員
                        </div>
                        <div style="position: relative;">
                            <Tree class="tree mt2" :data="empTreeData" @on-select-change="handleClickEmpLeaf" empty-text="社員データなし"></Tree>
                            <Spin size="large" fix v-if="emplistLoading"></Spin>
                        </div>
                    </Drawer>
                </span>
            <span style="flex:1"></span>
        </div>
    </div>
    <div class="content_body">
        <div class="table-top">
            <Row :gutter="16">
                <Col span="11">
                <i-button type="text" @click="preMonth">
                    <Icon type="ios-arrow-back"></Icon>
                    前月
                </i-button>
                <i-button type="text" @click="nextMonth">
                    翌月
                    <Icon type="ios-arrow-forward"></Icon>
                </i-button>
                </Col>
                <Col span="13" class="tr">
                <i-button type="primary" class="mr5" ghost @click="handleSelectAll(false)">選択状態をクリア</i-button>
                <i-button type="primary" class="mr5" ghost @click="handleSelectAll(true)">承認対象者を全選択</i-button>
                </Col>
            </Row>
        </div>
            <i-table class="long-table" border
                            ref="selection"
                            :columns="columns"
                            :data="tableData"
                            :disabled-hover="true"
                            :loading="loading"
                            no-data-text="所属を選択して下さい。">
                <template slot-scope="{ row }" slot="name">
                    <span @click="toWorkPage" class="mr10 pt2 pb2 pl10 pr10 cursor row-label-primary">{{ row.name }}</span>
                </template>

                <template v-for="item of slotList" slot-scope="{ row }" :slot="item">
                    <span @click="showDay" v-if="row[item] === 1" class="confirm-sytle ing">待</span>
                    <span @click="showDay" v-if="row[item] === 2" class="confirm-sytle">済</span>
                    <span @click="showDay" v-if="row[item] === 3" class="confirm-sytle undo">エ</span>
                </template>
            </i-table>
    </div>
</main>

<div th:replace="layout/script::common_script"></div>
<script type="text/babel" th:inline="javascript">
    const aliyun = "https://1615100189492697.ap-northeast-1.fc.aliyuncs.com/2016-08-15/proxy/api-dellen/test-func"
    const PERM_STATLIST = new Vue({
        el: '.permstatlist-warp',
        data() {
            return {
                monthSelect: Utils.getNumArray(1, 12).map(e => `${e}月`),
                curDate: new Date(),
                tableHead: [],
                tableData: [],
                slotList:Utils.getNumArray(1, 31).map(e => `m${e}`),
                dailyShow: true,
                rawData: [],
                isShow: false,
                showPre: true,
                loading: false,
                showDayApply: false,
                emplistLoading: false,
                referListObject: {
                    [[${ TREEVIEW_KEY_ADMIN_TARGET_SECTION }]]: '',
                    [[${ TREEVIEW_KEY_ADMIN_TARGET_EMP }]]: '',
                    [[${ TREEVIEW_KEY_RECORD_DATE }]]: '',
                    [[${ TREEVIEW_KEY_REFRESH_FLG }]]: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite')
                },
                deptDrawShow: false,
                treeData: [],
                empTreeData: [],
                defaultDeptId: '',
                deptName: '選んでください',
                query: {
                    employeeId: [[${ session.psSession.loginEmployee }]],
                    txtAction: 'ACT_DISP_MONTHLY',
                    txtDYYYYMM: '',
                    txtDYYYYMMDD: '',
                    txtCEMPLOYEEID: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite')
                },
                selectDisabled: false,    //年月選択可否制御
                dispMonthlyList: [],       //年月リスト
                model1: ''
            }
        },
        async mounted() {
            console.log([[${ session }]])
            this.getOrgTree()
        },
        computed: {
            tableHeadFixed() {
                if (this.contentScrollTop > 300) return true
                else return false
            },
            columns() {
                let result = [
                    {
                        title: '氏名',
                        slot: 'name',
                        minWidth: 100,
                        align: 'right'
                    },
                    {
                        title: '月次\n承認',
                        minWidth: 36,
                        key: 'vacationDivision',
                        align: 'center'
                    }
                ]
                this.tableHead.forEach((e, i) => {
                    result = result.concat({
                        // title: e,
                        className: e.indexOf('土') > -1 || e.indexOf('日') > -1 ? 'rest' : '',
                        minWidth: 25,
                        renderHeader: (h, params) => {
                            return (
                                <span style="cursor: pointer;" class={'table-head'} onClick={this.handleClickHead.bind(this, params)}>{e}</span>
                            )
                        },
                        slot: `m${i + 1}`,
                        align: 'center'
                    })
                })
                result = result.concat({
                    type: 'selection',
                    width: 60,
                    align: 'center'
                })
                return result
            }
        },
        methods: {
            async getDispTmgMonthlyList() {
                this.loading = false
                const { data } = await this.http.get('sys/permStatList/dispTmgMonthlyList', this.query)
                this.dispMonthlyList = data
                this.$nextTick(()=>{this.model1 = data[0].val},500)
                this.selectDisabled = true

                console.log("getDispTmgMonthlyList")
                console.log(this.model1)
                console.log(this.dispMonthlyList)

            },
            async getTableHead() {
                const { data } = await this.http.get(`${aliyun}/workApplyStatus/tableHead`)
                this.tableHead = data
            },
            async getTableData() {
                const { data } = await this.http.get(`${aliyun}/workApplyStatus/tableData`)
                this.tableData = data
                this.getDeptName(this.treeData)
            },
            async getOrgTree() {
                try {
                    const { data } = await this.http.get('sys/tree/admin/orglist', this.referListObject)
                    // 先将数据转为标准格式，再转为可用数据
                    this.treeData = Utils.convertTreeData(Utils.convertToData(data))
                } catch (error) {
                    return
                } finally {
                    this.loading = false
                }
            },
            getDeptName(data) {
                // 根据id遍历找出deptName
                data.forEach(e => {
                    if (e.secid === this.defaultDeptId) {
                        this.deptName = e.label
                    } else {
                        const children = e.child || e.children
                        if (children) {
                            this.getDeptName(children)
                        }
                    }
                })
            },
            // async handleClickLeaf(e) {
            //     console.log('e1')
            //     console.log(e)
            //     this.deptDrawShow = false
            //     const section = [[${ TREEVIEW_KEY_ADMIN_TARGET_SECTION }]]
            //     this.referListObject[section] = e[0].secid
            //     this.defaultDeptId = e[0].secid
            //     this.getTableData()
            // },
            preMonth() {

            },
            nextMonth() {

            },
            rowClass(row) {
                // 表格变色
                if (!row.dayDivisionCode || row.dayDivisionCode === '1') {
                    return ''
                }
                return 'sat'
            },
            handleScroll: Throttle(function(e) {
                this.contentScrollTop = e.target.scrollTop
                if (e.target.scrollTop > 200) {
                    this.isScroll = true
                } else {
                    this.isScroll = false
                }
            }, 50),
            showDay: Debounce(function() {
                this.isShow = true
            }),
            toTop() {
                const animateMachine = requestAnimationFrame(this.toTop)
                this.$refs.layout.scrollTop = this.$refs.layout.scrollTop - this.$refs.layout.scrollTop / 5
                if (this.$refs.layout.scrollTop === 0) {
                    cancelAnimationFrame(animateMachine)
                }
            },
            convertTreeData(treeData = []) {
                return treeData.map(e => {
                    const children = e.child || e.children
                    if (children) {
                        return {
                            ...e.data,
                            title: e.data.label,
                            // 前两层级默认展开方便查看
                            expand: e.data.level < 2 || !e.data.level,
                            children: this.convertTreeData(children)
                        }
                    } else {
                        return {
                            ...e.data,
                            title: e.data.label
                        }
                    }
                })
            },
            showDay() {
                //todo: 跳到详情页
                location.href = "./VacationTablePanel/vacationtablepanel.html";
            },
            handleSelector() { },
            getDeptName(data) {
                // 根据id遍历找出deptName
                data.forEach(e => {
                    if (e.secid === this.defaultDeptId) {
                        this.deptName = e.label
                    } else {
                        const children = e.child || e.children
                        if (children) {
                            this.getDeptName(children)
                        }
                    }
                })
            },
            async handleClickLeaf(e) {
                console.log('e2')
                console.log(e)
                const section = [[${ TREEVIEW_KEY_ADMIN_TARGET_SECTION }]]
                this.referListObject[section] = e[0].secid
                this.defaultDeptId = e[0].secid

                this.getDispTmgMonthlyList()

                this.getTableHead()
                this.getTableData()

                // this.getEmpList()
            },
            async getEmpList() {
                try {
                    this.emplistLoading = true
                    const { data } = await this.http.get('sys/tree/admin/emplist', this.referListObject)
                    this.empTreeData = Utils.convertTreeData(Utils.convertToData(data))
                } catch (error) {
                    return
                } finally {
                    this.emplistLoading = false
                }
            },
            // todo: 点完员工树干什么
            handleClickEmpLeaf(e) {
                this.deptDrawShow = false
                // this.getData(true)
            },
            showName(e) {
                const result = e.match(/^[\s\S]+(?=\()/g)
                return (result && result[0]) || e
            },
            handleClickHead() {
                this.showDayApply = true
            },
            toWorkPage() {
                // this.$router.push('/sys/confirmer/applyWork')
            },
            handleSelectAll(status) {
                this.$refs.selection.selectAll(status)
            },
            handleSelectAll2(status) {
                this.$refs.selection2.selectAll(status)
            },
            handleDatePicker() {}
        }
    })
</script>
</body>

</html>