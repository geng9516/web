<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='権限設定',cssPaths='/pages/content.min.css')">
</head>

<body>
    <div th:replace="layout/loadingBar::loadingBar"></div>
    <main class="content perms-warp" @scroll.passive="handleScroll" ref="layout">
        <div class="content_head">
            <div class="header">
                <div class="title1">
                    <h1>
                        <Icon type="i-emeer colored"></Icon>
                        {{  '権限設定' }}
                    </h1>
                </div>
                <div class="btnbox">
                    <span style="flex:1"></span>
                    <i-button type="primary" size="large" @click="permissionAdminAdd = true">承認者追加</i-button>
                    <i-button type="primary" size="large" @click="PermissionGroupAdd = true">グループ作成</i-button>
                    <i-button type="primary" size="large" @click="PermissionMemberAssign = true">メンバー割付</i-button>
                    <!-- <div style="height:40px;margin:2px"></div> -->
                </div>
            </div>
            <div class="searchwrap">
                <span class="label">改訂日指定</span>
                <date-picker class="mar" v-model="curDate" type="month" :editable="false" :clearable="false"
                    @on-change="handleDatePicker" format="yyyy年MM月dd日"></date-picker>
                <!-- 共通組織図画面 start-->
                <span style="display:flex;width: calc(15% + 200px);">
                    <span class="label">所属</span>
                    <i-button v-on:click.native="deptDrawShow = true" class="input-like-span mr30 cursor grey"
                        style="width: calc(100% - 120px);border-radius:0">
                        {{ deptName }}
                    </i-button>
                    ​
                    <Drawer class="tc" title="所属を選択してください" placement="right" width="700" :closable="false"
                        :mask-closable="!isSearchHistory" v-model="deptDrawShow">
                        <div class="titlenorm mb5">
                            <Icon type="logo-buffer"></Icon>
                            所属
                        </div>
                        <Row class="tl mb5">
                            <i-col span="4" class="label tc" style="height: 32px;">基準日</i-col>
                            <i-col span="7" class="no-border-radius">
                                <date-picker type="date" :value="referListObject.txtTmgReferListTreeViewRecordDate"
                                    placeholder="基準日" format="yyyy/MM/dd" ref="datePicker"
                                    @on-change="handleDeptDateChange"></date-picker>
                            </i-col>
                        </Row>
                        ​
                        <div style="position: relative;">
                            <Tree class="tree mt2" :data="treeData" v-on:on-select-change="handleClickLeaf" ref="tree"
                                empty-text="所属データなし"></Tree>
                            <Spin size="large" fix v-if="deptLoading"></Spin>
                        </div>
                    </Drawer>
                </span>
                <!-- 共通組織図画面 end-->
                <span style="flex:1"></span>
            </div>
        </div>
        <div class="content_body">
            <i-table border :columns="columns" :data="tableData" :span-method="handleSpan" :loading="loading"
                :disabled-hover="true">
                <template slot-scope="{ row }" slot="group">
                    <i-button type="primary" ghost size="small" :class="row.preIndex !== 0 ? 'ml30 width75' : 'width75'"
                        @click="handleOverFlag">
                        {{ row.group }}
                    </i-button>
                </template>
                <template slot-scope="{ row }" slot="name">
                    <i-button type="primary" ghost size="small" long v-if="row.name" @click="handleEditData">
                        {{ row.name }}
                    </i-button>
                    <span v-else class="grey">未设定</span>
                </template>
                <template slot-scope="{ row }" slot="workConfirm">
                    <span class="blue">{{ row.workConfirm ? '〇' : '' }}</span>
                </template>

                <template slot-scope="{ row }" slot="monthConfirm">
                    <span class="blue">{{ row.monthConfirm ? '〇' : '' }}</span>
                </template>

                <template slot-scope="{ row }" slot="overWorkConfirm">
                    <span class="blue">{{ row.overWorkConfirm ? '〇' : '' }}</span>
                </template>

                <template slot-scope="{ row }" slot="scheduleCreate">
                    <span class="blue">{{ row.scheduleCreate ? '〇' : '' }}</span>
                </template>

                <template slot-scope="{ row }" slot="permissionGive">
                    <span class="blue">{{ row.permissionGive ? '〇' : '' }}</span>
                </template>

                <template slot-scope="{ row }" slot="restConfirm">
                    <span class="blue">{{ row.restConfirm ? '〇' : '' }}</span>
                </template>
            </i-table>
        </div>

        <!-- 承認者追加画面 start-->
        <Modal v-model="permissionAdminAdd" title="承認者追加" footer-hide :mask-closable="false" @on-cancel="cancel">
            <!-- <i-form :label-width="120" ref="localValue" :model="localValue" :rules="ruleValidate">
                <form-item label="所属">
                    <Select v-model="localValue.group" filterable transfer>
                        <i-option v-for="(item, i) of groupList" :value="item.value" :key="i">{{ item.name }}</i-option>
                    </Select>
                </form-item>

                <form-item label="承認者氏名">
                    <Select v-model="localValue.group" filterable transfer>
                        <i-option v-for="(item, i) of userList" :value="item.value" :key="i">{{ item.name }}</i-option>
                    </Select>
                </form-item>

                <div class="titlenorm mt15">
                    <Icon type="logo-buffer"></Icon>
                    権限
                </div>
                <form-item label="就業承認">
                    <check-box class="input-like-span"></check-box>
                </form-item>

                <form-item label="月次承認">
                    <check-box class="input-like-span"></check-box>
                </form-item>

                <form-item label="超過勤務命令">
                    <check-box class="input-like-span"></check-box>
                </form-item>

                <form-item label="予定作成">
                    <check-box class="input-like-span"></check-box>
                </form-item>

                <form-item label="権限付与">
                    <check-box class="input-like-span"></check-box>
                </form-item>

                <form-item label="休暇・休業承認">
                    <check-box class="input-like-span"></check-box>
                </form-item>

                <form-item label="決裁レベル">
                    <Select transfer>
                        <i-option v-for="(item, i) of 5" :value="item" :key="i">{{ item }}</i-option>
                    </Select>
                </form-item>

                <form-item label="有効期間">
                    <date-picker :value="localValue.timeStart" format="yyyy/MM/dd" type="date" transfer
                        style="width:48%"></date-picker>
                    <span style="vertical-align: super;"> - </span>
                    <date-picker :value="localValue.timeEnd" format="yyyy/MM/dd" type="date" transfer style="width:48%">
                    </date-picker>
                </form-item>
            </i-form> -->
            <div class="my-footer">
                <i-button type="text" @click="cancel">キャンセル</i-button>
                <i-button type="success" size="large" @click="add()">登録</i-button>
            </div>
        </Modal>
        <!-- 承認者追加画面 end-->

        <!-- グループ作成 start-->
        <Modal v-model="PermissionGroupAdd" title="グループ作成" footer-hide :mask-closable="false" @on-cancel="cancel">
            <!-- <i-form :label-width="120" ref="localValue" :model="localValue" :rules="ruleValidate">
                <form-item label="所属">
                    <span class="input-like-span">{{ localValue.group }}</span>
                </form-item>
                <form-item label="改訂日">
                    <span class="input-like-span">{{ localValue.date }}</span>
                </form-item>
                <form-item label="新規グループ" prop="name">
                    <i-input v-model="localValue.name" placeholder="新規グループ" :maxlength="15"></i-input>
                </form-item>
            </i-form> -->
            <div class="my-footer">
                <i-button type="text" @click="cancel">キャンセル</i-button>
                <i-button type="success" size="large" @click="add()">登録</i-button>
            </div>
        </Modal>
        <!-- グループ作成 end-->

        <!-- メンバー割付 start-->
        <Modal v-model="PermissionMemberAssign" title="メンバー割付" width="650" footer-hide :mask-closable="false" @on-cancel="cancel">
            <!-- <i-form :label-width="120" ref="localValue" :model="localValue" :rules="ruleValidate">
                <form-item label="所属">
                    <span class="input-like-span">{{ localValue.group }}</span>
                </form-item>
                <form-item label="改訂日">
                    <span class="input-like-span">{{ localValue.date }}</span>
                </form-item>
            </i-form> -->
            <div class="titlenorm mt15">
                <Icon type="logo-buffer"></Icon>
                メンバー割付
            </div>
            <!-- <i-table border :columns="columns" :data="data" :loading="loading">
                <template slot-scope="{ row }" slot="group">
                    <Select v-model="row.newGroup" filterable transfer>
                        <i-option v-for="(item, i) of groupList" :value="item.value" :key="i">{{ item.name }}</i-option>
                    </Select>
                </template>
            </i-table> -->
            <div class="my-footer">
                <i-button type="text" @click="cancel">キャンセル</i-button>
                <i-button type="success" size="large" @click="add()">登録</i-button>
            </div>
        </Modal>
        <!-- メンバー割付 end-->

        <!-- 権限変更 start-->
        <Modal v-model="PermissionEditerModals" width="1280" title="権限変更" footer-hide :mask-closable="false" @on-cancel="cancel">
            <Row>
                <i-col span="4">
                <div class="label">所属</div>
                </i-col>
                <i-col span="5">
                <span class="input-like-span">XX庁</span>
                </i-col>
            </Row>
            <!-- <i-table border :columns="columns" :data="data" :loading="loading" class="mt15 mb20">
                <template slot-scope="{ row }" slot="workConfirm">
                    <check-box v-model="row.workConfirm"></check-box>
                </template>

                <template slot-scope="{ row }" slot="monthConfirm">
                    <check-box v-model="row.monthConfirm"></check-box>
                </template>

                <template slot-scope="{ row }" slot="overWorkConfirm">
                    <check-box v-model="row.overWorkConfirm"></check-box>
                </template>

                <template slot-scope="{ row }" slot="scheduleCreate">
                    <check-box v-model="row.scheduleCreate"></check-box>
                </template>

                <template slot-scope="{ row }" slot="permissionGive">
                    <check-box v-model="row.permissionGive"></check-box>
                </template>

                <template slot-scope="{ row }" slot="restConfirm">
                    <check-box v-model="row.restConfirm"></check-box>
                </template>

                <template slot-scope="{ row }" slot="level">
                    <Select transfer>
                        <i-option v-for="(item, i) of 5" :value="item" :key="i">{{ item }}</i-option>
                    </Select>
                </template>

                <template slot-scope="{ row }" slot="validPeriod">
                    <date-picker class="mt10" format="yyyy/MM/dd" type="date" transfer style="width:46%"
                        placement="bottom-end"></date-picker>&nbsp;-&nbsp;<date-picker  format="yyyy/MM/dd" type="date"
                        transfer style="width:46%" placement="bottom-end"></date-picker>
                </template>

                <template slot-scope="{ row }" slot="delete">
                    <i-button type="error" ghost size="small">削除</i-button>
                </template>
            </i-table> -->

            <div class="my-footer">
                <i-button type="text" @click="cancel">キャンセル</i-button>
                <i-button type="primary" size="large" @click="update()">変更</i-button>
            </div>
        </Modal>
        <!-- 権限変更 end-->

        <!-- 警告値設定 start-->
        <Modal v-model="PermissionFlagModals" width="650" title="警告値設定" footer-hide :mask-closable="false" @on-cancel="cancel">
            <!-- <i-form :label-width="120" ref="localValue" :model="localValue" :rules="ruleValidate">
                <form-item label="所属">
                    <span class="input-like-span">{{ localValue.group }}</span>
                </form-item>
                <form-item label="改訂日">
                    <span class="input-like-span">{{ localValue.date }}</span>
                </form-item>
                <form-item label="夜間連携">
                    <check-box class="input-like-span">デフォルト承認者の自動設定を行う</check-box>
                </form-item>
            </i-form> -->

            <!-- <i-table border :columns="overFlagColumns" :data="overFlagData" :loading="loading" class="mt15 mb20">
                <template slot-scope="{ row }" slot="time">
                    <i-input v-model="row.time" />
                </template>
            </i-table>

            <i-table border :columns="restFlagColumns" :data="restFlagData" :loading="loading">
                <template slot-scope="{ row }" slot="time">
                    <i-input v-model="row.time" />
                </template>
            </i-table> -->
            <div class="my-footer">
                <i-button type="text" @click="cancel">キャンセル</i-button>
                <i-button type="primary" size="large" @click="update()">変更</i-button>
            </div>
        </Modal>
        <!-- 警告値設定 end-->
    </main>

    <div th:replace="layout/script::common_script"></div>
    <script type="text/babel" th:inline="javascript">
        const PERM_SETTING = new Vue({
            el: '.perms-warp',
            data() {
                return {
                    curDate: new Date(),
                    columns: [
                        {
                            title: 'グループ',
                            width: 180,
                            slot: 'group'
                        },
                        {
                            title: '承認者氏名',
                            width: 260,
                            align: 'center',
                            slot: 'name'
                        },
                        {
                            title: '権限',
                            children: [
                                {
                                    title: '就業承認',
                                    slot: 'workConfirm',
                                    align: 'center'
                                },
                                {
                                    title: '月次承認',
                                    slot: 'monthConfirm',
                                    align: 'center'
                                },
                                {
                                    title: '超過勤務命令',
                                    slot: 'overWorkConfirm',
                                    align: 'center'
                                },
                                {
                                    title: '予定作成',
                                    slot: 'scheduleCreate',
                                    align: 'center'
                                },
                                {
                                    title: '権限付与',
                                    slot: 'permissionGive',
                                    align: 'center'
                                },
                                {
                                    title: '休暇・休業承認',
                                    slot: 'restConfirm',
                                    align: 'center'
                                },
                                {
                                    title: '決裁レベル',
                                    key: 'level',
                                    align: 'center'
                                }
                            ]
                        },
                        {
                            title: '有効期間',
                            align: 'center',
                            width: 220,
                            key: 'validPeriod'
                        }
                    ],
                    loading: false,
                    tableData: [],
                    mergeSpanInfo: [],
                    emplistLoading: false,
                    referListObject: {
                        txtTmgReferListTreeViewRecordDate: '',
                        txtTmgReferListTreeViewAdminTargetSection: '',
                        txtTmgReferListTreeViewAdminTargetGroup: '',
                        txtTmgReferListTreeViewAdminTargetEmp: '',
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        psApp: Utils.getUrlParam(location.href, 'psApp'),
                        type: 31
                    },
                    query: {},
                    empTreeData: [],
                    deptName: '選んでください',
                    data: [],
                    treeData: [],
                    isSearchHistory: false,
                    deptLoading: false,
                    deptDrawShow: false,
                    permissionAdminAdd: false,
                    PermissionGroupAdd: false,
                    PermissionMemberAssign: false,
                    PermissionEditerModals: false,
                    PermissionFlagModals: false,
                    // 承認者追加画面
                    localValue: {
                        name: '',
                        group: '1',
                        date: '2019年11月01日(金)'
                    },
                    ruleValidate: {
                        name: [
                            {
                                required: true,
                                message: '入力してください',
                                trigger: 'blur'
                            }
                        ]
                    },
                    groupList: [
                        {
                            name: 'XX庁',
                            value: '1'
                        },
                        {
                            name: '新しいチーム',
                            value: '2'
                        },
                        {
                            name: '総括補佐チーム',
                            value: '3'
                        }
                    ],
                    userList: [
                        {
                            name: '眞鍋 孝司',
                            value: '1'
                        }],
                }
            },
            async mounted() {
                this.getOrgTree()
                // this.getTableHead()
            },
            watch: {
                data: {
                    handler() {
                        let result = []
                        // 后端仅需返回netWork中请求的响应数据即可
                        // 此处理产生前端表格渲染数据以及行列合并的信息
                        // 示例合并信息说明如下
                        // [
                        //   {
                        //     deptOccupy: 4, // 第一条国创厅占了 4 条
                        //     whichMemberDuplicate: [
                        //       [0, 3], // 第一个承认者重复了 3 条
                        //       [1, 2]  // 第二个承认者重复了 2 条 以下循环相同
                        //     ]
                        //   },
                        //   { deptOccupy: number, whichMemberDuplicate: Array<T> }
                        // ]

                        this.mergeSpanInfo = this.data.map((e, i) => {
                            // 每一条中所属占了几行
                            let deptOccupy = 0
                            // 个人占据了多少条
                            let whichMemberDuplicate = []
                            if (!e.memberList) {
                                result = result.concat({ group: e.group })
                            } else {
                                e.memberList.forEach((j, _i) => {
                                    if (!j.validList) {
                                        // 成员无任何权限时
                                        deptOccupy += 1
                                        result = result.concat({ preIndex: i, group: e.group, name: j.name })
                                    } else {
                                        deptOccupy += j.validList.length
                                        if (j.validList.length > 1) {
                                            whichMemberDuplicate.push([_i, j.validList.length])
                                        }
                                        j.validList.forEach(h => {
                                            result = result.concat({ preIndex: i, group: e.group, name: j.name, ...h })
                                        })
                                    }
                                })
                            }
                            // 一条所属占据一行以上的，才将详细占据信息存入
                            if (deptOccupy > 1) {
                                return { deptOccupy, whichMemberDuplicate: whichMemberDuplicate }
                            } else {
                                return { deptOccupy: 1 }
                            }
                        })
                        this.tableData = result
                    },
                    immediate: true
                }
            },
            computed: {
                columns() {
                    return []
                },
            },
            methods: {
                handleDatePicker() {
                    this.query.baseMonth = Utils.formatDate(this.curDate, 'yyyy/MM').concat('/01')
                    if (this.deptName !== '選んでください') {
                        // this.getTableHead()
                        // this.getTableData()
                        return
                    }
                    this.$Notice.warning({ title: '所属を選択して下さい' })
                },
                async getOrgTree() {
                    this.deptLoading = true
                    try {
                        const { sectionList, recordDate, sysDate } = await this.http.get('sys/tree', this.referListObject)
                        // 转为可用数据
                        this.treeData = Utils.convertTreeData(sectionList)
                        this.referListObject.txtTmgReferListTreeViewRecordDate = recordDate
                        this.sysDate = sysDate
                    } catch (error) {
                        return
                    } finally {
                        this.loading = false
                        this.deptLoading = false
                    }
                },
                async handleDeptDateChange(e) {
                    this.referListObject.txtTmgReferListTreeViewRecordDate = e
                    this.isSearchHistory = true
                    await this.getOrgTree()
                    this.$Notice.warning({ title: '所属図更新完了', desc: "下記の所属リストから対象を選んでください" })
                },
                handleClickLeaf(e) {
                    if (!e[0]) return
                    this.deptDrawShow = false
                    this.deptName = e[0].secnic
                    this.query.txtTmgReferListTreeViewAdminTargetSection = e[0].secid
                    this.query.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                    this.getTableHead()
                    this.getTableData()
                },
                async getTableHead() {
                    // this.query.txtAction = 'ACT_DISP_MONTHLY'
                    // const { data } = await this.http.get('sys/permStatList/selectDayHead', this.query)
                    // this.tableHead = data
                },
                async getTableData() {
                    // this.listLoading = true
                    // const { data } = await this.http.get('sys/permStatList/getTmgMonthlyInfoVOList', this.query)
                    // this.tableData = data.tmgMonthlyInfoVOList
                    // this.approval = data.approval
                    // this.listLoading = false
                    // this.isSearchHistory = false
                },
                cancel() {
                    this.$refs.localValue.resetFields()
                    this.isShow = false
                },
                add() {
                    this.$refs.localValue.validate(valid => {
                        if (valid) {
                            this.$emit('add')
                            this.isShow = false
                        }
                    })
                },
                handleSpan({ rowIndex, columnIndex }) {
                    // 这里将得到得合并信息进行表格列项合并
                    let result = []
                    let curColumn = 0
                    this.mergeSpanInfo.forEach(e => {
                        if (!e.whichMemberDuplicate) {
                            // 不合并未设定承认者的行
                            curColumn += 1
                            return
                        }
                        // 下面判断合并グループ
                        for (let i = 0; i < e.deptOccupy; i++) {
                            if (i === 0) {
                                if (rowIndex === i + curColumn && columnIndex === 0) {
                                    result = [e.deptOccupy, 1]
                                }
                            } else {
                                if (rowIndex === i + curColumn && columnIndex === 0) {
                                    result = [0, 0]
                                }
                            }
                        }
                        // 下面判断合并承認者
                        let memberHelpCount = curColumn
                        e.whichMemberDuplicate.forEach(t => {
                            for (let j = 0; j < t[1]; j++) {
                                if (j === 0) {
                                    if (rowIndex === j + memberHelpCount && columnIndex === 1) {
                                        result = [t[1], 1]
                                    }
                                } else {
                                    if (rowIndex === j + memberHelpCount && columnIndex === 1) {
                                        result = [0, 0]
                                    }
                                }
                            }
                            memberHelpCount += t[1]
                        })
                        // 更新列位置
                        curColumn += e.deptOccupy
                    })
                    return result
                },
            }
        })
    </script>
</body>

</html>