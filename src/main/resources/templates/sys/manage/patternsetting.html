<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='勤務パターン設定',cssPaths='/pages/content.min.css')">
</head>

<body>
<div th:replace="layout/loadingBar::loadingBar"></div>
<!-- 菜单导航栏 -->
<div th:replace="layout/sider"></div>
<main class="content patternSetting-warp" ref="layout">
    <div class="content_head">
        <div class="header">
            <div class="title1">
                <h1>
                    <Icon type="i-emeer colored"></Icon>
                    {{ ' 勤務パターン設定 ' }}
                </h1>
            </div>
            <div class="btnbox">
                <span style="flex:1"></span>
                <i-button icon="md-create" disabled v-if="!addPatternShow">
                    新規
                </i-button>
                <i-button icon="ios-cloud-upload-outline" v-if="!addPatternShow" disabled>
                    CSVファイル取込
                </i-button>
                <i-button type="success" icon="md-create" 　@click="mergePattern(null)" :loading="bulkApprovalLoading" v-if="addPatternShow">新規</i-button>
                <i-button type="primary" ghost icon="ios-cloud-upload-outline" v-if="addPatternShow" @click="csvuploadModal = true">
                    CSVファイル取込
                </i-button>
            </div>
        </div>
        <div class="searchwrap">
            <!--<span class="label">改訂日</span>
            <date-picker class="mar" v-model="curDate" type="date" :editable="false" :clearable="false" @on-change="handleDatePicker" format="yyyy年MM月dd日" ></date-picker>-->
            <span style="display:flex;width: calc(15% + 200px);">
               <span class="label">所属</span>
               <i-button v-on:click.native="deptDrawShow = true" class="input-like-span dept-select">
                <Tooltip trigger="hover" :theme="toolTipTheme()" transfer>{{deptName}}
                    <div slot="content">{{deptName}}</div>
                </Tooltip>
            </i-button>
               <Drawer class="tc" placement="right" width="700" :closable="false" :mask-closable="!isSearchHistory" v-model="deptDrawShow">
                   <div class="titlenorm mb5">
                      <Icon type="logo-buffer"></Icon>
                      所属
                   </div>
                   <Row class="tl mb5">
                       <i-col span="4" class="label tc" style="height: 32px;">基準日</i-col>
                       <i-col span="7" class="no-border-radius">
                          <date-picker type="date" 　v-model="curDate" :value="referListObject.txtTmgReferListTreeViewRecordDate" placeholder="基準日" format="yyyy/MM/dd" ref="datePicker"
                                       :clearable="false" @on-change="handleDeptDateChange" transfer></date-picker>
                       </i-col>
                        <i-col span="4" class="label ml5 tc" style="height: 32px;">ビュー選択</i-col>
                          <div style="display: inline-block;width: 32.5%;" class="no-border-radius">
                            <i-select v-model="selectedDeptViewType" @on-change="handleDeptViewTypeChange">
                              <i-option :value="2">グループごとに</i-option>
                              <i-option :value="3">部署ごとに</i-option>
                            </i-select>
                          </div>
                        </Row>

                        <div style="position: relative;">
                          <Tree class="tree mt2" :data="treeData" v-on:on-select-change="handleClickLeaf" ref="tree"
                                empty-text="所属データなし"></Tree>
                          <Spin size="large" fix v-if="empDeptLoading"></Spin>
                        </div>
                      </Drawer>
                </span>
            <span style="flex:1"></span>
        </div>
    </div>
    <div class="content_body">
        <Alert class="primary-info tl" v-if="periodDate != ''">※ 適用処理は{{ periodDate }}以降の場合のみ利用する事が出来ます。{{ periodDate }}より前の勤務に対するパターンの適用は、予定作成から行ってください。</Alert>
        <Row :gutter="8">
            <i-col span="7">
                <i-table :columns="sk_column" :data="sk_list" border :loading="tableLoading" no-data-text="" :row-class-name="() => 'select-col'">
                </i-table>
            </i-col>
            <i-col :span="17">
                <i-table :class="" :columns="columns" :data="tmgPatternList" border :loading="tableLoading" :disabled-hover="true" :row-class-name="() => 'select-col'">
                    <!-- 勤務時間 -->
                    <template slot-scope="{ row }" slot="dutyTime">
                        <span v-for="(item,i) of row.planDuty" :key="i">{{item.NOPEN|handleTime}}～{{item.NCLOSE|handleTime}}</span>
                    </template>
                    <!-- 休憩時間 -->
                    <template slot-scope="{row}" slot="restTime">{{handleRestTime(row.planRest)}}</template>

                    <template slot-scope="{ row }" slot="action">
                        <div>
                            <i-button type="primary" ghost size="small" icon="ios-create" style="margin-right: 5px" :disabled="!editPatternShow" v-if="row.edit===false">編集</i-button>
                            <i-button type="primary" ghost size="small" icon="ios-create" style="margin-right: 5px" @click="mergePattern(row)" :disabled="editPatternShow" v-else>編集</i-button>

                            <i-button type="error" ghost size="small" icon="ios-trash" class="collapse-btn ivu-btn ivu-btn-error ivu-btn-small ivu-btn-ghost" 　style="margin-right: 5px"
                                      :disabled="!deletePatternShow" v-if="row.edit===false">削除
                            </i-button>
                            <i-button type="error" ghost size="small" icon="ios-trash" 　class="collapse-btn ivu-btn ivu-btn-error ivu-btn-small ivu-btn-ghost" style="margin-right: 5px"
                                      @click="deletePattern(row)" :disabled="deletePatternShow" v-else>削除
                            </i-button>
                        </div>
                    </template>

                </i-table>
            </i-col>
        </Row>
    </div>
    <back-top></back-top>
    <!-- 勤務パターンSTART -->
    <Modal v-model="isShow" :title="pageTitle" footer-hide :mask-closable="false" @on-cancel="cancel">
        <Alert type="error" class="error-info" v-show="errorFlag">{{ errorMsg }}</Alert>
        <i-form :label-width="120" ref="localValue" :model="localValue">
            <form-item label="所属" prop="deptName" class="ivu-form ivu-form-label-right">
                <i-button class="input-like-span mr30 cursor grey width100 border-radius:0">
                    {{ deptName }}
                </i-button>
            </form-item>
            <form-item label="コード" prop="patternId">
                <i-input v-model="rawData.tpa_cpatternid" :disabled="isPatternCodeDisable" 　placeholder="入力してください"></i-input>
            </form-item>

            <form-item label="名称" prop="patternName">
                <i-input v-model="rawData.tpa_cpatternname" placeholder="入力してください"></i-input>
            </form-item>

            <form-item label="勤務時間" prop="dutyTime">
                <Row>
                    <i-col span="10">
                        <i-input v-model="rawData.dutyTime[0]" placeholder="開始時間" maxlength="5" icon="ios-clock-outline"
                                 @on-blur="handleInputChange(rawData.dutyTime,0,$event.target)"></i-input>
                    </i-col>
                    <i-col span="4">
                        <span style="display: inline-block;vertical-align: sub;color:grey;margin-top: 17px;margin-left: 20px">～</span>
                    </i-col>
                    <i-col span="10">
                        <i-input v-model="rawData.dutyTime[1]" placeholder="終了時間" maxlength="5" icon="ios-clock-outline"
                                 @on-blur="handleInputChange(rawData.dutyTime,1,$event.target)"></i-input>
                    </i-col>
                </Row>
            </form-item>

            <form-item label="休憩時間1" prop="restTime1">
                <Row>
                    <i-col span="10">
                        <i-input v-model="rawData.planRest1[0]" placeholder="開始時間" maxlength="5" icon="ios-clock-outline"
                                 @on-blur="handleInputChange(rawData.planRest1,0,$event.target)"></i-input>
                    </i-col>
                    <i-col span="4">
                        <span style="display: inline-block;vertical-align: sub;color:grey;margin-top: 17px;margin-left: 20px">～</span>
                    </i-col>
                    <i-col span="10">
                        <i-input v-model="rawData.planRest1[1]" placeholder="終了時間" maxlength="5" icon="ios-clock-outline"
                                 @on-blur="handleInputChange(rawData.planRest1,1,$event.target)"></i-input>
                    </i-col>
                </Row>
            </form-item>

            <form-item label="休憩時間2" prop="restTime2">
                <Row>
                    <i-col span="10">
                        <i-input v-model="rawData.planRest2[0]" placeholder="開始時間" maxlength="5" icon="ios-clock-outline"
                                 @on-blur="handleInputChange(rawData.planRest2,0,$event.target)"></i-input>
                    </i-col>
                    <i-col span="4">
                        <span style="display: inline-block;vertical-align: sub;color:grey;margin-top: 17px;margin-left: 20px">～</span>
                    </i-col>
                    <i-col span="10">
                        <i-input v-model="rawData.planRest2[1]" placeholder="終了時間" maxlength="5" icon="ios-clock-outline"
                                 @on-blur="handleInputChange(rawData.planRest2,1,$event.target)"></i-input>
                    </i-col>
                </Row>
            </form-item>

            <form-item label="休憩時間3" prop="restTime3">
                <Row>
                    <i-col span="10">
                        <i-input v-model="rawData.planRest3[0]" placeholder="開始時間" maxlength="5" icon="ios-clock-outline"
                                 @on-blur="handleInputChange(rawData.planRest3,0,$event.target)"></i-input>
                    </i-col>
                    <i-col span="4">
                        <span style="display: inline-block;vertical-align: sub;color:grey;margin-top: 17px;margin-left: 20px">～</span>
                    </i-col>
                    <i-col span="10">
                        <i-input v-model="rawData.planRest3[1]" placeholder="終了時間" maxlength="5" icon="ios-clock-outline"
                                 @on-blur="handleInputChange(rawData.planRest3,1,$event.target)"></i-input>
                    </i-col>
                </Row>
            </form-item>

            <form-item label="休憩時間4" prop="restTime4">
                <Row>
                    <i-col span="10">
                        <i-input v-model="rawData.planRest4[0]" placeholder="開始時間" maxlength="5" icon="ios-clock-outline"
                                 @on-blur="handleInputChange(rawData.planRest4,0,$event.target)"></i-input>
                    </i-col>
                    <i-col span="4">
                        <span style="display: inline-block;vertical-align: sub;color:grey;margin-top: 17px;margin-left: 20px">～</span>
                    </i-col>
                    <i-col span="10">
                        <i-input v-model="rawData.planRest4[1]" placeholder="終了時間" maxlength="5" icon="ios-clock-outline"
                                 @on-blur="handleInputChange(rawData.planRest4,1,$event.target)"></i-input>
                    </i-col>
                </Row>
            </form-item>

            <form-item label="日付切替時刻" prop="changeTime">
                <i-col span="24">
                    <i-input v-model="rawData.tpa_ndate_change_time" placeholder="終了時間" maxlength="5" icon="ios-clock-outline"
                             @on-blur="handleInputChange(rawData,'tpa_ndate_change_time',$event.target)"></i-input>
                </i-col>
            </form-item>

            <form-item label="翌日勤務パターン" prop="ykjtPattern">
                <i-select v-model="ykjtPatternModel" placeholder="選択ください" filterable transfer @on-change="handleChangePattern($event)">
                    <i-option label="なし" value=""></i-option>
                    <i-option v-for="(item, index) of ykjtPatternList" :key="index" :label="item.tpa_cpatternname" :value="item.tpa_cpatternid"></i-option>
                </i-select>
            </form-item>
            <form-item label="デフォルト設定値">
                <checkbox v-model="isDefault" class="input-like-span" style="margin: 0;" @on-change="defaultSelect"></checkbox>
            </form-item>
        </i-form>
        <div>
            <div style="text-align: right">
                <i-button class="ivu-btn ivu-btn-text" type="text" @click="cancel">キャンセル</i-button>
                <i-button class="ivu-btn" type="success" disabled v-if="btn_sk_commit_show===false">{{titlesMessage}}</i-button>
                <i-button class="ivu-btn" type="success" @click="handleSubmit('localValue')" 　v-else>{{titlesMessage}}</i-button>
            </div>
        </div>
        <Spin size="large" fix v-if="mergePatternLoading"></Spin>
    </Modal>
    <!-- 勤務パターン追加END -->
    <!-- CSVファイル取込STARD -->
    <Modal v-model="csvuploadModal" class="tc" title="CSVファイル取込" :mask-closable="false">
        <Upload :before-upload="handleBeforeUpload" action="/" class="ivu-upload ivu-upload-select width100" type="drag">
            <div style="padding: 20px 0">
                <Icon type="ios-cloud-upload" size="52" style="color: var(--theme-mark)"></Icon>
                <p style="color:var(--grey)">クリックしてファイルを選択するか、</p>
                <p style="color:var(--grey)">ここにファイルをドラッグ＆ドロップして下さい。</p>
            </div>
        </Upload>
        <div class="tl mt10" v-if="file !== null">
            ファイル: <span class="blue">{{ file.name }}</span>
        </div>
        <div slot="footer">
            <i-button type="text" @click="uploadCancel">キャンセル</i-button>
            <i-button icon="md-arrow-round-up" type="primary" @click="upload" :loading="loadingStatus" v-if="file != null">アップロード</i-button>
            <i-button icon="md-arrow-round-up" disabled v-if="file === null">アップロード</i-button>
        </div>
    </Modal>
    <!-- CSVファイル取込END -->
</main>

<div th:replace="layout/head::header"></div>
<script type="text/babel" th:inline="javascript">
    const PERM_STATLIST = new Vue({
        el: '.patternSetting-warp',
        data() {
            return {
                mergePatternLoading: false,
                csvuploadModal: false,
                file: null,
                loadingStatus: false,
                errorFlag: false,
                errorMsg: '',
                titlesMessage: '',
                selectedDeptViewType: 3, //組織ツリー用
                hasPassedTimeCheck: true,
                isAdd: Boolean,
                localValue: {
                    name: '',
                    group: '1',
                    date: '2019年11月01日(金)'
                },
                curDate: new Date(),
                contentScrollTop: 0,
                btn_sk_show: false,
                btn_sk_commit_show: true,
                //勤務パターン情報
                rawData: {
                    tpa_csectionid: '',
                    tpa_cgroupid: '',
                    tpa_cpatternid: '',
                    tpa_cpatternname: '',
                    dutyTime: [],
                    planRest1: [],
                    planRest2: [],
                    planRest3: [],
                    planRest4: [],
                    tpa_ndate_change_time: '',
                    tpa_cnextptn: '',
                    flag: ''
                },
                rawData_bak: {
                    tpa_csectionid: '',
                    tpa_cgroupid: '',
                    tpa_cpatternid: '',
                    tpa_cpatternname: '',
                    dutyTime: [],
                    planRest1: [],
                    planRest2: [],
                    planRest3: [],
                    planRest4: [],
                    tpa_ndate_change_time: '',
                    tpa_cnextptn: '',
                    flag: ''
                },
                //照会検索
                query_sk: {
                    groupId: '',
                    sectionId: '',
                    baseDate: '',
                    txtTmgReferListTreeViewRecordDate: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),  //TMG_ADMIN
                    psApp: Utils.getUrlParam(location.href, 'psApp')   //PatternSetting
                },
                query_sk_bak: {},
                edit_flag: false,
                contentMsg: '',
                pageTitle: '勤務パターン新規',
                pageTitleMsg: '勤務パターンを新規登録しました',
                //翌日勤務パターン
                ykjtPatternList: [],
                ykjtPatternModel: '',
                isDefault: false,
                isShow: false,
                loading: false,
                tableLoading: false,
                empTableLoading: false,
                referListObject: {
                    [[${ TREEVIEW_KEY_ADMIN_TARGET_SECTION }]]: '',
                    [[${ TREEVIEW_KEY_ADMIN_TARGET_EMP }]]: '',
                    [[${ TREEVIEW_KEY_RECORD_DATE }]]: '',
                    [[${ TREEVIEW_KEY_REFRESH_FLG }]]: '',
                    txtTmgReferListTreeViewRecordDate: '',
                    hidSelectTab: '0',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    type: 21
                },
                empTreeData: [],
                deptName: '選んでください',
                // sectionId:'',
                // groupId:'',
                query: {
                    txtAction: 'ACTION_DISP_DISP',
                    txtDYYYYMM: '',
                    txtDYYYYMMDD: '',
                    txtCallBeanAction: 'ACTION_DISP_DISP',
                    txtTmgReferListTreeViewRecordDate: '',
                    txtTmgReferListTreeViewAdminTargetSection: '',
                    recordDate: '',
                    txtCEMPLOYEEID: '',
                    groupId: 'null',
                    sectionId: '',
                    txtExecuteEmpId: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    type: 21
                },
                query_ykjtPattern: {
                    txtAction: 'ACTION_DISP_DISP',
                    txtDYYYYMM: '',
                    txtDYYYYMMDD: '',
                    txtCallBeanAction: 'ACTION_DISP_DISP',
                    txtTmgReferListTreeViewRecordDate: '',
                    txtTmgReferListTreeViewAdminTargetSection: '',
                    txtCEMPLOYEEID: '',
                    groupId: 'null',
                    sectionId: '',
                    txtExecuteEmpId: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    type: 21
                },
                //勤務パターン削除
                query_delete: {
                    groupId: '',
                    sectionId: '',
                    patternId: ''
                },
                //取り込み
                query_upload: {
                    txtDYYYYMM: '',
                    txtDYYYYMMDD: '',
                    txtBaseDate: '',
                    txtEndDate: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    txtTmgReferListTreeViewRecordDate: '',
                    txtTmgReferListTreeViewAdminTargetSection: '',
                    file: null
                },
                empDeptLoading: false,
                deptDrawShow: false,
                empDrawShow: false,
                treeData: [],
                selectDisabled: false,   　//年月選択可否制御
                tmgPatternList: [],       //年月リスト
                model1: '',

                title: '',
                empIds: [],
                empIds2: [],

                bulkApprovalLoading: false,
                isSearchHistory: false,
                periodDate: '',
                editPatternShow: false,
                deletePatternShow: false,
                isPatternCodeDisable: false,
                addPatternShow: false,
                columns: [
                    {
                        title: '勤務パターン',
                        minWidth: 100,
                        key: 'tpa_cpatternname',
                        align: 'left'
                    },
                    {
                        title: 'オーナー',
                        minWidth: 80,
                        key: 'tpa_csectionname',
                        align: 'center'
                    },
                    {
                        title: '勤務時間',
                        minWidth: 100,
                        maxWidth: 120,
                        slot: 'dutyTime',
                        align: 'center'
                    },
                    {
                        title: '休憩時間',
                        minWidth: 180,
                        slot: 'restTime',
                        align: 'left'
                    },
                    {
                        title: '日付切替時刻',
                        minWidth: 50,
                        maxWidth: 130,
                        key: 'tpa_ndate_change_time',
                        align: 'center'
                    },
                    {
                        title: '翌日勤務パターン',
                        minWidth: 140,
                        maxWidth: 200,
                        key: 'cnextptname',
                        align: 'left'
                    },
                    {
                        title: '操作',
                        slot: 'action',
                        width: 150,
                        align: 'center'
                    }
                ],
                //照会タイトル
                sk_column: [
                    {
                        title: '氏名',
                        key: 'empname',
                        minWidth: 100,
                        align: 'left'
                    },
                    {
                        title: '勤務パターン',
                        minWidth: 200,
                        key: 'tpa_cpatternname',
                        align: 'left'
                    }
                ],
                //照会リスト
                sk_list: [],
                sk_list_bak: [],
                targetPermSection: '',
                targetPermSectionFlag: false
            }
        },
        async mounted() {
            if (!this.periodDate) {
                await this.getPeriodDate()
            }
            await this.getInit()
            this.selectTmgPatternApplies()
        },
        methods: {
            // 勤務パターンリスト
            async getTmgPatternList() {
                this.query.txtAction = 'ACTION_DISP_DISP'
                this.tableLoading = true
                const {data} = await this.http.get('sys/patternSetting/selectTmgPattern', this.query)
                this.tmgPatternList = data

                if (data.length > 0) {
                    this.model1 = data[0].val
                }

                //年月リスト.lengthがゼロ場合、非活性化にする
                if (data.length === 0) {
                    this.model1 = ''
                    this.selectDisabled = false
                }
                this.tableLoading = false
                this.addPatternShow = true
            },
            async handleDeptViewTypeChange() {
                await this.getOrgTree()
                if (this.selectedDeptViewType === 3) {
                    this.query.txtTmgReferListTreeViewPermSelectedView = 'section'
                }
                if (this.selectedDeptViewType === 2) {
                    this.query.txtTmgReferListTreeViewPermSelectedView = 'group'
                }
                //console.log("handleDeptViewTypeChange")
                //console.log(this.query.txtTmgReferListTreeViewPermSelectedView)
                this.$Notice.success({title: '所属図更新完了'})
            },
            async getOrgTree(refreshDept) {
                this.empDeptLoading = true
                try {
                    const {groupList, sectionList, recordDate} = await this.http.get('sys/tree', this.referListObject)
                    // 先将数据转为标准格式，再转为可用数据
                    if (this.selectedDeptViewType === 3) {
                        this.treeData = Utils.convertTreeData(sectionList)
                    }
                    if (this.selectedDeptViewType === 2) {
                        this.treeData = Utils.convertTreeData(groupList)
                    }
                    this.referListObject.txtTmgReferListTreeViewRecordDate = recordDate
                } catch (error) {
                    return
                } finally {
                    this.empDeptLoading = false
                }
            },
            async handleDeptDateChange(e) {
                this.referListObject.txtTmgReferListTreeViewRecordDate = e
                this.curDate = e
                this.isSearchHistory = true
                await this.getOrgTree()
                if (this.treeData.length !== 0) {
                    this.$Notice.warning({title: '所属図更新完了', desc: "下記の所属リストから対象を選んでください"})
                }
            },

            // 改訂日を変更すると　所属リストを更新する
            async handleDatePicker() {
                //console.log(this.curDate)
                this.referListObject.txtTmgReferListTreeViewRecordDate = Utils.formatDate(this.curDate, 'YYYY/MM/DD')

                this.isSearchHistory = true
                await this.getOrgTree()
            },
            //翌日勤務パターン
            handleChangePattern(e) {
                if (e) {
                    this.rawData.tpa_cnextptn = e
                } else {
                    //日付切替時刻の値をリセットする
                    this.rawData.tpa_ndate_change_time = ''
                    this.rawData.tpa_cnextptn = ''
                }
            },
            //所属変更する
            async handleClickLeaf(e) {
                //同一部署を二回目でクリックすると、取消とするためで、エラーあり
                //よって、二回目クリックすると、何もしない
                if (!e[0]) return

                if (this.selectedDeptViewType === 3) {
                    this.deptName = e[0].label
                }
                if (this.selectedDeptViewType === 2) {
                    this.deptName = e[0].secnic
                }

                this.deptDrawShow = false
                this.query.txtAction = 'ACTION_DISP_DISP'
                this.query.txtTmgReferListTreeViewPermTargetSection = e[0].secid
                this.query.txtTmgReferListTreeViewPermTargetGroup = e[0].groupid
                this.query.sectionId = e[0].secid
                this.query_ykjtPattern.sectionId = e[0].secid
                this.query.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate

                //編集画面のグループと部署を設定する
                this.rawData.tpa_csectionid = e[0].secid
                this.rawData.tpa_cgroupid = e[0].groupId
                this.query_upload.sectionId = e[0].secid
                this.query_upload.groupId = e[0].groupId
                this.query_sk.sectionId = e[0].secid
                this.query_sk.groupId = e[0].groupId

                //適用時間を取得する
                if (!this.periodDate) {
                    await this.getPeriodDate()
                }
                //リストの取得
                await this.getTmgPatternList()

                //部署職員リスト
                await this.selectTmgPatternApplies()

                //新規ボタンを有効にする
                this.addPatternShow = true
                this.btn_sk_show = true
            },

            // 新規と編集画面を開く
            async mergePattern(row) {
                this.isShow = true
                this.mergePatternLoading = true
                this.btn_sk_commit_show = true
                this.hiddenAlert()
                await this.getYkjtTmgPatternList()
                if (row != undefined && null != row) {
                    // 編集
                    this.pageTitle = '勤務パターン編集'
                    this.titlesMessage = '変更'
                    this.contentMsg = 'この編集内容で更新します。よろしいですか？'
                    this.pageTitleMsg = '勤務パターンを更新しました'
                    this.isPatternCodeDisable = true
                    this.rawData = {...row}
                    this.edit_flag = true
                    this.rawData.tpa_cpatternname = row.tpa_cpatternname
                    this.rawData.tpa_cpatternid = row.tpa_cpatternid

                    //時間フォーマットを変える
                    const handleTime = Vue.filter('handleTime');
                    const duty_start = handleTime(row.planDuty[0].NOPEN)
                    const duty_end = handleTime(row.planDuty[0].NCLOSE)
                    this.rawData.dutyTime = [duty_start, duty_end]

                    if (row.planRest[0] !== undefined) {
                        const rest_start = handleTime(row.planRest[0].NOPEN)
                        const rest_end = handleTime(row.planRest[0].NCLOSE)
                        //this.rawData.planRest1 = [rest_start, rest_end]
                        this.$set(this.rawData, 'planRest1', [rest_start, rest_end])
                    } else {
                        this.$set(this.rawData, 'planRest1', ['', ''])
                    }
                    if (row.planRest[1] !== undefined) {
                        const rest_start = handleTime(row.planRest[1].NOPEN)
                        const rest_end = handleTime(row.planRest[1].NCLOSE)
                        //this.rawData.planRest2 = [rest_start, rest_end]
                        this.$set(this.rawData, 'planRest2', [rest_start, rest_end])
                    } else {
                        this.$set(this.rawData, 'planRest2', ['', ''])
                    }
                    if (row.planRest[2] !== undefined) {
                        const rest_start = handleTime(row.planRest[2].NOPEN)
                        const rest_end = handleTime(row.planRest[2].NCLOSE)
                        //this.rawData.planRest3 = [rest_start, rest_end]
                        this.$set(this.rawData, 'planRest3', [rest_start, rest_end])
                    } else {
                        this.$set(this.rawData, 'planRest3', ['', ''])
                    }
                    if (row.planRest[3] !== undefined) {
                        const rest_start = handleTime(row.planRest[3].NOPEN)
                        const rest_end = handleTime(row.planRest[3].NCLOSE)
                        //this.rawData.planRest4 = [rest_start, rest_end]
                        this.$set(this.rawData, 'planRest4', [rest_start, rest_end])
                    } else {
                        this.$set(this.rawData, 'planRest4', ['', ''])
                    }

                    this.rawData.tpa_ndate_change_time = row.tpa_ndate_change_time
                    this.rawData.tpa_cnextptn = row.tpa_cnextptn

                    //ディフォルト
                    if (row.tpa_cdefaultflg === "TMG_ONOFF|1") {
                        this.isDefault = true
                        this.rawData.flag = row.tpa_cdefaultflg
                    } else {
                        this.isDefault = false
                        this.rawData.flag = row.tpa_cdefaultflg
                    }


                    //初期化データ
                    if (row.tpa_cnextptn == '' || row.tpa_cnextptn == undefined || row.tpa_cnextptn == null) {
                        this.ykjtPatternModel = ''
                    } else {
                        this.ykjtPatternModel = row.tpa_cnextptn
                    }
                    this.rawData_bak = Utils.deepClone(this.rawData)

                } else {
                    //新規
                    this.pageTitle = '勤務パターン新規'
                    this.titlesMessage = '登録'
                    this.contentMsg = 'この編集内容で登録します。よろしいですか？'
                    this.pageTitleMsg = '勤務パターンを新規登録しました'
                    this.ykjtPatternModel = ''
                    this.edit_flag = false
                    this.rawData.flag = 'TMG_ONOFF|0'
                    this.isDefault = false
                    this.isPatternCodeDisable = false
                }

                this.mergePatternLoading = false
            },

            //編集画面を閉じる
            cancel() {
                // this.rawData.tpa_csectionid = ''
                // this.rawData.tpa_cgroupid = ''
                this.rawData.tpa_cpatternid = ''
                this.rawData.tpa_cpatternname = ''
                this.rawData.dutyTime = []
                this.rawData.planRest1 = []
                this.rawData.planRest2 = []
                this.rawData.planRest3 = []
                this.rawData.planRest4 = []
                this.rawData.tpa_ndate_change_time = ''
                this.rawData.tpa_cnextptn = ''
                this.rawData.flag = ''
                this.$refs.localValue.resetFields()
                this.isShow = false
                this.edit_flag = false
                this.isDefault = false
            },
            //
            handleReset(name) {
                this.$refs[name].resetFields();
            },
            //部署またはグループをチェックする
            valid_secAndGroup(sectionId, groupId) {
                this.hiddenAlert()
                if (!groupId) {
                    if (!sectionId) {
                        this.showAlert('部署とグループが空です')
                        return false
                    }
                }
                return true
            },
            //undefined チェックする
            valid_ifnull(title, msg) {
                this.hiddenAlert()
                if (!msg) {
                    this.showAlert(title + 'を入力してください')
                    return false
                }
                return true
            },
            //特別文字をチェックする
            valid_word(title, msg) {
                var regEn = /[`~!@#$%^&*+>?:"{},.\/;'[\]]/im
                var regCn = /[·！#￥（——）：；“”‘、，|《。》？、【】[\]]/im
                if (regEn.test(msg) || regCn.test(msg)) {
                    this.showAlert(title + '中に特殊文字（`~!@#$%^&*+>?:"{},.\\/;\'[\\]）が含めています、入力し直してください')
                    return false;
                }
                return true
            },
            //文字の長さをチェックする
            valid_length(title, msg) {
                this.hiddenAlert()
                if (msg.length < 5) {
                    this.showAlert(title + 'は半角英数記号文字を5文字以上に入力してください')
                    return false
                }
                if (msg.length > 50) {
                    this.showAlert(title + 'は半角英数記号文字を50文字以下に入力してください')
                    return false
                }
                return true
            },
            //時間長さ(分)
            valid_timeMins(msg1, msg2) {
                //msg1  開始時間
                //msg2 　終了時間
                var reg = /-/g
                var dateBegin = '2020-01-01 ' + msg1 + ':00'
                var dateEnd = '2020-01-01 ' + msg2 + ':00'
                dateBegin = new Date(dateBegin.replace(reg, "/"))
                dateEnd = new Date(dateEnd.replace(reg, "/"))
                var dateDiff = dateEnd.getTime() - dateBegin.getTime();
                var mins = Math.floor(dateDiff / (60 * 1000));
                return mins
            },
            //法律について、一定の労働時間には一定の休憩時間を与えることが必要です
            valid_dutyAndRest(dutyMins, restMins) {
                this.hiddenAlert()
                if (dutyMins >= 6 * 60 && 8 * 60 > dutyMins) {
                    //六時間労働時間の場合、少なくとも45分の休憩時間
                    if (restMins < 45) {
                        this.showAlert('労働時間が6時間以上の場合、少なくとも45分時間数の休憩時間を与えなければならない')
                        return false
                    }
                }
                if (dutyMins >= 8 * 60) {
                    //八時間労働時間の場合、少なくとも60分の休憩時間
                    if (restMins < 60) {
                        this.showAlert('労働時間が8時間以上の場合、少なくとも60分時間数の休憩時間を与えなければならない')
                        return false
                    }
                }
                return true
            },
            //日付切替時刻と翌日勤務パターンをチェック
            valid_nextPtn(changeTime, nextptn) {
                //日付切替時刻があれば、翌日勤務パターンを選択しなければならない
                //console.log("changeTime:", changeTime)
                //console.log("nextptn:", nextptn)
                this.hiddenAlert()
                if (changeTime) {
                    if (!nextptn) {
                        this.showAlert('日付切替時刻がある場合、翌日勤務パターンを選択しなければならない')
                        return false
                    }
                }
                //翌日勤務パターンがあれば.日付切替時刻を入力しなければならない
                if (nextptn) {
                    if (!changeTime) {
                        this.showAlert('翌日勤務パターンがある場合、日付切替時刻を入力しなければならない')
                        return false
                    }
                }
                return true
            },
            //編集パターン情報は存在かをチェックする
            async valid_patternIdIsExists(patternId) {
                this.hiddenAlert()
                if (this.edit_flag) {
                    //編集の場合、このチェックを要らない
                    return true
                }
                const {data} = await this.http.get('sys/patternSetting/selectEditPatternExist', {patternId: patternId})
                if (data) {
                    this.showAlert('勤務パターンコードが存在しています、入力し直してください')
                    return false
                }
                return true
            },

            //休憩時間は勤務時間の範囲内かどうかをチェックする
            valid_time(item, dutyStart, dutyEnd, restStart, restEnd) {
                this.hiddenAlert()
                var dutyStart_date = new Date(Date.parse("2020-01-01 " + dutyStart + ":00"));
                var dutyEnd_date = new Date(Date.parse("2020-01-01 " + dutyEnd + ":00"));
                var restStart_date = new Date(Date.parse("2020-01-01 " + restStart + ":00"));
                var restEnd_date = new Date(Date.parse("2020-01-01 " + restEnd + ":00"));
                if (dutyStart_date > restStart_date) {
                    this.showAlert('[' + item + ']休憩開始時間は勤務開始時間より早いです')
                    return false
                }
                if (restStart_date > dutyEnd_date) {
                    this.showAlert('[' + item + ']休憩開始時間は退勤時間より遅いです')
                    return false
                }
                if (dutyStart_date > restEnd_date) {
                    this.showAlert('[' + item + ']休憩終了時間は勤務開始時間より早いです')
                    return false
                }
                if (restEnd_date > dutyEnd_date) {
                    this.showAlert('[' + item + ']休憩終了時間は退勤時間より遅いです')
                    return false
                }
                return true
            },
            //休憩時間が重複してるか
            valid_rest_time_isRepeat(planRest1, planRest2, planRest3, planRest4) {
                var planRests = [planRest1, planRest2, planRest3, planRest4]
                var flag
                for (var i = 0; i < planRests.length; i++) {
                    if (planRests[i][0] && planRests[i][1]) {
                        for (var j = i + 1; j < planRests.length; j++) {
                            if (planRests[j][0] && planRests[j][1]) {
                                flag = this.fun_rest_time_isRepeat(planRests[j][0], planRests[i][1])
                                if (!flag) {
                                    return false;
                                    break;
                                }
                            } else {
                                continue;
                            }
                        }
                    } else {
                        continue;
                    }
                }
                return true;
            },
            //休憩終了時刻は休憩開始時刻より未来の時刻を入力してください
            valid_rest_time_isTrue(planRest1, planRest2, planRest3, planRest4) {
                var planRests = [planRest1, planRest2, planRest3, planRest4]
                var flag
                for (var i = 0; i < planRests.length; i++) {
                    if (planRests[i][0] && planRests[i][1]) {
                        flag = this.fun_rest_time_isTrue(planRests[i][0], planRests[i][1],i+1)
                        if (!flag) {
                            return false;
                            break;
                        }
                    } else {
                        continue;
                    }
                }
                return true;
            },
            //休憩時間が重複してるか
            fun_rest_time_isRepeat(datatime1, datatime2) {
                var restStart = new Date(Date.parse("2020-01-01 " + datatime1 + ":00"));
                var restEnd = new Date(Date.parse("2020-01-01 " + datatime2 + ":00"));
                if (restStart < restEnd) {
                    //もし二番目の休憩開始時間は一番目の休憩終了時間より早くなったら、休憩時間が重複してます。
                    this.showAlert('休憩時間が重複しています')
                    return false
                }
                return true
            },
            //休憩終了時刻は休憩開始時刻より未来の時刻を入力してください
            fun_rest_time_isTrue(datatime1, datatime2,index) {
                var restStart = new Date(Date.parse("2020-01-01 " + datatime1 + ":00"));
                var restEnd = new Date(Date.parse("2020-01-01 " + datatime2 + ":00"));
                if (restStart > restEnd) {
                    this.showAlert('[休憩時間'+index+']休憩終了時刻は休憩開始時刻より未来の時刻を入力してください')
                    return false
                }
                return true
            },
            //時間フォーマットに変更する
            handleInputChange(object, index, el) {
                if (object) {
                    this.hasPassedTimeCheck = Utils.checkTime(object, index)
                    this.$set(object, index, object[index])
                    /*if (!this.hasPassedTimeCheck) {
                        el.focus()
                        return
                    }*/
                }
                //this.$forceUpdate()
            },
            //勤務パターン更新登録
            async handleSubmit(name) {
                //form validate
                var sectionId = this.rawData.tpa_csectionid
                var groupId = this.rawData.tpa_cgroupid
                var patternId = this.rawData.tpa_cpatternid
                var patternName = this.rawData.tpa_cpatternname
                var dutyDate = this.rawData.dutyTime
                var planRest1 = this.rawData.planRest1
                var planRest2 = this.rawData.planRest2
                var planRest3 = this.rawData.planRest3
                var planRest4 = this.rawData.planRest4
                var changeTime = this.rawData.tpa_ndate_change_time
                var nextptn = this.rawData.tpa_cnextptn

                if (this.edit_flag) {
                    if (JSON.stringify(this.rawData_bak) === JSON.stringify(this.rawData)) {
                        //console.log('after  isDefault', this.isDefault)
                        //console.log('befor  isDefault', this.rawData_bak.flag)
                        //console.log('this.rawData_bak', JSON.stringify(this.rawData_bak))
                        //console.log('this.rawData', JSON.stringify(this.rawData))
                        this.showAlert('まだ編集していません、先ずは編集しましょう')
                        return
                    } else {
                        this.hiddenAlert()
                    }
                    this.rawData_bak.tpa_ndate_change_time = changeTime
                }
                if (!this.valid_secAndGroup(sectionId, groupId)) {
                    return
                }
                /*if (!this.valid_word('コード', patternId)) {
                    return
                }*/
                if (!this.valid_ifnull('コード', patternId)) {
                    return
                }
                if (!this.valid_length('コード', patternId)) {
                    return
                }
                //awaitパラメータが必要です
                const flag = await this.valid_patternIdIsExists(patternId)
                if (!flag) {
                    return
                }
                /*if (!this.valid_word('名称', patternName)) {
                    return
                }*/
                if (!this.valid_ifnull('名称', patternName)) {
                    return
                }
                if (!this.valid_length('名称', patternName)) {
                    return
                }
                if (!this.valid_ifnull('勤務時間', dutyDate[0])) {
                    //isnull  format
                    return
                }
                if (!this.hasPassedTimeCheck) {
                    this.showAlert('勤務時間または休憩時間フォーマットが正しくないので、もう一度確認してください')
                    return
                } else {
                    this.hiddenAlert();
                }
                if (!this.valid_rest_time_isTrue(planRest1, planRest2, planRest3, planRest4)) {
                    return
                }
                if (!this.valid_rest_time_isRepeat(planRest1, planRest2, planRest3, planRest4)) {
                    return
                }

                //休憩時間は勤務時間と　比べる
                if (planRest1) {
                    if (!this.valid_time('休憩時間1', dutyDate[0], dutyDate[1], planRest1[0], planRest1[1])) {
                        return
                    }
                }
                if (planRest2) {
                    if (!this.valid_time('休憩時間2', dutyDate[0], dutyDate[1], planRest2[0], planRest2[1])) {
                        return
                    }
                }
                if (planRest3) {
                    if (!this.valid_time('休憩時間3', dutyDate[0], dutyDate[1], planRest3[0], planRest3[1])) {
                        return
                    }
                }
                if (planRest4) {
                    if (!this.valid_time('休憩時間4', dutyDate[0], dutyDate[1], planRest4[0], planRest4[1])) {
                        return
                    }
                }

                //勤務時間（分）
                var dutyMins = this.valid_timeMins(dutyDate[0], dutyDate[1])
                var restMins1 = 0
                var restMins2 = 0
                var restMins3 = 0
                var restMins4 = 0
                if (planRest1) {
                    if (planRest1.length > 0 && planRest1[0] != '') {
                        restMins1 = this.valid_timeMins(planRest1[0], planRest1[1])
                    } else {
                        restMins1 = 0
                    }

                }
                if (planRest2) {
                    if (planRest2.length > 0 && planRest2[0] != '') {
                        restMins2 = this.valid_timeMins(planRest2[0], planRest2[1])
                    } else {
                        restMins2 = 0
                    }

                }
                if (planRest3) {
                    if (planRest3.length > 0 && planRest3[0] != '') {
                        restMins3 = this.valid_timeMins(planRest3[0], planRest3[1])
                    } else {
                        restMins3 = 0
                    }
                }
                if (planRest4) {
                    if (planRest4.length > 0 && planRest4[0] != '') {
                        restMins4 = this.valid_timeMins(planRest4[0], planRest4[1])
                    } else {
                        restMins4 = 0
                    }
                }
                this.$Modal.confirm({
                    title: '注意',
                    content: this.contentMsg,
                    okText: 'OK',
                    width: 480,
                    cancelText: 'キャンセル',
                    onOk: async () => {
                        //休憩時間（総計）
                        var totalRestMins = restMins1 + restMins2 + restMins3 + restMins4
                        //法律について、一定の労働時間には一定の休憩時間を与えることが必要です
                        //１.六時間労働時間の場合、少なくとも45分の休憩時間
                        //２.八時間労働時間の場合、少なくとも60分の休憩時間
                        if (!this.valid_dutyAndRest(dutyMins, totalRestMins)) {
                            return
                        }
                        //日付切替時刻があれば、翌日勤務パターンを選択しなければならない
                        //翌日勤務パターンがあれば.日付切替時刻を入力しなければならない
                        //if (!this.valid_nextPtn(changeTime, nextptn)) {
                        //   return
                        //}
                        this.btn_sk_commit_show = false
                        if (this.isDefault === true) {
                            this.rawData.flag = "TMG_ONOFF|1"
                        } else {
                            this.rawData.flag = "TMG_ONOFF|0"
                        }
                        //パターンを更新
                        await this.http.post('sys/patternSetting/modifiEditAndNew', this.rawData)
                        //新規又は編集画面を閉じる
                        this.cancel()
                        //リストの取得
                        await this.getTmgPatternList()
                        this.$Notice.info({title: this.pageTitleMsg, desc: ""})
                    },
                    onCancel: () => {
                    }
                })
            },
            //勤務パターンを削除する
            async deletePattern(row) {
                if (row != undefined && null != row) {
                    this.query_delete.patternId = row.tpa_cpatternid
                    this.query_delete.sectionId = row.tpa_csectionid
                    this.query_delete.groupId = row.tpa_cgroupid
                    this.$Modal.confirm({
                        title: '注意',
                        width: 480,
                        content: 'この勤務パターンを削除します。よろしいですか？',
                        okText: '削除',
                        cancelText: '戻る',
                        onOk: async () => {
                            await this.http.postForm('sys/patternSetting/deletePattern', this.query_delete)
                            //リストの取得
                            await this.getTmgPatternList()
                            this.$Notice.info({title: '「' + row.tpa_cpatternname + '」を削除しました。', desc: ""})
                        },
                        onCancel: () => {

                        }
                    })
                } else {
                    this.$Notice.warning({title: '先ずは、目標パターンを選択してください', desc: ""})
                }
            },
            //翌日勤務パターンリスト
            async getYkjtTmgPatternList() {
                const {data} = await this.http.get('sys/patternSetting/selectTmgPattern', this.query_ykjtPattern)
                this.ykjtPatternList = data
                this.ykjtPatternModel = 'ykjtPatternModel'
            },
            //　ファイルタイプをチェック
            handleFormatError(file) {
                if (file != null && file != undefined) {
                    if (file.type != 'application/vnd.ms-excel') {
                        this.$Notice.warning({title: 'アイルタイプをチェック', desc: "サポートされているファイルタイプはCSVです"})
                        return false
                    }
                    return true
                }

            },
            //ファイルサイズをチェックする
            handleMaxSize(file) {
                if (file != null && file != undefined) {
                    if (file.size > 1024000) {
                        this.$Notice.warning({title: 'アイルタイプをチェック', desc: "ファイルサイズの最大値は1Mです"})
                        return false
                    }
                    return true
                }
            },
            // 勤務パターンファイルを手動に操作
            handleBeforeUpload(file) {
                if (this.handleFormatError(file) && this.handleMaxSize(file)) {
                    this.query_upload.file = file
                    this.file = file
                }
                return false
            },
            //アップロード
            async upload() {
                this.$Modal.confirm({
                    title: '注意',
                    content: 'このCSVファイルをアップロードします。\nよろしいですか？',
                    okText: 'OK',
                    width: 480,
                    cancelText: 'キャンセル',
                    onOk: async () => {
                        this.loadingStatus = true;
                        const {data} = await this.http.uploadFiles('sys/patternSetting/modifiCSVDwnload', this.query_upload)
                        this.csvuploadModal = false
                        // アップロード結果を統計する
                        var total = data.insertFlg.length
                        var success_count = 0
                        var fail_count = 0
                        for (var i = 0; i < data.insertFlg.length; i++) {
                            if (data.insertFlg[i] == true) {
                                success_count++
                            } else {
                                fail_count++
                            }
                        }
                        //詳細情報
                        var info = ""
                        for (var i = 0; i < data.lmsgList.length; i++) {
                            info += data.lmsgList[i] + "\n"
                        }
                        var msg = "トータル件数：" + total + "　　　 \n「成功件数：" + success_count + "     エラー件数：" + fail_count + "」\n" + "詳細情報:" + "\n" + info
                        if (fail_count > 0) {
                            //情報提示
                            this.$Notice.warning({title: 'アップロード結果', desc: msg, duration: 0})
                        } else {
                            this.$Notice.info({title: 'アップロード結果', desc: msg, duration: 0})
                        }
                        //リストの取得
                        this.getTmgPatternList()
                        this.loadingStatus = false;

                        //リセットアップロード対象
                        this.query_upload.file = null
                        this.file = null
                    },
                    onCancel: () => {
                    }
                })
            },
            //アップロードをキャンセル
            uploadCancel() {
                //リセットアップロード対象
                this.query_upload.file = null
                this.file = null
                this.csvuploadModal = false

            },
            //データ検証アラームを表示する
            showAlert(msg) {
                this.errorFlag = true
                this.errorMsg = msg
            },
            //データ検証アラームを非表示する
            hiddenAlert() {
                this.errorFlag = false
                this.errorMsg = ''
            },
            //適用時間を取得する
            async getPeriodDate() {
                const {data} = await this.http.get('sys/patternSetting/selectEditPeriodDate', null)
                this.periodDate = data.periodDate
            },
            //該当者毎に設定されている勤務パターンの情報を取得する（部署職員リスト）
            async selectTmgPatternApplies() {
                this.empDrawShow = true
                this.empTableLoading = true

                if (!this.curDate) {
                    this.query_sk.baseDate = Utils.formatDate(new Date(), "YYYY/MM/DD")
                } else {
                    this.query_sk.baseDate = Utils.formatDate(this.curDate, "YYYY/MM/DD")
                }
                if (this.query_sk_bak !== this.query_sk) {
                    //パラメータが変更しない場合、リクエストしない
                    const {data} = await this.http.postForm('sys/patternSetting/selectTmgPatternApplies', this.query_sk)
                    this.sk_list = data
                    this.query_sk_bak = Utils.deepClone(this.query_sk)
                }
                this.empTableLoading = false
                this.isSearchHistory = false
            },
            //ディフォルト勤務パターン
            defaultSelect(e) {
                // console.log(e)
                if (e === true) {
                    //checked
                    this.rawData.flag = 'TMG_ONOFF|1'
                } else {
                    this.rawData.flag = 'TMG_ONOFF|0'
                }
            },
            //初期化処理
            async getInit() {
                this.targetPermSection = ''
                this.targetPermSection = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]

                this.targetPermSection = ''
                if ([[${ session.txtTmgReferListTreeViewPermSelectedView }]] === "group") {
                    this.targetPermSection = [[${ session.txtTmgReferListTreeViewPermTargetGroup }]]
                } else if ([[${ session.txtTmgReferListTreeViewPermSelectedView }]] === "all") {
                    this.targetPermSection = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                } else if ([[${ session.txtTmgReferListTreeViewPermSelectedView }]] === "section") {
                    this.targetPermSection = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                }
                this.referListObject.txtTmgReferListTreeViewRecordDate = Utils.formatDate([[${ session.TmgReferListSYSDATE }]], 'yyyy/mm/dd')
                await this.getOrgTree()

                //　初回管理サイトの画面にアクセスするなら、targetSectionがnullであることから、下記通りでデフォルト所属を設定する
                // １．ログインユーザが本人所属部署の承認権限がある場合、ログインユーザの所属部署をデフォルト所属とする。
                // ２．ログインユーザが本人所属部署の管理権限がない場合、ログインユーザの管理対象部署のTOP部署をデフォルト所属とする
                if (this.targetPermSection != null || this.targetPermSection != '') {
                    this.getDeptCode(this.treeData)
                    if (this.targetPermSectionFlag) {
                        this.getDeptName(this.treeData)
                        this.query.txtTmgReferListTreeViewPermTargetSection = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                        this.query.txtTmgReferListTreeViewPermTargetGroup = [[${ session.txtTmgReferListTreeViewPermTargetGroup }]]
                        this.query.txtTmgReferListTreeViewPermSelectedView = [[${ session.txtTmgReferListTreeViewPermSelectedView }]]
                        this.query.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                        this.query.recordDate = this.referListObject.txtTmgReferListTreeViewRecordDate

                        this.curDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                        this.rawData.tpa_csectionid = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                        this.rawData.tpa_cgroupid = [[${ session.txtTmgReferListTreeViewPermTargetGroup }]]
                        this.query_upload.sectionId = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                        this.query_upload.groupId = [[${ session.txtTmgReferListTreeViewPermTargetGroup }]]
                        this.query_upload.txtTmgReferListTreeViewAdminTargetSection = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                        this.query_upload.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                        this.query_sk.sectionId = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                        this.query_sk.groupId = [[${ session.txtTmgReferListTreeViewPermTargetGroup }]]
                        this.query_ykjtPattern.sectionId = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                    } else {
                        //console.log('sectionid',this.treeData[0].secid)
                        //console.log('groupid',this.treeData[0].groupid)

                        this.deptName = this.treeData[0].label
                        this.query.txtTmgReferListTreeViewAdminTargetSection = this.treeData[0].secid
                        this.query.txtTmgReferListTreeViewPermTargetGroup = this.treeData[0].groupid
                        this.query.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                        this.query.txtTmgReferListTreeViewPermSelectedView = [[${ session.txtTmgReferListTreeViewPermSelectedView }]]
                        this.query.recordDate = this.referListObject.txtTmgReferListTreeViewRecordDate

                        this.curDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                        this.rawData.tpa_csectionid = this.treeData[0].secid
                        this.rawData.tpa_cgroupid = this.treeData[0].groupid
                        this.query_upload.sectionId = this.treeData[0].secid
                        this.query_upload.groupId = this.treeData[0].groupid
                        this.query_upload.txtTmgReferListTreeViewAdminTargetSection = this.treeData[0].secid
                        this.query_upload.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                        this.query_sk.sectionId = this.treeData[0].secid
                        this.query_sk.groupId = this.treeData[0].groupid
                        this.query_ykjtPattern.sectionId = this.treeData[0].secid

                    }
                }

                //一覧画面取得
                this.getTmgPatternList()
                //照会制御
                this.btn_sk_show = true
            },
            getDeptCode(data) {
                data.forEach(e => {
                    if (e.secid === this.targetPermSection) {
                        this.targetPermSectionFlag = true
                    } else {
                        const children = e.child || e.children
                        if (children) {
                            this.getDeptCode(children)
                        }
                    }
                })
            },
            getDeptName(data) {
                // idによりループ処理でdeptNameを取得する
                data.forEach(e => {
                    if (e.secid === this.targetPermSection) {
                        this.deptName = e.label
                    } else {
                        const children = e.child || e.children
                        if (children) {
                            this.getDeptName(children)
                        }
                    }
                })
            },
            handleRestTime(list) {
                if (!list) return
                const handleTime = Vue.filter('handleTime')
                let _e = list.filter(e => e.NOPEN && e.NCLOSE)
                if (_e.length === 1) return `${handleTime(_e[0].NOPEN)}～${handleTime(_e[0].NCLOSE)}`
                let result = ''
                _e.forEach((e, i) => {
                    if (i % 2 !== 0) {
                        result = result.concat(`${handleTime(e.NOPEN)}～${handleTime(e.NCLOSE)}\n`)
                    } else {
                        result = result.concat(`${handleTime(e.NOPEN)}～${handleTime(e.NCLOSE)}/`)
                    }
                })
                return result
            }
        }
    })
</script>
</body>

</html>