<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">


<head
        th:replace="layout/header::common_header(title='在宅勤務登録',cssPaths='/pages/content.min.css')">
</head>

<body>
<div th:replace="layout/loadingBar::loadingBar"></div>
<!-- 菜单导航栏 -->
<div th:replace="layout/sider"></div>
<main class="content oconfirm-warp" ref="layout">
    <div class="content_head">
        <div class="header">
            <div class="title1">
                <h1>
                    <Icon type="i-emeer colored"></Icon>
                    在宅勤務登録
                </h1>
            </div>
        </div>
        <div class="searchwrap">
            <span class="label">年月</span>
            <i-select v-model="defaultDate" class="mr30" @on-change="handleStartMonth($event)"
                      placeholder="選択ください">
                <i-option v-for="(item, index) of dispMonthlyList" :key="index" :label="item.tda_dyyyymm" :value="item.tda_dyyyymm"></i-option>
            </i-select>
            <!-- 共通組織図画面 start-->
            <span style="display:flex;width: calc(15% + 200px);">
              <span class="label">所属</span>
              <i-button v-on:click.native="deptDrawShow = true" class="input-like-span dept-select">
                <Tooltip trigger="hover" :theme="toolTipTheme()" transfer>{{deptName}}
                    <div slot="content">{{deptName}}</div>
                </Tooltip>
             </i-button>
              <Drawer class="tc" placement="right" width="700" :closable="false"
                      :mask-closable="!isSearchHistory" v-model="deptDrawShow">
                <Tabs v-model="currentTab" :animated="false">
                     <tab-pane label="ツリー" name="organisationTree">
                        <div class="titlenorm mb5">
                              <Icon type="logo-buffer"></Icon>
                              所属
                        </div>
                        <Row class="tl mb5">
                              <i-col span="4" class="label tc" style="height: 32px;">基準日</i-col>
                              <i-col span="7" class="no-border-radius">
                                <date-picker type="date" :value="referListObject.txtTmgReferListTreeViewRecordDate" :options="startLimit" placeholder="基準日" :clearable="false" transfer
                                             format="yyyy/MM/dd" ref="datePicker" @on-change="handleDeptDateChange"></date-picker>
                              </i-col>
                              <i-col span="4" class="label ml5 tc" style="height: 32px;">ビュー選択</i-col>
                              <div style="display: inline-block;width: 32.5%;" class="no-border-radius">
                                    <i-select v-model="selectedDeptViewType" @on-change="handleDeptViewTypeChange" transfer>
                                      <i-option value="all">全て</i-option>
                                      <i-option value="group">グループごとに</i-option>
                                      <i-option value="section">部署ごとに</i-option>
                                    </i-select>
                              </div>
                        </Row>
                        <div style="position: relative;">
                              <Tree class="tree mt2" :data="treeData" v-on:on-select-change="handleClickLeaf" ref="tree"
                                    :empty-text="selectedDeptViewType === 'all' ? '全て表示中' : '所属データなし'"></Tree>
                              <Spin size="large" fix v-if="empDeptLoading"></Spin>
                        </div>
                      </tab-pane>
                       <tab-pane label="検索" name="organisationSearch">
                                <Row class="tl mb2" :gutter="8">
                                    <i-col span="15">
                                        <i-input v-model="referListObject.hidSearchData" @on-search="handleClickEmpLeaf"
                                                 class="mar mb5 like-select" search enter-button placeholder="検索">
                                            <i-select v-model="referListObject.hidSearchItems" slot="prepend" style="width: 108px"
                                                      placeholder="項目" transfer>
                                                <i-option v-for="(item,i) of searchTypesList" :value="item.value">
                                                    {{ item.name }}</i-option>
                                            </i-select>
                                            <i-select v-model="referListObject.hidSearchCondition"  slot="append"
                                                      style="width: 108px" placeholder="条件" transfer>
                                                <i-option v-for="(item,i) of searchConditionsList" :value="item.value">
                                                    {{ item.name }}</i-option>
                                            </i-select>
                                        </i-input>
                                    </i-col>
                                    <i-col span="8" class="no-border-radius">
                                        <i-button long type="primary" icon="md-search" ghost :loading="empDeptLoading" @click="handleClickEmpLeaf">検索</i-button>
                                    </i-col>
                                </Row>
                                <Alert class="primary-info mt10">※検索結果の上位100件を表示しています。</Alert>
                      </tab-pane>
                </Tabs>
              </Drawer>
            </span>
            <!-- 共通組織図画面 end-->
            <span style="flex:1"></span>
        </div>
    </div>
    <div class="content_body">
        <Alert class="primary-info">※承認済の場合、文字色が「水色」で表示されます。</Alert>
        <i-table  no-data-text="所属から職員を選んでください。" border :columns="columns"
                 　:row-class-name="() => 'select-col'" :disabled-hover="true" :data="HomeWorkVOList" :loading="updateloading" >
            <template slot-scope="{ row , index}" slot="empname" >
                <span class="pl5 pr5 cursor row-label-primary tl no-border-radius width100" @click="hwApplyShowFlg(hwApplyShow,HomeWorkVOList[index].empid,HomeWorkVOList[index].empname)">{{ HomeWorkVOList[index].empname }}</span>
            </template>
            <template v-for="item of slotList" slot-scope="{ row, index }" :slot="item">
                    <span :class="dayRedStatus(row,item)"> {{row[item]}} </span>
            </template>
        </i-table>
        <div class="titlenorm mb10 mt10 ">
            <Icon type="logo-buffer"></Icon>
            月次勤務
        </div>
        <i-table  class="mb10" no-data-text="所属から職員を選んでください。" border :columns="columns3" width="555"
                  　:row-class-name="() => 'select-col'"  :data="HomeWorkMonthVO" :loading="updateloading" >
            <template slot-scope="{ row  }" slot="empname">
                <span >{{row.empname}}</span>
            </template>
            <template slot-scope="{ row  }" slot="commute">
                <span >{{row.commute}}</span>
            </template>
            <template slot-scope="{ row  }" slot="day">
                <span >{{row.day}}</span>
            </template>
            <template slot-scope="{ row  }" slot="am">
                <span >{{row.am}}</span>
            </template>
            <template slot-scope="{ row  }" slot="pm">
                <span >{{row.pm}}</span>
            </template>
            <template slot-scope="{ row  }" slot="time">
                <span >{{row.time}}</span>
            </template>
        </i-table>
    </div>
    <!-- 在宅勤務申请個人 -->
    <Drawer class="tc" title="在宅勤務編集画面-職員単位" placement="right" width="75%" v-model="hwApplyShow" @on-close="handleClose()" >
        <div class="tr">
            <Row >
                <i-col span="2">
                    <div class="label tc" >氏名</div>
                </i-col>
                <i-col span="3">
                    <div class="person-info">{{empName}}</div>
                </i-col>
                <i-col span="19">
                    <i-button type="primary" class="mb10" ghost @click="updateHomeWork()" icon="md-done-all">登録</i-button>

                    <i-button type="error" class="mb10" ghost @click="handleClose()" icon="md-hand">取消</i-button>
                </i-col>
            </Row>
        </div>
        <i-table  no-data-text="" border :columns="columns1"
                  :row-class-name="() => 'select-col'" :disabled-hover="true" :data="HomeWorkVOListEditBack" >

            <template slot-scope="{ row  }" slot="tdaDd">
                <span :class="dayRed(row)" >{{`${row.tdaDd}　${row.tdaDy}`}}</span>
            </template>
            <template slot-scope="{ row  }" slot="hwCworkingid">
                <span :class="dayRed(row)">{{ row.hwCworkingid }}</span>
            </template>

            <template slot-scope="{ row, index }" slot="hwStatus" >
                <span v-if="HomeWorkVOListEditBack[index].hwStatus=='1'">
                    <i-select v-model="HomeWorkVOListEditBack[index].hwStatus" class="mr30" @on-change="editBack(index)" placeholder="" transfer>
                        <i-option :value="StatusList[1].value">{{ StatusList[1].label }}</i-option>
                        <i-option :value="StatusList[2].value">{{ StatusList[2].label }}</i-option>
                        <i-option :value="StatusList[4].value">{{ StatusList[4].label }}</i-option>
                    </i-select>
                </span>
                <span v-else-if="HomeWorkVOListEditBack[index].hwStatus=='2'">
                    <i-select v-model="HomeWorkVOListEditBack[index].hwStatus" class="mr30"  @on-change="editBack(index)"placeholder="" transfer>
                        <i-option  :value="StatusList[0].value">{{ StatusList[0].label }}</i-option>
                        <i-option :value="StatusList[2].value">{{ StatusList[2].label }}</i-option>
                        <i-option :value="StatusList[4].value">{{ StatusList[4].label }}</i-option>
                    </i-select>
                </span>
                <span v-else-if="HomeWorkVOListEditBack[index].hwStatus=='4'">
                    <i-select v-model="HomeWorkVOListEditBack[index].hwStatus" class="mr30"  @on-change="editBack(index)"placeholder="" transfer>
                        <i-option :value="StatusList[2].value">{{ StatusList[2].label }}</i-option>
                        <i-option :value="StatusList[4].value">{{ StatusList[4].label }}</i-option>
                    </i-select>
                </span>
                <span v-else>
                    <i-select v-model="HomeWorkVOListEditBack[index].hwStatus" class="mr30"  @on-change="editBack(index)"placeholder="" transfer>
                        <i-option  :value="StatusList[0].value">{{ StatusList[0].label }}</i-option>
                        <i-option  :value="StatusList[2].value">{{ StatusList[2].label }}</i-option>
                    </i-select>
                </span>
            </template>

            <template slot-scope="{ row, index }" slot="hwHomework" >
                <i-select v-model="HomeWorkVOListEditBack[index].hwHomework" class="mr30"  @on-change="editTime(index)" placeholder="" transfer :disabled=" row.hwStatus == 0 || row.hwStatus == null || row.hwStatus == 4">
                    <i-option  v-for="(item, index) of homeworkList"  :value="item.value" :key="item.value" >{{ item.label }}</i-option>
                </i-select>
            </template>

            <template slot-scope="{ row, index }" slot="hwStart">
                <i-input v-model="HomeWorkVOListEditBack[index].hwStart"  @on-blur="handleInputChange(index, HomeWorkVOListEditBack[index],'hwStart', $event.target)" :disabled=" row.hwStatus == 0 || row.hwStatus == null || row.hwStatus == 4 || row.hwHomework　!= 4"></i-input>
            </template>

            <template slot-scope="{ row, index }" slot="hwEnd">
                <i-input v-model="HomeWorkVOListEditBack[index].hwEnd"  @on-blur="handleInputChange(index, HomeWorkVOListEditBack[index],'hwEnd', $event.target)" :disabled=" row.hwStatus == 0 || row.hwStatus == null || row.hwStatus == 4 || row.hwHomework　!= 4"></i-input>
            </template>

            <template slot-scope="{ row, index }" slot="hwCommute">
                <checkbox v-model="HomeWorkVOListEditBack[index].hwCommute" true-value="1" false-value="0" :disabled=" row.hwStatus == 0 || row.hwStatus == null || row.hwStatus == 4" ></checkbox>
            </template>

            <template slot-scope="{ row , index}" slot="hwApplicationcomment">
                <span class="ml5">{{ row.hwApplicationcomment }}</span>
            </template>

            <template slot-scope="{ row , index}" slot="hwApprovalcomment">
                <i-input v-model=" HomeWorkVOListEditBack[index].hwApprovalcomment " type="textarea" class="tl"
                         :autosize="{ minRows: 2, maxRows: 5 }"
                         :maxlength="100"
                         @on-blur="handleInputChange(index, false)"></i-input>
            </template>

        </i-table>
    </Drawer>
    <!-- 在宅勤務申请list -->
    <Drawer class="tc" title="在宅勤務編集画面-日単位" placement="right" width="75%" v-model="hwApplyListShow" @on-close="handleClose()" >
        <div class="tr">
            <Row >
                <i-col span="2">
                    <div class="label tc">日期</div>
                </i-col>
                <i-col span="3">
                    <div class="person-info tc">{{updateDay}}</div>
                </i-col>
                <i-col span="19">
                    <i-button type="primary" class="mb10" ghost @click="updateHomeWorkList()" icon="md-done-all">登録</i-button>

                    <i-button type="error" class="mb10" ghost @click="handleClose()" icon="md-hand">取消</i-button>
                </i-col>
            </Row>
        </div>
        <i-table  no-data-text="" border :columns="columns2"
                  :row-class-name="() => 'select-col'" :disabled-hover="true" :data="HomeWorkVOAdminList" >

            <template slot-scope="{ row  }" slot="empname">
                <span class="ml5">{{row.empname}}</span>
            </template>
            <template slot-scope="{ row  }" slot="hwcworkingid">
                <span :class="dayRed(row)">{{ row.hwcworkingid }}</span>
            </template>

            <template slot-scope="{ row, index }" slot="hwstatus" >
                <span v-if="row.hwstatus=='1'">
                    <i-select v-model="HomeWorkVOAdminList[index].hwstatus" class="mr30" @on-change="editlistBack(index)" placeholder="" transfer>
                        <i-option :value="StatusList[1].value">{{ StatusList[1].label }}</i-option>
                        <i-option :value="StatusList[2].value">{{ StatusList[2].label }}</i-option>
                        <i-option :value="StatusList[4].value">{{ StatusList[4].label }}</i-option>
                    </i-select>
                </span>
                <span v-else-if="row.hwstatus=='2'">
                    <i-select v-model="HomeWorkVOAdminList[index].hwstatus" class="mr30"  @on-change="editlistBack(index)" placeholder="" transfer>
                        <i-option  :value="StatusList[0].value">{{ StatusList[0].label }}</i-option>
                        <i-option :value="StatusList[2].value">{{ StatusList[2].label }}</i-option>
                        <i-option :value="StatusList[4].value">{{ StatusList[4].label }}</i-option>
                    </i-select>
                </span>
                <span v-else-if="row.hwstatus=='4'">
                    <i-select v-model="HomeWorkVOAdminList[index].hwstatus" class="mr30"  @on-change="editlistBack(index)" placeholder="" transfer>
                        <i-option :value="StatusList[2].value">{{ StatusList[2].label }}</i-option>
                        <i-option :value="StatusList[4].value">{{ StatusList[4].label }}</i-option>
                    </i-select>
                </span>
                <span v-else>
                    <i-select v-model="HomeWorkVOAdminList[index].hwstatus" class="mr30"  @on-change="editlistBack(index)" placeholder="" transfer>
                        <i-option  :value="StatusList[0].value">{{ StatusList[0].label }}</i-option>
                        <i-option :value="StatusList[2].value">{{ StatusList[2].label }}</i-option>
                    </i-select>
                </span>
            </template>

            <template slot-scope="{ row, index }" slot="hwhomework" >
                <i-select v-model="HomeWorkVOAdminList[index].hwhomework" class="mr30" @on-change="editListTime(index)" placeholder="" transfer :disabled=" row.hwstatus == 0 || row.hwstatus == null || row.hwstatus == 4">
                    <i-option  v-for="(item, index) of homeworkList"  :value="item.value" :key="item.value" >{{ item.label }}</i-option>
                </i-select>
            </template>

            <template slot-scope="{ row, index }" slot="hwStart">
                <i-input v-model="HomeWorkVOAdminList[index].hwStart"  @on-blur="handleInputChange(index, row,'hwStart', $event.target)" :disabled=" row.hwstatus == 0 || row.hwstatus == null || row.hwstatus == 4 || row.hwhomework　!= 4"></i-input>
            </template>

            <template slot-scope="{ row, index }" slot="hwEnd">
                <i-input v-model="HomeWorkVOAdminList[index].hwEnd"  @on-blur="handleInputChange(index, row,'hwEnd', $event.target)" :disabled=" row.hwstatus == 0 || row.hwstatus == null || row.hwstatus == 4 || row.hwhomework　!= 4"></i-input>
            </template>

            <template slot-scope="{ row, index }" slot="hwCommute">
                <checkbox v-model="HomeWorkVOAdminList[index].hwCommute" true-value="1" false-value="0" :disabled=" row.hwstatus == 0 || row.hwstatus == null || row.hwstatus == 4" ></checkbox>
            </template>

            <template slot-scope="{ row , index}" slot="hwApplicationcomment">
                <span class="ml5">{{ row.hwApplicationcomment }}</span>
            </template>

            <template slot-scope="{ row , index}" slot="hwApprovalcomment">
                <i-input v-model=" HomeWorkVOAdminList[index].hwApprovalcomment " type="textarea" class="tl"
                         :autosize="{ minRows: 2, maxRows: 5 }"
                         :maxlength="100"
                         @on-blur="handleInputChange(index, false)"></i-input>
            </template>

        </i-table>
    </Drawer>
</main>
<div th:replace="layout/head::header"></div>
<script type="text/babel" th:inline="javascript">
    const WORK_YEAR_SCHEDULE = new Vue({
        el: '.oconfirm-warp',
        data() {
            return {
                hwApplyShow: false,
                hwApplyListShow: false,
                StatusList: [
                    {
                        value: '0',
                        label: '   ',
                    },
                    {
                        value: '1',
                        label: '承認待',
                    },
                    {
                        value: '2',
                        label: '承認済'
                    },
                    {
                        value: '3',
                        label: '取下'
                    },
                    {
                        value: '4',
                        label: '差戻'
                    }
                ],
                homeworkList: [
                    {
                        value: '1',
                        label: '在宅勤務(終日)'
                    },
                    {
                        value: '2',
                        label: '在宅勤務(午前)'
                    },
                    {
                        value: '3',
                        label: '在宅勤務(午後)'
                    },
                    {
                        value: '4',
                        label: '在宅勤務(時間)'
                    }
                ],
                tableHead:[],
                defaultDate: '', //年月选择（Date）
                dispMonthlyList: [],       //年月リスト
                HomeWorkDay:[],
                HomeWorkVOList:[],
                HomeWorkVOAdminList:[],
                HomeWorkVOAdminListBack:[],
                HomeWorkVOListupdate:[],
                HomeWorkVOListEditBack:[],
                HomeWorkMonthVO:[],
                slotList: Utils.getNumArray(1, 31).map(e => `hwhomeworkflg${e}`),
                deptName:'',
                empName:'',
                updateloading: false,
                empDeptLoading: false,
                yyyyMMdd:'',
                updateDay:'',
                hasPassedTimeCheck: false,
                contentScrollTop: 0,
                kanjiName: [[${ session.psSession.loginKanjiName }]],　　 //ログインしたユーザの氏名
                loginEmployee: [[${ session.psSession.loginEmployee }]],  //ログインしたユーザの職員番号
                sectionName: [[${ session.psSession.loginDesignation[0].sectionName }]],　 //ログインしたユーザの所属
                queryList: {
                    txtAction: 'ACT_DISP_MONTHLY',
                    txtDYYYYMM: '',
                    txtDYYYYMMDD: '',
                    txtCallBeanAction: 'ACT_DISP_MONTHLY',
                    txtTmgReferListTreeViewRecordDate: '',
                    txtTmgReferListTreeViewPermTargetSection: '',
                    txtTmgReferListTreeViewPermTargetGroup: '',
                    txtTmgReferListTreeViewPermTargetEmp: '',
                    txtTmgReferListTreeViewPermSelectedView: '',
                    hidSearchItems: [[${ session.SearchItems }]],     //検索種別
                    hidSearchCondition: [[${ session.SearchCondition }]], //検索条件
                    hidSearchData: [[${ session.SearchData }]],      //検索対象
                    hidSelectTab:[[${ session.hidSelectTab }]] === 1 ? '1':'0',     //組織タブー0：ツリ、1:検索
                    txtCEMPLOYEEID: '',
                    // sectionid: '',
                    txtExecuteEmpId: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    baseDate:''
                },
                deptDrawShow: false,
                isSearchHistory: false,
                searchConditionsList: [],//組織ツリー用
                searchTypesList: [],     //組織ツリー用
                currentTab: [[${ session.hidSelectTab }]] === 1 ? "organisationSearch":"organisationTree",         //組織のツリーと検索タブーを切り替え
                selectedDeptViewType: [[${ session.txtTmgReferListTreeViewPermSelectedView }]]  ? [[${ session.txtTmgReferListTreeViewPermSelectedView }]]:"section", //类型选择
                treeData: [],
                referListObject: {
                    [[${ TREEVIEW_KEY_PERM_TARGET_SECTION }]]: '',
                    [[${ TREEVIEW_KEY_PERM_TARGET_EMP }]]: '',
                    [[${ TREEVIEW_KEY_PERM_TARGET_GROUP }]]: '',
                    [[${ TREEVIEW_KEY_RECORD_DATE }]]: '',
                    txtTmgReferListTreeViewPermSelectedView: '',
                    hidSearchData:'',
                    hidSearchItems:'EMPLOYEEID',
                    hidSearchCondition:'BROADMATCH',
                    txtTmgReferListTreeViewRecordDate: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    type: 21
                },
                query: {
                    employeeId: [[${ session.psSession.loginEmployee }]],　 //組織ツリーで選択した職員番号
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href,'psApp'),
                    txtBaseDate:'',
                    txtEndDate:'',
                    baseDate:''
                }
            }
        },
        async mounted() {
            await　this.getInit()
        },
        beforeDestroy() {
            window.removeEventListener('scroll',this.handleScroll,{ passive: true })
        },
        computed: {
            columns() {
                let result = [
                    {
                        title: '氏名',
                        slot: 'empname',
                        minWidth: 100,
                        tooltip: true,
                        align: 'left'
                    }
                ]
                const that = this
                this.tableHead.forEach((e, i) => {
                    result = result.concat({
                        // title: e,
                        className: e.today ? 'gold' : (e.tcaCholflg.indexOf('1') > -1 || e.tcaCholflg.indexOf('2') > -1 || e.tcaCholflg.indexOf('3') > -1 ? 'rest' : ''),
                        minWidth: 25,
                        renderHeader: (h, params) => {
                            return h(
                                'span',
                                {
                                    style: {
                                        cursor: 'pointer',
                                    },
                                    domProps: {
                                        className: 'table-head',
                                        innerHTML: e.name,
                                    },
                                    on: {
                                        click(){
                                            that.handleClickHead(e.day)
                                        },
                                    },
                                }
                            )
                        },
                        slot: `hwhomeworkflg${i + 1}`,
                        align: 'center'
                    })
                })
                return result
            },
            columns1() {
                return [
                    {
                        title: '日',
                        width: 80,
                        slot: 'tdaDd',
                        align: 'center'
                    },
                    {
                        title: '区分',
                        width: 80,
                        slot: 'hwCworkingid',
                        align: 'center'
                    },
                    {
                        title: '状態',
                        width: 100,
                        slot: 'hwStatus',
                        align: 'center'
                    },
                    {
                        title: '在宅勤務',
                        width: 150,
                        slot: 'hwHomework',
                        align: 'center'
                    },
                    {
                        title: '開始',
                        minWidth: 90,
                        slot: 'hwStart',
                        align: 'center'
                    },
                    {
                        title: '終了',
                        minWidth: 90,
                        slot: 'hwEnd',
                        align: 'center'
                    },
                    {
                        title: '通勤対象外',
                        minWidth: 50,
                        slot: 'hwCommute',
                        align: 'center'
                    },
                    {
                        title: '申請コメント',
                        minWidth: 200,
                        slot: 'hwApplicationcomment'
                    },
                    {
                        title: '承認コメント',
                        minWidth: 200,
                        slot: 'hwApprovalcomment',
                        align: 'center'
                    }
                ]
            },
            columns2() {
                return [
                    {
                        title: '氏名',
                        width: 150,
                        slot: 'empname'
                    },
                    {
                        title: '区分',
                        width: 80,
                        slot: 'hwcworkingid',
                        align: 'center'
                    },
                    {
                        title: '状態',
                        width: 100,
                        slot: 'hwstatus',
                        align: 'center'
                    },
                    {
                        title: '在宅勤務',
                        width: 150,
                        slot: 'hwhomework',
                        align: 'center'
                    },
                    {
                        title: '開始',
                        minWidth: 90,
                        slot: 'hwStart',
                        align: 'center'
                    },
                    {
                        title: '終了',
                        minWidth: 90,
                        slot: 'hwEnd',
                        align: 'center'
                    },
                    {
                        title: '通勤対象外',
                        minWidth: 50,
                        slot: 'hwCommute',
                        align: 'center'
                    },
                    {
                        title: '申請コメント',
                        minWidth: 200,
                        slot: 'hwApplicationcomment'
                    },
                    {
                        title: '承認コメント',
                        minWidth: 200,
                        slot: 'hwApprovalcomment',
                        align: 'center'
                    }
                ]
            },
            columns3() {
                return [
                    {
                        title: '氏名',
                        width: 150,
                        slot: 'empname',
                        align: 'center'
                    },
                    {
                        title: '通勤対象',
                        minWidth: 80,
                        slot: 'commute',
                        align: 'center'
                    },
                    {
                        title: '在宅終日',
                        minWidth: 80,
                        slot: 'day',
                        align: 'center'
                    },
                    {
                        title: '在宅午前',
                        minWidth: 80,
                        slot: 'am',
                        align: 'center'
                    },
                    {
                        title: '在宅午後',
                        minWidth: 80,
                        slot: 'pm',
                        align: 'center'
                    },
                    {
                        title: '在宅時間',
                        minWidth: 80,
                        slot: 'time',
                        align: 'center'
                    }
                ]
            }
        },
        methods: {
            async getHomeWorkInfo() {
                this.updateloading=true
                try {
                    const {data} = await this.http.get(`sys/homeWork/selectAdminHomeWorkList`,this.queryList)
                    this.HomeWorkVOList=data
                } catch (error) {
                    return
                } finally {

                }
            },
            async getHomeWorkMonthVO() {
                try {
                    const {data} = await this.http.get(`sys/homeWork/selectAdminHomeWorkMonthList`,this.queryList)
                    this.HomeWorkMonthVO=data
                    console.log(this.HomeWorkMonthVO)
                } catch (error) {
                    return
                } finally {
                    this.updateloading = false
                }
            },
            async getHomeWorkListInfo() {
                try {
                    const {data} = await this.http.get(`sys/homeWork/selectAdminHomeWorkUpdateList`,this.queryList)
                    this.HomeWorkVOAdminList=data
                    this.HomeWorkVOAdminListBack = JSON.parse(JSON.stringify(data));
                } catch (error) {
                    return
                } finally {
                }
            },
            async getUpdateHomeWorkInfo() {
                try {
                    const {data} = await this.http.get(`sys/homeWork/selectHomeWorkInfo`,this.queryList)
                    this.HomeWorkVOListupdate=data
                    this.HomeWorkVOListEditBack = JSON.parse(JSON.stringify(data));
                } catch (error) {
                    return
                } finally {
                }
            },
            async getTableHead() {
                this.updateloading = true
                const { data } = await this.http.get('sys/permStatList/selectDayHead', this.queryList)
                this.tableHead = data
                if (this.queryList.hidSelectTab == '1'){
                    this.deptName = '検索対象者一覧'
                    this.queryList.txtUserCode = null
                }
                this.updateloading = false
            },
            hwApplyShowFlg(e,e1,e2){
                this.hwApplyShow = !e
                this.queryList.txtTmgReferListTreeViewPermTargetEmp=e1
                this.empName=e2
                this.getUpdateHomeWorkInfo()
            },
            async selectScheduleDateList() {
                try {
                    const query = {
                        employeeId:this.query.employeeId,
                        psSite:this.query.psSite,
                        psApp:this.query.psApp,
                        baseDate:Utils.formatDate(new Date(),'YYYY-MM-DD')
                    }
                    const {data}= await  this.http.get(`sys/schedule/selectScheduleDateList`,query)
                    this.dispMonthlyList=data
                    this.defaultDate=this.dispMonthlyList[1].tda_dyyyymm
                    this.query.txtBaseDate=this.dispMonthlyList[1].tda_firstDay
                    this.queryList.baseDate=Utils.formatDate(query.baseDate,'YYYY/MM/DD')
                    await this.getHomeWorkInfo()
                    await this.getHomeWorkMonthVO()
                    this.getHatuRei()
                } catch (error) {
                    return
                }
            },
            dayRed(e) {
                const dayOfWeek = e.mgdCsparechar
                if (!dayOfWeek) {
                    return
                }
                if (dayOfWeek != '0') {
                    return 'blue'
                }
            },
            dayRedStatus(e1,e2) {
                let aaaaa = e1[`${"hwstatusflg" + e2.slice(13)}`];
                if(aaaaa === '2'){
                    return 'blue'
                }
                return ''
            },
            editTime(index){
                if(this.HomeWorkVOListEditBack[index].hwHomework != '4'){
                    this.HomeWorkVOListEditBack[index].hwStart = null
                    this.HomeWorkVOListEditBack[index].hwEnd = null
                }
            },
            editListTime(index){
                if(this.HomeWorkVOAdminList[index].hwhomework != '4'){
                    this.HomeWorkVOAdminList[index].hwStart = null
                    this.HomeWorkVOAdminList[index].hwEnd = null
                }
            },
            async getHatuRei() {
                try {
                    let txtBaseDate= this.yyyyMMdd.split('～')[0].replace(/(.+?)\年(.+?)\月(.+)\日/,"$1/$2/$3")
                } catch (error) {
                    return
                }finally {

                }
            },
            handleInputChange(i,object,value,el) {
                // 填完后自动checkbox
                if(object) {
                    this.hasPassedTimeCheck = Utils.checkTime(object, value,el)
                }
            },
            handleClose() {
                this.getTableHead()
                this.selectScheduleDateList()
                this.hwApplyShow = false
            },
            time_check(sTime) {
                return sTime.match(/^(([0-3]?[0-9])|([4][0-7])):([0-5]?[0-9])$/);
            },
            editBack(index) {
                if (this.HomeWorkVOListEditBack[index].hwStatus === '0'){
                    this.HomeWorkVOListEditBack[index].hwHomework = null
                    this.HomeWorkVOListEditBack[index].hwStart = null
                    this.HomeWorkVOListEditBack[index].hwEnd = null
                    this.HomeWorkVOListEditBack[index].hwCommute = '0'
                }else{
                    this.HomeWorkVOListEditBack[index].hwHomework = this.HomeWorkVOListupdate[index].hwHomework
                    this.HomeWorkVOListEditBack[index].hwStart = this.HomeWorkVOListupdate[index].hwStart
                    this.HomeWorkVOListEditBack[index].hwEnd = this.HomeWorkVOListupdate[index].hwEnd
                    this.HomeWorkVOListEditBack[index].hwCommute = this.HomeWorkVOListupdate[index].hwCommute
                }
            },
            editlistBack(index) {
                if (this.HomeWorkVOAdminList[index].hwstatus === '0'){
                    this.HomeWorkVOAdminList[index].hwhomework = null
                    this.HomeWorkVOAdminList[index].hwStart = null
                    this.HomeWorkVOAdminList[index].hwEnd = null
                    this.HomeWorkVOAdminList[index].hwCommute = '0'
                }else{
                    this.HomeWorkVOAdminList[index].hwhomework = this.HomeWorkVOAdminListBack[index].hwhomework
                    this.HomeWorkVOAdminList[index].hwStart = this.HomeWorkVOAdminListBack[index].hwStart
                    this.HomeWorkVOAdminList[index].hwEnd = this.HomeWorkVOAdminListBack[index].hwEnd
                    this.HomeWorkVOAdminList[index].hwCommute = this.HomeWorkVOAdminListBack[index].hwCommute
                }
            },
            //登陆处理
            async updateHomeWork() {
                let checkFlg=false
                for (let i = 0; i < this.HomeWorkVOListEditBack.length; i++) {
                    if (this.HomeWorkVOListEditBack[i].hwStatus == null  && this.HomeWorkVOListEditBack[i].hwApprovalcomment != null ){
                        this.HomeWorkVOListEditBack[i].hwStatus="0";
                    }
                    if (this.HomeWorkVOListEditBack[i].hwStatus != null  && this.HomeWorkVOListEditBack[i].hwCommute == null){
                        this.HomeWorkVOListEditBack[i].hwCommute="0";
                    }
                    if (this.HomeWorkVOListEditBack[i].hwStatus == null  && this.HomeWorkVOListEditBack[i].hwApplicationcomment != null){
                        this.HomeWorkVOListEditBack[i].hwStatus="0";
                    }
                    let msday=this.HomeWorkVOListEditBack[i].hwApplicationdate + " : ";
                    if (this.HomeWorkVOListEditBack[i].hwStatus === '1' || this.HomeWorkVOListEditBack[i].hwStatus === '2' || this.HomeWorkVOListEditBack[i].hwStatus === '4') {
                        if( this.HomeWorkVOListEditBack[i].hwHomework === null ){
                            this.$Notice.error({desc: msday + "在宅勤務を入力してください。"})
                            return checkFlg=true;
                        }
                    }
                    if(this.HomeWorkVOListEditBack[i].hwHomework === '4' ){
                        if (this.HomeWorkVOListEditBack[i].hwStart ==null ||  !this.time_check(this.HomeWorkVOListEditBack[i].hwStart)) {
                            this.$Notice.error({desc: msday + "開始時間は適切な時刻ではありません。(hh:mm)形式で時刻を入力及び48:00以内の時刻で指定してください。"})
                            return checkFlg=true;
                        }
                        if (this.HomeWorkVOListEditBack[i].hwEnd ==null ||  !this.time_check(this.HomeWorkVOListEditBack[i].hwEnd)) {
                            this.$Notice.error({desc: msday + "終了時間は適切な時刻ではありません。(hh:mm)形式で時刻を入力及び48:00以内の時刻で指定してください。"})
                            return checkFlg=true;
                        }
                        if(this.HomeWorkVOListEditBack[i].hwStart!='' && this.HomeWorkVOListEditBack[i].hwEnd!=''){
                            let count=Utils.timeToMinute(this.HomeWorkVOListEditBack[i].hwEnd)-Utils.timeToMinute(this.HomeWorkVOListEditBack[i].hwStart)
                            if(0>=count){
                                this.$Notice.error({desc: msday + "開始時間は終了時間の前になるようにしてください。"})
                                return checkFlg=true;
                            }
                        }
                    }
                }
                if(checkFlg){
                    return
                }
                this.$Modal.confirm({
                    title: '注意',
                    content: 'この編集内容で登録します。よろしいですか？',
                    okText: 'OK',
                    width: 480,
                    cancelText: 'キャンセル',
                    onOk: async () => {
                        for (let y = 0; y < this.HomeWorkVOListEditBack.length; y++) {
                            if(this.HomeWorkVOListEditBack[y].hwHomework === '4' ){
                                this.HomeWorkVOListEditBack[y].hwStart = Utils.timeToMinute(this.HomeWorkVOListEditBack[y].hwStart);
                                this.HomeWorkVOListEditBack[y].hwEnd = Utils.timeToMinute(this.HomeWorkVOListEditBack[y].hwEnd);
                            }
                        }
                        let query={ homeWorkVO:this.HomeWorkVOListEditBack }
                        try{
                            await this.http.post(`sys/homeWork/updateHmoeWorkAdminData`,query)

                        }catch (e) {
                            this.$Notice.warning({ title: '注意', desc: e, duration: 6.5 })
                        }finally {
                            this.getHomeWorkInfo()
                            this.getHomeWorkMonthVO()
                            this.hwApplyShow = false
                        }
                    },
                    onCancel: () => {
                    }
                })
            },
            //登陆处理
            async updateHomeWorkList() {
                console.log(this.HomeWorkVOAdminList)
                let checkFlg=false
                for (let i = 0; i < this.HomeWorkVOAdminList.length; i++) {
                    if (this.HomeWorkVOAdminList[i].hwstatus == null  && this.HomeWorkVOAdminList[i].hwApprovalcomment != null ){
                        this.HomeWorkVOAdminList[i].hwstatus="0";
                    }
                    if (this.HomeWorkVOAdminList[i].hwstatus != null  && this.HomeWorkVOAdminList[i].hwCommute == null){
                        this.HomeWorkVOAdminList[i].hwCommute="0";
                    }
                    if (this.HomeWorkVOAdminList[i].hwstatus == null  && this.HomeWorkVOAdminList[i].hwApplicationcomment != null){
                        this.HomeWorkVOAdminList[i].hwstatus="0";
                    }
                    let msday=this.HomeWorkVOAdminList[i].empname + " : ";
                    if (this.HomeWorkVOAdminList[i].hwstatus === '1' || this.HomeWorkVOAdminList[i].hwstatus === '2' || this.HomeWorkVOAdminList[i].hwstatus === '4') {
                        if( this.HomeWorkVOAdminList[i].hwhomework === null ){
                            this.$Notice.error({desc: msday + "在宅勤務を入力してください。"})
                            return checkFlg=true;
                        }
                    }
                    if(this.HomeWorkVOAdminList[i].hwhomework === '4' ){
                        if (this.HomeWorkVOAdminList[i].hwStart ==null ||  !this.time_check(this.HomeWorkVOAdminList[i].hwStart)) {
                            this.$Notice.error({desc: msday + "開始時間は適切な時刻ではありません。(hh:mm)形式で時刻を入力及び48:00以内の時刻で指定してください。"})
                            return checkFlg=true;
                        }
                        if (this.HomeWorkVOAdminList[i].hwEnd ==null ||  !this.time_check(this.HomeWorkVOAdminList[i].hwEnd)) {
                            this.$Notice.error({desc: msday + "終了時間は適切な時刻ではありません。(hh:mm)形式で時刻を入力及び48:00以内の時刻で指定してください。"})
                            return checkFlg=true;
                        }
                        if(this.HomeWorkVOAdminList[i].hwStart!='' && this.HomeWorkVOAdminList[i].hwEnd!=''){
                            let count=Utils.timeToMinute(this.HomeWorkVOAdminList[i].hwEnd)-Utils.timeToMinute(this.HomeWorkVOAdminList[i].hwStart)
                            if(0>=count){
                                this.$Notice.error({desc: msday + "開始時間は終了時間の前になるようにしてください。"})
                                return checkFlg=true;
                            }
                        }
                    }
                }
                if(checkFlg){
                    return
                }
                this.$Modal.confirm({
                    title: '注意',
                    content: 'この編集内容で登録します。よろしいですか？',
                    okText: 'OK',
                    width: 480,
                    cancelText: 'キャンセル',
                    onOk: async () => {
                        for (let y = 0; y < this.HomeWorkVOAdminList.length; y++) {
                            if(this.HomeWorkVOAdminList[y].hwhomework === '4' ){
                                this.HomeWorkVOAdminList[y].hwStart = Utils.timeToMinute(this.HomeWorkVOAdminList[y].hwStart);
                                this.HomeWorkVOAdminList[y].hwEnd = Utils.timeToMinute(this.HomeWorkVOAdminList[y].hwEnd);
                            }
                        }
                        let query={ homeWorkAdminVO:this.HomeWorkVOAdminList }
                        console.log(query)
                        try{
                            await this.http.post(`sys/homeWork/updateHmoeWorkAdminDataList`,query)

                        }catch (e) {
                            this.$Notice.warning({ title: '注意', desc: e, duration: 6.5 })
                        }finally {
                            this.getHomeWorkInfo()
                            this.getHomeWorkMonthVO()
                            this.hwApplyListShow = false
                        }
                    },
                    onCancel: () => {
                    }
                })
            },
            // 年月選択
            async handleStartMonth(e) {
                if(e){
                    this.queryList.baseDate = this.dateFormat(e)
                    this.getHomeWorkInfo()
                    this.getHomeWorkMonthVO()
                }
            },
            async handleClickHead(e) {
                this.updateDay= Utils.formatDate(e,'YYYY年MM月DD日')
                this.queryList.baseDate= e
                this.hwApplyListShow = true
                this.getHomeWorkListInfo()
            },
            dateFormat(e) {
                //YYYY年MM月からYYYY/MM/01へ変換する
                let yearMMDD = e.replace("年","/")
                yearMMDD = yearMMDD.replace("月","/")
                yearMMDD = yearMMDD+"01"
                return  yearMMDD
            },
            //初期化処理
            async getInit() {

                this.targetPermSection = ''
                //検索の初期化対応
                this.queryList.hidSelectTab = [[${ session.hidSelectTab }]]
                this.queryList.hidSearchItems = [[${ session.hidSearchItems }]]
                this.queryList.hidSearchCondition = [[${ session.hidSearchCondition }]]
                this.queryList.hidSearchData = [[${ session.hidSearchData }]]

                this.referListObject.hidSelectTab = [[${ session.hidSelectTab }]]
                this.referListObject.hidSearchItems = [[${ session.hidSearchItems }]] || 'EMPLOYEEID'
                this.referListObject.hidSearchCondition = [[${ session.hidSearchCondition }]] || 'BROADMATCH'
                this.referListObject.hidSearchData = [[${ session.hidSearchData }]]

                if([[${ session.txtTmgReferListTreeViewPermSelectedView }]] === "group"){
                    this.targetPermSection = [[${ session.txtTmgReferListTreeViewPermTargetGroup }]]
                } else if ([[${ session.txtTmgReferListTreeViewPermSelectedView }]] === "all"){
                    this.targetPermSection = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                } else if ([[${ session.txtTmgReferListTreeViewPermSelectedView }]] === "section"){
                    this.targetPermSection = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                }
                this.referListObject.txtTmgReferListTreeViewRecordDate = Utils.formatDate([[${ session.TmgReferListSYSDATE }]], 'yyyy/mm/dd')
                await this.getOrgTree()
                await this.getSearchCondition()
                await this.getTableHead()
                await　this.selectScheduleDateList()
                window.addEventListener('scroll',this.handleScroll,{ passive: true })

                //　初回管理サイトの画面にアクセスするなら、targetSectionがnullであることから、下記通りでデフォルト所属を設定する
                // １．ログインユーザが本人所属部署の承認権限がある場合、ログインユーザの所属部署をデフォルト所属とする。
                // ２．ログインユーザが本人所属部署の管理権限がない場合、ログインユーザの管理対象部署のTOP部署をデフォルト所属とする

                if (this.targetPermSection != null || this.targetPermSection != '') {
                    // this.getDeptCode(this.treeData)
                    if (this.targetPermSectionFlag) {
                        this.getDeptName(this.treeData)
                        this.queryList.txtTmgReferListTreeViewPermTargetSection = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                        this.queryList.txtTmgReferListTreeViewPermTargetGroup = [[${ session.txtTmgReferListTreeViewPermTargetGroup }]]
                        this.queryList.txtTmgReferListTreeViewPermSelectedView = [[${ session.txtTmgReferListTreeViewPermSelectedView }]]
                        this.queryList.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                        this.queryList.recordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                    } else {
                        this.deptName = this.treeData[0].label
                        this.queryList.txtTmgReferListTreeViewPermTargetSection = this.treeData[0].secid
                        this.queryList.txtTmgReferListTreeViewPermTargetGroup = this.treeData[0].groupid
                        this.queryList.txtTmgReferListTreeViewPermSelectedView = [[${ session.txtTmgReferListTreeViewPermSelectedView }]]
                        this.queryList.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                        this.queryList.recordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                    }
                }
                this.approval = false
            },
            async handleDeptDateChange(e) {
                this.referListObject.txtTmgReferListTreeViewRecordDate = e
                this.isSearchHistory = true
                await this.getOrgTree()
                if(this.treeData.length !== 0) {
                    this.$Notice.warning({ title:'所属図更新完了',desc:"下記の所属リストから対象を選んでください" })
                }
            },
            async handleDeptViewTypeChange(e) {
                this.selectedDeptViewType = e
                if (this.selectedDeptViewType === "all") {
                    this.deptDrawShow = false
                    this.deptName = '全て表示中'
                    this.treeData = []
                    this.queryList.txtTmgReferListTreeViewPermSelectedView = 'all'
                    this.referListObject.txtTmgReferListTreeViewPermSelectedView = 'all'
                    await　this.selectScheduleDateList()
                    return
                }
                await this.getOrgTree()
                if (this.selectedDeptViewType === "section") {
                    this.queryList.txtTmgReferListTreeViewPermSelectedView = 'section'
                    this.referListObject.txtTmgReferListTreeViewPermSelectedView = 'section'
                }
                if (this.selectedDeptViewType === "group") {
                    this.queryList.txtTmgReferListTreeViewPermSelectedView = 'group'
                    this.referListObject.txtTmgReferListTreeViewPermSelectedView = 'group'
                }
                this.$Notice.success({ title: '所属図更新完了' })
            },
            async getSearchCondition() {
                const { data } = await this.http.get('sys/tree/conditions', this.referListObject)
                this.searchConditionsList= Object.keys(data.searchConditions).map(e=> { return { name:data.searchConditions[e], value:e }})
                this.searchTypesList = Object.keys(data.searchTypes).map(e=> { return { name:data.searchTypes[e], value:e }})
            },
            async handleClickLeaf(e) {
                //同一部署を二回目でクリックすると、取消とするためで、エラーあり
                //よって、二回目クリックすると、何もしない
                if(!e[0]) return

                this.deptDrawShow = false

                this.queryList.txtAction = 'ACT_DISP_MONTHLY'

                if (this.selectedDeptViewType === "section") {
                    this.deptName = e[0].label
                }
                if (this.selectedDeptViewType === "group") {
                    this.deptName = e[0].secnic
                }

                this.queryList.txtTmgReferListTreeViewPermTargetSection = e[0].secid
                this.queryList.txtTmgReferListTreeViewPermTargetGroup = e[0].groupid
                this.queryList.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate


                //年月リストの取得
                //初期化
                // this.tableHead = []
                this.approval = false
                //ツリーを選択するの場合、0で設定する
                this.queryList.hidSelectTab='0'
                await this.getTableHead()
                await　this.selectScheduleDateList()
                // }

                //ツリーを選択するの場合、0で設定する
                this.query.hidSelectTab = '0'
            },
            async getOrgTree(refreshDept) {
                this.empDeptLoading = true
                try {
                    const { groupList, sectionList, recordDate } = await this.http.get('sys/tree', this.referListObject)
                    // 先将数据转为标准格式，再转为可用数据
                    if (this.selectedDeptViewType === "section") {
                        this.treeData = Utils.convertTreeData(sectionList)
                    }
                    if (this.selectedDeptViewType === "group") {
                        this.treeData = Utils.convertTreeData(groupList)
                    }
                    this.referListObject.txtTmgReferListTreeViewRecordDate = recordDate
                } catch (error) {
                    return
                } finally {
                    this.empDeptLoading = false
                }
            },
            handleClickEmpLeaf(e) {
                this.queryList.hidSelectTab = '1'
                this.queryList.hidSearchData = this.referListObject.hidSearchData
                this.queryList.hidSearchItems = this.referListObject.hidSearchItems
                this.queryList.hidSearchCondition = this.referListObject.hidSearchCondition
                if (this.queryList.hidSearchData === null || this.queryList.hidSearchData.trim() == '') {
                    this.$Message.error({
                        background: true,
                        closable: true,
                        duration: 6,
                        content: '検索内容が未設定です。検索内容を入力してください。'
                    });
                    return
                }
                this.getTableHead()
                this.selectScheduleDateList()
            },
            handleScroll: Throttle(function(e) {
                this.contentScrollTop = e.target.documentElement.scrollTop || e.target.body.scrollTop
            }, 50)
        }
    })
</script>
</body>

</html>