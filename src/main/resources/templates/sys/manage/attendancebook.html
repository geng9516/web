<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head
    th:replace="layout/header::common_header(title='出勤簿',cssPaths='/pages/content.min.css,' + '/pages/workYearSchedule.min.css')">
</head>

<body>
<div th:replace="layout/loadingBar::loadingBar"></div>
<style>
    .need-turnline-top:empty {
        display: block;
        position: relative;
        height: 21px;
    }
    .need-turnline-btm:empty {
        display: block;
        position: relative;
        height: 27px;
    }
</style>
<!-- 菜单导航栏 -->
<div th:replace="layout/sider"></div>
    <main class="content workyearschedule-warp" ref="layout">
        <div class="content_head">
            <div class="header">
                <div class="title1">
                    <h1>
                        <Icon type="i-emeer colored"></Icon>
                        {{  fromYYYYMM ? `出勤簿（${fromYYYYMM}～ ${toYYYYMM}）` : '出勤簿' }}
                    </h1>
                </div>
                <div class="btnbox">
                    <!-- 出勤簿一个按钮都没有，需要占位 -->
                    
                </div>
            </div>
            <div class="searchwrap">
                <span class="label">表示開始月</span>
                <i-select v-model="query.month" :disabled="!selectDisabled" class="mr30" @on-change="handleStartMonth($event)">
                    <i-option v-for="(item, index) of monthSelect" :key="index" :label="item" :value="index + 1">
                    </i-option>
                </i-select>

                <!-- 共通組織図画面 start-->
                <span style="display:flex;width: calc(15% + 200px);">
                    <span class="label">所属</span>
                    <i-button v-on:click.native="deptDrawShow = true" class="input-like-span dept-select">
                        <Tooltip trigger="hover" :theme="toolTipTheme()" transfer>{{deptName}}
                            <div slot="content">{{deptName}}</div>
                        </Tooltip>
                    </i-button>

               <Drawer :closable="false" class="tc" placement="right" title="所属職員を選択してください" width="700"
                            :mask-closable="!isSearchHistory" v-model="deptDrawShow">
                <Tabs :animated="false" v-model="currentTab" @on-click="currentTabChanged">
                <tab-pane label="ツリー" name="organisationTree">
                        <div class="titlenorm mb5">
                            <Icon type="logo-buffer"></Icon>
                            所属
                        </div>
                        <Row class="tl mb5">
                            <i-col span="4" class="label tc" style="height: 32px;">基準日</i-col>
                            <i-col span="7" class="no-border-radius">
                            <date-picker type="date" :value="referListObject.txtTmgReferListTreeViewRecordDate" transfer :options="startLimit"
                                         placeholder="基準日" format="yyyy/MM/dd" ref="datePicker" :clearable="false" @on-change="handleDeptDateChange"></date-picker>
                            </i-col>
                            <i-col span="4" class="label ml5 tc" style="height: 32px;">ビュー選択</i-col>
                            <div style="display: inline-block;width: 32.5%;" class="no-border-radius">
                            <i-select :value="selectedDeptViewType" @on-change="handleDeptViewTypeChange">
                                <i-option value="all">全て</i-option>
                                <i-option value="group">グループごとに</i-option>
                                <i-option value="section">部署ごとに</i-option>
                            </i-select>
                            </div>
                        </Row>
                        <div style="position: relative;">
                            <Tree class="tree mt2" :data="treeData" v-on:on-select-change="handleClickLeaf" ref="tree"
                                  empty-text="所属データなし"></Tree>
                            <Spin size="large" fix v-if="empDeptLoading"></Spin>
                        </div>
                </tab-pane>
                <tab-pane label="検索" name="organisationSearch">
                        <Row class="tl mb2" :gutter="8">
                            <i-col span="15">
                                <i-input v-model="referListObject.hidSearchData" @on-search="searchOrgTree" class="mar mb5 like-select" search enter-button placeholder="検索">
                                    <i-select v-model="referListObject.hidSearchItems" slot="prepend" style="width: 108px" placeholder="項目">
                                        <i-option v-for="(item,i) of searchTypesList" :value="item.value">{{ item.name }}</i-option>
                                    </i-select>
                                    <i-select v-model="referListObject.hidSearchCondition"  slot="append" style="width: 108px" placeholder="条件">
                                        <i-option v-for="(item,i) of searchConditionsList" :value="item.value">{{ item.name }}</i-option>
                                    </i-select>
                                </i-input>
                            </i-col>
                            <i-col span="8" class="no-border-radius">
                                <i-button long type="primary" icon="md-search" ghost :loading="empDeptLoading" @click="searchOrgTree">検索</i-button>
                            </i-col>
                        </Row>
                        <div class="titlenorm mt15">
                            <Icon type="logo-buffer"></Icon>
                            職員
                        </div>
                        <div style="position: relative;">
                            <Tree class="tree mt2" :data="empTreeData" v-on:on-select-change="handleClickLeaf" ref="tree"
                                  empty-text="職員データなし"></Tree>
                            <Spin size="large" fix v-if="empDeptLoading"></Spin>
                        </div>
                </tab-pane>
               </Tabs>
                </Drawer>
                <!-- 共通組織図画面 end-->
                </span>
                <span class="label">氏名</span>
                <span class="input-like-span width15">
                    <Tooltip trigger="hover"　:theme="toolTipTheme()" transfer　v-if="kanjiName">{{kanjiName}}
                        <div slot="content">{{kanjiName}}</div>
                    </Tooltip>
                </span>
            </div>
        </div>
        <div class="content_body">
            <div class="table-top">
                <Row :gutter="16">
                    <!-- 共通年選択 start-->
                    <i-col span="11">
                        <i-button type="text" @click="preYear" :disabled="preDisabled || !selectDisabled" class="icon-left">
                            <Icon type="ios-arrow-back" size="large"></Icon>
                        </i-button>
                        <i-button type="text" @click="currentYear" :disabled="showPre" class="icon-center">今年</i-button>
                        <i-button type="text" @click="nextYear" :disabled="nextDisabled || !selectDisabled" class="icon-right">
                            <Icon type="ios-arrow-forward" size="large"></Icon>
                        </i-button>
                    </i-col>
                    <!-- 共通年選択 end-->

                    <i-col span="13" class="tr">
                        <i-button type="primary" :disabled="!tableData.length > 0" class="mr5" ghost icon="md-paper" @click="pdfDownload" :loading="pdfDownloadLoading">PDFダウンロード</i-button>
                    </i-col>
                </Row>
            </div>

            <Row :gutter="10" class="mt5 mb15 tc">
                <i-col span="4">
                    <div class="label spec">年次休暇付与日数</div>
                    <div class="month-sum">{{ endueDaysHours }}</div>
                </i-col>
                <i-col span="4">
                    <div class>
                        <div class="label spec">年次休暇付与日</div>
                        <div class="month-sum">{{ endueDate }}</div>
                    </div>
                </i-col>
                <i-col span="8" class="no-border-radius">
                    <div class="label spec">摘要
                        <Poptip
                            v-if="remarksDisabled"
                            v-model="commentBtnShow"
                            class="comment-btn tl"
                            placement="right"
                            title="入力内容を登録します。よろしいですか？">
                            <i-button type="primary" ghost size="small" icon="md-create" style="border-radius: 23px" :loading="commentBtnLoading"><span style="margin-left: -4px;">登録</span></i-button>
                            <div class="tr" slot="content">
                            <i-button class="mr10" type="text" size="small" @click="cancelComment">いいえ</i-button>
                            <i-button type="primary" ghost size="small" @click="updateComment" style="border-radius: 23px">はい</i-button>
                        </div>
                        </Poptip>
                        </div>
                    <i-input class="tl" :disabled="!remarksDisabled" type="textarea" :autosize="{ maxRows: 2 }" v-model="query.comment" />
                </i-col>
            </Row>
            <div class="titlenorm mb10 mt10" style="font-size:15px">
                <Icon type="logo-buffer"></Icon>
                月出勤情報統計
            </div>
            <i-table :class="tableHeadFixed ? 'table-head-fixed sum-table' : 'sum-table'" :columns="columns" border no-data-text="所属職員を選択して下さい。"
                     :row-class-name="rowClass" :disabled-hover="true" :data="tableDataSum" :loading="loading">
                <template slot-scope="{ row }" slot="intDay">
                    <div style="position: relative;">
                        <span :class="row._index === 0 ? '' : 'mr15 sum-title-divi'">{{ row.intDay.split('日')[0].trim() }}</span>
                        <div style="position: absolute;top: -13px;left: 72px;" v-if="row._index !== 0">日</div>
                        <div class="divi-hour-line-small" style="position: absolute;top: 15px;left: 72px;" v-if="row._index !== 0">時</div>
                    </div>
                </template>

                <!-- 循环slotList -->
                <template v-for="item of slotList" slot-scope="{ row }" :slot="item">
                    <span :class="dayRed(row[item])" v-if="!row.needTurnLine">{{ row[item] | turnLine }}</span>
                    <div class="mb-2 need-turnline-top" v-if="row.needTurnLine">{{ row[item].split(TURN_LINE_STR)[0].trim() }}</div>
                    <div v-if="row.needTurnLine" class="divi-hour-line mb-2 need-turnline-btm">{{ row[item].split(TURN_LINE_STR)[1].trim() }}</div>
                </template>
            </i-table>

            <div class="titlenorm mb10 mt10" style="font-size:15px" v-show="tableData.length > 0">
                <Icon type="logo-buffer"></Icon>
                月出勤情報明細
            </div>
            <i-table :show-header="false" no-data-text=" " border :columns="columns"
                     :row-class-name="rowClass" :disabled-hover="true" :data="tableData" :loading="loading" v-show="tableData.length > 0">
                <template slot-scope="{ row }" slot="intDay">
                    <span>{{ row.intDay }}</span>
                </template>

                <template v-for="item of slotList" slot-scope="{ row }" :slot="item">
                    <span :class="dayRed(row[item])">{{ row[item] | turnLine }}</span>
                </template>
            </i-table>
        </div>
        <BackTop></BackTop>
    </main>
    <div th:replace="layout/head::header"></div>
    <script type="text/babel" th:inline="javascript">
        const WORK_YEAR_SCHEDULE = new Vue({
            el: '.workyearschedule-warp',
            data() {
                return {
                    monthSelect: Utils.getNumArray(1, 12).map(e => `${e}月`),  //表示開始月
                    slotList: ['one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve'],
                    commentBtnLoading: false,　 //摘要更新loading制御
                    commentBtnShow:false,　　　 //摘要登録表示制御
                    defaultDate: {},            //表示開始月のデフォルト月
                    queryDate: {},              //選択した開始月
                    queryHolidayInfo: {},       //年次休暇付与日数 年次休暇付与日
                    tableHead: [],              //月出勤情報統計と月出勤情報明細のテーブルヘッダー
                    loading: false,             //ローディングアクション-->
                    pdfDownloadLoading: false,  //PDFダウンロードローディングアクション
                    tableData: [],              //月出勤情報統計と月出勤情報明細のテーブルデータ
                    showPre: true,
                    selectDisabled: false,      //所属の職員を選択していない場合、表示月選択できるかどうかを制御する
                    remarksDisabled: false,     //摘要更新可能制御する
                    index: 0,
                    comment: '',
                    contentScrollTop: 0,
                    kanjiName: '',　         　 //選択した職員の氏名
                    loginEmployee: '',          //選択した職員の職員番号
                    query: {
                        employeeId: '',        //組織ツリーで選択した職員番号
                        year: '',              //年度情報
                        month: 0,              //表示開始月
                        hidSelectTab:'0',      //組織タブー0：ツリ、1:検索
                        modifieruserId: [[${ session.psSession.loginEmployee }]],  //摘要更新ユーザ（ログインユーザ）
                        comment: this.tmyComment,                                  //摘要
                        txtTmgReferListTreeViewPermSelectedView: '',
                        txtTmgReferListTreeViewPermTargetSection: '',
                        txtTmgReferListTreeViewPermTargetGroup: '',
                        txtTmgReferListTreeViewPermTargetEmp: '',
                        txtDYYYYMM: '',
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        psApp: Utils.getUrlParam(location.href,'psApp'),
                    },
                    isSearchHistory: false,
                    endueDate: '',            //年次休暇付与日
                    endueDaysHours: '',       //年次休暇付与日数
                    tmyComment: '',           //摘要
                    fromYYYYMM: '',       　  //出勤簿の表示開始年月
                    toYYYYMM: '',             //出勤簿の表示終了年月
                    contentScrollTop: 0,
                    isScroll: false,
                    titleStartMonth: '',    //デフォルト開始月
                    data: [],
                    referListObject: {       //組織ツリー共通
                        [[${ TREEVIEW_KEY_PERM_TARGET_SECTION }]]: '',
                        [[${ TREEVIEW_KEY_PERM_TARGET_EMP }]]: '',
                        [[${ TREEVIEW_KEY_PERM_TARGET_GROUP }]]: '',
                        [[${ TREEVIEW_KEY_RECORD_DATE }]]: '',
                        [[${ TREEVIEW_KEY_REFRESH_FLG }]]: '',
                        hidSearchItems:'EMPLOYEEID',
                        hidSearchCondition:'BROADMATCH',
                        hidSearchData:'',
                        txtTmgReferListTreeViewRecordDate: '',
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        psApp: Utils.getUrlParam(location.href,'psApp'),
                        type: 11
                    },
                    selectedDeptViewType: [[${ session.txtTmgReferListTreeViewPermSelectedView }]], //組織ツリー用
                    empDeptLoading: false,  // 組織ツリーloading用
                    deptDrawShow: false,    //組織ツリー用
                    treeData:[],            //組織ツリー用
                    empTreeData: [],        //組織ツリー用
                    searchConditionsList: [],//組織ツリー用
                    searchTypesList: [],     //組織ツリー用
                    deptName: '選んでください',   //選択した職員の所属
                    tableDataSum:[],        //月出勤情報統計
                    existsAttendanceBook: {},　 //年度選択制御
                    preDisabled: true,   //年度選択制御
                    nextDisabled: true,  //年度選択制御
                    currentTab: '',         //組織のツリーと検索タブーを切り替え
                    ledgerParamVO: {
                        txtAction: 'ACT_LEDGER_PDF_DOWNLOAD',
                        txtLedgerSheetId: 'ATTENDANCEBK_YEARLY',
                        txtEmp: '',
                        hidEmpId: '',　 //組織ツリーで選択した職員番号
                        txtOrg: '',
                        hidOrgId: '',
                        txtYYYY: '',
                        txtYYYYMM: '',
                        txtTermFrom: '',
                        txtTermTo: '',
                        txtAtdBookTermFrom: '1',//デフォルト：1月を設定する
                        txtIncludeOt100Flg: '',
                        psSecurityDate: '',
                        selLedgerSheet: 'ATTENDANCEBK_YEARLY',
                        selYear: '',
                        selMonth: '',
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        psApp: Utils.getUrlParam(location.href, 'psApp'),
                    },
                }
            },
            async mounted() {
                await this.getInit()
                // this.getOrgTree()
                // this.getSearchCondition()
                 window.addEventListener('scroll',this.handleScroll,{ passive: true })
            },
            beforeDestroy() {
                window.removeEventListener('scroll',this.handleScroll,{ passive: true })
            },
            computed: {
                tableHeadFixed() {
                    if (this.contentScrollTop > 300) return true
                    else return false
                },
                columns() {
                    return [
                        {
                            title: ' ',
                            slot: 'intDay',
                            width: 100,
                            align: 'center'
                        },
                        {
                            title: this.tableHead[0] || '04月',
                            minWidth: 70,
                            slot: 'one',
                            align: 'center'
                        },
                        {
                            title: this.tableHead[1] || '05月 ',
                            minWidth: 70,
                            slot: 'two',
                            align: 'center'
                        },
                        {
                            title: this.tableHead[2] || '06月 ',
                            slot: 'three',
                            minWidth: 70,
                            align: 'center'
                        },
                        {
                            title: this.tableHead[3] || '07月 ',
                            minWidth: 70,
                            slot: 'four',
                            align: 'center'
                        },
                        {
                            title: this.tableHead[4] || '08月 ',
                            minWidth: 70,
                            key: 'minusTime',
                            slot: 'five',
                            align: 'center'
                        },
                        {
                            title: this.tableHead[5] || '09月 ',
                            minWidth: 70,
                            slot: 'six',
                            align: 'center'
                        },
                        {
                            title: this.tableHead[6] || '10月',
                            minWidth: 70,
                            slot: 'seven',
                            align: 'center'
                        },
                        {
                            title: this.tableHead[7] || '11月',
                            minWidth: 70,
                            slot: 'eight',
                            align: 'center'
                        },
                        {
                            title: this.tableHead[8] || '12月',
                            minWidth: 70,
                            slot: 'nine',
                            align: 'center'
                        },
                        {
                            title: this.tableHead[9] || '01月',
                            minWidth: 70,
                            slot: 'ten',
                            align: 'center'
                        },
                        {
                            title: this.tableHead[10] || '02月',
                            minWidth: 70,
                            slot: 'eleven',
                            align: 'center'
                        },
                        {
                            title: this.tableHead[11] || '03月',
                            minWidth: 70,
                            slot: 'twelve',
                            align: 'center'
                        }
                    ]
                }
            },
            methods: {
                async getData(isInit) {
                    //初期化
                    this.endueDate = ''
                    this.endueDaysHours = ''
                    this.query.comment = ''

                    if (isInit) await this.getdefaultDate()
                    else await this.getqueryDate()
                    await this.getExistsAttendanceBook()
                    await this.getqueryHolidayInfo()
                    await this.getTableData()
                },
                async getdefaultDate() {
                    this.loading = true
                    const { data } = await this.http.get(`sys/attendanceBook/defaultDate`, { employeeId: this.loginEmployee })
                    this.defaultDate = data
                    this.query.month = +this.defaultDate.mgd_ndefault_month
                    this.query.year = Utils.formatDate(this.defaultDate.dispterm_start, 'yyyy')
                    this.fromYYYYMM = Utils.formatDate(this.defaultDate.dispterm_start, 'yyyy年mm月')
                    this.toYYYYMM = Utils.formatDate(this.defaultDate.dispterm_end, 'yyyy年mm月')
                    this.query.txtDYYYYMM = Utils.formatDate(this.query.year + "/"+ this.query.month + "/" + "01", 'yyyy/mm/dd')

                    this.ledgerParamVO.txtAtdBookTermFrom = +this.defaultDate.mgd_ndefault_month
                    this.ledgerParamVO.txtYYYY = Utils.formatDate(this.defaultDate.dispterm_start, 'yyyy')
                    this.ledgerParamVO.txtYYYYMM = Utils.formatDate(this.defaultDate.dispterm_start, 'yyyy/mm') + "/01"
                },
                async getqueryDate() {
                    this.loading = true
                    const { data } = await this.http.get(`sys/attendanceBook/queryDate`, this.query)
                    this.queryDate = data
                    this.query.month = +Utils.formatDate(this.queryDate.dispterm_start, 'mm')

                    this.query.year = Utils.formatDate(this.queryDate.dispterm_start, 'yyyy')
                    this.fromYYYYMM = Utils.formatDate(this.queryDate.dispterm_start, 'yyyy年mm月')
                    this.toYYYYMM = Utils.formatDate(this.queryDate.dispterm_end, 'yyyy年mm月')

                    this.ledgerParamVO.txtAtdBookTermFrom = +Utils.formatDate(this.queryDate.dispterm_start, 'mm')
                    this.ledgerParamVO.txtYYYY = Utils.formatDate(this.queryDate.dispterm_start, 'yyyy')
                    this.ledgerParamVO.txtYYYYMM = Utils.formatDate(this.defaultDate.dispterm_start, 'yyyy/mm') + "/01"
                },
                async getExistsAttendanceBook() {
                    const { data } = await this.http.get(`sys/attendanceBook/selectExistsAttendanceBook`, this.query)
                    this.existsAttendanceBook  = data

                    if (!this.existsAttendanceBook.lastYear) this.preDisabled = true
                    else this.preDisabled = false

                    if (!this.existsAttendanceBook.nextYear) this.nextDisabled = true
                    else this.nextDisabled = false
                },
                async getqueryHolidayInfo() {
                    const { data } = await this.http.get(`sys/attendanceBook/queryHolidayInfo`, this.query)
                    this.queryHolidayInfo = data
                    // 年次休暇付与日数
                    this.endueDate = this.queryHolidayInfo.endueDate

                    // 年次休暇付与日
                    this.endueDaysHours = this.queryHolidayInfo.endueDaysHours

                    // 摘要
                    this.query.comment = this.queryHolidayInfo.tmy_comment

                },
                async getTableData() {
                    const turnLine = Vue.filter('turnLine');
                    try {
                        const { data } = await this.http.get(`sys/attendanceBook/attendanceBookList`, this.query)
                        // 第一条是表头, 且需要去除空值intDay
                        // 统计部分着色判断是不是统计，根据是不是转成数字是不是其本身判断
                        // 拆成两份表格
                        this.tableDataSum = data.slice(1,7).map((e, i)=>{
                            return {
                                ...e,
                                intDay: turnLine(e.intDay),
                                needTurnLine:  e.intDay.indexOf(TURN_LINE_STR) > -1 ? true : false,
                                cellClassName: e.intDay.indexOf(TURN_LINE_STR) > -1 || i === 0 ? {intDay: 'sub-title'} : {}
                            }
                        })
                        this.tableData = data.slice(7)
                        this.tableHead = Object.values(data[0]).filter(e => e)
                    } catch (error) {
                        return
                    } finally {
                        this.loading = false
                        this.isSearchHistory = false
                    }
                },
                async getOrgTree() {
                    this.empDeptLoading = true
                    try {
                        const { groupMemberList, memberList, sectionMemberList, recordDate } = await this.http.get('sys/tree', this.referListObject)
                        // 先将数据转为标准格式，再转为可用数据
                        if(this.selectedDeptViewType === "section") {
                            this.treeData = Utils.convertTreeData(sectionMemberList)
                            this.query.txtTmgReferListTreeViewPermSelectedView = "section"
                        }
                        if(this.selectedDeptViewType === "group") {
                            this.treeData = Utils.convertTreeData(groupMemberList)
                            this.query.txtTmgReferListTreeViewPermSelectedView = "group"
                        }
                        if(this.selectedDeptViewType === "all") {
                            this.treeData = Utils.convertTreeData(memberList)
                            this.query.txtTmgReferListTreeViewPermSelectedView = "all"
                        }
                        this.referListObject.txtTmgReferListTreeViewRecordDate = recordDate
                    } catch (error) {
                        return
                    } finally {
                        this.loading = false
                        this.empDeptLoading = false
                    }
                },
                async getSearchCondition() {
                    const { data } = await this.http.get('sys/tree/conditions', this.referListObject)
                    this.searchConditionsList= Object.keys(data.searchConditions).map(e=> { return { name:data.searchConditions[e], value:e }})
                    this.searchTypesList = Object.keys(data.searchTypes).map(e=> { return { name:data.searchTypes[e], value:e }})
                },
                searchOrgTree: Debounce( async function() {
                    this.empDeptLoading = true
                    try {
                        const { data } = await this.http.get('sys/tree/search', this.referListObject)
                        this.empTreeData = Utils.convertTreeData(data)
                        this.$Notice.success({ title:'所属図更新完了' })
                    } catch (error) {
                        return
                    } finally {
                        this.empDeptLoading = false
                    }
                }),
                async handleDeptDateChange(e) {
                    this.referListObject.txtTmgReferListTreeViewRecordDate = e
                    this.query.txtTmgReferListTreeViewRecordDate = e
                    this.isSearchHistory = true
                    await this.getOrgTree()
                    if(this.treeData.length !== 0) {
                        this.$Notice.warning({ title:'所属図更新完了',desc:"下記の所属リストから対象を選んでください" })
                    }
                },
                async handleDeptViewTypeChange(e) {
                    this.selectedDeptViewType = e
                    this.query.txtTmgReferListTreeViewPermSelectedView = this.selectedDeptViewType
                    await this.getOrgTree()
                    this.$Notice.success({ title: '所属図更新完了' })
                },
                handleStartMonth: Debounce(async function (e) {
                    //他画面ではtxtDYYYYMMを利用するかもしれないためで、事前に保存しておく。
                    this.query.txtDYYYYMM = Utils.formatDate(this.query.year + "/"+ e + "/" + "01", 'yyyy/mm/dd')
                    this.titleStartMonth = e
                    this.getData()
                }),
                rowClass(row) {
                    // 表格变色
                    if (!row.dayDivisionCode || row.dayDivisionCode === '1') {
                        return ''
                    }
                    return 'sat'
                },
                dayRed(e) {
                    if (!e) {
                        return
                    }
                    if (e.indexOf('土') > -1 || e.indexOf('日') > -1) {
                        return 'rest-cell week-rest'
                    }
                    if (e.indexOf('休') > -1) {
                        return 'rest-cell year-rest'
                    }
                    return 'rest-cell'
                },

                handleScroll: Throttle(function(e) {
                    this.contentScrollTop = e.target.documentElement.scrollTop || e.target.body.scrollTop
                }, 50),
                async　preYear() {
                    this.showPre = false
                    this.query.year = Utils.formatDate(this.existsAttendanceBook.lastYear, 'yyyy')
                    this.query.txtDYYYYMM = Utils.formatDate(this.query.year + "/"+ this.query.month + "/" + "01", 'yyyy/mm/dd')
                    this.getData()
                },
                async　nextYear() {
                    this.showPre = true
                    this.query.year = Utils.formatDate(this.existsAttendanceBook.nextYear, 'yyyy')
                    this.query.txtDYYYYMM = Utils.formatDate(this.query.year + "/"+ this.query.month + "/" + "01", 'yyyy/mm/dd')
                    this.getData()
                },
                async　currentYear() {
                    this.showPre = true
                    this.query.year = Utils.formatDate(this.existsAttendanceBook.currentYear, 'yyyy')
                    this.query.txtDYYYYMM = Utils.formatDate(this.query.year + "/"+ this.query.month + "/" + "01", 'yyyy/mm/dd')
                    this.getData()
                },
                showDay() {
                    //todo: 跳到详情页
                    location.href = "./VacationTablePanel/vacationtablepanel.html";
                },
                handleSelector() { },
                async handleClickLeaf(e) {
                    //同一部署を二回目でクリックすると、取消とするためで、エラーあり
                    //よって、二回目クリックすると、何もしない
                    if(!e[0]) return
                    if(e[0].children) return

                    this.deptDrawShow = false
                    const section = [[${ TREEVIEW_KEY_PERM_TARGET_SECTION }]]

                    this.referListObject[section] = e[0].secid
                    this.loginEmployee = e[0].empid
                    this.deptName = e[0].secnic
                    this.query.employeeId = e[0].empid
                    this.kanjiName = e[0].empname
                    this.selectDisabled = true
                    this.remarksDisabled = true
                    this.ledgerParamVO.hidEmpId = e[0].empid
                    this.query.txtTmgReferListTreeViewPermTargetSection = e[0].secid
                    this.query.txtTmgReferListTreeViewPermTargetGroup = e[0].groupid
                    this.query.txtTmgReferListTreeViewPermTargetEmp = e[0].empid
                    this.getData(true)
                },
                // 摘要更新
                async updateComment() {
                    // 首先将浮层关闭，然后按钮进入loading状态，请求完成后提示完了并且loading结束
                    this.commentBtnShow = false
                    this.commentBtnLoading = true

                    if(this.query.comment != null){
                        if (this.query.comment.replace(/[^\x00-\xff]/g, '01').length > 400) {
                            this.$Message.error({
                                background: true,
                                closable: true,
                                duration: 0,
                                content: '摘要が設定値を超えています。全角・半角カナ200字以内、半角英数400字以内。'
                            });
                            this.commentBtnLoading = false
                            return
                        } else {
                            const { data,code } = await this.http.get(`sys/attendanceBook/updateComment`, this.query)
                            if(code==0){
                                this.$Message.success('登録完了')
                                this.commentBtnLoading = false
                            }
                        }
                    }
                    this.commentBtnLoading = false
                },
                cancelComment() {
                    this.commentBtnShow = false
                },
                currentTabChanged(name) {
                    if (name=="organisationTree") {
                        this.query.hidSelectTab='0'
                    } else if (name=="organisationSearch") {
                        this.query.hidSelectTab='1'
                    }
                },
                async　pdfDownload() {
                    this.pdfDownloadLoading = true
                    const { data, headers } = await this.http.post('sys/tmgLedger/pdfDownload', this.ledgerParamVO,true)
                    Utils.downloadFile(data,decodeURI(headers.filename,"UTF-8"),'application/pdf')
                    this.pdfDownloadLoading = false
                },
                //初期化処理
                async getInit() {
                    console.log([[${ session }]])
                    let targetPermEmp = [[${ session.txtTmgReferListTreeViewPermTargetEmp }]]
                    let targetPermSection = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                    let targetPermGroup = [[${ session.txtTmgReferListTreeViewPermTargetGroup }]]

                    if(Utils.formatDate([[${ session.TmgReferListSYSDATE }]], 'yyyy/mm/dd')){
                        this.referListObject.txtTmgReferListTreeViewRecordDate =  Utils.formatDate([[${ session.TmgReferListSYSDATE }]], 'yyyy/mm/dd')
                    }
                    await this.getOrgTree()
                    this.getSearchCondition()
                    console.log(this.treeData)
                    //　初回サイトの画面にアクセスするなら、targetSectionがnullであることから、下記通りでデフォルト所属を設定する
                    if (targetPermSection) {
                        console.log("getEmpCode(data,empId,sectionId")
                        console.log(this.treeData)
                        console.log(targetPermEmp)
                        console.log(targetPermSection)
                        let getEmpCode=this.getEmpCode(this.treeData,targetPermEmp,targetPermSection,targetPermGroup)
                        console.log(getEmpCode)
                        if (getEmpCode) {
                            console.log(1)
                            this.getDeptName(this.treeData,targetPermSection,targetPermGroup)
                            this.getEmpName(this.treeData,targetPermEmp)
                            this.referListObject.txtTmgReferListTreeViewPermTargetSection = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                            this.referListObject.txtTmgReferListTreeViewPermTargetGroup = [[${ session.txtTmgReferListTreeViewPermTargetGroup }]]
                            this.referListObject.txtTmgReferListTreeViewPermTargetEmp = [[${ session.txtTmgReferListTreeViewPermTargetEmp }]]
                            this.query.txtTmgReferListTreeViewPermTargetSection = this.referListObject.txtTmgReferListTreeViewPermTargetSection
                            this.query.txtTmgReferListTreeViewPermTargetEmp = this.referListObject.txtTmgReferListTreeViewPermTargetEmp
                            this.query.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                            this.query.txtDYYYYMM = this.referListObject.txtTmgReferListTreeViewRecordDate.slice(0,8)+'01'
                            // this.query.employeeId = this.referListObject.txtTmgReferListTreeViewPermTargetEmp
                        } else {
                            console.log(2)
                            this.getDeptName(this.treeData,targetPermSection,targetPermGroup)
                            this.getEmpName(this.treeData,this.referListObject.txtTmgReferListTreeViewPermTargetEmp)
                            this.referListObject.txtTmgReferListTreeViewPermTargetSection = [[${ session.txtTmgReferListTreeViewPermTargetSection }]]
                            this.referListObject.txtTmgReferListTreeViewPermTargetGroup = [[${ session.txtTmgReferListTreeViewPermTargetGroup }]]
                            this.query.txtTmgReferListTreeViewPermTargetSection = this.referListObject.txtTmgReferListTreeViewPermTargetSection
                            this.query.txtTmgReferListTreeViewPermTargetEmp = this.referListObject.txtTmgReferListTreeViewPermTargetEmp
                            this.query.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                            this.query.txtDYYYYMM = this.referListObject.txtTmgReferListTreeViewRecordDate.slice(0,8)+'01'
                            // this.query.employeeId = this.referListObject.txtTmgReferListTreeViewPermTargetEmp
                            console.log(this.query)
                            console.log(this.query.txtTmgReferListTreeViewPermTargetEmp)
                        }
                    }else{
                        console.log(0)
                        console.log(this.treeData)
                        this.deptName = this.treeData[0].label
                        this.referListObject.txtTmgReferListTreeViewAdminTargetSection = this.treeData[0].secid
                        this.referListObject.txtTmgReferListTreeViewPermTargetGroup = this.treeData[0].groupid
                        this.referListObject.txtTmgReferListTreeViewPermTargetEmp =this.treeData[0].children[0].empid
                        this.getEmpName(this.treeData,this.referListObject.txtTmgReferListTreeViewPermTargetEmp)
                        this.query.txtTmgReferListTreeV
                        iewPermTargetSection = this.referListObject.txtTmgReferListTreeViewPermTargetSection
                        this.query.txtTmgReferListTreeViewPermTargetEmp = this.referListObject.txtTmgReferListTreeViewPermTargetEmp
                        this.query.txtTmgReferListTreeViewRecordDate = this.referListObject.txtTmgReferListTreeViewRecordDate
                        // this.query.employeeId = this.referListObject.txtTmgReferListTreeViewPermTargetEmp
                    }

                    //一覧画面取得
                    this.loginEmployee = this.referListObject.txtTmgReferListTreeViewPermTargetEmp
                    // this.deptName = e[0].secnic
                    this.query.employeeId = this.referListObject.txtTmgReferListTreeViewPermTargetEmp
                    // this.kanjiName = e[0].empname
                    this.selectDisabled = true
                    this.remarksDisabled = true
                    this.ledgerParamVO.hidEmpId = this.referListObject.txtTmgReferListTreeViewPermTargetEmp
                    // this.query.txtTmgReferListTreeViewPermTargetSection = e[0].secid
                    // this.query.txtTmgReferListTreeViewPermTargetGroup = e[0].groupid
                    // this.query.txtTmgReferListTreeViewPermTargetEmp = e[0].empid
                    await this.getData(true)
                },
                getEmpCode(data,empId,sectionId,groupId) {
                    console.log("getEmpCode(data,empId,sectionId,groupId")
                    console.log(data)
                    console.log(empId)
                    console.log(sectionId)
                    let dept =false
                    if(this.selectedDeptViewType==='all'){
                        data.forEach(e => {
                            if ((e.secid === sectionId || e.groupid === groupId) && e.empid === empId) {
                                dept=true
                            }
                        })
                        if(!dept){
                            data.forEach(e => {
                                if (e.secid === sectionId || e.groupid === groupId) {
                                    this.referListObject.txtTmgReferListTreeViewPermTargetEmp=e.empid
                                    return dept
                                }
                            })
                        }
                    }else{
                    data.forEach(e => {
                        if (e.secid === sectionId || e.groupid === groupId) {
                            e.children.forEach(j => {
                                if (j.empid === empId) {
                                    console.log(j)
                                    dept=true
                                }
                            })
                            if(!dept){
                                console.log(e.children[0].empid)
                                this.referListObject.txtTmgReferListTreeViewPermTargetEmp=e.children[0].empid
                            }
                        }
                    })
                  }
                  return dept
                },
                getDeptName(data,section,group) {
                    // idによりループ処理でdeptNameを取得する
                    data.forEach(e => {
                        if (e.secid === section || e.groupid === group) {
                            if(this.selectedDeptViewType==='all'){
                                this.deptName = e.secnic
                            }else{
                                this.deptName = e.label
                            }
                        }
                    })
                },
                getEmpName(data,empId) {
                    // idによりループ処理でdeptNameを取得する
                    if(this.selectedDeptViewType==='all'){
                        data.forEach(e => {
                            if (e.empid === empId) {
                                this.kanjiName = e.empname
                            }
                        })
                    }else{
                    data.forEach(e => {
                        e.children.forEach(j => {
                            if (j.empid === empId) {
                                this.kanjiName = j.empname
                            }
                        })
                     })
                    }
                },
            }
        })
    </script>
</body>

</html>