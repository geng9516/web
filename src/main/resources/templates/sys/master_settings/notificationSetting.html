<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='休暇・休憩マスター設定',cssPaths='/pages/content.min.css')">
</head>


<body th:with="baseUrl = ${#httpServletRequest.getScheme() + '://' + #httpServletRequest.getServerName() + ':' + #request.getServerPort()  + #request.getContextPath()},
      now = ${new java.util.Date().getTime()
    }">
<script th:src="${baseUrl + '/static/libs/dTree.js?t='+ now}">
</script>
<style>
    .drag-tree-table {
        margin: 0;
    }
    .tree-column {
        font-size: 14px;
        padding: 2px 10px;
        overflow: visible;
        background: var(--table-body-bg);
    }
    .tree-row {
        line-height: unset;
    }
    .drag-tree-table-header {
        height: auto;
        line-height: unset;
        color: var(--white);
    }
    .drag-tree-table-header  .tree-column{
        background-color: var(--table-head);
    }
    .tree-row:hover .tree-column {
        background-color: var(--table-td-hover-bg);
        color: var(--table-tr-hover);
    }
</style>
<div th:replace="layout/loadingBar::loadingBar"></div>
<!-- 菜单导航栏 -->
<div th:replace="layout/sider"></div>
<main class="content ntfsettings-warp" ref="layout">
    <div class="content_head">
        <div class="header">
            <div class="title1">
                <h1>
                    <Icon type="i-emeer colored"></Icon>
                    {{ `休暇・休憩マスター設定` }}
                </h1>
            </div>
            <div class="btnbox">
                <span style="flex:1"></span>
                <i-button type="primary" icon="md-book" @click="groupManager('GROUP')" >親区分管理</i-button>
                <i-button type="primary" icon="ios-book" @click="groupManager('TYPEGROUP')" >申請種類管理</i-button>
                <i-button type="primary" icon="ios-add-circle" @click="editDisp()" >新規</i-button>
                <i-button type="primary" icon="md-create" @click="" :disabled="groupSortList.length === 0">ソード更新</i-button>
            </div>
        </div>
        <div class="searchwrap">
            <div class="label">親区分</div><!--NTFGROUP-->
            <i-select v-model="ntfGroupType" editable filterable style="width: 15%;" @on-change="handleGroup($event)">
                <i-option v-for="(item, i) of groupList" :key="i" :value="item.id">{{ item.name }}</i-option>
            </i-select>
        </div>
    </div>

    <div class="content_body">
        <div>
            <div class="tr mb10">
                <div class="tr mt10">
                    <Alert v-show="hasTypeChange" class="error-info tl">設定した内容を反映する場合、再度ログインする必要があります</Alert>
                    <div class="table-top">
                        <Row :gutter="16">
                            <i-col span="24" class="tr">
                                <span class="mr10">ドラッグ機能:  </span><i-switch v-model="isTypeDraggable" size="large">
                                <span slot="open">ON</span>
                                <span slot="close">OFF</span>
                            </i-switch>
                            </i-col>
                        </Row>
                    </div>
                </div>
                <Radio-group v-model="tableColumnsChecked" @on-change="changeTableColumns" class="tr" type="button">
                    <Radio label="basic">基本設定</Radio>
                    <Radio label="dispType">表示タイプ設定</Radio>
                    <Radio label="workType">職種設定</Radio>
                    <Radio label="others">その他設定</Radio>
                </Radio-group>

            </div>
            <dtree :class="tableHeadFixed ? 'table-head-fixed' : ''"
                   :data="dTypeTreeData"
                   @drag="sortTypeTableByDrag(arguments)" border
                   :isdraggable="isTypeDraggable" ref="typeTable"
                    v-show="!managerFlg">
                <template #selection="{row}">
                    <Tooltip placement="bottom" class="width100" transfer>
                        <span style="white-space: normal;" slot="content">{{row.ntfType}}</span>
                        <span class="ivu-table-cell-tooltip-content">{{row.ntfType}}</span>
                    </Tooltip>
                </template>
                <template #start="{row}">
                      <span>
                        {{row.startDate}}
                      </span>
                </template>
                <template #end="{row}">
                      <span>
                        {{row.endDate}}
                      </span>
                </template>
                <!--                <template #group="{row}">-->
                <!--                      <span class="ml5 mr10 mt5 mb5 pt2 pb2 pl10 pr10 row-label-primary">-->
                <!--                        {{row.start}}-->
                <!--                      </span>-->
                <!--                </template>-->
                <template #site="{row}">
                      <span>
                        {{row.site}}
                      </span>
                </template>
                <template #timetype="{row}">
                    <Tooltip placement="bottom" class="width100" transfer>
                        <span style="white-space: normal;" slot="content">{{row.timeType}}</span>
                        <span class="ivu-table-cell-tooltip-content">{{row.timeType}}</span>
                    </Tooltip>
                </template>
                <template #typegroup="{row}">
                    <Tooltip placement="bottom" class="width100" transfer>
                        <span style="white-space: normal;" slot="content">{{row.typeGroup}}</span>
                        <span class="ivu-table-cell-tooltip-content">{{row.typeGroup}}</span>
                    </Tooltip>
                </template>
                <template #btn="{row}">
                    <span style="display: inline-block;">
                        <i-button type="primary" icon="md-create" ghost size="small" @click="editDisp(row,'update')">編集</i-button>
                        <i-button type="success" icon="md-add" ghost size="small" @click="editDisp(row)">コピーした新規</i-button>
                    </span>
                </template>





                <template #transfer="{row}">
                      <span >
                        {{dispTypeText(row.dispType.transfer)}}
                      </span>
                </template>
                <template #timezone="{row}">
                      <span >
                        {{dispTypeText(row.dispType.timeZone)}}
                      </span>
                </template>
                <template #worktime="{row}">
                      <span >
                        {{dispTypeText(row.dispType.workTime)}}
                      </span>
                </template>
                <template #sickname="{row}">
                      <span >
                        {{dispTypeText(row.dispType.sickName)}}
                      </span>
                </template>
                <template #sickapply="{row}">
                      <span >
                        {{dispTypeText(row.dispType.sickApply)}}
                      </span>
                </template>
                <template #period="{row}">
                      <span >
                        {{dispTypeText(row.dispType.period)}}
                      </span>
                </template>
                <template #adddate="{row}">
                      <span >
                        {{dispTypeText(row.dispType.addDate)}}
                      </span>
                </template>
                <template #label="{row}">
                      <span >
                        {{dispTypeText(row.dispType.label)}}
                      </span>
                </template>
                <template #resttime="{row}">
                      <span >
                        {{dispTypeText(row.dispType.restTime)}}
                      </span>
                </template>
                <template #name="{row}">
                      <span >
                        {{dispTypeText(row.dispType.name)}}
                      </span>
                </template>
                <template #relation="{row}">
                      <span >
                        {{dispTypeText(row.dispType.relation)}}
                      </span>
                </template>
                <template #birthday="{row}">
                      <span >
                        {{dispTypeText(row.dispType.birthday)}}
                      </span>
                </template>
                <template #daysofweek="{row}">
                      <span >
                        {{dispTypeText(row.dispType.daysOfWeek)}}
                      </span>
                </template>
                <template #targetnumber="{row}">
                      <span >
                        {{dispTypeText(row.dispType.targetNumber)}}
                      </span>
                </template>


                <template #worktype="{row}">
                    <Poptip placement="right" transfer>
                        <div class="api" slot="content">
                            <p class="ml5 mr5" v-for="(item,i) of row.workTypeInfo" >{{item.workType}}</p>
                        </div>
                        <i-button  size="small" >全て表示</i-button>
                    </Poptip>
                </template>
                <template #limit="{row}">
                      <span >
<!--                        todo-->
                      </span>
                </template>
                <template #limittype1="{row}">
                      <span >
<!--                        todo-->
                      </span>
                </template>
                <template #limitnum="{row}">
                      <span >
<!--                        todo-->
                      </span>
                </template>
                <template #limitrange="{row}">
                      <span >
<!--                        todo-->
                      </span>
                </template>
                <template #limittype2="{row}">
                      <span >
<!--                        todo-->
                      </span>
                </template>


                <template #type="{row}">
                      <span >
                           {{typeSection[row.typeN]}}
                      </span>
                </template>
                <template #level="{row}">
                      <span >
                        {{row.appLevel.replace('TMG_APPROVAL_LEVEL|','')}}
                      </span>
                </template>
                <template #necessaryfile="{row}">
                      <span >
                        {{row.necessaryFile === 1 ? '○'　: '×'}}
                      </span>
                </template>
                <template #necessarycomment="{row}">
                      <span >
                        {{row.necessaryComment === 1 ? '○'　: '×'}}
                      </span>
                </template>
                <template #comment="{row}">
                    <Tooltip placement="bottom" class="width100" transfer>
                        <span style="white-space: normal;" slot="content">{{row.commentD}}</span>
                        <span class="ivu-table-cell-tooltip-content">{{row.commentD}}</span>
                    </Tooltip>
                </template>
                <template #timerange="{row}">
                      <span >
                        {{timeRangeSection[row.timeRangeId]}}
                      </span>
                </template>
                <template #imart="{row}">
                      <span >
                        {{imartSection[row.imart]}}
                      </span>
                </template>
            </dtree>
        </div>
    </div>

    <Modal title="新規" :styles="{top: '0px'}" fullscreen :mask-closable="false" footer-hide v-model="editFlag">
        <div class="table-top">

        </div>

        <div style="position: relative;">
            <template>
                <Row style="background:#eee;padding:20px" :gutter="8">
                    <i-col span="6">
                        <Card style="height: 800px;overflow:auto">
                            <div class="titlenorm mb10 mt10" style="font-size:15px">
                                <Icon type="logo-buffer"></Icon>
                                基本設定
                            </div>
                            <section class="tl mt5">
                                <p class="mb5">開始日<span style="color:var(--red)"  class="mb5">【必須】</span></p>
                                <date-picker v-model="editData.begin" type="date" class="datepicker-single mb5" placeholder="日付"
                                             format="yyyy/MM/dd"  ></date-picker>
                            </section>
                            <section class="tl mt5">
                                <p class="mb5">終了日<span style="color:var(--red)"  class="mb5">【必須】</span></p>
                                <date-picker v-model="editData.end" type="date" class="datepicker-single mb5" placeholder="日付"
                                             format="yyyy/MM/dd" ></date-picker>
                            </section>

                            <section class="tl mt5">
                                <p class="mb5">申請名<span style="color:var(--red)"  class="mb5">【必須】</span> <Icon type="md-checkmark" color="var(--green)" v-if="editData.checkntfTypeName === true" size = "18"></Icon><Icon type="md-close" color="var(--red)" v-if="editData.checkntfTypeName === false" size = "18"></Icon></p>
                                <i-input class="tl" v-model="editData.ntfTypeName" @on-blur="checkNtfName()"></i-input>
                            </section>

                            <section class="tl mt5">
                                <p class="mb5">親区分<span style="color:var(--red)"  class="mb5">【必須】</span></p>
                                <i-select v-model="editData.groupId" editable filterable clearable
                                          class="mb10 no-border-radius">
                                    <!--                                    <i-option v-for="" :value="" :key="i" :label=""></i-option>-->
                                    <i-option v-for="(item, i) of groupList" :key="i" :value="item.id">{{ item.name }}</i-option>
                                </i-select>
                            </section>
                            <section class="tl mt5">
                                <p class="mb5">可能サイト<span style="color:var(--red)"  class="mb5">【必須】</span></p>
                                <Tag v-for="item in editData.site" :key="item.siteId" :name="item.name" closable @on-close="delSite(item)">{{ item.name }}</Tag>
                                <Poptip v-model="sitevisible" placement="right" transfer>
                                    <div class="api" slot="content">
                                        <a class="ml5 mr5" v-for="(item,i) of leftSite" @click="addSite(item)">{{item.name}}</a>
                                    </div>
                                    <i-button icon="ios-add" type="dashed" size="small" v-show="editData.site.length < 3">add</i-button>
                                </Poptip>

                            </section>

                            <section class="tl mt5">
                                <p class="mb5">申請種類</p>
                                <i-select v-model="editData.typeGroup"  editable filterable clearable
                                          class="mb10 no-border-radius">
                                    <!--                                    <i-option v-for="" :value="" :key="i" :label=""></i-option>-->
                                    <i-option v-for="(item, i) of typeGroupList" :key="i" :value="item.typeGroupId">{{ item.typeGroupName }}</i-option>
                                </i-select>
                            </section>

                            <section class="tl mt20">
                                <p class="mb5">種類<span style="color:var(--red)"  class="mb5">【必須】</span></p>
                                <i-select v-model="editData.typeN"  editable filterable clearable
                                          class="mb10 no-border-radius">
                                    <!--                                    <i-option v-for="" :value="" :key="i" :label=""></i-option>-->
                                    <i-option value="1">終日</i-option>
                                    <i-option value="2">休憩45分</i-option>
                                    <i-option value="3">半休</i-option>
                                    <i-option value="4">相対</i-option>
                                    <i-option value="5">絶対</i-option>
                                    <i-option value="6">出張</i-option>
                                    <i-option value="7">勤務時間指定</i-option>
                                    <i-option value="8">予定シフト</i-option>
                                    <i-option value="9">振替</i-option>
                                    <i-option value="10">半日振替</i-option>
                                </i-select>
                            </section>
                            <section class="tl mt5">
                                <p class="mb5">決裁レベル<span style="color:var(--red)"  class="mb5">【必須】</span></p>
                                <i-select v-model="editData.appLevel"  editable filterable clearable
                                          class="mb10 no-border-radius">
                                    <i-option value="TMG_APPROVAL_LEVEL|1">レベル1</i-option>
                                    <i-option value="TMG_APPROVAL_LEVEL|2">レベル2</i-option>
                                    <i-option value="TMG_APPROVAL_LEVEL|3">レベル3</i-option>
                                    <i-option value="TMG_APPROVAL_LEVEL|4">レベル4</i-option>
                                    <i-option value="TMG_APPROVAL_LEVEL|5">レベル5</i-option>
                                </i-select>
                            </section>

                            <section class="tl mt5">
                                <p class="mb5">説明文</p>
                                <i-input class="tl" v-model="editData.commentD" type="textarea">
                                </i-input>
                            </section>


                        </Card>
                    </i-col>
                    <i-col span="6">
                        <Card style="height: 800px;overflow:auto">
                            <div class="titlenorm mb10 mt10" style="font-size:15px">
                                <Icon type="logo-buffer"></Icon>
                                表示タイプ設定
                            </div>
                            <section class="tl mt5">
                                <checkbox v-model="editData.transfer"></checkbox><h class="mb5 ml10">振替先・元</h>
                                <br></br>
                                <checkbox v-model="editData.timeZone"></checkbox><h class="mb5 ml10">時間帯</h>
                                <br></br>
                                <checkbox v-model="editData.workTime"></checkbox><h class="mb5 ml10">始業・終業</h>
                                <br></br>
                                <checkbox v-model="editData.sickName"></checkbox><h class="mb5 ml10">傷病名</h>
                                <br></br>
                                <checkbox v-model="editData.sickApply"></checkbox><h class="mb5 ml10">労災申請</h>
                                <br></br>
                                <checkbox v-model="editData.period"></checkbox><h class="mb5 ml10">起算日</h>
                                <br></br>
                                <checkbox v-model="editData.addDate"></checkbox><h class="mb5 ml10">加算日数</h>
                                <br></br>
                                <checkbox v-model="editData.label"></checkbox><h class="mb5 ml10">勤務時間ラベル</h>
                                <br></br>
                                <checkbox v-model="editData.restTime"></checkbox><h class="mb5 ml10">休憩時間</h>
                                <br></br>
                                <checkbox v-model="editData.name"></checkbox><h class="mb5 ml10">氏名</h>
                                <br></br>
                                <checkbox v-model="editData.relation"></checkbox><h class="mb5 ml10">続柄</h>
                                <br></br>
                                <checkbox v-model="editData.birthday"></checkbox><h class="mb5 ml10">生年月日</h>
                                <br></br>
                                <checkbox v-model="editData.daysOfWeek"></checkbox><h class="mb5 ml10">曜日</h>
                                <br></br>
                                <checkbox v-model="editData.targetNumber"></checkbox><h class="mb5 ml10">対象人数</h>
                            </section>
                            <section class="tl mt20">
                                <p class="mb5">反映先<span style="color:var(--red)"  class="mb5">【必須】</span></p>
                                <i-select v-model="editData.timeTypeId" editable filterable clearable
                                          class="mb10 no-border-radius" v-if="editData.timeZone">
                                    <i-option v-for="(item, i) of hourtimeTypeList" :key="i" :value="item.TIMETYPEID">{{ item.TIMETYPE }}</i-option>
                                </i-select>
                                <i-select v-model="editData.timeTypeId" editable filterable clearable
                                          class="mb10 no-border-radius" v-if="!editData.timeZone">
                                    <i-option v-for="(item, i) of daytimeTypeList" :key="i" :value="item.TIMETYPEID">{{ item.TIMETYPE }}</i-option>
                                </i-select>
                            </section>
                        </Card>
                    </i-col>
                    <i-col span="6">
                        <Card style="height: 800px;overflow:auto">
                            <div class="titlenorm mb10 mt10" style="font-size:15px">
                                <Icon type="logo-buffer"></Icon>
                                適用職種とその他設定
                            </div>
                            <section class="tl mt20">
                                <p class="mb5">職種 <span style="color:var(--red)"  class="mb5">【必須】</span></p>
                                <Tag v-for="item in editData.workType" :key="item.WORKTYPEID" :name="item.WORKTYPE" closable @on-close="delWorktype(item)">{{ item.WORKTYPE }}</Tag>
                                <Poptip v-model="worktypevisible" word-wrap width="200" placement="right" transfer>
                                    <div slot="content">
                                        <i-button class="mt5" v-for="(item,i) of leftworktype" @click="addWorktype(item)">{{item.WORKTYPE}}</i-button>
                                    </div>
                                    <i-button icon="ios-add" type="dashed" size="small" v-show="totalworktype.length > leftworktype.length">add</i-button>
                                </Poptip>
                            </section>
                            <section class="tl mt20">
                                <p class="mb5">上限値</p>
                                <i-input class="mb15　tl" v-model="editData.limit" >
                                    <i-select v-model="editData.limitType1" slot="append" style="width: 50px">
                                        <i-option value="day">日</i-option>
                                        <i-option value="min">分</i-option>
                                    </i-select>
                                </i-input>
                            </section>
                            <section class="tl mt20">
                                <p class="mb5">回数</p>
                                <i-input :max="99" :min="1" class="mb15　tl" v-model="editData.limitNum" >
                                    <i-select v-model="editData.limitType2" slot="append" style="width: 50px">
                                        <i-option value="dayCounts">回/日</i-option>
                                    </i-select>
                                </i-input>
                            </section>
                            <section class="tl mt20">
                                <p class="mb5">期間</p>
                                <i-input :max="99" :min="1" class="mb15　tl" v-model="editData.limitRange">
                                    <i-select v-model="editData.limitType2" slot="append" style="width: 50px">
                                        <i-option value="day">日</i-option>
                                        <i-option value="week">週</i-option>
                                    </i-select>
                                </i-input>
                            </section>
                            <section class="tl mt20">
                                <p class="mb5">申請期間区分<span style="color:var(--red)"  class="mb5">【必須】</span></p>
                                <i-select v-model="editData.timeRangeId"  editable filterable clearable
                                          class="mb10 no-border-radius">
                                    <!--                                    <i-option v-for="" :value="" :key="i" :label=""></i-option>-->
                                    <i-option value="0">勤怠シートが存在する</i-option>
                                    <i-option value="1">カレンダーが存在する</i-option>
                                </i-select>
                            </section>
                            <section class="tl mt20">
                                <p class="mb5">IMARTスケジュール連携対象有無</p>
                                <i-select v-model="editData.imart"  editable filterable clearable
                                          class="mb10 no-border-radius">
                                    <!--                                    <i-option v-for="" :value="" :key="i" :label=""></i-option>-->
                                    <i-option value="0">連携しない</i-option>
                                    <i-option value="1">連携する</i-option>
                                    <i-option value="2">振替先を連携する</i-option>
                                </i-select>
                            </section>
                            <section class="tl mt20">
                                <checkbox v-model="editData.necessaryFile"></checkbox><h class="mb5 ml10">ファイル必須</h>
                                <br></br>
                                <checkbox v-model="editData.necessaryComment"></checkbox><h class="mb5 ml10">事由必須</h>
                            </section>
                        </Card>
                    </i-col>
                    <i-col span="6" >
                        <Card style="height: 800px;overflow:auto">
                            <div class="titlenorm mb10 mt10" style="font-size:15px">
                                <Icon type="logo-buffer"></Icon>
                                CHECK設定
                            </div>
                            <span>
                                <Card class="mb5" v-for="item of editData.checkFunc" style="background: var(--content-bg);">
                                    <div class="tr card-del-btn cursor" @click.stop="remove(item)">✗</div>
                                    <div class="no-border-radius mb2" style="display: flex; align-items: stretch;">
                                      <span style="display: inline-block;width: 55px;color: var(--text-light-grey);">名称: </span>
                                      <span class="tl width100"> {{ item.checkname }}</span>
                                    </div>
                                    <div class="no-border-radius mb2" style="display: flex; align-items: stretch;">
                                      <span style="display: inline-block;width: 150px;color: var(--text-light-grey)">申請種類: </span><i-input v-model="item.checkType"></i-input>
                                    </div>
                                    <div class="no-border-radius mb2" style="display: flex; align-items: stretch;">
                                      <span style="display: inline-block;width: 150px;color: var(--text-light-grey)">取得上限値: </span><i-input v-model="item.checkLimit"></i-input>
                                    </div>
                                    <div class="no-border-radius mb2" style="display: flex; align-items: stretch;">
                                      <span style="display: inline-block;width: 150px;color: var(--text-light-grey)">取得単位: </span><i-input v-model="item.checkLimitType"></i-input>
                                    </div>
                                </Card>
                            </span>
                            <i-button icon="ios-add" size="large" style="width:100%;" @click=""></i-button>
                        </Card>
                    </i-col>
                </Row>
            </template>

            <Spin size="large" fix v-if="EditLoading"></Spin>
        </div>
    </Modal>

    <Modal :title=" typeId==='TYPEGROUP'? '申請種類管理':'親区分管理'" :width="typeId==='TYPEGROUP'? '80':'40'" v-model="managerFlg" footer-hide :mask-closable="false">

        <div style="position: relative;">
            <div v-if="typeId ==='GROUP'">
                <div class="table-top">
                    <div class="btnbox tr">
                        <span style="flex:1"></span>

                        <i-button type="primary" icon="md-create" @click="groupEdit = !groupEdit" >{{ groupEdit ?  '取消' : '編集'}}</i-button>
                        <i-button type="success" icon="md-create" @click="" >新規</i-button>
                        <i-button type="primary" icon="md-create" @click="" :disabled="typeSortList.length === 0">ソード更新</i-button>
                    </div>
                    <div class="tr mt10">
                        <Alert v-show="hasGroupChange" class="error-info tl">設定した内容を反映する場合、再度ログインする必要があります</Alert>
                        <div class="table-top">
                            <Row :gutter="16">
                                <i-col span="24" class="tr">
                                    <span class="mr10">ドラッグ機能:  </span><i-switch v-model="isGroupDraggable" size="large">
                                    <span slot="open">ON</span>
                                    <span slot="close">OFF</span>
                                </i-switch>
                                </i-col>
                            </Row>
                        </div>
                    </div>

                </div>

                <dtree :class="tableHeadFixed ? 'table-head-fixed' : ''"
                       :data="dGroupTreeData"
                       @drag="sortGroupTableByDrag(arguments)" border
                       :isdraggable="isGroupDraggable" ref="groupTable">
                    <template #selection="{row}">
                        <span v-if="!groupEdit">
                            {{row.name}}
                        </span>
                        <i-input v-if="groupEdit" v-model="row.name" width="80"></i-input>
                    </template>
                </dtree>
            </div>
            <div v-else-if="typeId ==='TYPEGROUP'">
                <div class="table-top">
                    <div class="btnbox tr">
                        <span style="flex:1"></span>
                        <i-button type="primary" icon="md-create" @click="typeGroupEditbtn()">{{ typeGroupEdit ?  '取消' : '編集'}}</i-button>
                        <i-button type="success" icon="md-create" @click="" >新規</i-button>
                        <i-button type="primary" icon="md-create" @click="":disabled="!typeGroupEdit">登録</i-button>
                    </div>
                </div>
                <i-table class="mt10" border :columns="typeGroupColumns" :data="typeGroupTableData"  show-header>
                    <template slot-scope="{ index , row }" slot="typeGroupName">
                        <Tooltip placement="bottom" class="width100" transfer>
                            <span style="white-space: normal;" slot="content">{{row.typeGroupName}}</span>
                            <span class="ivu-table-cell-tooltip-content">{{row.typeGroupName}}</span>
                        </Tooltip>
                    </template>
                    <template slot-scope="{ index , row }" slot="avgSection">
                        <Tooltip placement="bottom" class="width100" transfer v-show="!typeGroupEdit">
                            <span style="white-space: normal;" slot="content">{{avgSection[row.avgSection]}}</span>
                            <span class="ivu-table-cell-tooltip-content">{{avgSection[row.avgSection]}}</span>
                        </Tooltip>
                        <i-select v-model="typeGroupTableData[index].avgSection" slot="append" v-show="typeGroupEdit">
                            <i-option value="0">平均勤務時間どおり</i-option>
                            <i-option value="1">平均勤務時間を1時間単位で切り捨て</i-option>
                            <i-option value="2">平均勤務時間を1時間単位で切り上げ</i-option>
                        </i-select>
                    </template>
                    <template slot-scope="{ index , row }" slot="digestionSection">
                        <Tooltip placement="bottom" class="width100" transfer v-show="!typeGroupEdit">
                            <span style="white-space: normal;" slot="content">{{digestionSection[row.digestionSection]}}</span>
                            <span class="ivu-table-cell-tooltip-content">{{digestionSection[row.digestionSection]}}</span>
                        </Tooltip>
                        <i-select v-model="typeGroupTableData[index].digestionSection" slot="append" v-show="typeGroupEdit">
                            <i-option value="0">申請時間どおり消化(1日の平均勤務時間超も可)</i-option>
                            <i-option value="1">申請時間どおり消化(1日の平均勤務時間超は不可)</i-option>
                            <i-option value="2">申請時間を1時間単位で切り上げて消化(1日の平均勤務時間超も可)</i-option>
                            <i-option value="3">申請時間を1時間単位で切り上げて消化(1日の平均勤務時間超は不可)</i-option>
                            <i-option value="4">申請時間を1時間単位で切り上げて消化(1日の平均勤務時間超は不可)</i-option>
                        </i-select>
                    </template>
                    <template slot-scope="{ index , row }" slot="workDay">
                        <Tooltip placement="bottom" class="width100" transfer v-show="!typeGroupEdit">
                            <span style="white-space: normal;" slot="content">{{workDay[row.workDay]}}</span>
                            <span class="ivu-table-cell-tooltip-content">{{workDay[row.workDay]}}</span>
                        </Tooltip>
                        <i-select v-model="typeGroupTableData[index].workDay" slot="append" v-show="typeGroupEdit">
                            <i-option value="0">営業日(休日は含まない)</i-option>
                            <i-option value="1">暦日(休日を含む)</i-option>
                        </i-select>
                    </template>
                    <template slot-scope="{ index , row }" slot="contiCheck">
                        <Tooltip placement="bottom" class="width100" transfer v-show="!typeGroupEdit">
                            <span style="white-space: normal;" slot="content">{{contiCheck[row.contiCheck]}}</span>
                            <span class="ivu-table-cell-tooltip-content">{{contiCheck[row.contiCheck]}}</span>
                        </Tooltip>
                        <i-select v-model="typeGroupTableData[index].contiCheck" slot="append" v-show="typeGroupEdit">
                            <i-option value="0">連続チェック不要</i-option>
                            <i-option value="1">連続チェック必要</i-option>
                        </i-select>
                    </template>
                    <template slot-scope="{ index , row }" slot="yearBeginMonth">
                        <Tooltip placement="bottom" class="width100" transfer v-show="!typeGroupEdit">
                            <span style="white-space: normal;" slot="content">{{yearBeginMonth[row.yearBeginMonth]}}</span>
                            <span class="ivu-table-cell-tooltip-content">{{yearBeginMonth[row.yearBeginMonth]}}</span>
                        </Tooltip>
                        <i-select v-model="typeGroupTableData[index].yearBeginMonth" slot="append" v-show="typeGroupEdit">
                            <i-option value="1">1月</i-option>
                            <i-option value="4">4月</i-option>
                        </i-select>
                    </template>
                    <template slot-scope="{ index , row }" slot="startDateRange">


                        <span class="ml5">{{ typeGroupTableData[index].startDateRange }}</span>
                    </template>
                    <template slot-scope="{ index , row }" slot="hasuuSection">
                        <Tooltip placement="bottom" class="width100" transfer v-show="!typeGroupEdit">
                            <span style="white-space: normal;" slot="content">{{hasuuSection[row.hasuuSection]}}</span>
                            <span class="ivu-table-cell-tooltip-content">{{hasuuSection[row.hasuuSection]}}</span>
                        </Tooltip>
                        <i-select v-model="typeGroupTableData[index].hasuuSection" slot="append" v-show="typeGroupEdit">
                            <i-option value="0">端数処理なし(1分未満は切り上げ)</i-option>
                            <i-option value="1">1時間単位で切り捨て</i-option>
                            <i-option value="2">1時間単位で切り上げ</i-option>
                        </i-select>
                    </template>
                </i-table>

            </div>
            <Spin size="large" fix v-if="managerLoading"></Spin>
        </div>
    </Modal>


    <back-top></back-top>
</main>
<div th:replace="layout/head::header"></div>
<script type="text/babel" th:inline="javascript">
    new Vue({
        el: '.ntfsettings-warp',
        data() {
            return {
                groupList:[],
                ntfGroupType:'',
                dTypeTreeData:{
                    columns: [],
                    lists: [],
                    custom_field: {
                        id: 'ntfTypeId'
                    }
                },

                tableColumnsChecked:'basic',
                editFlag:false,

                editData: {
                    begin:'',
                    end:'',
                    groupId:'',
                    typeGroupId:'',
                    site:[],
                    timeTypeId:'',
                    ntfTypeName:'',
                    checkntfTypeName:'',

                    transfer:false,
                    timeZone:false,
                    workTime:false,
                    sickName:false,
                    sickApply:false,
                    period:false,
                    addDate:false,
                    label:false,
                    restTime:false,
                    name:false,
                    relation:false,
                    birthday:false,
                    daysOfWeek:false,
                    targetNumber:false,


                    workType:[],
                    limit:'',
                    limitType1:'day',
                    limitNum:'',
                    limitRange:'',
                    limitType2:'',

                    typeN:'',
                    appLevel:'',
                    necessaryFile:false,
                    necessaryComment:false,
                    commentD:'',
                    timeRangeId:'',
                    imart:'',

                    //选中的check func
                    checkFunc:[],
                },
                //全部可选check func
                totalCheckFunc:[],
                //剩余可选check func
                leftCheckFunc:[],
                //新规
                neweditData:{},
                daytimeTypeList:[],
                hourtimeTypeList:[],
                totalworktype:[],
                leftworktype:[],
                totalSite:[{name:'入力',siteId:'TMG_INP'},{name:'承認',siteId:'TMG_PERM'},{name:'管理',siteId:'TMG_ADMIN'}],
                leftSite:[],
                sitevisible:false,
                worktypevisible:false,
                typeUpdateFlag:false,
                EditLoading:false,

                typeGroupList:[], //新规下拉框

                //親区分管理
                managerFlg:false,
                typeId:'',
                managerLoading:false,

                isGroupDraggable: true,
                isTypeDraggable:true,

                contentScrollTop:0,
                dGroupTreeData: {
                    columns: [
                        {
                            type: 'selection',
                            title: '親区分名称',
                            align: 'left',
                            flex: 1
                        }
                    ],
                    lists: [],
                },
                groupSortList:[],
                typeSortList:[],
                hasGroupChange:false,
                hasTypeChange:false,



                //申請種類
                typeGroupColumns:[
                    {
                        title: '申請種類名',
                        slot: 'typeGroupName',
                        align: 'left',
                        minWidth: 200
                    },
                    {
                        title: '平均勤務時間・' +
                            '\n年休残時間の換算',
                        slot: 'avgSection',
                        align: 'left',
                        minWidth: 220
                    },
                    {
                        title: '消化時間' +
                            '\nの換算区分',
                        slot: 'digestionSection',
                        align: 'left',
                        minWidth: 350
                    },
                    {
                        title: ' 営業日・' +
                            '\n暦日区分',
                        slot: 'workDay',
                        align: 'left',
                        minWidth: 150
                    },
                    {
                        title: '連続チェック有無',
                        slot: 'contiCheck',
                        align: 'left',
                        minWidth: 180
                    },
                    {
                        title: '年度開始月',
                        slot: 'yearBeginMonth',
                        align: 'left',
                        minWidth: 100
                    },
                    {
                        title: '同一とみなす' +
                            '\n起算日の範囲',
                        slot: 'startDateRange',
                        align: 'left',
                        minWidth: 160
                    },
                    {
                        title: '消化時間に端数がある場合の換算区分',
                        slot: 'hasuuSection',
                        align: 'left',
                        minWidth: 140
                    },
                ],
                typeGroupTableData:[],
                typeGroupEdit:false,
                groupEdit:false,
                typeSection:{
                    1 :"終日",
                    2 :"休憩45分",
                    3 :"半休",
                    4 :"相対",
                    5 :"絶対",
                    6 :"出張",
                    7 :"勤務時間指定",
                    8 :"予定シフト",
                    9 :"振替",
                    10:"半日振替"
                },
                avgSection:{
                    0:'平均勤務時間どおり',
                    1:'平均勤務時間を1時間単位で切り捨て',
                    2:'平均勤務時間を1時間単位で切り上げ'
                },
                digestionSection:{
                    0:'申請時間どおり消化(1日の平均勤務時間超も可)',
                    1:'申請時間どおり消化(1日の平均勤務時間超は不可)',
                    2:'申請時間を1時間単位で切り上げて消化(1日の平均勤務時間超も可)',
                    3:'申請時間を1時間単位で切り上げて消化(1日の平均勤務時間超は不可)',
                    4:'申請時間を1時間単位で切り上げて消化(1日の平均勤務時間超は不可)',
                },
                workDay:{
                    0:'営業日(休日は含まない)',
                    1:'暦日(休日を含む)',
                },
                contiCheck:{
                    0:'連続チェック不要',
                    1:'連続チェック必要',
                },
                yearBeginMonth:{
                    1:'1月',
                    4:'4月'
                },
                hasuuSection:{
                    0:'端数処理なし(1分未満は切り上げ)',
                    1:'1時間単位で切り捨て',
                    2:'1時間単位で切り上げ'
                },
                imartSection:{
                    0 :"連携しない",
                    1 :"連携する",
                    2 :"振替先を連携する",
                },
                timeRangeSection:{
                    0:"勤怠シートが存在する",
                    1:"カレンダーが存在する"
                },
            }
        },
        components: {
            dtree: dtree.default
        },
        async created() {
            window.addEventListener('scroll', this.handleScroll, { passive: true })
        },
        beforeDestroy() {
            window.removeEventListener('scroll', this.handleScroll, { passive: true })
        },
        async mounted() {
            await this.getGroupTableData()
            this.changeTableColumns()
            this.handleGroup()
            this.getTypeGroupTableData()
            this.editInit()
        },
        computed: {
            tableHeadFixed() {
                if (this.contentScrollTop > 110) return true
                else return false
            }
        },
        methods: {
            async handleGroup() {
                try {
                    const {data} = await this.http.get('sys/notificationSetting/ntfDisp',{ntfGroup:this.ntfGroupType})
                    //this.dTypeTreeData.columns= this.getTable2Columns()
                    this.dTypeTreeData.lists=data
                    this.dTypeTreeData.lists.forEach((e,i)=>{
                        if(e.siteId.indexOf('TMG_INP')>-1){
                            this.dTypeTreeData.lists[i].site = e.siteId.replace('TMG_INP','入力')
                        }
                        if(this.dTypeTreeData.lists[i].site.indexOf('TMG_PERM')>-1){
                            this.dTypeTreeData.lists[i].site = this.dTypeTreeData.lists[i].site.replace('TMG_PERM','承認')
                        }
                        if(this.dTypeTreeData.lists[i].site.indexOf('TMG_ADMIN')>-1) {
                            this.dTypeTreeData.lists[i].site = this.dTypeTreeData.lists[i].site.replace('TMG_ADMIN', '管理')
                        }
                    })
                } catch (error) {
                } finally {

                }
            },
            dispTypeText(e){
                if(e){
                    return '○'
                }else{
                    return '×'
                }
            },
            getTable2Columns () {
                const table2ColumnList = {
                    ntfType: [{
                        type: 'selection',
                        title: '申請区分',
                        //slot: 'ntfType',
                        align: 'left',
                        flex: 2
                    }],
                    basic: [
                        {
                            type: 'slot',
                            slot: 'start',
                            title: '開始日',
                            flex: 1
                        },
                        {
                            type: 'slot',
                            title: '終了日',
                            slot: 'end',
                            flex: 1
                        },
                        // {
                        //     type: 'slot',
                        //     title: '親区分',
                        //     slot: 'group',
                        //     flex: 1
                        // },
                        {
                            type: 'slot',
                            title: '可能サイト',
                            slot: 'site',
                            flex: 1
                        },
                        {
                            type: 'slot',
                            title: '反映先',
                            align: 'left',
                            slot: 'timetype',
                            flex: 1
                        },
                        {
                            title: '申請種類',
                            slot: 'typegroup',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '操作',
                            slot: 'btn',
                            type: 'slot',
                            flex: 1
                        },
                    ],
                    dispType: [
                        {
                            title: '振替',
                            slot: 'transfer',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '時間帯',
                            slot: 'timezone',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '始終業',
                            slot: 'worktime',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '傷病名',
                            slot: 'sickname',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '労災申請',
                            slot: 'sickapply',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '起算日',
                            slot: 'period',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '加算日数',
                            slot: 'adddate',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: 'ラベル',
                            slot: 'label',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '休憩時間',
                            slot: 'resttime',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '氏名',
                            slot: 'name',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '続柄',
                            slot: 'relation',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '生年月日',
                            slot: 'birthday',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '曜日',
                            slot: 'daysofweek',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '対象人数',
                            slot: 'targetnumber',
                            type: 'slot',
                            flex: 1
                        },
                    ],
                    workType: [
                        {
                            title: '職種',
                            slot: 'worktype',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '上限値',
                            slot: 'limit',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '単位',
                            slot: 'limittype1',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '回数',
                            slot: 'limitnum',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '期間',
                            slot: 'limitrange',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '単位',
                            slot: 'limittype2',
                            type: 'slot',
                            flex: 1
                        },
                    ],
                    others: [
                        {
                            title: '種類',
                            slot: 'type',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '決裁レベル',
                            slot: 'level',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: 'ファイル必須',
                            slot: 'necessaryfile',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '事由必須',
                            slot: 'necessarycomment',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '説明文',
                            slot: 'comment',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: '期間区分',
                            slot: 'timerange',
                            type: 'slot',
                            flex: 1
                        },
                        {
                            title: 'IMART',
                            slot: 'imart',
                            type: 'slot',
                            flex: 1
                        },
                    ],
                }
                let data = table2ColumnList.ntfType;
                table2ColumnList[this.tableColumnsChecked].forEach(e=>{
                    data.push(e)
                })
                return data;
            },
            changeTableColumns () {
                this.dTypeTreeData.columns= this.getTable2Columns()
            },
            async editInit() {
                try {
                    const {data} = await this.http.get('sys/notificationSetting/editDisp')
                    this.hourtimeTypeList = data.hourTimeType
                    this.daytimeTypeList = data.dayTimeType
                    this.totalworktype = data.totalWorkType
                    this.leftworktype = this.totalworktype
                } catch (error) {
                } finally {

                }
            },
            async editDisp(e, update) {
                console.log(e)
                //编辑 或copy新规时
                if (e) {
                    this.editData.begin = e.startDate
                    this.editData.end = e.endDate
                    this.editData.groupId = e.ntfGroupId
                    this.editData.typeGroupId = e.typeGroupId
                    //site处理
                    this.leftSite = []
                    this.editData.site = []
                    this.totalSite.forEach(j => {
                        if (e.siteId.indexOf(j.siteId) > -1) {
                            this.editData.site.push(j)
                        } else {
                            this.leftSite.push(j)
                        }
                    })

                    this.editData.timeTypeId = e.timeTypeId
                    this.editData.ntfTypeName = ''
                    this.editData.checkntfTypeName = ''

                    this.editData.transfer = e.dispType.transfer
                    this.editData.timeZone = e.dispType.timeZone
                    this.editData.workTime = e.dispType.workTime
                    this.editData.sickName = e.dispType.sickName
                    this.editData.sickApply = e.dispType.sickApply
                    this.editData.period = e.dispType.period
                    this.editData.addDate = e.dispType.addDate
                    this.editData.label = e.dispType.label
                    this.editData.restTime = e.dispType.restTime
                    this.editData.name = e.dispType.name
                    this.editData.relation = e.dispType.relation
                    this.editData.birthday = e.dispType.birthday
                    this.editData.daysOfWeek = e.dispType.daysOfWeek
                    this.editData.targetNumber = e.dispType.targetNumber

                    //workType处理
                    // this.editData.workType=e.
                    this.leftworktype = []
                    this.editData.workType = []
                    console.log(this.totalworktype)
                    this.totalworktype.forEach(k => {
                        let include = false
                        e.workTypeInfo.forEach(l => {
                            if (l.workTypeId === k.WORKTYPEID) {
                                include = true
                            }
                        })
                        if (include) {
                            this.editData.workType.push(k)
                        } else {
                            this.leftworktype.push(k)
                        }
                    })

                    // this.editData.limit=e.
                    // this.editData.limitType1=e.
                    // this.editData.limitNum=e.
                    // this.editData.limitRange=e.
                    // this.editData.limitType2=e.

                    this.editData.typeN = e.typeN
                    this.editData.appLevel = e.appLevel
                    this.editData.necessaryFile = e.necessaryFile === '1' ? true : false
                    this.editData.necessaryComment = e.necessaryComment === '1' ? true : false
                    this.editData.commentD = e.commentD
                    this.editData.timeRangeId = e.timeRangeId
                    this.editData.imart = e.imart


                    //查询checkFunc
                    this.editData.checkFunc=[]
                    try {
                        const {data} = await this.http.get('sys/notificationSetting/checkFunc',{ntfType:e.ntfTypeId})
                        console.log(data)

                        data.forEach(n=>{
                            let func={}
                            func.checkname=n.tncCcomment
                            func.checkFunc=n.tncCfuncname
                            func.checkType=n.tncCfuncid
                            func.checkLimit=n.tncClimit
                            func.checkLimitType= n.tncClimitunit
                            this.editData.checkFunc.push(func)
                        })


                    } catch (error) {
                    } finally {

                    }

                }
                //编辑
                if (update) {
                    this.typeUpdateFlag = true
                }
                //新规时初始化
                if (!e && !update) {
                    this.leftSite = this.totalSite
                    this.editData = {
                        begin: '',
                        end: '',
                        groupId: '',
                        typeGroupId: '',
                        site: [],
                        timeTypeId: '',
                        ntfTypeName: '',
                        checkntfTypeName: '',

                        transfer: false,
                        timeZone: false,
                        workTime: false,
                        sickName: false,
                        sickApply: false,
                        period: false,
                        addDate: false,
                        label: false,
                        restTime: false,
                        name: false,
                        relation: false,
                        birthday: false,
                        daysOfWeek: false,
                        targetNumber: false,


                        workType: [],
                        limit: '',
                        limitType1: 'day',
                        limitNum: '',
                        limitRange: '',
                        limitType2: '',

                        typeN: '',
                        appLevel: '',
                        necessaryFile: false,
                        necessaryComment: false,
                        commentD: '',
                        timeRangeId: '',
                        imart: '',

                        //选中的check func
                        checkFunc: [],
                    }
                }
                this.editFlag = true

            },
            delSite(e){
                this.leftSite.push(e)
                this.editData.site.find((j,i)=>{
                    if(e===j){
                        this.editData.site.splice(i,1)
                    }
                })
            },
            addSite(e){
                this.editData.site.push(e)
                this.leftSite.find((j,i)=>{
                    if(e===j){
                        this.leftSite.splice(i,1)
                    }
                })
                this.sitevisible=false
            },
            delWorktype(e){
                this.leftworktype.push(e)
                this.editData.workType.find((j,i)=>{
                    if(e===j){
                        this.editData.workType.splice(i,1)
                    }
                })
            },
            addWorktype(e){
                this.editData.workType.push(e)
                this.leftworktype.find((j,i)=>{
                    if(e===j){
                        this.leftworktype.splice(i,1)
                    }
                })
                this.worktypevisible=false
            },
            remove(item) {
                this.$Modal.confirm({
                    title: '注意',
                    content: '削除します。よろしいですか？',
                    okText: 'OK',
                    cancelText: 'キャンセル',
                    onOk: async () => {
                        try {
                        } catch (error) {
                        } finally {
                        }
                    }
                })
            },


            groupManager(e){
                this.managerFlg=true;
                if(e==='GROUP'){
                    this.typeId='GROUP'
                    // this.getGroupTableData()
                }else{
                    this.typeId='TYPEGROUP'
                    this.getTypeGroupTableData()
                }
            },

            handleScroll: Throttle(function (e) {
                this.contentScrollTop = e.target.documentElement.scrollTop || e.target.body.scrollTop
            }, 50),
            //拖动
            sortGroupTableByDrag(e) {
                console.log(111)
                console.log(e)
                if (e[3] === 'center' || !e[2]) return
                this.dGroupTreeData.lists = e[0]
                this.groupSortList = this.groupSortList.concat({id:e[1].id})
            },
            sortTypeTableByDrag(e){
                console.log(222)
                console.log(e)
                if (e[3] === 'center' || !e[2]) return
                this.dTypeTreeData.lists = e[0]
                this.typeSortList = this.typeSortList.concat({id:e[1].ntfTypeId})
            },
            typeGroupEditbtn(){
                this.managerLoading=true
                this.typeGroupEdit=!this.typeGroupEdit
                setTimeout(() =>{
                    this.managerLoading=false
                },1000);
            },
            //check 新规申请名
            async checkNtfName() {
                if (!this.editData.ntfTypeName) return
                try {
                    const {data} = await this.http.get('sys/notificationSetting/checkNtfName', {ntfName:this.editData.ntfTypeName})
                    if (data > 0){
                        this.editData.checkntfTypeName=false
                    }else{
                        this.editData.checkntfTypeName=true
                    }

                } catch (error) {
                } finally {

                }

            },
            //获取所有group 数据
            async getGroupTableData(){
                this.managerLoading = true
                try {
                    const { data } = await this.http.get('sys/notificationSetting/groupManager')

                    this.groupList = data
                    this.ntfGroupType = this.groupList[0].id
                    this.dGroupTreeData.lists = data
                    this.$refs.groupTable.OpenAll()
                } catch (error) {
                } finally {
                    this.managerLoading = false
                }
            },
            //获取所有typegroup 数据
            async getTypeGroupTableData(){
                this.managerLoading = true
                try {
                    const { data } = await this.http.get('sys/notificationSetting/typeGroupManager')
                    this.typeGroupTableData = data
                    this.typeGroupList = data
                } catch (error) {
                } finally {
                    this.managerLoading = false
                }
            },
        },

    })
</script>
</body>