<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">


<head
        th:replace="layout/header::common_header(title='在宅勤務登録',cssPaths='/pages/content.min.css')">
</head>

<body>
<div th:replace="layout/loadingBar::loadingBar"></div>
<!-- 菜单导航栏 -->
<div th:replace="layout/sider"></div>
<main class="content oconfirm-warp" ref="layout">
    <div class="content_head">
        <div class="header">
            <div class="title1">
                <h1>
                    <Icon type="i-emeer colored"></Icon>
                    在宅勤務登録
                </h1>
            </div>
            <div class="btnbox">
                <span style="flex:1"></span>
                <i-button type="primary" ghost icon="md-nutrition" @click="hwApplyShow = !hwApplyShow">在宅勤務申請</i-button>
            </div>
        </div>
        <div class="searchwrap">
            <span class="label">年月</span>
            <i-select v-model="defaultDate" class="mr30" @on-change="handleStartMonth($event)"
                      placeholder="選択ください">
                <i-option v-for="(item, index) of dispMonthlyList" :key="index" :label="item.tda_dyyyymm" :value="item.tda_dyyyymm">
                </i-option>
            </i-select>
            <span class="label">所属</span>
            <span class="input-like-span width15">
                <Tooltip trigger="hover"　:theme="toolTipTheme()" transfer　v-if="kanjiName">{{ sectionName }}
                    <div slot="content">{{ sectionName }}</div>
                </Tooltip>
            </span>
        </div>
    </div>
    <div class="content_body">
        <div style="position: relative;">
            <i-table  no-data-text="所属から職員を選んでください。" border :columns="columns"
                     :row-class-name="() => 'select-col'" :disabled-hover="true" :data="HomeWorkVOList" >

                <template slot-scope="{ row }" slot="tdaDd">
                    <span :class="dayRed(row)">{{`${row.tdaDd}　${row.tdaDy}`}}</span>
                </template>

                <template slot-scope="{ row }" slot="hwStatus">
                    <span :class="dayRedStatus(row)"v-if="row.hwStatus=='1'">承認待</span>
                    <span :class="dayRedStatus(row)"v-else-if="row.hwStatus=='2'">承認済</span>
                    <span :class="dayRedStatus(row)"v-else-if="row.hwStatus=='3'">取下</span>
                    <span :class="dayRedStatus(row)"v-else-if="row.hwStatus=='4'">差戻</span>
                    <span :class="dayRedStatus(row)"v-else></span>
                </template>

                <template slot-scope="{ row }" slot="hwHomework">
                    <span :class="dayRedStatus(row)"v-if="row.hwHomework=='1'">在宅勤務（終日）</span>
                    <span :class="dayRedStatus(row)"v-else-if="row.hwHomework=='2'">在宅勤務（午前）</span>
                    <span :class="dayRedStatus(row)"v-else-if="row.hwHomework=='3'">在宅勤務（午後）</span>
                    <span :class="dayRedStatus(row)"v-else-if="row.hwHomework=='4'">在宅勤務（時間）</span>
                    <span :class="dayRedStatus(row)"v-else></span>
                </template>

                <template slot-scope="{ row }" slot="hwStart">
                    <span :class="dayRedStatus(row)">{{ row.hwStart }}</span>
                </template>

                <template slot-scope="{ row }" slot="hwEnd">
                    <span :class="dayRedStatus(row)">{{ row.hwEnd}}</span>
                </template>

                <template slot-scope="{ row }" slot="hwCommute">
                    <span :class="dayRedStatus(row)"v-if="row.hwCommute=='1'">対象外</span>
                    <span :class="dayRedStatus(row)"v-else-if="row.hwCommute=='0'">対象</span>
                    <span :class="dayRedStatus(row)"v-else></span>
                </template>

                <template slot-scope="{ row }" slot="hwApplicationcomment">
                    <span :class="dayRedStatus(row)">{{ row.hwApplicationcomment }}</span>
                </template>

                <template slot-scope="{ row }" slot="hwApprovalcomment">
                    <span :class="dayRedStatus(row)">{{ row.hwApprovalcomment }}</span>
                </template>

            </i-table>
            <Spin size="large" fix v-if="loading"></Spin>
        </div>
    </div>
    <!-- 在宅勤務申请 -->
    <Drawer class="tc" title="在宅勤務申請" placement="right" width="70%" v-model="hwApplyShow" @on-close="handleClose()">

        <div class="tr">
            <i-button type="primary" class="mb10" ghost @click="updateHomeWork()" icon="md-done-all">登録</i-button>
            <i-button type="error" class="mb10" ghost @click="handleClose()" icon="md-hand">取消</i-button>
        </div>
        </div>
        <i-table  no-data-text="" border :columns="columns"
                  :row-class-name="() => 'select-col'" :disabled-hover="true" :data="HomeWorkVOListEditBack" >

            <template slot-scope="{ row  }" slot="tdaDd">
                <span :class="dayRed(row)">{{`${row.tdaDd}　${row.tdaDy}`}}</span>
            </template>

            <template slot-scope="{ row, index }" slot="hwStatus" >
                <span v-if="HomeWorkVOListEditBack[index].hwStatus=='1'">
                    <i-select v-model="HomeWorkVOListEditBack[index].hwStatus" class="mr30" @on-change="editBack(index)" placeholder="" :class="dayRedStatus(row)">
                        <i-option :value="StatusList[0].value">{{ StatusList[0].label }}</i-option>
                        <i-option :value="StatusList[2].value">{{ StatusList[2].label }}</i-option>
                    </i-select>
                </span>
                <span v-else-if="HomeWorkVOListEditBack[index].hwStatus=='2'">
                    <i-select v-model="HomeWorkVOListEditBack[index].hwStatus" class="mr30"  @on-change="editBack(index)"placeholder="" :disabled="row.hwStatus == 2">
                        <i-option :value="StatusList[1].value">{{ StatusList[1].label }}</i-option>
                    </i-select>
                </span>
                <span v-else-if="HomeWorkVOListEditBack[index].hwStatus=='3'">
                    <i-select v-model="HomeWorkVOListEditBack[index].hwStatus" class="mr30"  @on-change="editBack(index)"placeholder="" :disabled="row.hwStatus == 2">
                        <i-option :value="StatusList[0].value">{{ StatusList[0].label }}</i-option>
                        <i-option :value="StatusList[2].value">{{ StatusList[2].label }}</i-option>
                    </i-select>
                </span>
                <span v-else-if="HomeWorkVOListEditBack[index].hwStatus=='4'">
                    <i-select v-model="row.hwStatus" class="mr30"  @on-change="editBack(index)"placeholder="" :class="dayRedStatus(row)">
                        <i-option :value="StatusList[0].value">{{ StatusList[0].label }}</i-option>
                        <i-option :value="StatusList[2].value">{{ StatusList[2].label }}</i-option>
                        <i-option :value="StatusList[3].value">{{ StatusList[3].label }}</i-option>
                    </i-select>
                </span>
                <span v-else>
                    <i-select v-model="HomeWorkVOListEditBack[index].hwStatus" class="mr30"  @on-change="editBack(index)"placeholder="">
                        <i-option  :value="StatusList[0].value">{{ StatusList[0].label }}</i-option>
                    </i-select>
                </span>
            </template>

            <template slot-scope="{ row, index }" slot="hwHomework" >
                <i-select v-model="HomeWorkVOListEditBack[index].hwHomework" class="mr30" @on-change="" placeholder="" :disabled="row.hwStatus == 2">
                    <i-option  v-for="(item, index) of homeworkList"  :value="item.value" :key="item.value" >{{ item.label }}</i-option>
                </i-select>
            </template>

            <template slot-scope="{ row, index }" slot="hwStart">
                <i-input v-model="HomeWorkVOListEditBack[index].hwStart"  @on-blur="handleInputChange(index, HomeWorkVOListEditBack[index],'hwStart', $event.target)" :disabled="row.hwStatus == 2 || row.hwHomework　!= 4"></i-input>
            </template>

            <template slot-scope="{ row, index }" slot="hwEnd">
                <i-input v-model="HomeWorkVOListEditBack[index].hwEnd"  @on-blur="handleInputChange(index, HomeWorkVOListEditBack[index],'hwEnd', $event.target)" :disabled="row.hwStatus == 2 || row.hwHomework　!= 4"></i-input>
            </template>

            <template slot-scope="{ row, index }" slot="hwCommute">
                <checkbox v-model="HomeWorkVOListEditBack[index].hwCommute == 1 " :disabled="row.hwStatus == 2"></checkbox>
            </template>

            <template slot-scope="{ row , index}" slot="hwApplicationcomment">
                    <i-input v-model=" HomeWorkVOListEditBack[index].hwApplicationcomment " type="textarea" class="tl dayRedStatus(row)"
                             :autosize="{ minRows: 2, maxRows: 5 }"
                             :maxlength="100"
                             @on-blur="handleInputChange(index, false)"></i-input>
            </template>

            <template slot-scope="{ row }" slot="hwApprovalcomment">
                <i-input v-model=" HomeWorkVOListEditBack[index].hwApprovalcomment " type="textarea" class="tl dayRedStatus(row)"
                         :autosize="{ minRows: 2, maxRows: 5 }"
                         :maxlength="100"
                         @on-blur="handleInputChange(index, false)"></i-input>
            </template>

        </i-table>
    </Drawer>
    <back-top></back-top>
</main>
<div th:replace="layout/head::header"></div>
<script type="text/babel" th:inline="javascript">
    const WORK_YEAR_SCHEDULE = new Vue({
        el: '.oconfirm-warp',
        data() {
            return {
                hwApplyShow: false,
                StatusList: [
                    {
                        value: '1',
                        label: '承認待',
                    },
                    {
                        value: '2',
                        label: '承認済'
                    },
                    {
                        value: '3',
                        label: '取下'
                    },
                    {
                        value: '4',
                        label: '差戻'
                    }
                ],
                homeworkList: [
                    {
                        value: '1',
                        label: '在宅勤務（終日）'
                    },
                    {
                        value: '2',
                        label: '在宅勤務（午前）'
                    },
                    {
                        value: '3',
                        label: '在宅勤務（午後）'
                    },
                    {
                        value: '4',
                        label: '在宅勤務（時間）'
                    }
                ],
                model1: '1',
                defaultDate: '', //年月选择（Date）
                dispMonthlyList: [],       //年月リスト
                hatuReiName:'',
                hatuResTimeRange:'',
                today:Utils.formatDate(new Date(),'YYYY/MM/DD'),
                HomeWorkVOList:[],
                HomeWorkVOListEditBack:[],
                yyyyMMdd:'',
                loading: false,　       //ローディングアクション
                hasPassedTimeCheck: false,
                index: 0,
                contentScrollTop: 0,
                kanjiName: [[${ session.psSession.loginKanjiName }]],　　 //ログインしたユーザの氏名
                loginEmployee: [[${ session.psSession.loginEmployee }]],  //ログインしたユーザの職員番号
                sectionName: [[${ session.psSession.loginDesignation[0].sectionName }]],　 //ログインしたユーザの所属
                query: {
                    employeeId: [[${ session.psSession.loginEmployee }]],　 //組織ツリーで選択した職員番号
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href,'psApp'),
                    txtBaseDate:'',
                    txtEndDate:'',
                    baseDate:''
                }
            }
        },
        async mounted() {
            this.selectScheduleDateList()
            window.addEventListener('scroll',this.handleScroll,{ passive: true })
        },
        beforeDestroy() {
            window.removeEventListener('scroll',this.handleScroll,{ passive: true })
        },
        computed: {
            columns() {
                return [
                    {
                        title: '日',
                        width: 100,
                        slot: 'tdaDd',
                        align: 'center'
                    },
                    {
                        title: '状態',
                        minWidth: 80,
                        slot: 'hwStatus',
                        align: 'center'
                    },
                    {
                        title: '在宅勤務',
                        minWidth: 130,
                        slot: 'hwHomework',
                        align: 'center'
                    },
                    {
                        title: '開始',
                        minWidth: 90,
                        slot: 'hwStart',
                        align: 'center'
                    },
                    {
                        title: '終了',
                        minWidth: 90,
                        slot: 'hwEnd',
                        align: 'center'
                    },
                    {
                        title: '通勤対象外',
                        minWidth: 50,
                        slot: 'hwCommute',
                        align: 'center'
                    },
                    {
                        title: '申請コメント',
                        minWidth: 200,
                        slot: 'hwApplicationcomment',
                        // tooltip: true,
                        align: 'center'
                    },
                    {
                        title: '承認コメント',
                        minWidth: 200,
                        slot: 'hwApprovalcomment',
                        // tooltip: true,
                        align: 'center'
                    }

                ]
            }
        },
        methods: {
            async getHomeWorkInfo() {
                this.loading=true
                try {
                    const {data} = await this.http.get(`sys/homeWork/selectHomeWorkInfo`,this.query)
                    this.HomeWorkVOList=data
                    // this.HomeWorkVOListEditBack = {...data}
                    this.HomeWorkVOListEditBack = JSON.parse(JSON.stringify(data));
                } catch (error) {
                    return
                } finally {
                    this.loading = false
                }
            },
            async selectScheduleDateList() {

                try {
                    const query = {
                        employeeId:this.query.employeeId,
                        psSite:this.query.psSite,
                        psApp:this.query.psApp,
                        baseDate:Utils.formatDate(new Date(),'YYYY-MM-DD')
                    }
                    const {data}= await  this.http.get(`sys/schedule/selectScheduleDateList`,query)
                    this.dispMonthlyList=data
                    this.defaultDate=this.dispMonthlyList[1].tda_dyyyymm
                    this.query.txtBaseDate=this.dispMonthlyList[1].tda_firstDay
                    await this.getHomeWorkInfo()
                    this.getHatuRei()
                } catch (error) {
                    return
                }
            },
            async handleStartMonth(e) {
                let select=this.dispMonthlyList.find(item=> item.tda_dyyyymm==e )
                this.query.txtBaseDate=select.tda_firstDay
                this.query.txtEndDate=select.tda_endDay

                await this.getHomeWorkInfo()
            },
            dayRed(e) {
                const dayOfWeek = e.mgdCsparechar
                if (!dayOfWeek) {
                    return
                }
                if (dayOfWeek != '0') {
                    return 'blue'
                }
            },
            dayRedStatus(e) {
                if (!e.hwStatus) {
                    return
                }
                if (e.hwStatus == '4') {
                    return 'red'
                }
            },
            async getHatuRei() {
                try {
                    let txtBaseDate= this.yyyyMMdd.split('～')[0].replace(/(.+?)\年(.+?)\月(.+)\日/,"$1/$2/$3")
                    // const query = {txtBaseDate:txtBaseDate}
                    // const { data } =  await this.http.get(`sys/homeWork/hatuRei`, query)
                    // this.hatuReiName=data.name
                    // this.hatuResTimeRange=data.timerange
                } catch (error) {
                    return
                }finally {

                }
            },
            handleInputChange(i,object,value,el) {
                // 填完后自动checkbox
                if(object) {
                    this.hasPassedTimeCheck = Utils.checkTime(object, value,el)
                }
            },
            handleClose() {
                this.getHomeWorkInfo()
                this.hwApplyShow = false
            },
            time_check(sTime) {
                return sTime.match(/^(([0-3]?[0-9])|([4][0-7])):([0-5]?[0-9])$/);
            },
            editBack(index) {
                this.HomeWorkVOListEditBack[index].hwHomework = this.HomeWorkVOList[index].hwHomework
                this.HomeWorkVOListEditBack[index].hwStart = this.HomeWorkVOList[index].hwStart
                this.HomeWorkVOListEditBack[index].hwEnd = this.HomeWorkVOList[index].hwEnd
                this.HomeWorkVOListEditBack[index].hwCommute = this.HomeWorkVOList[index].hwCommute
            },
            //登陆处理
            async updateHomeWork() {
                console.log(this.HomeWorkVOListEditBack)
                let checkFlg=false
                for (let i = 0; i < this.HomeWorkVOListEditBack.length; i++) {
                    let msday=this.HomeWorkVOListEditBack[i].hwApplicationdate + " : ";
                    if (this.HomeWorkVOListEditBack[i].hwStatus == 1 ) {
                        if( this.HomeWorkVOListEditBack[i].hwHomework == 0 ){
                            this.$Notice.error({desc: msday + "在宅勤務を入力してください。"})
                            return checkFlg=true;
                        }
                    }
                    if(this.HomeWorkVOListEditBack[i].hwHomework == 4 ){
                        if (this.HomeWorkVOListEditBack[i].hwStart ==null ||  !this.time_check(this.HomeWorkVOListEditBack[i].hwStart)) {
                            this.$Notice.error({desc: msday + "開始時間は適切な時刻ではありません。(hh:mm)形式で時刻を入力及び48:00以内の時刻で指定してください。"})
                            return checkFlg=true;
                        }
                        if (this.HomeWorkVOListEditBack[i].hwEnd ==null ||  !this.time_check(this.HomeWorkVOListEditBack[i].hwEnd)) {
                            this.$Notice.error({desc: msday + "終了時間は適切な時刻ではありません。(hh:mm)形式で時刻を入力及び48:00以内の時刻で指定してください。"})
                            return checkFlg=true;
                        }
                        if(this.HomeWorkVOListEditBack[i].hwStart!='' && this.HomeWorkVOListEditBack[i].hwEnd!=''){
                            let count=Utils.timeToMinute(this.HomeWorkVOListEditBack[i].hwEnd)-Utils.timeToMinute(this.HomeWorkVOListEditBack[i].hwStart)
                            if(0>=count){
                                this.$Notice.error({desc: msday + "開始時間は終了時間の前になるようにしてください。"})
                                return checkFlg=true;
                            }
                        }
                    }
                }
                if(checkFlg){
                    return
                }
                this.$Modal.confirm({
                    title: '注意',
                    content: 'この編集内容で登録します。よろしいですか？',
                    okText: 'OK',
                    width: 480,
                    cancelText: 'キャンセル',
                    onOk: async () => {
                        let query={ homeWorkVO:this.HomeWorkVOListEditBack }
                        console.log(query)
                        try{
                            await this.http.post(`sys/homeWork/updateHmoeWork`,query)
                        }catch (e) {
                            this.$Notice.warning({ title: '注意', desc: e, duration: 6.5 })
                        }finally {
                            this.getHomeWorkInfo()
                            this.hwApplyShow = false
                        }
                    },
                    onCancel: () => {
                    }
                })
            },
            handleScroll: Throttle(function(e) {
                this.contentScrollTop = e.target.documentElement.scrollTop || e.target.body.scrollTop
            }, 50)
        }
    })
</script>
</body>

</html>