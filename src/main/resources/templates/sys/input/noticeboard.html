<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='掲示板',cssPaths='/pages/content.min.css')">
</head>

<body
    th:with="baseUrl = ${#httpServletRequest.getScheme() + '://' + #httpServletRequest.getServerName() + ':' + #request.getServerPort()  + #request.getContextPath()}">
    <div th:replace="layout/loadingBar::loadingBar"></div>
    <!-- 菜单导航栏 -->
    <div th:replace="layout/sider"></div>
    <link th:href="${baseUrl + '/static/libs/quill.snow.css?t='+ new java.util.Date().getTime()}" rel="stylesheet">
    <style>
        .emoji-poptip .ivu-poptip-body {
            height: 500px;
            width: 300px;
            overflow-y: scroll;
        }

        .emoji {
            display: inline-block;
            width: 30px;
            height: 30px;
            font-size: 20px;
        }

        .emoji:hover {
            cursor: pointer;
            background: var(--light-input-border-grey);
            border-radius: 50%;
            transform: scale(1.2);
        }
    </style>
    <main class="content protosettings-warp" ref="layout">
        <div class="content_head">
            <div class="header">
                <div class="title1">
                    <h1>
                        <Icon type="i-emeer colored"></Icon>
                        {{ `掲示板` }}
                    </h1>
                </div>
                <div class="btnbox">
                    <span style="flex:1"></span>
                    <i-button type="success" ghost icon="md-create" @click="isAdding = true"
                        v-show="!isAdding && editPermission">新規投稿</i-button>
                    <i-button @click="resetDraft" v-show="isAdding">一覧に戻る</i-button>
                    <i-button type="success" ghost icon="md-create" @click="uploadNotice('0')" :loading="editLoading"
                        v-show="isAdding">一時保存</i-button>
                    <i-button type="success" icon="md-done-all" @click="uploadNotice('1')" :loading="editLoading"
                        v-show="isAdding">投稿</i-button>
                    <i-button type="error" ghost icon="md-trash" @click="deleteDraft({hbtId:editId})" :loading="editLoading"
                    v-show="isAdding && isEditing">削除</i-button>
                </div>
            </div>
            <div class="searchwrap" v-show="isAdding">
                <span class="label">掲示範囲</span>
                <i-select v-model="searchRange" class="mr30" style="width: 25%;" multiple
                    @on-change="getPeopleBySelection">
                    <i-option v-for="(item, index) of rangeList" :key="index" :label="item.typeName"
                        :value="item.typeId">
                    </i-option>
                </i-select>
                <span class="label" style="width: 190px;">掲示板に一番上にします</span>
                <span
                    style="padding-left: 8px;border: 1px solid var(--input-border-grey);line-height: 29px; width: 15%;">
                    <radio-group class="tl" v-model="updateValue.hbtCheaddisp">
                        <Radio label="0">いいえ</Radio>
                        <Radio label="1">はい</Radio>
                    </radio-group>
                </span>
            </div>
        </div>
        <div class="content_body">
            <Alert v-show="this.selectedPeopleText.length > 0 && isAdding" class="primary-info tl">
                <div class="no-border-radius mb2" style="display: flex; align-items: stretch;">
                    <span style="display: inline-block;width: 160px;color: var(--grey);">掲示範囲にいる社員： </span>
                    <span class="tl width100"> {{ selectedPeopleText }}</span>
                </div>
                <Spin size="large" fix v-if="selectedPeopleloading"></Spin>
            </Alert>
            <!-- <div class="table-top">
            <Row :gutter="16">
              <i-col span="24" class="tr">
              </i-col>
            </Row>
          </div> -->
            <!-- <i-table border :class="tableHeadFixed ? 'table-head-fixed' : ''"
            :row-class-name="() => 'select-col'" :columns="columns" :disabled-hover="true" :data="tableData"
            :loading="loading" ref="table">
          </i-table> -->
            <span v-show="!isAdding">
                <div class="titlenorm mb10 mt10" style="font-size:15px" v-if="editPermission">
                    <Icon type="logo-buffer"></Icon>
                    通知
                </div>
                <div class="tr mb10">
                    <Page :total="pageValue.amount" :current="pageValue.curPage" show-total style="display: inline"
                          :page-size="pageValue.curSize" @on-change="pageChangeNotice" simple/>
                </div>
                <i-table border :row-class-name="() => 'select-col'" :columns="columns"
                    :disabled-hover="true" :data="tableData" :loading="loading">
                    <template slot-scope="{ row }" slot="action">
                        <div>
                            <i-button type="primary" ghost size="small" icon="ios-eye" style="margin-right: 5px"
                                @click="checkoutNotice(row)">詳細</i-button>
                        </div>
                    </template>
                </i-table>
                <div class="titlenorm mb10 mt10" style="font-size:15px" v-if="editPermission">
                    <Icon type="logo-buffer"></Icon>
                    下書
                </div>
                <div class="tr mb10">
                    <Page :total="pageValueDraft.amount" :current="pageValueDraft.curPage" show-total style="display: inline"
                          :page-size="pageValueDraft.curSize" @on-change="pageChangeDraft" simple/>
                </div>
                <i-table border :row-class-name="() => 'select-col'" v-if="editPermission"
                    :columns="columns" :disabled-hover="true" :data="draftData" :loading="drafLoading">
                    <template slot-scope="{ row }" slot="action">
                        <div>
                            <i-button type="primary" ghost size="small" icon="ios-create" style="margin-right: 5px" @click="editDraft(row)">編集</i-button>
                            <i-button type="error" ghost size="small" icon="ios-trash" 　class="collapse-btn ivu-btn ivu-btn-error ivu-btn-small ivu-btn-ghost" style="margin-right: 5px" @click="deleteDraft(row)" >削除</i-button>
                        </div>
                    </template>
                </i-table>
            </span>
            <Row :gutter="16" v-show="isAdding">
                <i-col span="12">
                    <rich-text ref="richText" :uploadFiles="uploadFiles" @add-files="($event) => uploadFiles.push($event)"></rich-text>
                </i-col>
                <i-col span="12">
                    <Row :gutter="10">
                        <i-col span="13">
                            <div class="label pl10 tc">件名</div>
                            <div class="person-info">
                                <i-input class="tl" style="padding: 3px;margin-left: -6px;" size="small"
                                    v-model="updateValue.hbtCtitle" :maxlength="1000"></i-input>
                            </div>
                        </i-col>
                        <i-col span="11">
                            <div class="label pl10 tc">掲示期間</div>
                            <div class="person-info">
                                <Row :gutter="8">
                                    <i-col span="12">
                                        <date-picker v-model="updateValue.hbtDdateofannouncement" type="date"
                                            size="small" :clearable="false" :options="rangeOptions" format="yyyy/MM/dd"
                                            @on-change="updateValue.hbtDdateofannouncement = $event"></date-picker>
                                    </i-col>
                                    <i-col span="12">
                                        <date-picker v-model="updateValue.hbtDdateofexpire" type="date" size="small"
                                            :clearable="false" :options="rangeOptions" format="yyyy/MM/dd"
                                            　@on-change="updateValue.hbtDdateofexpire = $event"></date-picker>
                                    </i-col>
                                </Row>
                            </div>
                        </i-col>
                        <i-col span="24" class="mt10" v-show="uploadFiles.length > 0">
                            <div class="label pl10 tc">添付ファイル</div>
                            <div
                                style="border-right: 1px solid var(--border-grey); border-bottom: 1px solid var(--border-grey); border-left: 1px solid var(--border-grey); background-color: var(--selection-input-bg); padding: 8px; }">
                                <ul class="ivu-upload-list tl mb10">
                                    <li class="ivu-upload-list-file" v-for="(item,i) of uploadFiles" :key="i">
                                        <span @click="openFile(item)" :style="{cursor: item.isDefault ? 'pointer' : 'default'}">
                                            <Icon
                                                :type="item.type.indexOf('image') > -1 ? 'ios-image' : item.type.indexOf('sheet') > -1 || item.type.indexOf('xls') > -1 ? 'ios-stats' : 'md-document' ">
                                            </Icon> {{ item.name }}
                                        </span>
                                        <p style="position: absolute;top: 5px;right: 42px;font-size: 9px;color:var(--grey)" v-if="item.isDefault">既存</p>
                                        <i class="ivu-icon ivu-icon-ios-close ivu-upload-list-remove"
                                            @click="handleDelFile(item)"></i>
                                    </li>
                                </ul>
                            </div>
                        </i-col>
                    </Row>
                </i-col>
            </Row>
        </div>
        <Spin size="large" fix v-if="loading"></Spin>
        <Drawer class="tc with-footer" placement="right" width="45" v-model="drawerShow" :title="noticeTitle">
                <Row :gutter="10">
                    <i-col span="13">
                        <div class="label pl10 tc">件名</div>
                        <div class="person-info">
                            <p>{{ updateValue.hbtCtitle }}</p>
                        </div>
                    </i-col>
                    <i-col span="11">
                        <div class="label pl10 tc">掲示期間</div>
                        <div class="person-info">
                            {{`${Utils.formatDate(updateValue.hbtDdateofannouncement, 'yyyy/mm/dd')} ～ ${updateValue.hbtDdateofexpire === 7983759600000 ? '' : Utils.formatDate(updateValue.hbtDdateofexpire, 'yyyy/mm/dd')}`}}
                        </div>
                    </i-col>
                </Row>
                <div class="titlenorm grey mb10 mt10" style="font-size:15px">
                    <Icon type="logo-buffer"></Icon>
                    内容
                </div>
                <div class="tl input-like-span ql-editor" v-html="notice" style="padding: 5px;overflow-y: unset"></div>
                <div style="clear: both"></div>
                <div class="titlenorm grey mb10 mt10" style="font-size:15px">
                    <Icon type="logo-buffer"></Icon>
                    添付ファイル
                </div>
                <span class="input-like-span tl" style="padding:10px">
                    <div v-for="(item,i) of uploadFiles" :key="item.hbtfId">
                        <span class="link-like" @click="openFile(item)" :style="{color: 'var(--primary-info)', cursor: item.isDefault ? 'pointer' : 'default', 'border-bottom-color': 'var(--primary-info)'}">{{ item.name }}</span>
                    </div>
                </span>
                <Spin size="large" fix v-if="noticeLoading"></Spin>
            <drawer-footer @ok="onOk" @cancel="onCancel" ok-text="投稿"></drawer-footer>
        </Drawer>
        <back-top></back-top>
        <a href='' download style="display: none;" ref="downloadBtn"></a>
    </main>
    <script th:src="${baseUrl + '/static/component/drawer-footer.js?t='+ new java.util.Date().getTime()}"></script>
    <div th:replace="layout/head::header"></div>
    <script th:src="${baseUrl + '/static/libs/quill.min.js?t='+ new java.util.Date().getTime()}"></script>
    <script th:src="${baseUrl + '/static/libs/image-resize.min.js?t='+ new java.util.Date().getTime()}"></script>
    <script th:src="${baseUrl + '/static/js/emoji.js?t='+ new java.util.Date().getTime()}"></script>
    <script th:src="${baseUrl + '/static/component/rich-text.js?t='+ new java.util.Date().getTime()}"></script>
    <script type="text/babel" th:inline="javascript">
        new Vue({
            el: '.protosettings-warp',
            components: {DrawerFooter, RichText},
            data() {
                return {
                    isShow: false,
                    loading: false,
                    drafLoading: false,
                    editLoading: false,
                    noticeLoading: false,
                    isAdding: false,
                    isEditing: false,
                    btnLoading: false,
                    editPermission: [[${ session }]].psSession.hasPublishPermission,
                    drawerShow:false,
                    noticeTitle: '',
                    notice:'',
                    selectedPeople: '',
                    selectedPeopleText: '',
                    selectedPeopleloading: false,
                    searchRange: [],
                    defaultOption: false,
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    pageValueDraft: {
                        amount: 0,
                        curPage: 1,
                        list: [20, 30, 50, 100],
                        curSize: 20
                    },
                    opts: {
                        order: 'desc',
                        page: 1,
                        limit: 50
                    },
                    pageValue: {
                        amount: 0,
                        curPage: 1,
                        list: [20, 30, 50, 100],
                        curSize: 20
                    },
                    opts2: {
                        order: 'desc',
                        page: 1,
                        limit: 50
                    },
                    updateValue: {
                        hbtCheaddisp: '0'
                    },
                    rangeOptions: {
                        disabledDate: date => {
                            return date.valueOf() < -3600000 || date.valueOf() > 7983759600000
                        }
                    },
                    columns: [
                    {
                            title: '掲示期間',
                            key: 'date',
                            align: 'left',
                        },
                        {
                            title: '件名',
                            key: 'hbtCtitle',
                            align: 'left',
                        },
                        {
                            title: ' ',
                            slot: 'action',
                            align: 'center',
                        },
                    ],
                    draftData: [],
                    tableData: [],
                    selfList:[],
                    uploadFiles: [],
                    deleteFiles:[],
                    rangeList: [],
                }
            },
            created() {
                this.getSelfList()
                this.getTableData()
                this.getDraftData()
                this.getSelection()
            },
            methods: {
                async getDraftData() {
                    try {
                        this.drafLoading = true
                        const { data } = await this.http.get('sys/noticeboard/draft/list', this.opts)
                        this.draftData = data.list.map(e=> {
                            return {
                                date: `${Utils.formatDate(e.hbtDdateofannouncement, 'yyyy/mm/dd')} ～ ${e.hbtDdateofexpire === 7983759600000 ? '' : Utils.formatDate(e.hbtDdateofexpire, 'yyyy/mm/dd')}`,
                                ...e
                            }
                        })
                        this.pageValueDraft.amount = data.totalCount
                    } catch (error) {
                    } finally {
                        this.drafLoading = false
                    }
                },
                async getTableData() {
                    try {
                        this.loading = true
                        const { data } = await this.http.get('sys/noticeboard/notice/list', this.opts2)
                        this.tableData = data.list.map(e=> {
                            return {
                                date: `${Utils.formatDate(e.hbtDdateofannouncement, 'yyyy/mm/dd')} ～ ${e.hbtDdateofexpire === 7983759600000 ? '' : Utils.formatDate(e.hbtDdateofexpire, 'yyyy/mm/dd')}`,
                                ...e,
                                hbtCtitle:e.hbCtitle
                            }
                        })
                        this.pageValue.amount = data.totalCount
                    } catch (error) {
                    } finally {
                        this.loading = false
                    }
                },
                async getSelfList() {
                    try {
                        // this.loading = true
                        const { data } = await this.http.get('sys/noticeboard/list')
                        this.selfList = data.list
                        // this.pageValue.amount = data.totalCount
                    } catch (error) {
                    } finally {
                        // this.loading = false
                    }
                },
                async editDraft(row) {
                    const id = row.hbtId
                    try {
                        this.drafLoading = true
                        const { data } = await this.http.get(`sys/noticeboard/draft/${id}`)
                        this.isAdding = true
                        // 编辑的时候多一个删除按键
                        this.isEditing = true
                        // 这里v-model会自动触发一次 this.getPeopleBySelection()
                        this.searchRange = data.typeRangeList.map(e => e.typeId)
                        this.$refs.richText.setHtml(data.hbtCcontents)
                        this.updateValue.hbtCtitle = data.hbtCtitle
                        this.updateValue.hbtDdateofannouncement = Utils.formatDate(data.hbtDdateofannouncement, 'yyyy/mm/dd')
                        this.updateValue.hbtDdateofexpire = data.hbtDdateofexpire === 7983759600000 ? '' : Utils.formatDate(data.hbtDdateofexpire, 'yyyy/mm/dd')
                        this.updateValue.hbtCheaddisp = data.hbtCheaddisp
                        this.editId = data.hbtId
                        // 文件
                        this.$nextTick(() => {
                            this.uploadFiles = data.attachments.map(e => {
                                return {
                                    name: e.hbtfFilename,
                                    url: `${BASE_URL}${e.hbtfFileUrl}`,
                                    type: e.hbtfFilename.split('.')[1],
                                    hbtfId: e.hbtfId,
                                    isDefault: true
                                }
                            })
                        })
                    } catch (error) {
                    } finally {
                        this.drafLoading = false
                    }
                },
                async checkoutNotice(row) {
                    const id = row.hbId
                    try {
                        this.noticeLoading = true
                        this.noticeTitle = '通知'
                        this.drawerShow = true
                        const { data } = await this.http.get(`sys/noticeboard/notice/${id}`)
                        this.$refs.richText.setHtml(data.hbtCcontents)
                        this.updateValue.hbtCtitle = data.hbCtitle
                        this.updateValue.hbtDdateofannouncement = Utils.formatDate(data.hbtDdateofannouncement, 'yyyy/mm/dd')
                        this.updateValue.hbtDdateofexpire = data.hbtDdateofexpire === 7983759600000 ? '' : Utils.formatDate(data.hbtDdateofexpire, 'yyyy/mm/dd')
                        this.updateValue.hbtCheaddisp = data.hbtCheaddisp
                        this.notice = this.$refs.richText.getHtml()
                        this.$nextTick(() => {
                            this.uploadFiles = data.attachmentList.map(e => {
                                return {
                                    name: e.hbfFileName,
                                    url: `${BASE_URL}${e.hbfFileUrl}`,
                                    type: e.hbfFileName.split('.')[1],
                                    hbtfId: e.hbfId,
                                    isDefault: true
                                }
                            })
                        })
                    } catch (error) {
                    } finally {
                        this.noticeLoading = false
                    }
                },
                openFile(item) {
                    if(item.url) {
                        console.log(this.$refs.downloadBtn)
                        this.$refs.downloadBtn.href= item.url
                        this.$refs.downloadBtn.click()
                        // window.open(item.url, '_blank')
                    }
                },
                deleteDraft(row) {
                    this.$Modal.confirm({
                        title: '注意',
                        width: 480,
                        content: 'この下書を削除します。よろしいですか？',
                        okText: '削除',
                        cancelText: '戻る',
                        onOk: async () => {
                            await this.http.post('sys/noticeboard/draft/delete', [row.hbtId])
                            this.resetDraft()
                            this.getDraftData()
                            this.$Message.success('削除完了')
                        }
                    })
                },
                async getSelection() {
                    const { data } = await this.http.get('sys/noticeboard/rangelist')
                    this.rangeList = data
                },
                async getPeopleBySelection() {
                    if (this.searchRange.length === 0) return
                    try {
                        this.selectedPeopleloading = true
                        const { data } = await this.http.get('sys/noticeboard/validemps', { typeIds: this.searchRange })
                        let text = ''
                        this.selectedPeople = data.map(e => {
                            let key = Object.keys(e)[0]
                            let value = Object.values(e)[0]
                            text = text.concat(`${key} ${value} , `)
                            return {
                                key: key,
                                value: value,
                            }
                        })
                        this.selectedPeopleText = text.slice(0, -2)
                    } catch (error) {
                    } finally {
                        this.selectedPeopleloading = false
                    }

                },
                uploadNotice(hbtCfix) {
                    if (this.selectedPeople.length === 0) {
                        return this.$Notice.warning({ title: '注意', desc: '掲示範囲を選択してください', duration: 6.5 })

                    }
                    if (!this.updateValue.hbtCtitle) {
                        return this.$Notice.warning({ title: '注意', desc: '件名を入力してください', duration: 6.5 })

                    }
                    if (!this.updateValue.hbtDdateofannouncement) {
                        return this.$Notice.warning({ title: '注意', desc: '開始時間を入力してください', duration: 6.5 })

                    }
                    if (this.updateValue.hbtDdateofexpire && new Date(this.updateValue.hbtDdateofannouncement) > new Date(this.updateValue.hbtDdateofexpire)) {
                        return this.$Notice.warning({ title: '注意', desc: '掲示期間(終了時間)は(開始時間)より後の時刻を入力してください', duration: 6.5 })
                    }

                    if (!this.updateValue.hbtDdateofexpire) delete this.updateValue.hbtDdateofexpire
                    if(hbtCfix === '1') {
                        this.noticeTitle = '掲示確認用'
                        this.notice = this.$refs.richText.getHtml()
                        this.drawerShow = true
                    } else {
                        this.postNotice(hbtCfix)
                    }
                },
                resetDraft() {
                    this.isAdding = false
                    this.isEditing = false
                    this.updateValue = {
                        hbtCheaddisp: '0'
                    }
                    this.uploadFiles = []
                    this.deleteFiles = []
                    this.searchRange = ''
                    this.selectedPeople = ''
                    this.selectedPeopleText = ''
                    this.$refs.richText.setText('');
                    // 修正当富文本内有图像时，点击后，残留裁剪边框的bug
                    const quillImgCutFrame = document.querySelector('.ql-tooltip.ql-hidden').nextSibling
                    if(quillImgCutFrame) {
                        quillImgCutFrame.style.display = 'none'
                    }
                },
                onCancel() {
                    this.drawerShow = false
                },
                onOk() {
                    this.postNotice()
                },
                postNotice(hbtCfix) {
                    this.$Modal.confirm({
                        inDrawer: true,
                        title: '注意',
                        width: 480,
                        content: `${ hbtCfix ? '一時保存' : '投稿'}します。よろしいですか？`,
                        okText: 'OK',
                        cancelText: 'キャンセル',
                        onOk: async () => {
                            try {
                                if(hbtCfix) this.loading = true
                                let opts ={
                                    attachments: this.uploadFiles.filter(e=> !e.isDefault),
                                    ...this.updateValue,
                                    hbtCcontents: this.$refs.richText.getHtml(),
                                    sendRangeTypes: this.searchRange.join(),
                                    keepAttachmentIdStr: this.uploadFiles.filter(e=> e.isDefault).map(e=>e.hbtfId).join(),
                                    deleteAttachmentIdStr: this.deleteFiles.join(),
                                    empRangeIds: this.selectedPeople.map(e => e.key).join(),
                                    isPublish: hbtCfix ? hbtCfix : '1',
                                    hbtCfix: hbtCfix ? hbtCfix : '1',
                                }
                                if(this.isEditing) {
                                    opts.hbtId = this.editId
                                }
                                await this.http.uploadFiles('sys/noticeboard/draft/addOrUpdate', opts)
                                this.$Message.success(hbtCfix ? '一時保存完了' : '投稿完了')
                                this.drawerShow = false
                                this.resetDraft()
                                this.getDraftData()
                                this.getTableData()
                            } catch (error) {
                                console.log(error)
                            } finally {
                                if(hbtCfix) this.loading = false
                            }
                        }
                    })
                },
                handleDelFile(file) {
                    // 删除文件
                    if(file.isDefault) this.deleteFiles.push(file.hbtfId)
                    this.uploadFiles = this.uploadFiles.filter(e => e.name !== file.name)
                },
                pageChangeNotice(e) {
                    this.opts.sPage = e
                    this.pageValueNotice.curPage = e
                    this.getTableData()
                },
                pageChangeDraft(e) {
                    this.opts.sPage = e
                    this.pageValueDraft.curPage = e
                    this.getDraftData()
                },
            }
        })
    </script>
</body>