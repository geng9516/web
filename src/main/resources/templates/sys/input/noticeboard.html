<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='掲示板',cssPaths='/pages/content.min.css')">
</head>

<body
    th:with="baseUrl = ${#httpServletRequest.getScheme() + '://' + #httpServletRequest.getServerName() + ':' + #request.getServerPort()  + #request.getContextPath()}">
    <div th:replace="layout/loadingBar::loadingBar"></div>
    <!-- 菜单导航栏 -->
    <div th:replace="layout/sider"></div>
    <link th:href="${baseUrl + '/static/libs/quill.snow.css?t='+ new java.util.Date().getTime()}" rel="stylesheet">
    <style>
        .emoji-poptip .ivu-poptip-body {
            height: 500px;
            width: 300px;
            overflow-y: scroll;
        }

        .emoji {
            display: inline-block;
            width: 30px;
            height: 30px;
            font-size: 20px;
        }

        .emoji:hover {
            cursor: pointer;
            background: var(--light-input-border-grey);
            border-radius: 50%;
            transform: scale(1.2);
        }
    </style>
    <main class="content protosettings-warp" ref="layout">
        <div class="content_head">
            <div class="header">
                <div class="title1">
                    <h1>
                        <Icon type="i-emeer colored"></Icon>
                        {{ `掲示板` }}
                    </h1>
                </div>
                <div class="btnbox">
                    <span style="flex:1"></span>
                    <i-button type="success" ghost icon="md-create" @click="isAdding = true"
                        v-show="!isAdding && editPermission">新規投稿</i-button>
                    <i-button @click="resetDraft" v-show="isAdding">一覧に戻る</i-button>
                    <i-button type="success" ghost icon="md-create" @click="uploadNotice('0')" :loading="editLoading"
                        v-show="isAdding">一時保存</i-button>
                    <i-button type="success" icon="md-done-all" @click="uploadNotice('1')" :loading="editLoading"
                        v-show="isAdding">投稿</i-button>
                    <i-button type="error" ghost icon="md-trash" @click="deleteDraft({hbtId:editId})" :loading="editLoading"
                    v-show="isAdding && isEditing">削除</i-button>
                </div>
            </div>
            <div class="searchwrap" v-show="isAdding">
                <span class="label">掲示範囲</span>
                <i-select v-model="searchRange" class="mr30" style="width: 25%;" multiple
                    @on-change="getPeopleBySelection">
                    <i-option v-for="(item, index) of rangeList" :key="index" :label="item.typeName"
                        :value="item.typeId">
                    </i-option>
                </i-select>
                <span class="label" style="width: 190px;">掲示板に一番上にします</span>
                <span
                    style="padding-left: 8px;border: 1px solid var(--input-border-grey);line-height: 29px; width: 15%;">
                    <radio-group class="tl" v-model="updateValue.hbtCheaddisp">
                        <Radio label="0">いいえ</Radio>
                        <Radio label="1">はい</Radio>
                    </radio-group>
                </span>
            </div>
        </div>
        <div class="content_body">
            <Alert v-show="this.selectedPeopleText.length > 0 && isAdding" class="primary-info tl">
                <div class="no-border-radius mb2" style="display: flex; align-items: stretch;">
                    <span style="display: inline-block;width: 160px;color: var(--grey);">掲示範囲にいる社員： </span>
                    <span class="tl width100"> {{ selectedPeopleText }}</span>
                </div>
                <Spin size="large" fix v-if="selectedPeopleloading"></Spin>
            </Alert>
            <!-- <div class="table-top">
            <Row :gutter="16">
              <i-col span="24" class="tr">
              </i-col>
            </Row>
          </div> -->
            <!-- <i-table border :class="tableHeadFixed ? 'table-head-fixed' : ''"
            :row-class-name="() => 'select-col'" :columns="columns" :disabled-hover="true" :data="tableData"
            :loading="loading" ref="table">
          </i-table> -->
            <span v-show="!isAdding">
                <div class="titlenorm mb10 mt10" style="font-size:15px" v-if="editPermission">
                    <Icon type="logo-buffer"></Icon>
                    下書
                </div>
                <i-table border :class="tableHeadFixed ? 'table-head-fixed' : ''" :row-class-name="() => 'select-col'" v-if="editPermission"
                    :columns="draftColumns" :disabled-hover="true" :data="draftData" :loading="drafLoading" ref="table">
                    <template slot-scope="{ row }" slot="action">
                        <div>
                            <i-button type="primary" ghost size="small" icon="ios-create" style="margin-right: 5px" @click="editDraft(row)">編集</i-button>
                            <i-button type="error" ghost size="small" icon="ios-trash" 　class="collapse-btn ivu-btn ivu-btn-error ivu-btn-small ivu-btn-ghost" style="margin-right: 5px" @click="deleteDraft(row)" >削除</i-button>
                        </div>
                    </template>
                </i-table>
            </span>
            <Row :gutter="16" v-show="isAdding">
                <i-col span="12">
                    <div id="toolbar">
                        <span class="ql-formats">
                            <button class="ql-bold" title="太字"></button>
                            <button class="ql-italic" title="斜体"></button>
                            <button class="ql-underline" title="下線"></button>
                            <button class="ql-strike" title="打ち消し線"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-list" value="ordered" title="番号付きリスト"></button>
                            <button class="ql-list" value="bullet" title="リスト"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-script" value="sub" title="下付き文字"></button>
                            <button class="ql-script" value="super" title="上付き文字"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-indent" value="-1" title="字上げ"></button>
                            <button class="ql-indent" value="+1" title="字下げ"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-clean" title="フォーマットクリア"></button>
                            <button class="ql-undo" title="元に戻す"></button>
                            <button class="ql-redo" title="やり直す"></button>
                        </span>
                        <span class="ql-formats">
                            <select class="ql-color" title="フォントの色">
                                <option value="rgb(0, 0, 0)" label="rgb(0, 0, 0)" />
                                <option value="rgb(230, 0, 0)" label="rgb(230, 0, 0)" />
                                <option value="rgb(255, 153, 0)" label="rgb(255, 153, 0)" />
                                <option value="rgb(255, 255, 0)" label="rgb(255, 255, 0)" />
                                <option value="rgb(0, 138, 0)" label="rgb(0, 138, 0)" />
                                <option value="rgb(0, 102, 204)" label="rgb(0, 102, 204)" />
                                <option value="rgb(153, 51, 255)" label="rgb(153, 51, 255)" />
                                <option value="rgb(250, 204, 204)" label="rgb(250, 204, 204)" />
                                <option value="rgb(255, 235, 204)" label="rgb(255, 235, 204)" />
                                <option value="rgb(255, 255, 204)" label="rgb(255, 255, 204)" />
                                <option value="rgb(204, 232, 204)" label="rgb(204, 232, 204)" />
                                <option value="rgb(204, 224, 245)" label="rgb(204, 224, 245)" />
                                <option value="rgb(235, 214, 255)" label="rgb(235, 214, 255)" />
                                <option value="rgb(187, 187, 187)" label="rgb(187, 187, 187)" />
                                <option value="rgb(240, 102, 102)" label="rgb(240, 102, 102)" />
                                <option value="rgb(255, 194, 102)" label="rgb(255, 194, 102)" />
                                <option value="rgb(255, 255, 102)" label="rgb(255, 255, 102)" />
                                <option value="rgb(102, 185, 102)" label="rgb(102, 185, 102)" />
                                <option value="rgb(102, 163, 224)" label="rgb(102, 163, 224)" />
                                <option value="rgb(194, 133, 255)" label="rgb(194, 133, 255)" />
                                <option value="rgb(136, 136, 136)" label="rgb(136, 136, 136)" />
                                <option value="rgb(161, 0, 0)" label="rgb(161, 0, 0)" />
                                <option value="rgb(178, 107, 0)" label="rgb(178, 107, 0)" />
                                <option value="rgb(178, 178, 0)" label="rgb(178, 178, 0)" />
                                <option value="rgb(0, 97, 0)" label="rgb(0, 97, 0)" />
                                <option value="rgb(0, 71, 178)" label="rgb(0, 71, 178)" />
                                <option value="rgb(107, 36, 178)" label="rgb(107, 36, 178)" />
                                <option value="rgb(68, 68, 68)" label="rgb(68, 68, 68)" />
                                <option value="rgb(92, 0, 0)" label="rgb(92, 0, 0)" />
                                <option value="rgb(102, 61, 0)" label="rgb(102, 61, 0)" />
                                <option value="rgb(102, 102, 0)" label="rgb(102, 102, 0)" />
                                <option value="rgb(0, 55, 0)" label="rgb(0, 55, 0)" />
                                <option value="rgb(0, 41, 102)" label="rgb(0, 41, 102)" />
                                <option value="rgb(61, 20, 102)" label="rgb(61, 20, 102)" />
                            </select>
                            <select class="ql-background" title="塗りつぶしの色">
                                <option value="rgb(0, 0, 0)" label="rgb(0, 0, 0)" />
                                <option value="rgb(230, 0, 0)" label="rgb(230, 0, 0)" />
                                <option value="rgb(255, 153, 0)" label="rgb(255, 153, 0)" />
                                <option value="rgb(255, 255, 0)" label="rgb(255, 255, 0)" />
                                <option value="rgb(0, 138, 0)" label="rgb(0, 138, 0)" />
                                <option value="rgb(0, 102, 204)" label="rgb(0, 102, 204)" />
                                <option value="rgb(153, 51, 255)" label="rgb(153, 51, 255)" />
                                <option value="rgb(255, 255, 255)" label="rgb(255, 255, 255)" />
                                <option value="rgb(250, 204, 204)" label="rgb(250, 204, 204)" />
                                <option value="rgb(255, 235, 204)" label="rgb(255, 235, 204)" />
                                <option value="rgb(255, 255, 204)" label="rgb(255, 255, 204)" />
                                <option value="rgb(204, 232, 204)" label="rgb(204, 232, 204)" />
                                <option value="rgb(204, 224, 245)" label="rgb(204, 224, 245)" />
                                <option value="rgb(235, 214, 255)" label="rgb(235, 214, 255)" />
                                <option value="rgb(187, 187, 187)" label="rgb(187, 187, 187)" />
                                <option value="rgb(240, 102, 102)" label="rgb(240, 102, 102)" />
                                <option value="rgb(255, 194, 102)" label="rgb(255, 194, 102)" />
                                <option value="rgb(255, 255, 102)" label="rgb(255, 255, 102)" />
                                <option value="rgb(102, 185, 102)" label="rgb(102, 185, 102)" />
                                <option value="rgb(102, 163, 224)" label="rgb(102, 163, 224)" />
                                <option value="rgb(194, 133, 255)" label="rgb(194, 133, 255)" />
                                <option value="rgb(136, 136, 136)" label="rgb(136, 136, 136)" />
                                <option value="rgb(161, 0, 0)" label="rgb(161, 0, 0)" />
                                <option value="rgb(178, 107, 0)" label="rgb(178, 107, 0)" />
                                <option value="rgb(178, 178, 0)" label="rgb(178, 178, 0)" />
                                <option value="rgb(0, 97, 0)" label="rgb(0, 97, 0)" />
                                <option value="rgb(0, 71, 178)" label="rgb(0, 71, 178)" />
                                <option value="rgb(107, 36, 178)" label="rgb(107, 36, 178)" />
                                <option value="rgb(68, 68, 68)" label="rgb(68, 68, 68)" />
                                <option value="rgb(92, 0, 0)" label="rgb(92, 0, 0)" />
                                <option value="rgb(102, 61, 0)" label="rgb(102, 61, 0)" />
                                <option value="rgb(102, 102, 0)" label="rgb(102, 102, 0)" />
                                <option value="rgb(0, 55, 0)" label="rgb(0, 55, 0)" />
                                <option value="rgb(0, 41, 102)" label="rgb(0, 41, 102)" />
                                <option value="rgb(61, 20, 102)" label="rgb(61, 20, 102)" />
                            </select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-link" title="リンク"></button>
                            <button class="ql-image" title="画像"></button>
                            <button class="ql-upload" title="アップロード"></button>
                        </span>
                        <span class="ql-formats">
                            <select class="ql-size" title="フォント サイズ">
                                <option value="14px"></option>
                                <option value="16px"></option>
                                <option value="18px"></option>
                                <option value="22px"></option>
                                <option value="26px"></option>
                                <option value="30px"></option>
                                <option value="36px"></option>
                                <option value="42px"></option>
                            </select>
                        </span>
                        <span class="ql-formats">
                            <Poptip v-model="emojiPop" placement="right-start" class="emoji-poptip">
                                <i-button size="small" icon="md-happy" style="font-size: 18px;" class="ql-emoji" title="絵文字">
                                </i-button>
                                <div class="tr" slot="content">
                                    <div v-for="(item,category,index) in SM_EMOJI" class="tl">
                                        <div :class="index > 0 ? 'mt5 mb2': 'mb2'" style="font-size: 16px;">{{category}}
                                        </div>
                                        <div class="tc" style="display: flex;flex-wrap: wrap;overflow-y: hidden;">
                                            <span v-for="(emoji, emojiName) in item" class="emoji"
                                                @click="handleClickEmoji(emoji)">{{ emoji }}</span>
                                        </div>
                                    </div>
                                </div>
                            </Poptip>
                        </span>
                    </div>
                    <div ref="editor"></div>
                </i-col>
                <i-col span="12">
                    <Row :gutter="10">
                        <i-col span="13">
                            <div class="label pl10 tc">件名</div>
                            <div class="person-info">
                                <i-input class="tl" style="padding: 3px;margin-left: -6px;" size="small"
                                    v-model="updateValue.hbtCtitle" :maxlength="1000"></i-input>
                            </div>
                        </i-col>
                        <i-col span="11">
                            <div class="label pl10 tc">掲示期間</div>
                            <div class="person-info">
                                <Row :gutter="8">
                                    <i-col span="12">
                                        <date-picker v-model="updateValue.hbtDdateofannouncement" type="date"
                                            size="small" :clearable="false" :options="rangeOptions" format="yyyy/MM/dd"
                                            @on-change="updateValue.hbtDdateofannouncement = $event"></date-picker>
                                    </i-col>
                                    <i-col span="12">
                                        <date-picker v-model="updateValue.hbtDdateofexpire" type="date" size="small"
                                            :clearable="false" :options="rangeOptions" format="yyyy/MM/dd"
                                            　@on-change="updateValue.hbtDdateofexpire = $event"></date-picker>
                                    </i-col>
                                </Row>
                            </div>
                        </i-col>
                        <i-col span="24" class="mt10" v-show="uploadFiles.length > 0">
                            <div class="label pl10 tc">添付ファイル</div>
                            <div
                                style="border-right: 1px solid var(--border-grey); border-bottom: 1px solid var(--border-grey); border-left: 1px solid var(--border-grey); background-color: var(--selection-input-bg); padding: 8px; }">
                                <ul class="ivu-upload-list tl mb10">
                                    <li class="ivu-upload-list-file" v-for="(item,i) of uploadFiles" :key="i">
                                        <span @click="openFile(item)" :style="{cursor: item.isDefault ? 'pointer' : 'default'}">
                                            <Icon
                                                :type="item.type.indexOf('image') > -1 ? 'ios-image' : item.type.indexOf('sheet') > -1 || item.type.indexOf('xls') > -1 ? 'ios-stats' : 'md-document' ">
                                            </Icon> {{ item.name }}
                                        </span>
                                        <p style="position: absolute;top: 5px;right: 42px;font-size: 9px;color:var(--grey)" v-if="item.isDefault">既存</p>
                                        <i class="ivu-icon ivu-icon-ios-close ivu-upload-list-remove"
                                            @click="handleDelFile(item)"></i>
                                    </li>
                                </ul>
                            </div>
                        </i-col>
                    </Row>
                </i-col>
            </Row>
            <Upload :show-upload-list="false" multiple action="/" :before-upload="handleBeforeUpload"
                style="display: none;">
                <i-button icon="ios-cloud-upload-outline" ref="uploadBtn"></i-button>
            </Upload>
            <Upload :show-upload-list="false" action="/" :before-upload="handleBeforeUpload2" style="display: none;">
                <i-button icon="ios-cloud-upload-outline" ref="uploadImgBtn"></i-button>
            </Upload>
        </div>
        <Spin size="large" fix v-if="loading"></Spin>
        <back-top></back-top>
        <a href='' download style="display: none;" ref="downloadBtn"></a>
    </main>
    <div th:replace="layout/head::header"></div>
    <script th:src="${baseUrl + '/static/libs/quill.min.js?t='+ new java.util.Date().getTime()}"></script>
    <script th:src="${baseUrl + '/static/libs/image-resize.min.js?t='+ new java.util.Date().getTime()}"></script>
    <script th:src="${baseUrl + '/static/js/emoji.js?t='+ new java.util.Date().getTime()}"></script>
    <script>
        var UPLOAD_ICON = '<i class="ivu-icon ivu-icon-md-cloud-upload" style="font-size: 18px;" aria-hidden="true"></i>'
        var UNDO_ICON = '<i class="ivu-icon ivu-icon-ios-undo" style="font-size: 18px;" aria-hidden="true"></i>'
        var REDO_ICON = '<i class="ivu-icon ivu-icon-ios-redo" style="font-size: 18px;" aria-hidden="true"></i>'

    </script>
    <script type="text/babel" th:inline="javascript">
        new Vue({
            el: '.protosettings-warp',
            data() {
                return {
                    isShow: false,
                    loading: false,
                    drafLoading: false,
                    emojiPop: false,
                    editLoading: false,
                    isAdding: false,
                    isEditing: false,
                    btnLoading: false,
                    editPermission: [[${ session }]].psSession.hasPublishPermission,
                    selectedPeople: '',
                    selectedPeopleText: '',
                    selectedPeopleloading: false,
                    searchRange: [],
                    defaultOption: false,
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp'),
                    updateValue: {
                        hbtCheaddisp: '0'
                    },
                    rangeOptions: {
                        disabledDate: date => {
                            return date.valueOf() < -3600000 || date.valueOf() > 7983759600000
                        }
                    },
                    columns: [
                        {
                            title: '掲示期間',
                            key: 'date',
                            align: 'left',
                        },
                        {
                            title: '件名',
                            key: 'hbtCtitle',
                            align: 'left',
                        },
                        // {
                        //     title: '掲示者',
                        //     key: '',
                        //     align: 'left',
                        // },
                        {
                            title: ' ',
                            key: '',
                            align: 'left',
                        },
                    ],
                    draftColumns: [
                    {
                            title: '掲示期間',
                            key: 'date',
                            align: 'left',
                        },
                        {
                            title: '件名',
                            key: 'hbtCtitle',
                            align: 'left',
                        },
                        {
                            title: ' ',
                            slot: 'action',
                            align: 'center',
                        },
                    ],
                    draftData: [],
                    debugquill: '',
                    tableData: [],
                    uploadFiles: [],
                    deleteFiles:[],
                    rangeList: [],
                    contentScrollTop: 0
                }
            },
            async created() {
                this.getTableData()
                this.getSelection()
                window.addEventListener('scroll', this.handleScroll, { passive: true })
            },
            beforeDestroy() {
                window.removeEventListener('scroll', this.handleScroll, { passive: true })
            },
            mounted() {
                const Link = Quill.import("formats/link")
                var Embed = Quill.import('blots/embed');
                var icons = Quill.import('ui/icons')
                icons['upload'] = UPLOAD_ICON
                icons["undo"] = UNDO_ICON
                icons["redo"] = REDO_ICON

                // class FileBlot extends Link {  // 继承Link Blot
                //     static create(value) {
                //         let node = undefined
                //         if (value && !value.href) {  // 适应原本的Link Blot
                //             node = super.create(value);
                //         }
                //         else {  // 自定义Link Blot
                //             node = super.create(value.href);
                //             // node.setAttribute('download', value.innerText);  // 左键点击即下载
                //             node.innerText = value.innerText;
                //             node.download = value.innerText;
                //         }
                //         return node;
                //     }
                // }
                // FileBlot.blotName = 'link';
                // FileBlot.tagName = 'A';
                // Quill.register(FileBlot);
                class SPAN extends Embed {
                    static create(paramValue) {
                        let node = super.create();
                        node.innerHTML = paramValue;
                        return node;
                    }

                    static value(node) {
                        return node.innerHTML;
                    }
                }
                SPAN.blotName = 'span';
                SPAN.tagName = 'span';
                Quill.register(SPAN);

                const that = this
                this.quill = new Quill(this.$refs.editor, {
                    modules: {
                        imageResize: {
                            displayStyles: {
                                backgroundColor: 'black',
                                border: 'none',
                                color: 'white'
                            },
                            modules: ['Resize', 'DisplaySize', 'Toolbar']
                        },
                        toolbar: {
                            container: '#toolbar',
                            handlers: {
                                'image': function (value) {
                                    if (value) {
                                        that.$refs.uploadImgBtn.$el.click()
                                    } else {
                                        this.quill.format('image', false);
                                    }
                                },
                                'upload': ((value) => {
                                    if (value) {
                                        that.$refs.uploadBtn.$el.click()
                                    }
                                }),
                                'emoji': function (value) {},
                                redo() {
                                    this.quill.history.redo()
                                },
                                undo() {
                                    this.quill.history.undo()

                                }
                            }
                        },
                        history: {
                            'delay': 2000,
                            maxStack: 500,
                            'userOnly': true
                        },
                    },
                    theme: 'snow'
                });
                // this.quill.enable(false)
                // this.quill.on('text-change', (delta, oldDelta, source) => {
                //     this.debugquill = this.quill.getContents()
                //     // this.debugquill = this.$refs.editor.children[0].innerHTML
                // })
                this.quill.on('selection-change', range => {
                    if (!range) {
                        let e = document.querySelector('.ql-tooltip,.ql-editing')
                        if (e) {
                            let left = e.style.left
                            if (left.indexOf('-') === 0) {
                                e.style.left = 0
                            }
                        }
                    } else {

                    }
                })
            },
            computed: {
                tableHeadFixed() {
                    if (this.contentScrollTop > 110) return true
                    else return false
                }
            },
            methods: {
                async getTableData() {
                    try {
                        this.drafLoading = true
                        const { data } = await this.http.get('sys/noticeboard/draft/list')
                        this.draftData = data.list.map(e=> {
                            return {
                                date: `${Utils.formatDate(e.hbtDdateofannouncement, 'yyyy/mm/dd')} ～ ${e.hbtDdateofexpire === 7983759600000 ? '' : Utils.formatDate(e.hbtDdateofexpire, 'yyyy/mm/dd')}`,
                                ...e
                            }
                        })
                    } catch (error) {
                    } finally {
                        this.drafLoading = false
                    }
                },
                async editDraft(row) {
                    const id = row.hbtId
                    try {
                        this.drafLoading = true
                        const { data } = await this.http.get(`sys/noticeboard/draft/${id}`)
                        this.isAdding = true
                        // 编辑的时候多一个删除按键
                        this.isEditing = true
                        // 这里v-model会自动触发一次 this.getPeopleBySelection()
                        this.searchRange = data.typeRangeList.map(e => e.typeId)
                        this.$refs.editor.children[0].innerHTML = data.hbtCcontents
                        this.updateValue.hbtCtitle = data.hbtCtitle
                        this.updateValue.hbtDdateofannouncement = Utils.formatDate(data.hbtDdateofannouncement, 'yyyy/mm/dd')
                        this.updateValue.hbtDdateofexpire = data.hbtDdateofexpire === 7983759600000 ? '' : Utils.formatDate(data.hbtDdateofexpire, 'yyyy/mm/dd')
                        this.updateValue.hbtCheaddisp = data.hbtCheaddisp
                        this.editId = data.hbtId
                        // 文件
                        this.$nextTick(() => {
                            this.uploadFiles = data.attachments.map(e => {
                                return {
                                    name: e.hbtfFilename,
                                    url: `${BASE_URL}${e.hbtfFileUrl}`,
                                    type: e.hbtfFilename.split('.')[1],
                                    hbtfId: e.hbtfId,
                                    isDefault: true
                                }
                            })
                        })
                    } catch (error) {
                    } finally {
                        this.drafLoading = false
                    }
                },
                openFile(item) {
                    if(item.url) {
                        console.log(this.$refs.downloadBtn)
                        this.$refs.downloadBtn.href= item.url
                        this.$refs.downloadBtn.click()
                        // window.open(item.url, '_blank')
                    }
                },
                deleteDraft(row) {
                    this.$Modal.confirm({
                        title: '注意',
                        width: 480,
                        content: 'この下書を削除します。よろしいですか？',
                        okText: '削除',
                        cancelText: '戻る',
                        onOk: async () => {
                            await this.http.post('sys/noticeboard/draft/delete', [row.hbtId])
                            this.resetDraft()
                            this.getTableData()
                            this.$Message.success('削除完了')
                        }
                    })
                },
                async getSelection() {
                    const { data } = await this.http.get('sys/noticeboard/rangelist')
                    this.rangeList = data
                },
                async getPeopleBySelection() {
                    if (this.searchRange.length === 0) return
                    try {
                        this.selectedPeopleloading = true
                        const { data } = await this.http.get('sys/noticeboard/validemps', { typeIds: this.searchRange })
                        let text = ''
                        this.selectedPeople = data.map(e => {
                            let key = Object.keys(e)[0]
                            let value = Object.values(e)[0]
                            text = text.concat(`${key} ${value} , `)
                            return {
                                key: key,
                                value: value,
                            }
                        })
                        this.selectedPeopleText = text.slice(0, -2)
                    } catch (error) {
                    } finally {
                        this.selectedPeopleloading = false
                    }

                },
                handleBeforeUpload(files) {
                    // 上传附件
                    let checkPassed = true
                    if (this.uploadFiles.length >= 5) {
                        this.$Notice.warning({
                            title: '注意',
                            desc: '添付可能なファイル数が上限（5個）を超えました。', duration: 6.5
                        })
                        checkPassed = false
                    }
                    if (files.size / (1024 * 1024) > 20) {
                        this.$Notice.warning({
                            title: '注意',
                            desc: 'ファイル「' + files.name + '」のサイズが上限（20MBytes）を超えました。', duration: 6.5
                        })
                        checkPassed = false
                    }
                    if (checkPassed) {
                        this.uploadFiles.push(files)
                    }
                    return false;
                },
                handleBeforeUpload2(files) {
                    // 上传图片
                    let checkPassed = true
                    if (files.size / (1024 * 1024) > 20) {
                        this.$Notice.warning({
                            desc: 'ファイル「' + files.name + '」のサイズが上限（20MBytes）を超えました。', duration: 6.5
                        })
                        checkPassed = false
                    }
                    const imgType = ["jpg", "jpeg", "png", "gif"]
                    if (!imgType.includes(files.type.split('image/')[1])) {
                        this.$Notice.warning({
                            desc: 'ファイル「' + files.name + '」のタイプがjpg、jpeg、png、gifではありません', duration: 6.5
                        })
                        checkPassed = false
                    }
                    if (checkPassed) {
                        this.http.uploadFiles('sys/noticeboard/upload/image', {
                            file: files,
                        }).then(res => {
                            let length = this.quill.getSelection().index
                            this.quill.insertEmbed(length, 'image', `${BASE_URL}${res.data}`)
                            this.quill.setSelection(length + 1)
                        })
                    }
                    return false
                },
                uploadNotice(hbtCfix) {
                    if (this.selectedPeople.length === 0) {
                        return this.$Notice.warning({ title: '注意', desc: '掲示範囲を選択してください', duration: 6.5 })

                    }
                    if (!this.updateValue.hbtCtitle) {
                        return this.$Notice.warning({ title: '注意', desc: '件名を入力してください', duration: 6.5 })

                    }
                    if (!this.updateValue.hbtDdateofannouncement) {
                        return this.$Notice.warning({ title: '注意', desc: '開始時間を入力してください', duration: 6.5 })

                    }
                    if (this.updateValue.hbtDdateofexpire && new Date(this.updateValue.hbtDdateofannouncement) > new Date(this.updateValue.hbtDdateofexpire)) {
                        return this.$Notice.warning({ title: '注意', desc: '掲示期間(終了時間)は(開始時間)より後の時刻を入力してください', duration: 6.5 })
                    }

                    if (!this.updateValue.hbtDdateofexpire) delete this.updateValue.hbtDdateofexpire
                    this.$Modal.confirm({
                        inDrawer: true,
                        title: '注意',
                        width: 480,
                        content: '投稿します。よろしいですか？',
                        okText: 'OK',
                        cancelText: 'キャンセル',
                        onOk: async () => {
                            try {
                                this.loading = true
                                let opts ={
                                    attachments: this.uploadFiles.filter(e=> !e.isDefault),
                                    ...this.updateValue,
                                    hbtCcontents: this.$refs.editor.children[0].innerHTML,
                                    sendRangeTypes: this.searchRange.join(),
                                    keepAttachmentIdStr: this.uploadFiles.filter(e=> e.isDefault).map(e=>e.hbtfId).join(),
                                    deleteAttachmentIdStr: this.deleteFiles.join(),
                                    empRangeIds: this.selectedPeople.map(e => e.key).join(),
                                    hbtCfix: hbtCfix,
                                }
                                if(this.isEditing) {
                                    opts.hbtId = this.editId
                                }
                                await this.http.uploadFiles('sys/noticeboard/draft/addOrUpdate', opts)
                                this.$Message.success(hbtCfix === '1' ? '投稿完了' : '一時保存完了')
                                this.resetDraft()
                                this.getTableData()
                            } catch (error) {
                                console.log(error)
                            } finally {
                                this.loading = false
                            }
                        }
                    })
                },
                resetDraft() {
                    this.isAdding = false
                    this.isEditing = false
                    this.updateValue = {
                        hbtCheaddisp: '0'
                    }
                    this.uploadFiles = []
                    this.deleteFiles = []
                    this.searchRange = ''
                    this.selectedPeople = ''
                    this.selectedPeopleText = ''
                    this.quill.setText('');
                    // 修正当富文本内有图像时，点击后，残留裁剪边框的bug
                    const quillImgCutFrame = document.querySelector('.ql-tooltip.ql-hidden').nextSibling
                    if(quillImgCutFrame) {
                        quillImgCutFrame.style.display = 'none'
                    }
                },
                handleDelFile(file) {
                    // 删除文件
                    if(file.isDefault) this.deleteFiles.push(file.hbtfId)
                    this.uploadFiles = this.uploadFiles.filter(e => e.name !== file.name)
                },
                handleClickEmoji(emoji) {
                    let length = this.quill.selection.savedRange.index
                    this.quill.insertEmbed(length, 'span', emoji)
                    this.quill.setSelection(length + 1)
                    // this.emojiPop = false
                },
                handleScroll: Throttle(function (e) {
                    this.contentScrollTop = e.target.documentElement.scrollTop || e.target.body.scrollTop
                }, 50)
            }
        })
    </script>
</body>