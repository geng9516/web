<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head
    th:replace="layout/header::common_header(title='就業登録',cssPaths='/pages/content.min.css')">
</head>

<body>
    <div th:replace="layout/loadingBar::loadingBar"></div>
    <main class="content monthWorkConfirm-warp">
        <div class="content_head">
            <div class="header">
                <div class="title1">
                    <h1>
                        <Icon type="i-emeer colored"></Icon>
                        就業登録
                    </h1>
                </div>
<!--                <div class="btnbox">-->
<!--                    <span style="flex:1"></span>-->
<!--                    <p class="pr15" style="height: 40px;line-height: 45px;font-size: 16px;font-weight: bold;">-->
<!--                        {{ `現在の承認状況： ${isConfirm ? '承認済' : '未承認'}` }}-->
<!--                    </p>-->
<!--                    &lt;!&ndash; 就业承认的部分 &ndash;&gt;-->
<!--                    &lt;!&ndash; <i-button type="primary" size="large" @click="isConfirm = !isConfirm" v-if="isAdmin">-->
<!--                        {{ isConfirm ? '承認解除' : '月次承認' }}-->
<!--                      </i-button> &ndash;&gt;-->
<!--                    <i-button type="primary" size="large">月次報告</i-button>-->
<!--                </div>-->
            </div>
            <div class="searchwrap">
                <span class="label">年月</span>
                <i-select v-model="model1" :disabled="!selectDisabled" class="mr30" @on-change="handleStartMonth($event)"
                          placeholder="選択ください">
                    <i-option v-for="(item, index) of dispMonthlyList" :key="index" :label="item.val":value="item.val">
                    </i-option>
                </i-select>
            </div>
        </div>
        <div class="content_body">
<!--            <div class="table-top">-->
<!--                <Row :gutter="16" class="mb10">-->
<!--                    <i-Col span="11">-->
<!--                        <i-button type="text" @click="preMonth">-->
<!--                            <Icon type="ios-arrow-back"></Icon>-->
<!--                            前月-->
<!--                        </i-button>-->
<!--                        <i-button type="text" @click="nextMonth">-->
<!--                            翌月-->
<!--                            <Icon type="ios-arrow-forward"></Icon>-->
<!--                        </i-button>-->
<!--                    </i-Col>-->
<!--                    <i-Col span="13" class="tr">-->
<!--                        <i-button type="primary" class="mr5" ghost icon="md-add-circle"-->
<!--                            @click="download(2)">勤務表印刷</i-button>-->
<!--                    </i-Col>-->
<!--                </Row>-->
<!--            </div>-->

            <div class="titlenorm mb10 " style="font-size:15px">
                <Icon type="logo-buffer"></Icon>
                就業実績
            </div>
            <div class="month-sum tl">

                <div class="son" v-for="(item, i) of monthlyTilteMapList" :key="i">
                    <span class="label-monthSum">{{item.title | turnLine}}</span>
                    <span class="num">{{monthlyMap[item.key]}}</span>
                </div>

            </div>
            <i-table class="long-table" @on-row-click="showDay(arguments)" border :columns="columns"
                :row-class-name="rowClass" :disabled-hover="true" :data="data" :loading="loading">
                <template slot-scope="{ row }" slot="TDA_DYYYYMMDD_DD">
                    <span :class="dayRed(row)">{{ row.TDA_DYYYYMMDD_DD }}</span>
                </template>
                <template slot-scope="{ row }" slot="TDA_DYYYYMMDD_DY">
                    <span :class="dayRed(row)">{{ row.TDA_DYYYYMMDD_DY }}</span>
                </template>
                <template slot-scope="{ row }" slot="TDA_CWORKINGID_R_NAME">
                    <span :class="dayRed(row)">{{ row.TDA_CWORKINGID_R_NAME }}</span>
                </template>
                <template slot-scope="{ row }" slot="TDA_CSTATUSFLG_NAME">
                    <span v-if="row.TDA_CSTATUSFLG_NAME === '待'" class="confirm-sytle ing">待</span>
                    <span v-if="row.TDA_CSTATUSFLG_NAME === '済'" class="confirm-sytle">済</span>
                    <span v-if="row.TDA_CSTATUSFLG_NAME === 'エ'" class="confirm-sytle undo">エ</span>
                </template>
                <template slot-scope="{ row }" slot="TDA_CNTFSTATUSFLG_NAME">
                    <span v-if="row.TDA_CNTFSTATUSFLG_NAME === '待'" class="confirm-sytle ing">待</span>
                    <span v-if="row.TDA_CNTFSTATUSFLG_NAME === '済'" class="confirm-sytle">済</span>
                    <span v-if="row.TDA_CNTFSTATUSFLG_NAME === 'エ'" class="confirm-sytle undo">エ</span>
                </template>
            </i-table>
        </div>
    </main>
    <div th:replace="layout/script::common_script"></div>
    <script type="text/babel" th:inline="javascript">
        const WORK_YEAR_SCHEDULE = new Vue({
            // 特别注意要对上这个class
            el: '.monthWorkConfirm-warp',
            data() {
                return {
                    today:'',
                    selectDisabled: false,   　//年月選択可否制御
                    dispMonthlyList: [],       //年月リスト
                    model1: '',
                    targetUser:'',
                    monthlyTilteMapList:[],
                    monthlyMap:[],

                    query: {
                        txtAction: 'ACT_Disp_RList',
                        txtDYYYYMM: '2020/04/01',
                        txtDYYYYMMDD: '',
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        psApp: Utils.getUrlParam(location.href, 'psApp')
                    },

                    curDate: new Date(),
                    isConfirm: false,
                    loading: false,
                    columns:[] ,
                    data:[] ,
                    // monthlyTilteMapList:[[${monthlyTilteMapList }]],
                    // monthlyMap:[[${monthlyMap }]],

                    monthSum: {},
                    dailyShow: true,
                    rawData: [],
                    selectedData: {
                        obj: {},
                        date: ''
                    },
                    isShow: false,
                    index: 0,
                    isConfirm: false,
                    comment: ''

                }
            },
            async mounted() {
                this.init()
            },
            created() {
                console.log(this.monthlyTilteMapList)
                console.log(this.monthlyMap)
            },
            computed: {
            },
            methods: {
                async init() {

                    try {
                        // 今日日付取得
                        // await this.getToDay()
                        // 勤務年月一覧取得
                        await this.getWorkDateList()
                        await this.monthAndDaily()

                    } catch (error) {
                        return
                    } finally {
                        this.loading = false

                    }
                },
                // 今日日付取得
                async getToDay() {
                    this.query.txtAction = 'ACT_DISP_RMONTHLY'
                    const { data } = await this.http.get('sys/tmgResults/getToday', this.query)

                },
                // 勤務年月一覧取得
                async getWorkDateList() {
                    this.query.txtAction = 'ACT_DISP_RMONTHLY'
                    this.loading = false
                    const { data } = await this.http.get('sys/tmgResults/workDateList', this.query)

                    this.today=data.today.today
                    this.dispMonthlyList = data.monthLy
                    console.log(this.dispMonthlyList)


                    if (data.monthLy.length > 0){
                        this.model1 = this.dispMonthlyList[0].val

                        let result = this.model1.replace("年","/")
                        result = result.replace("月","/")
                        result = result + "01"
                        this.query.txtDYYYYMM = result

                        //年月リストを取得する時に、活性化にする
                        this.selectDisabled = true
                    }

                    //年月リスト.lengthがゼロ場合、非活性化にする
                    if (data.monthLy.length === 0){
                        this.model1 = ''
                        this.selectDisabled = false
                    }
                },
                // 年月選択
                async handleStartMonth(e) {
                    this.query.txtAction = 'ACT_DISP_RMONTHLY'
                    this.query.txtDYYYYMM = this.dateFormat(e)
                    this.query.txtDYYYYMMDD = this.today
                    // 就業実績 --月次実績
                    await this.getMonthlyData()
                    await this.getDailyData()
                },
                //就業実績（月次・日次）
                async monthAndDaily() {
                    this.query.txtAction = 'ACT_DISP_RMONTHLY'
                    this.query.txtDYYYYMM =  this.dateFormat(this.model1)
                    this.query.txtDYYYYMMDD = this.today
                    // 就業実績 --月次実績
                    await this.getMonthlyTitleData()
                    // 就業実績 --日次実績
                    await this.getDailyTitleData()

                },
                dateFormat(e) {
                    //YYYY年MM月からYYYY/MM/01へ変換する
                    let yearMMDD = e.replace("年","/")
                    yearMMDD = yearMMDD.replace("月","/")
                    yearMMDD = yearMMDD+"01"
                    return  yearMMDD
                },
                async getMonthlyTitleData() {
                    const { data } = await this.http.get('sys/tmgResults/getMonthlyData', this.query)

                    console.log(data)
                    // this.fullName = data.dispItemsList.slice(0,1)[0].title
                    this.monthlyTilteMapList = data.monthlyTilteMapList
                    this.monthlyMap = data.monthlyDateMap
                },
                async getDailyTitleData() {
                    this.loading　= true
                    const { data } = await this.http.get('sys/tmgResults/getDailyData', this.query)

                    console.log(data)

                    this.columns = data.dailyTittleMapList.map(e=> {
                        return {
                            ...e,
                            title: e.title.replace(TURN_LINE_STR, '\n')
                        }
                    })

                    this.data = data.dailyMapList
                    this.loading　= false
                },
                async getMonthlyData() {
                    const { data } = await this.http.get('sys/tmgResults/getMonthlyData', this.query)

                    this.monthlyMap = data.monthlyDateMap
                },
                async getDailyData() {
                    this.loading　= true
                    const { data } = await this.http.get('sys/tmgResults/getDailyData', this.query)
                    this.data = data.dailyMapList
                    this.loading　= false

                },







                handleDatePicker() { },
                rowClass(row) {
                    // 不可点击得时候，表格变色
                    // if (!row.memberDivisionCode || (!this.isEmployer && this.monthConfirmFlag)) {
                    //   if (row.dayDivisionCode === '4') {
                    //     return 'sun'
                    //   }
                    //   // 第一条避免错误数据被染上sat色
                    //   if (row.dayDivisionCode && row.dayDivisionCode !== '1') {
                    //     return 'sat'
                    //   }
                    //   return ''
                    // }
                    // 可点击得时候，表格变色
                    if (row.today) {
                        return 'select-col sun'
                    }
                    if (!row.dayDivisionCode || row.dayDivisionCode === '1') {
                        return 'select-col'
                    }
                    return 'select-col sat'
                },
                dayRed(e) {
                    const dayOfWeek = e.TDA_DYYYYMMDD_DY
                    if (!dayOfWeek) {
                        return
                    }
                    if (dayOfWeek.trim() === '土' || dayOfWeek.trim() === '日') {
                        return 'blue'
                    }
                    if (e.today) {
                        return 'brown'
                    }
                },
                showDay: Debounce(function () {
                    this.isShow = true
                }),
                preMonth() {
                },
                nextMonth() {
                },
                download(type) {
                },
                refresh() {
                }
            }
        })
    </script>
</body>

</html>