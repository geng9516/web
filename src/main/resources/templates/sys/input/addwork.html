<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head
        th:replace="layout/header::common_header(title='就業登録',cssPaths='/pages/content.min.css,' + '/pages/vacation.min.css')">
</head>

<body>
<div th:replace="layout/loadingBar::loadingBar"></div>
<main class="content monthWorkConfirm-warp" @scroll.passive="handleScroll" ref="layout">
    <div class="content_head">
        <div class="header">
            <div class="title1">
                <h1>
                    <Icon type="i-emeer colored"></Icon>
                    就業登録
                </h1>
            </div>
            <div class="btnbox">
                <span style="flex:1"></span>
                <p class="pr15" style="height: 40px;line-height: 45px;font-size: 16px;font-weight: bold;">
                    {{ `現在の承認状況： ${isConfirm==='TMG_DATASTATUS|5' ? '承認済' : '未承認'}` }}
                </p>
            </div>
        </div>
        <div class="searchwrap">
            <span class="label">年月</span>
            <i-select v-model="model1" :disabled="!selectDisabled" class="mr30" @on-change="handleStartMonth($event)"
                      placeholder="選択ください">
                <i-option v-for="(item, index) of dispMonthlyList" :key="index" :label="item.val" :value="item.code">
                </i-option>
            </i-select>
        </div>
    </div>
    <div class="content_body">

        <div class="titlenorm mb10 " style="font-size:15px">
            <Icon type="logo-buffer"></Icon>
            就業実績
        </div>
        <div class="month-sum tl">

            <div class="son" v-for="(item, i) of monthlyTilteMapList" :key="i">
                <span class="label-monthSum">{{item.title | turnLine}}</span>
                <span class="num">{{monthlyMap[item.key]}}</span>
            </div>

        </div>
        <i-table :class="tableHeadFixed ? 'table-head-fixed long-table' : 'long-table'"
                 @on-row-click="showDay(arguments)" border :columns="columns"
                 :row-class-name="rowClass" :disabled-hover="true" :data="dailyDataList" :loading="loading"
                 no-data-text="勤怠シート未作成">
            <template slot-scope="{ row }" slot="TDA_DYYYYMMDD_DD">
                <span :class="dayRed(row)">{{ row.TDA_DYYYYMMDD_DD }}</span>
            </template>
            <template slot-scope="{ row }" slot="TDA_DYYYYMMDD_DY">
                <span :class="dayRed(row)">{{ row.TDA_DYYYYMMDD_DY }}</span>
            </template>
            <template slot-scope="{ row }" slot="TDA_CWORKINGID_R_NAME">
                <span :class="dayRed(row)">{{ row.TDA_CWORKINGID_R_NAME }}</span>
            </template>
            <template slot-scope="{ row }" slot="TDA_CSTATUSFLG_NAME">
                <span v-if="row.TDA_CSTATUSFLG_NAME === '待'" class="confirm-sytle ing">待</span>
                <span v-if="row.TDA_CSTATUSFLG_NAME === '済'" class="confirm-sytle">済</span>
                <span v-if="row.TDA_CSTATUSFLG_NAME === 'エ'" class="confirm-sytle undo">エ</span>
            </template>
            <template slot-scope="{ row }" slot="TDA_CNTFSTATUSFLG_NAME">
                <span v-if="row.TDA_CNTFSTATUSFLG_NAME === '待'" class="confirm-sytle ing">待</span>
                <span v-if="row.TDA_CNTFSTATUSFLG_NAME === '済'" class="confirm-sytle">済</span>
                <span v-if="row.TDA_CNTFSTATUSFLG_NAME === 'エ'" class="confirm-sytle undo">エ</span>
            </template>
        </i-table>
    </div>

    <!--日次就業実績-->
    <Drawer :title="title" width="800" v-model="isShow" @on-close="handleClose()" draggable>
        <div class="content_body">
            <Alert type="error" class="error-info" v-show="errorFlag">{{ errorMsg }}</Alert>
            <Row class="mb15 tr">
                <i-col span="6" offset="15">
                    <i-button type="primary" ghost class="mr15" v-if="!bFixed" @click="updateInp">コメントのみ登録</i-button>
                </i-col>
                <i-col span="3">
                    <i-button type="primary" ghost v-if="!bFixed" @click="updateDaily" :loading="updateDailyLoading">
                        登録
                    </i-button>
                </i-col>
            </Row>
            <div class="titlenorm mb10">
                <Icon type="logo-buffer"></Icon>
                就業実績
            </div>
            <div style="position: relative;">
                <Row>
                    <i-col span="8" class="label tc">就業区分</i-col>
                    <i-col span="8" class="no-border-radius">
                        <i-select v-model="workingId" class="mr30" @on-change="changeWorkingID"
                                  v-if="((!bHoliday && !bFixed) || ( isEdiTableResult4Inp && !bFixed))">
                            <i-option v-for="(item, index) of workingIdList" :key="index"
                                      :label="item.mgdCgenericdetaildesc" 　:value="item.mgdCmastercode">
                            </i-option>
                        </i-select>
                        <p v-else align="center">{{dailyEdit.tdaCworkingidRName}}</p>
                    </i-col>
                </Row>
                <Row>
                    <i-col span="8" class="label tc">出張</i-col>
                    <i-col span="8" class="no-border-radius" v-if="!bDisable">
                        <i-select v-model="businessTrip" class="mr30" @on-change="" v-if="(!bHoliday && !bFixed)">
                            <i-option v-for="(item, index) of businessTripList" :key="index"
                                      :label="item.mgdCgenericdetaildesc" 　:value="item.mgdCmastercode">
                            </i-option>
                        </i-select>
                        <p v-else align="center">{{dailyEdit.tdaCbusinesstripidRName}}</p>
                    </i-col>
                    <i-col span="8" class="no-border-radius" v-else>
                        <i-select v-model="businessTrip" class="mr30" @on-change="" disabled
                                  v-if="(!bHoliday && !bFixed)">
                            <i-option v-for="(item, index) of businessTripList" :key="index"
                                      :label="item.mgdCgenericdetaildesc" 　:value="item.mgdCmastercode">
                            </i-option>
                        </i-select>
                        <p v-else align="center">{{dailyEdit.tdaCbusinesstripidRName}}</p>
                    </i-col>
                </Row>
                <i-table :columns="columnsWork" :data="workData">
                    <template slot-scope="{ row }" slot="workStart">
                        <i-input v-model="row.workStart"
                                 v-if="row.isInput && !bFixed && isEdiTableResult4Inp"></i-input>
                        <span v-else>{{ row.workStart | toTime }}</span>
                    </template>
                    <template slot-scope="{ row }" slot="workEnd">
                        <i-input v-model="row.workEnd" v-if="row.isInput && !bFixed && isEdiTableResult4Inp"></i-input>
                        <span v-else>{{ row.workEnd | toTime }}</span>
                    </template>

                </i-table>


                <Row>
                    <i-col span="8" class="label tc">本人コメント</i-col>
                    <i-col span="16">
                        <i-input v-model="dailyEdit.tdaCowncommentR" text-align="center;" type="textarea"
                                 v-if="!bFixed"></i-input>
                        <i-input v-model="dailyEdit.tdaCowncommentR" text-align="center;" type="textarea" v-else
                                 readonly></i-input>
                    </i-col>
                </Row>
                <Row class="mb5">
                    <i-col span="8" class="label tc">承認者コメント</i-col>
                    <i-col span="16">
                        <span v-if="bApproved">{{ dailyEdit.tdaCmodifieruseridR}} ({{dailyEdit.tdaDmodifieddateR }})</span>
                        <i-input v-model="dailyEdit.tdaCbosscommentR" text-align="center;" type="textarea"
                                 readonly></i-input>
                        <!--                        <span >{{ dailyEdit.tdaCbosscommentR }}</span>-->
                    </i-col>
                </Row>
                <Spin size="large" fix v-if="workDataLoading"></Spin>
            </div>


            <!-- 非勤務 -->
            <div class="titlenorm mb10">
                <Icon type="logo-buffer"></Icon>
                非勤務
            </div>
            <Row class="mb15 tr" v-if=" !bHoliday && !bFixed ">
                <i-col span="6" offset="15">
                    <i-select v-model="categoryNonduty" class="mr30" @on-change="" v-if="!bDisable">
                        <i-option v-for="(item, index) of categoryNondutyList" :key="index" :label="item.itemName"
                                  　:value="item.itemCode">
                        </i-option>
                    </i-select>
                    <i-select v-model="categoryNonduty" class="mr30" @on-change="" disabled v-else>
                        <i-option v-for="(item, index) of categoryNondutyList" :key="index" :label="item.itemName"
                                  　:value="item.itemCode">
                        </i-option>
                    </i-select>
                </i-col>
                <i-col span="3">
                    <i-button type="primary" ghost @click="addNotWork" v-if="!bDisable">追加</i-button>
                    <i-button type="primary" ghost @click="addNotWork" disabled v-else>追加</i-button>
                </i-col>
            </Row>
            <i-table :columns="columnsNotWork" :data="detailNonDutyVOList" class="mb20"
                     :loading="columnsNotWorkLoading">
                <template slot-scope="{ row, index }" slot="tdadNopen">
                    <i-input v-model="detailNonDutyVOList[index].tdadNopen" v-if=" !bFixed" @on-blur="detailNonDutyVOList[index].tdadNopen=toHHHcMI60FromHHHMI60(detailNonDutyVOList[index].tdadNopen)"></i-input>
                    <span v-else>{{  row.tdadNopen | toTime  }}</span>
                </template>

                <template slot-scope="{ row, index }" slot="tdadNclose">
                    <i-input v-model="detailNonDutyVOList[index].tdadNclose" v-if="!bFixed " @on-blur="detailNonDutyVOList[index].tdadNclose=toHHHcMI60FromHHHMI60(detailNonDutyVOList[index].tdadNclose)"></i-input>
                    <span v-else>{{ row.tdadNclose | toTime }}</span>
                </template>

                <template slot-scope="{ row ,index}" slot="tdadCsparechar1">
                    <i-input v-model="detailNonDutyVOList[index].tdadCsparechar1" type="textarea"
                             :autosize="{ maxRows: 3 }"
                             v-if="row.tdadCnotworkid !== 'TMG_ITEMS|ResultRest' && !bFixed "></i-input>
                    <span v-else>{{ row.tdadCsparechar1 | toTime }}</span>
                </template>

                <template slot-scope="{ row }" slot="tdadNdeleteflg" v-if="!bFixed">
                    <i-button type="error" ghost size="small" class="width100" @click="delNotWork(row)">削除</i-button>
                </template>
            </i-table>

            <!-- 超過勤務 -->
            <div class="titlenorm mb10">
                <Icon type="logo-buffer"></Icon>
                超過勤務
            </div>
            <Row class="mb15 tr" v-if="!bHoliday && !bFixed ">

                <i-col span="6" offset="15">
                    <i-select v-model="categoryOverhours" class="mr30" @on-change="" v-if="!bDisable">
                        <i-option v-for="(item, index) of categoryOverhoursList" :key="index" :label="item.itemName"
                                  　:value="item.itemCode">
                        </i-option>
                    </i-select>
                    <i-select v-model="categoryOverhours" class="mr30" @on-change="" disabled v-else>
                        <i-option v-for="(item, index) of categoryOverhoursList" :key="index" :label="item.itemName"
                                  　:value="item.itemCode">
                        </i-option>
                    </i-select>
                </i-col>

                <i-col span="3">
                    <i-button type="primary" ghost @click="addOverWork" v-if="!bDisable">追加</i-button>
                    <i-button type="primary" ghost @click="addOverWork" disabled v-else>追加</i-button>
                </i-col>
<!--                <i-col span="4">-->
<!--                    <i-button type="primary" ghost v-if="!bDisable">時刻補完</i-button>-->
<!--                    <i-button type="primary" ghost disabled v-else>時刻補完</i-button>-->
<!--                </i-col>-->
            </Row>

            <i-table :columns="columnsOverWork" :data="detailOverhoursVOList" class="mb20"
                     :loading="columnsOverWorkLoading">
                <template slot-scope="{ row ,index }" slot="tdadNopen">
                    <i-input v-model="detailOverhoursVOList[index].tdadNopen" v-if=" !bFixed" @on-blur="detailOverhoursVOList[index].tdadNopen=toHHHcMI60FromHHHMI60(detailOverhoursVOList[index].tdadNopen)"></i-input>
                    <span v-else>{{ row.tdadNopen | toTime }}</span>
                </template>

                <template slot-scope="{ row ,index}" slot="tdadNclose">
                    <i-input v-model="detailOverhoursVOList[index].tdadNclose" v-if=" !bFixed" @on-blur="detailOverhoursVOList[index].tdadNclose=toHHHcMI60FromHHHMI60(detailOverhoursVOList[index].tdadNclose)"></i-input>
                    <span v-else>{{ row.tdadNclose | toTime }}</span>
                </template>

                <template slot-scope="{ row ,index}" slot="tdadCsparechar1">
                    <i-input v-model="detailOverhoursVOList[index].tdadCsparechar1" type="textarea"
                             :autosize="{ maxRows: 3 }"
                             v-if="!bFixed"></i-input>
                    <span v-else>{{ row.tdadCsparechar1}}</span>
                </template>

                <template slot-scope="{ row ,index}" slot="tdadNdeleteflg" v-if="!bFixed">
                    <i-button type="error" ghost size="small" class="width100" @click="delOverWork(row)">削除</i-button>
                </template>
            </i-table>

            <div class="titlenorm mb10">
                <Icon type="logo-buffer"></Icon>
                <a @click="showLog"> 更新履歴</a>
            </div>
            <i-table :columns="columnsDailyLog" :data="dailyLog" class="mb20" v-if="isLogShow">

            </i-table>
        </div>
    </Drawer>
    <span class="toTopBtn" @click="toTop" v-show="isScroll">
            <Icon size="24" type="md-arrow-round-up"/>
    </span>
</main>
<div th:replace="layout/script::common_script"></div>
<script type="text/babel" th:inline="javascript">
    const WORK_YEAR_SCHEDULE = new Vue({
        // 特别注意要对上这个class
        el: '.monthWorkConfirm-warp',
        data() {
            return {
                contentScrollTop: 0,
                isScroll: false,

                selectDisabled: false,   　//年月選択可否制御
                dispMonthlyList: [],       //年月リスト
                model1: '',
                targetUser: '',
                monthlyTilteMapList: [],
                monthlyMap: [],
                columns: [],
                dailyDataList: [],
                data: [],
                loading: false,
                query: {
                    txtAction: 'ACT_DISP_RMONTHLY',
                    txtDYYYYMM: '2020/04/01',
                    txtDYYYYMMDD: '',
                    today: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp')
                },
                updateInpQuery: {
                    txtAction: 'ACT_EDITINP_UCOMMENT',
                    holiday: false,
                    txtTdaNopenR: '',
                    txtTdaNcloseR: '',
                    workingId: '',
                    selMgdCbusinessTrip: '',
                    txtDYYYYMMDD: '',
                    tdaCowncommentR: '',
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                    psApp: Utils.getUrlParam(location.href, 'psApp')
                },
                tmgResultsDto: {
                    txtAction: '',
                    holiday: false,
                    txtTdaNopenR: '',
                    txtTdaNcloseR: '',
                    workingId: '',
                    selMgdCbusinessTrip: '',
                    txtDYYYYMMDD: '',
                    tdaCowncommentR: '',
                    nonDutyList: [],
                    overHoursList: [],
                    hasAuthority: true,
                    psSite: Utils.getUrlParam(location.href, 'psSite'),
                },
                workingId: '',
                workingIdList: [],
                businessTrip: '',
                businessTripList: [],
                categoryNonduty: '',
                categoryNondutyName: '',
                categoryNondutyList: [],
                categoryOverhours: '',
                categoryOverhoursName: '',
                categoryOverhoursList: [],
                dailyEdit: {
                    noOvertimeDaysMsg: '',
                    ntime: '',
                    tdaCbosscommentR: '',
                    tdaCbusinesstripidR: '',
                    tdaCbusinesstripidRName: '',
                    tdaCcommentO: '',
                    tdaCerrcode: '',
                    tdaCmodifieruseridR: '',
                    tdaCowncommentR: '',
                    tdaCstatusflg: '',
                    tdaCworkingidR: '',
                    tdaCworkingidRBame: '',
                    tdaDmodifieddateR: '',
                    tdaDyyyymmdd: '',
                    tdaDyyyymmddDy: '',
                    tdaNcloseN: '',
                    tdaNcloseO: '',
                    tdaNcloseP: '',
                    tdaNclosePAtRest45: '',
                    tdaNcloseR: '',
                    tdaNcloseRHidden: '',
                    tdaNcloseTp: '',
                    tdaNopenN: '',
                    tdaNopenO: '',
                    tdaNopenP: '',
                    tdaNopenR: '',
                    tdaNopenRHidden: '',
                    tdaNopenTp: '',
                    tdaNrest45P: '',
                    tdaNrestcloseR: '',
                    tdaNrestopenR: ''
                },

                isShow: false,
                title: {
                    type: String,
                    default: ''
                },
                width: {
                    type: [String, Number],
                    default: 650
                },
                isAdmin: {
                    type: Boolean,
                    default: false
                },
                errorFlag: false,
                errorMsg: '',
                columnsWork: [
                    {
                        title: '勤務時間',
                        align: 'center',
                        key: 'workTime'
                    },
                    {
                        title: '始業',
                        slot: 'workStart',
                        align: 'center'
                    },
                    {
                        title: '終業',
                        slot: 'workEnd',
                        align: 'center'
                    }
                ],
                columnsNotWork: [
                    {
                        title: '内容',
                        align: 'center',
                        width: '120',
                        key: 'itemName'
                    },
                    {
                        title: '開始時刻',
                        width: '80',
                        slot: 'tdadNopen',
                        align: 'center'
                    },
                    {
                        title: '終了時刻',
                        slot: 'tdadNclose',
                        width: '80',
                        align: 'center'
                    },
                    {
                        title: '備考',
                        slot: 'tdadCsparechar1',
                        align: 'center'
                    },
                    {
                        title: '削除',
                        slot: 'tdadNdeleteflg',
                        width: '80',
                        align: 'center'
                    }
                ],
                detailNonDutyVOList: [],
                columnsOverWork: [
                    {
                        title: '内容',
                        align: 'center',
                        width: '120',
                        key: 'itemName'
                    },
                    {
                        title: '開始時刻',
                        width: '80',
                        slot: 'tdadNopen',
                        align: 'center'
                    },
                    {
                        title: '終了時刻',
                        slot: 'tdadNclose',
                        width: '80',
                        align: 'center'
                    },
                    {
                        title: '用務内容',
                        slot: 'tdadCsparechar1',
                        align: 'center'
                    },
                    {
                        title: '状態',
                        key: 'tdadCsparechar2Name',
                        align: 'center'
                    },
                    {
                        title: '削除',
                        slot: 'tdadNdeleteflg',
                        width: '80',
                        align: 'center'
                    }
                ],
                detailOverhoursVOList: [],
                columnsDailyLog: [
                    {
                        title: '更新者',
                        key: 'cmodifierusernm',
                        width: '120'
                    },
                    {
                        title: '更新日時',
                        key: 'dmodifieddate',
                        width: '140',
                        align: 'center'
                    },
                    {
                        title: '画面',
                        key: 'cmodifierprogramnm',
                        width: '100',
                        align: 'center'

                    },
                    {
                        title: '操作',
                        key: 'cactionnm',
                        width: '130',
                        align: 'center'
                    },
                    {
                        title: '更新内容',
                        key: 'cchangelogstr'
                    }
                ],
                dailyLog: [],
                notWorkType: 1,
                dailyData: {},
                workData0: [],
                mgdCsparechar4VOList: [],
                workDataLoading: false,
                columnsNotWorkLoading: false,
                columnsOverWorkLoading: false,
                bHoliday: false,
                bFixed: false,
                isEdiTableResult4Inp: false,
                isCommonDiscretionaryLabor: false,
                bOpen: false,
                bClose: false,
                // 承認者コメントの入力制御
                bApproved: false,

                txtDYYYYMMDD: '',
                index: 0,
                // 承認ステータス
                isConfirm: '',
                // 更新履歴の表示制御
                isLogShow: false,
                updateDailyLoading: false,
                // 就業区分切替の表示制御
                bDisable: false,
                overHourLimit: '',
                otDaily:'',
                targetForOverTime: '',
                errMsg: []


            }
        },
        async mounted() {
            this.init()
        },
        created() {
        },
        computed: {
            tableHeadFixed() {
                if (this.contentScrollTop > 310) return true
                else return false
            },
            workData() {

                let result = [
                    {
                        workTime: '予定時間',
                        workStart: this.dailyEdit.tdaNopenN,
                        workEnd: this.dailyEdit.tdaNcloseN,
                        cellClassName: {
                            workTime: 'sub-title'
                        }
                    },
                    {
                        workTime: '打刻',
                        workStart: this.dailyEdit.tdaNopenTp,
                        workEnd: this.dailyEdit.tdaNcloseTp,
                        cellClassName: {
                            workTime: 'sub-title'
                        }
                    },
                    {
                        workTime: '就業時間',
                        workStart: this.dailyEdit.tdaNopenR,
                        workEnd: this.dailyEdit.tdaNcloseR,
                        isInput: true,
                        cellClassName: {
                            workTime: 'sub-title'
                        }
                    }
                ]
                this.workData0.forEach(e => {
                    result = result.concat(
                        {
                            workTime: e.tdadCnotworkName,
                            workStart: e.tdadNopenHhmi,
                            workEnd: e.tdadNcloseHhmi,
                            cellClassName: {
                                workTime: 'sub-title'
                            }
                        }
                    )
                })

                return result
            },
        },
        methods: {

            handleScroll: Throttle(function (e) {
                this.contentScrollTop = e.target.scrollTop
                if (e.target.scrollTop > 200) {
                    this.isScroll = true
                } else {
                    this.isScroll = false
                }
            }, 50),
            toTop() {
                const animateMachine = requestAnimationFrame(this.toTop)
                this.$refs.layout.scrollTop = this.$refs.layout.scrollTop - this.$refs.layout.scrollTop / 5
                if (this.$refs.layout.scrollTop === 0) {
                    cancelAnimationFrame(animateMachine)
                }
            },
            async init() {

                try {
                    // 今日日付取得
                    // 勤務年月一覧取得
                    await this.getWorkDateList()
                    await this.monthAndDaily()

                } catch (error) {
                    return
                } finally {
                    this.loading = false

                }
            },
            // 勤務年月一覧取得
            async getWorkDateList() {
                this.query.txtAction = 'ACT_DISP_RMONTHLY'
                this.loading = false
                const {data} = await this.http.get('sys/tmgResults/workDateList', this.query)

                this.query.today = data.today
                this.dispMonthlyList = data.monthLy


                if (data.monthLy.length > 0) {
                    this.model1 = this.dispMonthlyList[0].code
                    this.query.txtDYYYYMM = this.model1

                    //年月リストを取得する時に、活性化にする
                    this.selectDisabled = true
                }

                //年月リスト.lengthがゼロ場合、非活性化にする
                if (data.monthLy.length === 0) {
                    this.model1 = ''
                    this.selectDisabled = false
                }
            },
            // 年月選択
            async handleStartMonth(e) {
                this.query.txtAction = 'ACT_DISP_RMONTHLY'
                this.query.txtDYYYYMM = e
                this.query.txtDYYYYMMDD = this.query.today

                // 就業実績 --月次・日次実績
                await this.getTitleData()

            },
            //就業実績（月次・日次）
            async monthAndDaily() {
                this.query.txtAction = 'ACT_DISP_RMONTHLY'
                this.query.txtDYYYYMM = this.model1
                this.query.txtDYYYYMMDD = this.query.today

                // 就業実績 --月次・日次実績
                await this.getTitleData()

            },
            // 就業実績のタイトルとデータを取得
            async getTitleData() {
                this.loading = true
                this.query.txtAction = 'ACT_EDITINP_RDAILY'
                this.monthlyMap = ''
                this.dailyDataList = []
                const {data} = await this.http.get('sys/tmgResults/getTitleData', this.query)

                this.monthlyTilteMapList = data.monthlyTilteMapList
                this.monthlyMap = data.monthlyDateMap
                this.isConfirm = data.monthlyDateMap.TMO_CSTATUSFLG

                this.columns = data.dailyTittleMapList.map(e => {
                    return {
                        ...e,
                        title: e.title.replace(TURN_LINE_STR, '\n')
                    }
                })

                this.dailyDataList = data.dailyMapList
                this.loading = false

            },
            //一覧から日次実績をクリックする
            async showDay(e) {

                // 就業登録画面項目クリアする
                this.categoryNonduty = ''
                this.categoryOverhours = ''
                this.dailyEdit = []
                this.workData0 = []
                this.detailNonDutyVOList = []
                this.detailOverhoursVOList = []
                this.title = '  '
                this.query.txtDYYYYMMDD = e[0].TDA_DYYYYMMDD
                this.txtDYYYYMMDD = e[0].TDA_DYYYYMMDD
                this.query.txtAction = 'ACT_EDITINP_RDAILY'
                this.bFixed = false
                this.bHoliday = false

                // 業登録画面表示
                this.isShow = true

                // 業登録画面データ取得
                await this.dailyDetail()
            },

            // 就業登録画面情報取得・設定する
            async dailyDetail() {

                this.workDataLoading = true
                // 画面情報取得
                const {data} = await this.http.get('sys/tmgResults/dailyDetail', this.query)
                this.workDataLoading = false

                // 就業区分ドロップダウン
                this.workingIdList = data.workIdList
                // this.workingId = this.workingIdList[0].mgdCmastercode

                // 出張ドロップダウン
                this.businessTripList = data.businessTripList
                // this.businessTrip = this.businessTripList[0].mgdCmastercode


                // 非勤務ドロップダウン
                this.categoryNondutyList = data.categoryNondutyList
                this.categoryNonduty = this.categoryNondutyList[0].itemCode

                // 超過勤務ドロップダウン
                this.categoryOverhoursList = data.categoryOverhoursList
                this.categoryOverhours = this.categoryOverhoursList[0].itemCode
                this.mgdCsparechar4VOList = data.mgdCsparechar4VOList

                // 詳細:欠勤離籍以外
                this.workData0 = data.dailyDetail0List

                // 就業実績
                this.dailyEdit = data.dailyEditVO


                if (('TMG_DATASTATUS|9' === this.dailyEdit.tdaCstatusflg || 'TMG_DATASTATUS|5' === this.dailyEdit.tdaCstatusflg)
                    && '' !== this.dailyEdit.tdaCmodifieruseridR
                    && '' !== this.dailyEdit.tdaDmodifieddateR
                ) {
                    this.bApproved = true
                } else {
                    this.bApproved = false
                }

                // 登録ボタンとコメントのみ登録ボタンの表示制御
                this.bFixed = !data.isEditable
                if (data.workIdList.length < 2) {
                    this.bHoliday = true
                }

                //就業入力サイトでの就業実績編集機能を使用するか判定し値を返却します
                this.isEdiTableResult4Inp = data.isEdiTableResult4Inp

                this.isCommonDiscretionaryLabor = data.isCommonDiscretionaryLabor


                if (this.dailyEdit.tdaNopenR !== this.dailyEdit.tdaNopenTp) {
                    this.bOpen = true
                } else {
                    this.bOpen = false
                }
                if (this.dailyEdit.tdaNcloseR !== this.dailyEdit.tdaNcloseTp) {
                    this.bClose = true
                } else {
                    this.bClose = false
                }

                if (this.isEdiTableResult4Inp) {
                    this.dailyEdit.tdaNcloseR = this.dailyEdit.tdaNopenRHidden
                    this.dailyEdit.tdaNcloseR = this.dailyEdit.tdaNcloseRHidden
                }

                if (this.dailyEdit.tdaNopenTp === null) {
                    this.dailyEdit.tdaNopenTp = '---'
                }
                if (this.dailyEdit.tdaNcloseTp === null) {
                    this.dailyEdit.tdaNcloseTp = '---'
                }
                if (!this.isCommonDiscretionaryLabor) {
                    this.dailyEdit.tdaNopenN = '---'
                    this.dailyEdit.tdaNcloseN = '---'
                }

                this.workingId = this.dailyEdit.tdaCworkingidR
                this.changeWorkingID(this.workingId)
                this.businessTrip = this.dailyEdit.tdaCbusinesstripidR
                this.title = this.dailyEdit.tdaDyyyymmddDy

                if(this.dailyEdit.tdaCerrcode !== null){

                    let tempErrCode = JSON.parse(this.dailyEdit.tdaCerrcode)
                    Object.keys(tempErrCode).some(e => {

                        if (e === 'ERRTYPE_10') {

                            this.$Notice.error({desc: tempErrCode.ERRTYPE_10[0].ERRMSG})
                            return true
                        }
                    })

                }

                // 非勤務
                this.detailNonDutyVOList = data.detailNonDutyVOList
                // 超過勤務
                this.detailOverhoursVOList = data.detailOverhoursVOList
                //
                const turnLine = Vue.filter('turnLine');
                this.dailyLog = data.columnsDailyLog.map(e => {
                    return {
                        ...e,
                        cchangelogstr: turnLine(e.cchangelogstr)

                    }
                })
                let limitOfBasedateVO = data.limitOfBasedateVO

                this.overHourLimit = limitOfBasedateVO.dailyConvMinute
                this.otDaily = limitOfBasedateVO.otDaily
                this.targetForOverTime = data.targetForOverTime




            },

            handleClose() {
                this.errorFlag = false
                this.isShow = false
                this.$emit('close')
            },
            addOverWork() {
                let detailOverhoursVO = this.categoryOverhoursList.find(e => e.itemCode === this.categoryOverhours)

                this.detailOverhoursVOList.push({
                    attributeUrl: detailOverhoursVO.attributeUrl,
                    tdadCnotworkid: detailOverhoursVO.itemCode,
                    itemName: detailOverhoursVO.itemName,
                    tdadNopen: '',
                    tdadNclose: '',
                    tdadNdeleteflg: '0',
                    tdadSeq: Date.now(),
                    tdadCsparechar1: '',
                    tdadNsparenum1: '',
                    tdadCcode01: '',
                    tdadCcode01Name: '',
                    tdadCsparechar2: '',
                    tdadCsparechar2Name: ''

                })
            },
            addNotWork() {
                let categoryNondutyVO = this.categoryNondutyList.find(e => e.itemCode === this.categoryNonduty)

                this.detailNonDutyVOList.push({
                    attributeUrl: categoryNondutyVO.attributeUrl,
                    tdadCnotworkid: categoryNondutyVO.itemCode,
                    itemName: categoryNondutyVO.itemName,
                    tdadNdeleteflg: "0",
                    tdadNopen: '',
                    tdadNclose: '',
                    tdadSeq: Date.now(),
                    tdadCsparechar1: '',
                    tdadNsparenum1: null

                })

            },
            delNotWork(row) {
                this.detailNonDutyVOList = this.detailNonDutyVOList.filter(e => e.tdadSeq !== row.tdadSeq)
            },
            delOverWork(row) {
                this.detailOverhoursVOList = this.detailOverhoursVOList.filter(e => e.tdadSeq !== row.tdadSeq)
            },
            //コメントのみ登録
            updateInp: Debounce(function () {
                this.tmgResultsDto.txtAction = 'ACT_EDITINP_UCOMMENT'
                this.tmgResultsDto.holiday = this.bHoliday
                this.tmgResultsDto.workingId = this.workingId
                this.tmgResultsDto.txtDYYYYMMDD = this.txtDYYYYMMDD
                this.tmgResultsDto.selMgdCbusinessTrip = this.businessTrip
                this.tmgResultsDto.txtTdaNopenR = this.dailyEdit.tdaNopenR
                this.tmgResultsDto.txtTdaNcloseR = this.dailyEdit.tdaNcloseR
                this.tmgResultsDto.tdaCowncommentR = this.dailyEdit.tdaCowncommentR

                this.http.post('sys/tmgResults/updateInp', this.tmgResultsDto)
                this.isShow = false
            }),
            //登録
            async updateDaily() {

                if (!this.errorCheck()) {
                    return
                }

                this.updateDailyLoading = true

                this.tmgResultsDto.txtDYYYYMMDD = this.txtDYYYYMMDD
                this.tmgResultsDto.txtAction = 'ACT_EDITINP_UDAILY'

                this.tmgResultsDto.workingId = this.workingId
                this.tmgResultsDto.selMgdCbusinessTrip = this.businessTrip
                this.tmgResultsDto.holiday = null
                this.tmgResultsDto.txtTdaNopenR = ''
                this.tmgResultsDto.txtTdaNcloseR = ''
                this.tmgResultsDto.tdaCowncommentR = ''
                this.tmgResultsDto.hasAuthority = ''

                if (!this.bDisable) {
                    this.tmgResultsDto.holiday = this.bHoliday

                    this.tmgResultsDto.txtTdaNopenR = this.dailyEdit.tdaNopenR
                    this.tmgResultsDto.txtTdaNcloseR = this.dailyEdit.tdaNcloseR
                    this.tmgResultsDto.tdaCowncommentR = this.dailyEdit.tdaCowncommentR
                    this.tmgResultsDto.nonDutyList = this.detailNonDutyVOList
                    this.tmgResultsDto.overHoursList = this.detailOverhoursVOList
                    if (this.bFixed || this.bHoliday) {
                        this.tmgResultsDto.hasAuthority = false
                    } else {
                        this.tmgResultsDto.hasAuthority = true
                    }
                }

                if (!await this.getSQLVecForAjax()) {
                    this.updateDailyLoading = false
                    return
                }
                await this.http.post('sys/tmgResults/updateDaily', this.tmgResultsDto)
                this.updateDailyLoading = false
                this.isShow = false
                this.getTitleData()

            },
            async getSQLVecForAjax() {
                const {data} = await this.http.post('sys/tmgResults/getSQLVecForAjax', this.tmgResultsDto)

                let terCerrcode = data.terCerrcode

                if (terCerrcode === '0') {
                    return true
                }
                this.errMsg = JSON.parse(terCerrcode)

                let errMsg20 = ''
                let errMsg30 = ''
                let check = Object.keys(this.errMsg).some(e => {
                    if (e === 'ERRTYPE_10') {

                        this.$Notice.error({desc: this.errMsg.ERRTYPE_10[0].ERRMSG})

                        return true
                    }

                    if (e === 'ERRTYPE_20') {
                        this.errMsg.ERRTYPE_20.forEach(e20 => {
                            errMsg20 = errMsg20 + e20.ERRMSG + '/n'
                        })

                    }
                    if (e === 'ERRTYPE_30') {
                        this.errMsg.ERRTYPE_30.forEach(e30 => {
                            errMsg30 = errMsg30 + e30.ERRMSG + '/n'
                        })
                    }

                })
                if (check) return false

                if (errMsg20 !== '') {
                    this.$Notice.warning({desc: errMsg20})

                }
                if (errMsg30 !== '') {

                    if(!confirm('errMsg30')){
                        return false
                    }
                }
                return true
            },

            showLog() {
                if (this.isLogShow) {
                    this.isLogShow = false
                } else {
                    this.isLogShow = true
                }

            },

            // 就業区分の切り替え表示制御
            changeWorkingID(workingid) {

                this.bDisable = false;

                // 休暇
                if (this.bHoliday) {
                    this.bDisable = true;
                    // 休暇以外
                } else {

                    let mgdCsparechar4VO = this.mgdCsparechar4VOList.find(e => e.mgdCmastercode === workingid)

                    // 出勤 or 休日出勤
                    if (mgdCsparechar4VO.mgdCsparechar5 == '0') {
                        this.bDisable = false;
                        // 欠勤
                    } else {
                        this.bDisable = true;
                    }
                }

                if (this.bDisable === true) {
                    this.detailNonDutyVOList = []
                    this.detailOverhoursVOList = []

                }
            },


            // エラーチェック
            errorCheck() {

                // 修正出社時刻形式
                if (!this.checkFormatTimeValue(this.dailyEdit.tdaNopenR, '就業時間・始業は適切な時刻ではありません。(hh:mm)形式で時刻を入力してください。')) {

                    return false;
                }

                // 修正退社時刻形式
                if (!this.checkFormatTimeValue(this.dailyEdit.tdaNcloseR, '就業時間・終業は適切な時刻ではありません。(hh:mm)形式で時刻を入力してください。')) {

                    return false;
                }

                if (this.dailyEdit.tdaCowncommentR !== null && this.getLengthB(this.dailyEdit.tdaCowncommentR) > 100) {

                    this.$Notice.error({desc: "本人コメントが設定値を超えています。全角・半角カナ50字以内、半角英数100字以内。"})

                    return false;
                }

                //非勤務
                const checkNonDuty = this.detailNonDutyVOList.some(e => {

                    if (!this.checkFormatTimeValue(e.tdadNopen, '非勤務の開始時刻は適切な時刻ではありません。(hh:mm)形式で時刻を入力してください。')) {

                        return true;
                    }
                    if (!this.checkFormatTimeValue(e.tdadNclose, '非勤務の終了時刻は適切な時刻ではありません。(hh:mm)形式で時刻を入力してください。')) {

                        return true;
                    }
                    if (e.tdadCsparechar1 !== null && this.getLengthB(e.tdadCsparechar1) > 100) {
                        this.$Notice.error({desc: "中断備考が設定値を超えています。全角・半角カナ50字以内、半角英数100字以内。"})
                        return true

                    }
                })
                if (checkNonDuty) return false

                // 超過勤務
                const checkOverhour = this.detailOverhoursVOList.some(e => {

                    if (!this.checkFormatTimeValue(e.tdadNopen, '超過勤務の開始時刻は適切な時刻ではありません。(hh:mm)形式で時刻を入力してください。')) {

                        return true;
                    }
                    if (!this.checkFormatTimeValue(e.tdadNclose, '超過勤務の終了時刻は適切な時刻ではありません。(hh:mm)形式で時刻を入力してください。')) {

                        return true;
                    }
                    if (e.tdadCsparechar1 !== null && e.tdadCsparechar1.length > 100) {
                        this.$Notice.error({desc: "超過勤務備考が設定値を超えています。全角・半角カナ50字以内、半角英数100字以内。"})
                        return true
                    }

                })
                if (checkOverhour) return false


                let nOverTimeTotal = 0;
                // 超過勤務命令の明細部配下を行単位で取得
                this.detailOverhoursVOList.forEach(e => {

                    // 超過勤務命令の時間数を算出
                    let sOpen = this.toMinuteFromHHcMI60(e.tdadNopen);
                    let sClose = this.toMinuteFromHHcMI60(e.tdadNclose);
                    nOverTimeTotal = nOverTimeTotal + (sClose - sOpen);
                })


                // 超過勤務命令時間が入力されていて、超過勤務対象「無」の場合は警告メッセージを表示する
                if (nOverTimeTotal > 0 && this.targetForOverTime === "1") {
                    // 警告メッセージの表示および、応答の確認

                    if(!confirm('超過勤務対象外として設定されています。\n超過勤務命令を登録してもよろしいですか？')){
                        return false
                    }
                }

                // 超過勤務命令時間数合計が登録された超勤限度時間を超える場合は警告メッセージを表示する
                if (nOverTimeTotal > this.overHourLimit) {
                    // 警告メッセージの表示および、応答の確認

                    if(!confirm('超過勤務命令の時間数が' +this.otDaily +'時間を超えています。\nこの超過勤務時間で登録してよろしいですか？')){
                        return false
                    }

                }

                return true;
            },
            getLengthB(moji) {

                let i, j, cnt = 0;

                // "§", "¨", "°", "±", "´", "¶"を追加。2005.08.22 Oyama
                let multiStr = new Array("×", "§", "¨", "°", "±", "´", "¶");

                for (i = 0; i < moji.length; i++) {
                    for (j = 0; j < multiStr.length; j++) {
                        if (multiStr[j].length == 0) {
                            continue;
                        }
                        moji = moji.replace(multiStr[j], "00");
                    }
                }

                // MAC OSの場合、改行コードが「\n」となり、Windowsの改行コード「\r\n」とバイト数が異なるので、
                // 改行コードは「\r\n」で桁数を計算する様にする。
                moji = moji.split("\r\n").join("\n"); // 一旦「\r\n」 ⇒ 「\n」の変換を行い、改行コードを「\n」に合わせる。
                moji = moji.split("\n").join("\r\n"); // 「\n」 ⇒ 「\r\n」の変換を行い、改行コード全てを「\r\n」にする。

                // バイト数を求めます。
                for (i = 0; i < moji.length; i++)
                    if (escape(moji.charAt(i)).length >= 4) cnt += 2; else cnt++;
                return cnt;

            },
            // 時刻形式チェック
            checkFormatTimeValue(obj, mes) {


                if (!this.checkFormatTimeValueMain(obj)) {
                    this.$Notice.error({desc: mes})
                    return false;
                }

                return true;
            },


            // 時刻形式チェック（実判定処理部）
            checkFormatTimeValueMain(obj) {
                if (obj == null) obj = ''
                if (obj !== '' && !this.time_check(obj)) {
                    return false;
                } else {
                    if (!(this.checkFormatHHcMI60(obj))) {
                        return false;
                    }
                }

                return true;
            },
            time_check(sTime) {

                return sTime.match(/^([0-9]?[0-9]):([0-9][0-9])$/);

            },
            // *****************************************************************************
            //		関数名:		checkFormatHHcMI60
            //		機能:		HH:MI60形式で入力が行われているかどうかチェック
            //		パラメータ:	時刻or時間
            //		戻り値:		正しい入力 未入力:true　不正な入力:false
            checkFormatHHcMI60(para) {

                let colonSTR = ':'
                let nColonPoint
                let bColonIs = '0'
                let vHHMI
                let vMI

                // 未入力はtrueで返す
                if (para.length === 0) {
                    return true
                }

                // 桁数チェック
                if (para.length < 4 || para.length > 5) {
                    return false
                }

                // ":"の有無を調べる
                for (let i = 0; i < para.length; i++) {
                    if (para.charAt(i) === colonSTR) {
                        nColonPoint = i
                        bColonIs = 1
                        break
                    }
                }
                if (bColonIs === 0) {
                    return false
                }

                // 数値チェック
                vHHMI = para.substring(0, nColonPoint) + para.substring(nColonPoint + 1, para.length);
                if (isNaN(vHHMI) === true) {
                    return false
                }
                // 分チェック
                vMI = para.substring(nColonPoint + 1, para.length)
                if (vMI.length !== 2) {
                    return false
                }

                const sixty = +vMI
                if (eval(sixty) >= eval(60)) {
                    return false
                }

                return true
            },

            toMinuteFromHHcMI60(pHHMM) {

                let colonSTR = ':';
                let retMinute;
                let bColonIs = 0;
                let nColonPoint;
                let nHour = new Number();
                let nMinute = new Number();

                // コロンがあるかどうか
                let bColon = false;

                // 何もパラメータが渡されなかった場合、そのまま返す
                if (pHHMM === '') {
                    return '';
                }

                // ":"の有無を調べる
                for (let i = 0; i < pHHMM.length; i++) {
                    if (pHHMM.charAt(i) === colonSTR) {
                        nColonPoint = i;
                        bColonIs = 1;

                        // コロンがあるかどうか
                        bColon = true;

                        break;
                    }
                }

                if (bColon === false) {
                    return 0;
                }

                // 分に変換します
                nHour = eval(pHHMM.substring(0, +nColonPoint) * 60);

                nMinute = eval(+(pHHMM.substring(nColonPoint + 1, pHHMM.length)));

                retMinute = eval(nHour + nMinute);

                return retMinute;
            },

            toHHHcMI60FromHHHMI60(pHHMM) {
                console.log(pHHMM)
                return this.toHHcMI60FromHHMI60(pHHMM)
            },
            toHHcMI60FromHHMI60(pHHMM) {
                let colonSTR = ':';
                let dSTR = '.';
                let retHHMM;
                let bColonIs = 0;
                let nColonPoint;

                if (!pHHMM.match(/^(\d{1,2}:?)?[0-5][0-9]$/)) {
                    // フォーマットが不正である場合は入力された値をそのまま返す
                    return pHHMM;
                }

                if (pHHMM.length < 3) {
                    return "0:" + pHHMM;
                }

                // ":"の有無を調べる
                for (let i = 0; i < pHHMM.length; i++) {
                    if (pHHMM.charAt(i) === colonSTR) {
                        nColonPoint = i;
                        bColonIs = 1;
                        break;
                    }
                }

                // ":"がなければ
                if (bColonIs === 0) {
                    // ３桁の場合
                    if (pHHMM.length === 3) {
                        retHHMM = pHHMM.substring(0, 1) + colonSTR + pHHMM.substring(1, 3);
                        // ４桁の場合
                    } else {
                        retHHMM = pHHMM.substring(0, 2) + colonSTR + pHHMM.substring(2, 4);
                    }
                    // ":"があれば
                } else {
                    retHHMM = pHHMM;
                }

                // 0X:XXの場合１桁目の0は削除
                if (retHHMM.charAt(0) === '0' && retHHMM.charAt(1) !== colonSTR) {
                    retHHMM = retHHMM.substring(1, retHHMM.length);
                }

                return retHHMM;
            },
            //登録画面/////////////////////////////////////////////////////////////////

            handleDatePicker() {
            },
            rowClass(row) {
                // 不可点击得时候，表格变色
                // if (!row.memberDivisionCode || (!this.isEmployer && this.monthConfirmFlag)) {
                //   if (row.dayDivisionCode === '4') {
                //     return 'sun'
                //   }
                //   // 第一条避免错误数据被染上sat色
                //   if (row.dayDivisionCode && row.dayDivisionCode !== '1') {
                //     return 'sat'
                //   }
                //   return ''
                // }
                // 可点击得时候，表格变色
                if (row.today) {
                    return 'select-col sun'
                }
                if (!row.dayDivisionCode || row.dayDivisionCode === '1') {
                    return 'select-col'
                }
                return 'select-col sat'
            },
            dayRed(e) {
                const dayOfWeek = e.TDA_DYYYYMMDD_DY
                if (!dayOfWeek) {
                    return
                }
                if (dayOfWeek.trim() === '土' || dayOfWeek.trim() === '日') {
                    return 'blue'
                }
                if (e.today) {
                    return 'brown'
                }
            }
        }
    })
</script>
</body>


</html>