<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head
    th:replace="layout/header::common_header(title='就業登録',cssPaths='/pages/content.min.css,' + '/pages/vacation.min.css')">
</head>

<body>
    <div th:replace="layout/loadingBar::loadingBar"></div>
    <main class="content monthWorkConfirm-warp" @scroll.passive="handleScroll" ref="layout">
        <div class="content_head">
            <div class="header">
                <div class="title1">
                    <h1>
                        <Icon type="i-emeer colored"></Icon>
                        就業登録
                    </h1>
                </div>
                <div class="btnbox">
                    <span style="flex:1"></span>
                    <p class="pr15" style="height: 40px;line-height: 45px;font-size: 16px;font-weight: bold;">
                        {{ `現在の承認状況： ${isConfirm==="TMG_DATASTATUS|5" ? '承認済' : '未承認'}` }}
                    </p>
                    <!-- 就业承认的部分 -->
                    <!-- <i-button type="primary" size="large" @click="isConfirm = !isConfirm" v-if="isAdmin">
                        {{ isConfirm ? '承認解除' : '月次承認' }}
                      </i-button> -->
<!--                    <i-button type="primary" size="large">月次報告</i-button>-->
                </div>
            </div>
            <div class="searchwrap">
                <span class="label">年月</span>
                <i-select v-model="model1" :disabled="!selectDisabled" class="mr30" @on-change="handleStartMonth($event)"
                          placeholder="選択ください">
                    <i-option v-for="(item, index) of dispMonthlyList" :key="index" :label="item.val":value="item.val">
                    </i-option>
                </i-select>
            </div>
        </div>
        <div class="content_body">

            <div class="titlenorm mb10 " style="font-size:15px">
                <Icon type="logo-buffer"></Icon>
                就業実績
            </div>
            <div class="month-sum tl">

                <div class="son" v-for="(item, i) of monthlyTilteMapList" :key="i">
                    <span class="label-monthSum">{{item.title | turnLine}}</span>
                    <span class="num">{{monthlyMap[item.key]}}</span>
                </div>

            </div>
            <i-table :class="tableHeadFixed ? 'table-head-fixed long-table' : 'long-table'" @on-row-click="showDay(arguments)" border :columns="columns"
                :row-class-name="rowClass" :disabled-hover="true" :data="data" :loading="loading">
                <template slot-scope="{ row }" slot="TDA_DYYYYMMDD_DD">
                    <span :class="dayRed(row)">{{ row.TDA_DYYYYMMDD_DD }}</span>
                </template>
                <template slot-scope="{ row }" slot="TDA_DYYYYMMDD_DY">
                    <span :class="dayRed(row)">{{ row.TDA_DYYYYMMDD_DY }}</span>
                </template>
                <template slot-scope="{ row }" slot="TDA_CWORKINGID_R_NAME">
                    <span :class="dayRed(row)">{{ row.TDA_CWORKINGID_R_NAME }}</span>
                </template>
                <template slot-scope="{ row }" slot="TDA_CSTATUSFLG_NAME">
                    <span v-if="row.TDA_CSTATUSFLG_NAME === '待'" class="confirm-sytle ing">待</span>
                    <span v-if="row.TDA_CSTATUSFLG_NAME === '済'" class="confirm-sytle">済</span>
                    <span v-if="row.TDA_CSTATUSFLG_NAME === 'エ'" class="confirm-sytle undo">エ</span>
                </template>
                <template slot-scope="{ row }" slot="TDA_CNTFSTATUSFLG_NAME">
                    <span v-if="row.TDA_CNTFSTATUSFLG_NAME === '待'" class="confirm-sytle ing">待</span>
                    <span v-if="row.TDA_CNTFSTATUSFLG_NAME === '済'" class="confirm-sytle">済</span>
                    <span v-if="row.TDA_CNTFSTATUSFLG_NAME === 'エ'" class="confirm-sytle undo">エ</span>
                </template>
            </i-table>
        </div>






        <Drawer :title="title" width="800" v-model="isShow" @on-close="handleClose()" draggable>
            <div class="content_body">
                <Alert type="error" class="error-info" v-show="errorFlag">{{ errorMsg }}</Alert>
                <Row class="mb15 tr">
                    <i-col span="6" offset="15"><i-button type="primary" ghost class="mr15">コメントのみ登録</i-button></i-col>
                    <i-col span="3"><i-button type="primary" ghost class="mr15">登録</i-button></i-col>
                </Row>
                <div class="titlenorm mb10">
                    <Icon type="logo-buffer"></Icon>
                    就業実績
                </div>
                <Row >
                    <i-col span="8" class="label tc">就業区分</i-col>
                    <i-col span="8" class="no-border-radius">
                        <i-select v-model="workingId" class="mr30" @on-change="" placeholder="選択ください">
                            <i-option v-for="(item, index) of workingIdList" :key="index" 　:value="item.mgdCgenericdetaildesc">
                            </i-option>
                        </i-select>
<!--                        <span >{{ dailyData.workStart | toTime }}</span>-->
<!--                    <i-select v-model="model1" :disabled="!selectDisabled" class="mr30" @on-change=""-->
<!--                              placeholder="選択ください">-->
<!--                        <i-option v-for="(item, index) of dispMonthlyList" :key="index" :label="item.val"　:value="item.val">-->
<!--                        </i-option>-->
<!--                    </i-select>-->
    <!--                <Select>-->
    <!--                    <Option :value="1">出勤</Option>-->
    <!--                    <Option :value="2">退勤</Option>-->
    <!--                </Select>-->
                    </i-col>
                </Row>
                <Row class="mb5">
                    <i-col span="8" class="label tc">出張</i-col>
                    <i-col span="8" class="no-border-radius">
                        <i-select v-model="workingId" class="mr30" @on-change=""  placeholder="選択ください">
                            <i-option v-for="(item, index) of workingIdList" :key="index" :label="item.mgdCgenericdetaildesc"　:value="item.mgdCgenericdetaildesc">
                            </i-option>
                        </i-select>
                    </i-col>
<!--                    <Col span="8" class="label">出張</Col>-->
<!--                    <Col span="8" class="no-border-radius">-->
<!--                    <Select>-->
<!--                        <Option :value="1">なし</Option>-->
<!--                        <Option :value="2">出張(国内)</Option>-->
<!--                        <Option :value="3">出張(海外)</Option>-->
<!--                        <Option :value="4">研修</Option>-->
<!--                        <Option :value="5">外出</Option>-->
<!--                    </Select>-->
<!--                    </Col>-->
                </Row>
                <i-table :columns="columnsWork" :data="workData" :span-method="handleSpan" class="mb20">
                    <template slot-scope="{ row }" slot="workStart">
<!--                        <i-input v-model="$options.filters.toTime(row.workStart)" v-if="row.isInput" />-->
                        <i-input v-model="row.workStart" v-if="row.isInput"  text-align="center;"></i-input>
                        <span v-else>{{ row.workStart | toTime }}</span>
                    </template>
                    <template slot-scope="{ row }" slot="workEnd">
                        <i-input v-model="row.workEnd" v-if="row.isInput" ></i-input>
                        <span v-else>{{ row.workEnd | toTime }}</span>
                    </template>
                </i-table>

                <!-- 非勤務 -->
                <div class="titlenorm mb10">
                    <i-ccon type="logo-buffer"></i-ccon>
                    非勤務
                </div>
                <Row class="mb15">
                    <i-col span="5" offset="16">
                    <i-select v-model="notWorkType">
                        <Option :value="1">休憩</Option>
                        <Option :value="2">中断</Option>
                    </i-select>
                    </i-col>
                    <i-col span="3"><i-button type="primary" ghost @click="addNotWork">追加</i-button></i-col>
                </Row>
                <i-table :columns="columnsNotWork" :data="notWorkData" class="mb20" no-data-text="追加ボタンを押してください。">
                    <template slot-scope="{ row }" slot="workStart">
                        <i-input :value="$options.filters.toTime(row.workStart)" v-if="row.isInput" ></template>
                        <span v-else>{{ row.workStart }}</span>
                    </template>

                    <template slot-scope="{ row }" slot="workEnd">
                        <i-input :value="$options.filters.toTime(row.workEnd)" v-if="row.isInput" ></i-input>
                        <span v-else>{{ row.workEnd | toTime }}</span>
                    </template>

                    <template slot-scope="{ row }" slot="remark">
                        <i-input v-if="row.hasRemark" type="textarea" :autosize="{ maxRows: 3 }" ></i-input>
                    </template>

                    <template slot-scope="{ row }" slot="del">
                        <i-button type="error" ghost size="small" class="width100" @click="delNotWork(row)">削除</i-button>
                    </template>
                </i-table>

                <!-- 超過勤務 -->
                <div class="titlenorm mb10">
                    <i-icon type="logo-buffer"></i-icon>
                    超過勤務
                </div>
                <Row class="mb15">
                    <i-col span="3" offset="17"><i-button type="primary" ghost @click="addOverWork">追加</i-button></i-col>
                    <i-col span="4"><i-button type="primary" ghost>時刻補完</i-button></i-col>
                </Row>

                <i-table :columns="columnsOverWork" :data="overWorkData" class="mb20" no-data-text="追加ボタンを押してください。">
                    <template slot-scope="{ row }" slot="workStart">
                        <i-input :value="$options.filters.toTime(row.workStart)" v-if="row.isInput" ></i-input>
                        <span v-else>{{ row.workStart | toTime }}</span>
                    </template>

                    <template slot-scope="{ row }" slot="workEnd">
                        <i-input :value="$options.filters.toTime(row.workEnd)" v-if="row.isInput" ></i-input>
                        <span v-else>{{ row.workEnd | toTime }}</span>
                    </template>

                    <template slot-scope="{ row }" slot="workContent">
                        <i-input v-model="row.content" type="textarea" :autosize="{ maxRows: 3 }" ></i-input>
                    </template>

                    <template slot-scope="{ row }" slot="del">
                        <i-button type="error" ghost size="small" class="width100" @click="delOverWork(row)">削除</i-button>
                    </template>
                </i-table>

                <div class="titlenorm mb10">
                    <i-icon type="logo-buffer"></i-icon>
                    更新履歴
                </div>
            </div>
        </Drawer>
        <span class="toTopBtn" @click="toTop" v-show="isScroll">
            <Icon size="24" type="md-arrow-round-up" />
        </span>
    </main>
    <div th:replace="layout/script::common_script"></div>
    <script type="text/babel" th:inline="javascript">
        const WORK_YEAR_SCHEDULE = new Vue({
            // 特别注意要对上这个class
            el: '.monthWorkConfirm-warp',
            data() {
                return {
                    contentScrollTop: 0,
                    isScroll: false,
                    today:'',
                    selectDisabled: false,   　//年月選択可否制御
                    dispMonthlyList: [],       //年月リスト
                    model1: '',
                    targetUser:'',
                    monthlyTilteMapList:[],
                    monthlyMap:[],
                    columns:[] ,
                    data:[] ,
                    loading: false,
                    query: {
                        txtAction: 'ACT_Disp_RList',
                        txtDYYYYMM: '2020/04/01',
                        txtDYYYYMMDD: '',
                        psSite: Utils.getUrlParam(location.href, 'psSite'),
                        psApp: Utils.getUrlParam(location.href, 'psApp')
                    },
                    workingId:'',
                    workingIdList:[],

                    isShow: false,
                    title: {
                        type: String,
                        default: ''
                    },
                    width: {
                        type: [String, Number],
                        default: 650
                    },
                    isAdmin: {
                        type: Boolean,
                        default: false
                    },
                    errorFlag: false,
                    errorMsg: '',
                    columnsWork: [
                        {
                            title: '勤務時間',
                            align: 'center',
                            key: 'workTime'
                        },
                        {
                            title: '始業',
                            slot: 'workStart',
                            align: 'center'
                        },
                        {
                            title: '終業',
                            slot: 'workEnd',
                            align: 'center'
                        }
                    ],
                    notWorkData: [],
                    columnsOverWork: [
                        {
                            title: '内容',
                            align: 'center',
                            width: '120',
                            key: 'workTime'
                        },
                        {
                            title: '開始時刻',
                            width: '80',
                            slot: 'workStart',
                            align: 'center'
                        },
                        {
                            title: '終了時刻',
                            slot: 'workEnd',
                            width: '80',
                            align: 'center'
                        },
                        {
                            title: '用務内容',
                            slot: 'workContent',
                            align: 'center'
                        },
                        {
                            title: '状態',
                            key: 'status',
                            align: 'center'
                        },
                        {
                            title: '削除',
                            slot: 'del',
                            width: '80',
                            align: 'center'
                        }
                    ],
                    workData: [
                        {
                            workTime: '予定時間',
                            workStart: 430,
                            workEnd: 1750,
                            cellClassName: {
                                workTime: 'sub-title'
                            }
                        },
                        {
                            workTime: '打刻',
                            workStart: 425,
                            workEnd: 1760,
                            cellClassName: {
                                workTime: 'sub-title'
                            }
                        },
                        {
                            workTime: '就業時間',
                            workStart: 430,
                            workEnd: 1750,
                            isInput: true,
                            cellClassName: {
                                workTime: 'sub-title'
                            }
                        },
                        {
                            workTime: '本人コメント	',
                            isInput: true,
                            comment: '',
                            cellClassName: {
                                workTime: 'like-title'
                            }
                        },
                        {
                            workTime: '承認者コメント	',
                            isInput: true,
                            comment: '',
                            cellClassName: {
                                workTime: 'like-title'
                            }
                        }
                    ],
                    columnsNotWork: [
                        {
                            title: '内容',
                            align: 'center',
                            width: '120',
                            key: 'workTime'
                        },
                        {
                            title: '開始時刻',
                            width: '80',
                            slot: 'workStart',
                            align: 'center'
                        },
                        {
                            title: '終了時刻',
                            slot: 'workEnd',
                            width: '80',
                            align: 'center'
                        },
                        {
                            title: '備考',
                            slot: 'remark',
                            align: 'center'
                        },
                        {
                            title: '削除',
                            slot: 'del',
                            width: '80',
                            align: 'center'
                        }
                    ],
                    overWorkData: [
                        {
                            workTime: '超勤命令',
                            workStart: 430,
                            addIndex: '33',
                            workEnd: 1750,
                            content: '書類整理',
                            status: '申請中（本人 事前）'
                        }
                    ],
                    notWorkType: 1,
                    dailyData:{

                    },



                    isConfirm: false,


                    // monthlyTilteMapList:[[${monthlyTilteMapList }]],
                    // monthlyMap:[[${monthlyMap }]],

                    monthSum: {},
                    dailyShow: true,
                    rawData: [],
                    selectedData: {
                        obj: {},
                        date: ''
                    },

                    index: 0,
                    isConfirm: false,
                    comment: ''

                }
            },
            async mounted() {
                this.init()
            },
            created() {
                console.log(this.monthlyTilteMapList)
                console.log(this.monthlyMap)
            },
            computed: {
                tableHeadFixed() {
                    if (this.contentScrollTop > 310) return true
                    else return false
                }
            },
            methods: {

                handleScroll: Throttle(function(e) {
                    this.contentScrollTop = e.target.scrollTop
                    if (e.target.scrollTop > 200) {
                        this.isScroll = true
                    } else {
                        this.isScroll = false
                    }
                }, 50),
                toTop() {
                    const animateMachine = requestAnimationFrame(this.toTop)
                    this.$refs.layout.scrollTop = this.$refs.layout.scrollTop - this.$refs.layout.scrollTop / 5
                    if (this.$refs.layout.scrollTop === 0) {
                        cancelAnimationFrame(animateMachine)
                    }
                },
                async init() {

                    try {
                        // 今日日付取得
                        // 勤務年月一覧取得
                        await this.getWorkDateList()
                        await this.monthAndDaily()

                    } catch (error) {
                        return
                    } finally {
                        this.loading = false

                    }
                },
                // 今日日付取得
                async getToDay() {
                    this.query.txtAction = 'ACT_DISP_RMONTHLY'
                    const { data } = await this.http.get('sys/tmgResults/getToday', this.query)

                },
                // 勤務年月一覧取得
                async getWorkDateList() {
                    this.query.txtAction = 'ACT_DISP_RMONTHLY'
                    this.loading = false
                    const { data } = await this.http.get('sys/tmgResults/workDateList', this.query)

                    this.today=data.today.today
                    this.dispMonthlyList = data.monthLy
                    console.log(this.dispMonthlyList)

                    if (data.monthLy.length > 0){
                        this.model1 = this.dispMonthlyList[0].val

                        let result = this.model1.replace("年","/")
                        result = result.replace("月","/")
                        result = result + "01"
                        this.query.txtDYYYYMM = result

                        //年月リストを取得する時に、活性化にする
                        this.selectDisabled = true
                    }

                    //年月リスト.lengthがゼロ場合、非活性化にする
                    if (data.monthLy.length === 0){
                        this.model1 = ''
                        this.selectDisabled = false
                    }
                },
                // 年月選択
                async handleStartMonth(e) {
                    this.query.txtAction = 'ACT_DISP_RMONTHLY'
                    this.query.txtDYYYYMM = this.dateFormat(e)
                    this.query.txtDYYYYMMDD = this.today
                    this.loading　= true
                    // 就業実績 --月次実績
                    await this.getMonthlyData()
                    // 就業実績 --日次実績
                    await this.getDailyData()
                    this.loading　= false
                },
                //就業実績（月次・日次）
                async monthAndDaily() {
                    this.query.txtAction = 'ACT_DISP_RMONTHLY'
                    this.query.txtDYYYYMM =  this.dateFormat(this.model1)
                    this.query.txtDYYYYMMDD = this.today
                    this.loading　= true
                    // 就業実績 --月次実績
                    await this.getMonthlyTitleData()
                    // 就業実績 --日次実績
                    await this.getDailyTitleData()
                    this.loading　= false

                },
                dateFormat(e) {
                    //YYYY年MM月からYYYY/MM/01へ変換する
                    let yearMMDD = e.replace("年","/")
                    yearMMDD = yearMMDD.replace("月","/")
                    yearMMDD = yearMMDD+"01"
                    return  yearMMDD
                },
                async getMonthlyTitleData() {
                    const { data } = await this.http.get('sys/tmgResults/getMonthlyData', this.query)

                    console.log(data)
                    // this.fullName = data.dispItemsList.slice(0,1)[0].title
                    this.monthlyTilteMapList = data.monthlyTilteMapList
                    this.monthlyMap = data.monthlyDateMap
                    this.isConfirm = data.monthlyTilteMapList.TMO_CSTATUSFLG
                },
                async getDailyTitleData() {

                    const { data } = await this.http.get('sys/tmgResults/getDailyData', this.query)

                    console.log(data)

                    this.columns = data.dailyTittleMapList.map(e=> {
                        return {
                            ...e,
                            title: e.title.replace(TURN_LINE_STR, '\n')
                        }
                    })

                    this.data = data.dailyMapList

                },
                async getMonthlyData() {
                    const { data } = await this.http.get('sys/tmgResults/getMonthlyData', this.query)

                    this.monthlyMap = data.monthlyDateMap
                },
                async getDailyData() {

                    const { data } = await this.http.get('sys/tmgResults/getDailyData', this.query)
                    this.data = data.dailyMapList


                },
                ////////////////////////////////////////
                 showDay(e) {
                    this.isShow = true
                    this.title = e[0].TDA_DYYYYMMDD + '(' + e[0].TDA_DYYYYMMDD_DY + ')'

                    this.query.txtDYYYYMMDD = e[0].TDA_DYYYYMMDD


                    const {data} = this.http.get('sys/tmgResults/getWorkingId', this.query)

                     console.log(data)
                    this.workingIdList = data
                    console.log(this.workingIdList)


                },

/////////////////////////////////////////////////////////////////
                //登録画面

                handleClose() {
                    this.errorFlag = false
                    this.isShow = false
                    this.$emit('close')
                },
                addOverWork() {
                    this.overWorkData.push({
                        workTime: '超勤命令',
                        workStart: 0,
                        workEnd: 0,
                        addIndex: Date.now(),
                        isInput: true,
                        content: '',
                        status: ''
                    })
                },
                addNotWork() {
                    if (this.notWorkType === 1) {
                        this.notWorkData.push({
                            workTime: '休憩時間',
                            workStart: 0,
                            addIndex: Date.now(),
                            isInput: true,
                            workEnd: 0
                        })
                    } else {
                        this.notWorkData.push({
                            workTime: '中断時間',
                            workStart: 430,
                            addIndex: Date.now(),
                            workEnd: 1750,
                            isInput: true,
                            hasRemark: true
                        })
                    }
                },
                delNotWork(row) {
                    this.notWorkData = this.notWorkData.filter(e => e.addIndex !== row.addIndex)
                },
                delOverWork(row) {
                    this.overWorkData = this.overWorkData.filter(e => e.addIndex !== row.addIndex)
                },
                handleSpan({ rowIndex, columnIndex }) {
                    if (rowIndex === 3 && columnIndex === 1) {
                        return [1, 2]
                    } else if (rowIndex === 4 && columnIndex === 1) {
                        return [1, 2]
                    }
                },



                handleDatePicker() { },
                rowClass(row) {
                    // 不可点击得时候，表格变色
                    // if (!row.memberDivisionCode || (!this.isEmployer && this.monthConfirmFlag)) {
                    //   if (row.dayDivisionCode === '4') {
                    //     return 'sun'
                    //   }
                    //   // 第一条避免错误数据被染上sat色
                    //   if (row.dayDivisionCode && row.dayDivisionCode !== '1') {
                    //     return 'sat'
                    //   }
                    //   return ''
                    // }
                    // 可点击得时候，表格变色
                    if (row.today) {
                        return 'select-col sun'
                    }
                    if (!row.dayDivisionCode || row.dayDivisionCode === '1') {
                        return 'select-col'
                    }
                    return 'select-col sat'
                },
                dayRed(e) {
                    const dayOfWeek = e.TDA_DYYYYMMDD_DY
                    if (!dayOfWeek) {
                        return
                    }
                    if (dayOfWeek.trim() === '土' || dayOfWeek.trim() === '日') {
                        return 'blue'
                    }
                    if (e.today) {
                        return 'brown'
                    }
                },

                preMonth() {
                },
                nextMonth() {
                },
                download(type) {
                },
                refresh() {
                }
            }
        })
    </script>
</body>


</html>