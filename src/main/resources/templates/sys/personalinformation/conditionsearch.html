<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='自由条件検索',cssPaths='/pages/content.min.css')">
</head>

<body
    th:with="baseUrl = ${#httpServletRequest.getScheme() + '://' + #httpServletRequest.getServerName() + ':' + #request.getServerPort()  + #request.getContextPath()},
      now = ${new java.util.Date().getTime()
    }">
    <div th:replace="layout/loadingBar::loadingBar"></div>
    <!-- 菜单导航栏 -->
    <div th:replace="layout/sider"></div>
    <main class="content protosettings-warp" ref="layout">
        <div class="content_head">
          <div class="header">
            <div class="title1">
              <h1>
                <Icon type="i-emeer colored"></Icon>
                {{ `自由条件検索` }}
              </h1>
            </div>
            <div class="btnbox">
              <span style="flex:1"></span>
              <i-button type="primary" icon="ios-search" @click="update" :loading="editLoading">検索</i-button>
              <i-button type="primary" ghost icon="md-download" @click="update" :loading="editLoading">CSV ダウンロード</i-button>
              <i-button type="primary" ghost icon="ios-undo" @click="update" :loading="editLoading">クリア</i-button>
            </div>
          </div>
        </div>
        <div class="content_body">
            <div class="titlenorm mb10" style="font-size:15px">
                <Icon type="logo-buffer"></Icon>
                条件設定
            </div>
            <div style="display: flex;z-index: 1;">
              <div>
                <span style="margin-left: 3px;font-weight: bold;color: var(--primary-info);">現在読み込み中の設定：</span>
                <i-button class="mr5" type="primary" ghost icon="md-cloud-download" @click="()=>  console.log(this.displayCheckboxList)" :loading="editLoading">読込</i-button>
                <i-button class="mr5" type="primary" ghost icon="md-cloud-upload" @click="update" :loading="editLoading">保存</i-button>
                <i-button type="error" ghost icon="md-trash" @click="update" :loading="editLoading">削除</i-button>
              </div>
              <div style="flex: 1;"></div>
                <div>
                  <span style="font-weight: bold;color: var(--primary-info);">検索結果データ：</span>
                  <i-select v-model="searchData.histroyDataId" style="width: 400px;" transfer>
                    <i-option value="0">なし
                    </i-option>
                    <i-option v-for="(item, i) of resultHistoryList" :key="i" value="01">{{item}}
                    </i-option>
                  </i-select>
                  <i-button type="primary" ghost icon="md-refresh" @click="getResultHistoryList"></i-button>
                </div>
            </div>
            <Tabs type="card" :animated="false" class="mt5">
                <tab-pane label="表示項目選択">
                    <Row :gutter="8">
                        <i-col span="8">
                            <div class="ivu-transfer-list width100" style="height: 500px;">
                                <div class="ivu-transfer-list-header">
                                    <span class="ivu-transfer-list-header-title">テーブルを選択してください</span>
                                </div>
                                <div class="ivu-transfer-list-body">
                                    <ul class="ivu-transfer-list-content">
                                        <li :class="item.name === curSelectedDisplay ? 'ivu-transfer-list-content-item conditionlist-transfer primary-set' : 'ivu-transfer-list-content-item conditionlist-transfer'"
                                            v-for="item of displayList" :key="item.name"
                                            @click="searchDisplayList(item.name)">
                                            {{ item.description }}
                                        </li>
                                        <li class="ivu-transfer-list-content-not-found"></li>
                                    </ul>
                                </div>
                            </div>
                        </i-col>
                        <i-col span="16">
                          <re-transfer :left-list="displayResultList" @to-left="($event) => displayResultList.push($event)" ref="transfer"></re-transfer>
                        </i-col>
                    </Row>
                    <Checkbox v-model="searchData.showMastCode" class="mt10">マスタ参照項目を表示するときはコードも併せて表示する</Checkbox>
                </tab-pane>
                <tab-pane label="条件項目選択">
                  <i-select value="01" class="mb5" style="display: block; width: 450px;">
                    <i-option value="01">{{`【${this.legalPersonList[0].macCcompanyidCk}】 ${this.legalPersonList[0].macCcompanyname}`}}
                    </i-option>
                  </i-select>
                  <radio-group class="tl" v-model="searchData.standardDateType">
                    <Radio :label="1">指定日付時点のデータを検索する（通常はこちらを使用してください）</Radio>
                    <date-picker type="date" v-model="searchData.standardDate" :options="startLimit" class="ml5" format="yyyy/MM/dd"
                     transfer :clearable="false">
                  </date-picker>
                    <Radio :label="0" style="display: block;">履歴も全て検索する</Radio>
                  </radio-group>
                 <!-- <search-condition
                 :poptipType="this.$refs.poptip.poptipType"
                 :curdisplayPanel="this.$refs.poptip.curdisplayPanel"
                 :operatorType="this.$refs.poptip.operatorType"
                 :poptipStyle="this.$refs.poptip.poptipStyle"
                  @close-poptip="() => this.$refs.poptip.cancelpoptip()"
                  @query-fallback="() => this.$refs.poptip.queryconditionsFallback()"
                  ref="condition"
                  ></search-condition> -->
                  <search-condition
                  :poptip-type="poptipType"
                  :curdisplay-panel="curdisplayPanel"
                  :operator-type="operatorType"
                  :poptip-style="poptipStyle"
                  :query-data="queryData"
                  :clicked-cell="clickedCell"
                   @close-poptip="() => this.$refs.poptip.cancelpoptip()"
                   @query-fallback="() => this.$refs.poptip.queryconditionsFallback()"
                   @change-poptip-type="($event) => this.poptipType = $event"
                   @set-clickcell="($event) => this.clickedCell = $event"
                   @set-curdisplay-panel="($event) => this.curdisplayPanel = $event"
                   @change-operator-type="($event) => this.operatorType = $event"
                   ref="condition"
                   ></search-condition>
                </tab-pane>
                <tab-pane label="ソート項目選択">
                  <Row :gutter="8">
                    <i-col span="8">
                        <div class="ivu-transfer-list width100" style="height: 500px;">
                            <div class="ivu-transfer-list-header">
                                <span class="ivu-transfer-list-header-title">テーブルを選択してください</span>
                            </div>
                            <div class="ivu-transfer-list-body">
                                <ul class="ivu-transfer-list-content">
                                    <li :class="item.name === curSelectedSort ? 'ivu-transfer-list-content-item conditionlist-transfer primary-set' : 'ivu-transfer-list-content-item conditionlist-transfer'"
                                        v-for="item of displayListForSort" :key="item.name"
                                        @click="searchDisplayList(item.name, 'sort')">
                                        {{ item.description }}
                                    </li>
                                    <li class="ivu-transfer-list-content-not-found"></li>
                                </ul>
                            </div>
                        </div>
                    </i-col>
                    <i-col span="16">
                      <re-transfer
                        :left-list="sortResultList"
                        right-btn-text="降順"
                        right-show-label="rightLabel"
                        @to-left="($event) => sortResultList.push($event)"
                        :right-btn-fn="(e) => `${e}(降)`"
                        ref="transfer"
                        >
                        <template #top-btn="{ left, rightList}">
                          <i-button type="primary" size="small" icon="ios-arrow-forward" ghost @click="orderLift(left, rightList)">昇順</i-button>
                        </template>
                      </re-transfer>
                    </i-col>
                </Row>
                </tab-pane>
            </Tabs>
          <i-table border :class="tableHeadFixed ? 'table-head-fixed no-padding' : 'no-padding'"
            :row-class-name="() => 'select-col'" :columns="columns" :disabled-hover="true" :data="tableData"
            :loading="loading" ref="table">
          </i-table>
        </div>
        <!-- <pop-select
        :queryData="this.$refs.condition.queryData"
        :clickedCell="this.$refs.condition.clickedCell"
        ref="poptip"
        ></pop-select> -->
        <pop-select
        :poptip-type="poptipType"
        :curdisplay-panel="curdisplayPanel"
        :operator-type="operatorType"
        :poptip-style="poptipStyle"
        :query-data="queryData"
        :clicked-cell="clickedCell"
        ref="poptip"
        ></pop-select>
        <back-top></back-top>
      </main>
    <div th:replace="layout/head::header"></div>
    <script th:src="${baseUrl + '/static/component/conditionSearch/re-transfer.js?t='+ now}"></script>
    <script th:src="${baseUrl + '/static/component/conditionSearch/pop-select.js?t='+ now}"></script>
    <script th:src="${baseUrl + '/static/component/conditionSearch/search-condition.js?t='+ now}"></script>
    <script type="text/babel" th:inline="javascript">
      new Vue({
        el: '.protosettings-warp',
        components: { ReTransfer, SearchCondition, PopSelect },
        data() {
          return {
            isShow: false,
            loading: true,
            editLoading: false,
            btnLoading: false,
            defaultOption: false,
            psSite: Utils.getUrlParam(location.href, 'psSite'),
            psApp: Utils.getUrlParam(location.href, 'psApp'),
            updateValue: {},
            columns: [
            ],
            opts: {
              systemId: '01',
              appId: '0',
              siteId: '0',
              companyId: '0',
              date: '',
              groupId: '0',
              isAll: false,
            },
            curSelectedDisplay: '',
            curSelectedSort: '',
            tableData: [],
            displayList: [],
            displayListForSort: [],
            displayResultList: [],
            sortResultList: [],
            contentScrollTop: 0,
          legalPersonList: [{macCcompanyidCk:'',macCcompanyname:''}],
          searchData:{standardDateType:1, standardDate: new Date(),histroyDataId:'0',showMastCode:false},
          resultHistoryList: [],
          // 分离条件表格和气泡组件抽出共有属性
          poptipType: 'displayvalue',
          curdisplayPanel: '',
          operatorType: false,
          poptipStyle: {
                display: 'none',
                position: 'absolute',
                'will-change': 'top, left',
                'z-index': '1001',
                left: '0',
                top: '0'
            },
            queryData: [{ isAdd: true, addIndex: Date.now(), andor: '', openedparenthsis: '', columnname: '', operator: '', displayvalue: '', closedparenthsis: '', delete: false }],
            clickedCell: { where: '', which: '' },
          }
        },
        async created() {
          // this.getTableData()
          this.getLegalPersonList()
          this.getResultHistoryList()
          this.getDisplayList()
          window.addEventListener('scroll', this.handleScroll, { passive: true })
        },
        beforeDestroy() {
          window.removeEventListener('scroll', this.handleScroll, { passive: true })
        },
        computed: {
          tableHeadFixed() {
            if (this.contentScrollTop > 110) return true
            else return false
          }
        },
        methods: {
          async getTableData() {
            const OPTS = { ...this.opts }
            OPTS.psSite = Utils.getUrlParam(location.href, 'psSite')
            OPTS.psApp = Utils.getUrlParam(location.href, 'psApp')
            Object.keys(OPTS).forEach(key => {
              if (OPTS[key] === '0') {
                delete OPTS[key]
              }
            })
            this.loading = true
            try {
              const { data } = await this.http.get('sys/conditionsearch/applist', OPTS)
              this.tableData = data
            } catch (error) {
            } finally {
              this.loading = false
            }
          },
          async getDisplayList() {
            try {
              const { data } = await this.http.get('sys/conditionsearch/options/tbl')
              this.displayList = data
              this.displayListForSort = Utils.deepClone(data)
              if (data.length > 0) {
                this.searchDisplayList(data[0].name, 'init')
              }
            } catch (error) {
            } finally {
              // this.loading = false
            }
          },
          searchDisplayList: Debounce(async function (name, type) {
            if (type === 'init') {
              this.curSelectedSort = name
              this.curSelectedDisplay = name
            } else if (type === 'sort') {
              this.curSelectedSort = name
            } else {
              this.curSelectedDisplay = name
            }
            try {
              const { data } = await this.http.get('sys/conditionsearch/options/col', { table: name })
              // 新获取表示項目时，应该排除已经选择的项目
              const rightListIds = this.$refs.transfer.rightList.map(e => e.columnName)
              if (type === 'init') {
                this.sortResultList = data.filter(e => !rightListIds.includes(e.columnName))
                this.displayResultList = data.filter(e => !rightListIds.includes(e.columnName))
              } else if (type === 'sort') {
                this.sortResultList = data.filter(e => !rightListIds.includes(e.columnName))
              } else {
                this.displayResultList = data.filter(e => !rightListIds.includes(e.columnName))
              }
              if (type === 'sort') this.sortResultList = data.filter(e => !rightListIds.includes(e.columnName))
              else this.displayResultList = data.filter(e => !rightListIds.includes(e.columnName))
            } catch (error) {
            } finally {
              // this.loading = false
            }
          }),
          orderLift(left, rightList){
            let index = 0
            left.forEach(e => {
                if (e === 0 || e) {
                    const target = this.sortResultList.splice(e - index, 1)
                    rightList.push({...target[0], rightLabel: `${target[0].columnFieldName}(昇)`})
                    this.$set(left, e, undefined)
                    index += 1
                }
            })
          },
          async getLegalPersonList() {
          const { data } = await this.http.get(`sys/groupappmanager/companies?psSite=${this.psSite}&psApp=${this.psApp}`)
          this.legalPersonList = data
          this.opts.companyId = data[0] && data[0].macCcompanyidCk
        },
        getResultHistoryList: Debounce(async function() {
          const { data } = await this.http.get('sys/conditionsearch/show/read')
          this.resultHistoryList = data
        }),
          async update() {
            this.$Modal.confirm({
              title: '注意',
              content: '入力内容を保存します。よろしいですか？',
              okText: 'OK',
              cancelText: 'キャンセル',
              onOk: async () => {
                this.loading = true
                const update = this.tableData.map((e, i) => {
                  return {
                    ...e,
                    templateId: e.templateId === 'null' ? null : e.templateId,
                    permissionType: e.permissionType === 'null' ? null : e.permissionType
                  }
                })
                try {
                  const { data } = await this.http.post('sys/appmanager/update', update)
                  this.$Message.success('更新完了')
                  this.getTableData()
                  this.updateValue = {}
                } catch (error) {
                } finally {
                  history.go(0)
                  this.loading = false
                }
              }
            })
          },
          handleScroll: Throttle(function (e) {
            this.contentScrollTop = e.target.documentElement.scrollTop || e.target.body.scrollTop
          }, 50)
        }
      })
    </script>
</body>
