<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='自由条件検索',cssPaths='/pages/content.min.css')">
</head>

<body th:with="baseUrl = ${#httpServletRequest.getScheme() + '://' + #httpServletRequest.getServerName() + ':' + #request.getServerPort()  + #request.getContextPath()},
      now = ${new java.util.Date().getTime()
    }">
  <div th:replace="layout/loadingBar::loadingBar"></div>
  <!-- 菜单导航栏 -->
  <div th:replace="layout/sider"></div>
  <style>
    flip-list-move {
      transition: transform 0.5s;
    }

    .share-query-select {
      width: 450px;
    }

    @media (max-width: 1500px) {
      .share-query-select {
        width: 350px;
      }
    }

    @media (max-width: 1350px) {
      .share-query-select {
        width: 300px;
      }
    }

    .ghost {
      opacity: .5;
      background: var(--primary-info-bg);
    }

    .ivu-table,
    .ivu-transfer-list-header {
      background-color: var(--content-bg);
    }

    .ivu-transfer-list-content-item:not(.primary-set),
    .ivu-transfer-list-header {
      color: var(--grey);
    }

    .ivu-tabs.ivu-tabs-card>.ivu-tabs-bar .ivu-tabs-tab {
      background: inherit;
    }
  </style>
  <main class="content protosettings-warp" ref="layout">
    <div class="content_head">
      <div class="header">
        <div class="title1">
          <h1>
            <Icon type="i-emeer colored"></Icon>
            {{ `自由条件検索` }}
          </h1>
        </div>
        <div class="btnbox">
          <span style="flex:1"></span>
          <i-button type="primary" icon="ios-search" @click="freeSearch('SCREEN')" :loading="loading">検索</i-button>
          <i-button type="primary" ghost icon="md-download" @click="freeSearch('CSV')" :loading="csvLoading">CSV ダウンロード
          </i-button>
          <i-button type="primary" ghost icon="ios-undo" @click="refreshPage">クリア</i-button>
        </div>
      </div>
    </div>
    <div class="content_body">
      <div class="titlenorm mb10" style="font-size:15px">
        <Icon type="logo-buffer"></Icon>
        条件設定
      </div>
      <div style="display: flex;z-index: 1;">
        <div>
          <span style="margin-left: 3px;font-weight: bold;color: var(--primary-info);"
            ref="clickHelper">現在読み込み中の設定：</span>
          <i-select v-model="searchData.queryListId" class="share-query-select" transfer @on-change="getSettingDetail">
            <i-option :value="0">なし
            </i-option>
            <i-option v-for="(item, i) of queryList" :key="i" :value="item.hseNsettingid" :label="item.hseCsettingName"
              style="position: relative;">
              <div>{{ `設定名: ${item.hseCsettingName}` }}</div>
              <span class="pr10" style="font-size: 12px;">{{ `備考: ${item.hseCcomment ? item.hseCcomment : '　'}`
                }}</span>
              <div style="color: var(--login-svg-fill);position: absolute;top:5px;right: 16px;"
                v-show="item.hseCpublic">共有</div>
              <i-button type="error" ghost icon="md-trash" size="small"
                @click.stop="delSettingShare(item.hseNsettingid, 'setting')" style="float:right;color: var(--red);">削除
              </i-button>
            </i-option>
          </i-select>
          <i-button type="primary" ghost icon="md-refresh" @click="getQueryListParam" :loading="shareQuerySaveLoading"></i-button>
          <i-button class="mr5" type="primary" ghost icon="md-cloud-upload" @click="shareSetting">保存
          </i-button>
        </div>
        <div style="flex: 1;"></div>
        <div>
          <span style="font-weight: bold;color: var(--primary-info);">検索結果データ：</span>
          <i-select v-model="searchData.histroyDataId" class="share-query-select" transfer>
            <i-option :value="0">なし
            </i-option>
            <i-option v-for="(item, i) of resultHistoryList" :key="i" :value="item.hscNdataId"
              :label="item.hscCdataname" style="position: relative;">
              <div>{{ `データ名: ${item.hscCdataname}` }}</div>
              <span class="pr10" style="font-size: 12px;">{{ `備考: ${item.hscCcomment ? item.hscCcomment : '　'}`
                }}</span>
              <div style="color: var(--login-svg-fill);position: absolute;top:5px;right: 16px;"
                v-show="item.hscCpublic">共有</div>
              <i-button type="error" ghost icon="md-trash" size="small"
                @click.stop="delSettingShare(item.hscNdataId, 'result')" style="float:right;color: var(--red);">削除
              </i-button>
            </i-option>
          </i-select>
          <i-button type="primary" ghost icon="md-refresh" @click="getResultHistoryList" :loading="shareResultSaveLoading"></i-button>
          <i-button class="mr5" type="primary" ghost icon="md-cloud-upload" @click="shareResult">
            保存
          </i-button>
        </div>
      </div>
      <Tabs type="card" :animated="false" class="mt5">
        <tab-pane label="表示項目選択">
          <Row :gutter="8">
            <i-col span="8">
              <div class="ivu-transfer-list width100" style="height: 500px;">
                <div class="ivu-transfer-list-header">
                  <span class="ivu-transfer-list-header-title">テーブルを選択してください</span>
                </div>
                <div class="ivu-transfer-list-body">
                  <ul class="ivu-transfer-list-content">
                    <li
                      :class="item.name === curSelectedDisplay ? 'ivu-transfer-list-content-item conditionlist-transfer primary-set' : 'ivu-transfer-list-content-item conditionlist-transfer'"
                      v-for="item of displayList" :key="item.name" @click="searchDisplayList(item.name)">
                      {{ item.description }}
                    </li>
                    <li class="ivu-transfer-list-content-not-found"></li>
                  </ul>
                </div>
              </div>
            </i-col>
            <i-col span="16">
              <re-transfer :left-list="displayResultList" @to-left="($event) => displayResultList.push($event)"
                ref="transfer"></re-transfer>
            </i-col>
          </Row>
          <Checkbox v-model="searchData.showMastCode" class="mt10">マスタ参照項目を表示するときはコードも併せて表示する</Checkbox>
        </tab-pane>
        <tab-pane label="条件項目選択">
          <i-select value="01" class="mb5" style="display: block; width: 450px;">
            <i-option value="01">{{`【${this.legalPersonList[0].macCcompanyidCk}】
              ${this.legalPersonList[0].macCcompanyname}`}}
            </i-option>
          </i-select>
          <radio-group class="tl" v-model="searchData.standardDateType">
            <Radio :label="1">指定日付時点のデータを検索する（通常はこちらを使用してください）</Radio>
            <date-picker type="date" v-model="searchData.standardDate" :options="startLimit" class="ml5"
              format="yyyy/MM/dd" transfer :clearable="false">
            </date-picker>
            <Radio :label="0" style="display: block;">履歴も全て検索する</Radio>
          </radio-group>
          <div style="display: flex;" class="mb5">
            <i-button type="primary" size="small" ghost @click="isByConditionMethod = !isByConditionMethod"
              class="mt10">{{ isByConditionMethod ? '条件を項目選択で指定する ->' : '条件を条件式で指定する ->'}}
            </i-button>
            <div style="flex: 1;"></div>
            <div v-show="isByConditionMethod">
              <i-button type="error" icon="md-trash" ghost @click="conditionDeleteAll">全行を削除
              </i-button>
              <i-button type="success" icon="md-add" ghost @click="conditionAddTop">1行追加
              </i-button>
            </div>
          </div>
          <i-table v-show="isByConditionMethod" class="mt5 no-padding" border :row-class-name="()=>'select-col'"
            :columns="queryColumns" @on-cell-click="handleCellClickForAction" :disabled-hover="true" :data="queryData"
            no-data-text="" ref="table">
            <template slot-scope="{ row }" slot="andor">{{ queryData[row._index].andor || '　' }}</template>

            <template slot-scope="{ row }" slot="openedparenthsis">{{ queryData[row._index].openedparenthsis || '　'
              }}</template>

            <template slot-scope="{ row }" slot="columnname">{{ queryData[row._index].description || '　' }}</template>

            <template slot-scope="{ row }" slot="operator">{{ queryData[row._index].operator || '　' }}</template>

            <template slot-scope="{ row }" slot="displayvalue">{{ queryData[row._index].displayvalue || '　'
              }}</template>

            <template slot-scope="{ row }" slot="closedparenthsis">{{ queryData[row._index].closedparenthsis || '　'
              }}</template>
            <template slot-scope="{ row }" slot="action">
              <Poptip v-model="lightDelBtnVisible3[row._index]" placement="left" transfer>
                <div class="operateBtn" slot="content">
                  <a @click="cancelconditionDelete(row._index)">いいえ</a>
                  <a @click="conditionDelete(row, row._index)">はい</a>
                </div>
                <i-button type="error" ghost size="small" style="width: 83px;text-align: left;">削除
                </i-button>
              </Poptip>
              <i-button type="success" class="mt5" ghost icon="md-arrow-down" size="small"
                @click="conditionAdd(row._index)" long>1行追加
              </i-button>
            </template>
          </i-table>
          <i-table v-show="!isByConditionMethod" class="mt5 no-padding" border :row-class-name="()=>'select-col'"
            :columns="queryColumns2" :disabled-hover="true" :data="queryData2" no-data-text="" 　ref="table">
            <template slot-scope="{ row }" slot="use">
              <Checkbox v-model="queryData2[row._index].useFlag"></Checkbox>
            </template>

            <template slot-scope="{ row }" slot="columnname">
              <i-button type="primary" class="mt5 tl" ghost size="small" @click="handleClickQueryWhere(row)" long>{{
                row.columnDescription }}
              </i-button>
            </template>
            <template slot-scope="{ row }" slot="displayvalue">
              <span v-if="queryData2[row._index].selectValue">{{ queryData2[row._index].selectValue.map(e=>
                e.hswCname).join() }}</span>
              <span v-if="queryData2[row._index].postFlag">
                <radio-group class="tl" v-model="queryData2[row._index].postCode">
                  <Radio label="1">本務</Radio>
                  <Radio label="0">兼務</Radio>
                </radio-group>
              </span>
              <span v-if="queryData2[row._index].inWorkFlag">
                <radio-group class="tl" v-model="queryData2[row._index].atWorkCode">
                  <Radio label="1">在職</Radio>
                  <Radio label="0">退職</Radio>
                </radio-group>
              </span>
            </template>
            <template slot-scope="{ row }" slot="action">
              <i-button type="primary" class="mt5" ghost size="small" @click="handleCleanQueryWhere(row)" long>クリア
              </i-button>
            </template>
          </i-table>
        </tab-pane>
        <tab-pane label="ソート項目選択">
          <Row :gutter="8">
            <i-col span="8">
              <div class="ivu-transfer-list width100" style="height: 500px;">
                <div class="ivu-transfer-list-header">
                  <span class="ivu-transfer-list-header-title">テーブルを選択してください</span>
                </div>
                <div class="ivu-transfer-list-body">
                  <ul class="ivu-transfer-list-content">
                    <li
                      :class="item.name === curSelectedSort ? 'ivu-transfer-list-content-item conditionlist-transfer primary-set' : 'ivu-transfer-list-content-item conditionlist-transfer'"
                      v-for="item of displayListForSort" :key="item.name" @click="searchDisplayList(item.name, 'sort')">
                      {{ item.description }}
                    </li>
                    <li class="ivu-transfer-list-content-not-found"></li>
                  </ul>
                </div>
              </div>
            </i-col>
            <i-col span="16">
              <re-transfer :left-list="sortResultList" right-btn-text="降順" right-show-label="rightLabel"
                @to-left="($event) => sortResultList.push($event)" :right-btn-fn="(e) => `${e}(降)`" ref="transfer2">
                <template #top-btn="{ left, rightList}">
                  <i-button type="primary" size="small" icon="ios-arrow-forward" ghost
                    @click="orderLift(left, rightList)">昇順</i-button>
                </template>
              </re-transfer>
            </i-col>
          </Row>
        </tab-pane>
      </Tabs>
      <!-- 展示结果的table -->
      <div class="titlenorm mb10" style="font-size:15px">
        <Icon type="logo-buffer"></Icon>
        検索結果
      </div>
      <div class="tr mb10" v-show="columns.length > 0">
        <span style="position: relative;top: 1px;">{{ pageValue.amount }}件</span>
        <Page :total="pageValue.amount" :current="pageValue.curPage" show-total style="display: inline"
              :page-size="pageValue.curSize" @on-change="pageChange" simple/>
      </div>
      <div style="overflow-x: auto;" v-show="columns.length > 0">
        <i-table border class="no-padding" :row-class-name="() => 'select-col'" :columns="columns"
          :disabled-hover="true" :data="tableData" :loading="loading" ref="table" no-data-text="">
        </i-table>
      </div>

      <Alert class="primary-info" v-show="noData">データが見つかりませんでした</Alert>

    </div>
    <!--  条件式による定義 选择group和 役職 start-->
    <Drawer class="tc" placement="right" :width="curdisplayPanel === 'searchDept' ? '100' : '700'" title="該当条件選択"
      :mask-closable="false" v-model="showGroupOrPositionDrawer">
      <span v-show="curdisplayPanel === 'QPOST'">
        <div class="titlenorm mb5">
          <Icon type="logo-buffer"></Icon>
          役職
        </div>
        <Alert class="primary-info tl" style="margin-bottom: 5px;">
          <div>※ 役職マスタを選択してください。</div>
          <div class="mt2">&emsp;&nbsp;検索結果件数 {{ positonData.length }}件</div>
        </Alert>
        <div class="tr mb5" v-if="selectTreeType === 'post'">
          <i-button type="primary" ghost @click="addPostTree">決定</i-button>
        </div>
        <i-table class="mb5" border :row-class-name="()=>'select-col'" :columns="positonColumns" :disabled-hover="true"
          :data="positonData" no-data-text="" ref="postTable">
          <template slot-scope="{ row }" slot="mapCpostidCk">
            <span class="mr10 pt2 pb2 pl10 pr10 cursor row-label-primary" @click="uptdatePositonValue(row)"
              v-if="selectTreeType !== 'post'">{{ row.mapCpostidCk }}</span>
            <span v-else>{{ row.mapCpostidCk }}</span>
          </template>

          <template slot-scope="{ row }" slot="mapCpostname">
            <span class="mr10 pt2 pb2 pl10 pr10 cursor row-label-primary" @click="uptdatePositonValue(row)"
              v-if="selectTreeType !== 'post'">{{ row.mapCpostname }}</span>
            <span v-else>{{ row.mapCpostname }}</span>
          </template>
        </i-table>
      </span>

      <Row :gutter="8">
        <i-col :span="curdisplayPanel === 'QSECTION'|| curdisplayPanel === 'base' ? 24 : 8"
          v-show="curdisplayPanel === 'QSECTION' || curdisplayPanel === 'searchDept'|| curdisplayPanel === 'base'">
          <div class="titlenorm mb5">
            <Icon type="logo-buffer"></Icon>
            所属
          </div>
          <Row class="tl mb5" :gutter="8">
            <i-col span="10">
              <i-input class="mar like-select" placeholder="検索" v-model="searchDept"
                @keyup.enter.native="handleSearchDept">
              </i-input>
            </i-col>
            <i-col span="8" class="no-border-radius">
              <i-button long type="primary" icon="md-search" ghost @click="handleSearchDept">検索
              </i-button>
            </i-col>
            <i-col span="4" offset="2" class="no-border-radius" v-if="curdisplayPanel === 'base'">
              <i-button long type="primary" ghost @click="handleSelectDept">決定
              </i-button>
            </i-col>
          </Row>
          <!-- 所属选择树 -->
          <Tree class="tree mt2" :data="treeData" @on-select-change="handleClickLeaf"
            @on-check-change="handleClickCheckTree" empty-text="所属データなし" :render="renderSearchTree" ref="selectTree"
            :show-checkbox="curdisplayPanel === 'base'" :check-strictly="curdisplayPanel === 'base'"
            :check-directly="curdisplayPanel === 'base'"></Tree>
        </i-col>
        <i-col :span="curdisplayPanel === 'searchEmp' ? 24 : 16"
          v-show="curdisplayPanel === 'searchEmp' || curdisplayPanel === 'searchDept'">
          <div class="titlenorm mb5">
            <Icon type="logo-buffer"></Icon>
            社員検索
          </div>
          <Row class="tl mb5" :gutter="8">
            <i-col span="10">
              <i-input class="mar like-select" placeholder="社員の絞込み検索" v-model="searchEmpt"
                @keyup.enter.native="handleSearchEmpt">
              </i-input>
            </i-col>
            <i-col span="6" class="no-border-radius">
              <i-button long type="primary" icon="md-search" ghost :loading="empSearchLoading"
                @click="handleSearchEmpt()">
                検索
              </i-button>
            </i-col>
          </Row>
          <div class="tr mb5">
            <i-button type="primary" ghost @click="addSearchEmp">決定</i-button>
          </div>
          <i-table class="mb5" border :row-class-name="()=>'select-col'" :columns="searchEmpColumns"
            :disabled-hover="true" :data="searchEmpData" :loading="empSearchLoading" no-data-text="" ref="empTable">
          </i-table>
        </i-col>
      </Row>
      <Spin size="large" fix v-if="empSearchLoading"></Spin>
    </Drawer>
    <!--  条件式による定義 选择group和 役職 end-->
    <div class="ivu-pop-popper" :style="poptipStyle" x-placement="right-start">
      <div class="ivu-poptip-content">
        <div class="ivu-poptip-arrow"></div>
        <div class="ivu-poptip-inner">
          <div class="ivu-poptip-body" style="max-height: 350px; overflow-y: auto;">
            <div class="ivu-poptip-body-content">
              <div class="ivu-poptip-body-content-inner">
                <!-- ＡＮＤ/ＯＲ -->
                <span v-show="poptipType === 'andor'">
                  <i-button @click="popClickAction('なし')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>なし</i-button>
                  <i-button @click="popClickAction('AND')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>AND</i-button>
                  <i-button @click="popClickAction('OR')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>OR</i-button>
                </span>

                <!-- （ -->
                <span v-show="poptipType === 'openedparenthsis'">
                  <i-button @click="popClickAction('なし')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>なし</i-button>
                  <i-button @click="popClickAction('(')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>(</i-button>
                  <i-button @click="popClickAction('((')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>((</i-button>
                  <i-button @click="popClickAction('(((')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>(((</i-button>
                </span>

                <!-- 項目 -->
                <span v-show="poptipType === 'columnname'">
                  <i-button v-for="(item,i) of queryconditionsList" :key="i" type="primary" ghost
                    @click="handleQueryconditions(item)" style="display:block;" size="small" class="mb5 tl" long>
                    {{ item.description }}</i-button>
                </span>

                <!-- 比較 -->
                <span v-show="poptipType === 'operator'">
                  <i-button @click="popClickAction(item.name, item.value)"
                    v-for="(item,i) of operatorType ? operatorList : operatorList2" type="primary" ghost
                    style="display:block" size="small" class="mb5" long>{{ item.name }}</i-button>
                </span>

                <!-- 値 -->
                <span v-show="poptipType === 'displayvalue'">
                  <!-- 为null时 自己输入
                      QHONKEN  0本務  兼務
                      QSECTION 弹出第二层抽屉选择所属
                      QPOST 役職マスタを選択してください。 弹出第二层抽屉选择役職マスタ
                      QPOSTNUM  役職順位マスタを選択してください。 没有
                      QZAITAI  在職 	退職
                      TMG_MANAGEFLG 管理対象外 管理対象 -->
                  <i-input class="mb5" v-if="!curdisplayPanel" v-model="updateValue.value"></i-input>
                  <i-button v-show="!curdisplayPanel" type="primary" ghost @click="updateInputValue"
                    style="display:block" size="small" class="mb5" long>決定</i-button>
                  <span v-show="curdisplayPanel === 'QHONKEN'">
                    <i-button @click="popClickAction('本務[0]', '0')" type="primary" ghost style="display:block"
                      size="small" class="mb5" long>本務[0]</i-button>
                    <i-button @click="popClickAction('兼務[1]', '1')" type="primary" ghost style="display:block"
                      size="small" class="mb5" long>兼務[1]</i-button>
                  </span>

                  <span v-show="curdisplayPanel === 'QZAITAI'">
                    <i-button @click="popClickAction('在職[0]', '0')" type="primary" ghost style="display:block"
                      size="small" class="mb5" long>在職[0]</i-button>
                    <i-button @click="popClickAction('退職[1]', '1')" type="primary" ghost style="display:block"
                      size="small" class="mb5" long>退職[1]</i-button>
                  </span>

                  <span v-show="curdisplayPanel === 'TMG_MANAGEFLG'">
                    <i-button @click="popClickAction('管理対象外[0]', '0')" type="primary" ghost style="display:block"
                      size="small" class="mb5" long>管理対象外[0]</i-button>
                    <i-button @click="popClickAction('管理対象[1]', '1')" type="primary" ghost style="display:block"
                      size="small" class="mb5" long>管理対象[1]</i-button>
                  </span>
                </span>

                <!-- ） -->
                <span v-show="poptipType === 'closedparenthsis'">
                  <i-button @click="popClickAction('なし')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>なし</i-button>
                  <i-button @click="popClickAction(')')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>)</i-button>
                  <i-button @click="popClickAction('))')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>))</i-button>
                  <i-button @click="popClickAction(')))')" type="primary" ghost style="display:block" size="small"
                    class="mb5" long>)))</i-button>
                </span>
                <i-button v-show="!hasSearchedQueryconditions || poptipType !== 'columnname'" @click="cancelpoptip"
                  style="display:block" size="small" class="mb5" long>キャンセル</i-button>
                <i-button v-show="hasSearchedQueryconditions && poptipType === 'columnname'"
                  @click="queryconditionsFallback" style="display:block" size="small" class="mb5" long>戻る</i-button>

                <Spin size="large" fix v-if="queryconditionsLoading"></Spin>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!--  条件式保存 start-->
    <Modal class="tc" placement="right" :width="700" :title="isSharingSetting ? '設定保存' : '検索結果データ保存'"
      :mask-closable="false" v-model="shareQuerySaveModal">
      <Row :gutter="4">
        <i-col span="10">
          <div class="label pl10 tc">{{ isSharingSetting ? '設定名' : '検索結果データ名'}}</div>
          <div class="person-info">
            <i-input class="tl" style="padding: 3px;margin-left: -6px;" size="small"
              v-model="shareQueryData.hseCsettingname" :maxlength="1000" v-if="isSharingSetting"></i-input>
            <i-input class="tl" style="padding: 3px;margin-left: -6px;" size="small" v-model="shareQueryData.dataName"
              :maxlength="1000" v-if="!isSharingSetting"></i-input>
          </div>
        </i-col>
        <i-col span="3">
          <div class="label pl10 tc">共有</div>
          <div class="person-info tc" style="padding-left: 0;">
            <Checkbox v-model="shareQueryData.hseCpublic" :true-value="1" :false-value="0"
              @on-change="shareQueryData.checkbox = []"></Checkbox>
          </div>
        </i-col>
        <i-col span="11">
          <div class="label pl10 tc">備考</div>
          <div class="person-info">
            <i-input class="tl" style="padding: 3px;margin-left: -6px;" size="small"
              v-model="shareQueryData.hseCcomment" :maxlength="1000"></i-input>
          </div>
        </i-col>
      </Row>
      <!-- 所属选择树 -->
      <div class="label mt10 tc" v-if="isSharingSetting">共有対象</div>
      <div class="tl person-info" v-if="isSharingSetting">
        <radio-group class="tl" v-model="shareQueryData.isAll" vertical @on-change="shareQueryData.checkbox = []">
          <Radio label="1" :disabled="!shareQueryData.hseCpubli">全て</Radio>
          <Radio label="0" :disabled="!shareQueryData.hseCpubli">グループ指定</Radio>
        </radio-group>
        <ul class="ivu-transfer-list-content">
          <li class="ivu-transfer-list-content-item conditionlist-transfer" v-for="(item, i) of shareData"
            :key="item.groupId" @click="clickShareBox(i)">
            <Checkbox v-model="shareQueryData.checkbox[i]"
              :disabled="!shareQueryData.hseCpubli || shareQueryData.isAll === '1'"></Checkbox>
            {{ item.groupName }}
          </li>
        </ul>
      </div>
      </i-col>
      </Row>
      <div slot="footer">
        <i-button type="text" @click="closeShareModal">キャンセル</i-button>
        <i-button type="primary" icon="md-add" @click="freeSearch('SAVESETTING')" :loading="shareQuerySaveLoading">登録
        </i-button>
      </div>
      <Spin size="large" fix v-if="shareQuerySaveLoading"></Spin>
    </Modal>
    <back-top></back-top>
  </main>
  <div th:replace="layout/head::header"></div>
  <script th:src="${baseUrl + '/static/libs/Sortable.min.js?t='+ now}"></script>
  <script th:src="${baseUrl + '/static/component/conditionSearch/re-transfer.js?t='+ now}"></script>
  <script>
    var operatorList = [
      { name: '＝', value: '=' },
      { name: '≠', value: '<>' },
      { name: '≧', value: '>=' },
      { name: '≦', value: '<=' },
      { name: '＞', value: '>' },
      { name: '＜', value: '<' },
      { name: '空白のみ', value: 'ISNULL' },
      { name: '空白以外', value: 'ISNOTNULL' },
      { name: '次が含まれる', value: 'CONTAINS' },
      { name: '次で始まる', value: 'STARTS_WITH' },
      { name: '次で終わる', value: 'ENDS_WITH' },
    ]
    var operatorList2 = [
      { name: '＝', value: '=' },
      { name: '≠', value: '<>' },
      { name: '≧', value: '>=' },
      { name: '≦', value: '<=' },
      { name: '＞', value: '>' },
      { name: '＜', value: '<' },
      { name: '空白のみ', value: 'ISNULL' },
      { name: '空白以外', value: 'ISNOTNULL' },
    ]
  </script>
  <script type="text/babel" th:inline="javascript">
    new Vue({
      el: '.protosettings-warp',
      components: { ReTransfer },
      data() {
        return {
          isShow: false,
          loading: false,
          csvLoading: false,
          btnLoading: false,
          defaultOption: false,
          psSite: Utils.getUrlParam(location.href, 'psSite'),
          psApp: Utils.getUrlParam(location.href, 'psApp'),
          updateValue: {},
          columns: [],
          opts: {
            systemId: '01',
            appId: '0',
            siteId: '0',
            companyId: '0',
            date: '',
            groupId: '0',
            isAll: false,
          },
          curSelectedDisplay: '',
          curSelectedSort: '',
          tableData: [],
          displayList: [],
          displayListForSort: [],
          displayResultList: [],
          sortResultList: [],
          queryColumns: [
            {
              title: 'ＡＮＤ/ＯＲ',
              slot: 'andor',
              align: 'center',
              width: 100,
            },
            {
              title: '（',
              width: 70,
              align: 'center',
              slot: 'openedparenthsis',
            },
            {
              title: '項目',
              slot: 'columnname',
            },
            {
              title: '比較',
              width: 120,
              align: 'center',
              slot: 'operator',
            },
            {
              title: '値',
              slot: 'displayvalue',
            },
            {
              title: '）',
              width: 70,
              align: 'center',
              slot: 'closedparenthsis',
            },
            {
              title: ' ',
              width: 100,
              slot: 'action',
            },
          ],
          queryColumns2: [
            {
              title: '使用',
              slot: 'use',
              align: 'center',
              width: 100,
            },
            {
              title: '条件項目（・・・が）',
              slot: 'columnname',
              width: 300,
            },
            {
              title: '条件の値（以下のいずれかに該当する）',
              minWidth: 300,
              slot: 'displayvalue',
            },
            {
              title: ' ',
              width: 100,
              slot: 'action',
            },
          ],
          queryData2: [],
          curdisplayPanel: '',
          queryData: [{ isAdd: true, addIndex: Date.now(), andor: '', openedparenthsis: '', columnname: '', operator: '', displayvalue: '', closedparenthsis: '', delete: false }],
          lightDelBtnVisible3: [],
          poptipStyle: {
            display: 'none',
            position: 'absolute',
            'will-change': 'top, left',
            'z-index': '1001',
            left: '0',
            top: '0'
          },
          poptipType: '',
          queryconditionsList: [],
          queryconditionsList_bak: [],
          hasSearchedQueryconditions: false,
          queryconditionsLoading: false,
          showGroupOrPositionDrawer: false,
          positonColumns: [
            {
              title: 'コード',
              width: 120,
              slot: 'mapCpostidCk',
            },
            {
              title: '名称',
              slot: 'mapCpostname',
            },
          ],
          positonData: [],
          searchEmpColumns: [
            {
              title: '社員番号',
              width: 120,
              key: 'meCuserid',
            },
            {
              title: '氏名',
              key: 'empName',
            },
            {
              title: '所属',
              key: 'sectionName',
            },
            {
              title: '役職',
              key: 'postName',
            },
            {
              type: 'selection',
              width: 60,
              align: 'center'
            },
          ],
          selectTreeType: '',
          searchDept: '',
          searchEmpt: '',
          treeData: [],
          searchEmpData: [],
          legalPersonList: [{ macCcompanyidCk: '', macCcompanyname: '' }],
          empSearchLoading: false,
          operatorType: false,
          isByConditionMethod: true,
          searchData: { standardDateType: 1, standardDate: new Date(), histroyDataId: 0, showMastCode: false },
          resultHistoryList: [],
          queryList: [],
          // 条件保存
          shareQuerySaveModal: false,
          shareQuerySaveLoading: false,
          shareData: [],
          shareQueryData: { checkbox: [], isAll: '1' },
          isSharingSetting: false,
          noData: false,
          shareResultSaveLoading: false,
          pageValue: {
            amount: 0,
            curPage: 1,
            list: [20, 30, 50, 100],
            curSize: 50
          },
        }
      },
      async created() {
        // this.getTableData()
        this.getQueryWhereList()
        this.getLegalPersonList()
        this.getResultHistoryList()
        this.getQueryListParam()
        this.getDisplayList()
        this.getqueryconditions()
        this.getShareQueryParam()
      },
      computed: {
      },
      methods: {
        async getDisplayList() {
          try {
            const { data } = await this.http.get('sys/conditionsearch/options/tbl')
            this.displayList = data
            this.displayListForSort = Utils.deepClone(data)
            if (data.length > 0) {
              this.searchDisplayList(data[0].name, 'init')
            }
          } catch (error) {
          } finally {
            // this.loading = false
          }
        },
        searchDisplayList: Debounce(async function (name, type) {
          if (type === 'init') {
            this.curSelectedSort = name
            this.curSelectedDisplay = name
          } else if (type === 'sort') {
            this.curSelectedSort = name
          } else {
            this.curSelectedDisplay = name
          }
          try {
            const { data } = await this.http.get('sys/conditionsearch/options/col', { table: name })
            // 新获取表示項目时，应该排除已经选择的项目
            const rightListIds = this.$refs.transfer.rightList.map(e => e.columnName)
            const rightListIds2 = this.$refs.transfer2.rightList.map(e => e.columnName)
            if (type === 'init') {
              this.sortResultList = data.filter(e => !rightListIds2.includes(e.columnName))
              this.displayResultList = data.filter(e => !rightListIds.includes(e.columnName))
            } else if (type === 'sort') {
              this.$refs.transfer2.displayLeaftList = []
              this.sortResultList = data.filter(e => !rightListIds2.includes(e.columnName))
            } else {
              this.$refs.transfer.displayLeaftList = []
              this.displayResultList = data.filter(e => !rightListIds.includes(e.columnName))
            }
          } catch (error) {
          } finally {
            // this.loading = false
          }
        }),
        orderLift(left, rightList) {
          let index = 0
          left.forEach(e => {
            if (e === 0 || e) {
              const target = this.sortResultList.splice(e - index, 1)
              rightList.push({ ...target[0], rightLabel: `${target[0].columnFieldName}(昇)` })
              this.$set(left, e, undefined)
              index += 1
            }
          })
        },
        async getLegalPersonList() {
          const { data } = await this.http.get(`sys/groupappmanager/companies?psSite=${this.psSite}&psApp=${this.psApp}`)
          this.legalPersonList = data
          this.opts.companyId = data[0] && data[0].macCcompanyidCk
        },
        async getQueryWhereList() {
          const { data } = await this.http.get('sys/conditionsearch/options/where')
          this.queryData2 = data
          this._queryData2 = Utils.deepClone(data)
        },
        getResultHistoryList: Debounce(async function () {
          try {
            this.shareResultSaveLoading = true
            const { data } = await this.http.get('sys/conditionsearch/coop/list')
            this.resultHistoryList = data
          } finally {
            this.shareResultSaveLoading = false
          }
        }),
        async getShareQueryParam() {
          const { data } = await this.http.get('sys/conditionsearch/show/addOrUpdate')
          this.shareData = data.groups
        },
        getQueryListParam: Debounce(async function () {
          try {
            this.shareQuerySaveLoading = true
            const { data } = await this.http.get('sys/conditionsearch/show/read')
            this.queryList = data
          } finally {
            this.shareQuerySaveLoading = false
          }
        }),
        async getqueryconditions() {
          const { data } = await this.http.get('sys/conditionsearch/defs/tbl')
          this.queryconditionsList = data
          this.queryconditionsList_bak = [...data]
        },
        queryconditionsFallback() {
          if (this.hasSearchedQueryconditions) {
            this.queryconditionsList = this.queryconditionsList_bak
            this.hasSearchedQueryconditions = false
          }
        },
        conditionDeleteAll() {
          this.$Modal.confirm({
            inDrawer: true,
            title: '全行を削除します。よろしいですか？',
            okText: 'OK',
            cancelText: 'キャンセル',
            onOk: () => {
              this.deleteQueryData = this.queryData.filter(e => !e.isAdd)
              this.queryData = []
            }
          })
          this.poptipStyle.display = 'none'
        },
        cancelconditionDelete(i) {
          this.$set(this.lightDelBtnVisible3, i, false)
        },
        conditionDelete(row, i) {
          if (row.isAdd) this.queryData = this.queryData.filter(e => e.addIndex !== row.addIndex)
          else this.queryData = this.queryData.filter(e => e.id !== row.id)
          this.$set(this.lightDelBtnVisible3, i, false)
        },
        conditionAddTop() {
          // 条件式表格顶部加一行
          this.queryData.unshift({ isAdd: true, addIndex: Date.now(), andor: '', openedparenthsis: '', columnname: '', operator: '', displayvalue: '', closedparenthsis: '', delete: false })
          this.poptipStyle.display = 'none'
        },
        conditionAdd(i) {
          // 条件式表格中间加一行
          this.queryData.splice(i + 1, 0, { isAdd: true, addIndex: Date.now(), andor: '', openedparenthsis: '', columnname: '', operator: '', displayvalue: '', closedparenthsis: '', delete: false })
          this.poptipStyle.display = 'none'
        },
        async handleCellClickForAction(row, column, data, event) {
          // console.log(event)
          this.poptipStyle.display = 'none'
          if (column.slot === 'action') {
            return
          }
          this.queryconditionsFallback()
          this.poptipType = column.slot
          console.log(row)
          this.curdisplayPanel = row.dialogType
          this.operatorType = row.type ? row.type === 'VARCHAR2' || row.type === 'NVARCHAR2' ? true : false : false
          // 储存单击格的位置信息
          this.clickedCell = {
            where: row._index,
            which: column.slot
          }
          this.searchDept = ''
          if (this.poptipType === 'displayvalue') {
            if (this.curdisplayPanel === 'QPOST') {
              this.showGroupOrPositionDrawer = true
              const selectionIndex = this.positonColumns.findIndex(e => e.type === 'selection')
              if (selectionIndex > -1) {
                this.positonColumns.splice(selectionIndex, 1)
              }
              this.selectTreeType = ''
              const { data } = await this.http.get(`sys/tree/posts?psSite=${this.psSite}`)
              this.positonData = data.list
              return
            }
            if (this.curdisplayPanel === 'QSECTION') {
              this.showGroupOrPositionDrawer = true
              const { data } = await this.http.get(`sys/tree/orgs?psSite=${this.psSite}&psApp=${this.psApp}`)
              this.treeData = this.convertTreeData(data)
              this.treeData[0].expand = true
              return
            }
          }
          const elemLocation = event.target.offsetParent.getBoundingClientRect()
          this.poptipStyle.display = 'block'
          this.poptipStyle.left = `${elemLocation.x}px`
          this.poptipStyle.top = `${elemLocation.y}px`
        },
        updateInputValue() {
          // 将input的值更新到表格中
          this.queryData[this.clickedCell.where].displayvalue = this.updateValue.value
          this.queryData[this.clickedCell.where].value = this.updateValue.value
          this.poptipStyle.display = 'none'
          this.updateValue.value = ''
        },
        cancelpoptip() {
          this.poptipStyle.display = 'none'
          this.updateValue.value = ''
        },
        // 点击項目
        async handleQueryconditions(e) {

          if (this.hasSearchedQueryconditions) {
            this.$set(this.queryData[this.clickedCell.where], 'description', e.description)
            console.log('shie')
            console.log(this.queryData)
            // columnname 项目
            // displayvalue 值
            // 将项目的选中值更新到表格中
            //   更新选择得条件
            this.queryData[this.clickedCell.where].name = e.name
            this.queryData[this.clickedCell.where].type = e.type


            //   更新值的变换信息
            this.queryData[this.clickedCell.where].dialogType = e.dialogType
            this.curdisplayPanel = e.dialogType
            //   清空之前的值信息
            this.queryData[this.clickedCell.where].displayvalue = ''
            this.queryData[this.clickedCell.where].value = ''
            this.queryData[this.clickedCell.where].operator = ''
            this.poptipStyle.display = 'none'
            return
          }
          try {
            this.queryconditionsLoading = true
            const { data } = await this.http.get('sys/conditionsearch/defs/col', { table: e.name })
            this.queryData[this.clickedCell.where].tableid = e.name
            this.hasSearchedQueryconditions = true
            this.queryconditionsList = data
          } catch (error) {
          } finally {
            this.queryconditionsLoading = false
          }
        },
        // 点击改变表格的值
        popClickAction(e, value2) {
          if (e === 'なし') {
            this.queryData[this.clickedCell.where][this.clickedCell.which] = ''
            if (this.clickedCell.which === 'openedparenthsis') this.queryData[this.clickedCell.where].closedparenthsis = ''
            if (this.clickedCell.which === 'closedparenthsis') this.queryData[this.clickedCell.where].openedparenthsis = ''
          } else {
            this.queryData[this.clickedCell.where][this.clickedCell.which] = e
            const paernthsis = {
              '(': ')',
              '((': '))',
              '(((': ')))',
              ')': '(',
              '))': '((',
              ')))': '(((',
            }
            if (this.clickedCell.which === 'displayvalue') this.queryData[this.clickedCell.where].value = value2
            // 这里和group不同，需要显示label
            if (this.clickedCell.which === 'operator') {
              this.queryData[this.clickedCell.where].operator = e
              this.queryData[this.clickedCell.where].operatorValue = value2
            }
            if (this.clickedCell.which === 'openedparenthsis') this.queryData[this.clickedCell.where].closedparenthsis = paernthsis[e]
            if (this.clickedCell.which === 'closedparenthsis') this.queryData[this.clickedCell.where].openedparenthsis = paernthsis[e]
          }
          this.poptipStyle.display = 'none'
        },
        // 可以传入一个selectedItemArray, 来回显已被选择的值
        convertTreeData(treeData, selectedItemArray, selectedItemkeyName) {
          if (!treeData) {
            this.$Message.error({
              background: true,
              closable: true,
              duration: 6.5,
              content: '参照できる組織図が存在しません。'
            });
            return []
          }
          return treeData.map((e, i) => {
            if (e.children) {
              return {
                ...e,
                title: e.sectionName,
                expand: true,
                checked: selectedItemArray && selectedItemArray.includes(e[selectedItemkeyName]),
                children: this.convertTreeData(e.children, selectedItemArray, selectedItemkeyName)
              }
            } else {
              return {
                ...e,
                title: e.sectionName,
                checked: selectedItemArray && selectedItemArray.includes(e[selectedItemkeyName])
              }
            }
          })
        },
        handleSearchDept: Debounce(function () {
          this.sectionInTreeData(this.treeData)
          this.treeData = Utils.deepClone(this.treeData)
        }),
        sectionInTreeData(data, father) {
          const _this = this
          // 这里再有已勾选项时会消失，所以只应该打上记号
          data.forEach((e, i) => {
            e.searchWords = ''
            if (e.title.indexOf(this.searchDept) > -1) {
              if (father) father.expand = true
              e.searchWords = this.searchDept
            }
            if (e.children && e.children.length > 0) {
              _this.sectionInTreeData(e.children, e);
            }
          })
        },
        renderSearchTree(h, { root, node, data }) {
          const searchWords = data.searchWords
          if (searchWords && data.title.indexOf(searchWords) > -1) {
            const title = data.title.split(searchWords)
            return h('span', {
              style: {
                display: 'inline-block',
                width: '100%'
              }
            }, [
              h('span', title[0]),
              h('span', {
                style: {
                  color: 'var(--row-label-primary)',
                  fontWeight: 'bold'
                },
              }, searchWords),
              h('span', title[1])
            ])
          }
          return h('span', data.title)
        },
        handleClickLeaf(e) {
          if (!e[0]) return
          // if (this.curdisplayPanel === 'searchDept') {
          //   try {
          //     this.empSearchLoading = true
          //     const { data } = await this.http.get(`sys/groupmanager/empsearch?psSite=${this.psSite}`, { targetDept: e[0].sectionId, type: 2 })
          //     this.searchEmpData = data.map(e => {
          //       // 点开后将默认勾选勾上
          //       if (this.emptData.find(t => t.employeeId === e.meCuserid)) {
          //         return { ...e, _checked: true }
          //       } else {
          //         return e
          //       }
          //     })
          //   } catch (error) {
          //   } finally {
          //     this.empSearchLoading = false
          //   }
          //   return
          // }
          this.queryData[this.clickedCell.where][this.clickedCell.which] = `${e[0].sectionName}[${e[0].sectionId}]`
          this.queryData[this.clickedCell.where].theId = e[0].sectionId
          this.showGroupOrPositionDrawer = false
        },
        handleClickCheckTree(e, current) {
          if (!e[0]) return
          // 如果有子节点，则遍历影响
          if (current.children && current.children.length > 0) {
            this.treeCheckHack(current.children, current.checked)
          }
        },
        // 使得check-strictly的情况下， 勾选/取消 checkbox父也会遍历全部子集
        treeCheckHack(treeNode, checked) {
          let _this = this
          treeNode.forEach((e, i) => {
            _this.$set(e, 'checked', checked)
            if (e.children && e.children.length > 0) {
              _this.treeCheckHack(e.children, checked);

            }
          })
        },
        uptdatePositonValue(e) {
          //mapCpostname  mapCpostidCk
          if (this.selectTreeType === 'post') {
            return
          } else {
            this.queryData[this.clickedCell.where].displayvalue = `${e.mapCpostname}[${e.mapCpostidCk}]`
            this.queryData[this.clickedCell.where].theId = e.mapCpostidCk
          }
          this.showGroupOrPositionDrawer = false
        },
        handleClickQueryWhere(row) {
          this.curdisplayPanel = row.dialogFlag
          this.poptipType = 'displayvalue'
          // 储存单击格的位置信息
          this.clickedCell = {
            where: row._index,
            which: 'displayvalue'
          }
          if (row.dialogFlag === 'QZAITAI') {
            // 在職 退職
            this.$set(this.queryData2[this.clickedCell.where], 'inWorkFlag', true)
            this.$set(this.queryData2[this.clickedCell.where], 'atWorkCode', '1')
            this.$set(this.queryData2[this.clickedCell.where], 'useFlag', true)
          }
          if (row.dialogFlag === 'QHONKEN') {
            // 本務 兼務
            this.$set(this.queryData2[this.clickedCell.where], 'postFlag', true)
            this.$set(this.queryData2[this.clickedCell.where], 'postCode', '1')
            this.$set(this.queryData2[this.clickedCell.where], 'useFlag', true)

          }
          if (row.dialogFlag === 'QPOST') {
            // 役職マスタ
            this.openPostTree()
          }
          if (row.dialogFlag === 'QSECTION') {
            // 弹出第二层抽屉选择所属
            this.openSectionTree()
          }
          if (!row.dialogFlag) {
            // 搜职员
            this.openEmpTree()
          }
        },
        handleCleanQueryWhere(row) {
          if (row.dialogFlag === 'QZAITAI') {
            // 在職 退職
            this.$set(this.queryData2[row._index], 'postFlag', false)
            this.$set(this.queryData2[row._index], 'postCode', '')
          }
          if (row.dialogFlag === 'QHONKEN') {
            // 本務 兼務
            this.$set(this.queryData2[row._index], 'inWorkFlag', false)
            this.$set(this.queryData2[row._index], 'atWorkCode', '')
          }
          if (row.dialogFlag === 'QPOST' || row.dialogFlag === 'QSECTION' || !row.dialogFlag) {
            // 役職マスタ
            this.$set(this.queryData2[row._index], 'selectValue', [])
          }
        },
        async openPostTree() {
          this.searchDept = ''
          this.showGroupOrPositionDrawer = true
          this.selectTreeType = 'post'
          if (!this.positonColumns.some(e => e.type === 'selection')) this.positonColumns = this.positonColumns.concat({ type: 'selection', width: 60, align: 'center' })
          const { data } = await this.http.get(`sys/tree/posts?psSite=${this.psSite}`)
          // 点击役職定義回显
          const targetArray = this.queryData2[this.clickedCell.where].selectValue
          let IDs = targetArray && targetArray.map(e => e.hswCvalue) || []
          this.positonData = data.list.map(e => {
            return {
              ...e,
              _checked: IDs.includes(e.mapCpostidCk)
            }
          })
        },
        async openSectionTree() {
          this.searchDept = ''
          this.showGroupOrPositionDrawer = true
          this.curdisplayPanel = 'base'
          this.selectTreeType = 'section'
          // this.selectedBaseTreeData = []
          const { data } = await this.http.get(`sys/tree/orgs?psSite=${this.psSite}&psApp=${this.psApp}`)
          // 点击追加組織・役職選択による定義回显
          const targetArray = this.queryData2[this.clickedCell.where].selectValue
          let IDs = targetArray && targetArray.map(e => e.hswCvalue) || []
          this.treeData = this.convertTreeData(data, IDs, 'sectionId')
        },
        openEmpTree() {
          this.searchDept = ''
          this.curdisplayPanel = 'searchEmp'
          this.showGroupOrPositionDrawer = true
        },
        async handleSearchEmpt() {
          try {
            this.empSearchLoading = true
            const { data } = await this.http.get(`sys/groupmanager/empsearch?psSite=${this.psSite}`, { searchWord: this.searchEmpt, type: 1 })
            this.checkDefaultEmpt(data)
          } catch (error) {
          } finally {
            this.empSearchLoading = false
          }
        },
        checkDefaultEmpt(data) {
          // 点开后将默认勾选勾上
          const targetArray = this.queryData2[this.clickedCell.where].selectValue
          let IDs = targetArray && targetArray.map(e => e.hswCvalue) || []
          console.log(IDs)
          this.searchEmpData = data.map(e => {
            return { ...e, _checked: IDs.includes(e.meCemployeeidCk) }
          })
        },
        handleSelectDept() {
          this.$set(this.queryData2[this.clickedCell.where], 'selectValue', this.$refs.selectTree.getCheckedNodes().map(e => {
            return {
              hswId: e.moId,
              hswCname: ` ${e.sectionName}(${e.sectionId})`,
              hswCvalue: e.sectionId,
            }
          }))
          this.$set(this.queryData2[this.clickedCell.where], 'useFlag', true)
          this.showGroupOrPositionDrawer = false
        },
        addPostTree() {
          this.$set(this.queryData2[this.clickedCell.where], 'selectValue', this.$refs.postTable.getSelection().map(e => {
            return {
              hswId: e.mapId,
              hswCname: ` ${e.mapCpostname}(${e.mapCpostidCk})`,
              hswCvalue: e.mapCpostidCk,
            }
          }))
          this.$set(this.queryData2[this.clickedCell.where], 'useFlag', true)
          this.showGroupOrPositionDrawer = false
        },
        // 将选择中的社员加到社員を指定表格里
        addSearchEmp() {
          this.$set(this.queryData2[this.clickedCell.where], 'selectValue', this.$refs.empTable.getSelection().map(e => {
            return {
              hswId: e.meId,
              hswCname: ` ${e.empName}(${e.meCemployeeidCk})`,
              hswCvalue: e.meCemployeeidCk,
            }
          }))
          this.$set(this.queryData2[this.clickedCell.where], 'useFlag', true)
          this.showGroupOrPositionDrawer = false
        },
        shareSetting() {
          this.isSharingSetting = true
          this.shareQuerySaveModal = true
        },
        shareResult() {
          this.isSharingSetting = false
          this.shareQuerySaveModal = true
        },
        refreshPage() {
          this.$Modal.confirm({
            title: '注意',
            content: '現在編集中の設定は全て破棄されます。よろしいですか？',
            okText: 'OK',
            cancelText: 'キャンセル',
            onOk: () => {
              history.go(0)
            }
          })
        },
        freeSearch: Debounce(async function (mode, refreshFlag) {
          if (this.$refs.transfer.rightList.length === 0) {
            return this.$Notice.warning({ title: '注意', desc: '表示項目を選択してください', duration: 6.5 })
          }
          let query = {
            useQueryDefinition: this.isByConditionMethod,
            useCooperation: false, // 検索結果データ：有没有用
            hseCusecooperation: false, // 検索結果データ：有没有用
            standardDateType: this.searchData.standardDateType,
            standardDate: Utils.formatDate(this.searchData.standardDate, 'YYYY/MM/DD'),
            showMastCode: this.searchData.showMastCode,
            mode: 'CSV',
            pagerLinkDTO: {
              currentPage: this.pageValue.curPage,
              pagerCondition: 50,
            },
            companyId: '01', // 法人code
            pagingEvent: 'currentPage',
            selectDtoList: this.$refs.transfer.rightList.map((e, i) => {
              return {
                hssNseq: `${i}`,
                hssCcolumn: e.columnName
              }
            }),
            orderDtoList: this.$refs.transfer2.rightList.map((e, i) => {
              return {
                hsoNseq: `${i}`,
                hsoCorder: e.rightLabel.indexOf('昇') > -1 ? '0' : '1',
                hsoCcolumn: e.columnName,
                hsoCcolumnId: `${e.columnName} ${e.rightLabel.indexOf('昇') > -1 ? 'ASC' : 'DESC'}`,
              }
            }),
            hseCcompanyselect: '', // 法人選択区分 1=全法人共通
            hseNdataId: '',        // 連携データID,当mode为table模式时才使用到
          }
          if (this.isByConditionMethod) {
            if (this.queryData.length > 0 && this.queryData[0].operatorValue) {
              if (!this.queryData.some((e, i) => {
                if (!e.description) {
                  this.$Notice.warning({ title: '注意', desc: '項目内容が設定されていません、必ず設定してください', duration: 6.5 })
                  return true
                }
                if (!e.displayvalue && e.operatorValue !== 'ISNULL' && e.operatorValue !== 'ISNOTNULL') {
                  this.$Notice.warning({ title: '注意', desc: '比較がIS NULL,IS NOT NULLでない場合は必ず値を入力してください', duration: 6.5 })
                  return true
                }
                if (!e.andor && i > 0) {
                  this.$Notice.warning({ title: '注意', desc: '条件式に２行以上設定する場合はAND/ORを設定してください。', duration: 6.5 })
                  return true
                }
              })) {
                query.queryConditionDtoList = this.queryData.map(e => {
                  return {
                    value: e.dialogType ? `${e.dialogType}|${e.theId}` : e.displayvalue,
                    columnid: e.name,
                    columnname: e.description,
                    displayvalue: e.displayvalue,
                    operator: e.operatorValue,
                    displayoperator: e.operator,
                    andor: e.andor,
                    openedparenthsis: e.openedparenthsis,
                    closedparenthsis: e.closedparenthsis,
                    tableid: e.tableid,
                    typeofcolumn: e.type,
                    companyid: '01',
                    mastertablename: e.dialogType ? e.dialogType : ''

                  }
                })
              } else return
            }
          } else {
            const getValue = e => {
              if (e.postFlag) {
                return [{ hswCvalue: e.postCode }]
              }

              if (e.inWorkFlag) {
                return [{ hswCvalue: e.atWorkCode }]
              }

              if (e.selectValue && e.selectValue.length > 0) {
                return e.selectValue
              }

              return []
            }
            query.whereDtoList = this.queryData2.map(e => {
              return {
                mswId: '',
                mswCtableid: e.tableName,
                mswCcolumnid: e.columnName,
                mswCemployee: e.employFlag,
                selectValue: getValue(e),
                use: e.useFlag ? e.useFlag : false
              }
            })
          }
          if (mode === 'CSV') {
            this.csvLoading = true
            try {
              const { data } = await this.http.post(`sys/conditionsearch/csv/show?psSite=${this.psSite}`, query)
              window.open(`${BASE_URL}${data[0].filePath}`, '_blank')
            }finally {
              this.csvLoading = false
            }
          }

          if (mode === 'SCREEN') {
            try {
              // 设定和结果读入再设置
              if (this.searchData.histroyDataId !== 0) {
                query.useCooperation = true
                query.hseCusecooperation = '1'
                query.hseNdataId = this.searchData.histroyDataId
              }
              this.loading = true
              const { data } = await this.http.post(`sys/conditionsearch/search?psSite=${this.psSite}`, query)
              let _length = 0
              this.columns = data.title.slice(1).map((e, i) => {
                if (data.result.length !== 0 && data.result[0][i] !== null) _length = data.result[0][i].length > e.length ? data.result[0][i].length : e.length
                else _length = e.length
                return {
                  title: e,
                  key: `value${i}`,
                  width: _length * 15 + 50,
                  align: 'left'
                }
              })
              if (data.result.length === 0) this.tableData = []
              else this.tableData = data.result.map((e, j) => {
                if (e.length === 0) return
                if (e.length === 2) return { value0: e[1] }
                if (e.length > 2) {
                  let result = {}
                  e.slice(1).forEach((t, i) => result[`value${i}`] = t)
                  return result
                }
              })
              this.pageValue.amount = data.pager.totalCount
              if (data.title.length === 0)　this.noData = true
              else this.noData = false
              if(!refreshFlag) this.$Message.success('検索が終了しました')
            } finally {
              this.loading = false
            }
          }

          if (mode === 'SAVESETTING') {
            if (this.isSharingSetting && !this.shareQueryData.hseCsettingname) {
              return this.$Notice.warning({ title: '注意', desc: '設定名称を入力してください', duration: 6.5 })
            }

            if (!this.isSharingSetting && !this.shareQueryData.dataName) {
              return this.$Notice.warning({ title: '注意', desc: '検索結果データ名を入力してください', duration: 6.5 })
            }
            this.$Modal.confirm({
              title: '注意',
              content: '入力内容を保存します。よろしいですか？',
              okText: 'OK',
              cancelText: 'キャンセル',
              onOk: async () => {
                this.shareQuerySaveLoading = true
                try {
                  const _query = {
                    ...query,
                    hseCpublic: this.shareQueryData.hseCpublic, // 共有有無 1=共有 0=不共有
                    hseCcomment: this.shareQueryData.hseCcomment, // 備考
                    hseCusecooperation: '0', // 連携使用有無
                    hseCmastercodeflg: query.showMastCode, // マスタコード表示フラグ
                    hseCcompanyidCk: '01', // 法人コード，保持为01即可
                    hseCcompanyselect: '0', // 法人選択区分，保持为0即可
                    hseCsettingname: this.shareQueryData.hseCsettingname, // 設定名
                    mode: 'TABLE',
                    coopDTO: {
                      hscCdataName: this.shareQueryData.dataName, // 設定名
                      hscCpublic: this.shareQueryData.hseCpublic, // 共有有無 1=共有 0=不共有
                      hscCcomment: this.shareQueryData.hseCcomment,
                    },
                  }
                  if (_query.hseCpublic === 1 && this.shareQueryData.isAll === '0' && this.isSharingSetting) {
                    let targetDtoList = []
                    this.shareQueryData.checkbox.forEach((e, i) => {
                      if (e) {
                        targetDtoList = targetDtoList.concat({
                          hstCtargetsystem: '01',
                          hstCtargetgroup: this.shareData[i].groupId,

                        })
                      }
                    })
                    if (targetDtoList.length > 0) _query.targetDtoList = targetDtoList
                  }
                  if (this.isSharingSetting) {
                    const { data } = await this.http.post(`sys/conditionsearch/addOrUpdate?psSite=${this.psSite}`, _query)
                    this.shareQuerySaveModal = false
                    this.getQueryListParam()
                    this.$Message.success('設定を保存しました')
                  } else {
                    const { data } = await this.http.post(`sys/conditionsearch/coop/save?psSite=${this.psSite}`, _query)
                    this.shareQuerySaveModal = false
                    this.$Message.success('検索結果データを保存しました')
                    this.getResultHistoryList()
                  }
                } catch (error) {
                } finally {
                  this.shareQuerySaveLoading = false
                }
              }
            })
          }

        }),
        clickShareBox(i) {
          if (!this.shareQueryData.checkbox[i] && this.shareQueryData.checkbox[i] !== 0) this.$set(this.shareQueryData.checkbox, i, true)
          else this.$set(this.shareQueryData.checkbox, i, false)
        },
        closeShareModal() {
          this.shareQuerySaveModal = false
          this.shareQueryData = { checkbox: [], isAll: '1', hseCpubli: 0 }
        },
        delSettingShare(id, type) {
          this.$refs.clickHelper.click()
          this.$Modal.confirm({
            title: '注意',
            content: '削除します。よろしいですか？',
            okText: 'OK',
            cancelText: 'キャンセル',
            onOk: async () => {
              try {
                if (type === 'setting') {
                  const { data } = await this.http.get('sys/conditionsearch/delete', { settingId: id })
                  this.getQueryListParam()
                } else {
                  const { data } = await this.http.get('sys/conditionsearch/coop/del', { dataId: id })
                  this.getResultHistoryList()
                }
                this.$Message.success('削除完了')
              } catch (error) {
              } finally {
              }
            }
          })
        },
        async getSettingDetail(e) {
          // 去除没有和被删除时
          if (e === 0 || e === undefined) return
          const { data } = await this.http.get('sys/conditionsearch/setting/detail', { settingId: e })
          // マスタ参照項目を表示するときはコードも併せて表示する
          this.searchData.showMastCode = data.mainInfo.hseCmastercodeflg === '1'
          if (data.orderInfo.length > 0) {
            this.$refs.transfer2.rightList = data.orderInfo.map(e => {
              return {
                columnName: e.hsoCcolumn,
                rightLabel: `${e.columnName}${e.hsoCorder === '1' ? '(降)' : '(昇)'}`,
                columnFieldName: e.columnName
              }
            })
          }

          if (data.selectInfo.length > 0) {
            this.$refs.transfer.rightList = data.selectInfo.map(e => {
              return {
                columnName: e.hssCcolumn,
                columnFieldName: e.columnName
              }
            })
          }
          // 获取表示項目时，应该排除已经选择的项目
          this.getDisplayList()

          // 履歴も全て検索す
          this.searchData.standardDateType = +data.mainInfo.hseCusedate

          // 条件式
          this.queryData = data.queryWhereInfo.map(e => {
            let _operator
            if (e.hsdCtypeofcolumn === 'VARCHAR2' || e.hsdCtypeofcolumn === 'NVARCHAR2') {
              _operator = operatorList.find(t => t.value === e.hsdCoperator).name
            } else {
              _operator = operatorList.find(t => t.value === e.hsdCoperator).name
            }
            return {
              andor: e.hsdCandor ? e.hsdCandor : '',
              closedparenthsis: e.hsdCclosedparenthsis ? e.hsdCclosedparenthsis : '',
              name: e.hsdCcolumnid,
              description: e.hsdCcolumnname,
              // displayvalue: e.hsdCdisplayvalue,
              openedparenthsis: e.hsdCopenedparenthsis ? e.hsdCopenedparenthsis : '',
              operator: _operator,
              operatorValue: e.hsdCoperator,
              tableid: e.hsdCtableid,
              type: e.hsdCtypeofcolumn,
              displayvalue: e.hsdCvalue,
              theId: e.hsdId,
              id: e.hsdId
            }
          })

          if (data.whereInfo.length > 0) {
            this.isByConditionMethod = false
            // 条件
            let _queryData2 = Utils.deepClone(this._queryData2)
            data.whereInfo.forEach(e => {
              _queryData2.forEach(t => {
                if (t.columnName === e.hswCcolumn) {
                  t.useFlag = true
                  if (!t.selectValue) {
                    // 如果是最下面两个则没有id, name并且只有一份
                    if (e.hswCcolumn === 'HVHD_CIFKEYORADDITIONALROLE') {
                      t.postFlag = true
                      t.postCode = e.hswCvalue
                    } else if (e.hswCcolumn === 'ME_CIFSTILLEMPLOYEDID') {
                      t.inWorkFlag = true
                      t.atWorkCode = e.hswCvalue
                    }
                    else {
                      t.selectValue = [{
                        hswId: e.hswId,
                        hswCname: ` ${e.displayName}(${e.hswCvalue})`,
                        hswCvalue: e.hswCvalue
                      }]
                    }
                  } else {
                    t.selectValue = t.selectValue.concat({
                      hswId: e.hswId,
                      hswCname: ` ${e.displayName}(${e.hswCvalue})`,
                      hswCvalue: e.hswCvalue
                    })
                  }
                }
              })
            })
            this.queryData2 = _queryData2
          } else {
            this.isByConditionMethod = true
            setTimeout(() => this.queryData2 = this._queryData2.map(e => {
              return {
                ...e,
                useFlag: false
              }
            }), 800)
          }
        },
        pageChange(e) {
          this.pageValue.curPage = e
          this.freeSearch('SCREEN', true)
        }
      }
    })
  </script>
</body>