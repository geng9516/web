<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head th:replace="layout/header::common_header(title='ログイン',cssPaths='/pages/errorPage.min.css')"></head>

<body>
<div th:replace="layout/loadingBar::loadingBar"></div>
<svg th:replace="layout/logos::svg_logos"></svg>
<style>
    body {
        position: fixed;
        background: var(--login-right-part-bg);
        overflow-y: hidden;
    }

    .login-page {
        position: relative;
        width: 100vw;
        height: 100vh;
        animation: scrollToUp 80s linear infinite alternate;
    }

    @keyframes scrollToUp {
        100% {
            background-position: 600px 600px
        }
    }

    .main-logo {
        position: absolute;
        top: 0.714rem;
        right: 0.714rem;
    }

    .logo-trademark {
        display: inline-block;
        width: 1.5rem;
        height: 2rem;
    }

    .logo-suit {
        display: inline-block;
        width: 8.5rem;
        height: 2rem;
    }

    .login-warp {
        position: relative;
        top: 5.714rem;
        width: 80vw;
        margin: 0 auto;
    }

    .title {
        position: relative;
        top: 6.071rem;
        padding: 1.428rem 2.428rem 2.5rem;
        /* border-bottom: 1px solid lightgrey; */
    }

    .logo-warp {
        width: 18.571rem;
        height: 2.214rem;
        background-repeat: no-repeat;
        background-size: 91%;
    }

    .sub-title {
        color: var(--login-svg-fill);
        margin-top: 0.714rem;
    }

    .login-label {
        display: inline-block;
        text-align: left;
        margin-bottom: 0.714rem;
        /* font-size: 16px; */
        font-weight: bold;
        color: rgb(128, 134, 149);
        background: transparent;
    }

    /* .ivu-input-prefix {
       padding-left: 25px;
    }

    .ivu-input-prefix i {
       font-size: 30px;
       line-height: 50px;
    } */

    .ivu-input {
        height: 3.571rem;
        padding-left: 1.071rem;
        border-radius: 5px;
        box-shadow: 0 1px 5px 0 var(--ghost-primary-shadow);
        background: var(--mobile-input-btn-bg);
        /* border-color: var(--input-border-grey); */
        border-color: transparent;
    }

    .mobile-login-btn {
        background: var(--mobile-login-btn);
        margin: 20px 0;
    }

    .mobile-footer {
        position: absolute;
        bottom: -7.357rem;
        height: 13.928rem;
        width: 100vw;
        border-radius: 40%;
        text-align: center;
        background-color:var(--content-bg);
        color: var(--grey);
        font-size: 12px;
    }

    .work-btn {
        margin: 10px 0;
    }

    .footer-p {
        position: relative;
        bottom: -42px;
        color: var(--grey);
    }

    @media (max-height: 600px) {
        .title {
            top: 4rem;
        }

        .login-warp {
            top: 3.7rem;
        }

        .mobile-login-btn {
            margin: 20px 0 0;
        }

        .work-btn {
            margin: 0 0 10px;
        }

        .ivu-divider-inner-text {
            font-size: 10px;
        }

        .mobile-footer {
            height: 12.628rem;
        }

        .footer-p {
            bottom: -32px;
        }
    }
    @media all and (orientation: landscape) {
      .login-page {
        display: none;
      }
    }
</style>
<main class="login-page" :style="handleBg()">
    <section class="main-logo">
        <svg class="logo-trademark mr2">
            <use xlink:href="#logo-p-mark"></use>
        </svg>

        <svg class="logo-suit">
            <use xlink:href="#logo-suit"></use>
        </svg>
    </section>
    <div class="title">
        <svg class="logo-warp">
            <use xlink:href="#logo"></use>
        </svg>
        <div class="tr sub-title">公的機関向け就業管理システム</div>
    </div>
    <section class="login-warp">
        <i-input class="mb20" style="border-radius: 23px;" v-model="login.username" @on-blur="fixH5Height"
                 @keyup.enter.native="loging" placeholder="アカウント"></i-input>
        <i-input v-model="login.password" style="border-radius: 23px;" @on-blur="fixH5Height"
                 @keyup.enter.native="loging" placeholder="パスワード" type="password" autocomplete="new-password"></i-input>
        <i-button @click="loging" class="mobile-login-btn" type="primary" size="large" :loading="loading" :disabled="clockDisable" long>
            ログイン
        </i-button>
        <Divider size="small">OR</Divider>
        <i-button class="work-btn" style="background: var(--mobile-other-btn-bg)" type="primary" @click="clock('ACT_EXEC_OPEN')" :loading="clocking" :disabled="clockDisable" size="large" ghost long>{{
            clockBtn.clock }}
        </i-button>
        <i-button style="background: var(--mobile-other-btn-bg)" size="large" @click="clock('ACT_EXEC_CLOSE')" :loading="exiting" :disabled="clockDisable" long>{{ clockBtn.exit }}</i-button>
    </section>
    <div class="mobile-footer">
        <div class="footer-p">Smart Public WorkManager Ver.1.0.0 Copyright©</br>株式会社日進サイエンティア</div>
    </div>
</main>
<script type="text/babel" data-presets="latest">
    const login = new Vue({
        el: '.login-page',
        data() {
            return {
                login: {
                    username: '',
                    password: ''
                },
                loading: false,
                clocking: false,
                exiting: false,
                clockDisable: false,
                clockBtn: {
                    clock: '出勤',
                    exit: '退勤'
                },
                clockData: {
                    startTime: '',
                    endTime: ''
                },
                ruleValidate: {
                    username: [
                        {
                            required: true,
                            message: '職員コードを入力してください',
                            trigger: 'blur'
                        }
                    ],
                    password: [
                        {
                            required: true,
                            message: 'パスワードを入力してください',
                            trigger: 'blur'
                        }
                    ]
                },
                loading: false
            }
        },
        methods: {
            //undefined チェックする
            valid_ifnull(title, msg) {
                if (!msg) {
                   //this.$Notice.warning({title: 'ログインチェック', desc: title + 'を入力してください'})
                    this.$Message.warning(title + 'を入力してください');
                    return false
                }
                return true
            },
            //form check
            formCheck() {
                var isPass = true
                if (!this.valid_ifnull('アカウント', this.login.username)) {
                    isPass = false
                    return
                }
                if (!this.valid_ifnull('パスワード', this.login.password)) {
                    isPass = false
                    return
                }
                return isPass
            },
            loging: Debounce(async function () {
                const isPass = this.formCheck()
                if (isPass) {
                    this.loading = true
                    this.clockDisable = true
                    try {
                        // 采用ajax发送表单，事后跳转到请求地址，即可模拟form提交
                        await this.http.post('/login', this.login)
                        location.href = BASE_PATH
                    } catch (error) {
                        this.loading = false
                        this.clockDisable = false
                    }
                }
            }),
            //打刻
            async clock(pAction) {
                var isPass = this.formCheck()
                if (isPass) {
                    if (pAction) {
                        if (pAction === "ACT_EXEC_OPEN") {
                            this.clocking = true
                        } else {
                            this.exiting = true
                        }
                        this.clockDisable = true
                        try {
                            const {data} = await this.http.postForm('/stamping', {username: this.login.username, password: this.login.password, pAction: pAction})
                            //console.log(data)
                            if (data) {
                                //チェック合格
                                if (data.resultCode === "0") {
                                    //打刻成功(0)
                                    if (pAction === "ACT_EXEC_OPEN") {
                                        this.clockData.startTime = data.clockTime
                                        this.clockBtn.clock = '出勤(' + data.clockTime + ')'
                                        //this.$Notice.info({title: '打刻しました', desc: data.resultMsg})
                                        this.$Message.success(data.resultMsg);
                                        /*this.$Modal.confirm({
                                                   title: '操作確認',
                                                   content: '打刻は終わりました、ホームページへ遷移しますか',
                                                   okText: '遷移',
                                                   cancelText: 'いいえ',
                                                   onOk: async () => {
                                                       this.loging()
                                                   },
                                                   onCancel: () => {

                                                   }
                                               })*/
                                    } else {
                                        this.clockData.endTime = data.clockTime
                                        this.clockBtn.exit = '退勤(' + data.clockTime + ')'
                                        //this.$Notice.info({title: '打刻しました', desc: data.resultMsg})
                                        this.$Message.success(data.resultMsg);
                                    }
                                } else {
                                    //打刻失敗(10,20,30)
                                    //this.$Notice.error({title: '打刻エラー', desc: data.resultMsg})
                                    this.$Message.error(data.resultMsg);
                                }
                            } else {
                                //チェック不合格
                                //this.$Notice.warning({title: '打刻エラー', desc: "内部エラーが発生しました"})
                               this.$Message.error('内部エラーが発生しました');
                            }
                        } catch (error) {
                            this.clocking = false
                            this.exiting = false
                            this.clockDisable = false
                        }
                    } else {
                        //this.$Notice.warning({title: '打刻エラー', desc: "パラメータが不正です"})
                        this.$Message.error("パラメータが不正です");
                    }
                    this.clocking = false
                    this.exiting = false
                    this.clockDisable = false
                }
            },
            handleBg() {
                // todo: 后端提供接口后需更改
                if(localStorage.getItem('APP_THEME') !== 'dark') return `background-image:url(${BASE_URL}/static/svg/trademark.svg)`
            },
            fixH5Height() {
                setTimeout(function () {
                    let scrollHeight =
                        document.documentElement.scrollTop || document.body.scrollTop || 0
                    window.scrollTo(0, Math.max(scrollHeight - 1, 0))
                }, 100)
            }
        }
    })
</script>
</body>

</html>