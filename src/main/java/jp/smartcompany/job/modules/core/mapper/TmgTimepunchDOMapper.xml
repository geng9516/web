<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="jp.smartcompany.job.modules.core.mapper.TmgTimepunchMapper">

    <resultMap id="selectBaseTimesMap" type="jp.smartcompany.job.modules.tmg.timepunch.dto.BaseTimesDTO">
        <result column="sToday" property="sToday"></result>
        <result column="sYesterday" property="sYesterday"></result>
        <result column="sNow" property="sNow"></result>
        <result column="sStartMinutes" property="sStartMinutes"></result>
        <result column="sEndMinutes" property="sEndMinutes"></result>
    </resultMap>

    <!-- 出勤日数と時間数を取得 -->
    <resultMap id="selectDutyDaysAndHoursMap" type="jp.smartcompany.job.modules.tmg.timepunch.dto.DutyDaysAndHoursDTO">
        <result column="mgd_cheader" property="mgd_cheader"></result>
        <result column="mgd_csql" property="mgd_csql"></result>
        <!--<result column="mgd_ccolumnkey" property="mgd_ccolumnkey"></result>-->
    </resultMap>

    <!-- 予定データ取得 -->
    <resultMap id="selectScheduleInfoMap" type="jp.smartcompany.job.modules.tmg.timepunch.dto.ScheduleInfoDTO">
        <result column="tda_cemployeeid" property="tda_cemployeeid"></result>
        <result column="tda_dyyyymmdd" property="tda_dyyyymmdd"></result>
        <result column="tda_nopen_p" property="tda_nopen_p"></result>
        <result column="tda_nclose_p" property="tda_nclose_p"></result>
        <result column="timerange" property="timerange"></result>
    </resultMap>

    <!-- 打刻データ取得 -->
    <resultMap id="selectClockInfoMap" type="jp.smartcompany.job.modules.tmg.timepunch.vo.ClockInfoVO">
        <result column="tda_cemployeeid" property="tda_cemployeeid"></result>
        <result column="me_ckanjiname" property="me_ckanjiname"></result>
        <result column="nopen" property="nopen"></result>
        <result column="nclose" property="nclose"></result>
        <result column="tda_nopen_p" property="tda_nopen_p"></result>
        <result column="tda_nclose_p" property="tda_nclose_p"></result>
        <result column="rest_p" property="rest_p"></result>
        <result column="datetime" property="datetime"></result>
    </resultMap>

    <!-- 打刻時に打刻データ(未反映)情報に登録する -->
    <insert id="insertTmgTimePunch" parameterType="java.util.HashMap">
        insert into tmg_timepunch
            (ttp_nid, ttp_ccustomerid, ttp_ccompanyid, ttp_cemployeeid,
            ttp_dstartdate, ttp_denddate, ttp_cmodifieruserid,ttp_dmodifieddate,
            ttp_cmodifierprogramid, ttp_dtpdate,ttp_dtptime, ttp_ctptypeid)
        values
            (tmg_timepunch_seq.nextval,#{custId},#{compCode}, #{employeeId},
             to_date(#{minDate}, 'yyyy/mm/dd'),to_date(#{maxDate},'yyyy/mm/dd'), #{employeeId}, sysdate,
             #{modifierprogramid}, trunc(sysdate, 'dd'),sysdate, #{ctpTypeid})
    </insert>

    <!--  TMG_TRIGGERへINSERTする -->
    <insert id="insertTmgTrgger" parameterType="java.util.HashMap">
        insert into tmg_trigger
            (ttr_ccustomerid, ttr_ccompanyid, ttr_cemployeeid, ttr_dstartdate,
            ttr_denddate, ttr_cmodifieruserid, ttr_dmodifieddate,ttr_cmodifierprogramid,
            ttr_cprogramid)
        values
            (#{custId},#{compCode}, #{employeeId},to_date(#{minDate}, 'yyyy/mm/dd'),
            to_date(#{maxDate},'yyyy/mm/dd'), #{employeeId}, trunc(sysdate, 'dd'),#{modifierprogramid},
            #{modifierprogramid})
    </insert>

    <!--  TMG_TRIGGERへDELETEする -->
    <delete id="deleteTmgTrgger" parameterType="java.util.HashMap">
        delete from tmg_trigger
             where ttr_ccustomerid = #{custId}
               and ttr_ccompanyid = #{compCode}
               and ttr_cemployeeid = #{employeeId}
               and ttr_cmodifieruserid = #{employeeId}
               and ttr_cmodifierprogramid =#{modifierprogramid}
    </delete>

    <!-- 打刻画面表示判断 -->
    <select id="selectIsTimePunchTarget" parameterType="java.util.HashMap" resultType="java.lang.String">
        select tmg_f_is_timepunch_target(#{custId},#{compCode},#{employeeId},#{targetDate}) as timePunchTarget  from dual
    </select>

    <!-- 本日の日付情報と、法人情報(TMG_COMPANY)の開始時刻を取得します -->
    <select id="selectBaseTimes" parameterType="java.util.HashMap" resultMap="selectBaseTimesMap">
        select to_char(sysdate, 'yyyy/mm/dd') as sToday
            ,to_char(sysdate - 1, 'yyyy/mm/dd') as sYesterday
            ,tmg_f_conv_hhmi2min(to_char(sysdate, 'hh24:mi')) as sNow
            ,tco_nopen as sStartMinutes
            ,tco_nclose as sEndMinutes
        from tmg_company
        where tco_ccustomerid = #{custId}
        and tco_ccompanyid = #{compCode}
        and tco_dstartdate <![CDATA[<=]]> trunc(sysdate)
        and tco_denddate <![CDATA[>=]]> trunc(sysdate)
    </select>

    <!-- 打刻更新先となる日と今日の日付を取得するクエリ -->
    <select id="selectBaseTimesWithPattern" parameterType="java.util.HashMap" resultType="java.lang.String">
        select to_char(tmg_f_get_timepunch_targetdate(#{custId},#{compCode},#{employeeId},sysdate),'yyyy/mm/dd') as baseTime from dual
    </select>

    <!-- 出勤日数と時間数を取得SQLを返却する -->
    <select id="selectDutyDaysAndHoursSQL" parameterType="java.util.HashMap" resultMap="selectDutyDaysAndHoursMap">
        select mgd_cheader,mgd_csql
            from tmg_v_mgd_dispmonthlyitems
        where mgd_ccustomerid = #{custId}
            and mgd_ccompanyid_ck_fk = #{compCode}
            and mgd_clanguage_ck = #{language}
            and mgd_cheader in ('勤務日数','勤務時間')
            and mgd_dstart_ck  <![CDATA[<=]]> sysdate
            and mgd_dend <![CDATA[>=]]> sysdate
        order by mgd_nseq
    </select>

    <!-- 出勤日数と時間数を取得SQLを返却する -->
    <select id="selectDutyDaysAndHours" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        select
        <foreach collection="list" item="params" index="index" separator="," close="">
            ${params.mgd_csql_alias}
        </foreach>
        from tmg_monthly
        where tmo_cemployeeid = #{employeeId}
        and tmo_dyyyymm = #{targetDate}
        and tmo_ccompanyid = #{compCode}
        and tmo_ccustomerid = #{custId}
    </select>

    <!--  超過勤務時間-->
    <select id="selectOverTime" parameterType="java.util.HashMap" resultType="java.lang.String">
        select nvl(tmg_f_conv_min2hhmi(sum(r1.tdt_nvalue), 0), 0) as overtime
        from tmg_daily_totalization r1
        where r1.tdt_ccustomerid = #{custId}
        and r1.tdt_ccompanyid = #{compCode}
        and r1.tdt_cemployeeid = #{employeeId}
        and r1.tdt_dyyyymmdd <![CDATA[>=]]> #{startDate}
        and r1.tdt_dyyyymmdd <![CDATA[<=]]> #{endDate}
        and r1.tdt_ctotalizationid = 'TMG_TOTALITEM|overtime_total'
    </select>

    <!-- 予定データ取得 -->
    <select id="selectScheduleInfo" parameterType="java.util.HashMap" resultMap="selectScheduleInfoMap">
        select  d.tda_dyyyymmdd
                ,d.tda_nopen_p
                ,d.tda_nclose_p
                ,tmg_f_timerange_table_json(tmg_f_get_timerange_tbl_tdad(
                        tda_ccustomerid, tda_ccompanyid, tda_cemployeeid,
                        tda_dyyyymmdd, 'TMG_ITEMS|PlanRest', null)) as timerange
              from tmg_daily d
         where to_char(d.tda_dyyyymmdd, 'yyyy/mm/dd') = #{targetDate}
               and d.tda_ccompanyid = #{compCode}
               and d.tda_ccustomerid =  #{custId}
               and d.tda_cemployeeid = #{employeeId}
    </select>

    <!-- エラーメッセージを取得する -->
    <select id="selectErrMsg" parameterType="java.util.HashMap" resultType="java.lang.String">
        select tmg_f_check_timepunch( #{employeeId}, to_date(#{targetDate}, 'yyyy/mm/dd'), #{timepunch},#{custId}, #{compCode}) as checkMsg from dual
    </select>

    <!-- 打刻と予定データを取得する -->
    <select id="selectClockInfo" parameterType="java.util.HashMap" resultMap="selectClockInfoMap">
        select me_ckanjiname
            ,tmg_f_get_mo(hd_csectionid_fk, sysdate, hd_ccompanyid_ck)
            ,tmg_f_conv_min2hhmi(tda_nopen_tp, 0)  as nopen
            ,tmg_f_conv_min2hhmi(tda_nclose_tp, 0)  as nclose
            ,tmg_f_conv_min2hhmi(tda_nopen_p, 0) as tda_nopen_p
            ,tmg_f_conv_min2hhmi(tda_nclose_p, 0) as tda_nclose_p
            ,tmg_f_timerange_table_json(tmg_f_get_timerange_tbl_tdad(tda_ccustomerid, tda_ccompanyid, tda_cemployeeid,tda_dyyyymmdd, 'TMG_ITEMS|PlanRest', null)) as rest_p
            ,to_char(tda_dyyyymmdd, 'yyyy/mm/dd') as datetime
        from mast_employees,hist_designation,tmg_daily
        where me_ccustomerid_ck = #{custId}
        and me_ccompanyid = #{compCode}
        and me_cemployeeid_ck = #{employeeId}
        and me_dstartdate <![CDATA[<=]]> to_date(to_char(sysdate,'yyyy/mm/dd'), 'yyyy/mm/dd')
        and me_denddate <![CDATA[>=]]> to_date(to_char(sysdate,'yyyy/mm/dd'), 'yyyy/mm/dd')
        and hd_ccustomerid_ck = me_ccustomerid_ck
        and hd_ccompanyid_ck = me_ccompanyid
        and hd_cemployeeid_ck = me_cemployeeid_ck
        and hd_cifkeyoradditionalrole = '0'
        and hd_dstartdate_ck <![CDATA[<=]]> to_date(to_char(sysdate,'yyyy/mm/dd'), 'yyyy/mm/dd')
        and hd_denddate <![CDATA[>=]]> to_date(to_char(sysdate,'yyyy/mm/dd'), 'yyyy/mm/dd')
        and tda_ccustomerid = me_ccustomerid_ck
        and tda_ccompanyid = me_ccompanyid
        and tda_cemployeeid = me_cemployeeid_ck
        and tda_dyyyymmdd = to_date(to_char(sysdate,'yyyy/mm/dd'), 'yyyy/mm/dd')
    </select>


</mapper>