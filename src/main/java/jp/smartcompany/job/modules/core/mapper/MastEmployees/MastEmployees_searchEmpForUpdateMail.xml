<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.smartcompany.job.modules.core.mapper.MastEmployees.MastEmployeesMapper">

    <select id="searchEmpForUpdateMail" parameterType="map" resultType="jp.smartcompany.admin.usermanager.dto.UserManagerListDTO">
        SELECT ME_CCUSTOMERID_CK
             , ME_CCOMPANYID
             , ME_CEMPLOYEEID_CK
             , main.ME_CUSERID
             , main.ME_DSTARTDATE
             , ME_CKANANAME
             , CASE
                   WHEN ME_DSTARTDATE > TRUNC(SYSDATE) THEN
                       PSMASTER.FUNC_GET_EMP_NAME('01', ME_CCOMPANYID, ME_CEMPLOYEEID_CK, '2222/03/31', 'ja')
                   ELSE
                       PSMASTER.FUNC_GET_EMP_NAME('01', ME_CCOMPANYID, ME_CEMPLOYEEID_CK, NULL, 'ja')
            END                       ME_CNAME
             , ME_CMAIL
             , ME_DDATEOFEMPLOYEMENT
             , ME_DDATEOFRETIREMENT
             , ME_ID
             , MA_ID
             , MA_CUSERID
             , MA_CACCOUNT
             , MA_DSTART
             , MA_DEND
             , MA_NRETRYCOUNTER
             , MA_NPASSWORDLOCK
             , MA_CADMINUSER
             , MAST_ACCOUNT.VERSIONNO VERSIONNO
        FROM MAST_EMPLOYEES main
           , MAST_ACCOUNT
           , (SELECT MIN(ME_DSTARTDATE),
                     ME_CUSERID
              FROM MAST_EMPLOYEES
              WHERE TRUNC(ME_DENDDATE) >= TRUNC(SYSDATE)
              GROUP BY ME_CUSERID) mindate
        WHERE ME_CCUSTOMERID_CK = '01'
          AND mindate."MIN(ME_DSTARTDATE)" = main.ME_DSTARTDATE
          AND mindate.ME_CUSERID = main.ME_CUSERID
          AND ME_CCOMPANYID = '01'
          AND main.ME_CUSERID IN (
            SELECT HD_CUSERID
            FROM HIST_DESIGNATION
            WHERE HD_CCUSTOMERID_CK = ME_CCUSTOMERID_CK
              AND HD_CCOMPANYID_CK = ME_CCOMPANYID
              AND HD_CEMPLOYEEID_CK = ME_CEMPLOYEEID_CK
              AND HD_DENDDATE >= TRUNC(SYSDATE)
              AND (
                   HD_CEMPLOYEEID_CK LIKE '%' || #{keyword} || '%'
                    OR ME_CKANANAME LIKE '%' || #{keyword} || '%'
                    OR ME_CKANJINAME LIKE '%' || #{keyword} || '%'
                )
        )
          AND ME_CIFSTILLEMPLOYEDID = '0'
          AND ME_CCUSTOMERID_CK = MA_CCUSTOMERID(+)
          AND main.ME_CUSERID = MA_CUSERID(+)
        ORDER BY ME_CEMPLOYEEID_CK
    </select>

</mapper>