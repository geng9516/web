<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.smartcompany.job.modules.core.mapper.TmgStatusWorktypeSimMapper">

    <resultMap id="selectExcludecondCtlMap" type="jp.smartcompany.job.modules.tmg.tmgifsimulation.dto.ConditionColDTO">
        <result property="mgd_excludecond_type" column="mgd_excludecond_type"></result>
        <result property="mgd_excludecond_type_name" column="mgd_excludecond_type_name"></result>
        <result property="mgd_excludecond_length" column="mgd_excludecond_length"></result>
        <result property="value" column="value"></result>
    </resultMap>

    <resultMap id="selectSimulationMasterMap" type="jp.smartcompany.job.modules.tmg.tmgifsimulation.dto.SimulationDataDTO">
        <result property="start_time" column="start_time"></result>
        <result property="end_time" column="end_time"></result>
        <result property="period" column="period"></result>
        <result property="mgd_excludecond_type" column="mgd_excludecond_type"></result>
        <result property="mgd_excludecond_type_name" column="mgd_excludecond_type_name"></result>
        <result property="excludecond" column="excludecond"></result>
    </resultMap>

    <parameterMap id="insertMastGenericDetailMap" type="jp.smartcompany.job.modules.tmg.tmgifsimulation.dto.SimulationInsertDTO">
        <parameter property="psCustId"></parameter>
        <parameter property="psCompId"></parameter>
        <parameter property="psGroupCode"></parameter>
        <parameter property="psDetailId"></parameter>
        <parameter property="psMasterCode"></parameter>
        <parameter property="psLanguage"></parameter>
        <parameter property="psStartDate"></parameter>
        <parameter property="psEndDate"></parameter>
        <parameter property="psUpdateUser"></parameter>
        <parameter property="psExuludecondType"></parameter>
        <parameter property="psExuludecondFrom"></parameter>
        <parameter property="psExuludecondTo"></parameter>
    </parameterMap>

    <!-- HR連携除外条件区分マスタ情報の件数を取得する -->
    <select id="selectExcludecondCtl" parameterType="java.util.HashMap" resultMap="selectExcludecondCtlMap">
        select mgd_excludecond_type
            ,mgd_excludecond_type_name
            ,mgd_excludecond_length
            ,'' as value
        from tmg_v_mgd_excludecond_ctl
        where mgd_ccustomerid = #{custId}
            and mgd_ccompanyid_ck_fk = #{compCode}
            and mgd_dstart_ck <![CDATA[<=]]> trunc(sysdate)
            and mgd_dend >= trunc(sysdate)
            and mgd_clanguage_ck = #{language}
            and mgd_excludecond_edit_flg = #{editFlag}
        order by mgd_excludecond_type
    </select>

    <!-- HR連携除外条件マスタ情報を取得する -->
    <select id="selectSimulationMaster" parameterType="java.util.HashMap" resultMap="selectSimulationMasterMap">
        select tab1.start_time
             ,tab1.end_time
             ,tab1.period
             ,tab1.mgd_excludecond_type
             ,tab2.mgd_excludecond_type_name
             ,tab1.excludecond
             from
          (select tab1.start_time
            ,tab1.end_time
            , tab1.start_time||'-'|| tab1.end_time as period
            ,tab1.mgd_excludecond_type
            ,listagg(tab1.excludecond, ',') within group(order by tab1.rownumid) as excludecond
          from (select tab.start_time
                ,tab.end_time
                ,tab.mgd_excludecond_type
                ,case when tab.mgd_excludecond_to is not null then tab.mgd_excludecond_from
                 || '-' || tab.mgd_excludecond_to else tab.mgd_excludecond_from
                 || tab.mgd_excludecond_to end as excludecond
                 ,tab.rownumid
              from (select rownum as rownumid
                    ,mgd_excludecond_type
                    ,mgd_excludecond_from
                    ,mgd_excludecond_to
                    ,to_char(mgd_dstart_ck, 'yyyy/mm/dd') as start_time
                    ,to_char(mgd_dend, 'yyyy/mm/dd') as end_time
                  from tmg_v_mgd_excludecond4thw
                 where mgd_ccustomerid = #{custId}
                   and mgd_ccompanyid_ck_fk =  #{compCode}
                   and mgd_clanguage_ck = #{language}
                   and mgd_cgenericgroupid = #{genericgroupId}
                 order by mgd_dstart_ck, mgd_excludecond_type,
                    mgd_excludecond_from) tab) tab1
         group by tab1.start_time, tab1.end_time, tab1.mgd_excludecond_type)tab1,(select mgd_excludecond_type
            ,mgd_excludecond_type_name
            ,mgd_excludecond_length
        from tmg_v_mgd_excludecond_ctl
        where mgd_ccustomerid = #{custId}
            and mgd_ccompanyid_ck_fk = #{compCode}
            and mgd_dstart_ck <![CDATA[<=]]> trunc(sysdate)
            and mgd_dend >= trunc(sysdate)
            and mgd_clanguage_ck = #{language}
            and mgd_excludecond_edit_flg = #{editFlag}
        order by mgd_excludecond_type) tab2
        where tab1.mgd_excludecond_type = tab2.mgd_excludecond_type
               order by tab1.start_time,tab1.end_time desc
    </select>

    <!-- マスタデータを入力する -->
    <insert id="insertMastGenericDetail" parameterMap="insertMastGenericDetailMap" useGeneratedKeys="false">
        <selectKey resultType="long" keyProperty="mgd_id" order="BEFORE">
            SELECT mast_generic_detail_seq.NEXTVAL FROM dual
        </selectKey>
        insert into mast_generic_detail(mgd_id,mgd_ccustomerid,mgd_ccompanyid_ck_fk,mgd_cgenericgroupid,mgd_cgenericdetailid_ck,
        mgd_cmastercode,mgd_clanguage_ck,mgd_dstart_ck,mgd_dend,mgd_cmodifieruserid,
        mgd_dmodifieddate,mgd_csparechar1,mgd_csparechar2,mgd_csparechar3,versionno)
        select mast_generic_detail_seq.nextval,m.* from(
        <foreach collection="list" item="list" index="index" separator="union all">
            select
            #{list.psCustId},#{list.psCompId},#{list.psGroupCode},#{list.psDetailId},
            #{list.psMasterCode},#{list.psLanguage},#{list.psStartDate},#{list.psEndDate},#{list.psUpdateUser},
            sysdate,#{list.psExuludecondType},#{list.psExuludecondFrom},#{list.psExuludecondTo},'1' from dual
        </foreach>
        ) m
    </insert>

    <!-- 臨時マスタデータをオンラインデータに確定する -->
    <insert id="insertOnlineMasterData" parameterType="java.util.HashMap">
        <selectKey resultType="long" keyProperty="mgd_id" order="BEFORE">
            SELECT mast_generic_detail_seq.NEXTVAL FROM dual
        </selectKey>
        insert into mast_generic_detail
        (mgd_id, mgd_ccustomerid, mgd_ccompanyid_ck_fk,mgd_cgenericgroupid, mgd_cgenericdetailid_ck, mgd_cmastercode,
        mgd_clanguage_ck, mgd_dstart_ck, mgd_dend, mgd_cmodifieruserid,mgd_dmodifieddate, mgd_csparechar1,
        mgd_csparechar2,mgd_csparechar3, versionno)
        select mast_generic_detail_seq.NEXTVAL,mgd_ccustomerid,mgd_ccompanyid_ck_fk,#{onlinegroupId}, mast_generic_detail_seq.currval,concat(concat(#{onlinegroupId},'-'),
        mast_generic_detail_seq.currval)
        ,mgd_clanguage_ck,mgd_dstart_ck,mgd_dend,mgd_cmodifieruserid,sysdate,mgd_csparechar1
        ,mgd_csparechar2,mgd_csparechar3,versionno
        from mast_generic_detail
        where mgd_cgenericgroupid = #{genericgroupId}
        and mgd_ccustomerid = #{custId}
        and mgd_ccompanyid_ck_fk = #{compCode}
        and mgd_clanguage_ck = #{language}
    </insert>

    <!--段階導入シミュレーション登録情報に登録する-->
    <update id="updateTmgStatusWorkTypeSim" parameterType="java.util.HashMap">
        update tmg_status_worktype_sim
        <set>
            tsws_cmodifierprogramid=#{psModifierProgramId},tsws_cmodifieruserid=#{psModifierUserId},tsws_dmodifieddate=sysdate,tsws_cstatus=#{psStatus}
        </set>
        where tsws_ccustomerid=#{psCustId} and tsws_ccompanyid=#{psCompId} and tsws_dstartdate <![CDATA[<=]]> TRUNC(SYSDATE) and tsws_denddate <![CDATA[>=]]> TRUNC(SYSDATE)
    </update>

    <!-- 期間のマスタを取得する -->
    <select id="selectSimulationMasterByDate" parameterType="java.util.HashMap" resultMap="selectSimulationMasterMap">
         select tab1.start_time
             ,tab1.end_time
             ,tab1.period
             ,tab2.mgd_excludecond_type
             ,tab2.mgd_excludecond_type_name
             ,tab1.excludecond
             from
          (select tab1.start_time
            ,tab1.end_time
            , tab1.start_time||'-'|| tab1.end_time as period
            ,tab1.mgd_excludecond_type
            ,listagg(tab1.excludecond, ',') within group(order by tab1.rownumid) as excludecond
          from (select tab.start_time
                ,tab.end_time
                ,tab.mgd_excludecond_type
                ,case when tab.mgd_excludecond_to is not null then tab.mgd_excludecond_from
                 || '-' || tab.mgd_excludecond_to else tab.mgd_excludecond_from
                 || tab.mgd_excludecond_to end as excludecond
                  ,tab.rownumid
              from (select rownum as rownumid
                    ,mgd_excludecond_type
                    ,mgd_excludecond_from
                    ,mgd_excludecond_to
                    ,to_char(mgd_dstart_ck, 'yyyy/mm/dd') as start_time
                    ,to_char(mgd_dend, 'yyyy/mm/dd') as end_time
                  from tmg_v_mgd_excludecond4thw
                 where mgd_ccustomerid = #{custId}
                   and mgd_ccompanyid_ck_fk =  #{compCode}
                   and mgd_clanguage_ck = #{language}
                   and mgd_cgenericgroupid = #{genericgroupId}
                 order by mgd_dstart_ck, mgd_excludecond_type,
                    mgd_excludecond_from) tab) tab1
         group by tab1.start_time, tab1.end_time, tab1.mgd_excludecond_type)tab1,(select mgd_excludecond_type
            ,mgd_excludecond_type_name
            ,mgd_excludecond_length
        from tmg_v_mgd_excludecond_ctl
        where mgd_ccustomerid = #{custId}
            and mgd_ccompanyid_ck_fk = #{compCode}
            and mgd_dstart_ck <![CDATA[<=]]> trunc(sysdate)
            and mgd_dend >= trunc(sysdate)
            and mgd_clanguage_ck = #{language}
            and mgd_excludecond_edit_flg = #{editFlag}
        order by mgd_excludecond_type) tab2
        where tab1.mgd_excludecond_type(+) = tab2.mgd_excludecond_type
               and tab1.start_time(+) = #{startDate} and tab1.end_time(+) = #{endDate}
    </select>

    <!-- 名称マスタ詳細情報を削除する -->
    <delete id="deleteMastGenericDetail" parameterType="java.util.HashMap">
        delete from mast_generic_detail
        where mgd_ccustomerid = #{custId} and mgd_ccompanyid_ck_fk= #{compCode} and mgd_clanguage_ck= #{language}
        and mgd_cgenericgroupid= #{genericgroupId}
        <if test="startDate != null and endDate != null">
            and to_char(mgd_dstart_ck, 'yyyy/mm/dd')=#{startDate} and to_char(mgd_dend, 'yyyy/mm/dd')=#{endDate}
        </if>

    </delete>


    <!-- 期間時間をチャックする -->
    <select id="checkPeriodDate" parameterType="java.util.HashMap" resultType="java.lang.Integer">
        select count(*)
              from(select distinct to_char(mgd_dstart_ck, 'yyyy/mm/dd') as start_time,to_char(mgd_dend, 'yyyy/mm/dd') as end_time
                  from tmg_v_mgd_excludecond4thw
                 where mgd_ccustomerid = #{custId}
                   and mgd_ccompanyid_ck_fk = #{compCode}
                   and mgd_clanguage_ck = #{language}
                   and mgd_cgenericgroupid = #{genericgroupId}) tab
         where #{startDate} between start_time and end_time or #{endDate} between start_time and end_time
    </select>

    <!-- TMG_TRIGGERを削除するクエリを返します -->
    <delete id="buildSQLForDeleteTmgTrgger" parameterType="java.util.HashMap">
        delete from tmg_trigger
             where ttr_ccustomerid = #{custId}
               and ttr_ccompanyid = #{compCode}
               and ttr_cemployeeid = #{employeeId}
               and ttr_cmodifieruserid = #{employeeId}
               and ttr_cmodifierprogramid = #{modifierprogramid}
    </delete>

    <!-- TMG_TRIGGERへINSERTするクエリを返します -->
    <insert id="buildSQLForInsertTmgTrgger" parameterType="java.util.HashMap">
        insert into tmg_trigger
            (ttr_ccustomerid, ttr_ccompanyid, ttr_cemployeeid, ttr_dstartdate,
            ttr_denddate, ttr_cmodifieruserid, ttr_dmodifieddate,ttr_cmodifierprogramid, ttr_cprogramid)
        values
            (#{custId}, #{compCode}, #{employeeId}, to_date(#{minDate}, 'yyyy/mm/dd')
            ,to_date(#{maxDate}, 'yyyy/mm/dd'), #{employeeId}, trunc(sysdate,'DD'), #{modifierprogramid},#{modifierprogramid})
    </insert>

    <!-- 段階導入シュミレーション登録情報を取得する -->
    <select id="buildSQLForSelectTmgStatusWorkTypeSim" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        select tsws_cstatus as code,mgd_wtsimstatus_name as name
        from tmg_status_worktype_sim,
             (select mgd_ccustomerid,mgd_ccompanyid_ck_fk,mgd_wtsimstatus_code,mgd_wtsimstatus_name
            from tmg_v_mgd_wtsimstatus
                where mgd_dstart_ck <![CDATA[<=]]> trunc(sysdate)
                and mgd_dend <![CDATA[>=]]> trunc(sysdate)
                and mgd_clanguage_ck = #{language})
        where tsws_ccustomerid = #{custId}
             and tsws_ccompanyid = #{compCode}
             and tsws_dstartdate <![CDATA[<=]]> trunc(sysdate)
             and tsws_denddate <![CDATA[>=]]> trunc(sysdate)
             and tsws_ccustomerid = mgd_ccustomerid(+)
             and tsws_ccompanyid = mgd_ccompanyid_ck_fk(+)
             and tsws_cstatus = mgd_wtsimstatus_code(+)
    </select>

</mapper>