<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.smartcompany.job.modules.core.mapper.MastApptreeMapper">

   <select id="selectAppTreePermission" resultType="jp.smartcompany.framework.auth.entity.AppAuthJudgmentEntity">
       -- アプリケーション起動権限判定 情報取得SQLファイル (オブジェクト一覧)
       SELECT
           MTR_ID,
           MTR_COBJECTID,
           MTR_CSITEID,
           MTR_CAPPID,
           MTR_CSUBAPPID,
           MTR_CSCREENID,
           MTR_CBUTTONID,
           MTR_CTYPE,
           MTR_CTEMPLATEID,
           MTR_CURL,
           MTR_CIMAGEURL,
           MTR_NSEQ,
           MTR_CVERSION,
           MTR_CSYSTEMID,
           MTR_CDEFAULTTARGETUSER,
           MTR_CCRITERIALDATETYPE,
           MTR_CDATAPERMISSIONTYPE,
           MTR_CAPPAUTOLOAD,
           MTR_CONLINEHELPURL,
           MTR_CONLINEHELPATTR,
           MTR_CDOMAINID,
           '0' AS MGP_CPERMISSION,
           '0' AS MGP_CREJECT,
           MTR_COBJNAMEJA,
           MTR_COBJNAMEEN,
           MTR_COBJNAMECH,
           MTR_COBJNAME01,
           MTR_COBJNAME02,
           MTR_CSITECAPTIONJA,
           MTR_CSITECAPTIONEN,
           MTR_CSITECAPTIONCH,
           MTR_CSITECAPTION01,
           MTR_CSITECAPTION02,
           MTR_CIFRAMEFLAG
       FROM
           MAST_APPTREE
       ORDER BY
           MTR_NSEQ
   </select>

    <select id="selectGroupPermission" parameterType="map" resultType="jp.smartcompany.framework.auth.entity.AppAuthJudgmentEntity">
        -- アプリケーション起動権限判定 情報取得SQLファイル (グループ毎の権限)
        select
        MTR_ID,
        MTR_COBJECTID,
        NVL(MGP_CPERMISSION, '0') AS MGP_CPERMISSION,
        NVL(MGP_CREJECT, '0') AS MGP_CREJECT
        from MAST_APPTREE left outer join MAST_GROUPAPPPERMISSION on
        MGP_COBJECTID = MTR_COBJECTID
        AND MGP_CSYSTEMID = #{systemCode}
        AND MGP_CGROUPID = #{groupCode}
        AND MGP_DSTARTDATE <![CDATA[<=]]> trunc(sysdate)
        AND MGP_DENDDATE >= trunc(sysdate)
    </select>

    <select id="selectSiteOrAppListByType" parameterType="map" resultType="jp.smartcompany.job.modules.core.pojo.entity.MastApptreeDO">
        -- アプリケーション（サイト）一覧取得SQL
-- psTypeが3はアプリケーション一覧
-- psTypeが1はサイト一覧
        SELECT
            <if test='type == "1"'>
                MTR_CSITEID,
            </if>
            <if test='type=="3"'>
                MTR_CAPPID,
            </if>
            MTR_COBJNAME,
            MIN(MTR_NSEQ) MTR_NSEQ
        FROM (
          SELECT
            <if test='type == "1"'>
              MTR_CSITEID,
            </if>
            <if test='type=="3"'>
              MTR_CAPPID,
            </if>
              PSMASTER.FUNC_GET_OBJ_NAME (
                     MTR_CSITEID,
                     MTR_CAPPID,
                     NULL,
                     NULL,
                     NULL,
                     '${language}'
              ) MTR_COBJNAME,
              MTR_NSEQ
          FROM MAST_APPTREE
        WHERE MTR_CSYSTEMID = #{systemId}
              <if test='type == "1"'>
                AND	MTR_CTYPE IN ('0','${type}')	-- トップページを含める
              </if>
              <if test='type == "3"'>
                AND	MTR_CTYPE = #{type}
              </if>
              <if test="siteId!=null">
                AND	MTR_CSITEID = #{siteId}
              </if>
        ) GROUP BY
            <if test='type == "1"'>
                MTR_CSITEID,
            </if>
            <if test='type == "3"'>
                MTR_CAPPID,
            </if>
            MTR_COBJNAME ORDER BY MTR_NSEQ
    </select>

    <select id="selectMastAppTree" resultType="jp.smartcompany.admin.appmanager.dto.MastAppTreeDTO">
        SELECT
            MTR_COBJECTID as object_id,
            MTR_CSITEID as site_id,
            MTR_CAPPID as app_id,
            MTR_CSUBAPPID as sub_app_id,
            MTR_CSCREENID as screen_id,
            MTR_CBUTTONID as button_id,
            PSMASTER.FUNC_GET_OBJ_NAME(
                MTR_CSITEID,
                MTR_CAPPID,
                MTR_CSUBAPPID,
                MTR_CSCREENID,
                MTR_CBUTTONID,
                'ja') name,
            MTR_CTYPE as type,
            MTR_CTEMPLATEID as template_id,
            MTR_CURL as url,
            MTR_CIMAGEURL as icon,
            MTR_CSITECAPTIONJA as remark,
            MTR_NSEQ as sort,
            MTR_CSYSTEMID as system_id,
            MTR_CAPPAUTOLOAD,
            MTR_CONLINEHELPURL as help_doc_url,
            MTR_CONLINEHELPATTR as help_attribute,
            MTR_CDOMAINID as domain_id
        FROM
            MAST_APPTREE
        ORDER BY
            MTR_NSEQ ASC
    </select>

    <delete id="removeAll">
        truncate table MAST_APPTREE
    </delete>

</mapper>