<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.smartcompany.job.modules.core.mapper.TmgLiquidationPeriod.TmgLiquidationPeriodMapper">

    <select id="getLiquidationDispFromWorkType"
            resultType="jp.smartcompany.job.modules.tmg.tmgliquidationperiod.dto.LiquidationPeriodListDto">
        SELECT
        te.TEM_CEMPLOYEEID AS EMPLOYEEID,
        TMG_F_GET_ME_NAME (
        te.TEM_CEMPLOYEEID,
        SYSDATE,
        0,
        te.TEM_CCOMPANYID,
        te.TEM_CCUSTOMERID
        ) AS EMPLOYEENAME,
        te.TEM_CWORKTYPEID  AS  worktypeid,
        TMG_F_GET_MGD (
        te.TEM_CWORKTYPEID,
        SYSDATE,
        te.TEM_CCOMPANYID,
        te.TEM_CCUSTOMERID,
        'ja'
        ) AS WORKTYPENAME,
        hd.HD_CSECTIONID_FK as sectionid,
        TMG_F_GET_MO(hd.HD_CSECTIONID_FK,sysdate,0,hd.HD_CCUSTOMERID_CK,hd.HD_CCOMPANYID_CK,'ja') as deptname,
        NVL( TO_CHAR(tlp.TLP_DSTARTDATE,'yyyy/mm/dd'), '' ) AS startdate,
        NVL( TO_CHAR(tlp.TLP_DENDDATE,'yyyy/mm/dd'), '' ) AS enddate,
        NVL( tlp.TLP_CMODIFIERUSERID, '' ) AS modifieduser,
        NVL( to_char(tlp.TLP_DMODIFIEDDATE,'yyyy/mm/dd'), '' ) AS modifieddate,
        NVL( tlp.TLP_CMAXDAYHOURS, '' ) as dailymaxworktime,
        NVL( tlp.TLP_CMAXWEEKHOURS, '' ) as weeklymaxworktime,
        NVL( tlp.TLP_CTOTALWORKDAYS, '' ) as totalworkdays,
        DECODE( tlp.tlp_CTLPID,'','',tlp.tlp_CTLPID ) AS NEWFLAG,
        tlp.tlp_csparechar1 as STATUS,
        TMG_F_GET_MGD(
        tlp.tlp_csparechar1,
        SYSDATE,
        tlp.TLP_CCOMPANYID,
        tlp.TLP_CCUSTOMERID,
        'ja') as STATUSNAME
        FROM
        HIST_DESIGNATION hd,
        TMG_EMPLOYEES te
        LEFT JOIN TMG_LIQUIDATION_PERIOD tlp
        ON tlp.TLP_CEMPLOYEEID = te.TEM_CEMPLOYEEID
        AND sysdate BETWEEN te.TEM_DSTARTDATE AND te.TEM_DENDDATE
        AND tlp.TLP_CCOMPANYID = te.TEM_CCOMPANYID
        AND tlp.TLP_CCUSTOMERID = te.TEM_CCUSTOMERID
        WHERE
            te.TEM_CCOMPANYID = #{custId}
        AND te.TEM_CCUSTOMERID = #{compId}
        AND SYSDATE BETWEEN te.TEM_DSTARTDATE AND te.TEM_DENDDATE
        AND hd.HD_CEMPLOYEEID_CK=te.TEM_CEMPLOYEEID
        AND hd.HD_CCUSTOMERID_CK = te.TEM_CCUSTOMERID
        AND hd.HD_CCOMPANYID_CK = te.TEM_CCOMPANYID
        AND SYSDATE BETWEEN hd.HD_DSTARTDATE_CK AND hd.HD_DENDDATE
        <choose>
            <when test='workType == "flex"'>
                AND EXISTS (
                SELECT
                *
                FROM
                TMG_MAST_WORKER4FLEX tmwf
                WHERE
                tmwf.TMWF_CWORKTYPEID = te.TEM_CWORKTYPEID
                )
            </when>
            <when test='workType == "variational"'>
                AND EXISTS (
                SELECT
                *
                FROM
                TMG_MAST_WORKER4VARIATIONAL tmwv
                WHERE
                tmwv.TMWV_CWORKTYPEID = te.TEM_CWORKTYPEID
                )
            </when>
            <when test='workType == "all"'>
                AND EXISTS (
                SELECT
                *
                FROM
                TMG_MAST_WORKER4VARIATIONAL tmwv
                WHERE
                tmwv.TMWV_CWORKTYPEID = te.TEM_CWORKTYPEID
                UNION
                SELECT
                *
                FROM
                TMG_MAST_WORKER4FLEX tmwf
                WHERE
                tmwf.TMWF_CWORKTYPEID = te.TEM_CWORKTYPEID
                )
            </when>
        </choose>

        <if test='workType!="flex" and workType!="variational" and workType!="all"'>
            AND te.TEM_CWORKTYPEID = #{workType}
        </if>
    </select>

</mapper>